<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-bounce.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.4">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.4" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.0.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="python,peewee,">


<meta name="description" content="简介 Peewee 是Python的一款轻量级ORM框架。ORM 是对象-关系映射（Object-Relational Mapping），是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。ORM 屏蔽了底层数据库操作的细节，使代码几乎不用修改即可支持不同的底层数据库存储。支持Pytho">
<meta name="keywords" content="python,peewee">
<meta property="og:type" content="article">
<meta property="og:title" content="Peewee 轻量级ORM框架">
<meta property="og:url" content="http://www.hinote.ga/2018/03/20/2018/Peewee 轻量级ORM框架/index.html">
<meta property="og:site_name" content="某科学的最后之作">
<meta property="og:description" content="简介 Peewee 是Python的一款轻量级ORM框架。ORM 是对象-关系映射（Object-Relational Mapping），是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。ORM 屏蔽了底层数据库操作的细节，使代码几乎不用修改即可支持不同的底层数据库存储。支持Pytho">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://www.hinote.ga/uploads/photos/d83h89da93d.jpg">
<meta property="og:updated_time" content="2018-12-05T15:10:29.242Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Peewee 轻量级ORM框架">
<meta name="twitter:description" content="简介 Peewee 是Python的一款轻量级ORM框架。ORM 是对象-关系映射（Object-Relational Mapping），是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。ORM 屏蔽了底层数据库操作的细节，使代码几乎不用修改即可支持不同的底层数据库存储。支持Pytho">
<meta name="twitter:image" content="http://www.hinote.ga/uploads/photos/d83h89da93d.jpg">






  <link rel="canonical" href="http://www.hinote.ga/2018/03/20/2018/Peewee 轻量级ORM框架/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>
  <title>Peewee 轻量级ORM框架 | 某科学的最后之作</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">某科学的最后之作</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">帅的人已经醒来 而丑的人还在沉睡</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.hinote.ga/2018/03/20/2018/Peewee 轻量级ORM框架/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="魏云飞">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/uploads/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="某科学的最后之作">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Peewee 轻量级ORM框架</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-20T10:12:00+08:00">2018-03-20</time>
            

            
            
              
                
              
            

            
              
              <span class="post-meta-divider">|</span>
              

              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">更新于&#58;</span>
              
              <time title="更新于" itemprop="dateModified" datetime="2018-12-05T23:10:29+08:00">2018-12-05</time>
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">37k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">0:37</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      
        <div class="post-gallery" itemscope="" itemtype="http://schema.org/ImageGallery">
          
          
            <div class="post-gallery-row">
              <a class="post-gallery-img fancybox" href="/uploads/photos/d83h89da93d.jpg" rel="gallery_cjq2am905009z3se69xgbe19r" itemscope="" itemtype="http://schema.org/ImageObject" itemprop="url">
                <img src="/uploads/photos/d83h89da93d.jpg" itemprop="contentUrl">
              </a>
            
          

          
          </div>
        </div>
      

      
        <!-- created: 2018-03-13 10:12:00-->
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote>
<p>Peewee 是Python的一款轻量级ORM框架。ORM 是对象-关系映射（Object-Relational Mapping），是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。ORM 屏蔽了底层数据库操作的细节，使代码几乎不用修改即可支持不同的底层数据库存储。支持Python2.7和3.4以上的版本，内置对SQLite, MySQL和Postgresql的支持。本文通过阅读官方文档翻译而来。<br><a id="more"></a></p>
</blockquote>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>这里使用 Windows 版的 Python 3.6 和当前最新版的 peewee 3.1.3。</p>
<p>Github地址：<a href="https://github.com/coleifer/peewee" target="_blank" rel="noopener">https://github.com/coleifer/peewee</a></p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>这里使用 pip 命令安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install peewee</span><br></pre></td></tr></table></figure>
<p>也可以将代码 git 下来 使用 setup 安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/coleifer/peewee.git </span><br><span class="line">cd peewee </span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<p>如果底层想要使用 MySQL 数据库需要安装 MySQL 的连接驱动：<code>pip install pymysql</code>，并且配置好一个可用的 MySQL 数据库。Postgres 同理，Postgres 的连接驱动：<code>pip install psycopg2</code>。</p>
<p> SQLite 是 Python 标准库的模块，不需要额外安装和配置，也更简单方便，所以这里就以 SQLite 为例。</p>
<h3 id="快速体验"><a href="#快速体验" class="headerlink" title="快速体验"></a>快速体验</h3><p>先来体验一下 peewee 对数据交互带来的方便吧。</p>
<h4 id="创建数据模型"><a href="#创建数据模型" class="headerlink" title="创建数据模型"></a>创建数据模型</h4><p>先理解下什么 ORM ，ORM 是将编程语言中的对象映射为数据库中的数据，比如说 可以将编程语言中的一个类，映射为数据库的一个表，这个类被称为模型类（Model class）。模型类的字段实例（Field instance），映射为数据库中表的字段。模型实例（Model instance）映射为数据库中表的每一行数据。</p>
<p>建议在命令行中执行下面的代码，这样就更直观的知道每一步都发生了什么。</p>
<p>在项目中使用 peewee 时，刚开始最好创建一个模型类，peewee 会自动根据这个模型类在数据库中创建好表。下面看看模型类如何定义的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">db = SqliteDatabase(<span class="string">'people.db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField()</span><br><span class="line">    birthday = DateField()</span><br><span class="line">    is_relative = BooleanField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db <span class="comment"># This model uses the "people.db" database.</span></span><br></pre></td></tr></table></figure>
<p>当我们使用外键建立模型之间的关系时，peewee 可以很容易的做到这一点。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pet</span><span class="params">(Model)</span>:</span></span><br><span class="line">    owner = ForeignKeyField(Person, backref=<span class="string">'pets'</span>)</span><br><span class="line">    name = CharField()</span><br><span class="line">    animal_type = CharField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db <span class="comment"># this model uses the "people.db" database</span></span><br></pre></td></tr></table></figure>
<p>现在创建好了模型，让我们连接到数据库。虽然在执行第一条查询的时候会自动连接数据库，但是手动连接可以立即显示数据库连接的任何错误，在使用完后手动关闭数据库连接也是个很好的习惯。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.connect()</span><br></pre></td></tr></table></figure>
<p>首先在数据库中创建存储数据的表。这将创建具有适当列，索引，序列和外键约束的表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.create_tables([Person, Pet])</span><br></pre></td></tr></table></figure>
<p>可以看到 当前目录 已经出现了一个 <code>people.db</code> 的 SQLite 数据库文件。</p>
<h4 id="存储数据"><a href="#存储数据" class="headerlink" title="存储数据"></a>存储数据</h4><p>现在开始存储一些数据，我们将使用 <code>save()</code> 和 <code>create()</code> 方法添加和修改表中的记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line">uncle_bob = Person(name=<span class="string">'Bob'</span>, birthday=date(<span class="number">1960</span>, <span class="number">1</span>, <span class="number">15</span>), is_relative=<span class="keyword">True</span>)</span><br><span class="line">uncle_bob.save() <span class="comment"># bob is now stored in the database. Returns: 1</span></span><br></pre></td></tr></table></figure>
<p>调用 <code>save()</code> 将返回修改的行数。也可使用 <code>create()</code> 方法来添加一个人：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grandma = Person.create(name=<span class="string">'Grandma'</span>, birthday=date(<span class="number">1935</span>, <span class="number">3</span>, <span class="number">1</span>), is_relative=<span class="keyword">True</span>)</span><br><span class="line">herb = Person.create(name=<span class="string">'Herb'</span>, birthday=date(<span class="number">1950</span>, <span class="number">5</span>, <span class="number">5</span>), is_relative=<span class="keyword">False</span>)</span><br></pre></td></tr></table></figure>
<p>如果想更改某行，修改模型实例的属性，然后调用 <code>save()</code> 方法就会同步到数据库了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grandma.name = <span class="string">'Grandma L.'</span></span><br><span class="line">grandma.save()</span><br></pre></td></tr></table></figure>
<p>现在已经在数据库中存储了三个人，让我们给他们一些宠物。奶奶不喜欢宠物，但Herb是宠物的爱好者。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bob_kitty = Pet.create(owner=uncle_bob, name=<span class="string">'Kitty'</span>, animal_type=<span class="string">'cat'</span>)</span><br><span class="line">herb_fido = Pet.create(owner=herb, name=<span class="string">'Fido'</span>, animal_type=<span class="string">'dog'</span>)</span><br><span class="line">herb_mittens = Pet.create(owner=herb, name=<span class="string">'Mittens'</span>, animal_type=<span class="string">'cat'</span>)</span><br><span class="line">herb_mittens_jr = Pet.create(owner=herb, name=<span class="string">'Mittens Jr'</span>, animal_type=<span class="string">'cat'</span>)</span><br></pre></td></tr></table></figure>
<p>经过漫长的时间后，Mittens 生病死亡了，现在从数据库中删的它。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">herb_mittens.delete_instance()</span><br></pre></td></tr></table></figure>
<p><code>delete_instance()</code> 方法也会返回删除的行数。</p>
<p>叔叔 Bob 觉得在 Herb 的房间死了太多动物，所以收养了他的狗 Fido。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">herb_fido.owner = uncle_bob</span><br><span class="line">herb_fido.save()</span><br><span class="line">bob_fido = herb_fido <span class="comment"># rename our variable for clarity</span></span><br></pre></td></tr></table></figure>
<h4 id="检索数据"><a href="#检索数据" class="headerlink" title="检索数据"></a>检索数据</h4><p>数据库的优势在于可以通过SQL语句来检索数据，现在看看 peewee 中是如何检索数据的。</p>
<h5 id="查询一条记录"><a href="#查询一条记录" class="headerlink" title="查询一条记录"></a>查询一条记录</h5><p>让我们从数据库中获取奶奶的记录，从数据库获取单条记录使用 <code>select.get()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grandma = Person.select().where(Person.name == <span class="string">'Grandma L.'</span>).get()</span><br></pre></td></tr></table></figure>
<p>我们也可以使用等效的缩写 <code>Model.get()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grandma = Person.get(Person.name == <span class="string">'Grandma L.'</span>)</span><br></pre></td></tr></table></figure>
<h5 id="列出记录"><a href="#列出记录" class="headerlink" title="列出记录"></a>列出记录</h5><p>让我们列出所有人的记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select():</span><br><span class="line">    print(person.name, person.is_relative)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Bob True
Grandma L. True
Herb False
</code></pre><p>让我们列出所有的猫和它们主人的名字</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query = Pet.select().where(Pet.animal_type == <span class="string">'cat'</span>)</span><br><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> query:</span><br><span class="line">    print(pet.name, pet.owner.name)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Kitty Bob
Mittens Jr Herb
</code></pre><p>但是这样的查询有一个很大的问题，因为我们想要知道宠物主人的名字，但是 Pet 表中并没有这一个字段，所以当访问 <code>pet.owner.name</code> 的时候，peewee 不得不执行额外的查询来检索宠物的所有者，这样的情况通常应该是避免的。</p>
<p>我们应当使用 join 进行关联查询来避免额外的开销</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">query = (Pet</span><br><span class="line">         .select(Pet, Person)</span><br><span class="line">         .join(Person)</span><br><span class="line">         .where(Pet.animal_type == <span class="string">'cat'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> query:</span><br><span class="line">    print(pet.name, pet.owner.name)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Kitty Bob
Mittens Jr Herb
</code></pre><p>让我们看看 Bob 有哪些宠物</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> Pet.select().join(Person).where(Person.name == <span class="string">'Bob'</span>):</span><br><span class="line">    print(pet.name)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Kitty
Fido
</code></pre><p>我们还有一个很酷的方法获取 Bob 的宠物，因为我们已经有一个表示 Bob 的对象，所以我们可以这样做</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> Pet.select().where(Pet.owner == uncle_bob):</span><br><span class="line">    print(pet.name)</span><br></pre></td></tr></table></figure>
<h5 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h5><p>让我们添加一个 <code>order_by()</code> 方法来让它们按照字母顺序排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> Pet.select().where(Pet.owner == uncle_bob).order_by(Pet.name):</span><br><span class="line">    print(pet.name)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Fido
Kitty
</code></pre><p>让我们按照年纪 从年轻到年老列出人们</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select().order_by(Person.birthday.desc()):</span><br><span class="line">    print(person.name, person.birthday)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Bob 1960-01-15
Herb 1950-05-05
Grandma L. 1935-03-01
</code></pre><h5 id="结合过滤器表达式"><a href="#结合过滤器表达式" class="headerlink" title="结合过滤器表达式"></a>结合过滤器表达式</h5><p>Peewee 支持任意嵌套的表达式。让我们得到所有生日不一的人</p>
<p>1940之前的人（Grandma）<br>1959年之后的人（Bob）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">d1940 = date(<span class="number">1940</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">d1960 = date(<span class="number">1960</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">query = (Person</span><br><span class="line">         .select()</span><br><span class="line">         .where((Person.birthday &lt; d1940) | (Person.birthday &gt; d1960)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    print(person.name, person.birthday)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Bob 1960-01-15
Grandma L. 1935-03-01
</code></pre><p>现在看看生日在1940年至1960年之间的人</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query = (Person</span><br><span class="line">         .select()</span><br><span class="line">         .where(Person.birthday.between(d1940, d1960)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    print(person.name, person.birthday)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Herb 1950-05-05
</code></pre><h5 id="聚合和预获取"><a href="#聚合和预获取" class="headerlink" title="聚合和预获取"></a>聚合和预获取</h5><p>现在让我们列出所有的人和他们有多少宠物</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select():</span><br><span class="line">    print(person.name, person.pets.count(), <span class="string">'pets'</span>)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Bob 2 pets
Grandma L. 0 pets
Herb 1 pets
</code></pre><p>在这种情况下，我们又为返回的每个人执行了附加查询！我们可以通过执行join并使用sql函数来聚合结果来避免这种情况。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query = (Person</span><br><span class="line">         .select(Person, fn.COUNT(Pet.id).alias(<span class="string">'pet_count'</span>))</span><br><span class="line">         .join(Pet, JOIN.LEFT_OUTER)  <span class="comment"># include people without pets.</span></span><br><span class="line">         .group_by(Person)</span><br><span class="line">         .order_by(Person.name))</span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    <span class="comment"># "pet_count" becomes an attribute on the returned model instances.</span></span><br><span class="line">    print(person.name, person.pet_count, <span class="string">'pets'</span>)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Bob 2 pets
Grandma L. 0 pets
Herb 1 pets
</code></pre><p>一只宠物只能有一个主人，所以当进行从 Pet 到 Person 的 join 操作时，它们通常都会进行一次匹配。当我们从 Person 到 Pet 的 join 时，情况会不同，因为一个人可能没有宠物，或者他们可能有几只宠物。因为我们使用关系数据库，当我们从 Person 到 Pet 的 join 时，那么每个宠物都会重复每个拥有多个宠物的人。</p>
<p>它看起来像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query = (Person</span><br><span class="line">         .select(Person, Pet)</span><br><span class="line">         .join(Pet, JOIN.LEFT_OUTER)</span><br><span class="line">         .order_by(Person.name, Pet.name))</span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    <span class="comment"># We need to check if they have a pet instance attached, since not all</span></span><br><span class="line">    <span class="comment"># people have pets.</span></span><br><span class="line">    <span class="keyword">if</span> hasattr(person, <span class="string">'pet'</span>):</span><br><span class="line">        print(person.name, person.pet.name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(person.name, <span class="string">'no pets'</span>)</span><br></pre></td></tr></table></figure></p>
<p>输出：</p>
<pre><code>Bob Fido
Bob Kitty
Grandma L. no pets
Herb Mittens Jr
</code></pre><p>通常这种类型的重复是不可取的，我们可以使用一种 <code>prefetch()</code> 的特殊方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query = Person.select().order_by(Person.name).prefetch(Pet)</span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    print(person.name)</span><br><span class="line">    <span class="keyword">for</span> pet <span class="keyword">in</span> person.pets:</span><br><span class="line">        print(<span class="string">'  *'</span>, pet.name)</span><br></pre></td></tr></table></figure>
<h5 id="SQL-函数"><a href="#SQL-函数" class="headerlink" title="SQL 函数"></a>SQL 函数</h5><p>这将使用一个 SQL 方法来查找名字以大写或者小写 g 开头的人</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">expression = fn.Lower(fn.Substr(Person.name, <span class="number">1</span>, <span class="number">1</span>)) == <span class="string">'g'</span></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select().where(expression):</span><br><span class="line">    print(person.name)</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<pre><code>Grandma L.
</code></pre><p>这只是 peewee 的基础，你还可以使查询更复杂，其他的 SQL 子句也可以使用，比如 <code>group_by()</code>, <code>having()</code>, <code>limit()</code>, <code>offset()</code></p>
<h4 id="关闭数据库"><a href="#关闭数据库" class="headerlink" title="关闭数据库"></a>关闭数据库</h4><p>当使用完数据库，我们应该关闭它</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.close()</span><br></pre></td></tr></table></figure>
<h4 id="从数据库导出模型"><a href="#从数据库导出模型" class="headerlink" title="从数据库导出模型"></a>从数据库导出模型</h4><p>如果已经存在的数据库，可以使用模型生成器 <code>pwiz</code> 自动生成 peewee 模型</p>
<p>比如将刚才 <code>people.db</code> 的数据再导出模型</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pwiz -e sqlite people.db</span><br></pre></td></tr></table></figure>
<p>如果想导出 MySQL 库的数据 可以这样做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pwiz -e mysql -H localhost -p3306 -uuser -Ppassword  dbname &gt; db.py</span><br></pre></td></tr></table></figure></p>
<h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><h4 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h4><p>Peewee 的 <code>Database</code> 对象表示到数据库的连接。<code>Database</code> 类将实例化打开的数据库连接所需的所有信息，这些信息可用于：</p>
<ul>
<li>打开和关闭连接</li>
<li>执行查询请求</li>
<li>事务管理</li>
<li>内省表，列，索引和约束</li>
<li>模型整合</li>
</ul>
<p>peewee支持 SQLite, MySQL 和 Postgres。每个数据库类都提供了一些基本的数据库特定的配置选项</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># SQLite database using WAL journal mode and 64MB cache.</span></span><br><span class="line">sqlite_db = SqliteDatabase(<span class="string">'/path/to/app.db'</span>, pragmas=(</span><br><span class="line">    (<span class="string">'journal_mode'</span>, <span class="string">'wal'</span>),</span><br><span class="line">    (<span class="string">'cache_size'</span>, <span class="number">-1024</span> * <span class="number">64</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to a MySQL database on network.</span></span><br><span class="line">mysql_db = MySQLDatabase(<span class="string">'dbname'</span>, user=<span class="string">'root'</span>, password=<span class="string">'db_password'</span>,</span><br><span class="line">                         host=<span class="string">'10.1.0.8'</span>, port=<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to a Postgres database.</span></span><br><span class="line">pg_db = PostgresqlDatabase(<span class="string">'my_app'</span>, user=<span class="string">'postgres'</span>, password=<span class="string">'secret'</span>,</span><br><span class="line">                           host=<span class="string">'10.1.0.9'</span>, port=<span class="number">5432</span>)</span><br></pre></td></tr></table></figure>
<p>Peewee 通过特定的扩展模块提供了对 SQLite 和 Postgres 的高级支持。要使用扩展功能，需要导入特殊数据库模块的 <code>Database</code> 类</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playhouse.sqlite_ext <span class="keyword">import</span> SqliteExtDatabase</span><br><span class="line"><span class="comment"># Use SQLite (will register a REGEXP function and set busy timeout to 3s).</span></span><br><span class="line">db = SqliteExtDatabase(<span class="string">'/path/to/app.db'</span>, regexp_function=<span class="keyword">True</span>, timeout=<span class="number">3</span>,</span><br><span class="line">                       pragmas=((<span class="string">'journal_mode'</span>, <span class="string">'wal'</span>),))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> playhouse.postgres_ext <span class="keyword">import</span> PostgresqlExtDatabase</span><br><span class="line"><span class="comment"># Use Postgres (and register hstore extension).</span></span><br><span class="line">db = PostgresqlExtDatabase(<span class="string">'dbname'</span>, user=<span class="string">'postgres'</span>, register_hstore=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p><code>Database</code> 类的初始化方法第一个参数是期望的数据库名称，剩下的参数将传给建立连接的底层数据库驱动程序</p>
<h4 id="使用URL连接数据库"><a href="#使用URL连接数据库" class="headerlink" title="使用URL连接数据库"></a>使用URL连接数据库</h4><p><code>playhouse</code> 模块提供了一个 <code>connect()</code> 函数，它接受数据库URL 并返回一个数据库实例</p>
<p>示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> playhouse.db_url <span class="keyword">import</span> connect</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to the database URL defined in the environment, falling</span></span><br><span class="line"><span class="comment"># back to a local Sqlite database if no database URL is specified.</span></span><br><span class="line">db = connect(os.environ.get(<span class="string">'DATABASE'</span>) <span class="keyword">or</span> <span class="string">'sqlite:///default.db'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br></pre></td></tr></table></figure></p>
<p>数据库URL示例：</p>
<ul>
<li><code>sqlite:///my_database.db</code> 将为 <code>my_database.db</code> 在当前目录创建 <code>SqliteDatabase</code> 实例。</li>
<li><code>sqlite:///:memory</code> 将要创建在内存中的 <code>SqliteDatabase</code> 实例。</li>
<li><code>postgresql://postgres:my_password@localhost:5432/my_database</code> 将创建一个 <code>PostgresqlDatabase</code> 实例。并提供用户名和密码以及连接的主机和端口</li>
<li><code>mysql://user:passwd@ip:port/my_db</code> 将为本地 MySQL 数据库创建 <code>MySQLDatabase</code> 的实例。</li>
</ul>
<h4 id="数据库运行时配置"><a href="#数据库运行时配置" class="headerlink" title="数据库运行时配置"></a>数据库运行时配置</h4><p>有时候直到运行时数据库配置才会直到，这些值可以从配置文件或者环境变量获取。在这种情况下可以通过将 <code>None</code> 指定为数据库名来推迟数据库的初始化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">database = SqliteDatabase(<span class="keyword">None</span>)  <span class="comment"># Un-initialized database.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = database</span><br></pre></td></tr></table></figure>
<p>这时候尝试连接数据库时会抛出一个异常</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">database.connect()</span><br><span class="line">Exception: Error, database <span class="keyword">not</span> properly initialized before opening connection</span><br></pre></td></tr></table></figure>
<p>可以手动调用 init() 方法来初始化数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">database_name = raw_input(<span class="string">'What is the name of the db? '</span>)</span><br><span class="line">database.init(database_name, host=<span class="string">'localhost'</span>, user=<span class="string">'postgres'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="动态定义数据库"><a href="#动态定义数据库" class="headerlink" title="动态定义数据库"></a>动态定义数据库</h4><p>为了更好地控制数据库的定义/初始化方式，可以使用 <code>Proxy()</code> 方法，<code>Proxy()</code> 方法充当占位符，然后在运行时您可以将其交换出一个不同的对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">database_proxy = Proxy()  <span class="comment"># Create a proxy for our db.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = database_proxy  <span class="comment"># Use proxy for our DB.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username = CharField()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on configuration, use a different database.</span></span><br><span class="line"><span class="keyword">if</span> app.config[<span class="string">'DEBUG'</span>]:</span><br><span class="line">    database = SqliteDatabase(<span class="string">'local.db'</span>)</span><br><span class="line"><span class="keyword">elif</span> app.config[<span class="string">'TESTING'</span>]:</span><br><span class="line">    database = SqliteDatabase(<span class="string">':memory:'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    database = PostgresqlDatabase(<span class="string">'mega_production_db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure our proxy to use the db we specified in config.</span></span><br><span class="line">database_proxy.initialize(database)</span><br></pre></td></tr></table></figure>
<h4 id="连接管理"><a href="#连接管理" class="headerlink" title="连接管理"></a>连接管理</h4><p>打开一个数据库连接，使用 <code>Database.connect()</code> 方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db = SqliteDatabase(<span class="string">':memory:'</span>) </span><br><span class="line">db.connect()</span><br></pre></td></tr></table></figure>
<p>如果尝试再次调用 <code>connect()</code> 将会得到一个 <code>OperationalError</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.connect()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"/home/charles/pypath/peewee.py"</span>, line <span class="number">2390</span>, <span class="keyword">in</span> connect</span><br><span class="line">    <span class="keyword">raise</span> OperationalError(<span class="string">'Connection already opened.'</span>)</span><br><span class="line">peewee.OperationalError: Connection already opened.</span><br></pre></td></tr></table></figure>
<p>为了阻止这个异常，可以添加参数 <code>reuse_if_open = True</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.connect()</span><br><span class="line">db.connect(reuse_if_open = <span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注意：如果数据库连接已打开，则返回 <code>False</code></p>
</blockquote>
<p>调用 <code>close()</code> 将关闭已打开的数据库连接，再次调用 <code>close()</code> 则只会返回 <code>False</code></p>
<blockquote>
<p>小提示：虽然在使用之前没必要显式连接到数据库，但时最好明确连接。这样如果连接失败，在打开的时候就可以捕获该异常，而不是执行数据库操作的时候。如果在使用数据库连接池。则需要调用 <code>connect()</code> 和 <code>close()</code> 以确保连接正确回收。</p>
</blockquote>
<p>Peewee 使用线程本地存储跟踪连接状态，使得 Peewee 数据库对象可以安全的用于多个线程，每个线程都拥有自己的连接。</p>
<p>数据库对象本身可以使用 <code>with</code> 上下文管理器，在上下文管理器中打开一个连接，在连接关闭之前提交，如果错误发生，这种情况下事务将回滚。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.is_closed()  <span class="comment"># True</span></span><br><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    print(db.is_closed())  <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line">db.is_closed()  <span class="comment"># True</span></span><br></pre></td></tr></table></figure>
<p><code>connection_context()</code> 方法也可用于装饰器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@db.connection_context()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare_database</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># DB connection will be managed by the decorator, which opens</span></span><br><span class="line">    <span class="comment"># a connection, calls function, and closes upon returning.</span></span><br><span class="line">    db.create_tables(MODELS)  <span class="comment"># Create schema.</span></span><br><span class="line">    load_fixture_data(db)</span><br></pre></td></tr></table></figure>
<p>使用 <code>Database.connection()</code> 方法可以获取底层数据库驱动的原始对象。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.connection()</span><br><span class="line"><span class="comment"># &lt;sqlite3.Connection object at 0x0574DF20&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h4><p>连接池由 <code>Playhouse</code> 扩展库中包含的池模块提供</p>
<ul>
<li>超时后的连接收回</li>
<li>最大连接数上限</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playhouse.pool <span class="keyword">import</span> PooledMySQLDatabase</span><br><span class="line"></span><br><span class="line">db = PooledMySQLDatabase(</span><br><span class="line">    <span class="string">'my_database'</span>,</span><br><span class="line">    max_connections=<span class="number">8</span>,</span><br><span class="line">    stale_timeout=<span class="number">300</span>,</span><br><span class="line">    time_out=<span class="number">60</span>,</span><br><span class="line">    user=<span class="string">'root'</span>, </span><br><span class="line">    password=<span class="string">'db_password'</span>,</span><br><span class="line">    host=<span class="string">'10.1.0.8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br></pre></td></tr></table></figure>
<p>以下数据库连接池类可用：</p>
<ul>
<li><code>PooledPostgresqlDatabase</code></li>
<li><code>PooledPostgresqlExtDatabase</code></li>
<li><code>PooledMySQLDatabase</code></li>
<li><code>PooledSqliteDatabase</code></li>
<li><code>PooledSqliteExtDatabase</code></li>
</ul>
<h4 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h4><p>如果想直接执行 SQL 语句，可以使用 <code>Database.execute_sql()</code> 方法。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db = SqliteDatabase(<span class="string">'my_app.db'</span>)</span><br><span class="line">db.connect()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of executing a simple query and ignoring the results.</span></span><br><span class="line">db.execute_sql(<span class="string">"ATTACH DATABASE ':memory:' AS cache;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of iterating over the results of a query using the cursor.</span></span><br><span class="line">cursor = db.execute_sql(<span class="string">'SELECT * FROM users WHERE status = ?'</span>, (ACTIVE,))</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> cursor.fetchall():</span><br><span class="line">    <span class="comment"># Do something with row, which is a tuple containing column data.</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h4 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h4><p>Peewee 提供了几个用于处理事务的接口，最常用的是 <code>Database.atomic()</code> 方法，它也支持嵌套事务。<br>如果包装块中发生异常，则当前事务将回滚，否则将提交。</p>
<p>而在 <code>atomic()</code> 上下文管理器包装的代码块内部时，可以通过调用 <code>Transaction.rollback()</code> 或者 <code>Transaction.commit()</code> 显性的回滚或提交事务。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db.atomic() <span class="keyword">as</span> transaction:  <span class="comment"># Opens new transaction.</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        save_some_objects()</span><br><span class="line">    <span class="keyword">except</span> ErrorSavingData:</span><br><span class="line">        <span class="comment"># Because this block of code is wrapped with "atomic", a</span></span><br><span class="line">        <span class="comment"># new transaction will begin automatically after the call</span></span><br><span class="line">        <span class="comment"># to rollback().</span></span><br><span class="line">        transaction.rollback()</span><br><span class="line">        error_saving = <span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    create_report(error_saving=error_saving)</span><br><span class="line">    <span class="comment"># Note: no need to call commit. Since this marks the end of the</span></span><br><span class="line">    <span class="comment"># wrapped block of code, the `atomic` context manager will</span></span><br><span class="line">    <span class="comment"># automatically call commit for us.</span></span><br></pre></td></tr></table></figure>
<p><code>atomic()</code> 不仅可以用作上下文管理器，还可用做装饰器</p>
<p>用作装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">db = SqliteDatabase(<span class="string">':memory:'</span>)</span><br><span class="line"><span class="keyword">with</span> db.atomic() <span class="keyword">as</span> txn:</span><br><span class="line">    <span class="comment"># This is the outer-most level, so this block corresponds to</span></span><br><span class="line">    <span class="comment"># a transaction.</span></span><br><span class="line">    User.create(username=<span class="string">'charlie'</span>)</span><br><span class="line">    <span class="keyword">with</span> db.atomic() <span class="keyword">as</span> nested_txn:</span><br><span class="line">        <span class="comment"># This block corresponds to a savepoint.</span></span><br><span class="line">        User.create(username=<span class="string">'huey'</span>)</span><br><span class="line">        <span class="comment"># This will roll back the above create() query.</span></span><br><span class="line">        nested_txn.rollback()</span><br><span class="line">    User.create(username=<span class="string">'mickey'</span>)</span><br><span class="line"><span class="comment"># When the block ends, the transaction is committed (assuming no error</span></span><br><span class="line"><span class="comment"># occurs). At that point there will be two users, "charlie" and "mickey".</span></span><br></pre></td></tr></table></figure></p>
<p>还可使用 <code>atomic()</code> 方法来获取或创建数据：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> db.atomic():</span><br><span class="line">        user = User.create(username=username)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Success'</span></span><br><span class="line"><span class="keyword">except</span> peewee.IntegrityError:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Failure: %s is already in use.'</span> % username</span><br></pre></td></tr></table></figure></p>
<p>用作装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@db.atomic()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">(username)</span>:</span></span><br><span class="line">    <span class="comment"># This statement will run in a transaction. If the caller is already</span></span><br><span class="line">    <span class="comment"># running in an `atomic` block, then a savepoint will be used instead.</span></span><br><span class="line">    <span class="keyword">return</span> User.create(username=username)</span><br><span class="line">create_user(<span class="string">'charlie'</span>)</span><br></pre></td></tr></table></figure></p>
<p>保存点：</p>
<p>可以像显式创建事务一样，也可以使用 <code>savepoint()</code> 方法显式创建保存点。保存点必须发生在一个事务中，但可以任意嵌套。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db.transaction() <span class="keyword">as</span> txn:</span><br><span class="line">    <span class="keyword">with</span> db.savepoint() <span class="keyword">as</span> sp:</span><br><span class="line">        User.create(username=<span class="string">'mickey'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> db.savepoint() <span class="keyword">as</span> sp2:</span><br><span class="line">        User.create(username=<span class="string">'zaizee'</span>)</span><br><span class="line">        sp2.rollback()  <span class="comment"># "zaizee" will not be saved, but "mickey" will be.</span></span><br></pre></td></tr></table></figure>
<p>如果手动提交或回滚保存点，则不会自动创建新的保存点。这与事务的行为不同，它会在手动提交/回滚之后自动打开新的事务。</p>
<h4 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h4><p>所有查询都使用标准库 <code>logging</code> 模块记录到 peewee 命名空间。查询使用 <code>DEBUG</code> 级别。<br>如果你对查询有兴趣，你可以简单地注册一个处理程序。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Print all queries to stderr.</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logger = logging.getLogger(<span class="string">'peewee'</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line">logger.addHandler(logging.StreamHandler())</span><br></pre></td></tr></table></figure>
<h3 id="模型和字段"><a href="#模型和字段" class="headerlink" title="模型和字段"></a>模型和字段</h3><p>模型类、字段实例和模型实例都映射到了数据库</p>
<table>
<thead>
<tr>
<th>项</th>
<th>对应于</th>
</tr>
</thead>
<tbody>
<tr>
<td>模型类</td>
<td>数据库</td>
</tr>
<tr>
<td>字段实例</td>
<td>表中的列</td>
</tr>
<tr>
<td>模型实例</td>
<td>表中的行</td>
</tr>
</tbody>
</table>
<p>下面的例子演示了定义数据库连接和模型类的方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个数据库的实例</span></span><br><span class="line">db = SqliteDatabase(<span class="string">'my_app.db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个指定数据库的基础模型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义模型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username = CharField(unique=<span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义模型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tweet</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">'tweets'</span>)</span><br><span class="line">    message = TextField()</span><br><span class="line">    created_date = DateTimeField(default=datetime.datetime.now)</span><br><span class="line">    is_published = BooleanField(default=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<h4 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h4><p>字段类用于描述模型属性到数据库字段的映射，每一个字段类型都有一个相应的 SQL 存储类型，如 <code>varchar</code>, <code>int</code>。并且python的数据类型和 SQL 存储类型之间的转换是透明的。</p>
<p>在创建模型类时，字段被定义为类属性。有一种特殊类型的字段 <code>ForeignKeyField</code>，可以以更直观的方式表示模型之间的外键关系。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">'messages'</span>)</span><br><span class="line">    body = TextField()</span><br><span class="line">    send_date = DateTimeField()</span><br></pre></td></tr></table></figure>
<p>这允许你编写如下的代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(some_message.user.username)</span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> some_user.messages:</span><br><span class="line">    print(message.body)</span><br></pre></td></tr></table></figure>
<h5 id="字段类型表"><a href="#字段类型表" class="headerlink" title="字段类型表"></a>字段类型表</h5><table>
<thead>
<tr>
<th>字段类型</th>
<th>Sqlite</th>
<th>Postgresql</th>
<th>MySQL</th>
</tr>
</thead>
<tbody>
<tr>
<td>IntegerField</td>
<td>integer</td>
<td>integer</td>
<td>integer</td>
</tr>
<tr>
<td>BigIntegerField</td>
<td>integer</td>
<td>bigint</td>
<td>bigint</td>
</tr>
<tr>
<td>SmallIntegerField</td>
<td>integer</td>
<td>smallint</td>
<td>smallint</td>
</tr>
<tr>
<td>AutoField</td>
<td>integer</td>
<td>serial</td>
<td>integer</td>
</tr>
<tr>
<td>FloatField</td>
<td>real</td>
<td>real</td>
<td>real</td>
</tr>
<tr>
<td>DoubleField</td>
<td>real</td>
<td>double precision</td>
<td>double precision</td>
</tr>
<tr>
<td>DecimalField</td>
<td>decimal</td>
<td>numeric</td>
<td>numeric</td>
</tr>
<tr>
<td>CharField</td>
<td>varchar</td>
<td>varchar</td>
<td>varchar</td>
</tr>
<tr>
<td>FixedCharField</td>
<td>char</td>
<td>char</td>
<td>char</td>
</tr>
<tr>
<td>TextField</td>
<td>text</td>
<td>text</td>
<td>longtext</td>
</tr>
<tr>
<td>BlobField</td>
<td>blob</td>
<td>bytea</td>
<td>blob</td>
</tr>
<tr>
<td>BitField</td>
<td>integer</td>
<td>bigint</td>
<td>bigint</td>
</tr>
<tr>
<td>BigBitField</td>
<td>blob</td>
<td>bytea</td>
<td>blob</td>
</tr>
<tr>
<td>UUIDField</td>
<td>text</td>
<td>uuid</td>
<td>varchar(40)</td>
</tr>
<tr>
<td>DateTimeField</td>
<td>datetime</td>
<td>timestamp</td>
<td>datetime</td>
</tr>
<tr>
<td>DateField</td>
<td>date</td>
<td>date</td>
<td>date</td>
</tr>
<tr>
<td>TimeField</td>
<td>time</td>
<td>time</td>
<td>time</td>
</tr>
<tr>
<td>TimestampField</td>
<td>integer</td>
<td>integer</td>
<td>integer</td>
</tr>
<tr>
<td>IPField</td>
<td>integer</td>
<td>bigint</td>
<td>bigint</td>
</tr>
<tr>
<td>BooleanField</td>
<td>integer</td>
<td>boolean</td>
<td>bool</td>
</tr>
<tr>
<td>BareField</td>
<td>untyped</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>ForeignKeyField</td>
<td>integer</td>
<td>integer</td>
<td>integer</td>
</tr>
</tbody>
</table>
<h5 id="字段初始参数"><a href="#字段初始参数" class="headerlink" title="字段初始参数"></a>字段初始参数</h5><p>所有字段类型接受的参数与默认值</p>
<ul>
<li><code>null = False</code> – 布尔值，表示是否允许存储空值</li>
<li><code>index = False</code> – 布尔值，表示是否在此列上创建索引</li>
<li><code>unique = False</code> – 布尔值，表示是否在此列上创建唯一索引</li>
<li><code>column_name = None</code> – 如果和属性名不同，底层的数据库字段使用这个值</li>
<li><code>default = None</code> – 字段默认值，可以是一个函数，将使用函数返回的值</li>
<li><code>primary_key = False</code> – 布尔值，此字段是否是主键</li>
<li><code>constraints = None</code> - 一个或多个约束的列表 例如：<code>[Check(&#39;price &gt; 0&#39;)]</code></li>
<li><code>sequence = None</code> – 序列填充字段（如果后端数据库支持）</li>
<li><code>collation = None</code> – 用于排序字段/索引的排序规则</li>
<li><code>unindexed = False</code> – 表示虚拟表上的字段应该是未索引的（仅用于sqlite）</li>
<li><code>choices = None</code> – 一个可选的迭代器，包含两元数组<code>（value, display）</code></li>
<li><code>help_text = None</code> – 表示字段的帮助文本</li>
<li><code>verbose_name = None</code> – 表示用户友好的字段名</li>
</ul>
<p>一些字段的特殊参数</p>
<table>
<thead>
<tr>
<th>字段类型</th>
<th>特殊参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>CharField</td>
<td>max_length</td>
</tr>
<tr>
<td>FixedCharField</td>
<td>max_length</td>
</tr>
<tr>
<td>DateTimeField</td>
<td>formats</td>
</tr>
<tr>
<td>DateField</td>
<td>formats</td>
</tr>
<tr>
<td>TimeField</td>
<td>formats</td>
</tr>
<tr>
<td>TimestampField</td>
<td>resolution, utc</td>
</tr>
<tr>
<td>DecimalField</td>
<td>max_digits, decimal_places, auto_round, rounding</td>
</tr>
<tr>
<td>ForeignKeyField</td>
<td>model, field, backref, on_delete, on_update, extra</td>
</tr>
<tr>
<td>BareField</td>
<td>coerce</td>
</tr>
</tbody>
</table>
<h5 id="字段默认值"><a href="#字段默认值" class="headerlink" title="字段默认值"></a>字段默认值</h5><p>创建对象时，peewee 可以为字段提供默认值，例如将字段的默认值<code>null</code>设置为<code>0</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    context = TextField()</span><br><span class="line">    read_count = IntegerField(default=<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p>
<p>如果想提供一个动态值，比如当前时间，可以传入一个函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    context = TextField()</span><br><span class="line">    timestamp = DateTimeField(default=datetime.datetime.now)</span><br></pre></td></tr></table></figure>
<p>数据库还可以提供字段的默认值。虽然 peewee 没有明确提供设置服务器端默认值的 API，但您可以使用 <code>constraints</code> 参数来指定服务器默认值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    context = TextField()</span><br><span class="line">    timestamp = DateTimeField(constraints=[SQL(<span class="string">'DEFAULT CURRENT_TIMESTAMP'</span>)])</span><br></pre></td></tr></table></figure>
<h5 id="外键字段"><a href="#外键字段" class="headerlink" title="外键字段"></a>外键字段</h5><p><code>foreignkeyfield</code> 是一种特殊的字段类型，允许一个模型引用另一个模型。通常外键将包含与其相关的模型的主键（但您可以通过指定一个字段来指定特定的列）。</p>
<p>可以通过追加 <code>_id</code> 的外键字段名称来访问原始外键值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tweets = Tweet.select()</span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> tweets:</span><br><span class="line">    <span class="comment"># Instead of "tweet.user", we will just get the raw ID value stored</span></span><br><span class="line">    <span class="comment"># in the column.</span></span><br><span class="line">    print(tweet.user_id, tweet.message)</span><br></pre></td></tr></table></figure>
<p><code>ForeignKeyField</code> 允许将反向引用属性绑定到目标模型。隐含地，这个属性将被命名为 <code>classname_set</code>，其中 classname 是类的小写名称，但可以通过参数覆盖 backref：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    from_user = ForeignKeyField(User)</span><br><span class="line">    to_user = ForeignKeyField(User, backref=<span class="string">'received_messages'</span>)</span><br><span class="line">    text = TextField()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> some_user.message_set:</span><br><span class="line">    <span class="comment"># We are iterating over all Messages whose from_user is some_user.</span></span><br><span class="line">    print(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> some_user.received_messages:</span><br><span class="line">    <span class="comment"># We are iterating over all Messages whose to_user is some_user</span></span><br><span class="line">    print(message)</span><br></pre></td></tr></table></figure>
<h5 id="日期字段"><a href="#日期字段" class="headerlink" title="日期字段"></a>日期字段</h5><p><code>DateField</code> <code>TimeField</code> 和 <code>DateTimeField</code> 字段</p>
<p><code>DateField</code> 包含 <code>year</code> <code>month</code> <code>day</code><br><code>TimeField</code> 包含 <code>hour</code> <code>minute</code> <code>second</code><br><code>DateTimeField</code> 包含以上所有</p>
<h4 id="创建模型表"><a href="#创建模型表" class="headerlink" title="创建模型表"></a>创建模型表</h4><p>为了开始使用模型，它需要打开一个到数据库的连接并创建表。Peewee 将运行必要的 <code>CREATE TABLE</code> 查询，另外创建约束和索引。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Connect to our database.</span></span><br><span class="line">db.connect()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the tables.</span></span><br><span class="line">db.create_tables([User, Tweet])</span><br></pre></td></tr></table></figure>
<p>默认情况下，Peewee 将确定表是否已经存在，并有条件地创建它们。如果你想禁用它，指定 <code>safe=False</code>。</p>
<h4 id="模型选项和表格元数据"><a href="#模型选项和表格元数据" class="headerlink" title="模型选项和表格元数据"></a>模型选项和表格元数据</h4><p>为了不污染模型空间，模型的配置被放置在名为 <code>Meta</code> 的特殊类中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line">contacts_db = SqliteDatabase(<span class="string">'contacts.db'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = contacts_db</span><br></pre></td></tr></table></figure>
<p>模型一旦定义，访问元数据应该访问 <code>ModelClass._meta</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Person._meta.fields</span><br><span class="line">Person._meta.primary_key</span><br><span class="line">Person._meta.database</span><br></pre></td></tr></table></figure>
<p>有几个选项可以指定为Meta属性。虽然大多数选项都是可继承的，但有些选项是特定于表的，不会被子类继承。</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>含义</th>
<th>是否可继承</th>
</tr>
</thead>
<tbody>
<tr>
<td>database</td>
<td>模型的数据库</td>
<td>是</td>
</tr>
<tr>
<td>table_name</td>
<td>用于存储数据的表的名称</td>
<td>否</td>
</tr>
<tr>
<td>table_function</td>
<td>函数动态生成表名</td>
<td>是</td>
</tr>
<tr>
<td>indexes</td>
<td>要索引的字段列表</td>
<td>是</td>
</tr>
<tr>
<td>primary_key</td>
<td>一个 <code>CompositeKey</code> 实例</td>
<td>是</td>
</tr>
<tr>
<td>constraints</td>
<td>表约束列表</td>
<td>是</td>
</tr>
<tr>
<td>schema</td>
<td>模型的数据库概要</td>
<td>是</td>
</tr>
<tr>
<td>only_save_dirty</td>
<td>当调用 <code>model.save()</code> 时，只保存脏字段</td>
<td>是</td>
</tr>
<tr>
<td>options</td>
<td>用于创建表扩展选项的字典</td>
<td>是</td>
</tr>
<tr>
<td>table_alias</td>
<td>用于查询中的表的别名</td>
<td>否</td>
</tr>
<tr>
<td>depends_on</td>
<td>此表依赖于另一个表的创建</td>
<td>否</td>
</tr>
<tr>
<td>without_rowid</td>
<td>指示表不应该有rowid（仅限SQLite）</td>
<td>否</td>
</tr>
</tbody>
</table>
<p>不可被继承的例子</p>
<pre><code>&gt;&gt;&gt; db = SqliteDatabase(&apos;:memory:&apos;)
&gt;&gt;&gt; class ModelOne(Model):
...     class Meta:
...         database = db
...         table_name = &apos;model_one_tbl&apos;
...
&gt;&gt;&gt; class ModelTwo(ModelOne):
...     pass
...
&gt;&gt;&gt; ModelOne._meta.database is ModelTwo._meta.database
True
&gt;&gt;&gt; ModelOne._meta.table_name == ModelTwo._meta.table_name
False
</code></pre><p>自定义主键或者没有主键可以用 <code>CompositeKey</code> 或者将主键设置为 <code>False</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogToTag</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="string">"""A simple "through" table for many-to-many relationship."""</span></span><br><span class="line">    blog = ForeignKeyField(Blog)</span><br><span class="line">    tag = ForeignKeyField(Tag)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = CompositeKey(<span class="string">'blog'</span>, <span class="string">'tag'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoPrimaryKey</span><span class="params">(Model)</span>:</span></span><br><span class="line">    data = IntegerField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h4 id="索引和约束"><a href="#索引和约束" class="headerlink" title="索引和约束"></a>索引和约束</h4><p>Peewee 可以在单列或多列上创建索引，可以包含 <code>UNIQUE</code> 约束。Peewee 还在模型和字段上支持用户定义的约束。</p>
<h5 id="单列索引和约束"><a href="#单列索引和约束" class="headerlink" title="单列索引和约束"></a>单列索引和约束</h5><p>单列索引是使用字段初始化参数定义的。以下示例在用户名字段上添加唯一索引，并在电子邮件字段上添加常规索引：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">User</span> （<span class="title">Model</span> ）：</span></span><br><span class="line">    username  =  CharField （unique = True ）</span><br><span class="line">    email  =  CharField （index = <span class="keyword">True</span> ）</span><br></pre></td></tr></table></figure>
<p>要在列上添加用户定义的约束，可以使用constraints参数传递它 。您可能希望将默认值指定为架构的一部分，或者添加一个 CHECK 约束，例如：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField(unique=<span class="keyword">True</span>)</span><br><span class="line">    price = DecimalField(constraints=[Check(<span class="string">'price &lt; 10000'</span>)])</span><br><span class="line">    created = DateTimeField(</span><br><span class="line">        constraints=[SQL(<span class="string">"DEFAULT (datetime('now'))"</span>)])</span><br></pre></td></tr></table></figure>
<h5 id="多列索引"><a href="#多列索引" class="headerlink" title="多列索引"></a>多列索引</h5><p>多列索引可以使用嵌套元组定义为元属性。每个数据库索引都是一个两个元素的元组，第一部分是字段名称的元组，第二部分是布尔值，指示索引是否应该是唯一的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span><span class="params">(Model)</span>:</span></span><br><span class="line">    from_acct = CharField()</span><br><span class="line">    to_acct = CharField()</span><br><span class="line">    amount = DecimalField()</span><br><span class="line">    date = DateTimeField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        indexes = (</span><br><span class="line">            <span class="comment"># create a unique on from/to/date</span></span><br><span class="line">            ((<span class="string">'from_acct'</span>, <span class="string">'to_acct'</span>, <span class="string">'date'</span>), <span class="keyword">True</span>),</span><br><span class="line">            <span class="comment"># create a non-unique on from/to</span></span><br><span class="line">            ((<span class="string">'from_acct'</span>, <span class="string">'to_acct'</span>), <span class="keyword">False</span>),</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h5 id="创建高级索引"><a href="#创建高级索引" class="headerlink" title="创建高级索引"></a>创建高级索引</h5><p>Peewee 支持更结构化的 API，以便使用该 <code>Model.add_index()</code> 方法在模型上声明索引，或直接使用 <code>ModelIndexhelper</code> 类。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = TextField()</span><br><span class="line">    timestamp = TimestampField()</span><br><span class="line">    status = IntegerField()</span><br><span class="line">    flags = IntegerField()</span><br><span class="line"><span class="comment"># Add an index on "name" and "timestamp" columns.</span></span><br><span class="line">Article.add_index(Article.name, Article.timestamp)</span><br><span class="line"><span class="comment"># Add a partial index on name and timestamp where status = 1.</span></span><br><span class="line">Article.add_index(Article.name, Article.timestamp,</span><br><span class="line">                  where=(Article.status == <span class="number">1</span>))</span><br><span class="line"><span class="comment"># Create a unique index on timestamp desc, status &amp; 4.</span></span><br><span class="line">idx = Article.index(</span><br><span class="line">    Article.timestamp.desc(),</span><br><span class="line">    Article.flags.bin_and(<span class="number">4</span>),</span><br><span class="line">    unique=<span class="keyword">True</span>)</span><br><span class="line">Article.add_index(idx)</span><br></pre></td></tr></table></figure>
<h5 id="表约束"><a href="#表约束" class="headerlink" title="表约束"></a>表约束</h5><p>Peewee允许您为您添加任意约束Model，这将在创建模式时成为表定义的一部分。</p>
<p>例如，假设您有一个具有两列组合主键的人员表格，即人员的姓名。您希望将另一个表与人员表相关联，为此，您需要定义一个外键约束：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Model)</span>:</span></span><br><span class="line">    first = CharField()</span><br><span class="line">    last = CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = CompositeKey(<span class="string">'first'</span>, <span class="string">'last'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pet</span><span class="params">(Model)</span>:</span></span><br><span class="line">    owner_first = CharField()</span><br><span class="line">    owner_last = CharField()</span><br><span class="line">    pet_name = CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        constraints = [SQL(<span class="string">'FOREIGN KEY(owner_first, owner_last) '</span></span><br><span class="line">                           <span class="string">'REFERENCES person(first, last)'</span>)]</span><br></pre></td></tr></table></figure>
<p>也可以使用 <code>CHECK</code> 在表级别实施约束：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField(unique=<span class="keyword">True</span>)</span><br><span class="line">    price = DecimalField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        constraints = [Check(<span class="string">'price &lt; 10000'</span>)]</span><br></pre></td></tr></table></figure>
<h4 id="其他主键"><a href="#其他主键" class="headerlink" title="其他主键"></a>其他主键</h4><h5 id="非整数主键"><a href="#非整数主键" class="headerlink" title="非整数主键"></a>非整数主键</h5><p>如果想使用非整数主键，可以在创建字段时指定 <code>primary_key=True</code>。当希望使用非自动增量主键为模型创建新实例时，您需要确保 <code>save()</code> 指定 <code>force_insert=True</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UUIDModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    id = UUIDField(primary_key=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>自动递增ID在新行插入数据库时​​会自动生成，当调用 <code>save()</code> 时 peewee 会根据主键值的存在性来确定是否执行 <code>insert</code> 和 <code>update</code>。由于在上一个例子中，数据库驱动程序不会生成新的ID，所以需要手动指定它。在第一次调用 <code>save()</code> 时，传入：<code>force_insert = True</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="comment"># This works because .create() will specify `force_insert=True`.</span></span><br><span class="line">obj1 = UUIDModel.create(id=uuid.uuid4())</span><br><span class="line"><span class="comment"># This will not work, however. Peewee will attempt to do an update:</span></span><br><span class="line">obj2 = UUIDModel(id=uuid.uuid4())</span><br><span class="line">obj2.save() <span class="comment"># WRONG</span></span><br><span class="line">obj2.save(force_insert=<span class="keyword">True</span>) <span class="comment"># CORRECT</span></span><br><span class="line"><span class="comment"># Once the object has been created, you can call save() normally.</span></span><br><span class="line">obj2.save()</span><br></pre></td></tr></table></figure>
<h5 id="复合主键"><a href="#复合主键" class="headerlink" title="复合主键"></a>复合主键</h5><p>Peewee 对复合键有基本的支持。为了使用组合键，必须将 <code>primary_key</code> 模型选项的属性设置为一个 <code>CompositeKey</code> 实例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogToTag</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="string">"""A simple "through" table for many-to-many relationship."""</span></span><br><span class="line">    blog = ForeignKeyField(Blog)</span><br><span class="line">    tag = ForeignKeyField(Tag)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = CompositeKey(<span class="string">'blog'</span>, <span class="string">'tag'</span>)</span><br></pre></td></tr></table></figure>
<h6 id="手动指定主键"><a href="#手动指定主键" class="headerlink" title="手动指定主键"></a>手动指定主键</h6><p>有时不希望数据库自动为主键生成值，例如在批量加载关系数据时。要一次性处理这个问题，您可以简单地告诉 peewee <code>auto_increment</code> 在导入期间关闭：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data = load_user_csv() <span class="comment"># load up a bunch of data</span></span><br><span class="line"></span><br><span class="line">User._meta.auto_increment = <span class="keyword">False</span> <span class="comment"># turn off auto incrementing IDs</span></span><br><span class="line"><span class="keyword">with</span> db.transaction():</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> data:</span><br><span class="line">        u = User(id=row[<span class="number">0</span>], username=row[<span class="number">1</span>])</span><br><span class="line">        u.save(force_insert=<span class="keyword">True</span>) <span class="comment"># &lt;-- force peewee to insert row</span></span><br><span class="line"></span><br><span class="line">User._meta.auto_increment = <span class="keyword">True</span></span><br></pre></td></tr></table></figure>
<p>如果想要始终控制主键，则不要使用 <code>PrimaryKeyField</code> 字段类型，而要使用正常 <code>IntegerField</code>（或其他列类型）：</p>
<pre><code>class User(BaseModel):
    id = IntegerField(primary_key=True)
    username = CharField()

&gt;&gt;&gt; u = User.create(id=999, username=&apos;somebody&apos;)
&gt;&gt;&gt; u.id
999
&gt;&gt;&gt; User.get(User.username == &apos;somebody&apos;).id
999
</code></pre><h5 id="没有主键的模型"><a href="#没有主键的模型" class="headerlink" title="没有主键的模型"></a>没有主键的模型</h5><p>如果你想创建一个没有主键的模型，你可以在内部类 <code>Meta</code> 中指定 ：<code>primary_key = False</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyData</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    timestamp = DateTimeField()</span><br><span class="line">    value = IntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = <span class="keyword">False</span></span><br></pre></td></tr></table></figure>
<h3 id="更改和查询"><a href="#更改和查询" class="headerlink" title="更改和查询"></a>更改和查询</h3><p>本章将介绍在关系型数据库上执行 CRUD 操作</p>
<ul>
<li><code>Model.create()</code>，用于执行 INSERT 请求。</li>
<li><code>Model.save()</code> 和 <code>Model.update()</code> 执行 UPDATE 请求。</li>
<li><code>Model.delete_instance()</code> 和 <code>Model.delete()</code> 执行 DELETE 请求。</li>
<li><code>Model.select()</code>，用于执行 SELECT 请求。</li>
</ul>
<h4 id="创建一条新记录"><a href="#创建一条新记录" class="headerlink" title="创建一条新记录"></a>创建一条新记录</h4><p>可以使用 <code>Model.create()</code> 创建一个新的模型实例。此方法接受关键字参数，其中键与模型字段的名称相对应。返回一个新实例并将一行添加到表中。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.create(username=<span class="string">'Charlie'</span>)</span><br></pre></td></tr></table></figure>
<p>这将插入一行新数据到数据库中，主键将自动检索并存储在模型实例中。或者还可以先创建模型实例，然后调用 <code>save()</code></p>
<pre><code>&gt;&gt;&gt; user = User(username=&apos;Charlie&apos;)
&gt;&gt;&gt; user.save()  # save() returns the number of rows modified.
1
&gt;&gt;&gt; user.id
1
&gt;&gt;&gt; huey = User()
&gt;&gt;&gt; huey.username = &apos;Huey&apos;
&gt;&gt;&gt; huey.save()
1
&gt;&gt;&gt; huey.id
2
</code></pre><p>当模型有外键时，可以在创建新记录时直接将模型实例分配给外键字段。</p>
<pre><code>&gt;&gt;&gt; tweet = Tweet.create(user=huey, message=&apos;Hello!&apos;)
</code></pre><p>也可以使用相关对象主键的值：</p>
<pre><code>&gt;&gt;&gt; tweet = Tweet.create(user=2, message=&apos;Hello again!&apos;)
</code></pre><p>如果只是想插入数据而不需要创建模型实例，则可以使用 <code>Model.insert()</code>：</p>
<pre><code>&gt;&gt;&gt; User.insert(username=&apos;Mickey&apos;).execute()
3
</code></pre><h4 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h4><p>可以通过调用 <code>insert_many()</code> 高效率的插入大量数据</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">data_source = [</span><br><span class="line">    &#123;<span class="string">'field1'</span>: <span class="string">'val1-1'</span>, <span class="string">'field2'</span>: <span class="string">'val1-2'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'field1'</span>: <span class="string">'val2-1'</span>, <span class="string">'field2'</span>: <span class="string">'val2-2'</span>&#125;,</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最快的方法</span></span><br><span class="line">MyModel.insert_many(data_source).execute()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用元组 并指定插入的字段</span></span><br><span class="line">fields = [MyModel.field1, MyModel.field2]</span><br><span class="line">data = [(<span class="string">'val1-1'</span>, <span class="string">'val1-2'</span>),</span><br><span class="line">        (<span class="string">'val2-1'</span>, <span class="string">'val2-2'</span>),</span><br><span class="line">        (<span class="string">'val3-1'</span>, <span class="string">'val3-2'</span>)]</span><br><span class="line">MyModel.insert_many(data, fields=fields)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以包含在一个事务中</span></span><br><span class="line"><span class="keyword">with</span> db.atomic():</span><br><span class="line">    MyModel.insert_many(data, fields=fields)</span><br></pre></td></tr></table></figure>
<p>如果要批量加载的数据存储在另一个表中，则还可以创建其源为 SELECT 请求的 INSERT 请求。使用 方法：<code>Model.insert_from()</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query = (TweetArchive</span><br><span class="line">         .insert_from(</span><br><span class="line">             Tweet.select(Tweet.user, Tweet.message),</span><br><span class="line">             fields=[Tweet.user, Tweet.message])</span><br><span class="line">         .execute())</span><br></pre></td></tr></table></figure>
<h4 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h4><p>一旦模型具有主键，后续的任何 <code>save()</code> 都将导致 UPDATE 而不是 INSERT，该模型的主键不会改变。</p>
<pre><code>&gt;&gt;&gt; user.save()
1
&gt;&gt;&gt; user.id
2
&gt;&gt;&gt; user.username = &apos;Tom&apos;
&gt;&gt;&gt; user.save()
1
&gt;&gt;&gt; user.id
2
</code></pre><p>如果想更新多条记录，使用 <code>Model.update()</code></p>
<pre><code>&gt;&gt;&gt; today = datetime.today()
&gt;&gt;&gt; query = Tweet.update(is_published=True).where(Tweet.creation_date &lt; today)
&gt;&gt;&gt; query.execute()  # Returns the number of rows that were updated.
4
</code></pre><h4 id="原子更新"><a href="#原子更新" class="headerlink" title="原子更新"></a>原子更新</h4><p>peewee 允许执行原子更新。假设需要更新计数器，天真的方法是这样写的：</p>
<pre><code>&gt;&gt;&gt; for stat in Stat.select().where(Stat.url == request.url):
...     stat.counter += 1
...     stat.save()
</code></pre><p>这样速度不仅特别慢，如果多进程同时更新计数器，还会受到竞争条件的影响。可以使用 <code>update()</code> 自动更新计数器。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query = Stat.update(counter=Stat.counter + <span class="number">1</span>).where(Stat.url == request.url)</span><br><span class="line">query.execute()</span><br></pre></td></tr></table></figure>
<p>还可以使这些更新语句更复杂些。让我们给所有员工一个奖金，等于他们以前的奖金加上他们工资的10％：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query = Employee.update(bonus=(Employee.bonus + (Employee.salary * <span class="number">.1</span>)))</span><br><span class="line">query.execute()</span><br></pre></td></tr></table></figure>
<p>还可以使用子查询来更新值：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subquery = Tweet.select(fn.COUNT(Tweet.id)).where(Tweet.user == User.id)</span><br><span class="line">update = User.update(num_tweets=subquery)</span><br><span class="line">update.execute()</span><br></pre></td></tr></table></figure>
<h4 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h4><p>要删除单个模型实例，可以使用 <code>Model.delete_instance()</code>，<code>delete_instance()</code> 方法将删除给定的模型实例，并可以递归删除任何依赖对象（指定 <code>recursive=True</code>）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = User.get(User.id == <span class="number">1</span>)</span><br><span class="line">user.delete_instance()</span><br></pre></td></tr></table></figure>
<p>要删除多行，可以使用删除命令：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query = Tweet.delete().where(Tweet.creation_date &lt; one_year_ago)</span><br><span class="line">query.execute()</span><br></pre></td></tr></table></figure>
<h4 id="查询一条记录-1"><a href="#查询一条记录-1" class="headerlink" title="查询一条记录"></a>查询一条记录</h4><p>可以使用 <code>Model.get()</code> 方法来检索查询匹配到的单个实例。对于主键查找，还可以使用快捷方式 <code>Model.get_by_id()</code>。如果没有查询到结果，将返回一个异常</p>
<pre><code>&gt;&gt;&gt; User.get(User.id == 1)
&lt;__main__.User object at 0x25294d0&gt;

&gt;&gt;&gt; User.get_by_id(1)  # Same as above.
&lt;__main__.User object at 0x252df10&gt;

&gt;&gt;&gt; User[1]  # Also same as above.
&lt;__main__.User object at 0x252dd10&gt;

&gt;&gt;&gt; User.get(User.id == 1).username
u&apos;Charlie&apos;

&gt;&gt;&gt; User.get(User.username == &apos;Charlie&apos;)
&lt;__main__.User object at 0x2529410&gt;

&gt;&gt;&gt; User.get(User.username == &apos;nobody&apos;)
UserDoesNotExist: instance matching query does not exist:
SQL: SELECT t1.&quot;id&quot;, t1.&quot;username&quot; FROM &quot;user&quot; AS t1 WHERE t1.&quot;username&quot; = ?
PARAMS: [&apos;nobody&apos;]
</code></pre><p>对于更高级的查询，可以使用 <code>SelectBase.get()</code>。</p>
<pre><code>&gt;&gt;&gt; (Tweet
...  .select()
...  .join(User)
...  .where(User.username == &apos;charlie&apos;)
...  .order_by(Tweet.created_date.desc())
...  .get())
&lt;__main__.Tweet object at 0x2623410&gt;
</code></pre><h4 id="获取或创建"><a href="#获取或创建" class="headerlink" title="获取或创建"></a>获取或创建</h4><p>Peewee 有一个用于执行获取或者创建类型操作的方法 <code>Model.get_or_create()</code>，它首先尝试检索匹配的行，否则将创建一个新行</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user, created = User.get_or_create(username=username)</span><br></pre></td></tr></table></figure>
<h4 id="选择多行"><a href="#选择多行" class="headerlink" title="选择多行"></a>选择多行</h4><p>可以使用 <code>Model.select()</code> 从表中检索多行，peewee 允许迭代以及检索和切片这些行</p>
<pre><code>&gt;&gt;&gt; query = User.select()
&gt;&gt;&gt; [user.username for user in query]
[&apos;Charlie&apos;, &apos;Huey&apos;, &apos;Peewee&apos;]

&gt;&gt;&gt; query[1]
&lt;__main__.User at 0x7f83e80f5550&gt;

&gt;&gt;&gt; query[1].username
&apos;Huey&apos;

&gt;&gt;&gt; query[:2]
[&lt;__main__.User at 0x7f83e80f53a8&gt;, &lt;__main__.User at 0x7f83e80f5550&gt;]
</code></pre><p>除了返回模型实例之外，选择查询还可以返回字典，元组和命名集。</p>
<pre><code>&gt;&gt;&gt; query = User.select().dicts()
&gt;&gt;&gt; for row in query:
...     print(row)

{&apos;id&apos;: 1, &apos;username&apos;: &apos;Charlie&apos;}
{&apos;id&apos;: 2, &apos;username&apos;: &apos;Huey&apos;}
{&apos;id&apos;: 3, &apos;username&apos;: &apos;Peewee&apos;}
</code></pre><h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h4><p>可以使用普通的Python操作符来过滤特定的记录。 Peewee 支持多种查询操作符。</p>
<pre><code>&gt;&gt;&gt; user = User.get(User.username == &apos;Charlie&apos;)
&gt;&gt;&gt; for tweet in Tweet.select().where(Tweet.user == user, Tweet.is_published == True):
...     print(tweet.user.username, &apos;-&gt;&apos;, tweet.message)
...
Charlie -&gt; hello world
Charlie -&gt; this is fun

&gt;&gt;&gt; for tweet in Tweet.select().where(Tweet.created_date &lt; datetime.datetime(2011, 1, 1)):
...     print(tweet.message, tweet.created_date)
...
Really old tweet 2010-01-01 00:00:00
</code></pre><p>还可以使用 join 后过滤</p>
<pre><code>&gt;&gt;&gt; for tweet in Tweet.select().join(User).where(User.username == &apos;Charlie&apos;):
...     print(tweet.message)
hello world
this is fun
look at this picture of my food
</code></pre><p>如果想表达复杂的逻辑，还可以使用 <code>|</code> 或者 <code>&amp;</code> 操作符</p>
<pre><code>&gt;&gt;&gt; Tweet.select().join(User).where(
...     (User.username == &apos;Charlie&apos;) |
...     (User.username == &apos;Peewee Herman&apos;))
</code></pre><h4 id="排序-1"><a href="#排序-1" class="headerlink" title="排序"></a>排序</h4><p>要按顺序返回行，要使用 <code>order_by()</code> 方法</p>
<pre><code>&gt;&gt;&gt; for t in Tweet.select().order_by(Tweet.created_date):
...     print(t.pub_date)
...
2010-01-01 00:00:00
2011-06-07 14:08:48
2011-06-07 14:12:57

&gt;&gt;&gt; for t in Tweet.select().order_by(Tweet.created_date.desc()):
...     print(t.pub_date)
...
2011-06-07 14:12:57
2011-06-07 14:08:48
2010-01-01 00:00:00
</code></pre><p>还可以使用 <code>+</code> 和 <code>-</code> 前缀来指示排序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The following queries are equivalent:</span></span><br><span class="line">Tweet.select().order_by(Tweet.created_date.desc())</span><br><span class="line"></span><br><span class="line">Tweet.select().order_by(-Tweet.created_date)  <span class="comment"># Note the "-" prefix.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Similarly you can use "+" to indicate ascending order, though ascending</span></span><br><span class="line"><span class="comment"># is the default when no ordering is otherwise specified.</span></span><br><span class="line">User.select().order_by(+User.username)</span><br></pre></td></tr></table></figure>
<p>还可以使用 join 连接后排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query = (Tweet</span><br><span class="line">         .select()</span><br><span class="line">         .join(User)</span><br><span class="line">         .order_by(User.username, Tweet.created_date.desc()))</span><br></pre></td></tr></table></figure>
<p>当对计算值进行排序时，可以包含必需的 sql 表达式，或者分配给该值别名。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let's start with our base query. We want to get all usernames and the number of</span></span><br><span class="line"><span class="comment"># tweets they've made. We wish to sort this list from users with most tweets to</span></span><br><span class="line"><span class="comment"># users with fewest tweets.</span></span><br><span class="line">query = (User</span><br><span class="line">         .select(User.username, fn.COUNT(Tweet.id).alias(<span class="string">'num_tweets'</span>))</span><br><span class="line">         .join(Tweet, JOIN.LEFT_OUTER)</span><br><span class="line">         .group_by(User.username))</span><br></pre></td></tr></table></figure>
<p>还可以在 select 中使用 <code>COUNT</code> 表达式来排序</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query = (User</span><br><span class="line">         .select(User.username, fn.COUNT(Tweet.id).alias(<span class="string">'num_tweets'</span>))</span><br><span class="line">         .join(Tweet, JOIN.LEFT_OUTER)</span><br><span class="line">         .group_by(User.username)</span><br><span class="line">         .order_by(fn.COUNT(Tweet.id).desc()))</span><br></pre></td></tr></table></figure>
<h4 id="获取随机记录"><a href="#获取随机记录" class="headerlink" title="获取随机记录"></a>获取随机记录</h4><p>偶尔可能想从数据库中提取一条随机记录，可以通过 <code>random</code> 或 <code>rand</code>（取决于你的数据库）来完成这个任务：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Postgresql and Sqlite use the Random function</span></span><br><span class="line"><span class="comment"># Pick 5 lucky winners:</span></span><br><span class="line">LotteryNumber.select().order_by(fn.Random()).limit(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL uses Rand:</span></span><br><span class="line"><span class="comment"># Pick 5 lucky winners:</span></span><br><span class="line">LotterNumber.select().order_by(fn.Rand()).limit(<span class="number">5</span>)</span><br></pre></td></tr></table></figure>
<h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p><code>paginate()</code> 方法可以轻松对记录进行分页，<code>paginate()</code> 方法需要两个参数，<code>page_number</code>, 和 <code>items_per_page</code>。</p>
<pre><code>&gt;&gt;&gt; for tweet in Tweet.select().order_by(Tweet.id).paginate(2, 10):
...     print(tweet.message)
...
tweet 10
tweet 11
tweet 12
tweet 13
tweet 14
tweet 15
tweet 16
tweet 17
tweet 18
tweet 19
</code></pre><h4 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h4><p>可以计算任何查询中选择的行数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Tweet.select().count()</span><br><span class="line">100</span><br><span class="line">&gt;&gt;&gt; Tweet.select().where(Tweet.id &gt; 50).count()</span><br><span class="line">50</span><br></pre></td></tr></table></figure>
<h4 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h4><p>假设你有一些用户，并希望得到他们的列表以及每个人的推文数量。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query = (User</span><br><span class="line">         .select(User, fn.Count(Tweet.id).alias(<span class="string">'count'</span>))</span><br><span class="line">         .join(Tweet, JOIN.LEFT_OUTER)</span><br><span class="line">         .group_by(User))</span><br></pre></td></tr></table></figure>
<h4 id="返回标量值"><a href="#返回标量值" class="headerlink" title="返回标量值"></a>返回标量值</h4><p>可以通过调用 <code>Query.scalar()</code> 来返回标量值：</p>
<pre><code>&gt;&gt;&gt; PageView.select(fn.Count(fn.Distinct(PageView.url))).scalar()
100
</code></pre><p>您可以通过传递 <code>as_tuple=true</code> 来返回多个标量值：</p>
<pre><code>&gt;&gt;&gt; Employee.select(
...     fn.Min(Employee.salary), fn.Max(Employee.salary)
... ).scalar(as_tuple=True)
(30000, 50000)
</code></pre><h4 id="SQL函数，子查询和原始表达式"><a href="#SQL函数，子查询和原始表达式" class="headerlink" title="SQL函数，子查询和原始表达式"></a>SQL函数，子查询和原始表达式</h4><p>要使用特殊的 SQL 函数，需要使用 <code>fn</code> 的对象来构造请求<br>假设要获取所有以字母 <code>a</code> 开头的用户列表：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Select the user's id, username and the first letter of their username, lower-cased</span></span><br><span class="line">first_letter = fn.LOWER(fn.SUBSTR(User.username, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">query = User.select(User, first_letter.alias(<span class="string">'first_letter'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternatively we could select only users whose username begins with 'a'</span></span><br><span class="line">a_users = User.select().where(first_letter == <span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> a_users:</span><br><span class="line">    print(user.username)</span><br></pre></td></tr></table></figure>
<p>有时候想传入一些任意的 SQL ，可以使用特殊的 SQL 类来做到这点</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We'll query the user table and annotate it with a count of tweets for</span></span><br><span class="line"><span class="comment"># the given user</span></span><br><span class="line">query = (User</span><br><span class="line">         .select(User, fn.Count(Tweet.id).alias(<span class="string">'ct'</span>))</span><br><span class="line">         .join(Tweet)</span><br><span class="line">         .group_by(User))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now we will order by the count, which was aliased to "ct"</span></span><br><span class="line">query = query.order_by(SQL(<span class="string">'ct'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># You could, of course, also write this as:</span></span><br><span class="line">query = query.order_by(fn.COUNT(Tweet.id))</span><br></pre></td></tr></table></figure>
<p>有两种方法可以用 peewee 执行手动编写的 SQL 语句：</p>
<ol>
<li><code>Database.execute_sql()</code> 用户执行任意类型的查询</li>
<li>用于执行 SELECT 查询和返回模型实例的 <code>RawQuery</code></li>
</ol>
<h4 id="安全和SQL注入"><a href="#安全和SQL注入" class="headerlink" title="安全和SQL注入"></a>安全和SQL注入</h4><p>默认情况下，peewee会参数化查询，所以用户传入的参数将被转义。这条规则唯一的例外是，如果你正在编写一个原始的 sql 查询或传入一个可能包含不可信数据的 sql 对象。为了减轻这一点，请确保任何用户定义的数据都作为查询参数传入，而不是实际的 sql 查询的一部分：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bad! DO NOT DO THIS!</span></span><br><span class="line">query = MyModel.raw(<span class="string">'SELECT * FROM my_table WHERE data = %s'</span> % (user_data,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Good. `user_data` will be treated as a parameter to the query.</span></span><br><span class="line">query = MyModel.raw(<span class="string">'SELECT * FROM my_table WHERE data = %s'</span>, user_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bad! DO NOT DO THIS!</span></span><br><span class="line">query = MyModel.select().where(SQL(<span class="string">'Some SQL expression %s'</span> % user_data))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Good. `user_data` will be treated as a parameter.</span></span><br><span class="line">query = MyModel.select().where(SQL(<span class="string">'Some SQL expression %s'</span>, user_data))</span><br></pre></td></tr></table></figure>
<h4 id="返回元组-字典-名称元组"><a href="#返回元组-字典-名称元组" class="headerlink" title="返回元组/字典/名称元组"></a>返回元组/字典/名称元组</h4><p>有时候不需要创建模型实例的开销，只需要数据即可，可以使用：</p>
<ul>
<li>dicts()</li>
<li>namedtuples()</li>
<li>tuples()</li>
<li>objects() – 接受用行元组调用的任意构造函数。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stats = (Stat</span><br><span class="line">         .select(Stat.url, fn.Count(Stat.url))</span><br><span class="line">         .group_by(Stat.url)</span><br><span class="line">         .tuples())</span><br><span class="line"></span><br><span class="line"><span class="comment"># iterate over a list of 2-tuples containing the url and count</span></span><br><span class="line"><span class="keyword">for</span> stat_url, stat_count <span class="keyword">in</span> stats:</span><br><span class="line">    print(stat_url, stat_count)</span><br></pre></td></tr></table></figure>
<p>同样也可以使用 <code>dicts()</code> 将数据作为字典返回</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stats = (Stat</span><br><span class="line">         .select(Stat.url, fn.Count(Stat.url).alias(<span class="string">'ct'</span>))</span><br><span class="line">         .group_by(Stat.url)</span><br><span class="line">         .dicts())</span><br><span class="line"></span><br><span class="line"><span class="comment"># iterate over a list of 2-tuples containing the url and count</span></span><br><span class="line"><span class="keyword">for</span> stat <span class="keyword">in</span> stats:</span><br><span class="line">    print(stat[<span class="string">'url'</span>], stat[<span class="string">'ct'</span>])</span><br></pre></td></tr></table></figure>
<h3 id="查询操作符"><a href="#查询操作符" class="headerlink" title="查询操作符"></a>查询操作符</h3><p>Peewee 支持以下类型的比较：</p>
<table>
<thead>
<tr>
<th>对照</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>==</td>
<td>x 等于 y</td>
</tr>
<tr>
<td>&lt;</td>
<td>x 小于 y</td>
</tr>
<tr>
<td>&lt;=</td>
<td>x 小于或等于 y</td>
</tr>
<tr>
<td>></td>
<td>x 大于 y</td>
</tr>
<tr>
<td>>=</td>
<td>x 大于或等于 y</td>
</tr>
<tr>
<td>!=</td>
<td>x 不等于 y</td>
</tr>
<tr>
<td>&lt;&lt;</td>
<td>x IN y, y 是一个列表或查询</td>
</tr>
<tr>
<td>>&gt;</td>
<td>x IS y, 当 y 是 None 或者 NULL</td>
</tr>
<tr>
<td>%</td>
<td>x LIKE y, 当 y 可能包含通配符</td>
</tr>
<tr>
<td>**</td>
<td>x ILIKE y, 当 y 可能包含通配符</td>
</tr>
<tr>
<td>^</td>
<td>x XOR y</td>
</tr>
<tr>
<td>~</td>
<td>非 (例如：NOT x)</td>
</tr>
</tbody>
</table>
<p>还有一些查询可以用方法：</p>
<table border="1"><colgroup><col width="32%"><col width="68%"></colgroup><thead valign="bottom"><tr><th>方法</th><th>含义</th></tr></thead><tbody valign="top"><tr><td><code><span>.contains(substr)</span></code></td><td>通配符搜索子字符串</td></tr><tr><td><code><span>.startswith(prefix)</span></code></td><td>搜索以<code>prefix</code>为前缀的值</td></tr><tr><td><code><span>.endswith(suffix)</span></code></td><td>搜索以<code>suffix</code>为后缀的值</td></tr><tr><td><code><span>.between(low,</span><span>high)</span></code></td><td>搜索<code><span>low</span></code>和 <code><span>high</span></code>之间的值</td></tr><tr><td><code><span>.regexp(exp)</span></code></td><td>正则表达式匹配</td></tr><tr><td><code><span>.bin_and(value)</span></code></td><td>二进制 AND</td></tr><tr><td><code><span>.bin_or(value)</span></code></td><td>二进制 OR</td></tr><tr><td><code><span>.in_(value)</span></code></td><td>值是否属于</td></tr><tr><td><code><span>.not_in(value)</span></code></td><td>值是否不属于</td></tr><tr><td><code><span>.is_null(is_null)</span></code></td><td>是 NULL 或者不是 NULL </td></tr><tr><td><code><span>.concat(other)</span></code></td><td>连接两个字符串</td></tr><tr><td><code><span>.distinct()</span></code></td><td>标记不同的选择列</td></tr></tbody></table>

<p>要使用逻辑运算符来组合子句，使用：</p>
<table border="1"><colgroup><col width="18%"><col width="22%"><col width="60%"></colgroup><thead valign="bottom"><tr><th>操作符</th><th>意思</th><th>示例</th></tr></thead><tbody valign="top"><tr><td><code><span>&amp;</span></code></td><td>AND</td><td><code><span>(User.is_active</span><span>==</span><span>True)</span><span>&amp;</span><span>(User.is_admin</span><span>==</span><span>True)</span></code></td></tr><tr><td><code><span>|</span></code></td><td>OR</td><td><code><span>(User.is_admin)</span><span>|</span><span>(User.is_superuser)</span></code></td></tr><tr><td><code><span>~</span></code></td><td>NOT</td><td><code><span>~(User.username</span><span>&lt;&lt;</span><span>[‘foo’,</span><span>‘bar’,</span><span>‘baz’])</span></code></td></tr></tbody></table>

<p>如何使用查询操作符的示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Find the user whose username is "charlie".</span></span><br><span class="line">User.select().where(User.username == <span class="string">'charlie'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find the users whose username is in [charlie, huey, mickey]</span></span><br><span class="line">User.select().where(User.username &lt;&lt; [<span class="string">'charlie'</span>, <span class="string">'huey'</span>, <span class="string">'mickey'</span>])</span><br><span class="line"></span><br><span class="line">Employee.select().where(Employee.salary.between(<span class="number">50000</span>, <span class="number">60000</span>))</span><br><span class="line"></span><br><span class="line">Employee.select().where(Employee.name.startswith(<span class="string">'C'</span>))</span><br><span class="line"></span><br><span class="line">Blog.select().where(Blog.title.contains(search_string))</span><br></pre></td></tr></table></figure>
<p>这里是如何组合表达式的示例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Find any users who are active administrations.</span></span><br><span class="line">User.select().where(</span><br><span class="line">  (User.is_admin == <span class="keyword">True</span>) &amp;</span><br><span class="line">  (User.is_active == <span class="keyword">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find any users who are either administrators or super-users.</span></span><br><span class="line">User.select().where(</span><br><span class="line">  (User.is_admin == <span class="keyword">True</span>) |</span><br><span class="line">  (User.is_superuser == <span class="keyword">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find any Tweets by users who are not admins (NOT IN).</span></span><br><span class="line">admins = User.select().where(User.is_admin == <span class="keyword">True</span>)</span><br><span class="line">non_admin_tweets = Tweet.select().where(~(Tweet.user &lt;&lt; admins))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find any users who are not my friends (strangers).</span></span><br><span class="line">friends = User.select().where(User.username.in_([<span class="string">'charlie'</span>, <span class="string">'huey'</span>, <span class="string">'mickey'</span>]))</span><br><span class="line">strangers = User.select().where(User.id.not_in(friends))</span><br></pre></td></tr></table></figure>
<p>请记住：</p>
<ul>
<li>使用 <code>.in_()</code> 和 <code>.not_in()</code> 替换 <code>in</code> 和 <code>not in</code></li>
<li>使用 <code>&amp;</code> 替换 <code>and</code></li>
<li>使用 <code>|</code> 替换 <code>or</code></li>
<li>使用 <code>~</code> 替换 <code>not</code></li>
<li>使用 <code>.is_null()</code> 替换 <code>is None</code> 或者 <code>== None</code></li>
<li>在使用逻辑运算符时，不要忘记使用圆括号包含比较结果</li>
</ul>
<h4 id="用户自定义操作符"><a href="#用户自定义操作符" class="headerlink" title="用户自定义操作符"></a>用户自定义操作符</h4><p>如果发现自己需要的操作符不在上表中，可以非常容易的自定义操作符，比如取模运算</p>
<p>这里是如何在 SQLite 中添加取模运算的支持：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> Expression <span class="comment"># the building block for expressions</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod</span><span class="params">(lhs, rhs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Expression(lhs, <span class="string">'%'</span>, rhs)</span><br></pre></td></tr></table></figure>
<p>现在可以将自定义运算符来构建更丰富的查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Users with even ids.</span></span><br><span class="line">User.select().where(mod(User.id, <span class="number">2</span>) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>Peewee 的详细使用说明请翻阅 <a href="http://docs.peewee-orm.com/en/latest/index.html" target="_blank" rel="noopener">Peewee官方文档</a></p>

      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/python/" rel="tag"><i class="fa fa-tag"></i> python</a>
          
            <a href="/tags/peewee/" rel="tag"><i class="fa fa-tag"></i> peewee</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/03/12/2018/PHP基础学习/" rel="next" title="PHP基础学习">
                <i class="fa fa-chevron-left"></i> PHP基础学习
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/04/04/2018/Python进阶指南/" rel="prev" title="Python进阶指南">
                Python进阶指南 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/uploads/avatar.png" alt="魏云飞">
            
              <p class="site-author-name" itemprop="name">魏云飞</p>
              <p class="site-description motion-element" itemprop="description">帅的人已经醒来 而丑的人还在沉睡</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">49</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">27</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">56</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/yunfwe" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">2.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用"><span class="nav-number">3.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#快速体验"><span class="nav-number">3.2.</span> <span class="nav-text">快速体验</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建数据模型"><span class="nav-number">3.2.1.</span> <span class="nav-text">创建数据模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#存储数据"><span class="nav-number">3.2.2.</span> <span class="nav-text">存储数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#检索数据"><span class="nav-number">3.2.3.</span> <span class="nav-text">检索数据</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#查询一条记录"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">查询一条记录</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#列出记录"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">列出记录</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#排序"><span class="nav-number">3.2.3.3.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#结合过滤器表达式"><span class="nav-number">3.2.3.4.</span> <span class="nav-text">结合过滤器表达式</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#聚合和预获取"><span class="nav-number">3.2.3.5.</span> <span class="nav-text">聚合和预获取</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SQL-函数"><span class="nav-number">3.2.3.6.</span> <span class="nav-text">SQL 函数</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭数据库"><span class="nav-number">3.2.4.</span> <span class="nav-text">关闭数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从数据库导出模型"><span class="nav-number">3.2.5.</span> <span class="nav-text">从数据库导出模型</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据库"><span class="nav-number">3.3.</span> <span class="nav-text">数据库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#连接数据库"><span class="nav-number">3.3.1.</span> <span class="nav-text">连接数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用URL连接数据库"><span class="nav-number">3.3.2.</span> <span class="nav-text">使用URL连接数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据库运行时配置"><span class="nav-number">3.3.3.</span> <span class="nav-text">数据库运行时配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态定义数据库"><span class="nav-number">3.3.4.</span> <span class="nav-text">动态定义数据库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接管理"><span class="nav-number">3.3.5.</span> <span class="nav-text">连接管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#连接池"><span class="nav-number">3.3.6.</span> <span class="nav-text">连接池</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#执行查询"><span class="nav-number">3.3.7.</span> <span class="nav-text">执行查询</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#事务管理"><span class="nav-number">3.3.8.</span> <span class="nav-text">事务管理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#日志记录"><span class="nav-number">3.3.9.</span> <span class="nav-text">日志记录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模型和字段"><span class="nav-number">3.4.</span> <span class="nav-text">模型和字段</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#字段"><span class="nav-number">3.4.1.</span> <span class="nav-text">字段</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#字段类型表"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">字段类型表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#字段初始参数"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">字段初始参数</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#字段默认值"><span class="nav-number">3.4.1.3.</span> <span class="nav-text">字段默认值</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#外键字段"><span class="nav-number">3.4.1.4.</span> <span class="nav-text">外键字段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#日期字段"><span class="nav-number">3.4.1.5.</span> <span class="nav-text">日期字段</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#创建模型表"><span class="nav-number">3.4.2.</span> <span class="nav-text">创建模型表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#模型选项和表格元数据"><span class="nav-number">3.4.3.</span> <span class="nav-text">模型选项和表格元数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#索引和约束"><span class="nav-number">3.4.4.</span> <span class="nav-text">索引和约束</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#单列索引和约束"><span class="nav-number">3.4.4.1.</span> <span class="nav-text">单列索引和约束</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#多列索引"><span class="nav-number">3.4.4.2.</span> <span class="nav-text">多列索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#创建高级索引"><span class="nav-number">3.4.4.3.</span> <span class="nav-text">创建高级索引</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#表约束"><span class="nav-number">3.4.4.4.</span> <span class="nav-text">表约束</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他主键"><span class="nav-number">3.4.5.</span> <span class="nav-text">其他主键</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#非整数主键"><span class="nav-number">3.4.5.1.</span> <span class="nav-text">非整数主键</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#复合主键"><span class="nav-number">3.4.5.2.</span> <span class="nav-text">复合主键</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#手动指定主键"><span class="nav-number">3.4.5.2.1.</span> <span class="nav-text">手动指定主键</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#没有主键的模型"><span class="nav-number">3.4.5.3.</span> <span class="nav-text">没有主键的模型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#更改和查询"><span class="nav-number">3.5.</span> <span class="nav-text">更改和查询</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#创建一条新记录"><span class="nav-number">3.5.1.</span> <span class="nav-text">创建一条新记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#批量插入"><span class="nav-number">3.5.2.</span> <span class="nav-text">批量插入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#更新数据"><span class="nav-number">3.5.3.</span> <span class="nav-text">更新数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#原子更新"><span class="nav-number">3.5.4.</span> <span class="nav-text">原子更新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#删除记录"><span class="nav-number">3.5.5.</span> <span class="nav-text">删除记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查询一条记录-1"><span class="nav-number">3.5.6.</span> <span class="nav-text">查询一条记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取或创建"><span class="nav-number">3.5.7.</span> <span class="nav-text">获取或创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#选择多行"><span class="nav-number">3.5.8.</span> <span class="nav-text">选择多行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过滤"><span class="nav-number">3.5.9.</span> <span class="nav-text">过滤</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#排序-1"><span class="nav-number">3.5.10.</span> <span class="nav-text">排序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#获取随机记录"><span class="nav-number">3.5.11.</span> <span class="nav-text">获取随机记录</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分页"><span class="nav-number">3.5.12.</span> <span class="nav-text">分页</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#计数"><span class="nav-number">3.5.13.</span> <span class="nav-text">计数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#汇总"><span class="nav-number">3.5.14.</span> <span class="nav-text">汇总</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#返回标量值"><span class="nav-number">3.5.15.</span> <span class="nav-text">返回标量值</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SQL函数，子查询和原始表达式"><span class="nav-number">3.5.16.</span> <span class="nav-text">SQL函数，子查询和原始表达式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#安全和SQL注入"><span class="nav-number">3.5.17.</span> <span class="nav-text">安全和SQL注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#返回元组-字典-名称元组"><span class="nav-number">3.5.18.</span> <span class="nav-text">返回元组/字典/名称元组</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询操作符"><span class="nav-number">3.6.</span> <span class="nav-text">查询操作符</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#用户自定义操作符"><span class="nav-number">3.6.1.</span> <span class="nav-text">用户自定义操作符</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#附录"><span class="nav-number">4.</span> <span class="nav-text">附录</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">魏云飞</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">553k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点总阅读时长">9:13</span>
  
</div>








  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Mist</a> v6.0.4</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>












  















  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.4"></script>



  



	





  





  










  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  

  

  

  

  

</body>
<script>
var OriginTitile = document.title;
 var titleTime;
 document.addEventListener('visibilitychange', function () {
     if (document.hidden) {
         $('[rel="icon"]').attr('href', "/img/TEP.ico");
         document.title = '╭(°A°`)╮ 页面崩溃啦 ~ ';
         clearTimeout(titleTime);
     }
     else {
         $('[rel="icon"]').attr('href', "/favicon.ico");
         document.title = '(ฅ>ω<*ฅ) 噫又好了~' + OriginTitile;
         titleTime = setTimeout(function () {
             document.title = OriginTitile;
         }, 2000);
     }
 });
</script>
</html>
