<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>某科学的最后之作</title>
  
  <subtitle>帅的人已经醒来 而丑的人还在沉睡</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.yunfwe.cn/"/>
  <updated>2025-07-22T07:14:12.635Z</updated>
  <id>http://www.yunfwe.cn/</id>
  
  <author>
    <name>魏云飞</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Linux IO多路复用</title>
    <link href="http://www.yunfwe.cn/2019/11/16/2019/Linux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/"/>
    <id>http://www.yunfwe.cn/2019/11/16/2019/Linux%20IO%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8/</id>
    <published>2019-11-16T02:12:00.000Z</published>
    <updated>2025-07-22T07:14:12.635Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>在平常的工作中，遇到 IO 密集型任务，比如要频繁调用外部的 API 接口（网络IO），或者频繁读写文件（磁盘IO）通常代码都会在 IO 任务创建后等待 IO 任务结束并将需要的数据返回。这种同步的编程方式是最简单的，但同时也是效率最低的。比如在一个 Web 后端中，如果是单线程单进程的运行模式，一次就只能处理一个客户端的请求，即使引入了多线程/多进程，虽然可以同时服务多个客户端了，但是如果瞬间几千的并发连接，那么后端就必须创建相对多的线程或进程，这时候 CPU 将会花费大量的时间和资源用于线程上下文切换上，而且这么多的线程，如果用到了锁机制来保证一些共享数据的安全，还将进一步的降低 Web 后端的性能。而 IO 多路复用的出现，则给这种局面带来了转机。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>操作系统</td><td>Ubuntu 18.04</td></tr><tr><td>Python</td><td>3.6</td></tr></tbody></table><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><p>在学习 IO 多路复用前，我们先理解一些基本的概念，渐进式的学习 IO 多路复用。</p><h3 id="同步-异步"><a href="#同步-异步" class="headerlink" title="同步/异步"></a>同步/异步</h3><p>同步和异步的概念，在不同的角度有不同的回答，这里举几个简单的例子来说明一下。</p><ol><li><p>在楼下食堂买饭，当点完餐后，你就站在台前呆若木鸡的等，直到你点的餐做好了你才端走去吃。因为吃饭和点餐是相互依赖的事情，所以在点餐没有得到结果（食物）之前就什么也不干一直等待，这就是同步。异步就是在点完餐后，你就找个地坐着玩手机，就干点别的 不傻等了。节约了等待过程的时间浪费，但是怎么才能知道自己点的餐好了呢？这时候可以选择每隔五分钟就上吧台问一问，没有好就继续回去玩手机。这种方式也就称之为轮询。还有一种更高效的方式，就是点完餐后服务人员给你一个号，当你的餐准备完毕就广播你的号，你就可以前去领餐了。这种方式就是消息通知。</p></li><li><p>在一套 Web 系统中，比如我们要导出员工表，当点击导出的按钮后，过一会就开始自动下载员工表。在浏览器内部，浏览器发起 http 请求我们的后端接口，这时候后端保持着 http 连接，当把员工数据从数据库中找到并绘制成表格后就返回给浏览器，这就是同步。而异步就是当浏览器发起请求后，后端直接返回它一个任务 ID，并提供它一个接口用来查询任务进度。这时候想要知道任务是否已经结束就需要不停的刷新页面查看任务状态，这种轮询的方式是非常比较浪费资源切低效的。最高效的方式就是后端可以主动通知浏览器任务已经结束了，关于主动推的技术目前主流的是 WebSocket。</p></li><li><p>在日常的编程中，我们接触最多的就是同步编程的方式了，比如我们使用 <code>requests</code> 库发起一个 http 请求，在请求发出后，函数将以阻塞的方式等待对方返回数据。在阻塞期间，是没有任何一行代码被执行，整个程序都处于挂起状态，直到对方返回数据后才继续往下走，如果有多个不想关的请求需要被发送，比如爬虫程序，那么同步编程的方式效率简直太低了。JavaScript 在浏览器中，通过 <code>XMLHttpRequest</code> 发送 ajax 请求的时候，默认是直接返回的，但是你需要将事后对数据的处理方法通过回调的形式传递给 <code>XMLHttpRequest</code> 对象，当请求的接口响应后，会主动调用对数据处理的回调函数。这种通过非阻塞加回调的方式，就是一种常见的异步编程方式。</p></li></ol><p>由上可以看到，同步就是事物之间串行化的执行过程，异步就是事物之间无需互相等待。同步和异步所关注的就是事件完成后的<strong>消息通知机制</strong>，是阻塞等待、轮询还是事件通知/回调。</p><h3 id="阻塞-非阻塞"><a href="#阻塞-非阻塞" class="headerlink" title="阻塞/非阻塞"></a>阻塞/非阻塞</h3><p>阻塞和非阻塞是在调用者的角度来看，例如发起一个 IO 相关的<strong>系统调用</strong>，或者 <code>wait</code> 另外的线程，<code>sleep</code> 主动挂起自己，都会使程序进行阻塞。而我们大多遇到的阻塞案例，都是进行了 IO 相关的系统调用。</p><p>什么是系统调用？简单来说就是内核提供给用户程序的 API 接口，用于操纵内核才有权限访问的内容。例如我们在 Python 中对文件进行读写，我们并不需要关心文件存储在哪种物理介质上，是机械硬盘是U盘还是固态硬盘，这是因为在驱动、内核、C语言库的层层封装下，我们才得以用非常简单的方式对文件进行读写。对于网络也一样，我们不需要关心网卡的类型和性质，只需要简单的调用 <code>socket</code> 模块就可以完成对网络的操控。这些库本质上都只是调用了C语言提供的标准库，C语言的标准库中又调用了内核提供的这些系统调用完成的。那内核又为什么不允许用户进程直接操控硬件呢？是为了自我保护，如果任何进程都能随意的操控硬件，操控内存中的数据则是非常危险的，内核都可能分分钟被恶意程序干掉。</p><p>现在再来看看因为 IO 相关的系统调用造成阻塞的原因是什么。Linux 上的 <code>strace</code> 命令可以跟踪用户进程的系统调用，下面写一段因为网络 IO 造成的阻塞的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</span><br><span class="line">s.bind((<span class="string">''</span>,<span class="number">9090</span>))</span><br><span class="line">data, addr = s.recvfrom(<span class="number">4096</span>)</span><br><span class="line">s.sendto(data, addr)</span><br><span class="line">s.close()</span><br></pre></td></tr></table></figure><p>使用 <code>strace python echo.py</code> 执行脚本，在一片输出后，停在了 <code>recvfrom(3,</code> 这个地方：</p><pre><code>...socket(AF_INET, SOCK_DGRAM, IPPROTO_IP) = 3bind(3, {sa_family=AF_INET, sin_port=htons(9090), sin_addr=inet_addr(&quot;0.0.0.0&quot;)}, 16) = 0recvfrom(3, </code></pre><p>我们需要关注的是最后三行，前面打印的都是 Python 虚拟机在启动的时候加载动态链接库、读取脚本内容、分配内存空间等相关的系统调用。当脚本执行到 <code>s = socket.socket(socket.AF_INET,socket.SOCK_DGRAM)</code> 发起了第一个系统调用 <code>socket</code>，就是创建了一个网络套接字文件，返回的文件描述符是 3，在系统的 <code>/proc</code> 下也可以看到该进程打开的所有文件描述符：</p><pre><code>root@yunfwe:~# ps aux |grep echo.pyroot     10533  0.0  0.0  18720  1932 pts/0    S+   20:40   0:00 strace python echo.pyroot     10535  0.0  0.4  35684  9084 pts/0    S+   20:40   0:00 python echo.pyroot     14654  0.0  0.0  14428  1052 pts/2    S+   20:50   0:00 grep --color=auto echo.pyroot@yunfwe:~# ls -lh /proc/10535/fdtotal 0lrwx------ 1 root root 64 2019/11/10 20:50:52 0 -&gt; /dev/pts/0lrwx------ 1 root root 64 2019/11/10 20:50:52 1 -&gt; /dev/pts/0lrwx------ 1 root root 64 2019/11/10 20:50:52 2 -&gt; /dev/pts/0lrwx------ 1 root root 64 2019/11/10 20:50:52 3 -&gt; &apos;socket:[274124191]&apos;root@yunfwe:~#</code></pre><p>程序当前已经打开了 4 个文件描述符，其中 1,2,3 分别对应着 <strong>标准输入</strong>，<strong>标准输出</strong>，<strong>错误输出</strong>，其中都指向了 <code>/dev/pts/0</code>，这个设备文件就是当前 SSH 连接的虚拟终端，所以程序的输出我们才会在终端上看到。最后一个 socket 类型的文件就是打开的网络套接字了。</p><p>接着 <code>s.bind((&#39;&#39;,9090))</code> 的语句发起了第二个系统调用，就是给刚才创建的网络套接字绑定了监听地址和端口。如果没有异常，<code>bind</code> 系统调用将返回 0。接着执行到 <code>data, addr = s.recvfrom(4096)</code> 语句的时候，发起了第三个系统调用，这个系统调用并长时间的阻塞了 Python 进程，这个过程又发生了什么？</p><p>进程在进行系统调用的时候，用户进程触发软中断，CPU 接收到中断信号后由用户态切换到内核态去运行相应系统调用的内核函数，此时用户进程是被挂起的（进程被放入等待队列中，这时进程的状态为 <code>sleeping</code>），并等待系统调用执行完毕后 CPU 由内核态切换到用户态才被重新唤醒（进程重新被放入执行队列，只有此队列的进程才可能获得 CPU 执行权，此时进程的状态为 <code>running</code>）。所以，前面在进行 <code>socket</code> 和 <code>bind</code> 系统调用的时候，Python 进程并不是没有被阻塞，而是阻塞的时间太短，我们感知不到而已。</p><p>当网卡又数据来到的时候，网卡将产生一个硬中断来通知内核来处理数据，内核发现了有该进程监听的端口的数据的时候，将数据由内核空间的缓冲区拷贝到用户进程空间的缓冲区，并重新将用户进程唤醒（放置到运行队列），这时用户进程就拿到了需要的数据。我们可以使用 <code>nc</code> 命令向此端口发送一些数据，看看用户进程之后的动作。</p><p>新建终端，并通过 <code>nc</code> 命令发送数据：</p><pre><code>root@yunfwe:~# echo &apos;hello&apos; |nc -4u 127.0.0.1 9090hello</code></pre><p>Python 进程退出，<code>strace</code> 命令的跟踪如下：</p><pre><code>recvfrom(3, &quot;hello\n&quot;, 4096, 0, {sa_family=AF_INET, sin_port=htons(53114), sin_addr=inet_addr(&quot;127.0.0.1&quot;)}, [16]) = 6sendto(3, &quot;hello\n&quot;, 6, 0, {sa_family=AF_INET, sin_port=htons(53114), sin_addr=inet_addr(&quot;127.0.0.1&quot;)}, 16) = 6close(3)                                = 0rt_sigaction(SIGINT, {sa_handler=SIG_DFL, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7f1fa7148f20}, {sa_handler=0x561f54bcebe0, sa_mask=[], sa_flags=SA_RESTORER, sa_restorer=0x7f1fa7148f20}, 8) = 0exit_group(0)                           = ?+++ exited with 0 +++root@yunfwe:~# </code></pre><p><code>recvfrom</code> 系统调用将接收到的字符串 <code>hello\n</code> 和客户端地址由内核态返回到用户态，用户态紧接着通过 <code>sendto</code> 系统调用将数据发送给客户端地址，然后 <code>close</code> 系统调用关闭打开的文件描述符，用户进程执行完毕，Python 解释器退出。进程退出也是用户进程生命周期的最后一个系统调用，这时候内核将回收进程所占用的资源（打开的文件、占用的内存等），然后将进程的退出码返回给进程的调用者，这就是该进程的父进程。</p><p>题外话：无论是文件 IO 相关的系统调用，还是网络 IO 相关的系统调用，都会发生由 内核缓冲区 -&gt; 用户空间缓冲区，或者 用户空间缓冲区 -&gt; 内核缓冲区的数据复制，对于 Web 静态资源服务器，比如 Nginx 像客户端发送文件数据，需要先将硬盘上读取的文件由内核缓冲区 -&gt; 用户空间缓冲区，然后再由用户空间缓冲区 -&gt; 内核的网络套接字缓冲区 -&gt; 发送到客户端，这个过程是低效的，因此 Linux 内核提供了 <code>sendfile</code> 这个系统调用，这个系统调用将文件描述符（必须是真实的文件）作为输入，套接字描述符作为输出，达到在两个套接字之间直接传递数据，完全在内核内部完成，而避免了数据在内核和用户进程间的复制，并且避免了多余的系统调用。所以 Nginx 作为号称可以榨干计算机最后一丝性能的服务软件，自然也提供了对 <code>sendfile</code> 的支持，只需要在提供静态资源访问的配置块中添加 <code>sendfile on;</code> 即可。</p><p>说完了程序为什么会发送阻塞，再说说如何避免阻塞，也就是非阻塞。非阻塞 IO 最简单的实现就是多线程，遇到耗时的 IO 操作，就开启一个线程处理，这样就可以做到不阻塞当前线程了。对于 <code>socket</code> 模块，也可以将套接字对象设置为非阻塞模式：<code>socket.setblocking(false)</code>，这样再进行 <code>recv</code> 等系统调用时将抛出一个异常而不是阻塞当前线程。对于文件，Linux 内核提供了 AIO 相关的系统调用，但是市面上也并没有看到太多的应用。当今最常用的非阻塞 IO 的方法就是 <strong>IO多路复用</strong>，Linux 提供 IO 多路复用相关的几个系统调用就是 <code>select</code>、<code>poll</code>、<code>epoll</code>。Python 协程的完整实现，IO 多路复用也是不可少的一个环节，Nginx 出了名和高效，也就是借助了 IO 多路复用的能力。</p><p>PS：中断其实也就是一种异步的事件通知机制，可见整套计算机系统的设计中穿插着各种的同步和异步。其他原因造成的阻塞，例如锁、<code>wait</code>、<code>sleep</code> 函数等，各位有兴趣可以自己探索一番。</p><h3 id="IO多路复用"><a href="#IO多路复用" class="headerlink" title="IO多路复用"></a>IO多路复用</h3><p>IO 多路复用是如何在单个线程内并发处理多个网络套接字的一种方式，已经是系统高性能网络服务器的必备技术，Nginx、Redis 等也都用到了 IO 多路复用技术。</p><h4 id="select"><a href="#select" class="headerlink" title="select"></a>select</h4><p>最先出来，且兼容性最好的 IO 多路复用技术是 <code>select</code> 系统调用。它的实现思路是，传递给它一个包含所有套接字描述符的数组，如果数组内的套接字有数据到来，<code>select</code> 将返回这些可以操作的套接字，并唤醒进程继续处理，否则将一直阻塞，或直到设置的 <code>timeout</code> 超时。Python 的标准库 <code>select.select</code> 提供了对它的封装，下面一个简单的例子看看如何使用。</p><p><code>select.select</code> 函数申明：</p><pre><code>select(rlist, wlist, xlist[, timeout]) -&gt; (rlist, wlist, xlist)</code></pre><ul><li>rlist 对应可读列表，此列表内的套接字有数据来到时会使 select 返回。</li><li>wlist 对应可写列表，此列表内的套接字可写时返回。</li><li>xlist 对应异常列表，此列表内的套接字异常，比如已被关闭时返回。</li><li>可选的 timeout 参数，如果提供，则 select 会在超时后唤醒进程。因此，我们也可以使用 <code>select.select([],[],[],2)</code> 来模拟 time.sleep 函数。</li></ul><p>select 函数返回一个包含三种情况套接字列表的元组，例如返回的 rlist 内的套接字，肯定是已经有数据可读的套接字，因此这时候调用 recv 就不会将进程阻塞了。同时处理多个客户端连接的原因也在这里，当有新的客户端连接，或者客户端有数据发送到服务端时，select 都将唤醒线程去处理，且处理过程中 recv 也不会造成单个套接字的阻塞导致整个线程内所有套接字都无法被处理。</p><p>下面看代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEPORT, <span class="number">1</span>)</span><br><span class="line">s.setblocking(<span class="literal">False</span>)</span><br><span class="line">s.bind((<span class="string">''</span>,<span class="number">9090</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Server is listen on 0.0.0.0:9090'</span></span><br><span class="line"></span><br><span class="line">rlist = [s, ]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    rables , _ , xables = select.select(rlist,[],[])</span><br><span class="line">    <span class="keyword">for</span> sock <span class="keyword">in</span> rables:</span><br><span class="line">        <span class="keyword">if</span> sock <span class="keyword">is</span> s:</span><br><span class="line">            new_sock, addr = sock.accept()</span><br><span class="line">            new_sock.setblocking(<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'New client : %s:%s'</span> % addr</span><br><span class="line">            rlist.append(new_sock)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            msg = sock.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> msg == <span class="string">''</span> <span class="keyword">or</span> <span class="string">'exit'</span> <span class="keyword">in</span> msg: </span><br><span class="line">                sock.close()</span><br><span class="line">                rlist.remove(sock)</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'Have a client exit...'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'Recv msg: %s'</span> % msg</span><br><span class="line">                sock.send(<span class="string">'From server: '</span> + msg)</span><br></pre></td></tr></table></figure><p>将代码运行起来：</p><pre><code>root@yunfwe:~# python echo.py Server is listen on 0.0.0.0:9090</code></pre><p>这时代码被阻塞到了 select 处，接着新开一个终端，通过 nc 命令连接此端口，并发送 <code>hello</code> 字符串：</p><pre><code>root@yunfwe:~# nc 127.0.0.1 9090helloFrom server: hello</code></pre><p>这时服务端打印如下：</p><pre><code>root@yunfwe:~# python echo.py Server is listen on 0.0.0.0:9090New client : 127.0.0.1:41700Recv msg: hello</code></pre><p>这个过程中，select 已经返回了两次，第一次是 nc 客户端接入的时候，执行了获取客户端套接字以及将客户端套接字也加入 rlist 中，第二次返回因为客户端发送了 <code>hello</code> 字符串。<code>sock.recv(4096)</code> 这一步，并不是指从套接字缓存区读取 4096 个字节，而是创建一个长度为 4096 的用户进程缓冲区，然后接收从内核中套接字缓冲区复制来的数据，所以并不一定 recv 返回的数据就有 4096 的长度。接着再新开一个终端再次用 nc 连接服务端：</p><pre><code>root@yunfwe:~# nc 127.0.0.1 9090hiFrom server: hi</code></pre><p>可以看到，第二个客户端也被正常的服务了！</p><pre><code>root@yunfwe:~# python echo.py Server is listen on 0.0.0.0:9090New client : 127.0.0.1:41700Recv msg: helloNew client : 127.0.0.1:41702Recv msg: hi</code></pre><p>在单线程中，同时处理多个客户端的连接，而且如果设置了 <code>timeout</code> 关键字，就可以在超时后做一些额外的处理工作，IO 多路复用就提供了这么强大的能力。</p><p>接着两个客户端都向服务器发送 <code>exit</code> 字符串来退出连接：</p><pre><code>root@yunfwe:~# python echo.py Server is listen on 0.0.0.0:9090New client : 127.0.0.1:41700Recv msg: helloNew client : 127.0.0.1:41702Recv msg: hiHave a client exit...Have a client exit...</code></pre><p>以上就是 select 的简单示例，可以看到 select 还是非常简单，那么 select 又是如何完成套接字的监听和唤醒进程的呢？</p><p>在上面的例子中，已经有两个客户端连接了，加上服务端监听服务端口的套接字，一共有三个套接字。在进行 select 系统调用时，select 会将调用线程分别放到这三个套接字的等待队列中，这时线程就失去了执行权，当其中任何一个套接字有数据到来，将触发中断处理程序，中断程序会将线程从等待队列移除，然后重新加入执行队列。线程被唤醒后就知道，肯定有至少一个套接字接收了数据，这时只需要遍历 select 返回的列表就可以拿到所有就绪的套接字了。</p><p>select 的实现非常简单，而且在多个平台都有实现（Windows，Linux，Mac 都可用），但是简单不一定代表高效，如果需要被同时监听的套接字太多，每次 select 都先检查套接字缓冲区是否已经有准备好的数据，如果有就直接返回，没有就需要将线程加入到每个套接字的等待队列，唤醒也需要从每个套接字的等待队列移除。这个过程需要经历至少一次对套接字列表的遍历，套接字列表越大，每次 select 调用的成本也越高，这也是 Linux 限制 select 默认最高 1024 个描述符的原因之一。</p><h4 id="epoll"><a href="#epoll" class="headerlink" title="epoll"></a>epoll</h4><p>在 select 的基础上，升级发展出了 poll，但是基本的原理还是一样，select 中遇到的问题，poll 也没有解决，只是 poll 没有了 1024 最大文件描述符的限制。再之后，对 select 进行功能分离和引入 eventpoll 对象来作为代理，优化存储套接字的数据结构，使 IO 多路复用的效率大大提高，这就是 epoll。</p><p>在 select 中，每次 select 调用，都会将线程添加到套接字的等待队列，唤醒也需要从所有套接字队列中把线程移除，epoll 添加了一层代理（eventpoll），只需要使用 <code>epoll_create</code> 就可以创建它，然后使用 <code>epoll_ctl</code> 维护要监听的套接字，当添加要监听的套接字的时候，只是将 eventpoll 添加到这些套接字的等待队列，而不是直接将线程添加到等待队列了。当套接字接收到数据，中断处理进程会给 eventpoll 对象的 rdlist （就绪列表）中引用这些准备就绪的套接字。当程序执行到 <code>epoll_wait</code> 时，如果 rdlist 中已经有就绪的套接字就直接返回，否则将线程放到 eventpoll 中的等待队列里完成对线程的阻塞，当套接字再次收到数据，线程才会被再次唤醒。</p><p>正因为 rdlist 的存在，eventpoll 就不需要对所有套接字进行遍历来收集准备就绪的套接字了。而且只需要判断 rdlist 的有无数据就可以完成对线程的阻塞和唤醒，<code>epoll_ctl</code> 也使用红黑树来维护要监视的套接字，所以综上，就是 epoll 更高效和快速的原因。</p><p>Python 的 <code>select.epoll</code> 实现了对 epoll 的封装，刚才的示例使用 epoll 来改造：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">s.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEPORT, <span class="number">1</span>)</span><br><span class="line">s.setblocking(<span class="literal">False</span>)</span><br><span class="line">s.bind((<span class="string">''</span>,<span class="number">9090</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Server is listen on 0.0.0.0:9090'</span></span><br><span class="line"></span><br><span class="line">epoll = select.epoll()</span><br><span class="line">epoll.register(s.fileno(), select.EPOLLIN)</span><br><span class="line"></span><br><span class="line">fd_map = &#123;s.fileno(): s&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    events = epoll.poll()</span><br><span class="line">    <span class="keyword">for</span> fd, event <span class="keyword">in</span> events:</span><br><span class="line">        sock = fd_map[fd]</span><br><span class="line">        <span class="keyword">if</span> sock <span class="keyword">is</span> s:</span><br><span class="line">            new_sock, addr = sock.accept()</span><br><span class="line">            new_sock.setblocking(<span class="literal">False</span>)</span><br><span class="line">            <span class="keyword">print</span> <span class="string">'New client : %s:%s'</span> % addr</span><br><span class="line">            epoll.register(new_sock.fileno(), select.EPOLLIN | select.EPOLLET)</span><br><span class="line">            fd_map[new_sock.fileno()] = new_sock</span><br><span class="line">        <span class="keyword">elif</span> event == select.EPOLLIN:</span><br><span class="line">            msg = sock.recv(<span class="number">4096</span>)</span><br><span class="line">            <span class="keyword">if</span> msg == <span class="string">''</span> <span class="keyword">or</span> <span class="string">'exit'</span> <span class="keyword">in</span> msg: </span><br><span class="line">                sock.close()</span><br><span class="line">                epoll.unregister(fd)</span><br><span class="line">                <span class="keyword">del</span> fd_map[fd]</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'Have a client exit...'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">print</span> <span class="string">'Recv msg: %s'</span> % msg</span><br><span class="line">                sock.send(<span class="string">'From server: '</span> + msg)</span><br></pre></td></tr></table></figure><p>程序的执行效果与 select 版一致，就不再演示了。epoll 与 select 在 Python 上的用法还是有些区别的，select 可以直接传递套接字对象，而 epoll 只能传递套接字的文件描述符（<code>sock.fileno()</code>），所以我们需要手动维护一个文件描述符到套接字的映射。<code>epoll.register(s.fileno(), select.EPOLLIN)</code> 就是在一开始的时候，注册端口监听的套接字，之后每次调用 <code>epoll.poll()</code> 的时候，就不需要重新注册了。<code>select.EPOLLIN</code> 就是监听此套接字的可读事件，对应着 <code>select.EPOLLOUT</code> 为可写事件。在注册客户端套接字的时候多出来 <code>select.EPOLLET</code> 是表示将此套接字的监听模式设置为<strong>边缘触发</strong>模式，接下来的代码对数据的处理逻辑就与 select 版相同了。</p><p>关于<strong>水平触发</strong>和<strong>边缘触发</strong>：水平触发是默认的情况，当有数据来到，通过 recv 函数读取数据时，如果一次性没有读完（例如接收缓冲区太小），则此套接字在下次执行 <code>epoll.poll()</code> 的时候，依然会被返回，直到此套接字缓冲区被读空为止。如果存在大量没有读完的套接字，水平触发模式效率是比较低的。边缘触发则相反，如果数据一次没读完，也只通知一次，直到下次有新的数据到来。所以如果采用边缘触发模式，应该循环读取数据，直到套接字缓存区被读完抛出异常为止。因此，边缘触发的示例中，从套接字缓冲区读取数据的部分应该改为如下形式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">elif</span> event == select.EPOLLIN:</span><br><span class="line">    msg = <span class="string">''</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            msg += sock.recv(<span class="number">4096</span>)</span><br><span class="line">        <span class="keyword">except</span> socket.error:</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure><p>到这里，希望大家都对这些概念都有了基本的理解。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在平常的工作中，遇到 IO 密集型任务，比如要频繁调用外部的 API 接口（网络IO），或者频繁读写文件（磁盘IO）通常代码都会在 IO 任务创建后等待 IO 任务结束并将需要的数据返回。这种同步的编程方式是最简单的，但同时也是效率最低的。比如在一个 Web 后端中，如果是单线程单进程的运行模式，一次就只能处理一个客户端的请求，即使引入了多线程/多进程，虽然可以同时服务多个客户端了，但是如果瞬间几千的并发连接，那么后端就必须创建相对多的线程或进程，这时候 CPU 将会花费大量的时间和资源用于线程上下文切换上，而且这么多的线程，如果用到了锁机制来保证一些共享数据的安全，还将进一步的降低 Web 后端的性能。而 IO 多路复用的出现，则给这种局面带来了转机。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="http://www.yunfwe.cn/categories/Linux/"/>
    
    
      <category term="python" scheme="http://www.yunfwe.cn/tags/python/"/>
    
      <category term="linux" scheme="http://www.yunfwe.cn/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>LXC Linux系统容器</title>
    <link href="http://www.yunfwe.cn/2019/09/23/2019/LXC%20Linux%E7%B3%BB%E7%BB%9F%E5%AE%B9%E5%99%A8/"/>
    <id>http://www.yunfwe.cn/2019/09/23/2019/LXC%20Linux%E7%B3%BB%E7%BB%9F%E5%AE%B9%E5%99%A8/</id>
    <published>2019-09-23T02:12:00.000Z</published>
    <updated>2019-09-26T08:41:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>LXC 是 Linux Container 的简写。Linux Container 是一种内核虚拟化技术，可以提供轻量级的虚拟化以便隔离进程和资源。大名鼎鼎的 Docker 在早期版本使用的底层容器引擎便是 LXC，不过 Docker 的目标是创建应用级容器，而 LXC 的目标是创建系统级容器，所以使用 LXC 更容易获得接近虚拟机的体验。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>LXC 也是利用了 Linux 内核的 cgroup 和 namespace 特性来实现容器的资源隔离，因此也对 Linux 的内核版本有较高的要求。这里使用 <code>Ubuntu 18.04 Server</code> 作为容器的宿主机，内核版本为 <code>4.15.0-58-generic</code></p><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><h4 id="安装命令行工具"><a href="#安装命令行工具" class="headerlink" title="安装命令行工具"></a>安装命令行工具</h4><p>安装非常简单，在 Ubuntu 上使用 <code>apt-get install lxc</code> 即可。<code>lxc</code> 包里包含了所有的命令，之后就可以看到系统多了很多 <code>lxc-</code> 开头的命令。</p><pre><code>root@localhost:~# lxc-lxc-attach         lxc-checkpoint     lxc-create         lxc-freeze         lxc-snapshot       lxc-unfreeze       lxc-waitlxc-autostart      lxc-config         lxc-destroy        lxc-info           lxc-start          lxc-unshare        lxc-cgroup         lxc-console        lxc-device         lxc-ls             lxc-stop           lxc-update-config  lxc-checkconfig    lxc-copy           lxc-execute        lxc-monitor        lxc-top            lxc-usernsexec</code></pre><p>LXC 安装成功后会自动创建一个叫 lxcbr0 的网桥，如下：</p><pre><code>lxcbr0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500        inet 10.0.2.1  netmask 255.255.255.0  broadcast 0.0.0.0        ether 00:16:3e:00:00:00  txqueuelen 1000  (Ethernet)        RX packets 0  bytes 0 (0.0 B)        RX errors 0  dropped 0  overruns 0  frame 0        TX packets 0  bytes 0 (0.0 B)        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</code></pre><p>之后运行的容器的虚拟网卡都会接入到这个网桥了。LXC 还为这个网桥配置了一个 DHCP 服务，配置文件在 <code>/etc/dnsmasq.d/lxc</code>。这样容器支持 DHCP 的话就可以直接获取到可用的 IP 地址了。</p><h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><h4 id="创建容器"><a href="#创建容器" class="headerlink" title="创建容器"></a>创建容器</h4><p><code>lxc</code> 安装后 在 <code>/usr/share/lxc/templates</code> 为我们提供了几个容器安装的模板： </p><ul><li><code>lxc-download</code>：通过网络获取容器镜像来创建容器。</li><li><code>lxc-local</code>：通过本地已有的镜像来创建容器。</li><li><code>lxc-busybox</code>：使用 busybox 来创建最基本的容器。</li><li><code>lxc-oci</code>：通过 oci 标准的镜像来创建容器。</li></ul><p>创建容器通过使用 <code>lxc-create</code> 命令来完成，此命令会调用指定的模板来完成容器的创建，我们先通过 <code>lxc-busybox</code> 这个模板创建一个最简单的容器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxc-create -t busybox -n busybox</span><br></pre></td></tr></table></figure><p><code>lxc-create</code> 命令通过 <code>-t</code> 参数指定要使用的模板，<code>-n</code> 参数指定创建的容器的名称。之后使用 <code>lxc-ls</code> 可以看到所有已经创建的容器，所有的容器默认都保存在 <code>/var/lib/lxc</code> 中。</p><pre><code>root@localhost:~# ls /var/lib/lxc/busyboxroot@localhost:~# ls /var/lib/lxc/busybox/config  rootfsroot@localhost:~# ls /var/lib/lxc/busybox/rootfs/bin      dev  home  lib64  null  ram0  sbin     sys  tty   tty1  urandom  varconsole  etc  lib   mnt    proc  root  selinux  tmp  tty0  tty5  usr      zeroroot@localhost:~#</code></pre><p>每个容器对应 <code>/var/lib/lxc</code> 下的每个目录，目录内存放着这个容器的配置文件和根文件系统。<code>lxc-create</code> 还可以指定使用 <code>lvm</code>、<code>Ceph RBD</code>、<code>zfs</code>、<code>loop</code> 文件系统来作为容器的根目录，默认使用的是 <code>dir</code> 的方式与宿主机共享文件系统。目录的方式胜在简单，但是却无法支持其他文件系统带来的高级特性，比如磁盘配额、快照等。</p><h4 id="启动容器"><a href="#启动容器" class="headerlink" title="启动容器"></a>启动容器</h4><p>使用 <code>lxc-info</code> 命令可以查看指定容器的状态，使用 <code>lxc-start</code> 来启动容器：</p><pre><code>root@localhost:~# lxc-info busyboxName:           busyboxState:          STOPPEDroot@localhost:~# lxc-start busyboxroot@localhost:~# lxc-info busyboxName:           busyboxState:          RUNNINGPID:            5288CPU use:        0.01 secondsBlkIO use:      0 bytesMemory use:     1.77 MiBKMem use:       1.40 MiBLink:           veth7F3KFWTX bytes:      1.51 KiBRX bytes:      1.87 KiBTotal bytes:   3.37 KiBroot@localhost:~#</code></pre><p>容器启动后的第一个进程的 ID 是 5288，查看此进程的父进程可以看到是一个内核进程：</p><pre><code>root@localhost:~# cat /proc/5288/status |grep PPidPPid:    5281root@localhost:~# ps 5281PID TTY      STAT   TIME COMMAND5281 ?        Ss     0:00 [lxc monitor] /var/lib/lxc busyboxroot@localhost:~# </code></pre><h4 id="连接到容器"><a href="#连接到容器" class="headerlink" title="连接到容器"></a>连接到容器</h4><p>容器启动后，我们可以通过 <code>lxc-attach</code> 命令来运行容器内的命令，默认会运行容器内的 shell 来供我们操作容器。</p><pre><code>root@localhost:~# lxc-attach busybox BusyBox v1.27.2 (Ubuntu 1:1.27.2-2ubuntu3.2) built-in shell (ash)Enter &apos;help&apos; for a list of built-in commands.~ # ifconfigeth0      Link encap:Ethernet  HWaddr 00:16:3E:88:E3:4A          inet6 addr: fe80::216:3eff:fe88:e34a/64 Scope:Link        UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1        RX packets:25 errors:0 dropped:0 overruns:0 frame:0        TX packets:15 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:1000         RX bytes:2526 (2.4 KiB)  TX bytes:1962 (1.9 KiB)lo        Link encap:Local Loopback          inet addr:127.0.0.1  Mask:255.0.0.0        inet6 addr: ::1/128 Scope:Host        UP LOOPBACK RUNNING  MTU:65536  Metric:1        RX packets:0 errors:0 dropped:0 overruns:0 frame:0        TX packets:0 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:1000         RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)~ # </code></pre><p>进入容器后就可以执行容器内的所有命令了，可以看到，容器默认分配了一个 <code>eth0</code> 的网卡，但是并没有获取到 IP 地址。LXC 容器会尽量让一个容器就像是一个虚拟机一样，因此在容器内可以自主的配置 IP，甚至使用 reboot 命令重启容器都可以。接下来给容器分配一个 IP 地址，然后看看是否可以与主机互访。</p><p>容器内操作：</p><pre><code>~ # ifconfig eth0 10.0.2.100~ # ip ro add default via 10.0.2.1~ # ping 180.76.76.76PING 180.76.76.76 (180.76.76.76): 56 data bytes64 bytes from 180.76.76.76: seq=0 ttl=127 time=4.649 ms64 bytes from 180.76.76.76: seq=1 ttl=127 time=7.460 ms64 bytes from 180.76.76.76: seq=2 ttl=127 time=4.998 ms64 bytes from 180.76.76.76: seq=3 ttl=127 time=4.852 ms--- 180.76.76.76 ping statistics ---4 packets transmitted, 4 packets received, 0% packet lossround-trip min/avg/max = 4.649/5.489/7.460 ms~ # </code></pre><p>需要注意的是，给容器分配的 IP 地址要和宿主机的 <code>lxcbr0</code> 网桥的地址在同一网段，并且容器内将默认网关设置为宿主机网桥的 IP 即可实现容器内联网。接着执行 <code>telnetd</code> 命令允许在外部通过 <code>telnet</code> 程序远程连接到此容器。</p><p>宿主机已经可以 <code>ping</code> 通容器：</p><pre><code>root@localhost:~# ping -c 4 10.0.2.100PING 10.0.2.100 (10.0.2.100) 56(84) bytes of data.64 bytes from 10.0.2.100: icmp_seq=1 ttl=64 time=0.046 ms64 bytes from 10.0.2.100: icmp_seq=2 ttl=64 time=0.058 ms64 bytes from 10.0.2.100: icmp_seq=3 ttl=64 time=0.047 ms64 bytes from 10.0.2.100: icmp_seq=4 ttl=64 time=0.045 ms--- 10.0.2.100 ping statistics ---4 packets transmitted, 4 received, 0% packet loss, time 3070msrtt min/avg/max/mdev = 0.045/0.049/0.058/0.005 msroot@localhost:~#</code></pre><p>除了使用 <code>lxc-attach</code> 还可以使用 <code>lxc-console</code> 来登陆容器，此命令会连接到容器内 Linux 的控制台，所以必须提供必要的用户名和密码才可以登陆进容器内部。</p><p>更改容器内密码：</p><pre><code>~ # passwdpasswd: no record of root in /etc/shadow, using /etc/passwdChanging password for rootNew password: Bad password: too weakRetype password: passwd: password for root changed by root~ # </code></pre><p>宿主机使用 <code>lxc-console</code> 来登陆容器：</p><pre><code>root@localhost:~# lxc-console busyboxConnected to tty 1Type &lt;Ctrl+a q&gt; to exit the console, &lt;Ctrl+a Ctrl+a&gt; to enter Ctrl+a itselfbusybox login: rootPassword: BusyBox v1.27.2 (Ubuntu 1:1.27.2-2ubuntu3.2) built-in shell (ash)Enter &apos;help&apos; for a list of built-in commands.~ # </code></pre><p>可以看到，成功输入用户名和密码后也进入了容器。</p><h4 id="停止并删除容器"><a href="#停止并删除容器" class="headerlink" title="停止并删除容器"></a>停止并删除容器</h4><p>使用 <code>lxc-stop</code> 来停止容器，使用 <code>lxc-destroy</code> 来彻底删除容器。</p><pre><code>root@localhost:~# lxc-stop busyboxroot@localhost:~# lxc-destroy busyboxlxc-destroy: busybox: tools/lxc_destroy.c: main: 271 Destroyed container busyboxroot@localhost:~#</code></pre><p>需要注意的是，如果想直接删除一个正在运行的容器，可以使用 <code>lxc-destroy -f</code> 来强制删除。</p><h3 id="容器管理"><a href="#容器管理" class="headerlink" title="容器管理"></a>容器管理</h3><blockquote><p>在快速开始一章中，已经体验了 LXC 的基本用法，下面的章节将会讲解如何对容器进行更高级的管理，让容器运行的更像是虚拟机一样。</p></blockquote><h4 id="创建容器-1"><a href="#创建容器-1" class="headerlink" title="创建容器"></a>创建容器</h4><p>容器的创建分两种，一种是由 root 用户创建的特权容器，一种是由普通用户创建的非特权容器。非特权容器有一些限制，比如无法创建设备节点等。而在特权模式下，让 Docker 运行在 LXC 中，甚至 LXC 嵌套 LXC 运行都成了可能。下面所有的例子创建的都是特权容器。</p><h5 id="获取镜像模板"><a href="#获取镜像模板" class="headerlink" title="获取镜像模板"></a>获取镜像模板</h5><p>busybox 只提供了一个极小的更适合用于嵌入式 Linux 的基本文件系统，下面就看看如何使用 LXC 运行 CentOS、Ubuntu 等完整的 Linux 发行版吧！</p><p>例如，想要运行一个基于 CentOS 发行版的容器，首先需要下载 CentOS 的容器镜像模板，之后需要运行容器时，会自动从下载好的模板解压出容器的根文件系统到指定的 <code>lvm</code>、<code>zfs</code>、<code>loop</code> 或者 <code>dir</code> 等存储设备，并启动容器。</p><p>LXC 提供了 <code>lxc-download</code> 模板来通过网络获取容器镜像：</p><pre><code>root@localhost:~# lxc-create -t download -n ubuntu-1604Setting up the GPG keyringDownloading the image index---DIST    RELEASE    ARCH    VARIANT    BUILD---alpine    3.10    amd64    default    20190923_13:00alpine    3.10    arm64    default    20190923_13:00...---Distribution: ubuntuRelease: xenialArchitecture: amd64Downloading the image indexDownloading the rootfsDownloading the metadataThe image cache is now readyUnpacking the rootfs---You just created an Ubuntu xenial amd64 (20190923_07:42) container.To enable SSH, run: apt install openssh-serverNo default root or user password are set by LXC.</code></pre><p>命令执行后会列出所有镜像的索引，接着会让你输入要下载的发行版、版本号、架构信息。经过片刻等待，Ubuntu 16.04 的容器就创建成功了。所有下载的镜像都缓存在 <code>/var/cache/lxc/download</code> 中，下一次创建此镜像模板的容器时就不会再次通过网络下载了。</p><p>也可以使用 <code>lxc-create -t download --help</code> 来查看模板支持的一些命令，例如安装 CentOS 7 过程可以省略为 <code>lxc-create -t download -n centos7 -- -d centos -r 7 -a amd64</code>。需要注意的是命令行当中的 <code>--</code> 参数，此参数之后的参数才会会当作模板参数传递给模板。</p><h5 id="启动容器-1"><a href="#启动容器-1" class="headerlink" title="启动容器"></a>启动容器</h5><p>接着启动此容器，并验证是否是 Ubuntu 16.04 的发行版：</p><pre><code>root@localhost:~# lxc-start ubuntu-1604root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# python3 -m platformLinux-4.15.0-58-generic-x86_64-with-Ubuntu-16.04-xenialroot@ubuntu-1604:~#</code></pre><p><code>lxc-start</code> 默认在后台启动容器，如果想切换至前端启动，可以使用 <code>-F</code> 参数，同时容器启动过程中的一些控制台输出也会被打印出来了。</p><h4 id="远程连接容器"><a href="#远程连接容器" class="headerlink" title="远程连接容器"></a>远程连接容器</h4><p>LXC 没有提供远程连接容器的方式，如果打算为 LXC 写一套 Web 管理工具，并想实现在 Web 端操作容器，可以采用将 <code>lxc-attach</code> 或者 <code>lxc-console</code> 的输入输出通过 <code>WebSocket</code> 的方式与前端通信。</p><p>或者通过 SSH 的方式远程连接到容器，这样就需要在每个容器内配置 SSH 服务。例如在刚才创建好的容器中安装 SSH 服务：</p><pre><code>root@ubuntu-1604:~# apt-get install openssh-server -yroot@ubuntu-1604:~# netstat -anptActive Internet connections (servers and established)Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program nametcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      610/sshd        tcp6       0      0 :::22                   :::*                    LISTEN      610/sshd        root@ubuntu-1604:~#</code></pre><p>由于新启动的容器还是空密码，所以还需要设置一个密码才可以登录：</p><pre><code>root@ubuntu-1604:~# passwdEnter new UNIX password: Retype new UNIX password: passwd: password updated successfullyroot@ubuntu-1604:~#</code></pre><p>允许使用 root 用户登录并重启服务：</p><pre><code>sed -i &apos;s/^PermitRootLogin prohibit-password/PermitRootLogin yes/g&apos; /etc/ssh/sshd_configservice ssh restart</code></pre><p>这样就可以在宿主机上通过 ssh 连接到容器了，如果想在局域网内也可以 ssh 连接到容器，可以将 <code>lxcbr0</code> 与物理网卡桥接起来，并配置局域网的 IP 地址。</p><h4 id="容器资源限制"><a href="#容器资源限制" class="headerlink" title="容器资源限制"></a>容器资源限制</h4><p>对于虚拟机来说，在创建虚拟机时为虚拟机分配的内存大小 就是对虚拟机能使用的内存的限制。对于容器而言，限制容器可使用的硬件资源 都是通过 cgroup 来实现的。</p><p>LXC 提供了 <code>lxc-cgroup</code> 命令来操作容器的控制组，默认容器是没有任何限制的。</p><h5 id="限制内存使用"><a href="#限制内存使用" class="headerlink" title="限制内存使用"></a>限制内存使用</h5><p>在容器内使用 <code>free -m</code> 命令查看内存使用情况：</p><pre><code>root@ubuntu-1604:~# free -m            total        used        free      shared  buff/cache   availableMem:           3921          18        3802           8          99        3902Swap:          3920           0        3920root@ubuntu-1604:~#</code></pre><p>可以看到总内存是和宿主机内存相同的，接下来使用 <code>lxc-cgroup</code> 来限制内存的使用：</p><p>宿主机上执行：</p><pre><code>root@ubuntu-1604:~# lxc-cgroup ubuntu-1604 memory.limit_in_bytes 256M</code></pre><p>容器内查看：</p><pre><code>root@ubuntu-1604:~# free -m            total        used        free      shared  buff/cache   availableMem:            256          18         137           8          99         237Swap:          3920           0        3920root@ubuntu-1604:~#</code></pre><p>可以看到允许使用的最大内存已经变成了 256M。但是这样只是临时更改了容器允许使用的内存，在容器重启后限制就会消失，如果想在重启重启后也保持这样的限制，可以更改每个容器的配置文件。</p><p>例如容器 ubuntu-1604 的配置文件就在 <code>/var/lib/lxc/ubuntu-1604/config</code> 在文件的最后添加如下内容：</p><pre><code>lxc.cgroup.memory.limit_in_bytes = 512M</code></pre><p>接着使用 <code>lxc-stop ubuntu-1604</code> 和 <code>lxc-start ubuntu-1604</code> 停止并启动容器，直接在容器内使用 <code>reboot</code> 命令是无效的。</p><pre><code>root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# free -m            total        used        free      shared  buff/cache   availableMem:            512          11         492           8           8         500Swap:          3920           0        3920root@ubuntu-1604:~#</code></pre><p>容器重启后可用内存变为了 512M。对于交换分区，我们也可以通过 cgroup 来限制其使用，其限制字段名为 <code>memory.memsw.limit_in_bytes</code>，但是限制交换分区使用后通过 <code>free</code> 命令看到的依旧是宿主机的交换分区大小。</p><h5 id="限制CPU使用"><a href="#限制CPU使用" class="headerlink" title="限制CPU使用"></a>限制CPU使用</h5><p>与内存限制的简单粗暴不同，对于 CPU 资源的限制复杂了一些，因为 CPU 有不同维度的限制条件，例如仅允许容器运行在 CPU 的某个核心上，或者仅允许容器在一段时间内获取多久的 CPU 执行时间片。这里只简单的限制容器可以在哪几个核心上使用。</p><p>宿主机上执行：</p><pre><code>root@ubuntu-1604:~# lxc-cgroup ubuntu-1604 cpuset.cpus &quot;0,1&quot;</code></pre><p>表示仅允许容器使用 CPU 的第 0 个和第 1 个核心。容器内查看：</p><pre><code>root@ubuntu-1604:~# cat /proc/cpuinfo |grep processorprocessor    : 0processor    : 1root@ubuntu-1604:~#</code></pre><p>容器内只可以看到 CPU 的两个核心了。同样，如果想要在容器重启后限制依然生效，可以修改容器的配置文件 新增以下内容：</p><pre><code>lxc.cgroup.cpuset.cpus = &quot;0,1&quot;</code></pre><h5 id="限制存储空间"><a href="#限制存储空间" class="headerlink" title="限制存储空间"></a>限制存储空间</h5><p>如果容器的存储使用的是 <code>dir</code> 则与宿主机共享存储，如果使用了 <code>lvm</code>、<code>zfs</code> 等文件系统则可以通过给容器分配独立的分区方式来限制容器可用的存储空间。这里使用 <code>loop</code> 设备模拟硬盘分区的方式来限制容器存储使用。</p><p>创建使用 <code>loop</code> 设备的容器并启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lxc-create -B loop -t download -n ubuntu-1604-loop --fssize 1G -- -d ubuntu -r xenial -a amd64</span><br><span class="line">lxc-start ubuntu-1604-loop</span><br></pre></td></tr></table></figure><p>可以看到，<code>dir</code> 和 <code>loop</code> 的区别如下：</p><pre><code>root@localhost:~# ls /var/lib/lxc/ubuntu-1604config  rootfsroot@localhost:~# ls /var/lib/lxc/ubuntu-1604-loop/config  rootdev  rootfsroot@localhost:~# cat /var/lib/lxc/ubuntu-1604/config |grep rootfslxc.rootfs.path = dir:/var/lib/lxc/ubuntu-1604/rootfsroot@localhost:~# cat /var/lib/lxc/ubuntu-1604-loop/config |grep rootfslxc.rootfs.path = loop:/var/lib/lxc/ubuntu-1604-loop/rootdevroot@localhost:~# ls /var/lib/lxc/ubuntu-1604-loop/rootfsroot@localhost:~# ls -lh /var/lib/lxc/ubuntu-1604-loop/rootdev -rw------- 1 root root 1.1G Sep 25 03:36 /var/lib/lxc/ubuntu-1604-loop/rootdevroot@localhost:~#</code></pre><p>虽然 <code>ubuntu-1604-loop</code> 容器依然保留了 <code>rootfs</code> 目录，但内容确是空的。容器内也可以看到根文件系统的总空间只有 1G 了：</p><pre><code>root@localhost:~# lxc-attach ubuntu-1604-loop root@ubuntu-1604-loop:~# df -hTFilesystem     Type   Size  Used Avail Use% Mounted on/dev/loop0     ext4   976M  372M  537M  41% /none           tmpfs  492K     0  492K   0% /devtmpfs          tmpfs  2.0G     0  2.0G   0% /dev/shmtmpfs          tmpfs  2.0G  8.1M  2.0G   1% /runtmpfs          tmpfs  5.0M     0  5.0M   0% /run/locktmpfs          tmpfs  2.0G     0  2.0G   0% /sys/fs/cgrouproot@ubuntu-1604-loop:~#</code></pre><h5 id="网卡接口限速"><a href="#网卡接口限速" class="headerlink" title="网卡接口限速"></a>网卡接口限速</h5><p>对容器网卡流量进行限制使用了 Linux 内核的流量控制功能，通过 <code>tc</code> 命令进行管理。<code>tc</code> 命令的操作比较复杂，所幸有人封装好了对接口进行限速的脚本并开源到了 Github 上，我们只需要下载下来使用就可以了。</p><p>宿主机上安装 <code>wondershaper</code> 工具：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/magnific0/wondershaper.git</span><br><span class="line">cp wondershaper/wondershaper /usr/<span class="built_in">local</span>/sbin/</span><br></pre></td></tr></table></figure><p><code>windershaper</code> 工具使用非常简单，使用 <code>-a</code> 参数指定网卡接口名称，<code>-c</code> 清理所有规则，<code>-d</code> 限制下载速率，<code>-u</code> 限制上传速率，单位是 <code>Kbps</code>。需要注意的是 Linux 并不能很准确的控制下载速度，而且对于提供服务的容器或虚拟机而言，一般需要限制的是上传速率。</p><pre><code>root@localhost:~# wondershaperUSAGE: /usr/local/sbin/wondershaper [-hcs] [-a &lt;adapter&gt;] [-d &lt;rate&gt;] [-u &lt;rate&gt;]Limit the bandwidth of an adapterOPTIONS:-h           Show this message-a &lt;adapter&gt; Set the adapter-d &lt;rate&gt;    Set maximum download rate (in Kbps) and/or-u &lt;rate&gt;    Set maximum upload rate (in Kbps)-p           Use presets in /etc/conf.d/wondershaper.conf-c           Clear the limits from adapter-s           Show the current status of adapter-v           Show the current versionMODES:wondershaper -a &lt;adapter&gt; -d &lt;rate&gt; -u &lt;rate&gt;wondershaper -c -a &lt;adapter&gt;wondershaper -s -a &lt;adapter&gt;EXAMPLES:wondershaper -a eth0 -d 1024 -u 512wondershaper -a eth0 -u 512wondershaper -c -a eth0root@localhost:~#</code></pre><p>接着找到要限制流量的容器对应的网卡接口 并限制容器的上行速度为 <code>1Mbps</code>：</p><pre><code>root@localhost:~# lxc-info ubuntu-1604 | egrep &quot;IP|Link&quot;IP:             10.0.2.238Link:           vethQFAM44root@localhost:~# wondershaper -a vethQFAM44 -croot@localhost:~# wondershaper -a vethQFAM44 -d 1024root@localhost:~# </code></pre><p>我也不清楚为什么设置容器的上行速率使用的是 <code>-d</code> 参数，实际测试发现此参数能控制容器的上传速率。</p><p>在容器内运行一个 Web 服务进行测试：</p><pre><code>root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# dd if=/dev/zere of=img bs=1M count=128dd: failed to open &apos;/dev/zere&apos;: No such file or directoryroot@ubuntu-1604:~# dd if=/dev/zero of=img bs=1M count=128128+0 records in128+0 records out134217728 bytes (134 MB, 128 MiB) copied, 0.0789097 s, 1.7 GB/sroot@ubuntu-1604:~# python3 -m http.server 80Serving HTTP on 0.0.0.0 port 80 ...</code></pre><p>宿主机上使用 <code>wget</code> 命令下载测试：</p><pre><code>root@localhost:~# wget http://10.0.2.238/img --2019-09-25 08:47:46--  http://10.0.2.238/imgConnecting to 10.0.2.238:80... connected.HTTP request sent, awaiting response... 200 OKLength: 134217728 (128M) [application/octet-stream]Saving to: ‘img’img        0%[                     ]   1.04M   120KB/s    eta 18m 4s</code></pre><p>可以看到，速度保持在了 <code>1Mbps</code> 下。</p><h4 id="挂起和恢复容器"><a href="#挂起和恢复容器" class="headerlink" title="挂起和恢复容器"></a>挂起和恢复容器</h4><p>正在运行中的容器可以随时暂停和恢复，使用 <code>lxc-freeze</code> 命令挂起一个容器，此时容器内所有正在运行的程序都将被强制挂起：</p><pre><code>root@localhost:~# lxc-freeze ubuntu-1604root@localhost:~# ps aux |grep python3root       7921  0.0  0.4  55988 17520 pts/4    D+   07:33   0:01 python3 -m http.server 80root       8222  0.0  0.0  13136  1104 pts/2    S+   09:07   0:00 grep --color=auto python3root@localhost:~# cat /proc/7921/status |grep StateState:    D (disk sleep)root@localhost:~# kill -9 7921root@localhost:~# cat /proc/7921/status |grep StateState:    D (disk sleep)root@localhost:~#</code></pre><p>可以看到，刚才容器内运行的 python 进程已经是不可中断的休眠状态了，此时即使使用 <code>kill -9</code> 也依然无法杀掉此状态的进程。使用 <code>lxc-unfreeze</code> 解除容器的挂起状态：</p><pre><code>root@localhost:~# lxc-unfreeze ubuntu-1604root@localhost:~# cat /proc/7921/status |grep Statecat: /proc/7921/status: No such file or directoryroot@localhost:~#</code></pre><p>在容器内可以看到 python 进程已经退出，并显示 <code>Killed</code>，看来 <code>kill -9</code> 可能会迟到，但永远不会缺席。</p><h4 id="容器状态监控"><a href="#容器状态监控" class="headerlink" title="容器状态监控"></a>容器状态监控</h4><p>LXC 有三个命令工具提供了容器状态监控，分别是 <code>lxc-monitor</code>、<code>lxc-top</code>、<code>lxc-wait</code>。</p><h5 id="lxc-monitor"><a href="#lxc-monitor" class="headerlink" title="lxc-monitor"></a>lxc-monitor</h5><p>这个命令可以监控单个或多个容器的状态变化，例如监听所有名称以 <code>ubuntu</code> 开头的容器状态：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxc-monitor ubuntu*</span><br></pre></td></tr></table></figure><p>接着打开另外一个终端，重启一个容器：</p><pre><code>root@localhost:~# lxc-stop ubuntu-1604-looproot@localhost:~# lxc-start ubuntu-1604-looproot@localhost:~#</code></pre><p>可以看到，<code>lxc-monitor</code> 输出了被监听的容器的状态变化：</p><pre><code>root@localhost:~# lxc-monitor ubuntu*&apos;ubuntu-1604-loop&apos; exited with status [0]&apos;ubuntu-1604-loop&apos; changed state to [STOPPING]&apos;ubuntu-1604-loop&apos; changed state to [STOPPED]&apos;ubuntu-1604-loop&apos; changed state to [STARTING]&apos;ubuntu-1604-loop&apos; changed state to [RUNNING]</code></pre><h5 id="lxc-wait"><a href="#lxc-wait" class="headerlink" title="lxc-wait"></a>lxc-wait</h5><p>此命令是等待容器到达某一状态后便退出。</p><pre><code>root@localhost:~# lxc-wait ubuntu-1604-loop -s RUNNINGroot@localhost:~# lxc-wait ubuntu-1604-loop -s STOPPED</code></pre><p><code>ubuntu-1604-loop</code> 容器已经是运行状态，所以命令直接就退出了，而等待容器状态变化为 <code>STOPPED</code> 是，命令发送了阻塞。接着停止此容器，可以看到 <code>lxc-wait</code> 发现被监控容器是 <code>STOPPED</code> 状态后就退出了。</p><p>如果想同时监听多个状态，可以使用 <code>lxc-wait ubuntu-1604-loop -s &quot;RUNNING|STOPPED&quot;</code> 这种方式。</p><h5 id="lxc-top"><a href="#lxc-top" class="headerlink" title="lxc-top"></a>lxc-top</h5><p>此命令可以查看所有容器的运行状态</p><pre><code>Container                   CPU          CPU          CPU                                BlkIO        Mem       KMemName                       Used          Sys         User                    Total(Read/Write)       Used       Usedubuntu-1604                0.39         0.25         0.10         4.00 KiB(  0.00   /4.00 KiB)  17.83 MiB   4.53 MiBubuntu-1604-loop           2.24         1.48         0.28      54.32 MiB(54.14 MiB/180.00 KiB)  72.16 MiB   6.16 MiBTOTAL 2 of 2               2.63         1.73         0.38      54.32 MiB(54.14 MiB/184.00 KiB)  89.99 MiB  10.68 MiBroot@localhost:~#</code></pre><h4 id="网卡管理"><a href="#网卡管理" class="headerlink" title="网卡管理"></a>网卡管理</h4><h5 id="网卡配置项"><a href="#网卡配置项" class="headerlink" title="网卡配置项"></a>网卡配置项</h5><p>容器启动后默认只有一个可用的 eth0 网卡接口，查看容器的配置文件可以找到网卡相关的配置项：</p><pre><code>cat /var/lib/lxc/ubuntu-1604/config...# Network configurationlxc.net.0.type = vethlxc.net.0.link = lxcbr0lxc.net.0.flags = uplxc.net.0.hwaddr = 00:16:3e:bc:27:d1...</code></pre><p>网卡相关配置如下：</p><ul><li><code>lxc.net.0.type</code>：第 0 块网卡的类型，如果是第二块网卡，则为 <code>lxc.net.1.type</code> 可选类型如下：<ul><li><code>empty</code>：不创建网卡，容器仅有 lo 网卡</li><li><code>veth</code>：创建一个对等网卡，该网卡的一端分配给容器，另一端与 <code>lxc.net.0.link</code> 指定的网桥桥接</li><li><code>vlan</code>：创建一个由 <code>lxc.net.0.link</code> 指定的虚拟局域网接口分配给容器，vlan的标识符可由 <code>lxc.net.0.vlan.id</code> 指定</li><li><code>phys</code>：将 <code>lxc.net.0.link</code> 指定的网卡接口分配给容器。</li><li><code>macvlan</code>：创建一个 <code>macvlan</code> 接口，该接口和由 <code>lxc.net.0.link</code> 指定的接口相连接</li></ul></li><li><code>lxc.net.0.name</code>：指定虚拟网卡接口的名称，默认是 eth 开头。</li><li><code>lxc.net.0.link</code>：指定进行真实网络通信的网卡。</li><li><code>lxc.net.0.flags</code>：指定网卡的状态，<code>up</code> 激活接口，<code>down</code> 关闭接口。</li><li><code>lxc.net.0.hwaddr</code>：指定虚拟网卡的 MAC 地址，默认情况该值会自动分配。</li></ul><h5 id="分配物理网卡给容器"><a href="#分配物理网卡给容器" class="headerlink" title="分配物理网卡给容器"></a>分配物理网卡给容器</h5><p>为容器新增一块虚拟网卡非常简单，只需要模范示例配置，将其中的 0 改为 1 就会新增一块 <code>eth1</code> 的网卡了，下面试试直接分配一块物理网卡给容器，需要先保证宿主机有一块额外的物理网卡，如果是虚拟机可以先为宿主机新增一块。</p><p>将以下内容追加到容器配置文件，将物理网卡分配给容器：</p><pre><code>lxc.net.1.type = physlxc.net.1.link = ens35lxc.net.1.flags = up</code></pre><p><code>ens35</code> 是宿主机上第二块物理网卡的名称，不同的 Linux 环境网卡接口名称也不尽相同。然后重启被修改的容器：</p><pre><code>root@localhost:~# lxc-stop ubuntu-1604 &amp;&amp; lxc-start ubuntu-1604root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# ifconfigens35     Link encap:Ethernet  HWaddr 00:0c:29:95:b4:7b          inet6 addr: fe80::20c:29ff:fe95:b47b/64 Scope:Link        UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1        RX packets:0 errors:0 dropped:0 overruns:0 frame:0        TX packets:9 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:1000         RX bytes:0 (0.0 B)  TX bytes:726 (726.0 B)eth0      Link encap:Ethernet  HWaddr 00:16:3e:bc:27:d1          inet addr:10.0.2.238  Bcast:10.0.2.255  Mask:255.255.255.0        inet6 addr: fe80::216:3eff:febc:27d1/64 Scope:Link        UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1        RX packets:13 errors:0 dropped:0 overruns:0 frame:0        TX packets:12 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:1000         RX bytes:1519 (1.5 KB)  TX bytes:1452 (1.4 KB)lo        Link encap:Local Loopback          inet addr:127.0.0.1  Mask:255.0.0.0        inet6 addr: ::1/128 Scope:Host        UP LOOPBACK RUNNING  MTU:65536  Metric:1        RX packets:0 errors:0 dropped:0 overruns:0 frame:0        TX packets:0 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:1000         RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)root@ubuntu-1604:~#</code></pre><p>可以看到容器内部也可以使用这块网卡了，接着为此网卡配置一个静态 IP，看看从外部是否可以直接访问：</p><pre><code>root@ubuntu-1604:~# ifconfig ens35 10.0.1.11/24root@ubuntu-1604:~#</code></pre><p>需要注意的是，这个 IP 必须是此物理网卡所在网段的 IP 才可以。在 Windows 下直接访问容器：</p><pre><code>Microsoft Windows [版本 10.0.18362.356](c) 2019 Microsoft Corporation。保留所有权利。C:\Users\yunfwe\Desktop&gt;ssh root@10.0.1.11The authenticity of host &apos;10.0.1.11 (10.0.1.11)&apos; can&apos;t be established.ECDSA key fingerprint is SHA256:WGzRElNn4jypkZLIwVzDcqbDDi7vqCb29UyAPbC8Oqs.Are you sure you want to continue connecting (yes/no)? yesWarning: Permanently added &apos;10.0.1.11&apos; (ECDSA) to the list of known hosts.root@10.0.1.11&apos;s password:Welcome to Ubuntu 16.04.6 LTS (GNU/Linux 4.15.0-58-generic x86_64)* Documentation:  https://help.ubuntu.com* Management:     https://landscape.canonical.com* Support:        https://ubuntu.com/advantageLast login: Wed Sep 25 01:58:44 2019root@ubuntu-1604:~#</code></pre><h5 id="桥接物理网卡"><a href="#桥接物理网卡" class="headerlink" title="桥接物理网卡"></a>桥接物理网卡</h5><p>直接分配物理网卡虽然实现了在外部直接访问宿主机内部的容器了，但是显然太浪费资源，每一个容器都要分配一个物理网卡。我们可以在宿主机创建一个网桥，然后将物理网卡接入到网桥内，之后再将容器的虚拟网卡也接入到网桥，这样就可以实现桥接模式了。</p><p>首先删除之前为容器分配物理网卡的配置项并重启容器，然后在宿主机上新增网桥，并将第二块物理网卡加入到网桥中。</p><p>宿主机执行：</p><pre><code>root@localhost:~# brctl addbr netbr0 root@localhost:~# brctl addif netbr0 ens35root@localhost:~# ifconfig netbr0 uproot@localhost:~# ifconfig ens35 uproot@localhost:~# brctl showbridge name    bridge id        STP enabled    interfaceslxcbr0        8000.00163e000000    no        vethA75TNV                                        vethWL2CSXnetbr0        8000.000c2995b47b    no        ens35root@localhost:~#</code></pre><p>lxcbr0 是 LXC 自动帮我们创建的网桥，网桥内已经有两个接口，对端便是两个容器的 eth0 网卡。接下来我们可以重新创建一个容器，然后将容器配置文件中的 <code>lxc.net.0.link</code> 改为我们新创建的网桥，或者在现有的容器中新增一块虚拟网卡，然后连接到网桥上。</p><p>修改容器配置文件，新增如下配置：</p><pre><code>lxc.net.1.type = vethlxc.net.1.link = netbr0lxc.net.1.flags = up</code></pre><p>重启此容器并查看 netbr0 网桥已经有多少个接口：</p><pre><code>root@localhost:~# lxc-stop ubuntu-1604 &amp;&amp; lxc-start ubuntu-1604root@localhost:~# brctl showbridge name    bridge id        STP enabled    interfaceslxcbr0        8000.00163e000000    no        vethA75TNV                                        vethGHBNA6netbr0        8000.000c2995b47b    no        ens35                                        veth479Q5Droot@localhost:~#</code></pre><p>为容器内接口分配 IP 并远程连接：</p><pre><code>root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# ifconfig eth1 10.0.1.11/24root@ubuntu-1604:~# ifconfig eth1eth1      Link encap:Ethernet  HWaddr 66:15:70:46:7e:bf          inet addr:10.0.1.11  Bcast:10.0.1.255  Mask:255.255.255.0        inet6 addr: fe80::6415:70ff:fe46:7ebf/64 Scope:Link        UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1        RX packets:44 errors:0 dropped:0 overruns:0 frame:0        TX packets:22 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:1000         RX bytes:4625 (4.6 KB)  TX bytes:1588 (1.5 KB)root@ubuntu-1604:~#</code></pre><p>Windows 上远程连接成功：</p><pre><code>C:\Users\yunfwe\Desktop&gt;ssh root@10.0.1.11root@10.0.1.11&apos;s password:Welcome to Ubuntu 16.04.6 LTS (GNU/Linux 4.15.0-58-generic x86_64)* Documentation:  https://help.ubuntu.com* Management:     https://landscape.canonical.com* Support:        https://ubuntu.com/advantageLast login: Thu Sep 26 03:01:21 2019 from 10.0.1.1root@ubuntu-1604:~#</code></pre><p>当前网桥的配置是临时生效的，如果需要开机自动配置 还请查看你当前所使用的发行版的网络管理器如何配置网桥。</p><h4 id="设备管理"><a href="#设备管理" class="headerlink" title="设备管理"></a>设备管理</h4><p>LXC 提供了 <code>lxc-device</code> 命令将宿主机的硬件设备直接分配给容器。其实运用到的技术是 cgroup 的设备白名单和在容器内创建设备相应的设备文件。</p><p><code>lxc-device</code> 命令的使用非常简单，使用 <code>add</code> 直接指定要将宿主机 <code>/dev</code> 目录下的哪个设备分配给容器就可以了，删除可以使用 <code>del</code></p><h5 id="分配硬盘分区到容器"><a href="#分配硬盘分区到容器" class="headerlink" title="分配硬盘分区到容器"></a>分配硬盘分区到容器</h5><p>宿主机执行：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lxc-device ubuntu-1604 add /dev/sda2</span><br></pre></td></tr></table></figure><p>容器内查看：</p><pre><code>root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# ls /dev/sda2 /dev/sda2root@ubuntu-1604:~# mount /dev/sda2 /mnt/root@ubuntu-1604:~# ls /mnt/bin   cdrom  etc   initrd.img      lib    lost+found  mnt  proc  run   snap  swap.img  tmp  var      vmlinuz.oldboot  dev    home  initrd.img.old  lib64  media       opt  root  sbin  srv   sys       usr  vmlinuzroot@ubuntu-1604:~#</code></pre><h5 id="分配-tunnel-设备到容器"><a href="#分配-tunnel-设备到容器" class="headerlink" title="分配 tunnel 设备到容器"></a>分配 tunnel 设备到容器</h5><p>默认在容器内是没有 <code>/dev/net/tun</code> 设备文件的，因此一大部分的 VPN 应用都无法在容器内正常运行。利用 <code>lxc-device</code> 命令可以很方便的将 tunnel 设备分配给容器：<code>lxc-device ubuntu-1604 add /dev/net/tun</code>，但是用这种方法在容器重启后分配的设备文件将失效。</p><p>我们可以在配置文件中指定容器允许的设备文件白名单，容器在启动过程中会默认分配一些设备文件，在容器的配置文件中有一行是 <code>lxc.include = /usr/share/lxc/config/common.conf</code> 打开此文件，可以看到这些默认会创建的设备文件：</p><pre><code>## Allow specific devices### /dev/nulllxc.cgroup.devices.allow = c 1:3 rwm### /dev/zerolxc.cgroup.devices.allow = c 1:5 rwm### /dev/fulllxc.cgroup.devices.allow = c 1:7 rwm### /dev/ttylxc.cgroup.devices.allow = c 5:0 rwm### /dev/consolelxc.cgroup.devices.allow = c 5:1 rwm### /dev/ptmxlxc.cgroup.devices.allow = c 5:2 rwm### /dev/randomlxc.cgroup.devices.allow = c 1:8 rwm### /dev/urandomlxc.cgroup.devices.allow = c 1:9 rwm### /dev/pts/*lxc.cgroup.devices.allow = c 136:* rwm### fuselxc.cgroup.devices.allow = c 10:229 rwm</code></pre><p>Linux tunnel 设备号是 <code>c 10 200</code>，如果我们需要在将来创建的容器都默认分配 tunnel 设备，可以直接修改 <code>/usr/share/lxc/config/common.conf</code>，否则只修改容器的配置文件即可：</p><p>容器配置文件最后添加以下内容：</p><pre><code>### tunnel lxc.cgroup.devices.allow = c 10:200 rwm</code></pre><p>现在只是允许了容器内使用 <code>/dev/net/tun</code> 设备，容器并不会自动创建此设备文件，我们可以在容器的 <code>/etc/rc.local</code> 中写入创建设备文件的命令来完成启动容器后自动创建。</p><p>编辑容器内的 <code>/etc/rc.local</code> 在最后的 <code>exit 0</code> 之前写入以下内容：</p><pre><code>mkdir /dev/net -pmknod /dev/net/tun c 10 200</code></pre><p>然后重启容器：</p><pre><code>root@localhost:~# lxc-stop ubuntu-1604 &amp;&amp; lxc-start ubuntu-1604root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# ls /dev/net/tun/dev/net/tunroot@ubuntu-1604:~#</code></pre><h4 id="目录挂载"><a href="#目录挂载" class="headerlink" title="目录挂载"></a>目录挂载</h4><p>如果想在多个容器内共享同一个目录，可以采用挂载宿主机同一目录的方式。</p><p>首先在宿主机创建一个目录用于容器见共享：</p><pre><code>root@localhost:~# mkdir /dataroot@localhost:~# echo hello &gt; /data/worldroot@localhost:~#</code></pre><p>修改容器配置文件，新增如下内容：</p><pre><code>lxc.mount.entry = /data data none rw,bind,create=dir 0 0</code></pre><p><code>lxc.mount.entry</code> 的写法跟 <code>/etc/fstab</code> 的写法一样，上面的内容就是将宿主机的 <code>/data</code> 目录挂载到容器内的 <code>/data</code> 目录，容器内的路径开头不可以写 <code>/</code> 否则会无法挂载。<code>rw,bind,create=dir</code> 是挂载选项，表示以读写方式挂载，如果容器内文件夹不存在则自动创建。</p><pre><code>root@localhost:~# lxc-stop ubuntu-1604 &amp;&amp; lxc-start ubuntu-1604root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# ls /dataworldroot@ubuntu-1604:~# cat /data/world helloroot@ubuntu-1604:~# </code></pre><p>我们还可以利用挂载的特性，将设备文件直接挂载到容器内，比如上面的 tunnel 设备文件还可以用以下方式自动挂载：</p><pre><code>lxc.mount.entry = /dev/net/tun dev/net/tun none rw,bind,create=file 0 0</code></pre><h4 id="容器权限"><a href="#容器权限" class="headerlink" title="容器权限"></a>容器权限</h4><p>在 Linux2.2 内核开始将超级用户的权限分为若干独立的子权限，每个子权限可独立的禁止或者打开，注意，一旦剥夺了根用户的某一权限，那么除非重启系统，否则无法恢复该权限。下面对这些权限进行简单的介绍： </p><ul><li><code>CAP_CHOWN</code>：允许改变文件的所有权 </li><li><code>CAP_DAC_OVERRIDE</code>：忽略对文件的所有 DAC 访问限制 </li><li><code>CAP_DAC_READ_SEARCH</code>：忽略所有对读、搜索操作的限制 </li><li><code>CAP_FOWNER</code>：如果文件属于进程的 UID，就取消对文件的限制 </li><li><code>CAP_FSETID</code>：允许设置 setuid 位 </li><li><code>CAP_KILL</code>：允许对不属于自己的进程发送信号 </li><li><code>CAP_SETGID</code>：允许改变组 ID </li><li><code>CAP_SETUID</code>：允许改变用户 ID </li><li><code>CAP_SETPCAP</code>：允许向其它进程转移能力以及删除其它进程的任意能力 </li><li><code>CAP_LINUX_IMMUTABLE</code>：允许修改文件的不可修改 (IMMUTABLE) 和只添加 (APPEND-ONLY) 属性 </li><li><code>CAP_NET_BIND_SERVICE</code>： 允许绑定到小于 1024 的端口 </li><li><code>CAP_NET_BROADCAST</code>：允许网络广播和多播访问 </li><li><code>CAP_NET_ADMIN</code>：允许执行网络管理任务：接口、防火墙和路由等。 </li><li><code>CAP_NET_RAW</code>：允许使用原始 (raw) 套接字 </li><li><code>CAP_IPC_LOCK</code>：允许锁定共享内存片段 </li><li><code>CAP_IPC_OWNER</code>： 忽略 IPC 所有权检查 </li><li><code>CAP_SYS_MODULE</code>： 插入和删除内核模块 </li><li><code>CAP_SYS_RAWIO</code>：允许对 ioperm/iopl 的访问 </li><li><code>CAP_SYS_CHROOT</code>：允许使用 chroot() 系统调用 </li><li><code>CAP_SYS_PTRACE</code>：允许跟踪任何进程 </li><li><code>CAP_SYS_PACCT</code>：允许配置进程记帐 (process accounting) </li><li><code>CAP_SYS_ADMIN</code>：允许执行系统管理任务：加载/卸载文件系统、设置磁盘配额、开/关交换设备和文件等。 </li><li><code>CAP_SYS_BOOT</code>：允许重新启动系统 </li><li><code>CAP_SYS_NICE</code>：允许提升优先级，设置其它进程的优先级 </li><li><code>CAP_SYS_RESOURCE</code>：忽略资源限制 </li><li><code>CAP_SYS_TIME</code>：允许改变系统时钟 </li><li><code>CAP_SYS_TTY_CONFIG</code>：允许配置 TTY 设备 </li><li><code>CAP_MKNOD</code>：允许使用 mknod() 系统调用 </li><li><code>CAP_LEASE</code>：Allow taking of leases on files </li></ul><p>容器的配置文件提供了 <code>lxc.cap.drop</code> 来允许我们运行的容器抛弃某些权限，例如我们要抛弃容器的创建设备文件和更改 IP 地址的权限，追加以下配置到容器的配置文件：</p><pre><code>lxc.cap.drop =  mknod net_admin</code></pre><p>权限的名称不需要写开头的 <code>CAP_</code> 使用小写即可，接着重启容器：</p><pre><code>root@localhost:~# lxc-stop ubuntu-1604 &amp;&amp; lxc-start ubuntu-1604root@localhost:~# lxc-attach ubuntu-1604root@ubuntu-1604:~# ifconfig eth1 10.0.1.11/24SIOCSIFADDR: Operation not permittedSIOCSIFFLAGS: Operation not permittedSIOCSIFNETMASK: Operation not permittedroot@ubuntu-1604:~# mknod test c 10 200mknod: test: Operation not permittedroot@ubuntu-1604:~#</code></pre><h4 id="容器开机自启"><a href="#容器开机自启" class="headerlink" title="容器开机自启"></a>容器开机自启</h4><p>容器默认在系统启动时不会自动启动，但是提供了 <code>lxc-autostart</code> 命令来帮我们启动所有设置了开机自启的容器。 我们可以在容器的配置文件中添加以下内容来让容器自启动：</p><pre><code>lxc.start.auto = 1lxc.start.delay = 10lxc.group = onboot</code></pre><p><code>lxc.start.auto</code> 表示允许自启。<code>lxc.start.delay</code> 表示启动延迟，在处理互相依赖的容器中，启动延迟会比较有用。<code>lxc.group</code> 表示定义启动组，这样就可以通过 <code>lxc-autostart -g onboot</code> 来启动所有属于 <code>onboot</code> 组的容器了。</p><p>当设置好容器开机自启动后，将 <code>lxc-autostart</code> 命令添加到宿主机的 <code>/etc/rc.local</code> 中，这样就可以实现开机时自动启动容器了。</p><h4 id="容器备份"><a href="#容器备份" class="headerlink" title="容器备份"></a>容器备份</h4><p>可以在停掉或冻结要备份的容器后直接对 <code>/var/lib/lxc/</code> 下的容器目录进行归档备份，如果想克隆容器，直接将容器目录复制一份，然后改下复制后的容器配置文件中的网卡配置相关冲突的地方即可。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>LXC 工具集的使用上还是比较原始简单，还有个更好用的 LXC 管理工具：LXD。该工具类似于 Docker，启动一个守护进程，然后通过 <code>lxc</code> 命令对容器和镜像进行管理，并提供了更灵活的配置和更完善的官方文档。还有容器快照、热迁移等高级功能。</p><ul><li>LXD官方文档：<a href="https://lxd.readthedocs.io/en/latest/" target="_blank" rel="noopener">https://lxd.readthedocs.io/en/latest/</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;LXC 是 Linux Container 的简写。Linux Container 是一种内核虚拟化技术，可以提供轻量级的虚拟化以便隔离进程和资源。大名鼎鼎的 Docker 在早期版本使用的底层容器引擎便是 LXC，不过 Docker 的目标是创建应用级容器，而 LXC 的目标是创建系统级容器，所以使用 LXC 更容易获得接近虚拟机的体验。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="http://www.yunfwe.cn/categories/Linux/"/>
    
    
      <category term="linux" scheme="http://www.yunfwe.cn/tags/linux/"/>
    
      <category term="lxc" scheme="http://www.yunfwe.cn/tags/lxc/"/>
    
  </entry>
  
  <entry>
    <title>Supervisor 进程管理工具</title>
    <link href="http://www.yunfwe.cn/2019/08/27/2019/Supervisor%20%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/"/>
    <id>http://www.yunfwe.cn/2019/08/27/2019/Supervisor%20%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7/</id>
    <published>2019-08-27T02:12:00.000Z</published>
    <updated>2019-09-02T16:04:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Supervisor 是用 Python 开发的一个 C/S 架构的进程管理工具，只可以用 Linux/Unix 系统下。在 Linux 系统上，通常的做法是为每个需要控制的服务编写 rc.d 脚本，之后通过 service 或者 systemctl 来管理和控制服务，但是在程序崩溃的时候却无法自动重启项目。Supervisor 将它管理的服务作为它的子进程，所以可以简单且精确的管理和控制这些服务。<a href="http://www.supervisord.org/" target="_blank" rel="noopener">官方文档</a></p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><blockquote><p>Supervisor 仅支持 Linux/Unix 系统，推荐使用 Python 2.7 或 Python 3.4 之上的版本来运行 Supervisor。</p></blockquote><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><table><thead><tr><th>系统类型</th><th>发行商</th><th>版本号</th></tr></thead><tbody><tr><td>Linux</td><td>Ubuntu</td><td>18.04.3</td></tr></tbody></table><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h3><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>Python</td><td>3.6.8</td></tr><tr><td>Supervisor</td><td>4.0.4</td></tr></tbody></table><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>Ubuntu 可以直接通过 <code>apt install supervisor</code> 进行安装，但是这样安装的版本不会是最新版，并且还会安装一些其他依赖。这里选择适用性更广的虚拟环境来安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apt install python3-venv -y     <span class="comment"># 安装 python3 虚拟环境库</span></span><br><span class="line">mkdir -p /data/venv             <span class="comment"># 创建一个目录供放置虚拟环境</span></span><br><span class="line"><span class="built_in">cd</span> /data/venv</span><br><span class="line">python3 -m venv supervisor      <span class="comment"># 创建一个叫 supervisor 的虚拟环境</span></span><br><span class="line"><span class="built_in">source</span> /data/venv/supervisor/bin/activate</span><br><span class="line">pip install supervisor</span><br></pre></td></tr></table></figure><p>安装好之后，执行 <code>supervisord -v</code> 可以看到当前安装的版本号。</p><pre><code>(supervisor) root@ubuntu:/data/venv# supervisord -v4.0.4(supervisor) root@ubuntu:/data/venv#</code></pre><h3 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h3><blockquote><p>接下来演示 Supervisor 最基本的使用</p></blockquote><h4 id="提供一个配置文件"><a href="#提供一个配置文件" class="headerlink" title="提供一个配置文件"></a>提供一个配置文件</h4><p>Supervisor 会首先在当前目录查找 <code>supervisord.conf</code>，如果没有找到 则会使用 <code>/etc/supervisord.conf</code>，如果此文件依然不存在，则会使用程序内置的配置。或者，我们可以用 <code>-c</code> 参数，来为 supervisor 指明一个配置文件。为了让进程运行的更清晰，建议通过 <code>-c</code> 参数来指明配置文件。</p><p>接下来就是提供一个配置文件给 supervisor。supervisor 提供了一个 <code>echo_supervisord_conf</code> 的命令，此命令的执行会打印一个 supervisor 的模板示例。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf</span><br></pre></td></tr></table></figure><p>以下是打印的配置文件示例内容：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">; Sample supervisor config file.</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; For more information on the config file, please see:</span></span><br><span class="line"><span class="comment">; http://supervisord.org/configuration.html</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Notes:</span></span><br><span class="line"><span class="comment">;  - Shell expansion ("~" or "$HOME") is not supported.  Environment</span></span><br><span class="line"><span class="comment">;    variables can be expanded using this syntax: "%(ENV_HOME)s".</span></span><br><span class="line"><span class="comment">;  - Quotes around values are not supported, except in the case of</span></span><br><span class="line"><span class="comment">;    the environment= options as shown below.</span></span><br><span class="line"><span class="comment">;  - Comments must have a leading space: "a=b ;comment" not "a=b;comment".</span></span><br><span class="line"><span class="comment">;  - Command will be truncated if it looks like a config file comment, e.g.</span></span><br><span class="line"><span class="comment">;    "command=bash -c 'foo ; bar'" will truncate to "command=bash -c 'foo ".</span></span><br><span class="line"><span class="comment">;</span></span><br><span class="line"><span class="comment">; Warning:</span></span><br><span class="line"><span class="comment">;  Paths throughout this example file use /tmp because it is available on most</span></span><br><span class="line"><span class="comment">;  systems.  You will likely need to change these to locations more appropriate</span></span><br><span class="line"><span class="comment">;  for your system.  Some systems periodically delete older files in /tmp.</span></span><br><span class="line"><span class="comment">;  Notably, if the socket file defined in the [unix_http_server] section below</span></span><br><span class="line"><span class="comment">;  is deleted, supervisorctl will be unable to connect to supervisord.</span></span><br><span class="line"></span><br><span class="line"><span class="section">[unix_http_server]</span></span><br><span class="line"><span class="attr">file</span>=/tmp/supervisor.sock   <span class="comment">; the path to the socket file</span></span><br><span class="line"><span class="comment">;chmod=0700                 ; socket file mode (default 0700)</span></span><br><span class="line"><span class="comment">;chown=nobody:nogroup       ; socket file uid:gid owner</span></span><br><span class="line"><span class="comment">;username=user              ; default is no username (open server)</span></span><br><span class="line"><span class="comment">;password=123               ; default is no password (open server)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; Security Warning:</span></span><br><span class="line"><span class="comment">;  The inet HTTP server is not enabled by default.  The inet HTTP server is</span></span><br><span class="line"><span class="comment">;  enabled by uncommenting the [inet_http_server] section below.  The inet</span></span><br><span class="line"><span class="comment">;  HTTP server is intended for use within a trusted environment only.  It</span></span><br><span class="line"><span class="comment">;  should only be bound to localhost or only accessible from within an</span></span><br><span class="line"><span class="comment">;  isolated, trusted network.  The inet HTTP server does not support any</span></span><br><span class="line"><span class="comment">;  form of encryption.  The inet HTTP server does not use authentication</span></span><br><span class="line"><span class="comment">;  by default (see the username= and password= options to add authentication).</span></span><br><span class="line"><span class="comment">;  Never expose the inet HTTP server to the public internet.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;[inet_http_server]         ; inet (TCP) server disabled by default</span></span><br><span class="line"><span class="comment">;port=127.0.0.1:9001        ; ip_address:port specifier, *:port for all iface</span></span><br><span class="line"><span class="comment">;username=user              ; default is no username (open server)</span></span><br><span class="line"><span class="comment">;password=123               ; default is no password (open server)</span></span><br><span class="line"></span><br><span class="line"><span class="section">[supervisord]</span></span><br><span class="line"><span class="attr">logfile</span>=/tmp/supervisord.log <span class="comment">; main log file; default $CWD/supervisord.log</span></span><br><span class="line"><span class="attr">logfile_maxbytes</span>=<span class="number">50</span>MB        <span class="comment">; max main logfile bytes b4 rotation; default 50MB</span></span><br><span class="line"><span class="attr">logfile_backups</span>=<span class="number">10</span>           <span class="comment">; # of main logfile backups; 0 means none, default 10</span></span><br><span class="line"><span class="attr">loglevel</span>=info                <span class="comment">; log level; default info; others: debug,warn,trace</span></span><br><span class="line"><span class="attr">pidfile</span>=/tmp/supervisord.pid <span class="comment">; supervisord pidfile; default supervisord.pid</span></span><br><span class="line"><span class="attr">nodaemon</span>=<span class="literal">false</span>               <span class="comment">; start in foreground if true; default false</span></span><br><span class="line"><span class="attr">minfds</span>=<span class="number">1024</span>                  <span class="comment">; min. avail startup file descriptors; default 1024</span></span><br><span class="line"><span class="attr">minprocs</span>=<span class="number">200</span>                 <span class="comment">; min. avail process descriptors;default 200</span></span><br><span class="line"><span class="comment">;umask=022                   ; process file creation umask; default 022</span></span><br><span class="line"><span class="comment">;user=supervisord            ; setuid to this UNIX account at startup; recommended if root</span></span><br><span class="line"><span class="comment">;identifier=supervisor       ; supervisord identifier, default is 'supervisor'</span></span><br><span class="line"><span class="comment">;directory=/tmp              ; default is not to cd during start</span></span><br><span class="line"><span class="comment">;nocleanup=true              ; don't clean up tempfiles at start; default false</span></span><br><span class="line"><span class="comment">;childlogdir=/tmp            ; 'AUTO' child log dir, default $TEMP</span></span><br><span class="line"><span class="comment">;environment=KEY="value"     ; key value pairs to add to environment</span></span><br><span class="line"><span class="comment">;strip_ansi=false            ; strip ansi escape codes in logs; def. false</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The rpcinterface:supervisor section must remain in the config file for</span></span><br><span class="line"><span class="comment">; RPC (supervisorctl/web interface) to work.  Additional interfaces may be</span></span><br><span class="line"><span class="comment">; added by defining them in separate [rpcinterface:x] sections.</span></span><br><span class="line"></span><br><span class="line"><span class="section">[rpcinterface:supervisor]</span></span><br><span class="line"><span class="attr">supervisor.rpcinterface_factory</span> = supervisor.rpcinterface:make_main_rpcinterface</span><br><span class="line"></span><br><span class="line"><span class="comment">; The supervisorctl section configures how supervisorctl will connect to</span></span><br><span class="line"><span class="comment">; supervisord.  configure it match the settings in either the unix_http_server</span></span><br><span class="line"><span class="comment">; or inet_http_server section.</span></span><br><span class="line"></span><br><span class="line"><span class="section">[supervisorctl]</span></span><br><span class="line"><span class="attr">serverurl</span>=unix:///tmp/supervisor.sock <span class="comment">; use a unix:// URL  for a unix socket</span></span><br><span class="line"><span class="comment">;serverurl=http://127.0.0.1:9001 ; use an http:// url to specify an inet socket</span></span><br><span class="line"><span class="comment">;username=chris              ; should be same as in [*_http_server] if set</span></span><br><span class="line"><span class="comment">;password=123                ; should be same as in [*_http_server] if set</span></span><br><span class="line"><span class="comment">;prompt=mysupervisor         ; cmd line prompt (default "supervisor")</span></span><br><span class="line"><span class="comment">;history_file=~/.sc_history  ; use readline history if available</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The sample program section below shows all possible program subsection values.</span></span><br><span class="line"><span class="comment">; Create one or more 'real' program: sections to be able to control them under</span></span><br><span class="line"><span class="comment">; supervisor.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;[program:theprogramname]</span></span><br><span class="line"><span class="comment">;command=/bin/cat              ; the program (relative uses PATH, can take args)</span></span><br><span class="line"><span class="comment">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)</span></span><br><span class="line"><span class="comment">;numprocs=1                    ; number of processes copies to start (def 1)</span></span><br><span class="line"><span class="comment">;directory=/tmp                ; directory to cwd to before exec (def no cwd)</span></span><br><span class="line"><span class="comment">;umask=022                     ; umask for process (default None)</span></span><br><span class="line"><span class="comment">;priority=999                  ; the relative start priority (default 999)</span></span><br><span class="line"><span class="comment">;autostart=true                ; start at supervisord start (default: true)</span></span><br><span class="line"><span class="comment">;startsecs=1                   ; # of secs prog must stay up to be running (def. 1)</span></span><br><span class="line"><span class="comment">;startretries=3                ; max # of serial start failures when starting (default 3)</span></span><br><span class="line"><span class="comment">;autorestart=unexpected        ; when to restart if exited after running (def: unexpected)</span></span><br><span class="line"><span class="comment">;exitcodes=0                   ; 'expected' exit codes used with autorestart (default 0)</span></span><br><span class="line"><span class="comment">;stopsignal=QUIT               ; signal used to kill process (default TERM)</span></span><br><span class="line"><span class="comment">;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)</span></span><br><span class="line"><span class="comment">;stopasgroup=false             ; send stop signal to the UNIX process group (default false)</span></span><br><span class="line"><span class="comment">;killasgroup=false             ; SIGKILL the UNIX process group (def false)</span></span><br><span class="line"><span class="comment">;user=chrism                   ; setuid to this UNIX account to run the program</span></span><br><span class="line"><span class="comment">;redirect_stderr=true          ; redirect proc stderr to stdout (default false)</span></span><br><span class="line"><span class="comment">;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO</span></span><br><span class="line"><span class="comment">;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span></span><br><span class="line"><span class="comment">;stdout_logfile_backups=10     ; # of stdout logfile backups (0 means none, default 10)</span></span><br><span class="line"><span class="comment">;stdout_capture_maxbytes=1MB   ; number of bytes in 'capturemode' (default 0)</span></span><br><span class="line"><span class="comment">;stdout_events_enabled=false   ; emit events on stdout writes (default false)</span></span><br><span class="line"><span class="comment">;stdout_syslog=false           ; send stdout to syslog with process name (default false)</span></span><br><span class="line"><span class="comment">;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO</span></span><br><span class="line"><span class="comment">;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span></span><br><span class="line"><span class="comment">;stderr_logfile_backups=10     ; # of stderr logfile backups (0 means none, default 10)</span></span><br><span class="line"><span class="comment">;stderr_capture_maxbytes=1MB   ; number of bytes in 'capturemode' (default 0)</span></span><br><span class="line"><span class="comment">;stderr_events_enabled=false   ; emit events on stderr writes (default false)</span></span><br><span class="line"><span class="comment">;stderr_syslog=false           ; send stderr to syslog with process name (default false)</span></span><br><span class="line"><span class="comment">;environment=A="1",B="2"       ; process environment additions (def no adds)</span></span><br><span class="line"><span class="comment">;serverurl=AUTO                ; override serverurl computation (childutils)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The sample eventlistener section below shows all possible eventlistener</span></span><br><span class="line"><span class="comment">; subsection values.  Create one or more 'real' eventlistener: sections to be</span></span><br><span class="line"><span class="comment">; able to handle event notifications sent by supervisord.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;[eventlistener:theeventlistenername]</span></span><br><span class="line"><span class="comment">;command=/bin/eventlistener    ; the program (relative uses PATH, can take args)</span></span><br><span class="line"><span class="comment">;process_name=%(program_name)s ; process_name expr (default %(program_name)s)</span></span><br><span class="line"><span class="comment">;numprocs=1                    ; number of processes copies to start (def 1)</span></span><br><span class="line"><span class="comment">;events=EVENT                  ; event notif. types to subscribe to (req'd)</span></span><br><span class="line"><span class="comment">;buffer_size=10                ; event buffer queue size (default 10)</span></span><br><span class="line"><span class="comment">;directory=/tmp                ; directory to cwd to before exec (def no cwd)</span></span><br><span class="line"><span class="comment">;umask=022                     ; umask for process (default None)</span></span><br><span class="line"><span class="comment">;priority=-1                   ; the relative start priority (default -1)</span></span><br><span class="line"><span class="comment">;autostart=true                ; start at supervisord start (default: true)</span></span><br><span class="line"><span class="comment">;startsecs=1                   ; # of secs prog must stay up to be running (def. 1)</span></span><br><span class="line"><span class="comment">;startretries=3                ; max # of serial start failures when starting (default 3)</span></span><br><span class="line"><span class="comment">;autorestart=unexpected        ; autorestart if exited after running (def: unexpected)</span></span><br><span class="line"><span class="comment">;exitcodes=0                   ; 'expected' exit codes used with autorestart (default 0)</span></span><br><span class="line"><span class="comment">;stopsignal=QUIT               ; signal used to kill process (default TERM)</span></span><br><span class="line"><span class="comment">;stopwaitsecs=10               ; max num secs to wait b4 SIGKILL (default 10)</span></span><br><span class="line"><span class="comment">;stopasgroup=false             ; send stop signal to the UNIX process group (default false)</span></span><br><span class="line"><span class="comment">;killasgroup=false             ; SIGKILL the UNIX process group (def false)</span></span><br><span class="line"><span class="comment">;user=chrism                   ; setuid to this UNIX account to run the program</span></span><br><span class="line"><span class="comment">;redirect_stderr=false         ; redirect_stderr=true is not allowed for eventlisteners</span></span><br><span class="line"><span class="comment">;stdout_logfile=/a/path        ; stdout log path, NONE for none; default AUTO</span></span><br><span class="line"><span class="comment">;stdout_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span></span><br><span class="line"><span class="comment">;stdout_logfile_backups=10     ; # of stdout logfile backups (0 means none, default 10)</span></span><br><span class="line"><span class="comment">;stdout_events_enabled=false   ; emit events on stdout writes (default false)</span></span><br><span class="line"><span class="comment">;stdout_syslog=false           ; send stdout to syslog with process name (default false)</span></span><br><span class="line"><span class="comment">;stderr_logfile=/a/path        ; stderr log path, NONE for none; default AUTO</span></span><br><span class="line"><span class="comment">;stderr_logfile_maxbytes=1MB   ; max # logfile bytes b4 rotation (default 50MB)</span></span><br><span class="line"><span class="comment">;stderr_logfile_backups=10     ; # of stderr logfile backups (0 means none, default 10)</span></span><br><span class="line"><span class="comment">;stderr_events_enabled=false   ; emit events on stderr writes (default false)</span></span><br><span class="line"><span class="comment">;stderr_syslog=false           ; send stderr to syslog with process name (default false)</span></span><br><span class="line"><span class="comment">;environment=A="1",B="2"       ; process environment additions</span></span><br><span class="line"><span class="comment">;serverurl=AUTO                ; override serverurl computation (childutils)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The sample group section below shows all possible group values.  Create one</span></span><br><span class="line"><span class="comment">; or more 'real' group: sections to create "heterogeneous" process groups.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;[group:thegroupname]</span></span><br><span class="line"><span class="comment">;programs=progname1,progname2  ; each refers to 'x' in [program:x] definitions</span></span><br><span class="line"><span class="comment">;priority=999                  ; the relative start priority (default 999)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">; The [include] section can just contain the "files" setting.  This</span></span><br><span class="line"><span class="comment">; setting can list multiple files (separated by whitespace or</span></span><br><span class="line"><span class="comment">; newlines).  It can also contain wildcards.  The filenames are</span></span><br><span class="line"><span class="comment">; interpreted as relative to this file.  Included files *cannot*</span></span><br><span class="line"><span class="comment">; include files themselves.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">;[include]</span></span><br><span class="line"><span class="comment">;files = relative/directory/*.ini</span></span><br></pre></td></tr></table></figure></div></div><p>为了方便查看配置，这里只写入没有被注释掉的配置项到配置文件：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo_supervisord_conf |grep -v <span class="string">'^;'</span> |uniq &gt; /etc/supervisord.conf</span><br><span class="line">cat /etc/supervisord.conf</span><br></pre></td></tr></table></figure><p>以下是配置文件内容：</p><pre><code>[unix_http_server]file=/tmp/supervisor.sock   ; the path to the socket file[supervisord]logfile=/tmp/supervisord.log ; main log file; default $CWD/supervisord.loglogfile_maxbytes=50MB        ; max main logfile bytes b4 rotation; default 50MBlogfile_backups=10           ; # of main logfile backups; 0 means none, default 10loglevel=info                ; log level; default info; others: debug,warn,tracepidfile=/tmp/supervisord.pid ; supervisord pidfile; default supervisord.pidnodaemon=false               ; start in foreground if true; default falseminfds=1024                  ; min. avail startup file descriptors; default 1024minprocs=200                 ; min. avail process descriptors;default 200[rpcinterface:supervisor]supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface[supervisorctl]serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket</code></pre><h4 id="启动-Supervisord"><a href="#启动-Supervisord" class="headerlink" title="启动 Supervisord"></a>启动 Supervisord</h4><p>如果已经进入 supervisor 的虚拟环境，可以直接使用 supervisord 命令启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure><p>或者没有进入虚拟环境的话，可以使用 supervisord 命令的绝对路径启动：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/data/venv/supervisor/bin/supervisord -c /etc/supervisord.conf</span><br></pre></td></tr></table></figure><p>可以看到 supervisord 已经运行起来了：</p><pre><code>(supervisor) root@ubuntu:~# pgrep supervisord 1990(supervisor) root@ubuntu:~# ls /tmp/supervisor.sock  supervisord.log  supervisord.pid(supervisor) root@ubuntu:~#</code></pre><h4 id="管理一个进程"><a href="#管理一个进程" class="headerlink" title="管理一个进程"></a>管理一个进程</h4><p>接下来为 supervisor 添加被它管理的第一个进程。将下面配置项追加到 <code>/etc/supervisord.conf</code>：</p><pre><code>[program:pyhttp]command=/usr/bin/python3 -m http.server 8080directory=/tmp/stdout_logfile=/tmp/pyhttp.logautostart=trueautorestart=true</code></pre><p>接着执行 <code>supervisorctl</code> 命令，这个命令是 <code>supervisord</code> 的命令行管理工具，也就是 C/S 架构中的 C 了。进入 supervisorctl 交互命令行后，执行 <code>update</code> 命令会通知 supervisord 进程更新进程管理相关的配置项，这样刚才添加的配置项就生效了：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl -c /etc/supervisord.confsupervisor&gt; updatepyhttp: added process groupsupervisor&gt; statuspyhttp                           RUNNING   pid 2107, uptime 0:00:11supervisor&gt;</code></pre><p>使用 <code>status</code> 命令可以查看当前被 <code>supervisord</code> 管理的所有进程状态，<code>exit</code> 命令可以退出交互模式。</p><p><strong>注意：</strong> 也可以直接使用 <code>supervisorctl update</code> 或者 <code>supervisorctl status</code> 来达到相同的效果而不需要进入 supervisorctl 的交互模式。<br>运行 supervisorctl 命令也应当指定 supervisord 所使用的配置文件。</p><h4 id="进程控制"><a href="#进程控制" class="headerlink" title="进程控制"></a>进程控制</h4><p>通过 <code>stop</code>、<code>start</code>、<code>restart</code> 命令可以对进程进行 <strong>停止</strong>、<strong>启动</strong>、<strong>重启</strong> 的操作：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl -c /etc/supervisord.confpyhttp                           RUNNING   pid 2107, uptime 0:09:31supervisor&gt; stop pyhttp pyhttp: stoppedsupervisor&gt; statuspyhttp                           STOPPED   Aug 28 06:00 AMsupervisor&gt; start pyhttppyhttp: startedsupervisor&gt; restart pyhttppyhttp: stoppedpyhttp: startedsupervisor&gt; statuspyhttp                           RUNNING   pid 2135, uptime 0:00:03supervisor&gt; </code></pre><h4 id="停止-Supervisord"><a href="#停止-Supervisord" class="headerlink" title="停止 Supervisord"></a>停止 Supervisord</h4><p>在停止 supervisord 进程前，我们应该先停止 supervisord 管理的所有子进程，以免造成 supervisord 停止后，子进程没有主动停止被 init 进程接管的现象。下面演示下强制杀掉 supervisord 进程后造成子进程逃逸的现象：</p><pre><code>(supervisor) root@ubuntu:~# netstat -anpt |grep python3tcp    0    0 0.0.0.0:8080      0.0.0.0:*       LISTEN    2221/python3        (supervisor) root@ubuntu:~# pgrep supervisord 2191(supervisor) root@ubuntu:~# cat /proc/2221/status |grep PPidPPid:    2191(supervisor) root@ubuntu:~# kill -9 2191(supervisor) root@ubuntu:~# pgrep supervisord (supervisor) root@ubuntu:~# cat /proc/2221/status |grep PPidPPid:    1(supervisor) root@ubuntu:~# </code></pre><p>supervisor 提供了安全的方式关闭 supervisord 进程，在 supervisorctl 中使用 <code>shutdown</code> 命令即可：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl -c /etc/supervisord.confpyhttp                           RUNNING   pid 2251, uptime 0:00:10supervisor&gt; shutdown Really shut the remote supervisord process down y/N? yShut downsupervisor&gt; statusunix:///tmp/supervisor.sock no such filesupervisor&gt; (supervisor) root@ubuntu:~# netstat -anpt |grep 8080(supervisor) root@ubuntu:~#</code></pre><h4 id="使用-Web-管理"><a href="#使用-Web-管理" class="headerlink" title="使用 Web 管理"></a>使用 Web 管理</h4><p>Supervisor 提供了一套简易的 Web 页面来远程管理进程，但是由于安全考虑默认是关闭的。将以下配置项加入配置文件则可以开启这个功能：</p><pre><code>[inet_http_server]port=0.0.0.0:9001username=adminpassword=123456</code></pre><p>服务监听在 <code>0.0.0.0:9001</code>，登录用户名为 <code>admin</code>，密码为 <code>123456</code>。接着重启 supervisord 进程：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -HUP `pgrep supervisord`</span><br></pre></td></tr></table></figure><p>向 supervisord 进程发送 <code>HUP</code> 信号会通知进程重新初始化，supervisord 会重新加载配置文件，已经启动的子进程会重启！还有一点需要注意，<code>pgrep</code> 命令会列出所有的 supervisord 进程，如果主机上正运行着多个 supervisord 实例，这会触发所有 supervisord 重新初始化！</p><pre><code>(supervisor) root@ubuntu:~# netstat -anpt |grep python3tcp    0   0 0.0.0.0:9001        0.0.0.0:*        LISTEN     2264/python3        tcp    0   0 0.0.0.0:8080        0.0.0.0:*        LISTEN     2644/python3        (supervisor) root@ubuntu:~# kill -HUP `pgrep supervisord`(supervisor) root@ubuntu:~# netstat -anpt |grep python3tcp    0   0 0.0.0.0:9001        0.0.0.0:*        LISTEN     2264/python3        tcp    0   0 0.0.0.0:8080        0.0.0.0:*        LISTEN     2650/python3    </code></pre><p>可以看到，当我又一次重启 supervisord 后，监听 8080 端口的 python3 进程的 PID 发生了变化，而 supervisord 的没有。</p><p>接着通过浏览器访问 supervisord 的 Web 页面：</p><p><img src="/uploads/2019/supervisor/w73siq9x9109l2qg.png" alt></p><p>我们可以通过 Web 页面对 supervisord 做一些简单的操作。</p><p><strong>注意：</strong> 生产环境请勿开启此项，会有安全隐患。</p><h3 id="命令行程序"><a href="#命令行程序" class="headerlink" title="命令行程序"></a>命令行程序</h3><blockquote><p>supervisor 安装完毕后会提供四个命令行工具：<code>supervisord</code>、<code>supervisorctl</code>、<code>echo_supervisord_conf</code>、<code>pidproxy</code>。下面对这些命令行工具进行详细说明。</p></blockquote><h4 id="supervisord"><a href="#supervisord" class="headerlink" title="supervisord"></a>supervisord</h4><h5 id="命令帮助"><a href="#命令帮助" class="headerlink" title="命令帮助"></a>命令帮助</h5><p>这个就是 supervisor 最重要的进程了，这个命令会在后台启动一个守护进程，对子进程的管理实际上就是通过这个进程。执行 <code>supervisord --help</code> 可以看到此命令的所有参数：</p><pre><code>(supervisor) root@ubuntu:~# supervisord --helpsupervisord -- run a set of applications as daemons.Usage: /data/venv/supervisor/bin/supervisord [options]Options:-c/--configuration FILENAME -- configuration file path (searches if not given)-n/--nodaemon -- run in the foreground (same as &apos;nodaemon=true&apos; in config file)-h/--help -- print this usage message and exit-v/--version -- print supervisord version number and exit-u/--user USER -- run supervisord as this user (or numeric uid)-m/--umask UMASK -- use this umask for daemon subprocess (default is 022)-d/--directory DIRECTORY -- directory to chdir to when daemonized-l/--logfile FILENAME -- use FILENAME as logfile path-y/--logfile_maxbytes BYTES -- use BYTES to limit the max size of logfile-z/--logfile_backups NUM -- number of backups to keep when max bytes reached-e/--loglevel LEVEL -- use LEVEL as log level (debug,info,warn,error,critical)-j/--pidfile FILENAME -- write a pid file for the daemon process to FILENAME-i/--identifier STR -- identifier used for this instance of supervisord-q/--childlogdir DIRECTORY -- the log directory for child process logs-k/--nocleanup --  prevent the process from performing cleanup (removal of                old automatic child log files) at startup.-a/--minfds NUM -- the minimum number of file descriptors for start success-t/--strip_ansi -- strip ansi escape codes from process output--minprocs NUM  -- the minimum number of processes available for start success--profile_options OPTIONS -- run supervisord under profiler and output                            results based on OPTIONS, which  is a comma-sep&apos;d                            list of &apos;cumulative&apos;, &apos;calls&apos;, and/or &apos;callers&apos;,                            e.g. &apos;cumulative,callers&apos;)(supervisor) root@ubuntu:~#</code></pre><p>由于我们几乎不会通过命令行参数来运行 supervisord，所以各个参数的含义都不再说明，只需要知道通过 <code>-c</code> 或者 <code>--configuration</code> 来指明 supervisord 的配置文件即可。</p><h5 id="信号处理"><a href="#信号处理" class="headerlink" title="信号处理"></a>信号处理</h5><p>当 supervisord 进程接收到不同的信号时，会有不同的反应，我们在外部还可以通过信号来控制 supervisord 的一些行为：</p><ul><li><code>SIGTERM</code>：这个信号也是 kill 命令默认的信号，supervisord 会关闭所有子进程，然后退出。这可能需要几秒钟的时间。</li><li><code>SIGINT</code>：相当于将 supervisord 的进程 <code>Ctrl-C</code> 掉，supervisord 的处理同对 <code>SIGTERM</code> 信号的处理。</li><li><code>SIGQUIT</code>：同对 <code>SIGTERM</code> 信号的处理。</li><li><code>SIGHUP</code>：supervisord 将停止所有进程，然后重新加载配置文件，并启动所有进程。</li><li><code>SIGUSR2</code>：supervisord 将关闭并重新打开主日志文件和子日志文件。</li></ul><h4 id="supervisorctl"><a href="#supervisorctl" class="headerlink" title="supervisorctl"></a>supervisorctl</h4><h5 id="命令帮助-1"><a href="#命令帮助-1" class="headerlink" title="命令帮助"></a>命令帮助</h5><p>这个命令是 supervisord 守护进程的命令行管理工具，我们大多时候都是通过这个命令来管理 supervisord 的。下面是这个命令的帮助：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl --helpsupervisorctl -- control applications run by supervisord from the cmd line.Usage: /data/venv/supervisor/bin/supervisorctl [options] [action [arguments]]Options:-c/--configuration FILENAME -- configuration file path (searches if not given)-h/--help -- print usage message and exit-i/--interactive -- start an interactive shell after executing commands-s/--serverurl URL -- URL on which supervisord server is listening    (default &quot;http://localhost:9001&quot;).-u/--username USERNAME -- username to use for authentication with server-p/--password PASSWORD -- password to use for authentication with server-r/--history-file -- keep a readline history (if readline is available)action [arguments] -- see belowActions are commands like &quot;tail&quot; or &quot;stop&quot;.  If -i is specified or no action isspecified on the command line, a &quot;shell&quot; interpreting actions typedinteractively is started.  Use the action &quot;help&quot; to find out about availableactions.</code></pre><h5 id="连接-supervisord"><a href="#连接-supervisord" class="headerlink" title="连接 supervisord"></a>连接 supervisord</h5><p>supervisorctl 默认是通过 unix 套接字跟 supervisord 通信，也就是用之前使用 supervisorctl 的方式。如果 supervisord 开启了远程监听（web访问），则 supervisorctl 也可以远程连接其他主机的 supervisor，连接方式主要是以下两种：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl -s http://10.0.1.15:9001 -u admin -p 123456 statuspyhttp                           RUNNING   pid 2728, uptime 0:00:48(supervisor) root@ubuntu:~# supervisorctl -s http://10.0.1.15:9001 Server requires authenticationUsername:adminPassword:pyhttp                           RUNNING   pid 2728, uptime 0:03:48supervisor&gt; (supervisor) root@ubuntu:~#</code></pre><p>使用 <code>-s</code> 指定服务监听地址，<code>-u</code> 提供登录的用户名，<code>-p</code> 提供密码，如果是进入交互模式，没有在命令行提供用户名和密码，supervisorctl 则会询问。</p><h5 id="控制命令"><a href="#控制命令" class="headerlink" title="控制命令"></a>控制命令</h5><p>除了最常用的 <code>stop</code>、<code>start</code>、<code>restart</code> 命令，supervisorctl 还支持非常多的控制命令，通过 <code>help</code> 命令可以获取所有支持的命令：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl -c /etc/supervisord.conf pyhttp                           RUNNING   pid 2728, uptime 0:36:59supervisor&gt; helpdefault commands (type help &lt;topic&gt;):=====================================add    exit      open  reload  restart   start   tail   avail  fg        pid   remove  shutdown  status  update clear  maintail  quit  reread  signal    stop    versionsupervisor&gt;</code></pre><p>通过 <code>help &lt;command&gt;</code> 可以查看命令帮助：</p><pre><code>supervisor&gt; help helphelp        Print a list of available actionshelp &lt;action&gt;    Print help for &lt;action&gt;supervisor&gt;</code></pre><p>下面对所以支持的命令进行一一介绍</p><h6 id="update"><a href="#update" class="headerlink" title="update"></a>update</h6><blockquote><p>重新读取配置文件</p></blockquote><p>用法：</p><ul><li><code>update</code>            根据配置文件的改动添加或移除项目，将会重启或停止受影响的项目</li><li><code>update all</code>        和 update 一样，根据配置文件的改动添加或移除项目，将会重启或停止受影响的项目</li><li><code>update &lt;gname&gt; [...]</code>    更新指定的组，可以提供多个组名</li></ul><p>示例：</p><p>为了演示效果，我们修改配置文件，添加一个进程，并为它们创建一个进程组。将以下配置项写入配置文件，并更新 supervisord：</p><pre><code>[program:pyhttp1]command=/usr/bin/python3 -m http.server 8081directory=/tmp/stdout_logfile=/tmp/pyhttp1.log[program:pyhttp2]command=/usr/bin/python3 -m http.server 8082directory=/tmp/stdout_logfile=/tmp/pyhttp2.log[group:simpleHttp]programs=pyhttp1,pyhttp2</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">supervisorctl -c /etc/supervisord.conf update</span><br></pre></td></tr></table></figure><pre><code>(supervisor) root@ubuntu:~# supervisorctl -c /etc/supervisord.conf updatesimpleHttp: added process group</code></pre><p><strong>注意</strong>：update 方法不会影响没有修改配置的进程，所以重复执行也是安全的</p><h6 id="status"><a href="#status" class="headerlink" title="status"></a>status</h6><blockquote><p>查看进程的状态信息</p></blockquote><p>用法：</p><ul><li><code>status</code>：获取所有进程状态信息</li><li><code>status &lt;name&gt;</code>：        获取指定名称的进程状态信息</li><li><code>status &lt;gname&gt;:*</code>：    获取指定进程组名称的所有进程信息</li><li><code>status &lt;name&gt; &lt;name&gt;</code>：    获取指定的多个名称的进程信息</li></ul><p>示例：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl -c /etc/supervisord.conf pyhttp                           RUNNING   pid 2851, uptime 0:02:20simpleHttp:pyhttp1               RUNNING   pid 2860, uptime 0:00:29simpleHttp:pyhttp2               RUNNING   pid 2861, uptime 0:00:29supervisor&gt; status pyhttp pyhttp                           RUNNING   pid 2851, uptime 0:02:25supervisor&gt; status simpleHttp:*simpleHttp:pyhttp1               RUNNING   pid 2860, uptime 0:00:39simpleHttp:pyhttp2               RUNNING   pid 2861, uptime 0:00:39supervisor&gt;</code></pre><h6 id="stop"><a href="#stop" class="headerlink" title="stop"></a>stop</h6><blockquote><p>停止进程</p></blockquote><p>用法：</p><ul><li><code>stop &lt;name&gt;</code>        停止指定名称的进程</li><li><code>stop &lt;gname&gt;:*</code>        停止指定进程组内的所有进程</li><li><code>stop &lt;name&gt; &lt;name&gt;</code>    停止指定的多个进程或进程组</li><li><code>stop all</code>        停止所有进程</li></ul><p>示例：</p><pre><code>supervisor&gt; stop pyhttppyhttp: stoppedsupervisor&gt; stop simpleHttp:*simpleHttp:pyhttp1: stoppedsimpleHttp:pyhttp2: stoppedsupervisor&gt; statuspyhttp                           STOPPED   Aug 28 01:23 PMsimpleHttp:pyhttp1               STOPPED   Aug 28 01:24 PMsimpleHttp:pyhttp2               STOPPED   Aug 28 01:24 PMsupervisor&gt;</code></pre><h6 id="start"><a href="#start" class="headerlink" title="start"></a>start</h6><blockquote><p>启动进程</p></blockquote><p>用法：</p><ul><li><code>start &lt;name&gt;</code>        启动指定名称的进程</li><li><code>start &lt;gname&gt;:*</code>        启动指定进程组内的所有进程</li><li><code>start &lt;name&gt; &lt;name&gt;</code>    启动指定的多个进程或进程组</li><li><code>start all</code>        启动所有进程</li></ul><p>示例：</p><pre><code>supervisor&gt; start pyhttppyhttp: startedsupervisor&gt; start allsimpleHttp:pyhttp1: startedsimpleHttp:pyhttp2: startedsupervisor&gt; statuspyhttp                           RUNNING   pid 3351, uptime 0:00:06simpleHttp:pyhttp1               RUNNING   pid 3352, uptime 0:00:03simpleHttp:pyhttp2               RUNNING   pid 3353, uptime 0:00:03supervisor&gt;</code></pre><h6 id="restart"><a href="#restart" class="headerlink" title="restart"></a>restart</h6><blockquote><p>重启进程</p></blockquote><p>用法：</p><ul><li><code>restart &lt;name&gt;</code>        重启指定名称的进程</li><li><code>restart &lt;gname&gt;:*</code>    重启指定进程组内的所有进程</li><li><code>restart &lt;name&gt; &lt;name&gt;</code>    重启指定的多个进程或进程组</li><li><code>restart all</code>        重启所有进程</li></ul><p>示例：</p><pre><code>supervisor&gt; restart allpyhttp: stoppedsimpleHttp:pyhttp1: stoppedsimpleHttp:pyhttp2: stoppedpyhttp: startedsimpleHttp:pyhttp1: startedsimpleHttp:pyhttp2: startedsupervisor&gt;</code></pre><h6 id="pid"><a href="#pid" class="headerlink" title="pid"></a>pid</h6><blockquote><p>获取 PID</p></blockquote><p>用法：</p><ul><li><code>pid</code>            获取 supervisord 的 PID</li><li><code>pid &lt;name&gt;</code>        获取指定名称的进程的 PID</li><li><code>pid all</code>            获取所有进程的 PID</li></ul><p>示例：</p><pre><code>supervisor&gt; pid all335733583359supervisor&gt; pid2727supervisor&gt; pid pyhttp 3357supervisor&gt; </code></pre><h6 id="reload"><a href="#reload" class="headerlink" title="reload"></a>reload</h6><blockquote><p>通知 supervisord 进程重新重新初始化。会关闭所有进程，然后重新读取配置文件后启动进程</p></blockquote><p>用法：</p><ul><li><code>reload</code>         重启远程的 supervisord</li></ul><p>此命令类似于直接向 supervisord 进程发送 <code>HUP</code> 信号一样，会通知 supervisord 进程重新初始化。为了演示效果，我们修改下进程组 <code>simpleHttp</code> 的成员，将 <code>pyhttp2</code> 换成 <code>pyhttp</code>：</p><pre><code>[group:simpleHttp]programs=pyhttp1,pyhttp</code></pre><p>示例：</p><pre><code>supervisor&gt; reloadReally restart the remote supervisord process y/N? yRestarted supervisordsupervisor&gt; statuspyhttp2                          RUNNING   pid 3502, uptime 0:00:07simpleHttp:pyhttp                RUNNING   pid 3504, uptime 0:00:07simpleHttp:pyhttp1               RUNNING   pid 3503, uptime 0:00:07supervisor&gt;</code></pre><p><strong>注意</strong>：生产环境应该尽量避免执行这个命令，因为会重启所有的进程，除非在修改了 supervisord 服务本身的配置项的时候，比如修改了 supervisord 服务监听地址的时候，才需要使用 <code>reload</code> 命令，修改了项目相关配置项的时候 应当使用 <code>update</code> 代替。关于 supervisor 的配置文件，下面会有详细说明。</p><h6 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h6><blockquote><p>移除一个已停止的进程，相当于禁用</p></blockquote><p>用法：</p><ul><li><code>remove &lt;name&gt; [...]</code>    从当前活跃的配置中，移除指定的进程名或进程组</li></ul><p>示例：</p><pre><code>supervisor&gt; stop pyhttp2pyhttp2: stoppedsupervisor&gt; remove pyhttp2 pyhttp2: removed process groupsupervisor&gt; statussimpleHttp:pyhttp                RUNNING   pid 3510, uptime 0:05:42simpleHttp:pyhttp1               RUNNING   pid 3509, uptime 0:05:42supervisor&gt; </code></pre><p>必须要先停止要移除的进程，移除后再执行 <code>status</code> 被移除的进程就不可见了。</p><h6 id="avail"><a href="#avail" class="headerlink" title="avail"></a>avail</h6><blockquote><p>显示所有已配置的进程</p></blockquote><p>用法：</p><ul><li><code>avail</code> 显示所有已配置的进程</li></ul><p>示例：</p><pre><code>supervisor&gt; avail simpleHttp:pyhttp                in use    auto      999:999simpleHttp:pyhttp1               in use    auto      999:999pyhttp2                          avail     auto      999:999supervisor&gt;</code></pre><p>可以看到所有的进程，包括正在使用的，和可用的。</p><h6 id="add"><a href="#add" class="headerlink" title="add"></a>add</h6><blockquote><p>添加一个被移除后的进程，相当于启用</p></blockquote><p>用法：</p><ul><li><code>add &lt;name&gt; [...]</code> 从已移除的项目中，重新启用指定的进程名或进程组</li></ul><p>示例：</p><pre><code>supervisor&gt; add pyhttp2pyhttp2: added process groupsupervisor&gt; statuspyhttp2                          RUNNING   pid 3613, uptime 0:00:07simpleHttp:pyhttp                RUNNING   pid 3510, uptime 0:11:37simpleHttp:pyhttp1               RUNNING   pid 3509, uptime 0:11:37supervisor&gt;</code></pre><p><strong>注意</strong>：用 update 也会使已禁用的进程重新启用。但是和 <code>add</code> 还是有本质上的区别，如果禁用这个进程后，修改了这个进程的配置文件，用 <code>add</code> 只能启用未修改前这个进程的配置，而 <code>update</code> 则会重新读取新的配置。</p><h6 id="reread"><a href="#reread" class="headerlink" title="reread"></a>reread</h6><blockquote><p>重新读取项目的配置文件</p></blockquote><p>用法：</p><ul><li><code>reread</code> 重新加载配置文件，但是不会自动执行 add 和 remove</li></ul><p>也就是说，reread 会比 update 柔和，当修改了正在运行的进程的配置项后，它也不会停止被修改的进程。即使添加了新的进程配置项，它也不会主动启动新进程。现在我们修改配置文件，将 <code>pyhttp2</code> 的名称改为 <code>pyhttp3</code>：</p><pre><code>[program:pyhttp3]command=/usr/bin/python3 -m http.server 8082directory=/tmp/stdout_logfile=/tmp/pyhttp2.log</code></pre><p>示例：</p><pre><code>supervisor&gt; rereadpyhttp2: disappearedpyhttp3: availablesupervisor&gt; statuspyhttp2                          RUNNING   pid 3616, uptime 0:01:12simpleHttp:pyhttp                RUNNING   pid 3510, uptime 0:24:57simpleHttp:pyhttp1               RUNNING   pid 3509, uptime 0:24:57supervisor&gt; avail simpleHttp:pyhttp                in use    auto      999:999simpleHttp:pyhttp1               in use    auto      999:999pyhttp3                          avail     auto      999:999supervisor&gt;</code></pre><p>可以看到，pyhttp2 进程依然在运行，pyhttp3 只存在于 avail 中。接下来复原配置文件，并执行 update ：</p><pre><code>[program:pyhttp2]command=/usr/bin/python3 -m http.server 8082directory=/tmp/stdout_logfile=/tmp/pyhttp2.log</code></pre><h6 id="tail"><a href="#tail" class="headerlink" title="tail"></a>tail</h6><blockquote><p>显示进程的标准输出或错误输出，用法类似于 linux 的 tail 命令</p></blockquote><p>命令格式：<code>tail [-f] &lt;name&gt; [stdout|stderr] (default stdout)</code></p><p>用法：</p><ul><li><code>tail -f &lt;name&gt;</code>        连续的获取指定进程名的标准输出，Ctrl-C 退出。</li><li><code>tail -100 &lt;name&gt;</code>    获取指定进程名的最后 100 个字节的标准输出。</li><li><code>tail &lt;name&gt; stderr</code>    获取指定进程名的最后 1600 个字节的错误输出。</li></ul><p>由于 supervisord 没有获取到 <code>python -m http.server</code> 的输出流，所以 tail 命令看不到任何数据，具体原因我也懒得排查了。。。</p><h6 id="maintail"><a href="#maintail" class="headerlink" title="maintail"></a>maintail</h6><blockquote><p>显示 supervisord 进程的日志，用法和 tail 命令类似</p></blockquote><p>用法：</p><ul><li><code>maintail -f</code>     连续的获取 supervisord 的日志，Ctrl-C 退出。</li><li><code>maintail -100</code>    获取 supervisord 的日志的最后 100 个字节。</li><li><code>maintail    last</code>  获取 supervisord 的日志的最后 1600 个字节。</li></ul><p>示例：</p><pre><code>supervisor&gt; maintail -100 INFO success: pyhttp2 entered RUNNING state, process has stayed up for &gt; than 1 seconds (startsecs)</code></pre><h6 id="clear"><a href="#clear" class="headerlink" title="clear"></a>clear</h6><blockquote><p>清理进程日志</p></blockquote><p>用法：</p><ul><li><code>clear &lt;name&gt;</code>        清理指定进程名的日志文件。</li><li><code>clear &lt;name&gt; &lt;name&gt;</code>    清理指定的多个进程名的日志文件</li><li><code>clear all</code>        清理所有进程的日志文件。</li></ul><p>示例：</p><pre><code>supervisor&gt; clear allsimpleHttp:pyhttp1: clearedsimpleHttp:pyhttp: clearedpyhttp2: clearedsupervisor&gt;</code></pre><h6 id="version"><a href="#version" class="headerlink" title="version"></a>version</h6><blockquote><p>显示 supervisord 的版本</p></blockquote><p>用法：</p><ul><li><code>version</code> 显示远程 supervisord 进程的版本。</li></ul><p>示例：</p><pre><code>supervisor&gt; version4.0.4supervisor&gt;</code></pre><h6 id="fg"><a href="#fg" class="headerlink" title="fg"></a>fg</h6><blockquote><p>在前台模式连接一个进程，本质上是连接到了进程的标准输入</p></blockquote><p>用法：</p><ul><li><code>fg &lt;process&gt;</code> 在前台模式连接一个进程</li></ul><p>首先我们需要先编写一个可以获取标准输入的程序，然后才可以用 fg 命令来做测试。</p><p>编辑 <code>/root/fgtest.py</code> 写入以下内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    print(<span class="string">"hello "</span>, input())</span><br></pre></td></tr></table></figure><p>编辑 <code>/etc/supervisord.conf</code> 添加如下内容：</p><pre><code>[program:fgtest]command=/usr/bin/python3 /root/fgtest.pystdout_logfile=/tmp/fgtest.log</code></pre><p>接着更新 supervisord，并测试 fg 命令：</p><pre><code>supervisor&gt; updatefgtest: added process groupsupervisor&gt; statusfgtest                           RUNNING   pid 3722, uptime 0:00:06pyhttp2                          RUNNING   pid 3699, uptime 0:03:17simpleHttp:pyhttp                RUNNING   pid 3701, uptime 0:03:17simpleHttp:pyhttp1               RUNNING   pid 3700, uptime 0:03:17supervisor&gt; fg fgtest ==&gt; Press Ctrl-C to exit &lt;==aaahello  aaaExiting foregroundsupervisor&gt; tail fgtest hello  aaasupervisor&gt;</code></pre><p>的确如我们所愿，当我们输入了 <code>aaa</code>，进程成功的回显了 <code>hello aaa</code>，并且 tail 命令也正确的输出了结果。</p><h6 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h6><blockquote><p>给子进程发送信号，类似于 linux 的 kill 命令</p></blockquote><p>用法：</p><ul><li><code>signal &lt;signal name&gt; &lt;name&gt;</code>        向指定的进程名发送指定的信号</li><li><code>signal &lt;signal name&gt; &lt;gname&gt;:*</code>        向指定的进程组发送指定的信号</li><li><code>signal &lt;signal name&gt; &lt;name&gt; &lt;name&gt;</code>    向指定的多个进程名发送指定的信号</li><li><code>signal &lt;signal name&gt; all</code>        向所有进程发送指定的信号</li></ul><p>linux 可用的信号如下所示：</p><pre><code>root@ubuntu:~# kill -l1) SIGHUP     2) SIGINT     3) SIGQUIT     4) SIGILL     5) SIGTRAP2) SIGABRT     7) SIGBUS     8) SIGFPE     9) SIGKILL    10) SIGUSR13)  SIGSEGV    12) SIGUSR2    13) SIGPIPE    14) SIGALRM    15) SIGTERM4)  SIGSTKFLT    17) SIGCHLD    18) SIGCONT    19) SIGSTOP    20) SIGTSTP5)  SIGTTIN    22) SIGTTOU    23) SIGURG    24) SIGXCPU    25) SIGXFSZ6)  SIGVTALRM    27) SIGPROF    28) SIGWINCH    29) SIGIO    30) SIGPWR7)  SIGSYS    34) SIGRTMIN    35) SIGRTMIN+1    36) SIGRTMIN+2    37) SIGRTMIN+38)  SIGRTMIN+4    39) SIGRTMIN+5    40) SIGRTMIN+6    41) SIGRTMIN+7    42) SIGRTMIN+89)  SIGRTMIN+9    44) SIGRTMIN+10    45) SIGRTMIN+11    46) SIGRTMIN+12    47) SIGRTMIN+1310) SIGRTMIN+14    49) SIGRTMIN+15    50) SIGRTMAX-14    51) SIGRTMAX-13    52) SIGRTMAX-1211) SIGRTMAX-11    54) SIGRTMAX-10    55) SIGRTMAX-9    56) SIGRTMAX-8    57) SIGRTMAX-712) SIGRTMAX-6    59) SIGRTMAX-5    60) SIGRTMAX-4    61) SIGRTMAX-3    62) SIGRTMAX-213) SIGRTMAX-1    64) SIGRTMAX    </code></pre><p>我们前面已经了解到，可以通过给 supervisord 发送 <code>HUP</code>(1) 信号来通知进程重新初始化。平常我们通过 <code>Ctrl-C</code> 来终止程序本质上就是发送 <code>INT</code>(2) 信号给进程。以及最常用的也是 kill 命令默认发出的 <code>TERM</code>(15) 信号，还有六亲不认的 <code>KILL</code>(9) 信号。</p><p>示例：</p><pre><code>supervisor&gt; status fgtest fgtest                           RUNNING   pid 3737, uptime 0:00:36supervisor&gt; signal INT fgtest fgtest: signalledsupervisor&gt; status fgtest fgtest                           RUNNING   pid 3738, uptime 0:00:03supervisor&gt; signal 9 fgtest fgtest: signalledsupervisor&gt; status fgtest fgtest                           STARTING  supervisor&gt; status fgtest fgtest                           RUNNING   pid 3739, uptime 0:00:03supervisor&gt; </code></pre><p>我们可以通过信号的名称，或者信号的编号来用作发送给进程，可以看到，给进程发送了终止，或者强制杀死的信号后，supervisord 把挂掉的进程重启了！这也是 supervisord 的特性之一。</p><h6 id="help"><a href="#help" class="headerlink" title="help"></a>help</h6><blockquote><p>查看帮助</p></blockquote><p>用法：</p><ul><li><code>help</code> 列出所有的可用命令</li><li><code>help &lt;command&gt;</code> 查看指定的命令的帮助</li></ul><p>示例：</p><pre><code>supervisor&gt; help default commands (type help &lt;topic&gt;):=====================================add    exit      open  reload  restart   start   tail   avail  fg        pid   remove  shutdown  status  update clear  maintail  quit  reread  signal    stop    versionsupervisor&gt; help startstart &lt;name&gt;        Start a processstart &lt;gname&gt;:*        Start all processes in a groupstart &lt;name&gt; &lt;name&gt;    Start multiple processes or groupsstart all        Start all processessupervisor&gt; </code></pre><h6 id="open"><a href="#open" class="headerlink" title="open"></a>open</h6><blockquote><p>连接远程的 supervisord 进程，可以通过 unix 套接字，也可以通过 http 协议。</p></blockquote><p>用法：</p><ul><li><code>open &lt;url&gt;</code> 连接远程的 supervisord 进程。</li></ul><p>示例：</p><pre><code>supervisor&gt; open http://127.0.0.1:9001Server requires authenticationUsername:adminPassword:pyhttp2                          RUNNING   pid 3616, uptime 0:33:55simpleHttp:pyhttp                RUNNING   pid 3510, uptime 0:57:40simpleHttp:pyhttp1               RUNNING   pid 3509, uptime 0:57:40supervisor&gt; open unix:///tmp/supervisor.sockpyhttp2                          RUNNING   pid 3616, uptime 0:34:58simpleHttp:pyhttp                RUNNING   pid 3510, uptime 0:58:43simpleHttp:pyhttp1               RUNNING   pid 3509, uptime 0:58:43supervisor&gt;</code></pre><h6 id="quit"><a href="#quit" class="headerlink" title="quit"></a>quit</h6><blockquote><p>退出当前 supervisorctl 交互界面。</p></blockquote><p>用法：</p><ul><li><code>quit</code> 退出 supervisorctl 交互。</li></ul><p>示例：</p><pre><code>supervisor&gt; quit(supervisor) root@ubuntu:~#</code></pre><h6 id="exit"><a href="#exit" class="headerlink" title="exit"></a>exit</h6><blockquote><p>退出当前 supervisorctl 交互界面，同 quit。</p></blockquote><p>用法：</p><ul><li><code>exit</code> 退出 supervisorctl 交互。</li></ul><p>示例：</p><pre><code>supervisor&gt; exit(supervisor) root@ubuntu:~#</code></pre><h6 id="shutdown"><a href="#shutdown" class="headerlink" title="shutdown"></a>shutdown</h6><blockquote><p>关闭 supervisord 以及所有正在被管理的子进程。</p></blockquote><p>用法：</p><ul><li><code>shutdown</code> 关闭远程 supervisord 进程。</li></ul><p>示例：</p><pre><code>supervisor&gt; shutdown Really shut the remote supervisord process down y/N? yShut downsupervisor&gt;supervisor&gt; statusunix:///tmp/supervisor.sock no such filesupervisor&gt;</code></pre><h4 id="echo-supervisord-conf"><a href="#echo-supervisord-conf" class="headerlink" title="echo_supervisord_conf"></a>echo_supervisord_conf</h4><p>这个命令很简单，就是打印 <code>supervisord.conf</code> 的模板示例。</p><h4 id="pidproxy"><a href="#pidproxy" class="headerlink" title="pidproxy"></a>pidproxy</h4><p>对于一些启动比较特殊的服务，例如 <code>mysqld</code>，当我们启动 <code>mysqld</code> 的时候，通常执行的是 <code>mysqld_safe</code> 脚本，然后它再去调用 <code>mysqld</code> 程序来启动服务。</p><p>supervisord 是通过给进程发送信号的方式来关闭程序的，但是 supervisord 只能获取 <code>mysqld_safe</code> 的 PID，而 <code>mysqld_safe</code> 会忽略进程退出相关的信号，只有它的子进程 <code>mysqld</code> 才会处理信号，所以如果使用 supervisord 来管理 <code>mysqld</code>，就需要让 supervisord 知道 <code>mysqld</code> 进程的实际 PID。</p><p>幸运的是，大多数进程启动后，都会创建一个 <code>.pid</code> 的文件，文件里保存进程的实际 PID，pidproxy 可以帮助我们启动进程后，根据提供的 <code>.pid</code> 文件位置来获取实际要控制的进程。</p><p>用法：</p><ul><li><code>pidproxy &lt;pidfile name&gt; &lt;command&gt; [&lt;cmdarg1&gt; ...]</code></li></ul><p>示例：</p><pre><code>[program：mysqld] command = /data/venv/supervisor/bin/pidproxy /var/run/mysqld.pid mysqld_safe</code></pre><h3 id="配置文件详解"><a href="#配置文件详解" class="headerlink" title="配置文件详解"></a>配置文件详解</h3><h4 id="默认配置文件查找"><a href="#默认配置文件查找" class="headerlink" title="默认配置文件查找"></a>默认配置文件查找</h4><p>supervisord 和 supervisorctl 共同使用 <code>supervisord.conf</code> 这个配置文件，如果没有使用 <code>-c</code> 参数指定配置文件的话，程序将依次从以下位置查找并使用找到的第一个配置文件：</p><ol><li><code>./supervisord.conf</code> 当前用户所在路径下的 supervisord.conf 文件。</li><li><code>./etc/supervisord.conf</code> 当前用户所在路径下的 etc/supervisord.conf 文件。</li><li><code>/etc/supervisord.conf</code> 系统绝对路径 /etc/supervisord.conf 文件。</li><li><code>/etc/supervisor/supervisord.conf</code> 系统绝对路径，但是从 3.3.0 版本才开始支持。</li><li><code>../etc/supervisord.conf</code> 相对于程序所在路径的 ../etc/supervisord.conf。</li><li><code>../supervisord.conf</code> 相对于程序所在路径的 ../supervisord.conf。</li></ol><h4 id="配置文件格式"><a href="#配置文件格式" class="headerlink" title="配置文件格式"></a>配置文件格式</h4><p>supervisord.conf 使用 Windows-INI 风格的配置文件。由不同的配置单元，配置单元中通过键值对的方式记录配置信息，格式如下：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[program:pyhttp1]</span></span><br><span class="line"><span class="attr">command</span>=/usr/bin/python3 -m http.server <span class="number">8081</span></span><br><span class="line"><span class="attr">directory</span>=/tmp/</span><br><span class="line"><span class="attr">stdout_logfile</span>=/tmp/pyhttp1.log</span><br><span class="line"></span><br><span class="line"><span class="section">[program:pyhttp2]</span></span><br><span class="line"><span class="attr">command</span>=/usr/bin/python3 -m http.server <span class="number">8082</span></span><br><span class="line"><span class="attr">directory</span>=/tmp/</span><br><span class="line"><span class="attr">stdout_logfile</span>=/tmp/pyhttp2.log</span><br></pre></td></tr></table></figure><p>每一个 <code>[]</code> 开始都表示一个配置单元，直到下一个配置单元为止。在 supervisord.conf 中，配置单元中的值还可以使用 <code>%(ENV_ENVNAME)s</code> 的方式。supervisord 启动的时候，会将其中的值根据对应的环境变量替换成实际的值，例如在配置文件中使用了 <code>%(ENV_ENVNAME)s</code>，则对应环境变量 <code>ENVNAME</code> 的值会替换了配置文件中变量的部分。下面举个例子来看：</p><p>配置文件中追加新的配置项：</p><pre><code>[program:envtest]command=/usr/bin/python3 -m http.server 8083stdout_logfile=/tmp/%(ENV_LOGFILE)s</code></pre><p>因为通过环境变量传递值给 supervisord.conf 的方式，必须保证 supervisord 进程可以继承到这些环境变量，我们在添加 <code>LOGFILE</code> 这个环境变量后必须重新启动 supervisord 进程才可以</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl shutdownShut down(supervisor) root@ubuntu:~# env LOGFILE=&quot;log_from_env.log&quot; supervisord -c /etc/supervisord.conf(supervisor) root@ubuntu:~# supervisorctl statusenvtest                          RUNNING   pid 4944, uptime 0:00:04fgtest                           RUNNING   pid 4945, uptime 0:00:04pyhttp2                          RUNNING   pid 4946, uptime 0:00:04simpleHttp:pyhttp                RUNNING   pid 4948, uptime 0:00:04simpleHttp:pyhttp1               RUNNING   pid 4947, uptime 0:00:04(supervisor) root@ubuntu:~# ls /tmp/log_from_env.log /tmp/log_from_env.log(supervisor) root@ubuntu:~#</code></pre><p>我们配置了一个只针对 supervisord 进程生效的环境变量 <code>LOGFILE</code>，可以看到 <code>log_from_env.log</code> 文件被成功读取并替换到配置文件中。</p><h4 id="配置单元"><a href="#配置单元" class="headerlink" title="配置单元"></a>配置单元</h4><blockquote><p>下面详细讲解 supervisord.conf 都支持哪些配置项。</p></blockquote><h5 id="unix-http-server"><a href="#unix-http-server" class="headerlink" title="[unix_http_server]"></a>[unix_http_server]</h5><p>该配置项用于定义 supervisord 监听 UNIX 套接字提供 <code>HTTP/XML-RPC</code> 服务的相关配置。</p><h6 id="file"><a href="#file" class="headerlink" title="file"></a>file</h6><blockquote><p>supervisord 将监听 UNIX 套接字的路径。</p></blockquote><p>默认值：无<br>是否必填：否<br>例子：<code>file = /tmp/supervisor.sock</code></p><h6 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h6><blockquote><p>设置 UNIX 套接字文件的权限。</p></blockquote><p>默认值：0700<br>是否必填：否<br>例如：<code>chmod = 0777</code></p><h6 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h6><blockquote><p>设置 UNIX 套接字文件的属主和属组。可以是用户名，也可以用冒号分割用户名和组 例如：<code>nobody:nogroup</code>。</p></blockquote><p>默认值：默认使用启动 supervisord 进程的用户名和组。<br>是否必填：否<br>例如：<code>chown= nobody:nogroup</code></p><h6 id="username"><a href="#username" class="headerlink" title="username"></a>username</h6><blockquote><p><code>HTTP/XML-RPC</code> 服务的认证用户名，如果提供，supervisorctl 则需要用户认证才可连接。</p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>username = admin</code></p><h6 id="password"><a href="#password" class="headerlink" title="password"></a>password</h6><blockquote><p><code>HTTP/XML-RPC</code> 服务的认证密码。可以是明文密码，也可以使用密码经过 sha-1 哈希后的值，需要用 <code>{SHA}</code> 标识是一个哈希串，例如： <code>{SHA}82ab876d1387bfafe46cc1c8a2ef074eae50cb1d</code> </p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>password = password</code> 或者 <code>password = {SHA}5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</code></p><h5 id="inet-http-server"><a href="#inet-http-server" class="headerlink" title="[inet_http_server]"></a>[inet_http_server]</h5><p>该项用于定义 supervisord 监听 TCP 套接字提供 <code>HTTP/XML-RPC</code> 服务的相关配置。启动此监听后 supervisord 可以通过网络来管理和控制。默认 supervisord 不会启动 TCP 的监听，因为这非常的不安全。</p><h6 id="port"><a href="#port" class="headerlink" title="port"></a>port</h6><blockquote><p>监听的地址和端口</p></blockquote><p>默认值：如果有 <code>[inet_http_server]</code> 配置项则必填<br>是否必填：否<br>例如：<code>port = 127.0.0.1:9001</code></p><h6 id="username-1"><a href="#username-1" class="headerlink" title="username"></a>username</h6><blockquote><p><code>HTTP/XML-RPC</code> 服务的认证用户名，如果提供，supervisorctl 则需要用户认证才可连接。</p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>username = admin</code></p><h6 id="password-1"><a href="#password-1" class="headerlink" title="password"></a>password</h6><blockquote><p><code>HTTP/XML-RPC</code> 服务的认证密码。可以是明文密码，也可以使用密码经过 sha-1 哈希后的值，需要用 <code>{SHA}</code> 标识是一个哈希串，例如： <code>{SHA}82ab876d1387bfafe46cc1c8a2ef074eae50cb1d</code> </p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>password = password</code> 或者 <code>password = {SHA}5baa61e4c9b93f3f0682250b6cf8331b7ee68fd8</code></p><h5 id="supervisord-1"><a href="#supervisord-1" class="headerlink" title="[supervisord]"></a>[supervisord]</h5><p>此配置项定义 supervisord 进程的一些配置信息</p><h6 id="logfile"><a href="#logfile" class="headerlink" title="logfile"></a>logfile</h6><blockquote><p>supervisord 进程的日志输出文件。</p></blockquote><p>默认值：当前目录下的 <code>supervisord.log</code> 文件<br>是否必填：否<br>例如：<code>logfile = /tmp/supervisord.log</code></p><p><strong>注意</strong>：如果 logfile 的值是特殊文件，比如 <code>/dev/stdout</code> 则必须设置 <code>logfile_maxbytes = 0</code> 来禁止日志轮转。</p><h6 id="logfile-maxbytes"><a href="#logfile-maxbytes" class="headerlink" title="logfile_maxbytes"></a>logfile_maxbytes</h6><blockquote><p>日志超过多大的尺寸将会被分割轮转，如果设置为 0 则表示无限大。</p></blockquote><p>默认值：50MB<br>是否必填：否<br>例如：<code>logfile_maxbytes = 50MB</code></p><h6 id="logfile-backups"><a href="#logfile-backups" class="headerlink" title="logfile_backups"></a>logfile_backups</h6><blockquote><p>由于日志文件轮转导致的备份数量，如果设置为 0 则不会对因为轮转被分割的日志文件进行备份。</p></blockquote><p>默认值：10<br>是否必填：否<br>例如：<code>logfile_backups = 10</code></p><h6 id="loglevel"><a href="#loglevel" class="headerlink" title="loglevel"></a>loglevel</h6><blockquote><p>supervisord 进程记录日志的级别，可选值为 <code>critical</code>, <code>error</code>, <code>warn</code>, <code>info</code>, <code>debug</code>, <code>trace</code>, <code>blather</code>。</p></blockquote><p>默认值：info<br>是否必填：否<br>例如：<code>loglevel = info</code></p><h6 id="pidfile"><a href="#pidfile" class="headerlink" title="pidfile"></a>pidfile</h6><blockquote><p>supervisord 进程 pid 文件的位置。</p></blockquote><p>默认值：当前路径下的 <code>supervisord.pid</code><br>是否必填：否<br>例如：<code>pidfile = /tmp/supervisord.pid</code></p><h6 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h6><blockquote><p>supervisord 进程的 umask。将会影响 supervisord 进程创建文件的权限，包括记录子进程日志的文件权限。</p></blockquote><p>默认值：022<br>是否必填：否<br>例如：<code>umask = 022</code></p><h6 id="nodaemon"><a href="#nodaemon" class="headerlink" title="nodaemon"></a>nodaemon</h6><blockquote><p>是否以非守护进程方式运行 supervisord 进程，如果 <code>true</code>，supervisord 进程将在前台运行。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>nodaemon = false</code></p><h6 id="minfds"><a href="#minfds" class="headerlink" title="minfds"></a>minfds</h6><blockquote><p>supervisord 进程在成功运行之前会调整自身的最小可用文件描述符的数量。</p></blockquote><p>默认值：1024<br>是否必填：否<br>例如：<code>minfds = 1024</code></p><h6 id="minprocs"><a href="#minprocs" class="headerlink" title="minprocs"></a>minprocs</h6><blockquote><p>supervisord 进程在成功运行之前会调整自身的最小进程描述符的数量。</p></blockquote><p>默认值：200<br>是否必填：否<br>例如：<code>minprocs = 200</code></p><h6 id="nocleanup"><a href="#nocleanup" class="headerlink" title="nocleanup"></a>nocleanup</h6><blockquote><p>子进程的 stdout 和 stderr 的输出如果没有配置重定向则默认保存为临时文件（子进程日志路径为 AUTO 的情况），此项配置 supervisord 启动时是否清理这些临时文件。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>nocleanup = false</code></p><h6 id="childlogdir"><a href="#childlogdir" class="headerlink" title="childlogdir"></a>childlogdir</h6><blockquote><p>当子进程日志路径为 AUTO 的时候，子进程日志文件的存放路径。</p></blockquote><p>默认值：/tmp<br>是否必填：否<br>例如：<code>childlogdir = /tmp</code></p><h6 id="user"><a href="#user" class="headerlink" title="user"></a>user</h6><blockquote><p>在使用 root 用户运行 supervisord 进程时，进程将切换到此配置指定的用户。</p></blockquote><p>默认值：不切换用户<br>是否必填：否<br>例如：<code>user = nobody</code></p><h6 id="directory"><a href="#directory" class="headerlink" title="directory"></a>directory</h6><blockquote><p>运行 supervisord 守护进程时切换到此目录。</p></blockquote><p>默认值：不切换<br>是否必填：否<br>例如：<code>directory = /tmp</code></p><h6 id="strip-ansi"><a href="#strip-ansi" class="headerlink" title="strip_ansi"></a>strip_ansi</h6><blockquote><p>是否清除子进程日志中的 ansi 序列，比如 <code>\n</code>, <code>\t</code> 这些字符。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>strip_ansi = false</code></p><h6 id="environment"><a href="#environment" class="headerlink" title="environment"></a>environment</h6><blockquote><p>用于设置 supervisord 进程启动时的环境变量。supervisord 进程启动时会从 linux 系统继承当前的环境变量，这里可以设置 supervisord 进程特有的一些环境变量。当 supervisord 进程启动子进程时，子进程也会继承系统的和这些特有的环境变量。</p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>environment = LOGFILE=&quot;/tmp/process.log&quot;</code></p><p><strong>注意</strong>：多个环境变量用逗号隔开。</p><h6 id="identifier"><a href="#identifier" class="headerlink" title="identifier"></a>identifier</h6><blockquote><p>supervisord 进程的标识符，主要用于通过 XML_RPC 统一管理时，用于区分不同 supervisord 进程的标识符。</p></blockquote><p>默认值：supervisor<br>是否必填：否<br>例如：<code>identifier = supervisor</code></p><h5 id="supervisorctl-1"><a href="#supervisorctl-1" class="headerlink" title="[supervisorctl]"></a>[supervisorctl]</h5><p>此配置项主要是针对 supervisorctl 的一些配置。</p><h6 id="serverurl"><a href="#serverurl" class="headerlink" title="serverurl"></a>serverurl</h6><blockquote><p>supervisorctl 默认连接的 supervisord 地址，可以是 unix 套接字地址，也可以是 http 地址。</p></blockquote><p>默认值：<code>http://localhost:9001</code><br>是否必填：否<br>例如：<code>serverurl = unix:///tmp/supervisor.sock</code></p><p><strong>注意</strong>：没看错，默认值的确是 http 的连接。</p><h6 id="username-2"><a href="#username-2" class="headerlink" title="username"></a>username</h6><blockquote><p>supervisorctl 认证 <code>HTTP/XML-RPC</code> 服务时使用的用户名。</p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>username = admin</code></p><h6 id="password-2"><a href="#password-2" class="headerlink" title="password"></a>password</h6><blockquote><p>supervisorctl 认证 <code>HTTP/XML-RPC</code> 服务时使用的密码，这个值必须是明文的。</p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>password = password</code></p><h6 id="prompt"><a href="#prompt" class="headerlink" title="prompt"></a>prompt</h6><blockquote><p>supervisorctl 命令交互页面的提示符，默认是 <code>supervisor</code>，所以进入 supervisorctl 后提示符都是 <code>supervisor&gt;</code>。</p></blockquote><p>默认值：supervisor<br>是否必填：否<br>例如：<code>prompt = supervisor</code></p><h6 id="history-file"><a href="#history-file" class="headerlink" title="history_file"></a>history_file</h6><blockquote><p>保存 supervisorctl 命令输入历史的文件，和 shell 的 hisotry 类似。默认是没有开启，开启后我们则可以用过上下键来查找之前执行过的命令。</p></blockquote><p>默认值：没有文件<br>是否必填：否<br>例如：<code>history_file = ~/.sc_history</code></p><h5 id="program-xxx"><a href="#program-xxx" class="headerlink" title="[program:xxx]"></a>[program:xxx]</h5><p>这个配置项就是定义子进程的配置了，<code>[program:xxx]</code> 中的 <code>xxx</code> 可以是任意名字。</p><h6 id="command"><a href="#command" class="headerlink" title="command"></a>command</h6><blockquote><p>进程的启动命令，进程必须在前台运行模式才可以被 supervisord 进程管理。</p></blockquote><p>默认值：无<br>是否必填：是<br>例如：<code>command = python3 -m http.server</code></p><h6 id="process-name"><a href="#process-name" class="headerlink" title="process_name"></a>process_name</h6><blockquote><p>进程名，如果下面的 numprocs 参数才 1，就不需要管这个参数。它的值默认是 <code>%(program_name)s</code> 也就是 <code>[program:xxx]</code> 中的 <code>xxx</code>。如果 numprocs 有多个，那不同的进程名就必须是不同的名字了。</p></blockquote><p>默认值：<code>$(program_name)s</code><br>是否必填：否<br>例如：<code>process_name = $(program_name)s</code></p><h6 id="numprocs"><a href="#numprocs" class="headerlink" title="numprocs"></a>numprocs</h6><blockquote><p>supervisord 进程将启动此子进程的多个实例。如果 numprocs 大于 1，则 process_name 的值中必须包含 <code>$(process_num)s</code> 的表达式。</p></blockquote><p>默认值：1<br>是否必填：否<br>例如：<code>numprocs = 1</code></p><p><strong>备注</strong>：如果 numproces 的值大于 1，配置文件可以这样写：</p><pre><code>[program:fgtest]command=/usr/bin/python3 /root/fgtest.pystdout_logfile=/tmp/fgtest.logprocess_name = %(program_name)s-%(process_num)snumprocs=10</code></pre><p>update 后可以看到：</p><pre><code>supervisor&gt; statusenvtest                          RUNNING   pid 8319, uptime 1:18:29fgtest:fgtest-0                  RUNNING   pid 8580, uptime 0:00:02fgtest:fgtest-1                  RUNNING   pid 8581, uptime 0:00:02fgtest:fgtest-2                  RUNNING   pid 8582, uptime 0:00:02fgtest:fgtest-3                  RUNNING   pid 8583, uptime 0:00:02fgtest:fgtest-4                  RUNNING   pid 8584, uptime 0:00:02fgtest:fgtest-5                  RUNNING   pid 8585, uptime 0:00:02fgtest:fgtest-6                  RUNNING   pid 8586, uptime 0:00:02fgtest:fgtest-7                  RUNNING   pid 8587, uptime 0:00:02fgtest:fgtest-8                  RUNNING   pid 8588, uptime 0:00:02fgtest:fgtest-9                  RUNNING   pid 8589, uptime 0:00:02pyhttp2                          RUNNING   pid 8321, uptime 1:18:29simpleHttp:pyhttp                RUNNING   pid 8323, uptime 1:18:29simpleHttp:pyhttp1               RUNNING   pid 8322, uptime 1:18:29supervisor&gt;</code></pre><h6 id="numprocs-start"><a href="#numprocs-start" class="headerlink" title="numprocs_start"></a>numprocs_start</h6><blockquote><p>上面可以看到，<code>%(process_num)s</code> 是从 0 开始计算。这个配置用于更改 <code>%(process_num)s</code> 的偏移量，例如 numproces_start 等于 1，则会生成 <code>fgtest:fgtest-1</code> 到 <code>fgtest:fgtest-10</code>。</p></blockquote><p>默认值：0<br>是否必填：否<br>例如：<code>numprocs_start = 0</code></p><h6 id="priority"><a href="#priority" class="headerlink" title="priority"></a>priority</h6><blockquote><p>进程的优先级，高优先级的程序将最后一个启动和第一个关闭。主要可以用于处理进程之间的依赖关系。</p></blockquote><p>默认值：999<br>是否必填：否<br>例如：<code>priority = 999</code></p><h6 id="autostart"><a href="#autostart" class="headerlink" title="autostart"></a>autostart</h6><blockquote><p>子进程是否随着 supervisord 进程的启动而启动。</p></blockquote><p>默认值：true<br>是否必填：否<br>例如：<code>autostart = true</code></p><h6 id="startsecs"><a href="#startsecs" class="headerlink" title="startsecs"></a>startsecs</h6><blockquote><p>子进程启动多少秒之后，如果状态依然是 RUNNGIN，则我们认为它启动成功了。</p></blockquote><p>默认值：1<br>是否必填：否<br>例如：<code>startsecs = 1</code></p><h6 id="startretries"><a href="#startretries" class="headerlink" title="startretries"></a>startretries</h6><blockquote><p>当进程启动失败后，最大尝试启动的次数。默认是 3 次，当超过 3 次后，supervisord 将把此进程的状态设置为 FAIL。</p></blockquote><p>默认值：3<br>是否必填：否<br>例如：<code>startretries = 3</code></p><h6 id="autorestart"><a href="#autorestart" class="headerlink" title="autorestart"></a>autorestart</h6><blockquote><p>如果进程已处于 RUNNING 状态后进程退出，supervisord 是否应该自动重启子进程。有三种选项：<code>false</code> 表示不自动重启， <code>unexpected</code> 表示只有进程退出码为下面 exitcodes 里定义的退出码时才重启， <code>true</code> 表示总是重启。</p></blockquote><p>默认值：unexpected<br>是否必填：否<br>例如：<code>autorestart = unexpected</code></p><h6 id="exitcodes"><a href="#exitcodes" class="headerlink" title="exitcodes"></a>exitcodes</h6><blockquote><p>进程退出码列表，与 autorestart 配合使用。</p></blockquote><p>默认值：0<br>是否必填：否<br>例如：<code>exitcodes = 0</code> 或者 <code>exitcodes = 0,2</code></p><h6 id="stopsignal"><a href="#stopsignal" class="headerlink" title="stopsignal"></a>stopsignal</h6><blockquote><p>进程停止信号，可以为 <code>TERM</code>, <code>HUP</code>, <code>INT</code>, <code>QUIT</code>, <code>KILL</code>, <code>USR1</code>, <code>USR2</code> 等信号。将执行 stop 命令的时候，supervisord 将用指定的信号杀死进程。</p></blockquote><p>默认值：TERM<br>是否必填：否<br>例如：<code>stopsignal = TERM</code></p><h6 id="stopwaitsecs"><a href="#stopwaitsecs" class="headerlink" title="stopwaitsecs"></a>stopwaitsecs</h6><blockquote><p>向子进程发送 stopsignal 后，到子进程退出，系统返回信息到 supervisord 所等待的时间。如果超时，supervisord 进程将强制杀死子进程。</p></blockquote><p>默认值：10<br>是否必填：否<br>例如：<code>stopwaitsecs = 10</code></p><h6 id="stopasgroup"><a href="#stopasgroup" class="headerlink" title="stopasgroup"></a>stopasgroup</h6><blockquote><p>如果子进程也有子进程，supervisord 仅仅干掉子进程的话，子进程的子进程可能会变成孤儿进程。该选项定义是否把整个子进程组全部停止。该选项发送的是终止信号。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>stopasgroup = false</code></p><h6 id="killasgroup"><a href="#killasgroup" class="headerlink" title="killasgroup"></a>killasgroup</h6><blockquote><p>与 stopasgroup 道理相同，不过 killasgroup 会强制杀死子进程。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>killasgroup = false</code></p><h6 id="user-1"><a href="#user-1" class="headerlink" title="user"></a>user</h6><blockquote><p>supervisord 进程启动子进程时，使用哪个用户身份运行子进程。只有 supervisord 进程以 root 用户启动才生效。</p></blockquote><p>默认值：不切换<br>是否必填：否<br>例如：<code>user = user</code></p><p><strong>注意</strong>：supervisord 仅仅使用 <code>setuid</code> 更改用户，并不会处理用户的环境变量，所以不会更改 <code>USER</code>、<code>HOME</code> 等环境变量的值。如果子进程依赖这些环境变量的话，可以通过下面的 environment 选项来配置。</p><h6 id="redirect-stderr"><a href="#redirect-stderr" class="headerlink" title="redirect_stderr"></a>redirect_stderr</h6><blockquote><p>将子进程的错误输出也写入标准输出的日志文件中。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>redirect_stderr = false</code></p><h6 id="stdout-logfile"><a href="#stdout-logfile" class="headerlink" title="stdout_logfile"></a>stdout_logfile</h6><blockquote><p>将子进程的标准输出写入到指定的文件，如果配置了 redirect_stderr 则错误输出也会写入到这个文件。如果未设置 stdout_logfile 或者此设置的值为 AUTO，supervisord 将自动选择文件位置，并在重启时清理这些文件。如果设置为 NONE，则 supervisord 不会创建任何日志文件。</p></blockquote><p>默认值：AUTO<br>是否必填：否<br>例如：<code>stdout_logfile = /tmp/process.log</code></p><p><strong>注意</strong>：如果将 stdout_logfile 设置为 <code>/dev/stdout</code> 等特殊文件，则必须通过设置 <code>stdout_logfile_maxbytes = 0</code> 来禁用日志轮转。</p><h6 id="stdout-logfile-maxbytes"><a href="#stdout-logfile-maxbytes" class="headerlink" title="stdout_logfile_maxbytes"></a>stdout_logfile_maxbytes</h6><blockquote><p>子进程日志文件在被轮转前最大字节数，将此值设置为 0 表示无限制。</p></blockquote><p>默认值：50MB<br>是否必填：否<br>例如：<code>stdout_logfile_maxbytes = 50MB</code></p><h6 id="stdout-logfile-backups"><a href="#stdout-logfile-backups" class="headerlink" title="stdout_logfile_backups"></a>stdout_logfile_backups</h6><blockquote><p>由于日志文件轮转导致的备份数量，如果设置为 0 则不会对因为轮转被分割的日志文件进行备份。</p></blockquote><p>默认值：10<br>是否必填：否<br>例如：<code>stdout_logfile_backups = 10</code></p><h6 id="stdout-capture-maxbytes"><a href="#stdout-capture-maxbytes" class="headerlink" title="stdout_capture_maxbytes"></a>stdout_capture_maxbytes</h6><blockquote><p>设置捕获模式管道的大小，当值不为 0 的时候，子进程可以从 stdout 发送消息，而 supervisord 可以根据信息发送相应的事件。</p></blockquote><p>默认值：0<br>是否必填：否<br>例如：<code>stdout_capture_maxbytes = 1MB</code></p><h6 id="stdout-events-enabled"><a href="#stdout-events-enabled" class="headerlink" title="stdout_events_enabled"></a>stdout_events_enabled</h6><blockquote><p>当设置为 true，子进程向 stdout 文件描述符写数据的时候，supervisord 将发送 <code>PROCESS_LOG_STDOUT</code> 类型的事件。</p></blockquote><p>默认值：0<br>是否必填：否<br>例如：<code>stdout_events_enabled = 0</code></p><h6 id="stdout-syslog"><a href="#stdout-syslog" class="headerlink" title="stdout_syslog"></a>stdout_syslog</h6><blockquote><p>如果为 true，则子进程标准输出与子进程的名字一同被定向到 syslog。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>stdout_syslog = false</code></p><h6 id="stderr-logfile"><a href="#stderr-logfile" class="headerlink" title="stderr_logfile"></a>stderr_logfile</h6><blockquote><p><code>redirect_stderr = false</code> 的情况下，子进程的错误输出写入指定的文件。</p></blockquote><p>默认值：AUTO<br>是否必填：否<br>例如：<code>stderr_logfile = /tmp/process-stderr.log</code></p><h6 id="stderr-logfile-maxbytes"><a href="#stderr-logfile-maxbytes" class="headerlink" title="stderr_logfile_maxbytes"></a>stderr_logfile_maxbytes</h6><blockquote><p>作用与 stdout_logfile_maxbytes 相同，只不过作用与子进程的错误输出。</p></blockquote><p>默认值：50MB<br>是否必填：否<br>例如：<code>stderr_logfile_maxbytes = 50MB</code></p><h6 id="stderr-logfile-backups"><a href="#stderr-logfile-backups" class="headerlink" title="stderr_logfile_backups"></a>stderr_logfile_backups</h6><blockquote><p>作用与 stdout_logfile_backups 相同，只不过作用与子进程的错误输出。</p></blockquote><p>默认值：10<br>是否必填：否<br>例如：<code>stderr_logfile_backups = 10</code></p><h6 id="stderr-capture-maxbytes"><a href="#stderr-capture-maxbytes" class="headerlink" title="stderr_capture_maxbytes"></a>stderr_capture_maxbytes</h6><blockquote><p>作用与 stdout_capture_maxbytes 相同，只不过作用与子进程的错误输出。</p></blockquote><p>默认值：0<br>是否必填：否<br>例如：<code>stderr_capture_maxbytes = 1MB</code></p><h6 id="stderr-events-enabled"><a href="#stderr-events-enabled" class="headerlink" title="stderr_events_enabled"></a>stderr_events_enabled</h6><blockquote><p>作用与 stdout_events_enabled 相同，只不过作用与子进程的错误输出。</p></blockquote><p>默认值：0<br>是否必填：否<br>例如：<code>stderr_events_enabled = 0</code></p><h6 id="stderr-syslog"><a href="#stderr-syslog" class="headerlink" title="stderr_syslog"></a>stderr_syslog</h6><blockquote><p>作用与 stdout_syslog 相同，只不过作用与子进程的错误输出。</p></blockquote><p>默认值：false<br>是否必填：否<br>例如：<code>stderr_syslog = false</code></p><h6 id="environment-1"><a href="#environment-1" class="headerlink" title="environment"></a>environment</h6><blockquote><p>用于设置子进程启动时的环境变量。</p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>environment = HOME=&quot;/home/user&quot;,USER=&quot;user&quot;</code></p><p><strong>注意</strong>：多个环境变量用逗号隔开，此环境变量是子进程独享的，不与其他进程共享。</p><h6 id="directory-1"><a href="#directory-1" class="headerlink" title="directory"></a>directory</h6><blockquote><p>运行子进程前，会先切换到这个目录。</p></blockquote><p>默认值：继承 supervisord 的目录<br>是否必填：否<br>例如：<code>directory = /tmp</code></p><h6 id="umask-1"><a href="#umask-1" class="headerlink" title="umask"></a>umask</h6><blockquote><p>子进程创建文件的 umask。</p></blockquote><p>默认值：继承 supervisord 的 umask<br>是否必填：否<br>例如：<code>umask = 022</code></p><h6 id="serverurl-1"><a href="#serverurl-1" class="headerlink" title="serverurl"></a>serverurl</h6><blockquote><p>supervisord 将 serverurl 的值通过环境变量传递给子进程，子进程可以通过读取环境变量 <code>SUPERVISOR_SERVER_URL</code> 来获取值。</p></blockquote><p>默认值：AUTO<br>是否必填：否<br>例如：<code>serverurl = AUTO</code></p><h5 id="include"><a href="#include" class="headerlink" title="[include]"></a>[include]</h5><p>此配置项用于定义包含其他配置文件。</p><h6 id="files"><a href="#files" class="headerlink" title="files"></a>files</h6><blockquote><p>定义其他配置文件的路径，可以使用通配符来匹配文件。</p></blockquote><p>默认值：无<br>是否必填：否<br>例如：<code>files = /etc/supervisord.d/*.conf</code></p><p><strong>注意</strong>：我们应该养成良好的习惯，将子进程相关的配置放到 <code>/etc/supervisord.d/</code> 下而不是和 supervisord.conf 放到一起。</p><h5 id="group-xxx"><a href="#group-xxx" class="headerlink" title="[group:xxx]"></a>[group:xxx]</h5><p>进程组相关的配置。<code>[group:xxx]</code> 中的 <code>xxx</code> 是分组名称。</p><h6 id="programs"><a href="#programs" class="headerlink" title="programs"></a>programs</h6><blockquote><p>配置哪些进程属于这个分组</p></blockquote><p>默认值：无<br>是否必填：是<br>例如：<code>programs = bar,foo</code></p><h6 id="priority-1"><a href="#priority-1" class="headerlink" title="priority"></a>priority</h6><blockquote><p>进程组的优先级</p></blockquote><p>默认值：999<br>是否必填：否<br>例如：<code>priority = 999</code></p><h5 id="fcgi-program-xxx"><a href="#fcgi-program-xxx" class="headerlink" title="[fcgi-program:xxx]"></a>[fcgi-program:xxx]</h5><p>提供对 fast-cgi 程序的支持，这里不做过多讲解。</p><h5 id="eventlistener-xxx"><a href="#eventlistener-xxx" class="headerlink" title="[eventlistener:xxx]"></a>[eventlistener:xxx]</h5><p>事件监听器相关配置，地位和 program 一样，也是 supervisord 的子进程，只不过主要功能用于订阅 supervisord 发送的事件，我们可以在事件监听器中做一系列的处理。supervisor 中事件监听相关的用法，后面的章节会详细介绍。</p><p>事件监听器除了支持 program 所有的配置外，还支持以下几个特有的配置</p><h6 id="buffer-size"><a href="#buffer-size" class="headerlink" title="buffer_size"></a>buffer_size</h6><blockquote><p>事件监听器的事件队列缓冲区大小，当事件缓冲区溢出时，将丢弃缓冲区中最旧的事件。</p></blockquote><p>默认值：10<br>是否必填：否<br>例如：<code>buffer_size = 10</code></p><h6 id="events"><a href="#events" class="headerlink" title="events"></a>events</h6><blockquote><p>事件的类型，只有在这里定义了的事件才会被发送给事件的订阅者。</p></blockquote><p>默认值：无<br>是否必填：是<br>例如：<code>events = PROCESS_STATE_STARTING</code></p><h6 id="result-handler"><a href="#result-handler" class="headerlink" title="result_handler"></a>result_handler</h6><blockquote><p>一个 <code>pkg_resources</code> 入口点的字符串解析为 Python 可调用。默认值是 <code>supervisor.dispatchers:default_handler</code>。</p></blockquote><p>默认值：<code>supervisor.dispatchers:default_handler</code><br>是否必填：否<br>例如：<code>result_handler = supervisor.dispatchers:default_handler</code></p><h5 id="rpcinterface-supervisor"><a href="#rpcinterface-supervisor" class="headerlink" title="[rpcinterface:supervisor]"></a>[rpcinterface:supervisor]</h5><p>这个配置项作用与 <code>HTTP/XML-RPC</code>，如果想使用 Web 管理或者 supervisorctl 管理 supervisord，则必须开启此项。如果想添加 RPC 接口来自定义 supervisor 的功能，可以查看官方文档获取更详细的教程。</p><h6 id="supervisor-rpcinterface-factory"><a href="#supervisor-rpcinterface-factory" class="headerlink" title="supervisor.rpcinterface_factory"></a>supervisor.rpcinterface_factory</h6><blockquote><p>RPC 接口的入口工厂函数。</p></blockquote><p>默认值：<code>supervisor.rpcinterface:make_main_rpcinterface</code><br>是否必填：否<br>例如：<code>supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface</code></p><h3 id="子进程状态"><a href="#子进程状态" class="headerlink" title="子进程状态"></a>子进程状态</h3><ul><li><code>STOPPED</code>：通过 stop 命令停止或从未启动过的进程状态。</li><li><code>STARTING</code>：接收到 start 命令进程正在启动中。</li><li><code>RUNNING</code>：进程正在运行。</li><li><code>BACKOFF</code>：进程进入 STARTING 状态后退出太快而无法进入 RUNNING 状态。</li><li><code>STOPPING</code>： 接收到 stop 命令进程正在停止中。</li><li><code>EXITED</code>：进程意外的从 RUNNING 状态退出。</li><li><code>FATAL</code>：程序无法启动成功。</li><li><code>UNKNOWN</code>：未知状态，一般属于 supervisord 进程的错误。</li></ul><h3 id="事件处理"><a href="#事件处理" class="headerlink" title="事件处理"></a>事件处理</h3><blockquote><p>事件是 supervisor 的一个高级特性，常用于被管理的子进程崩溃的时候发送报警等额外操作。</p></blockquote><p>supervisord 会在子进程运行的各各阶段发出不同的事件，只要定义了事件监听器，并订阅相应的事件，就可以在事件触发后对这些事件进行额外的处理。事件监听器是作为 supervisord 的子进程存在，事件通知协议是通过子进程的标准输入和标准输出来通信。supervisord 将特殊格式的字符串通过标准输入传递给子进程，子进程将结果通过标准输出返回给 supervisord。因此 事件监听器可以由任何语言来写，但是 supervisor 为 Python 提供了 <code>supervisor.childutils</code> 模块来简化了通信过程，因此会比其他语言更方便些。</p><h4 id="事件通知消息格式"><a href="#事件通知消息格式" class="headerlink" title="事件通知消息格式"></a>事件通知消息格式</h4><blockquote><p>在编写事件监听器之前我们需要先知道 supervisord 和事件监听器交流的数据格式是什么。</p></blockquote><h5 id="消息-head"><a href="#消息-head" class="headerlink" title="消息 head"></a>消息 head</h5><p>事件通知消息分为两部分 <code>head</code> 和 <code>body</code>。以下是 <code>head</code> 部分的格式样例：</p><pre><code>ver:3.0 server:supervisor serial:15 pool:pyhttp_eventlistener poolserial:2 eventname:PROCESS_STATE_RUNNING len:66</code></pre><table><thead><tr><th>键</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>ver</td><td>事件协议的版本</td><td>3.0</td></tr><tr><td>server</td><td>supervisord 的标识符</td><td>supervisor</td></tr><tr><td>serial</td><td>事件编号</td><td>15</td></tr><tr><td>pool</td><td>生成此事件的事件侦听器池的名称</td><td>pyhttp_eventlistener</td></tr><tr><td>poolserial</td><td>事件池的编号</td><td>2</td></tr><tr><td>eventname</td><td>事件名称</td><td>PROCESS_STATE_RUNNING</td></tr><tr><td>len</td><td>data长度，这个非常重要</td><td>66</td></tr></tbody></table><h5 id="消息-body"><a href="#消息-body" class="headerlink" title="消息 body"></a>消息 body</h5><p>根据 <code>head</code> 中的 <code>len</code> 字段，可以得知 <code>data</code> 的长度，然后通过长度可以读取到完整的 <code>data</code> 内容了。以下是 <code>data</code> 部分示例：</p><pre><code>processname:pyhttp2 groupname:pyhttp2 from_state:STARTING pid:9896</code></pre><table><thead><tr><th>键</th><th>描述</th><th>示例</th></tr></thead><tbody><tr><td>processname</td><td>进程名</td><td>pyhttp2</td></tr><tr><td>groupname</td><td>进程组名</td><td>pyhttp2</td></tr><tr><td>from_state</td><td>上一次的进程状态</td><td>STARTING</td></tr><tr><td>pid</td><td>进程ID</td><td>9896</td></tr></tbody></table><h4 id="事件监听器消息通知"><a href="#事件监听器消息通知" class="headerlink" title="事件监听器消息通知"></a>事件监听器消息通知</h4><blockquote><p>事件监听器也有自己的状态和事件需要通知给 supervisord，例如在某个事件监听器正在工作，没法处理新事件时，supervisord 将不会发送通知给这个事件监听器。</p></blockquote><h5 id="事件监听器状态"><a href="#事件监听器状态" class="headerlink" title="事件监听器状态"></a>事件监听器状态</h5><p>事件监听器主要有三种状态：</p><table><thead><tr><th>键</th><th>描述</th></tr></thead><tbody><tr><td>ACKNOWLEDGED</td><td>事件监听器已确认（接受或拒绝）事件发送</td></tr><tr><td>READY</td><td>事件监听器已就绪</td></tr><tr><td>BUSY</td><td>事件监听器正在工作</td></tr></tbody></table><p>事件监听器首次启动时， supervisord 会自动将其设置为 <code>ACKNOWLEDGED</code> 状态，只有当监听器通过标准输出发送 <code>READY\n</code> 时，supervisord 才会将事件通知给这个监听器，此时监听器将处于 <code>BUSY</code> 状态。直到事件监听器向 supervisord 发送 <code>RESULT 2\nOK</code> 或者 <code>RESULT 2\nFAIL</code> 时，监听器才会重新回到 <code>ACKNOWLEDGED</code> 状态。当监听器再次向 supervisord 发送 <code>READY\n</code> 后才可以继续接收到新的事件。</p><h5 id="事件监听器示例"><a href="#事件监听器示例" class="headerlink" title="事件监听器示例"></a>事件监听器示例</h5><p>编辑 <code>/root/listener.py</code> 写入如下内容：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">write_stdout</span><span class="params">(s)</span>:</span></span><br><span class="line">    sys.stdout.write(s)</span><br><span class="line">    sys.stdout.flush()</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="comment"># transition from ACKNOWLEDGED to READY</span></span><br><span class="line">        write_stdout(<span class="string">'READY\n'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># read header line and print it to stderr</span></span><br><span class="line">        line = sys.stdin.readline()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'event.log'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(line)</span><br><span class="line"></span><br><span class="line">        headers = dict([ x.split(<span class="string">':'</span>) <span class="keyword">for</span> x <span class="keyword">in</span> line.split() ])</span><br><span class="line">        data = sys.stdin.read(int(headers[<span class="string">'len'</span>]))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'event.log'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(data)</span><br><span class="line">            f.write(<span class="string">'\n\n'</span>)</span><br><span class="line"></span><br><span class="line">        write_stdout(<span class="string">'RESULT 2\nOK'</span>)</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>这段代码简单的将从 supervisord 接收到的事件通知写入 event.log 文件，然后继续下一次的接受通知。</p><p>接着将以下配置项追加到 <code>/etc/supervisord.conf</code>：</p><pre><code>[eventlistener:pyhttp_eventlistener]command=python3 /root/listener.pyevents=PROCESS_STATE</code></pre><p>这个事件监听器订阅了 <code>PROCESS_STATE</code> 事件，这个事件会在子进程状态改变时触发。更新 supervisord：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl updatepyhttp_eventlistener: stoppedpyhttp_eventlistener: updated process group(supervisor) root@ubuntu:~# supervisorctl statuspyhttp2                          RUNNING   pid 9896, uptime 0:55:57pyhttp_eventlistener             RUNNING   pid 10056, uptime 0:00:05simpleHttp:pyhttp                RUNNING   pid 9889, uptime 0:56:35simpleHttp:pyhttp1               RUNNING   pid 9888, uptime 0:56:35(supervisor) root@ubuntu:~#</code></pre><p>接着我们重启一个子进程，就可以看到 <code>event.log</code> 的内容了：</p><pre><code>(supervisor) root@ubuntu:~# supervisorctl restart simpleHttp:pyhttpsimpleHttp:pyhttp: stoppedsimpleHttp:pyhttp: started(supervisor) root@ubuntu:~# cat event.log ver:3.0 server:supervisor serial:76 pool:pyhttp_eventlistener poolserial:2 eventname:PROCESS_STATE_STOPPING len:67processname:pyhttp groupname:simpleHttp from_state:RUNNING pid:9889ver:3.0 server:supervisor serial:77 pool:pyhttp_eventlistener poolserial:3 eventname:PROCESS_STATE_STOPPED len:68processname:pyhttp groupname:simpleHttp from_state:STOPPING pid:9889ver:3.0 server:supervisor serial:78 pool:pyhttp_eventlistener poolserial:4 eventname:PROCESS_STATE_STARTING len:66processname:pyhttp groupname:simpleHttp from_state:STOPPED tries:0ver:3.0 server:supervisor serial:79 pool:pyhttp_eventlistener poolserial:5 eventname:PROCESS_STATE_RUNNING len:69processname:pyhttp groupname:simpleHttp from_state:STARTING pid:10068</code></pre><p>日志中记录了 <code>simpleHttp:pyhttp</code> 进程从退出到重启成功过程中所有的事件。</p><p>如果使用 Python 编写监听器，<code>supervisor.childutils</code> 可以更方便的帮助我们处理事件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> supervisor <span class="keyword">import</span> childutils</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        headers, payload = childutils.listener.wait(sys.stdin, sys.stdout)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">with</span> open(<span class="string">'event.pro.log'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(json.dumps(headers))</span><br><span class="line">        childutils.listener.ok(sys.stdout)</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure><p>supervisord 将事件监听器也当作普通子进程管理，所以事件监听器的配置项包含了所有 <code>[program:xxx]</code> 的配置，不过事件监听器配置项必须存在一个 <code>events</code> 的配置用来定义监听器订阅的事件。</p><h4 id="事件类型"><a href="#事件类型" class="headerlink" title="事件类型"></a>事件类型</h4><blockquote><p>以下是可以被订阅的所有事件名和它的作用。</p></blockquote><h5 id="EVENT"><a href="#EVENT" class="headerlink" title="EVENT"></a>EVENT</h5><p>基本事件类型，所有事件的父类，订阅此事件会接收所有的事件类型，但永远不会接收到此事件。</p><h5 id="PROCESS-STATE"><a href="#PROCESS-STATE" class="headerlink" title="PROCESS_STATE"></a>PROCESS_STATE</h5><p>表示进程由一种状态转为另一种状态，订阅者永远不会收到此类型的事件，但是订阅此事件可以接收所有此事件类型的子类。</p><h5 id="PROCESS-STATE-STARTING"><a href="#PROCESS-STATE-STARTING" class="headerlink" title="PROCESS_STATE_STARTING"></a>PROCESS_STATE_STARTING</h5><p>进程状态变成 <code>STARTING</code> 时会触发此事件。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:STOPPED tries:0</code></pre><h5 id="PROCESS-STATE-RUNNING"><a href="#PROCESS-STATE-RUNNING" class="headerlink" title="PROCESS_STATE_RUNNING"></a>PROCESS_STATE_RUNNING</h5><p>进程状态变成 <code>RUNNING</code> 时会触发此事件。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:STARTING pid:2766</code></pre><h5 id="PROCESS-STATE-BACKOFF"><a href="#PROCESS-STATE-BACKOFF" class="headerlink" title="PROCESS_STATE_BACKOFF"></a>PROCESS_STATE_BACKOFF</h5><p>进程状态变成 <code>BACKOFF</code> 时会触发此事件，表示进程未成功启动。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:STOPPED tries:0</code></pre><p>tries 字段表示已经尝试重启的次数。</p><h5 id="PROCESS-STATE-STOPPING"><a href="#PROCESS-STATE-STOPPING" class="headerlink" title="PROCESS_STATE_STOPPING"></a>PROCESS_STATE_STOPPING</h5><p>进程状态变成 <code>STOPPING</code> 时会触发此事件。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:STARTING pid:2766</code></pre><h5 id="PROCESS-STATE-EXITED"><a href="#PROCESS-STATE-EXITED" class="headerlink" title="PROCESS_STATE_EXITED"></a>PROCESS_STATE_EXITED</h5><p>进程状态变成 <code>EXITED</code> 时会触发此事件。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:RUNNING expected:0 pid:2766</code></pre><p>expected 字段用来标识进程是否是正常退出，如果是非正常退出，它的值是 0。</p><h5 id="PROCESS-STATE-STOPPED"><a href="#PROCESS-STATE-STOPPED" class="headerlink" title="PROCESS_STATE_STOPPED"></a>PROCESS_STATE_STOPPED</h5><p>进程状态变成 <code>STOPPED</code> 时会触发此事件。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:STOPPING pid:2766</code></pre><h5 id="PROCESS-STATE-FATAL"><a href="#PROCESS-STATE-FATAL" class="headerlink" title="PROCESS_STATE_FATAL"></a>PROCESS_STATE_FATAL</h5><p>进程状态变成 <code>FATAL</code> 时会触发此事件。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:BACKOFF</code></pre><h5 id="PROCESS-STATE-UNKNOWN"><a href="#PROCESS-STATE-UNKNOWN" class="headerlink" title="PROCESS_STATE_UNKNOWN"></a>PROCESS_STATE_UNKNOWN</h5><p>进程状态变成 <code>UNKNOWN</code> 时会触发此事件，只有 supervisord 发生错误时才会导致此状态。父类是 <code>PROCESS_STATE</code>。</p><p>事件内容示例：</p><pre><code>processname:cat groupname:cat from_state:BACKOFF</code></pre><h5 id="REMOTE-COMMUNICATION"><a href="#REMOTE-COMMUNICATION" class="headerlink" title="REMOTE_COMMUNICATION"></a>REMOTE_COMMUNICATION</h5><p>在 supervisord 的 RPC 接口上调用 <code>supervisor.sendRemoteCommEvent()</code> 方法时触发。父类是 EVENT。</p><p>事件内容示例：</p><pre><code>type:typedata</code></pre><h5 id="PROCESS-LOG"><a href="#PROCESS-LOG" class="headerlink" title="PROCESS_LOG"></a>PROCESS_LOG</h5><p>进程写入 stdout 或 stderr 时触发。只有 <code>stdout_events_enabled</code> 或 <code>stderr_events_enabled</code> 为 true 时且未处于捕获模式才生效。订阅者永远不会收到此类型的事件，但是订阅此事件可以接收所有此事件类型的子类。</p><h5 id="PROCESS-LOG-STDOUT"><a href="#PROCESS-LOG-STDOUT" class="headerlink" title="PROCESS_LOG_STDOUT"></a>PROCESS_LOG_STDOUT</h5><p>表示子进程已经写入了 stdout 文件描述符。</p><p>事件内容示例：</p><pre><code>processname:name groupname:name pid:piddata</code></pre><h5 id="PROCESS-LOG-STDERR"><a href="#PROCESS-LOG-STDERR" class="headerlink" title="PROCESS_LOG_STDERR"></a>PROCESS_LOG_STDERR</h5><p>表示子进程已经写入了 stderr 文件描述符。</p><p>事件内容示例：</p><pre><code>processname:name groupname:name pid:piddata</code></pre><h5 id="PROCESS-COMMUNICATION"><a href="#PROCESS-COMMUNICATION" class="headerlink" title="PROCESS_COMMUNICATION"></a>PROCESS_COMMUNICATION</h5><p>只有 <code>stdout_capture_maxbytes</code> 或 <code>stderr_capture_maxbytes</code> 的值不为 0 时，子进程在向 stdout 或者 stderr 中输出 <code>&lt;!--XSUPERVISOR:BEGIN--&gt;</code> 和 <code>&lt;!--XSUPERVISOR:END--&gt;</code> 标签时会触发此类型事件的子类。标签中的内容会被作为事件日志发送给订阅者。</p><h5 id="PROCESS-COMMUNICATION-STDOUT"><a href="#PROCESS-COMMUNICATION-STDOUT" class="headerlink" title="PROCESS_COMMUNICATION_STDOUT"></a>PROCESS_COMMUNICATION_STDOUT</h5><p>子进程通过 stdout 向 supervisord 发送消息。</p><p>例如子进程在 stdout 中输出了 <code>&lt;!--XSUPERVISOR:BEGIN--&gt;message_from:fgtest&lt;!--XSUPERVISOR:END--&gt;</code>，订阅此事件的监听者会收到：</p><pre><code>processname:fgtest groupname:fgtest pid:10902message_from:fgtest</code></pre><h5 id="PROCESS-COMMUNICATION-STDERR"><a href="#PROCESS-COMMUNICATION-STDERR" class="headerlink" title="PROCESS_COMMUNICATION_STDERR"></a>PROCESS_COMMUNICATION_STDERR</h5><p>子进程通过 stderr 向 supervisord 发送消息。</p><h5 id="SUPERVISOR-STATE-CHANGE"><a href="#SUPERVISOR-STATE-CHANGE" class="headerlink" title="SUPERVISOR_STATE_CHANGE"></a>SUPERVISOR_STATE_CHANGE</h5><p>当 supervisord 进程的状态发送变化时引发的事件类型。订阅者永远不会收到此类型的事件，但是订阅此事件可以接收所有此事件类型的子类。</p><h5 id="SUPERVISOR-STATE-CHANGE-RUNNING"><a href="#SUPERVISOR-STATE-CHANGE-RUNNING" class="headerlink" title="SUPERVISOR_STATE_CHANGE_RUNNING"></a>SUPERVISOR_STATE_CHANGE_RUNNING</h5><p>supervisord 进程启动会发送此事件，事件消息体为空字符串。</p><h5 id="SUPERVISOR-STATE-CHANGE-STOPPING"><a href="#SUPERVISOR-STATE-CHANGE-STOPPING" class="headerlink" title="SUPERVISOR_STATE_CHANGE_STOPPING"></a>SUPERVISOR_STATE_CHANGE_STOPPING</h5><p>supervisord 进程停止会发送此事件，事件消息体为空字符串。</p><h5 id="TICK"><a href="#TICK" class="headerlink" title="TICK"></a>TICK</h5><p>监听者会隔 5、60、360 秒被事件唤醒，订阅者永远不会收到此类型的事件，但是订阅此事件可以接收所有此事件类型的子类。</p><h5 id="TICK-5"><a href="#TICK-5" class="headerlink" title="TICK_5"></a>TICK_5</h5><p>每隔 5 秒会通过此类型事件唤醒监听者。</p><p>事件内容示例：</p><pre><code>when:1201063880</code></pre><h5 id="TICK-60"><a href="#TICK-60" class="headerlink" title="TICK_60"></a>TICK_60</h5><p>每隔 60 秒会通过此类型事件唤醒监听者。</p><p>事件内容示例：</p><pre><code>when:1201063880</code></pre><h5 id="TICK-3600"><a href="#TICK-3600" class="headerlink" title="TICK_3600"></a>TICK_3600</h5><p>每隔 3600 秒会通过此类型事件唤醒监听者。</p><p>事件内容示例：</p><pre><code>when:1201063880</code></pre><h5 id="PROCESS-GROUP"><a href="#PROCESS-GROUP" class="headerlink" title="PROCESS_GROUP"></a>PROCESS_GROUP</h5><p>将进程组从 supervisord 中添加或删除会触发的事件类型。订阅者永远不会收到此类型的事件，但是订阅此事件可以接收所有此事件类型的子类。</p><h5 id="PROCESS-GROUP-ADDED"><a href="#PROCESS-GROUP-ADDED" class="headerlink" title="PROCESS_GROUP_ADDED"></a>PROCESS_GROUP_ADDED</h5><p>添加进程组将会触发这个事件</p><p>事件内容示例：</p><pre><code>groupname:cat</code></pre><h5 id="PROCESS-GROUP-REMOVED"><a href="#PROCESS-GROUP-REMOVED" class="headerlink" title="PROCESS_GROUP_REMOVED"></a>PROCESS_GROUP_REMOVED</h5><p>删除进程组将会触发这个事件</p><p>事件内容示例：</p><pre><code>groupname:cat</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="配置开机自启-supervisord"><a href="#配置开机自启-supervisord" class="headerlink" title="配置开机自启 supervisord"></a>配置开机自启 supervisord</h3><p>将 <code>/data/venv/supervisor/bin/supervisord -c /etc/supervisord.conf</code> 添加到 <code>/etc/rc.local</code> 即可。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Supervisor 是用 Python 开发的一个 C/S 架构的进程管理工具，只可以用 Linux/Unix 系统下。在 Linux 系统上，通常的做法是为每个需要控制的服务编写 rc.d 脚本，之后通过 service 或者 systemctl 来管理和控制服务，但是在程序崩溃的时候却无法自动重启项目。Supervisor 将它管理的服务作为它的子进程，所以可以简单且精确的管理和控制这些服务。&lt;a href=&quot;http://www.supervisord.org/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;官方文档&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/categories/Python/"/>
    
    
      <category term="python" scheme="http://www.yunfwe.cn/tags/python/"/>
    
      <category term="supervisor" scheme="http://www.yunfwe.cn/tags/supervisor/"/>
    
  </entry>
  
  <entry>
    <title>回调地狱的终结：Pormise &amp; Async</title>
    <link href="http://www.yunfwe.cn/2018/12/31/2018/%E5%9B%9E%E8%B0%83%E5%9C%B0%E7%8B%B1%E7%9A%84%E7%BB%88%E7%BB%93%EF%BC%9APormise%20&amp;%20Async/"/>
    <id>http://www.yunfwe.cn/2018/12/31/2018/%E5%9B%9E%E8%B0%83%E5%9C%B0%E7%8B%B1%E7%9A%84%E7%BB%88%E7%BB%93%EF%BC%9APormise%20&amp;%20Async/</id>
    <published>2018-12-30T16:00:00.000Z</published>
    <updated>2018-12-30T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>由于 JavaScript 是一门单线程，事件驱动的语言，因此异步编程方式是它一个非常重要的特性。无论是客户端的 JavaScript 还是服务端的 JavaScript 在处理 HTTP请求响应、事件监听、文件读取等操作时都避不开回调，如果异步的事件需要嵌套执行，那么回调给代码结构和可读性简直带来了灾难，这个被后人称之为：回调地狱。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><blockquote><p>由于大多数浏览器环境不支持 async/await 这些 ES8 提案才支持的语法，因此 JavaScript 执行环境选择 Node.js。浏览器不支持包含 ES7/ES8 的语法特性的代码，可以通过 Babel 等工具转为低版本 JavaScript 语法运行。</p></blockquote><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>操作系统</td><td>Windows 10</td></tr><tr><td>Node.js</td><td>v10.13.0</td></tr></tbody></table><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><h3 id="经典回调问题"><a href="#经典回调问题" class="headerlink" title="经典回调问题"></a>经典回调问题</h3><p>JavaScript 中对异步事件处理是通过给异步事件传递处理函数的方式，也就是回调（callback）来完成，下面看一个例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">    以 utf-8 编码打开当前目录下 aaa.txt 文件。</span></span><br><span class="line"><span class="comment">    如果回调函数执行失败，则打印失败原因，否则打印文件内容。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fs.readFile(<span class="string">"aaa.txt"</span>, <span class="string">"utf-8"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err.message)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>这是一个经典的 JavaScript 处理异步事件的方法，我们将对数据的后续处理写成函数传递给 <code>fs.readFile</code> 方法，文件读取成功后 <code>fs.readFile</code> 会自动调用我们传递给它的函数。</p><p>现在我们需要进行秩序的读取三个甚至更多的文件，只有在 <code>aaa.txt</code> 读取完成后再继续读取 <code>bbb.txt</code>，接着再读取 <code>ccc.txt</code>。传统的解决方案应该会写出下面的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"><span class="comment">/* </span></span><br><span class="line"><span class="comment">    以 utf-8 编码打开当前目录下 aaa.txt 文件。</span></span><br><span class="line"><span class="comment">    如果回调函数执行失败，则打印失败原因，否则打印文件内容。</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">fs.readFile(<span class="string">"aaa.txt"</span>, <span class="string">"utf-8"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err.message)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(data)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续读取 bbb.txt</span></span><br><span class="line">    fs.readFile(<span class="string">"bbb.txt"</span>, <span class="string">"utf-8"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(err.message)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(data)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 继续读取 ccc.txt</span></span><br><span class="line">        fs.readFile(<span class="string">"ccc.txt"</span>, <span class="string">"utf-8"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(err.message)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>如果还要继续读取更多的文件，并对文件内容进行操作，那之后的代码也都要写在回调函数中，会造成嵌套越来越多。这样对代码的可读性和日后的维护都带来了很大挑战。</p><p>随着 JavaScript 能干的事情越来越多，人们已经不满足只用它来处理一些简单的事情了，当随着代码越来越多，项目工程越来越大，JavaScript 的不断发展中，势必会寻找一些解决方案来应对这些问题。</p><p>之前最流行的是 2009 年 12 月发布的 ES5 标准，终于在 2015 年的 6 月 ES6 发布了，这是个历经 6 年沉淀出的版本，给 JavaScript 带来了大量的新特性并保持了向下的兼容，其中对异步回调地狱的解决方案：<code>Promise</code> 就是这个版本带来的特性之一。</p><p>JavaScript 设计时的缺陷，历史包袱等原因，后面新的版本带来新特性的同时，又要对之前代码保持兼容，现在 JavaScript 各种功能重复又不相同的 API 也让人一言难尽。。。</p><h3 id="当代的-Promise"><a href="#当代的-Promise" class="headerlink" title="当代的 Promise"></a>当代的 Promise</h3><p><code>Promise</code>：承诺的意思，你可以通过 <code>Promise</code> 封装一个异步事件，并且在事件创建后再将回调函数传递给 <code>Promise</code>，而 <code>Promise</code> 则向你承诺异步事件有结果的时候，会调用之后传给 <code>Promise</code> 的处理函数。而传统的回调，是在事件创建之初就一并将回调函数传递过去的。</p><h4 id="Promise-基本概念"><a href="#Promise-基本概念" class="headerlink" title="Promise 基本概念"></a>Promise 基本概念</h4><p>在浏览器环境或者 Node.js 环境中，<code>Promise</code> 是一个全局的构造函数。<code>Promise</code> 构造函数接受一个函数作为参数，我们需要封装的异步事件，就是写在这个函数中的。这个函数的主要作用只是为了封装异步事件为一个 <code>Promise</code> 对象，那么异步事件的正常结果和异次结果又该如何处理呢？</p><p>答案是这个函数会接收两个函数作为参数，一个用来处理正常结果的，一个用来处理异次结果。大致样子如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="comment">/* 异步操作成功 */</span>) &#123;</span><br><span class="line">        resolve(data)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reject(err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>resolve</code> 和 <code>reject</code> 这里都只是形参，当一个 <code>Promise</code> 对象创建的时候，传递的函数就立即执行了。函数的执行会产生三种状态：<code>pending</code>、<code>fulfilled</code>、<code>rejected</code>。</p><ul><li><code>pending</code>：异步事件初始化，还没有结果的时候。</li><li><code>fulfilled</code>：在函数中调用 <code>resolve</code> 方法后将触发 <code>Promise</code> 对象的状态更改为 <code>fulfilled</code>，表示异步事件正常结束。</li><li><code>rejected</code>：当异步事件抛出异常时，我们调用这个函数将触发 <code>Promise</code> 对象的状态更改为 <code>rejected</code>，表示异步事件异常结束。</li></ul><p>之后我们就可以给 <code>Promise</code> 绑定 <code>fulfilled</code> 和 <code>rejected</code> 状态的回调函数了，我们通过 <code>Promise.prototype.then()</code> 函数来将 <code>fulfilled</code> 和 <code>rejected</code> 状态的处理函数传递进去：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 当 Promise 的状态变为 fulfilled 的时候执行的回调</span></span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 当 Promise 的状态变为 rejected 的时候执行的回调</span></span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在封装 <code>Promise</code> 对象中通过 <code>resolve(data)</code> 可以将异步事件返回的数据传递出去，然后由 <code>.then()</code> 的第一个回调函数来接收，因此我们就可以将对异步事件结果的处理过程写在 <code>.then()</code> 的第一个回调函数中了。同理，对异常结果的处理在 <code>.then()</code> 的第二个回调函数中处理。</p><p>如果不需要对异常情况进行处理，对异常处理的回调函数在 <code>.then()</code> 中是可以省略的，也就是说，可以只给 <code>.then()</code> 传递一个正常结果处理的回调即可。</p><h4 id="Promise-初体验"><a href="#Promise-初体验" class="headerlink" title="Promise 初体验"></a>Promise 初体验</h4><p>说了这么多，现在就看看怎么把之前出现的读取文件的例子用 <code>Promise</code> 改造一下，看看和传统的回调嵌套有什么本质上的不同。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">    fs.readFile(<span class="string">"aaa.txt"</span>, <span class="string">"utf-8"</span>, (err, data)=&gt;&#123;</span><br><span class="line">        <span class="comment">/* </span></span><br><span class="line"><span class="comment">            由于作用域的原因，如果给 readFile 的回调使用 function()，</span></span><br><span class="line"><span class="comment">            那么将无法访问 resolve 和 reject 方法了。</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            reject(err)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            resolve(data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">promise.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理成功读取到文件内容的回调函数</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理读取文件异常的回调函数</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'失败原因：'</span> + err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>当文件正常读取后的执行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js文件内容：Hello! this is aaa.txt</code></pre><p>当文件不存在的执行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js失败原因：ENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\aaa.txt&apos;</code></pre><p>结果与我们预料的相同，接下来读取多个文件，我们总不能为每个文件都单独写一串封装为 <code>Promise</code> 对象的代码吧，最好的做法是用一个构造函数，传给这个函数不同的文件名称，然后自动为我们返回一个封装好的 <code>Promise</code> 对象：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        fs.readFile(fileName, <span class="string">"utf-8"</span>, (err, data)=&gt;&#123;</span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">                由于作用域的原因，如果给 readFile 的回调使用 function()，</span></span><br><span class="line"><span class="comment">                那么将无法访问 resolve 和 reject 方法了。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们创建了一个新的 <code>readFile</code> 函数，这个函数会根据不同的文件名，自动返回一个封装好的 <code>Promise</code> 对象。如果我们想并发的读取多个文件，大可以这样来写：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">readFile(<span class="string">"aaa.txt"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;...&#125;)</span><br><span class="line">readFile(<span class="string">"bbb.txt"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;...&#125;)</span><br><span class="line">readFile(<span class="string">"ccc.txt"</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;...&#125;)</span><br></pre></td></tr></table></figure><p>但是这并不能满足我们读完 <code>aaa.txt</code> 再继续往下读取的意愿，那么我们可以让第一个文件的处理结束后，返回第二个文件的 <code>Promise</code> 对象，然后通过 <code>.then()</code> 进行链式调用的方法依次读取：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        fs.readFile(fileName, <span class="string">"utf-8"</span>, (err, data)=&gt;&#123;</span><br><span class="line">            <span class="comment">/* </span></span><br><span class="line"><span class="comment">                由于作用域的原因，如果给 readFile 的回调使用 function()，</span></span><br><span class="line"><span class="comment">                那么将无法访问 resolve 和 reject 方法了。</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 aaa.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'失败原因：'</span> + err.message)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 bbb.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'失败原因：'</span> + err.message)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 ccc.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'失败原因：'</span> + err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></div></div><p>当文件都正常读取的情况下：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js文件内容：Hello! this is aaa.txt文件内容：Hello! this is bbb.txt文件内容：Hello! this is ccc.txt</code></pre><p>这中写法，即使我们要读取再多的文件，也只需要依次往下排列代码就行了，并不需要对代码进行嵌套，也更不存在回调地狱的问题了。但是如果遇到一个文件读取失败呢？可达鸭眉头一皱发现事情并不简单</p><p><code>bbb.txt</code> 读取失败的情况：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js文件内容：Hello! this is aaa.txt失败原因：ENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;文件内容：undefined</code></pre><p>因为 <code>bbb.txt</code> 不存在，所以 <code>Promise</code> 里触发了 <code>fulfilled</code> 状态，那么执行的就是错误处理的方法，然而在错误处理的方法中，我们并没有返回读取下一个文件的 <code>Promise</code> 对象。解决方法也很简单，就是在每一个 <code>Promise</code> 的异常处理函数中也返回下一个 <code>Promise</code>。。。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 aaa.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'失败原因：'</span> + err.message)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 bbb.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'失败原因：'</span> + err.message)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 ccc.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'失败原因：'</span> + err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js文件内容：Hello! this is aaa.txt失败原因：ENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;文件内容：Hello! this is ccc.txt</code></pre><h4 id="Promise-异常处理"><a href="#Promise-异常处理" class="headerlink" title="Promise 异常处理"></a>Promise 异常处理</h4><p>正常情况下，一把都是有关联的异步操作才会使用 <code>Promise</code> 来链起来执行，因为下一个异步操作可能会依赖于上一个异步操作的结果，如果其中一个异步操作失败，那么剩下的就没继续执行下去的意义了。如果我们为每个 <code>Promise</code> 对象都指定了异常处理回调，链中的某一个 <code>Promise</code> 即使触发了异常，整个链依然会继续执行下去的，虽然结果并不是我们想要的。</p><p>我们更希望的是，当某一个 <code>Promise</code> 发生异常的时候，就立即终止整个 <code>Promise</code> 链的执行，我们可以统一使用 <code>Promise.prototype.catch()</code> 来捕获异常并终止整个链。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 aaa.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 bbb.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 ccc.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>执行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js文件内容：Hello! this is aaa.txtENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;</code></pre><p><code>bbb.txt</code> 文件不存在，<code>.catch()</code> 捕获了这个异常并终止了接下来的执行。如果在 <code>.then()</code> 中产生的异常也会被 <code>.catch()</code> 捕获。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 aaa.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"手动触发的异常"</span>)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 bbb.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">    <span class="keyword">return</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">&#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span> (<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// 处理 ccc.txt</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'文件内容：'</span> + data)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js文件内容：Hello! this is aaa.txt手动触发的异常</code></pre><p>因此一般总是建议在 <code>Promise</code> 的后面跟上一个 <code>.catch()</code> 来处理已知的或者意料之外的异常。当然，你依然可以在 <code>.catch()</code> 中也返回一个 <code>Promise</code> 对象，然后继续用 <code>.then()</code> 进行其他的逻辑处理。<code>Promise</code> 最直接的好处就是链式调用。</p><h4 id="Promise-的其他用法"><a href="#Promise-的其他用法" class="headerlink" title="Promise 的其他用法"></a>Promise 的其他用法</h4><p>这里举例说明 <code>Pormise</code> 的几个其他常用的方法，其他更详细的 <code>Pormise</code> 用法可以查阅 MDN web docs：<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener">Pormise</a></p><h5 id="Pormise-all"><a href="#Pormise-all" class="headerlink" title="Pormise.all()"></a>Pormise.all()</h5><p><code>Pormise.all()</code> 接收一个由多个 <code>Promise</code> 对象组成的数组，只有这个数据里所有的 <code>Promise</code> 对象都完成的时候才会去调用 <code>.then()</code> 方法，否则有一个失败，那么整体就是 <code>rejected</code>：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        fs.readFile(fileName, <span class="string">"utf-8"</span>, (err, data)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Promise</span>.all([readFile(<span class="string">"aaa.txt"</span>), readFile(<span class="string">"bbb.txt"</span>), readFile(<span class="string">"ccc.txt"</span>)])</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>正常情况下返回的是个包含结果集的数组：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.js[ &apos;Hello! this is aaa.txt&apos;,  &apos;Hello! this is bbb.txt&apos;,  &apos;Hello! this is ccc.txt&apos; ]</code></pre><p>如果有一个异常，则会触发 <code>.catch()</code>：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;</code></pre><h5 id="Pormise-race"><a href="#Pormise-race" class="headerlink" title="Pormise.race()"></a>Pormise.race()</h5><p>与 <code>Pormise.all()</code> 用法相似，但是结果不同，<code>Pormise.race()</code> 中只要有一个 <code>Pormise</code> 对象率先改变状态（不管完成还是失败），那 <code>Pormise.race()</code> 之后 <code>.then()</code> 就都是对这一个改变状态了的 <code>Pormise</code> 的处理。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Promise</span>.race([readFile(<span class="string">"aaa.txt"</span>), readFile(<span class="string">"bbb.txt"</span>), readFile(<span class="string">"ccc.txt"</span>)])</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br><span class="line">.catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><code>aaa.txt</code> 先完成读取，所以只返回了 <code>aaa.txt</code> 的数据：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsHello! this is aaa.txt</code></pre><p>判断一个文件是否存在比读取文件内容快得多，所以 <code>bbb.txt</code> 不存在的情况下率先改变成了 <code>rejected</code> 状态：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;</code></pre><p>基于 <code>Pormise.race()</code> 的性质，我们可以给浏览器的 Ajax 请求添加超时的功能：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Pormise.race([$ajax.get(<span class="string">"/api"</span>), <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> reject(<span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'request timeout'</span>)), <span class="number">5000</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">])</span><br></pre></td></tr></table></figure><p>这样如果 <code>$ajax</code> 没有在 5 秒之内完成的话，<code>setTimeout</code> 就会将状态率先改为 <code>rejected</code> 了。</p><h3 id="未来的-Async"><a href="#未来的-Async" class="headerlink" title="未来的 Async"></a>未来的 Async</h3><p>之所以说 <code>async</code> 是未来的，是因为 ES8 的标准才引入了 <code>async</code> 关键字，<code>async</code> 是 <code>Generator</code> 的语法糖，而 <code>Generator</code> 是 ES6 提供的一种异步编程解决方案。以后使用 <code>async</code> 越来越多一定是个趋势。</p><p><code>async</code> 配合 <code>await</code> 可以让异步的代码看起来和同步的一样，并且可以使用 <code>try</code> 和 <code>catch</code> 来捕捉异步事件产生的异常。想了解这两个需要先熟悉什么是 <code>Generator</code>。</p><h4 id="Generator"><a href="#Generator" class="headerlink" title="Generator"></a>Generator</h4><h5 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h5><p><code>Generator</code>（生成器）是用于将一个函数变成 <code>Generator</code> 函数，这种函数的执行过程和普通函数不太一样，普通函数使用 <code>return</code> 返回值，而 <code>Generator</code> 函数中还可以使用 <code>yield</code> 返回值，并且 <code>yield</code> 还可以在函数内使用多次。<code>return</code> 返回值后整个函数就完成执行了，而 <code>yield</code> 只表示这个函数暂停了，下一次继续驱动 <code>Generator</code> 函数运行的时候，就会从上次暂停的地方继续运行。下面看一个简单的例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"hello"</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="string">"world"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>注意申明一个 <code>Generator</code> 函数和普通函数的不同，<code>Generator</code> 函数需要在 <code>function</code> 和函数名中间加上一个 <code>*</code>，加在哪里并不重要，<code>function *gen()</code> 和 <code>function*gen()</code> 都可以，但是推荐使用 <code>function* gen()</code> 这种方式。接着使用两个 <code>yield</code> 返回了两个字符串，下面看看如何运行这种函数：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node&gt; function* gen(){...     yield &quot;hello&quot;...     yield &quot;world&quot;... }undefined&gt; let f = gen()undefined&gt; fObject [Generator] {}&gt; f.next(){ value: &apos;hello&apos;, done: false }&gt; f.next(){ value: &apos;world&apos;, done: false }&gt; f.next(){ value: undefined, done: true }</code></pre><p>我们运行 <code>gen()</code> 后，返回的是一个 <code>Generator</code> 类型的对象，然后调用这个对象的 <code>next</code> 方法，返回了一个普通对象，这个对象的 <code>value</code> 属性是第一个 <code>yield</code> 返回的值，第二个属性 <code>done</code> 表示这个 <code>Generator</code> 函数是否运行结束。当第三次执行 <code>f.next()</code> 的时候，因为已经没有 <code>yield</code> 可以执行了所以 <code>done</code> 的值变成了 <code>true</code>。</p><h5 id="创建一个整数列表"><a href="#创建一个整数列表" class="headerlink" title="创建一个整数列表"></a>创建一个整数列表</h5><p>接下来使用一个小例子来更深入的了解下 <code>Generator</code> 函数的运行原理。我们编写一个 <code>range</code> 函数，传给它一个整数，然后返回从 0 到 传递的整数之间所有的整数，先看普通函数版本：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">range</span>(<span class="params">len</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> l = []</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++)&#123;</span><br><span class="line">        l.push(i)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> l</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><pre><code>&gt; range(5)[ 0, 1, 2, 3, 4 ]&gt; range(10)[ 0, 1, 2, 3, 4, 5, 6, 7, 8, 9 ]</code></pre><p>的确达到了我们的目的，但是这个函数有一个致命的缺陷，就是如果要生成的范围非常巨大，比如 <code>range(99999999999999)</code></p><pre><code>&gt; range(99999999999999)==== JS stack trace =========================================    0: ExitFrame [pc: 000003D44F75C5C1]Security context: 0x02931fb858a1 &lt;JSObject&gt;    1: range [000002931FBA36F9] [repl:~1] [pc=000003D44F7622DB](this=0x01e40aa9ad49 &lt;JSGlobal Object&gt;,len=0x02931fbbdf59 &lt;Number 1e+14&gt;)    2: /* anonymous */ [000002931FBBE1F9] [repl:1] [bytecode=000002931FBBDF81 offset=10](this=0x01e40aa9ad49 &lt;JSGlobal Object&gt;)    3: InternalFrame [pc: 000003D44F70F0B6]    4: EntryFrame [pc: 000003D44F709455]    5: E...FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed - JavaScript heap out of memory</code></pre><p>node 进程直接挂掉了，因为所有生成的数都在一个数组里保存，这个数组很容易就超过了堆内存的限制。而如果使用 <code>Generator</code> 函数，每一个值只会在调用的时候生成并返回，并且没有在函数内部保存这个值，那自然不会发生堆内存超出了：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">range</span>(<span class="params">len</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到，因为缺少了对产生的值的保存，代码反而更精简了。那么怎么打印它所产生的值呢？总不能挨个执行 <code>next</code> 吧，ES6 新添了 <code>for ... of</code> 的语法，所有只要实现了 <code>Iterator</code> 接口的对象都可以使用这个语法来遍历，比如：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> l = [<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 for ... of 遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> l)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出：3 2 1 a b c</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 for ... in 遍历</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">in</span> l)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 输出：0 1 2 3 4 5</span></span><br></pre></td></tr></table></figure><p><code>for ... of</code> 和 <code>for ... in</code> 最大的区别就是 <code>for ... of</code> 会直接将数组的值传递给了 <code>let i</code>，而 <code>for ... in</code> 将数组的索引传递给了 <code>let i</code>。我们的 <code>Generator</code> 函数也实现了 <code>Iterator</code> 接口所以也可以使用 <code>for ... of</code> 的方法来取值：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">range</span>(<span class="params">len</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++)&#123;</span><br><span class="line">        <span class="keyword">yield</span> i</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i <span class="keyword">of</span> range(<span class="number">99999999999999</span>))&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这时候屏幕开始疯狂输出了。。。</p><h5 id="给-Generator-对象传值"><a href="#给-Generator-对象传值" class="headerlink" title="给 Generator 对象传值"></a>给 Generator 对象传值</h5><p>在 <code>Generator</code> 对象运行期间，我们还可以在外部通过 <code>next</code> 方法传递一些值给生成器内部，在生成器对象内部对传递进来的值进行处理，看下面例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> w = <span class="keyword">yield</span> <span class="string">"hello"</span></span><br><span class="line">    <span class="built_in">console</span>.log(w)</span><br><span class="line">    <span class="keyword">yield</span> w</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>yield</code> 返回 <code>hello</code> 字符串后，我们用 <code>let w</code> 再保存 <code>yield</code> 接收到的值：</p><pre><code>&gt; function* gen(){...     let w = yield &quot;hello&quot;...     console.log(w)...     yield w... }undefined&gt; let g = gen()undefined&gt; g.next(){ value: &apos;hello&apos;, done: false }&gt; g.next(&quot;world&quot;)world{ value: &apos;world&apos;, done: false }&gt; g.next(&quot;world&quot;){ value: undefined, done: true }</code></pre><p>运行到 <code>let g = gen()</code> 的时候，创建了一个生成器对象 <code>g</code>，第一次 <code>g.next()</code> 的时候为什么我们没有传值进去呢？因为它运行到 <code>yield &quot;hello&quot;</code> 的时候就暂停函数了，如果这个时候传值进去，它也没办法处理。当第二次执行 <code>g.next(&quot;world&quot;)</code> 的时候，从上次暂停的地方继续运行，也就相当于开始运行 <code>let w = (yield)</code> 了，这时候通过 <code>next</code> 传递进去的值就由 <code>yield</code> 返回给内部的 <code>let w</code>，接着生成器继续运行到下一个 <code>yield w</code> 的时候，将 <code>w</code> 的值返回给外部调用者。再继续执行 <code>g.next(&quot;world&quot;)</code> 可内部已经没有 <code>yield</code> 语句进行接收传进去的值了，所以没法处理，生成器结束运行。</p><h5 id="Generator-与-Pormise"><a href="#Generator-与-Pormise" class="headerlink" title="Generator 与 Pormise"></a>Generator 与 Pormise</h5><p>利用生成器对象可以将值返回外部调用者并暂停，然后从外部接收值并继续运行到下一个 <code>yield</code> 的机制，配合 <code>Promise</code> 又能碰撞出什么样的火花呢？</p><p>回到之前需要顺序读取三个文件的问题，我们理想状态下，想要写出这样的代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        fs.readFile(fileName, <span class="string">"utf-8"</span>, (err, data)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> aaa = <span class="keyword">yield</span> readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(aaa)</span><br><span class="line">    <span class="keyword">let</span> bbb = <span class="keyword">yield</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(bbb)</span><br><span class="line">    <span class="keyword">let</span> ccc = <span class="keyword">yield</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(ccc)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>通过 <code>yield</code> 将程序的控制权交给外部，让外部处理 <code>readFile()</code> 返回的 <code>Promise</code> 对象，然后外部处理完成后将数据传递给 <code>yield</code>，生成器内部就可以直接获取到处理好的数据了，接着再处理其他文件的读取。</p><p>接下来我们该实现如何在外部启动并处理这个生成器，然后将生成器返回的 <code>Promise</code> 对象处理好后再传递给生成器：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> g = gen()</span><br><span class="line">g.next().value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    g.next(data).value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        g.next(data).value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            g.next(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>通过 <code>g.next().value</code> 获取到了生成器返回来的 <code>Promise</code> 对象，接着使用 <code>.then()</code> 方法处理读取文件完成后的数据通过 <code>g.next(data)</code> 传递回去并继续处理它返回的下一个 <code>Promise</code> 对象，于是就写出了这样的代码。先看看是否达到我们预期的效果了吧：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsHello! this is aaa.txtHello! this is bbb.txtHello! this is ccc.txt</code></pre><p>没问题，虽然外部处理生成器返回的 <code>Promise</code> 还是一团糟，但是生成器函数写的就像是同步代码那样了。接下来就是对外部处理生成器对象的方法进行优化了。我们可以发现，外部对 <code>g.next()</code> 的执行基于生成器用 <code>yield</code> 返回了多少次，我们可以用生成器返回对象的 <code>done</code> 属性来判断这个生成器是否结束，然后用递归的方法不断进行 <code>g.next(data)</code> 处理：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">gen</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> g = gen()</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> result = g.next(data)</span><br><span class="line">        <span class="keyword">if</span> (result.done) <span class="keyword">return</span> result.value</span><br><span class="line">        result.value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            next(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们定义了一个 <code>run</code> 函数作为生成器函数的辅助函数，<code>run</code> 函数内部首先初始化了生成器对象，然后定义了一个 <code>next</code> 的函数，这个函数通过递归来控制生成器返回值和传递值，通过判断生成器是否已经完成来结束递归。接着我们通过 <code>run</code> 函数来启动 <code>gen</code> 生成器函数：</p><p>完整代码：<br><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        fs.readFile(fileName, <span class="string">"utf-8"</span>, (err, data)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">gen</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> g = gen()</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> result = g.next(data)</span><br><span class="line">        <span class="keyword">if</span> (result.done) <span class="keyword">return</span> result.value</span><br><span class="line">        result.value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            next(data)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span>* <span class="title">gen</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> aaa = <span class="keyword">yield</span> readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(aaa)</span><br><span class="line">    <span class="keyword">let</span> bbb = <span class="keyword">yield</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(bbb)</span><br><span class="line">    <span class="keyword">let</span> ccc = <span class="keyword">yield</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(ccc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">run(gen)</span><br></pre></td></tr></table></figure></div></div></p><p>执行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsHello! this is aaa.txtHello! this is bbb.txtHello! this is ccc.txt</code></pre><p>我们还可以在 <code>run</code> 函数中通过 <code>catch</code> 来处理异常的情况，我们可以将异常传递进去，或者直接终止生成器：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params">gen</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> g = gen()</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">let</span> result = g.next(data)</span><br><span class="line">        <span class="keyword">if</span> (result.done) <span class="keyword">return</span> result.value</span><br><span class="line">        result.value.then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">            next(data)</span><br><span class="line">        &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">            next(err)  <span class="comment">// 如果将err传递进去，则生成器继续运行</span></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    next()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsHello! this is aaa.txt{ [Error: ENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;]errno: -4058,code: &apos;ENOENT&apos;,syscall: &apos;open&apos;,path: &apos;C:\\Users\\yunfwe\\Desktop\\bbb.txt&apos; }Hello! this is ccc.txt</code></pre><p><code>Generator</code> 已经有点好用了，那么还有没有更好用的方法呢？</p><h4 id="async-await-闪亮登场"><a href="#async-await-闪亮登场" class="headerlink" title="async/await 闪亮登场"></a>async/await 闪亮登场</h4><p>前面也有说到，<code>async</code> 是 <code>Generator</code> 的语法糖，<code>async</code> 就相当于将 <code>Generator</code> 函数，以及之前我们写的 <code>run</code> 这个辅助执行器融合到了一起。<code>await</code> 关键字只能用在 <code>async</code> 申明的函数中，意为等待一个异步操作完成。</p><h5 id="基本用法-1"><a href="#基本用法-1" class="headerlink" title="基本用法"></a>基本用法</h5><p>上一节处理依次读取三个文件的 <code>gen</code> 和 <code>run</code> 方法，我们先用 <code>async</code> 和 <code>await</code> 改造一下，先体现一下它的用法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">genAsync</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> aaa = <span class="keyword">await</span> readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(aaa)</span><br><span class="line">    <span class="keyword">let</span> bbb = <span class="keyword">await</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(bbb)</span><br><span class="line">    <span class="keyword">let</span> ccc = <span class="keyword">await</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(ccc)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们只是把申明 <code>Generator</code> 函数的 <code>*</code> 换成了在函数前面用 <code>async</code>，然后在需要等待异步操作完成的地方使用 <code>await</code> 代替了 <code>yield</code>，然后其他的什么辅助方法都不需要了，完整代码如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readFile</span>(<span class="params">fileName</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="keyword">function</span>(<span class="params">resolve, reject</span>)</span>&#123;</span><br><span class="line">        fs.readFile(fileName, <span class="string">"utf-8"</span>, (err, data)=&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                reject(err)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                resolve(data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">genAsync</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> aaa = <span class="keyword">await</span> readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(aaa)</span><br><span class="line">    <span class="keyword">let</span> bbb = <span class="keyword">await</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(bbb)</span><br><span class="line">    <span class="keyword">let</span> ccc = <span class="keyword">await</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(ccc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">genAsync()</span><br></pre></td></tr></table></figure><p>运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsHello! this is aaa.txtHello! this is bbb.txtHello! this is ccc.txt</code></pre><p>有没有觉得很棒！甚至我们都可以像写同步代码一样，通过 <code>try...catch</code> 来捕捉 <code>await</code> 产生的异常！</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">genAsync</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> aaa = <span class="keyword">await</span> readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(aaa)</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> bbb = <span class="keyword">await</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(bbb)</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err.message)</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> ccc = <span class="keyword">await</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(ccc)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们在可能出现异常的地方使用 <code>try...catch</code> 来捕捉，运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsHello! this is aaa.txtENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;Hello! this is ccc.txt</code></pre><p>异步代码写起来比以前舒服太多了，接下来就探究下 <code>async</code> 都帮我们做了什么吧！</p><h5 id="async-函数"><a href="#async-函数" class="headerlink" title="async 函数"></a>async 函数</h5><p>使用 <code>async</code> 申明的函数返回的是一个 <code>Promise</code> 对象，如果通过 <code>return</code> 返回值，相当于将 <code>Promise</code> 的状态变为了 <code>fulfilled</code> 状态，可以通过 <code>.then()</code> 来处理返回的数据。如果在 <code>async</code> 函数中抛出异常，相当于将 <code>Promise</code> 的状态变成了 <code>rejected</code>，可以通过 <code>.catch()</code> 来捕捉。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"hello world"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f().then(<span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f1</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Error!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f1().catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>执行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node async.jshello worldError!</code></pre><h5 id="await-命令"><a href="#await-命令" class="headerlink" title="await 命令"></a>await 命令</h5><p>只有 <code>async</code> 函数内部才可以使用 <code>await</code> 命令。<code>await</code> 命令后面可以跟上一个 <code>Promise</code> 对象（或者定义了 <code>then</code> 方法的对象）或者其他类型的数据，如果是其他类型数据，<code>await</code> 会直接返回这个数据。</p><p>如果是 <code>Promise</code> 对象，当 <code>await</code> 后面的 <code>Promise</code> 对象的状态变成 <code>fulfilled</code>，<code>await</code> 将返回它的值。如果 <code>await</code> 后面的 <code>Promise</code> 对象的状态变成 <code>rejected</code>，<code>await</code> 会立即抛出一个异常，并结束 <code>async</code> 函数的运行，可以通过 <code>async</code> 函数的 <code>.catch()</code> 在外部来捕捉这个异常，或者直接用 <code>try...catch</code> 在内部捕捉 <code>await</code> 抛出的异常。</p><p><code>await</code> 后面 <code>Promise</code> 状态为 <code>fulfilled</code> 的情况：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> d = <span class="keyword">await</span> <span class="built_in">Promise</span>.resolve(<span class="string">"Done"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(d)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f()</span><br></pre></td></tr></table></figure><p>运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node async.jsDone</code></pre><p><code>await</code> 后面 <code>Promise</code> 状态为 <code>rejected</code> 的情况：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> d = <span class="keyword">await</span> <span class="built_in">Promise</span>.reject(<span class="string">"Error!"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(d)</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Catch: "</span> + err)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f()</span><br></pre></td></tr></table></figure><p>运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node async.jsCatch: Error!</code></pre><p>如果 <code>async</code> 内部没有捕捉到 <code>await</code> 抛出的异常，那么可以在 <code>async</code> 函数外部通过 <code>.catch()</code> 方法捕捉：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> d = <span class="keyword">await</span> <span class="built_in">Promise</span>.reject(<span class="string">"Error!"</span>)</span><br><span class="line">        <span class="built_in">console</span>.log(d)</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"Catch: "</span> + err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">await</span> <span class="built_in">Promise</span>.reject(<span class="string">"New Error!"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f().catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node async.jsCatch: Error!New Error!</code></pre><p>如果 <code>async</code> 内部多个 <code>await</code> 等待异步结果，只要有一个 <code>await</code> 抛出了异常没被捕捉，那么整个 <code>async</code> 函数就立即停止运行了，我们继续改造之前读取文件的例子：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">genAsync</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> aaa = <span class="keyword">await</span> readFile(<span class="string">"aaa.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(aaa)</span><br><span class="line">    <span class="keyword">let</span> bbb = <span class="keyword">await</span> readFile(<span class="string">"bbb.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(bbb)</span><br><span class="line">    <span class="keyword">let</span> ccc = <span class="keyword">await</span> readFile(<span class="string">"ccc.txt"</span>)</span><br><span class="line">    <span class="built_in">console</span>.log(ccc)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">genAsync().catch(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(err.message)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>可以看到，<code>bbb.txt</code> 不存在的情况下，如果没有捕捉这个异常，<code>genAsync</code> 就 <code>rejected</code> 了。运行结果：</p><pre><code>C:\Users\yunfwe\Desktop&gt;node app.jsHello! this is aaa.txtENOENT: no such file or directory, open &apos;C:\Users\yunfwe\Desktop\bbb.txt&apos;</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>这是 2018 年最后一篇博客，特此纪念一下 (￣▽￣)”</p><h3 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h3><ul><li><a href="http://es6.ruanyifeng.com/#docs/promise" target="_blank" rel="noopener">Promise</a></li><li><a href="http://es6.ruanyifeng.com/#docs/generator" target="_blank" rel="noopener">Generator</a></li><li><a href="http://es6.ruanyifeng.com/#docs/async" target="_blank" rel="noopener">Async</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;由于 JavaScript 是一门单线程，事件驱动的语言，因此异步编程方式是它一个非常重要的特性。无论是客户端的 JavaScript 还是服务端的 JavaScript 在处理 HTTP请求响应、事件监听、文件读取等操作时都避不开回调，如果异步的事件需要嵌套执行，那么回调给代码结构和可读性简直带来了灾难，这个被后人称之为：回调地狱。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="JavaScript" scheme="http://www.yunfwe.cn/categories/JavaScript/"/>
    
    
      <category term="javascript" scheme="http://www.yunfwe.cn/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>Web页面布局</title>
    <link href="http://www.yunfwe.cn/2018/12/28/2018/Web%E9%A1%B5%E9%9D%A2%E5%B8%83%E5%B1%80/"/>
    <id>http://www.yunfwe.cn/2018/12/28/2018/Web%E9%A1%B5%E9%9D%A2%E5%B8%83%E5%B1%80/</id>
    <published>2018-12-28T04:50:00.000Z</published>
    <updated>2018-12-27T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>使用现代前端技术开发的应用，不管是 Web 页面，还是混合开发的手机 APP，都离不开页面元素的布局。而布局又可以说是页面开发里最麻烦的地方，不仅要兼容不同的设备，还要兼容不同的浏览器，还很可能一不小心改错了一个值就造成整个页面的雪崩。这里汇总下关于页面布局的基础知识以及一些开发中的经验。<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>操作系统</td><td>Windows 10</td></tr><tr><td>Chrome浏览器</td><td>70</td></tr></tbody></table><h2 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h2><blockquote><p>这里假使读者已经有了基础的 CSS 知识。如果对这些基础知识还没有概念的话，如果继续往下看，可能会觉得比较难以理解和接受。</p></blockquote><h3 id="布局基础"><a href="#布局基础" class="headerlink" title="布局基础"></a>布局基础</h3><blockquote><p>CSS 布局重点在于  <strong>三大特性</strong>、<strong>盒子模型</strong>、<strong>浮动</strong> 和 <strong>定位</strong> 这几个方面，其他的背景啊、边框啊也都是细节，而这几个才是整个页面布局的基础。</p></blockquote><h4 id="显示模式"><a href="#显示模式" class="headerlink" title="显示模式"></a>显示模式</h4><p>网页的标签非常多，并且不同的标签用于不同的场合，因此不同的标签也有不同的显示模式。比如两个 <code>a</code> 标签默认是可以放在一行显示的，而 <code>p</code> 标签则不可以，默认在页面上独占一行或多行。</p><h5 id="块级元素"><a href="#块级元素" class="headerlink" title="块级元素"></a>块级元素</h5><p><code>p</code> 标签就是常见的块级元素，以及我们经常用来布局的 <code>div</code> 标签、<code>h1 ~ h6</code> 标签等，默认都是块级元素。块级元素由于可以对其设置宽高、对齐，因此常用于网页布局和结构搭建。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        h1 &#123;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8a8a8a</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">        p &#123;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#5e68ea</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">        div &#123;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff7171</span>;</span></span><br><span class="line">            padding: 3px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>第一行<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>第二行<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span>第三行<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545666248139.png" alt="1545666248139"></p><p>可以看到块级元素的几个特性：</p><ul><li>独占一行或多行</li><li>宽高、内外边距都可以控制</li><li>宽度默认是占满整个容器</li><li>可以容器其他行内元素、块级元素</li></ul><p>需要注意的是，<code>p</code> 标签和 <code>h1 ~ h6</code> 等文字类块级标签不可以容纳其他块级元素。</p><p>浏览器默认给一些块元素提供了外边距，所以页面上元素与元素之间还会有块空白。一般在实际开发中，都会重置所有元素的内外边距：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/2018/Web页面布局/1545666827380.png" alt="1545666827380"></p><p>这样页面上就不会有这么多无法掌控的情况了。</p><h5 id="行内元素"><a href="#行内元素" class="headerlink" title="行内元素"></a>行内元素</h5><p>行内元素不占有独立的区域，仅仅靠自身的字体大小和图像尺寸来支撑结构，一般不可以设置宽度、高度、对齐等属性，常用于控制页面中文本的样式。常见的行内元素有 <code>a</code>, <code>b</code>, <code>del</code>, <code>i</code>, <code>span</code> 等。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line">        a, b, del, i, span &#123;</span><br><span class="line">            margin: 5px;</span><br><span class="line">            padding: 5px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>超文本链接<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">b</span>&gt;</span>加粗<span class="tag">&lt;/<span class="name">b</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">del</span>&gt;</span>删除<span class="tag">&lt;/<span class="name">del</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">i</span>&gt;</span>斜体<span class="tag">&lt;/<span class="name">i</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>没有预设样式<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545667856330.png" alt="1545667856330"></p><p><code>span</code> 元素最为纯粹，可塑性非常高，所以经常会使用 <code>span</code> 标签来为文本添加各种样式。</p><p>行内元素的特点：</p><ul><li>不会独占一行，会和相邻的行内元素在一行上显示。</li><li>无法设置高和宽，以及上下内外边距，但是左右内外边距可以设置。</li><li>它的内容有多宽，容器就被撑多宽</li><li>行内元素只能容纳文本或则其他行内元素。</li></ul><p><code>a</code> 标签比较特殊，也可以容纳块级元素。</p><h5 id="行内块元素"><a href="#行内块元素" class="headerlink" title="行内块元素"></a>行内块元素</h5><p>行内块元素可以说就是允许设置宽高、内外边距（包括上下）、对齐属性的行内元素，比如常见的 <code>img</code> 标签，<code>input</code> 标签。下面看看行内块元素的显示：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line">        img &#123;</span><br><span class="line">            width: 150px;</span><br><span class="line">            height: 150px;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#3280f3</span>;</span></span><br><span class="line">            vertical-align: bottom</span><br><span class="line">        &#125;</span><br><span class="line">        input &#123;</span><br><span class="line">            width: 200px;</span><br><span class="line">            height: 30px;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f37932</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"css.png"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">placeholder</span>=<span class="string">"这是一个输入框"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545668809401.png" alt="1545668809401"></p><p><code>img</code> 标签和 <code>input</code> 标签都可以设置宽高，<code>img</code> 标签默认与其他一行的元素以基线对齐（<code>baseline</code>），这里改为底部对齐（<code>bottom</code>）的方式让显示的更好看一些。还有个问题可以发现，即使已经设置了 <code>margin: 0</code> 和 <code>padding: 0</code>，可是两个行内块元素中间依然有个缝隙。下面总结行内块元素的特点：</p><ul><li>和相邻行内或行内块元素在一行上，但是中间有空白缝隙。</li><li>默认宽度是它本身内容把它撑开的宽度。</li><li>宽高、内外边距都可以控制。</li></ul><p>顺便一提 <code>img</code> 标签和文字在一行时的一些显示：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line">        img &#123;</span><br><span class="line">            width: 150px;</span><br><span class="line">            height: 150px;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#3280f3</span>;</span></span><br><span class="line"><span class="css">            <span class="comment">/* vertical-align: bottom */</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        span &#123;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#d052d3</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"css.png"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span>&gt;</span>一些文字<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545668809400.gif" alt="1545668809400"></p><p><code>vertical-align</code> 可以设置行内和行内块元素垂直对其的方式。<code>img</code> 和其他行内元素默认的对齐方式并不是底线对其的！所以可以看到 <code>img</code> 比 <code>span</code> 高出了几个像素。<br>同样这个问题也会出现，当使用一个 <code>div</code> 去包裹 <code>img</code> 的时候，<code>img</code> 并不是铺满整个 <code>div</code> 的。而是底边会留有几个像素：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        div &#123;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#3280f3</span>;</span></span><br><span class="line">            display: inline-block;</span><br><span class="line">        &#125;</span><br><span class="line">        img &#123;</span><br><span class="line">            width: 150px;</span><br><span class="line">            height: 150px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"black.png"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545751283265.png" alt="1545751283265"></p><p>解决方法也很简单，将 <code>img</code> 的垂直对其方式设置为底边对其，或者 将 <code>img</code> 的显示模式转换为块元素</p><h5 id="显示模式转换"><a href="#显示模式转换" class="headerlink" title="显示模式转换"></a>显示模式转换</h5><p>通过 <code>display</code> 属性可以转换元素的默认显示模式：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: inline;        <span class="comment">/* 转换为行内元素 */</span></span><br><span class="line">    <span class="attribute">display</span>: block;         <span class="comment">/* 转换为块级元素 */</span></span><br><span class="line">    <span class="attribute">display</span>: inline-block;  <span class="comment">/* 转换为行内块元素 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>下面看一个例子：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        span &#123;</span><br><span class="line">            display: block;</span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#3a65e2</span>;</span></span><br><span class="line">            margin: 5px;</span><br><span class="line">        &#125;</span><br><span class="line">        div &#123;</span><br><span class="line">            display: inline;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#f459b7</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>span现在是块级元素了<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>拥有块级元素的特性<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span>div成了行内元素<span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span>可以一行显示了<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545670158259.png" alt="1545670158259"></p><p>上面的 <code>img</code> 显示问题也可以通过显示转换来解决：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        div &#123;</span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#3280f3</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">        img &#123;</span><br><span class="line">            width: 150px;</span><br><span class="line">            height: 150px;</span><br><span class="line">            display: block;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"black.png"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545751535135.png" alt="1545751535135"></p><h5 id="其他显示模式"><a href="#其他显示模式" class="headerlink" title="其他显示模式"></a>其他显示模式</h5><p>这三种基本的显示模式几乎可以应付大部分的页面布局了，其中还有一些非常好用的显示模式，比如 <code>display: flex</code> 可以用来做另外一种页面布局，但是对老旧的电脑浏览器存在一些兼容性问题（比如 IE），如果是手机页面开发，<code>display: flex</code> 几乎可以想怎么用就怎么用了。</p><p>浏览器开发者模式中可以看到所有支持的显示模式：</p><p><img src="/uploads/2018/Web页面布局/1545670550429.png" alt="1545670550429"></p><h4 id="三大特性"><a href="#三大特性" class="headerlink" title="三大特性"></a>三大特性</h4><h5 id="层叠性"><a href="#层叠性" class="headerlink" title="层叠性"></a>层叠性</h5><p>所谓层叠性，是指如果一个元素被应用了多个相同的 CSS 属性，那么浏览器如何处理这种冲突呢？先看一个例子。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-id">#app</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            background-color: red;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#app</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            background-color: gray;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>在浏览器中查看效果，显示的是灰色的盒子：</p><p><img src="/uploads/2018/Web页面布局/1545658432213.png" alt="1545658432213"></p><p>接着把两个颜色替换下看看效果<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-id">#app</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: gray;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-id">#app</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>盒子变成红色：</p><p><img src="/uploads/2018/Web页面布局/1545658706473.png" alt="1545658706473"></p><p>可以看到，是最后一次定义的 <code>background-color</code> 生效。也就是说，相同的 CSS 样式互相覆盖，只有最上面的一层 CSS 样式才最终被我们看到。</p><h5 id="继承性"><a href="#继承性" class="headerlink" title="继承性"></a>继承性</h5><p>几乎所有（未来不知道有没有）的应用与文字上的样式，都具有继承性。也就是说，在父标签定义好的一些关于文字的样式，子元素都不需要重新定义。如果子元素需要不同的样式，只能通过在子元素上应用新的样式来层叠掉父元素继承来的样式。</p><p>子元素可以继承的样式有 <code>text-</code>, <code>font-</code>, <code>line-</code> 开头的所有元素以及 <code>color</code> 元素。下面看一个例子：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        html &#123;</span><br><span class="line">            color: green;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-id">#father</span> &#123;</span></span><br><span class="line">            color: blue;</span><br><span class="line">            font-size: 24px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    从HTML标签继承来的color为绿色</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        #father层叠了继承来的color为蓝色<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        并定义了字号样式为 20px</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"son"</span>&gt;</span></span><br><span class="line">            #son继承了来自#father的字体颜色和字号</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>结果：<br><img src="/uploads/2018/Web页面布局/1545659782277.png" alt="1545659782277"></p><h5 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h5><p>给元素定义样式的方式有好多种，比如ID选择器、类和伪类选择器、标签选择器等。如果通过不同的选择器给相同样式定义了不同的值，这时候样式的层叠就不太一样了。</p><p>CSS 给通过不同的选择器定义的样式提供不同的优先级，CSS 的层叠只发生在相同的优先级下，比如上面 CSS 层叠性的代码中，都是通过 ID 选择器来定义的样式。</p><p>CSS 使用一套权重系统来计算优先级，使用 <code>0,0,0,0</code> 这种值来计算权重，不同的选择器或者定义样式的方法（内联样式、继承来的样式、<code>!important</code>申明的样式）会给权重系统提供不同的贡献，最后根据总贡献值来确定哪一套样式会覆盖了哪一套，如果贡献值相同，那么就应用最后定义的那套。这个过程就叫做层叠。</p><p>下面这个表格表明了不同的选择器或定义样式的方式的贡献值：</p><table><thead><tr><th>方式</th><th>贡献值</th></tr></thead><tbody><tr><td>继承来的样式</td><td>0,0,0,0</td></tr><tr><td>通配符选择器（*）</td><td>0,0,0,0</td></tr><tr><td>标签选择器</td><td>0,0,0,1</td></tr><tr><td>类、伪类选择器</td><td>0,0,1,0</td></tr><tr><td>ID选择器</td><td>0,1,0,0</td></tr><tr><td>内联样式</td><td>1,0,0,0</td></tr><tr><td>!important申明</td><td>无穷大</td></tr></tbody></table><p>可以将 <code>0,0,0,0</code> 的每一位当成一个级别，<code>0,0,0,1 &gt; 0,0,0,0</code>，<code>0,0,1,0 &gt; 0,0,0,1</code>，所以，<code>!important</code> &gt; 内联样式 &gt; ID选择器 &gt; 类、伪类选择器 &gt; 标签选择器 &gt; 通配符选择器（*）和继承来的样式。</p><p>下面看一个例子：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-id">#app</span> &#123;</span></span><br><span class="line">            width: 300px;</span><br><span class="line">            height: 300px;</span><br><span class="line">            color: blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            color: green</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">            字体颜色是蓝色，因为类选择器的优先级低于ID选择器</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>结果：<br><img src="/uploads/2018/Web页面布局/1545661905949.png" alt="1545661905949"></p><p>优先级是可以叠加的，比如：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-id">#app</span> &#123;</span></span><br><span class="line">            width: 300px;</span><br><span class="line">            height: 300px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.inner</span> &#123;</span></span><br><span class="line">            color: blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &gt; <span class="selector-class">.inner</span> &#123;</span></span><br><span class="line">            color: green;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"inner"</span>&gt;</span></span><br><span class="line">            字体颜色是绿色，因为两个类的贡献值比一个类的贡献值大</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545662472204.png" alt="1545662472204"></p><p>通过计算，<code>.inner</code> 的权重是 <code>0,0,1,0</code>，而 <code>.box &gt; .inner</code> 的权重是 <code>0,0,2,0</code>，所以 <code>.box &gt; .inner</code> 定义的样式会覆盖掉 <code>.inner</code> 定义的样式。同理，如果再加上 <code>#app &gt; .inner</code> 还会覆盖掉 <code>.box &gt; .inner</code> 定义的选择器，因为 <code>#app &gt; .inner</code> 的优先级是 <code>0,1,1,0</code>。</p><p>需要注意的是！CSS 的优先级没有进位，一百个类选择器定义的样式优先级也不会比一个ID选择器定义的样式优先级高！现在测试下 <code>!important</code> 的效果：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-id">#app</span> &#123;</span></span><br><span class="line">            width: 300px;</span><br><span class="line">            height: 300px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.inner</span> &#123;</span></span><br><span class="line">            color: blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &gt; <span class="selector-class">.inner</span> &#123;</span></span><br><span class="line">            color: green;</span><br><span class="line">        &#125;</span><br><span class="line">        * &#123;</span><br><span class="line">            color: purple!important;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"inner"</span>&gt;</span></span><br><span class="line">            而!important简直六亲不认，</span><br><span class="line">            即使毫无贡献值的通配符选择器定义的color样式，也秒杀一切</span><br><span class="line">        <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545663311042.png" alt="1545663311042"></p><h4 id="盒子模型"><a href="#盒子模型" class="headerlink" title="盒子模型"></a>盒子模型</h4><p>页面上每一个元素都像是一个盒子，盒子里面放的就是我们要展示的文字、图片或者其他的盒子。然后我们通过摆放盒子的位置来使内容合理的呈现在页面上。</p><h5 id="内外边距和边框"><a href="#内外边距和边框" class="headerlink" title="内外边距和边框"></a>内外边距和边框</h5><p>在现代浏览器中，每一个盒子都由 <strong>内容区域</strong>、<strong>内边距</strong>、<strong>边框</strong>、<strong>外边距</strong> 组成。</p><p><img src="/uploads/2018/Web页面布局/1545704369752.png" alt="1545704369752"></p><p>盒子模型可以比喻成我们拆快递，快递包装的厚度可以想象为边框，快递为了保护里面的东西会有一些填充物，这个填充物就可以当成内边距，而快递里面的东西就是实际的内容了。如果有多个快递，快递与快递之间的距离就是外边距了。下面看代码：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            padding: 10px;</span><br><span class="line">            border: 5px solid pink;</span><br><span class="line">            margin: 15px;</span><br><span class="line">            background-color: blue;</span><br><span class="line">            display: inline-block</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>这里将两个 <code>div</code> 元素设置为行内块显示，然后开发者模式查看他们的盒模型：</p><p><img src="/uploads/2018/Web页面布局/1545705114625.gif" alt="1545705114625"></p><p>可以看到，给元素设置的宽高实际上是给盒子的内容区域设置的，而元素占的实际空间大小是要加上内外边距还有边框的。我们也可以单独为每一个边设置不同的内外边距还有边框，或者通过将盒子左右外边距设置为 <code>auto</code> 来让浏览器自动计算实现盒子居中显示：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            padding: 10px;</span><br><span class="line">            border: 5px solid pink;</span><br><span class="line">            margin: 15px auto;</span><br><span class="line">            background-color: blue;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545706594946.png" alt="1545706594946"></p><h5 id="块元素的上下外边距合并"><a href="#块元素的上下外边距合并" class="headerlink" title="块元素的上下外边距合并"></a>块元素的上下外边距合并</h5><p>现在 <code>.box</code> 的显示模式是块元素了，如果相邻的两个块元素，上下外边距会有什么不同呢？</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            padding: 10px;</span><br><span class="line">            border: 5px solid pink;</span><br><span class="line">            margin: 15px auto;</span><br><span class="line">            background-color: blue;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545706594948.gif" alt="1545706594946"></p><p>如果两个盒子的外边距不同，则会以外边距最大的元素为准：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            padding: 10px;</span><br><span class="line">            border: 5px solid pink;</span><br><span class="line">            margin: 15px auto;</span><br><span class="line">            background-color: blue;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span> <span class="attr">style</span>=<span class="string">"margin: 25px auto"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545707735409.gif" alt="1545707735409"></p><p>如何消除这个影响呢？也很简单，用一个父盒子将其中一个盒子嵌套起来，并给父盒子设置一个 <code>overflow: hidden</code>：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            padding: 10px;</span><br><span class="line">            border: 5px solid pink;</span><br><span class="line">            margin: 15px auto;</span><br><span class="line">            background-color: blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            overflow: hidden;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span> <span class="attr">style</span>=<span class="string">"margin: 25px auto"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545707735410.gif" alt="1545707735410"></p><p>添加 <code>overfiow: hidden</code> 可以防止 <code>margin</code> 合并的原理是 <code>.father</code> 的盒子触发了浏览器的 BFC 机制，形成了自己的独立空间，但是它的元素占用空间是由里面的子元素撑起来的，父元素的外边距为 0，所以也不会与下一行的块元素发生重叠（如果给父元素设置了外边距，依然会跟下一行的重叠）。那么什么是 BFC 呢？</p><h5 id="BFC（块级格式化上下文）"><a href="#BFC（块级格式化上下文）" class="headerlink" title="BFC（块级格式化上下文）"></a>BFC（块级格式化上下文）</h5><p>BFC 就是页面上的一个隔离的独立容器，容器里面的子元素不会影响到外面的元素。反之也如此。包括浮动，和外边距合并等等，因此，有了这个特性，我们布局的时候就不会出现意外情况了。</p><p>元素如何才能形成 BFC 呢？满足如下几个条件之一即可：</p><ul><li><code>float</code> 的值不为 <code>none</code></li><li><code>position</code> 的值不为 <code>static</code> 或 <code>relative</code></li><li><code>display</code> 的值为 <code>table-cell</code>、<code>table-caption</code>、<code>inline-block</code>、<code>flex</code> 或 <code>inline-flex</code></li><li><code>overflow</code> 的值不为 <code>visibility</code></li></ul><p>利用 BFC 我们能做些什么呢？</p><ol><li>上一节的例子已经看到，BFC 可以防止两个元素上下外边距合并的问题。</li><li>清除父元素内部的子元素浮动问题。</li><li>父元素内部右侧盒子自适应。</li></ol><p>下面看一个例子：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 350px;</span><br><span class="line"><span class="css">            <span class="comment">/* height: 350px; */</span></span></span><br><span class="line">            border: 1px solid blue;</span><br><span class="line"><span class="css">            <span class="comment">/* overflow: hidden; */</span></span></span><br><span class="line"><span class="css">            <span class="comment">/* display: flex; */</span></span></span><br><span class="line"><span class="css">            <span class="comment">/* position: absolute; */</span></span></span><br><span class="line"><span class="css">            <span class="comment">/* float: left; */</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#f66</span>;</span></span><br><span class="line"><span class="css">            <span class="comment">/* float: left; */</span></span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            height: 200px;</span><br><span class="line">            width: 200px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background</span>: <span class="selector-id">#fcc</span>;</span></span><br><span class="line">            display: none;</span><br><span class="line"><span class="css">            <span class="comment">/* overflow: hidden; */</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.other</span> &#123;</span></span><br><span class="line">            height: 120px;</span><br><span class="line">            width: 120px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#649ddd</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span></span><br><span class="line">            文字文字文字文字文字文字文字文字文字文字文字文字文字文字文字</span><br><span class="line">            文字文字文字文字文字文字文字文字文字文字文字文字文字文字文字</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"other"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>当前元素都一行一行的正常排列着：</p><p><img src="/uploads/2018/Web页面布局/1545714903936.png" alt="1545714903936"></p><p>当我们给 <code>.box1</code> 添加浮动，一切都改变了：</p><p><img src="/uploads/2018/Web页面布局/1545714972297.png" alt="1545714972297"></p><p><code>.father</code> 的内容高度变为了 0，变成了只剩靠 2px 的边框维持的一条线。<code>.box1</code> 与 <code>.other</code> 发生了重叠，这个就是因为父元素内部子元素浮动产生的问题，我们看看如何来解决这个问题：</p><p><img src="/uploads/2018/Web页面布局/1545715245226.png" alt="1545715245226"></p><p>我们给 <code>.father</code> 设置了高度，这样看似解决了问题，但是这个高度不是因为内部子元素自动撑开的，而是我们手动设置的，如果内部子元素的高度发生变化，我们还得相应的修改父元素高度以适应，这样显然不是太合理。接下来看看如何使用 BFC 来解决这个问题：</p><p><img src="/uploads/2018/Web页面布局/1545715245227.gif" alt="1545715245227"></p><p>首先尝试了使用 <code>overflow: hidden</code> 的方式，似乎完美解决了问题，但是如果内部盒子的宽度大于父盒子，则会被隐藏。接着使用 <code>display: flex</code> 的方式，这使用了 <code>flex</code> 布局。当使用了 <code>position: absolute</code> 和 <code>float: left</code> 的时候，虽然父元素形成了 BFC，并由内部子元素自动撑开了高度，但是却脱离了文档流，依然与下面的元素发生重叠。</p><p>在看看最后一个可以利用 BFC 解决的问题：“父元素内部右侧盒子自适应”。首先给父元素提供一个高度，然后将 <code>.box2</code> 的 <code>display: none</code> 状态取消：</p><p><img src="/uploads/2018/Web页面布局/1545715245228.gif" alt="1545715245228"></p><p>可以看到由于 <code>.box1</code> 的浮动，与 <code>.box2</code> 产生了重叠，并让 <code>.box2</code> 的文字与它产生了环绕效果。当我们让 <code>.box2</code> 形成 BFC 会产生什么效果呢？</p><p><img src="/uploads/2018/Web页面布局/1545715245229.gif" alt="1545715245229"></p><p>当使用 <code>overflow: hidden</code> 触发 BFC 后，<code>.box2</code> 的左边框紧贴着 <code>.box1</code> 的右边框。当取消手动指定的 <code>.box2</code> 宽度后，<code>.box2</code> 自动适应了 <code>.father</code> 剩余的宽度。</p><h5 id="更改盒模型"><a href="#更改盒模型" class="headerlink" title="更改盒模型"></a>更改盒模型</h5><p>默认我们对块元素设置宽高是内容区域的宽高，如果对这个盒子进行增加内边距和边框，都会使这个元素变大，这个默认模型是 <code>content-box</code>。还有一个常用的模型，让内边距和边框都包含到元素的宽高中，这种模型就是 <code>border-box</code>。</p><p>我们可以通过 <code>box-sizing</code> 来更改盒子模型：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            background-color: pink;</span><br><span class="line">            padding: 10px;</span><br><span class="line">            border: 5px solid gray;</span><br><span class="line">            margin: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            box-sizing: border-box;</span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            background-color: blue;</span><br><span class="line">            padding: 10px;</span><br><span class="line">            border: 5px solid gray;</span><br><span class="line">            margin: 20px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545723227167.png" alt="1545723227167"></p><p><code>.box2</code> 由于使用了 <code>border-box</code> 模型，所以去掉边框和内边距占用的区域，内容区域只剩下 <code>70 × 70</code> 了，看起来也比 <code>.box1</code> 小了很多。</p><h4 id="定位机制"><a href="#定位机制" class="headerlink" title="定位机制"></a>定位机制</h4><h5 id="文档流"><a href="#文档流" class="headerlink" title="文档流"></a>文档流</h5><p>不给元素添加浮动或者定位的话，元素就放在文档流（或标准流）中。文档流实际上就是网页内的元素从左往右，从上往下依次排列的布局方式。如果给某个元素添加了浮动或者定位，那么它的显示就不会按照文档流的规则，我们称之为：脱离文档流。</p><p>当某个元素脱离的文档流，就不会占用文档流的位置了，所以经常会发现多个元素发生了重叠的现象。脱离了文档流的元素的层级会比文档流中的元素层级高，因此大多情况下都是脱离文档流的元素遮住文档流的元素。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            background-color: pink;</span><br><span class="line">            float: left;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 120px;</span><br><span class="line">            height: 120px;</span><br><span class="line">            background-color: blue;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545727983700.png" alt="1545727983700"></p><h5 id="浮动"><a href="#浮动" class="headerlink" title="浮动"></a>浮动</h5><p>浮动最早是用来控制图片，为了让其他元素特别是文字实现环绕图片的效果。后来发现浮动可以让任何盒子排在一行，而且中间没有间隙（<code>inline-block</code> 的两个盒子中间有间隙），慢慢的人们就会浮动的特性来布局了。</p><p>元素设置了浮动样式，会脱离文档流的控制，并移动到浮动样式设置的地方。浮动元素依然受限于父级元素，子元素浮动，父元素依然在文档流中。如果多个子元素都添加了浮动，那么这些元素都有了 <code>inline-block</code> 元素的特性</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            padding: 10px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">            float: left;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            float: left;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">            float: right;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545729291972.png" alt="1545729291972"></p><p>可以看到，所有添加了浮动的标签，都有了行内块元素的特性，但是会两边贴合没有缝隙。元素会按照浮动样式的值进行漂移，如果是 <code>left</code> 则会贴着父元素的左边排列，<code>right</code> 会贴着父元素的右边排列。但是子元素不会超出父元素的内边距距离。</p><p>浮动的特性：脱离文档流、不占用原本在文档流中的位置、会影响原本文档流的布局、只有左右浮动或者不浮动。</p><h5 id="定位"><a href="#定位" class="headerlink" title="定位"></a>定位</h5><p>我们如果想移动某个元素的位置，或者将某个元素直接放置到页面中一个固定的位置，如果不使用定位就非常麻烦或者不可能完成了。就连页面中各种各样的动画，也几乎都是通过定位来做的。</p><p>元素的定位属性主要包括定位模式和边偏移两部分，定位属性常用的有四种：<code>static</code>，<code>relative</code>，<code>absolute</code>，<code>fixed</code>。边偏移样式：<code>top</code>，<code>bottom</code>，<code>left</code>，<code>right</code>。一般偏移样式 <code>top</code> 和 <code>bottom</code> 只使用一个就够了，<code>left</code> 和 <code>right</code> 同理，不要既给元素设置了 <code>left</code> 然后又设置了 <code>right</code>。</p><p>偏移量不仅可以使用 <code>px</code> 等单位，还可以使用百分比：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box</span> &#123;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">10%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>并且元素如果添加了定位（除了static定位）都会像给元素添加了浮动一样，将元素模式转换为行内块模式。因此即使是行内元素，也可以直接设置高度和内外上下边距。</p><h6 id="static"><a href="#static" class="headerlink" title="static"></a>static</h6><p>文档流中的所有元素都默认是这个定位方式，而且没法通过边偏移样式进行改变元素位置。</p><h6 id="relative"><a href="#relative" class="headerlink" title="relative"></a>relative</h6><p>相对定位：相对与自身原本在文档流中的位置进行边偏移。不脱离文档流，元素原本的占位依然保留。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            position: relative;</span><br><span class="line">            top: 0px;</span><br><span class="line">            left: 0px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>给 <code>.box2</code> 添加了相对定位，并与原来位置的顶部保持 <code>0px</code> 的像素偏移和相对与原来位置的左边保持 <code>0px</code> 的像素偏移，然后浏览器开发者模式中手动调整这两个值试试看：</p><p><img src="/uploads/2018/Web页面布局/1545729291973.gif" alt="1545729291973"></p><p>相对于 <code>top</code> 设置偏移时，如果值小于 0 则向上偏移，如果值大于 0 则向下偏移。<code>left</code> 如果值小于 0 则向左偏移，如果值大于 0 则向右偏移。</p><h6 id="absolute"><a href="#absolute" class="headerlink" title="absolute"></a>absolute</h6><p>绝对定位：将元素根据最近的已经定位（相对、绝对、固定都可以）的父级或祖先级元素进行定位，如果所有的父元素都没有定位，则以 document 文档为基准进行定位。完全脱离文档流，元素原本的占位不保留。</p><p>因此如果想让某个元素以它的某个父或祖先元素进行定位，就需要给这个元素设置绝对定位，并给父或祖先元素也设置合适的定位方式，如果不想改变父或祖先元素的位置，也不想让父或祖先元素脱离文档流，那最好的方式就是给父或祖先元素设置相对定位。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 1000px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            position: absolute;</span><br><span class="line">            top: 0px;</span><br><span class="line">            left: 0px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>这里将 <code>.father</code> 的长度设置为 <code>1000px</code> 使页面产生滚动条，然后将 <code>.box2</code> 改为绝对定位：</p><p><img src="/uploads/2018/Web页面布局/1545729291974.gif" alt="1545729291974"></p><p>由于 <code>.box2</code> 的祖先都没有设置定位，因此它的绝对定位是以 <code>document</code> 整个页面为基准。完全脱离了文档流，所以它原来的位置被 <code>.box3</code> 所占据，并且当文档滚动时它也跟着滚动。如果想让它以 <code>.father</code> 元素为基准进行定位，又不想改变 <code>.father</code> 元素的位置，那么就最好给 <code>.father</code> 元素设置相对定位：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 1000px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            position: relative;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            position: absolute;</span><br><span class="line">            top: 0px;</span><br><span class="line">            left: 0px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545729291975.gif" alt="1545729291975"></p><p><code>.box2</code> 以 <code>.father</code> 为基准定位，所以覆盖了 <code>.box1</code>。如果想要元素相对于父元素水平和垂直居中对齐，可以将四个修改偏移的样式都设置为 0 ，然后将 <code>margin</code> 设置为 <code>auto</code>，看下面示例：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 400px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            position: relative;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            position: absolute;</span><br><span class="line"><span class="css">            <span class="comment">/* top: 0px; */</span></span></span><br><span class="line"><span class="css">            <span class="comment">/* left: 0px; */</span></span></span><br><span class="line"><span class="css">            <span class="comment">/* bottom: 0; */</span></span></span><br><span class="line"><span class="css">            <span class="comment">/* right: 0; */</span></span></span><br><span class="line">            margin: auto;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545729292975.gif" alt="1545729292975"></p><p>通过不同的偏移组合，可以将 <code>.box1</code> 定位到父元素中的 8 个位置上。</p><h6 id="fixed"><a href="#fixed" class="headerlink" title="fixed"></a>fixed</h6><p>固定定位：永远以浏览器窗口为基准，不随页面滚动而滚动。完全脱离文档流，元素原本的占位不保留。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 1000px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            position: relative;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            position: fixed;</span><br><span class="line">            top: 0px;</span><br><span class="line">            left: 0px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545729291976.gif" alt="1545729291976"></p><p>将 <code>.box2</code> 设置为固定定位，可以看到它并不随着页面的滚动而滚动。我们经常看到的页面双侧广告，是不是就是这样子的？固定定位也可以像绝对定位那样，通过将四个偏移样式都设置为 0，然后将 <code>margin</code> 设置为 <code>auto</code> 的方式实现元素相对于浏览器窗口永远水平和垂直居中：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 400px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            position: fixed;</span><br><span class="line">            top: 0;</span><br><span class="line">            bottom: 0;</span><br><span class="line">            left: 0;</span><br><span class="line">            right: 0;</span><br><span class="line">            margin: auto;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545741622908.png" alt="1545741622908"></p><h6 id="sticky"><a href="#sticky" class="headerlink" title="sticky"></a>sticky</h6><p>CSS3 新增的样式，粘性定位，这个就比较有意思了。它相当于 <code>relative</code> 和 <code>fixed</code> 混合。最初会被当作是 <code>relative</code>，相对于原来的位置进行偏移。一旦超过一定阈值之后，会被当成 <code>fixed</code>，相对于视口进行定位。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 1000px;</span><br><span class="line">            height: 1000px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            position: relative;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            position: sticky;</span><br><span class="line">            top: 20px;</span><br><span class="line">            left: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545742622908.gif" alt="1545742622908"></p><p>有点意思吧！不是实际好像用的并不多。</p><h5 id="层级"><a href="#层级" class="headerlink" title="层级"></a>层级</h5><p>如果对元素使用了定位，就非常容易发生元素重叠的情况，我们可以使用 <code>z-index</code> 来调整定位元素的堆叠顺序，其取值可以为负整数、0 和正整数，值越大，则定位的元素越居上，如果值相同，则后定义的元素居上。</p><p><code>z-index</code> 的默认值是 0，并且只有相对定位、绝对定位和固定定位才有此属性。其余标准流，浮动，静态定位都无此属性，也不可指定此属性。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 400px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            position: relative;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">            position: absolute;</span><br><span class="line">            z-index: 0;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            position: absolute;</span><br><span class="line">            top: 20px;</span><br><span class="line">            left: 20px;</span><br><span class="line">            z-index: 0;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">            position: absolute;</span><br><span class="line">            top: 40px;</span><br><span class="line">            left: 40px;</span><br><span class="line">            z-index: 0;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545741622910.gif" alt="1545741622910"></p><h4 id="显示与隐藏"><a href="#显示与隐藏" class="headerlink" title="显示与隐藏"></a>显示与隐藏</h4><p>CSS 中可以控制元素显示与隐藏的样式最常用的有三个，一个是 <code>display</code>，一个是 <code>visibility</code>，另一个是 <code>overflow</code>。</p><h5 id="display"><a href="#display" class="headerlink" title="display"></a>display</h5><p>如果将元素的 <code>display</code> 设置为 <code>none</code> 将会使这个元素彻底的隐藏掉，元素原来的位置也不再保留：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 400px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            display: none;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545746851690.png" alt="1545746851690"></p><p>可以看到 <code>.box3</code> 显示在原来 <code>.box2</code> 的位置。于此对应的是，将一个隐藏元素的 <code>display</code> 设置为原来的显示模式（一般是 <code>block</code>），元素就可以再出现了。</p><h5 id="visibility"><a href="#visibility" class="headerlink" title="visibility"></a>visibility</h5><p><code>visibility</code> 与 <code>display</code> 不同的是，隐藏元素后，会保留原来的位置。<code>visibility</code> 的值为 <code>hidden</code> 时元素隐藏不可见，值为 <code>visible</code> 时元素显示出来。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 400px;</span><br><span class="line">            height: 400px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#8000ff</span>;</span></span><br><span class="line">            visibility: hidden;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff2f97</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545747830399.png" alt="1545747830399"></p><h5 id="overflow"><a href="#overflow" class="headerlink" title="overflow"></a>overflow</h5><p><code>overflow</code> 和上面两个的作用就不太一样了，它主要用于设置当对象的内容超过其指定高度及宽度时如何管理内容。</p><ul><li><code>overflow: visible</code>：默认值，不剪切内容，也不添加滚动条。</li><li><code>overflow: auto</code>：超出自动添加滚动条，否则不加</li><li><code>overflow: hidden</code>：超出部分隐藏掉</li><li><code>overflow: scroll</code>：不管是否超出，都显示滚动条</li></ul><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-attr">[class^=box]</span> &#123;</span></span><br><span class="line">            display: inline-block;</span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff9d6f</span>;</span></span><br><span class="line">            vertical-align: top;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.content</span> &#123;</span></span><br><span class="line">            margin: 10px auto;</span><br><span class="line">            width: 30px;</span><br><span class="line">            height: 200px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#4ed869</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line">            overflow: visible;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line">            overflow: auto;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line">            overflow: hidden;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line">            overflow: scroll;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"content"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545749729658.png" alt="1545749729658"></p><h4 id="屏幕与像素"><a href="#屏幕与像素" class="headerlink" title="屏幕与像素"></a>屏幕与像素</h4><h5 id="常用单位"><a href="#常用单位" class="headerlink" title="常用单位"></a>常用单位</h5><p>页面开发中，我们用的最多的就是使用 <code>px</code> 作为单位来编写样式了，偶尔也会用到百分比来写一些元素自适应父元素的样式。但是在移动开发中，为了让一套页面可以适应多套屏幕尺寸，<code>px</code> 就不太适用了。</p><p><img src="/uploads/2018/Web页面布局/1545789503327.png" alt="1545789503327"></p><p>图中可以看到，当我们给元素设置宽高时，IDE 给我们显示出了所有可用的单位。</p><table><thead><tr><th width="100px">单位</th><th>描述</th></tr></thead><tbody><tr><td>%</td><td>相对于父元素相同属性的百分比。</td></tr><tr><td>px</td><td>像素点，跟屏幕的物理性质相关。</td></tr><tr><td>in</td><td>英寸，跟 px 的换算是 1in == 96px （基于屏幕为 96 DPI计算）</td></tr><tr><td>cm</td><td>厘米，并非生活中的厘米，这里 1cm == 37.8px</td></tr><tr><td>mm</td><td>毫米，1mm == .1cm == 3.78px</td></tr><tr><td>em</td><td>基于当前容器的字体大小，font-size 是多少，1em就是多少</td></tr><tr><td>rem</td><td>与 em 类似，不过 rem 是基于根元素（html）的字体大小</td></tr><tr><td>pt</td><td>印刷行业常用单位，1pt == 1/72英寸</td></tr></tbody></table><h5 id="屏幕-DPI（PPI）"><a href="#屏幕-DPI（PPI）" class="headerlink" title="屏幕 DPI（PPI）"></a>屏幕 DPI（PPI）</h5><p>现在电脑屏幕的主流分辨率都是 <code>1920 × 1080</code> 了，而手机屏幕也大多都是这个分辨率，那么电脑上看到的 100px 和手机看到的 100px 能一样长吗？答案当然是不一样。</p><p><img src="/uploads/2018/Web页面布局/1545794545664.png" alt="1545794545664"></p><p>我们常用英寸来表示屏幕尺寸（屏幕对角线长度），比如现在手机屏幕尺寸大多都是 5.5 英寸，笔记本电脑的屏幕有 13英寸、15英等，显示器的尺寸就更大了，21英寸、23英寸、甚至现在的电视剧都 55英寸以上。屏幕分辨率则以像素作度量的，屏幕分辨率这些年也越来越高，当年的 720p 的屏幕，现在 1080p 的分辨率是主流，甚至高端产品有 2k 屏甚至 4k 屏。</p><p>屏幕尺寸的不同和分辨率的不同，则构成了各种设备的差异。DPI 是硬刷行业中用来表示打印机每英寸可以喷的墨汁点数，显示器也借鉴了这个概念，不过是将墨汁点换成了像素。屏幕英寸一般指对角线，在知道屏幕宽和高的像素后，可以通过勾股定理计算出每英寸可容纳的像素点，这个就是 DPI（PPI）。</p><p><img src="/uploads/2018/Web页面布局/799396908.png" alt="img"></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ppi</span>(<span class="params">w,h,n</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">let</span> p = <span class="built_in">Math</span>.sqrt(w**<span class="number">2</span>+h**<span class="number">2</span>) / n</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.round(p)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们以 23 英寸的显示器屏幕，<code>1920 × 1080</code> 的分辨率，计算下这个屏幕的 DPI（PPI）：</p><pre><code>&gt; console.log(ppi(1920,1080,23))&lt; 96</code></pre><p>所以上面常用单位中的 1 英寸是以 96px 来计算的，再计算下我当前手机的 DPI（PPI）：</p><pre><code>&gt; ppi(1920,1080,5.5)&lt; 401</code></pre><p><img src="/uploads/2018/Web页面布局/1545798490089.png" alt="1545798490089"></p><p>和在手机上查询到的的确相同。如果想让显示器上通过肉眼看到的元素大小和手机屏幕上看到的元素大小差不多，那么理论上就需要让手机上的元素增大 <code>401/96</code> 倍，但实际并没有这么简单，影响手机上显示元素的大小和电脑上显示不同的因素还有很多。</p><h5 id="设备独立像素"><a href="#设备独立像素" class="headerlink" title="设备独立像素"></a>设备独立像素</h5><p>前面讲到的显示器分辨率 <code>1920 × 1080</code> 这个指实际的物理像素，是屏幕渲染图像的最小单位。而我们在 CSS 中编写的 <code>px</code> 实际上是一种逻辑上的像素。这个逻辑上的像素就是设备独立像素，可以由操作系统或浏览器来管理物理像和素设备独立像素的比例（DPR）。通过 BOM 的 <code>devicePixelRatio</code> 属性可以查询到物理像素和设备独立像素的实际比例：</p><pre><code>&gt; window.screen.width&lt; 1920&gt; window.screen.height&lt; 1080&gt; window.devicePixelRatio&lt; 1</code></pre><p>默认是 1:1，所以我们在 CSS 样式中写的 <code>100px</code> 和实际物理像素是相同的。当我们在页面上调整缩放比例时，页面元素也跟着变化。当缩放比达到 2 倍的时候，设备独立像素是物理像素的 4 倍：<code>(200×200)/(100×100)</code>。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line">        div &#123;</span><br><span class="line">            display: inline-block;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#23d3e7</span>;</span></span><br><span class="line">        &#125; </span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545798490090.gif" alt="1545798490090"></p><p>DPR（物理像素/设备独立像素）控制着由我们在 CSS 中编写的 <code>px</code> 到物理像素的映射比例：</p><ul><li>当设备像素比为1:1时，使用1（1×1）个设备像素显示1个CSS像素</li><li>当设备像素比为2:1时，使用4（2×2）个设备像素显示1个CSS像素</li><li>当设备像素比为3:1时，使用9（3×3）个设备像素显示1个CSS像素</li></ul><p><img src="/uploads/2018/Web页面布局/1502532540.png" alt="img"></p><p>这样，在相同尺寸高清屏上和普通屏上，通过不同的 DPR 就可以让两个元素看起来大小差不多了。而设备独立像素和 DPR 就是为了解决随着技术发展，屏幕不断更新，不同 DPI（PPI）的屏幕显示图像大小差距的问题。</p><p>智能手机和平板设备，厂家在设备出厂时已经预设好了 DPR，同样可以通过 <code>window.devicePixelRatio</code> 来获取。需要注意的是，大多数的移动设备通过 <code>window.screen.width</code> 和 <code>window.screen.height</code> 无法像 PC 设备一样获取准确的屏幕物理像素！</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> info = <span class="built_in">document</span>.querySelector(<span class="string">".info"</span>)</span></span><br><span class="line"><span class="javascript">        info.innerHTML = <span class="string">""</span></span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"devicePixelRatio: "</span> + <span class="built_in">window</span>.devicePixelRatio</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;screen.width: "</span> + <span class="built_in">window</span>.screen.width</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;screen.height: "</span> + <span class="built_in">window</span>.screen.height</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;documentElement.clientWidth: "</span> + </span></span><br><span class="line"><span class="javascript">                            <span class="built_in">document</span>.documentElement.clientWidth;</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;documentElement.clientHeight: "</span> + </span></span><br><span class="line"><span class="javascript">                            <span class="built_in">document</span>.documentElement.clientHeight;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545812771712.png" alt="1545812771712"></p><p>Apple 6s Plus:<br><img src="/uploads/2018/Web页面布局/1545813056095.png" alt="1545813056095"></p><p>Vivo X9:<br><img src="/uploads/2018/Web页面布局/1545813736619.png" alt="1545813736619"></p><p>浏览器上，通过 <code>window.screen</code> 获取了屏幕的物理像素，通过 <code>window.documentElement</code> 获取了页面文档的像素尺寸。而在手机上，却获取了两对奇怪的值。安卓手机的不难发现，<code>screen.width × devicePixelRatio</code> 刚好等于物理像素的 <code>1080</code>，<code>screen.height × devicePixelRatio</code> 刚好等于物理像素的 <code>1920</code>，而苹果手机则设置的大了一些。这个就涉及到了视口的概念。</p><h5 id="视口（viewport）"><a href="#视口（viewport）" class="headerlink" title="视口（viewport）"></a>视口（viewport）</h5><p>视口的概念是在移动设备才存在的。由于移动设备的屏幕一般都比较小，而且大部分网站都是为 PC 端准备的，移动设备不得不做一些处理才能让 PC 的页面正常显示在手机上。</p><h6 id="布局视口"><a href="#布局视口" class="headerlink" title="布局视口"></a>布局视口</h6><p>布局视口（<code>layout viewpoer</code>）是指我们可以进行页面布局的区域，相当于浏览器的窗口大小决定页面如何布局。移动设备的浏览器窗口是没法改变大小的，默认宽度就是屏幕的宽度。但是移动厂商并没有直接将屏幕的物理像素宽度直接给布局视口用，而是使用了一个默认值，并允许我们自行设置。这个值在大多数的设备上都是 <code>980px</code> 也就是我们通过 <code>document.documentElement.clientWidth</code> 获取的值。一般情况下我们都不关心页面的高度，因为如果高度超出会自动出现滚动条。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line">        div &#123;</span><br><span class="line">            width: 245px;</span><br><span class="line">            height: 200px;</span><br><span class="line">            float: left;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#23d3e7</span>;</span></span><br><span class="line">        &#125; </span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#2b2bff</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#777777</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff3e9e</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545816231699.png" alt="1545816231699"></p><p>4 个宽度为 <code>245px</code> 的盒子刚好平铺一行，当我们把其中一个盒子的宽度增加 1 像素，立马最后一个盒子被挤下去了：</p><p><img src="/uploads/2018/Web页面布局/1545816429624.png" alt="1545816429624"></p><p>稍后再讲如何自定义这个值。</p><h6 id="理想视口"><a href="#理想视口" class="headerlink" title="理想视口"></a>理想视口</h6><p>理想视口（<code>ideal viewport</code>）是设备的屏幕区域，是以设备的独立像素作为单位，并由 <code>devicePixelRatio</code> 的值自动映射为屏幕物理像素。这个值是不可能被改变的，我们可以通过 <code>window.screen.width</code> 和 <code>window.screen.height</code> 来获取。这也刚好解释了为什么获取到的值刚好或差不多比屏幕物理像素小 <code>devicePixelRatio</code> 倍。</p><p>至于为什么选择 <code>360px</code>，<code>375px</code> 这样的值，大概是因为智能手机刚发展的时候屏幕物理像素大部分都是 <code>480*320px</code>，之后手机屏幕的技术发展，出现了 <code>960*640px</code> 到 <code>1920*1080px</code> 甚至 2K 屏的时候，为了页面尺寸兼容以前的手机，所以 <code>devicePixelRatio</code> 由 1 变成了 2，然后变成了 3 又变成了 4。</p><h5 id="视口控制"><a href="#视口控制" class="headerlink" title="视口控制"></a>视口控制</h5><p>我们可以在 <code>head</code> 标签中添加 <code>&lt;meta name=&quot;viewport&quot; content=&quot;&quot;&gt;</code> 来对页面进行控制。可以控制的属性如下表：</p><table><thead><tr><th>属性</th><th>可取值</th><th>含义</th></tr></thead><tbody><tr><td>width</td><td>数值或 device-width</td><td>layout viewport 的宽度</td></tr><tr><td>height</td><td>数值或 device-width</td><td>layout viewport 的高度</td></tr><tr><td>initital-scale</td><td>数值，可以是小数</td><td>页面的初始缩放值</td></tr><tr><td>maximum-scale</td><td>数值，可以是小数</td><td>允许用户最大缩放值</td></tr><tr><td>minimum-scale</td><td>数值，可以是小数</td><td>允许用户最小缩放值</td></tr><tr><td>user-scalable</td><td>no 或者 yes</td><td>是否用户进行缩放</td></tr></tbody></table><p>移动端浏览器上，如果页面过大，要么出现滚动条，那么缩放显得很小。理想状态下应该是既不发生缩放，也不出现横向滚动条，看看如何通过配置实现吧。</p><p>我们可以将 <code>layout viewport</code> 的宽度设置的和 <code>ideal viewport</code> 一样，这样就不会出现横向的滚动条了。设置方法是将 <code>width</code> 的值设置为 <code>device-width</code>：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line">        div &#123;</span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">            float: left;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#23d3e7</span>;</span></span><br><span class="line">        &#125; </span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#2b2bff</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#777777</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ff3e9e</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">        p &#123;</span><br><span class="line">            clear: both;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> info = <span class="built_in">document</span>.querySelector(<span class="string">".info"</span>)</span></span><br><span class="line"><span class="javascript">        info.innerHTML = <span class="string">""</span></span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"devicePixelRatio: "</span> + <span class="built_in">window</span>.devicePixelRatio</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;screen.width: "</span> + <span class="built_in">window</span>.screen.width</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;screen.height: "</span> + <span class="built_in">window</span>.screen.height</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;documentElement.clientWidth: "</span> + </span></span><br><span class="line"><span class="javascript">                            <span class="built_in">document</span>.documentElement.clientWidth;</span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"&lt;br&gt;documentElement.clientHeight: "</span> + </span></span><br><span class="line"><span class="javascript">                            <span class="built_in">document</span>.documentElement.clientHeight;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545828113342.png" alt="1545828113342"></p><p>可以看到，4 个盒子的宽度是 <code>100px</code> 但是页面只有 <code>360px</code>，所以最后一个盒子被挤到了下面，接下来将 <code>width</code> 的值设置为 <code>400</code>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=400"</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="/uploads/2018/Web页面布局/1545830029389.png" alt="1545830029389"></p><p>还有一个 <code>initital-scale</code> 可以设置 <code>layout viewport</code>，它的值是页面初始的缩放比例，相当于 <code>ideal viewport / layout viewport</code>，所以 <code>width=device-width</code> 就相当于 <code>initial-scale=1</code>。如果值为<br>一般为了兼容性问题，这两个属性都要写。</p><p><code>maximum-scale</code> 和 <code>minimum-scale</code> 是允许用户最大和最小的缩放值，超过或小于设置的值，用户就没法继续放大或缩小页面了。</p><p>还有一个比较常用的设置是 <code>user-scalable</code>，将它设置为 <code>no</code> 的时候用户就没法用双指对页面进行缩放了。添加新的设置无需创建新的 <code>meta</code> 标签，用逗号分隔，直接写到一起即可：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width,initial-scale=0.5,user-scalable=no"</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="页面布局"><a href="#页面布局" class="headerlink" title="页面布局"></a>页面布局</h3><p>随着设备越来越丰富，传统 PC 页面并不能完美的展现在各种屏幕上，为不同的设备再单独开发一套页面来成本也比较大，那么如何让一套页面适应各种屏幕就非常重要了。除了传统的 PC 页面静态布局方式之外，移动互联网的发展也促进了布局方式的发展。</p><h4 id="流式布局"><a href="#流式布局" class="headerlink" title="流式布局"></a>流式布局</h4><p>流式布局（Liquid）是页面元素的宽度按照屏幕分辨率进行适配调整，但整体布局不变。代表作栅栏系统（网格系统）。网页中主要的划分区域的尺寸使用百分数（搭配 <code>min-*</code>、<code>max-*</code> 属性使用）。</p><h5 id="栅栏系统"><a href="#栅栏系统" class="headerlink" title="栅栏系统"></a>栅栏系统</h5><p>说到栅栏系统，就不得不说大名鼎鼎的 <code>bootstrap</code>。<code>bootstrap</code> 将整个页面或某个局部元素的行平均分成 12 等列，然后我们再分配好某个元素在不同的设备下的显示占 12 等列的具体多少列。然后通过媒体查询的方式对页面进行自适应。</p><p>看一个例子：<br><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.row</span> &gt; <span class="selector-tag">div</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">border</span>: 1<span class="selector-tag">px</span> <span class="selector-tag">solid</span> <span class="selector-id">#c9c1d5</span>;</span></span><br><span class="line">            border-radius: 5px;</span><br><span class="line">            height: 50px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.row</span> &gt; <span class="selector-tag">div</span><span class="selector-pseudo">:nth-last-of-type(2n)</span>&#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#ccc</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.row</span> &#123;</span></span><br><span class="line">            margin-bottom: 20px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container-fluid"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 col-sm-3 col-xs-6"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 col-sm-3 col-xs-6"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 col-sm-3 hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 col-sm-3 hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-1 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-8 col-sm-4"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-4 col-sm-8 hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-3 col-sm-4 col-xs-6"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-3 col-sm-4 col-xs-6"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-3 col-sm-4 col-xs-6"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-3 col-sm-4 col-xs-6"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 hidden-sm hidden-xs"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div></p><p><img src="/uploads/2018/Web页面布局/1545830023000.gif" alt="1545830023000"></p><p>可以通过类名的方式设置页面元素在哪种屏幕下所占的比例是多少，以及在哪种屏幕下隐藏元素。没有隐藏的元素，当屏幕不够时会自动换行显示。具体的细节可以翻阅 <code>bootstrap</code> <a href="http://www.bootcss.com/" target="_blank" rel="noopener">中文文档</a></p><h4 id="Flex布局"><a href="#Flex布局" class="headerlink" title="Flex布局"></a>Flex布局</h4><p>2009 年的时候，W3C 提出了 Flex 布局，可以非常方便快捷的实现各种页面布局，并且还是响应式的。目前PC 端，如果页面要求兼容 IE10 以下，那么 Flex 布局就不要想了，但是现在的移动端几乎全部支持 Flex。</p><p>Flex 意为弹性盒子，任何一个盒子将 <code>display</code> 设置为 <code>flex</code> 都可以指定为 Flex 布局，行内元素也可以设置为 <code>inline-flex</code> 来使用 Flex 布局。Flex 自成 BFC 区域，所以只会影响到当前的盒子。设为 Flex 布局后，子元素就无法使用 <code>float</code>，<code>clear</code>，<code>vertical-align</code> 属性了。</p><h5 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h5><p><img src="/uploads/2018/Web页面布局/2015071004.png" alt="img"></p><ul><li>主轴：Flex 的子元素默认按照主轴的方向从左往右排列</li><li>侧轴：与主轴垂直的轴，默认从上到下。</li></ul><p>当给父容器设置为 Flex 布局后，子元素都转为了 Flex 项目，并且在父容器内按主轴排列。每个子元素占主轴的空间叫主轴尺寸，占侧轴的空间叫侧轴尺寸。</p><p>先来体验一下 Flex 布局：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 80%;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            margin: 100px auto;</span><br><span class="line">            display: flex;</span><br><span class="line">            text-align: center;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-attr">[class^=box]</span>&#123;</span></span><br><span class="line">            font-size: 24px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#808080</span></span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#f4a8b9</span>;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#bdaeee</span>;</span></span><br><span class="line">            flex: 2;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#77c5ee</span>;</span></span><br><span class="line">            flex: 1;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#aef1ab</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span>内容撑开盒子<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545892573207.png" alt="1545892573207"></p><p>首先给 <code>box1</code> 设置了固定的宽高，那么它就会独占这么多空间，<code>box2</code> 通过 <code>flex</code> 设置它占据 Flex 容器的 2 份剩余空间，<code>box3</code> 占据 1 份 Flex 容器的剩余空间。之所以是剩余空间，因为 Flex 会优先给设置了固定宽高以及内容撑开的盒子分配空间，之后才会将剩余空间按照 <code>flex</code> 指定的份数继续分配。不过若是给 <code>box1</code> 也设置了 <code>flex</code> 属性，那么给 <code>box1</code> 手动设置的宽高将失效！</p><p>当对窗体进行拉伸，改变了父容器的大小时，子元素也会自动适应。这就是为什么叫弹性盒子的原因了。</p><h5 id="排列方向"><a href="#排列方向" class="headerlink" title="排列方向"></a>排列方向</h5><p>默认 4 个盒子的排列方向是从左往右，我们也可以改成从右向左，从上到下甚至从下到上。通过 <code>flex-direction</code> 属性可以实现，默认属性值是 <code>row</code>。</p><h6 id="从右向左排列"><a href="#从右向左排列" class="headerlink" title="从右向左排列"></a>从右向左排列</h6><p>给父容器添加 <code>flex-direction: row-reverse</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-direction</span>: row-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545892861208.png" alt="1545892861208"></p><p>盒子主轴起始方向变成了右边。</p><h6 id="从上向下排列"><a href="#从上向下排列" class="headerlink" title="从上向下排列"></a>从上向下排列</h6><p>将父容器的 <code>flex-direction</code> 设置为 <code>column</code> 原来的侧轴就变成了主轴，元素将默认从上向下排列：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/2018/Web页面布局/1545893174322.png" alt="1545893174322"></p><p><code>.box1</code> 由于固定了宽度，因为空出一大片空白。</p><h6 id="从下往上排列"><a href="#从下往上排列" class="headerlink" title="从下往上排列"></a>从下往上排列</h6><p>将父容器的 <code>flex-direction</code> 设置为 <code>column-reverse</code>：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-direction</span>: column-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/2018/Web页面布局/1545893336962.png" alt="1545893336962"></p><h5 id="调整主轴对齐"><a href="#调整主轴对齐" class="headerlink" title="调整主轴对齐"></a>调整主轴对齐</h5><p>如果子元素没有占满父元素，那么就会留下空白。这种情况我们就能调整子元素间如何对齐</p><p><code>justify-content</code> 属性用来调整子元素在主轴上的对齐方式，目前可用的值有 6 个：<code>flex-start</code>、<code>flex-end</code>、<code>center</code>、<code>space-between</code>、<code>space-around</code>、<code>space-evenly</code>。</p><p>一定要注意，调整主轴对齐会受主轴方向的影响！（<code>flex-direction</code>）。</p><h6 id="主轴开始位置对齐"><a href="#主轴开始位置对齐" class="headerlink" title="主轴开始位置对齐"></a>主轴开始位置对齐</h6><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 80%;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            margin: 100px auto;</span><br><span class="line">            display: flex;</span><br><span class="line">            text-align: center;</span><br><span class="line">            justify-content: flex-start;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-attr">[class^=box]</span>&#123;</span></span><br><span class="line">            font-size: 24px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#808080</span>;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#f4a8b9</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#bdaeee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#77c5ee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#aef1ab</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545894032141.png" alt="1545894032141"></p><p>默认就是 <code>flex-start</code> 对齐。</p><h6 id="主轴结束位置对齐"><a href="#主轴结束位置对齐" class="headerlink" title="主轴结束位置对齐"></a>主轴结束位置对齐</h6><p>将父容器的 <code>justify-content</code> 设置为 <code>flex-end</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: flex-end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545894181522.png" alt="1545894181522"></p><h6 id="主轴中间位置对齐"><a href="#主轴中间位置对齐" class="headerlink" title="主轴中间位置对齐"></a>主轴中间位置对齐</h6><p>将父容器的 <code>justify-content</code> 设置为 <code>center</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545894250448.png" alt="1545894250448"></p><h6 id="空白在子元素之间"><a href="#空白在子元素之间" class="headerlink" title="空白在子元素之间"></a>空白在子元素之间</h6><p>将父容器的 <code>justify-content</code> 设置为 <code>space-between</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-between;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545894355915.png" alt="1545894355915"></p><h6 id="空白环绕子元素"><a href="#空白环绕子元素" class="headerlink" title="空白环绕子元素"></a>空白环绕子元素</h6><p>将父容器的 <code>justify-content</code> 设置为 <code>space-around</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-around;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545894407702.png" alt="1545894407702"></p><h6 id="子元素平分空白区域"><a href="#子元素平分空白区域" class="headerlink" title="子元素平分空白区域"></a>子元素平分空白区域</h6><p>将父容器的 <code>justify-content</code> 设置为 <code>space-evenly</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-evenly;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545894520715.png" alt="1545894520715"></p><p>这个和 <code>space-around</code> 有点像，不同的是 <code>space-around</code> 子元素的两边空白相等，所以两个子元素中间就有两倍的空白。而 <code>space-evenly</code> 子元素之间和父容器之间的空白都是相等的。</p><h5 id="调整侧轴对齐"><a href="#调整侧轴对齐" class="headerlink" title="调整侧轴对齐"></a>调整侧轴对齐</h5><p>通过调整侧轴对齐相当于调整垂直方向的对齐方式，通过 <code>align-items</code> 来调整。默认值是 <code>stretch</code>，在没有给定子元素固定高度的情况下，会让子元素自动适应父容器的高度。如果设置为其他值，则子元素的高度由子元素的内容区域撑开。</p><p><img src="/uploads/2018/Web页面布局/1545894520716.gif" alt="1545894520716"></p><h6 id="顶部对其"><a href="#顶部对其" class="headerlink" title="顶部对其"></a>顶部对其</h6><p>将父容器的 <code>align-items</code> 设置为 <code>flex-start</code>。如果没有给子元素指定高度，则默认由子元素内容区域撑开：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-evenly;</span><br><span class="line">    <span class="attribute">align-items</span>: flex-start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/2018/Web页面布局/1545894520717.gif" alt="1545894520717"></p><h6 id="底部对齐"><a href="#底部对齐" class="headerlink" title="底部对齐"></a>底部对齐</h6><p>将父容器的 <code>align-items</code> 设置为 <code>flex-end</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-evenly;</span><br><span class="line">    <span class="attribute">align-items</span>: flex-end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545895170248.png" alt="1545895170248"></p><h6 id="垂直居中对齐"><a href="#垂直居中对齐" class="headerlink" title="垂直居中对齐"></a>垂直居中对齐</h6><p>将父容器的 <code>align-items</code> 设置为 <code>center</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">justify-content</span>: space-evenly;</span><br><span class="line">    <span class="attribute">align-items</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545895270452.png" alt="1545895270452"></p><h5 id="换行规则"><a href="#换行规则" class="headerlink" title="换行规则"></a>换行规则</h5><p>如果子元素过多，总宽度超过父容器的宽度了，默认是不会换行的，所有的盒子会挤到一起。可以通过 <code>flex-wrap</code> 来改变这个规则。<code>flex-wrap</code> 只有三个值：<code>nowrap</code>，<code>wrap</code>，<code>wrap-reverse</code>。</p><p>还有一个 <code>flex-flow</code> 相当于 <code>flex-direction</code> 和 <code>flex-wrap</code> 的综合体，可以同时对这两个属性的值进行设置。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 80%;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            margin: 100px auto;</span><br><span class="line">            display: flex;</span><br><span class="line">            text-align: center;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-attr">[class^=box]</span>&#123;</span></span><br><span class="line">            font-size: 24px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#808080</span>;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#f4a8b9</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#bdaeee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#77c5ee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#aef1ab</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>6<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>添加两个盒子，盒子的宽度被自动压缩了：</p><p><img src="/uploads/2018/Web页面布局/1545896942182.png" alt="1545896942182"></p><h6 id="正常换行"><a href="#正常换行" class="headerlink" title="正常换行"></a>正常换行</h6><p>将父容器的 <code>flex-wrap</code> 设置为 <code>wrap</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-wrap</span>: wrap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545897147941.png" alt="1545897147941"></p><h6 id="反转换行"><a href="#反转换行" class="headerlink" title="反转换行"></a>反转换行</h6><p>将父容器的 <code>flex-wrap</code> 设置为 <code>wrap-reverse</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-wrap</span>: wrap-reverse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545897190367.png" alt="1545897190367"></p><h5 id="多行情况下的侧轴对齐"><a href="#多行情况下的侧轴对齐" class="headerlink" title="多行情况下的侧轴对齐"></a>多行情况下的侧轴对齐</h5><p>前面讲到的 <code>align-items</code> 是设置只有单行情况下的侧轴对齐，还有一个 <code>align-content</code> 用来设置多行情况下的侧轴对其。<code>align-content</code> 的使用必须在 <code>flex-direction: row</code> 和 <code>flex-wrap: wrap</code> 或 <code>flex-wrap: wrap-reverse</code> 的情况下才可以使用。</p><p>与 <code>align-items</code> 的性质也一样，默认 <code>stretch</code>，子元素没设置高度会自动拉伸。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-flow</span>: row wrap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/2018/Web页面布局/1545897190368.gif" alt="1545897190368"></p><h6 id="顶部对齐"><a href="#顶部对齐" class="headerlink" title="顶部对齐"></a>顶部对齐</h6><p>将父容器的 <code>align-content</code> 设置为 <code>flex-start</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-flow</span>: row wrap;</span><br><span class="line">    <span class="attribute">align-content</span>: flex-start;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545898408991.png" alt="1545898408991"></p><h6 id="中心对齐"><a href="#中心对齐" class="headerlink" title="中心对齐"></a>中心对齐</h6><p>将父容器的 <code>align-content</code> 设置为 <code>center</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-flow</span>: row wrap;</span><br><span class="line">    <span class="attribute">align-content</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545898531818.png" alt="1545898531818"></p><h6 id="底部对齐-1"><a href="#底部对齐-1" class="headerlink" title="底部对齐"></a>底部对齐</h6><p>将父容器的 <code>align-content</code> 设置为 <code>flex-end</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-flow</span>: row wrap;</span><br><span class="line">    <span class="attribute">align-content</span>: flex-end;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545898574597.png" alt="1545898574597"></p><h6 id="各行之间留空"><a href="#各行之间留空" class="headerlink" title="各行之间留空"></a>各行之间留空</h6><p>将父容器的 <code>align-content</code> 设置为 <code>space-between</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-flow</span>: row wrap;</span><br><span class="line">    <span class="attribute">align-content</span>: space-between;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545898646064.png" alt="1545898646064"></p><h6 id="各行前后都留空"><a href="#各行前后都留空" class="headerlink" title="各行前后都留空"></a>各行前后都留空</h6><p>将父容器的 <code>align-content</code> 设置为 <code>space-around</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-flow</span>: row wrap;</span><br><span class="line">    <span class="attribute">align-content</span>: space-around;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545898892440.png" alt="1545898892440"></p><h6 id="各行平分空白"><a href="#各行平分空白" class="headerlink" title="各行平分空白"></a>各行平分空白</h6><p>将父容器的 <code>align-content</code> 设置为 <code>space-evenly</code>：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.father</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">80%</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">300px</span>;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid blue;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">100px</span> auto;</span><br><span class="line">    <span class="attribute">display</span>: flex;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">    <span class="attribute">flex-flow</span>: row wrap;</span><br><span class="line">    <span class="attribute">align-content</span>: space-evenly;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><img src="/uploads/2018/Web页面布局/1545898982821.png" alt="1545898982821"></p><h5 id="子元素的一些属性"><a href="#子元素的一些属性" class="headerlink" title="子元素的一些属性"></a>子元素的一些属性</h5><p>上面讲到的属性都是应用与父容器的，通过各种属性的配置已经可以实现很多复杂的布局。还有一些用于子元素的属性，可以让 Flex 布局的灵活性更高一层。</p><h6 id="调整子元素顺序"><a href="#调整子元素顺序" class="headerlink" title="调整子元素顺序"></a>调整子元素顺序</h6><p>给子元素的 <code>order</code> 属性设置不同的值，值越大的越靠后，默认是 0 。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box3</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#77c5ee</span>;</span><br><span class="line">    <span class="attribute">order</span>: -<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>只给 <code>.box3</code> 应用了 <code>order</code> 属性，<code>-1</code> 比其他子元素的 <code>order</code> 都小，所以会排在第一个：</p><p><img src="/uploads/2018/Web页面布局/1545899885232.png" alt="1545899885232"></p><h6 id="子元素放大比例"><a href="#子元素放大比例" class="headerlink" title="子元素放大比例"></a>子元素放大比例</h6><p>使用 <code>flex-grow</code> 可以配置当某一行拥有剩余空间的话，将某个元素放大到剩余空间的倍数。值默认是 0 ，不进行放大。</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.box4</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#aef1ab</span>;</span><br><span class="line">    <span class="attribute">flex-grow</span>: <span class="number">0.5</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/uploads/2018/Web页面布局/1545900703463.png" alt="1545900703463"></p><p><code>0.5</code> 倍表示如果一行的剩余空间为 <code>80px</code> 那么 <code>.box4</code> 最多会被放大到 <code>140px</code>，因为剩余空间的 <code>0.5</code> 倍是 <code>40px</code>。</p><h6 id="子元素缩小比例"><a href="#子元素缩小比例" class="headerlink" title="子元素缩小比例"></a>子元素缩小比例</h6><p>使用 <code>flex-shrink</code> 设置一行空间不足时，子元素自动缩小的比例。默认是 1。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 80%;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            margin: 100px auto;</span><br><span class="line">            display: flex;</span><br><span class="line">            text-align: center;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-attr">[class^=box]</span>&#123;</span></span><br><span class="line">            font-size: 24px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#808080</span>;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            flex-shrink: 1;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#f4a8b9</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#bdaeee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#77c5ee</span>;</span></span><br><span class="line">            order: -1</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#aef1ab</span>;</span></span><br><span class="line">            flex-shrink: 0;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>6<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545901886645.png" alt="1545901886645"></p><p>当其他元素的 <code>flex-shrink</code> 为 1，<code>.box4</code> 为 0 的时候，如果没有剩余空间，那么其他元素都会缩小，而 <code>.box4</code> 不会。</p><h6 id="子元素占据固定空间"><a href="#子元素占据固定空间" class="headerlink" title="子元素占据固定空间"></a>子元素占据固定空间</h6><p><code>flex-basis</code> 属性定义了分配多余空间之前，项目占据的主轴空间尺寸。如果 <code>flex-direction</code> 是 <code>row</code>，那么 <code>flex-basic</code>就相当于 <code>width</code>，如果 <code>flex-direction</code> 是 <code>column</code>，它就相当于 <code>height</code>。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 80%;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            margin: 100px auto;</span><br><span class="line">            display: flex;</span><br><span class="line">            text-align: center;</span><br><span class="line">            flex-flow: column wrap;</span><br><span class="line">            align-content: space-evenly;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-attr">[class^=box]</span>&#123;</span></span><br><span class="line">            font-size: 24px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#808080</span>;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            flex-basis: 120px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#f4a8b9</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#bdaeee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#77c5ee</span>;</span></span><br><span class="line">            order: -1</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#aef1ab</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>6<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545902495016.png" alt="1545902495016"></p><h6 id="子元素所占空余空间份数"><a href="#子元素所占空余空间份数" class="headerlink" title="子元素所占空余空间份数"></a>子元素所占空余空间份数</h6><p><code>flex</code> 属性设置子元素占据空余空间的份数，这个在 Flex 布局的刚开始就演示了，这里就不再多说。</p><h6 id="子元素设置特有的对齐方式"><a href="#子元素设置特有的对齐方式" class="headerlink" title="子元素设置特有的对齐方式"></a>子元素设置特有的对齐方式</h6><p>默认子元素的对齐方式是从父容器的 <code>align-items</code> 继承来的，通过 <code>align-self</code> 属性来进行设置，值是 <code>auto</code>。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.father</span> &#123;</span></span><br><span class="line">            width: 80%;</span><br><span class="line">            height: 300px;</span><br><span class="line">            border: 1px solid blue;</span><br><span class="line">            margin: 100px auto;</span><br><span class="line">            display: flex;</span><br><span class="line">            text-align: center;</span><br><span class="line">            flex-flow: row wrap;</span><br><span class="line">            align-items: flex-start;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-attr">[class^=box]</span>&#123;</span></span><br><span class="line">            font-size: 24px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#808080</span>;</span></span><br><span class="line">            width: 100px;</span><br><span class="line">            height: 100px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box1</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#f4a8b9</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box2</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#bdaeee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box3</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#77c5ee</span>;</span></span><br><span class="line">            align-self: flex-end;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box4</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#aef1ab</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"father"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box1"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box2"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box3"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box4"</span>&gt;</span>4<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545903014010.png" alt="1545903014010"></p><h4 id="媒体查询"><a href="#媒体查询" class="headerlink" title="媒体查询"></a>媒体查询</h4><h5 id="基本概念-1"><a href="#基本概念-1" class="headerlink" title="基本概念"></a>基本概念</h5><p>媒体查询是响应式开发中重要的知识点，比如 <code>bootstrap</code> 的响应式布局本质上就是借助媒体查询实现的，那么到底什么是媒体查询呢？其实就是查询屏幕的宽度，然后针对不同的屏幕宽度设置不同的样式来适应不同的屏幕。简单来说，就是给不同屏幕尺寸编写不同的样式，然后 CSS 会自动根据实际的屏幕来应用我们预先编写好的样式。</p><p>bootstrap 中给不同的设备预定义了一些尺寸，这些只是作为建议：</p><table><thead><tr><th>设备</th><th>尺寸</th></tr></thead><tbody><tr><td>超小屏幕，手机等设备</td><td>w &lt; 768px</td></tr><tr><td>小屏设备，平板等设备</td><td>768 &lt;= w &lt; 992</td></tr><tr><td>中等屏幕，桌面显示器等设备</td><td>992 &lt;= w &lt; 1200</td></tr><tr><td>超大屏幕，大型的显示器</td><td>w &gt;= 1200</td></tr></tbody></table><h5 id="语法规则"><a href="#语法规则" class="headerlink" title="语法规则"></a>语法规则</h5><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@media</span> mediatype <span class="keyword">and</span>|<span class="keyword">not</span>|<span class="keyword">only</span> (media feature) &#123;</span><br><span class="line">    <span class="selector-tag">CSS-Code</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>或者针对不同的媒体使用不同的外部样式表：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">media</span>=<span class="string">"mediatype and|not|only (media feature)"</span> </span></span><br><span class="line"><span class="tag"><span class="attr">href</span>=<span class="string">"mystylesheet.css"</span>&gt;</span></span><br></pre></td></tr></table></figure><p>mediatype 的可选值除了已经废弃的有如下几种：</p><table><thead><tr><th>值</th><th>说明</th></tr></thead><tbody><tr><td>all</td><td>用于所有设备</td></tr><tr><td>print</td><td>用于打印机</td></tr><tr><td>screen</td><td>用于电脑屏幕、平板电脑、手机等</td></tr><tr><td>speech</td><td>应用于屏幕阅读器等发声设备</td></tr></tbody></table><p><code>and|not|only</code> 实现简单的逻辑，媒体功能（<code>media feature</code>）最常用的就是 <code>min-width</code> 和 <code>max-width</code> 了。</p><p>接下来看看具体如何编写媒体查询吧。</p><h5 id="自适应实现"><a href="#自适应实现" class="headerlink" title="自适应实现"></a>自适应实现</h5><p>我们现在要编写一套和 bootstrap 一样的媒体查询功能，首先编写屏幕像素小于 <code>768px</code> 的媒体查询：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">768px</span>) &#123;</span></span><br><span class="line">            body &#123;</span><br><span class="line"><span class="css">                <span class="selector-tag">background-color</span>: <span class="selector-id">#b4e9bd</span>;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>这条规则白话文来说就是：如果我们在使用电脑或手机屏幕，并且屏幕的尺寸最大 <code>768px</code>，那么就将页面的背景变成淡绿色。接下来添加大于 <code>768px</code> 小于 <code>992px</code> 的规则：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">768px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">            <span class="attribute">background-color</span>: <span class="number">#b4e9bd</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">768px</span>) <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">992px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">          <span class="attribute">background-color</span>: <span class="number">#f4a8b9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p>这条规则意思是：当屏幕尺寸最小 <code>768px</code> 并且最大 <code>992px</code> 的时候，将页面背景变成淡红色。接下来添加大于 <code>992px</code> 小于 <code>1200px</code> 的规则：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">768px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">            <span class="attribute">background-color</span>: <span class="number">#b4e9bd</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">768px</span>) <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">992px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">            <span class="attribute">background-color</span>: <span class="number">#f4a8b9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">992px</span>) <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">1200px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">            <span class="attribute">background-color</span>: <span class="number">#f4a8b9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p>当屏幕尺寸最小 <code>992px</code> 并且最大 <code>1200px</code> 的时候，将页面背景变成淡紫色。屏幕尺寸大于 <code>1200px</code> 的规则：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="selector-tag">style</span>&gt;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">768px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">            <span class="attribute">background-color</span>: <span class="number">#b4e9bd</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">768px</span>) <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">992px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">            <span class="attribute">background-color</span>: <span class="number">#f4a8b9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">992px</span>) <span class="keyword">and</span> (<span class="attribute">max-width:</span> <span class="number">1200px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">            <span class="attribute">background-color</span>: <span class="number">#f4a8b9</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">1200px</span>) &#123;</span><br><span class="line">        <span class="selector-tag">body</span> &#123;</span><br><span class="line">          <span class="attribute">background-color</span>: <span class="number">#77c5ee</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure><p>屏幕大于 <code>1200px</code> 时，页面背景变成淡蓝色，接下来看看实际表现如何：</p><p><img src="/uploads/2018/Web页面布局/1545903014011.gif" alt="1545903014011"></p><h5 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h5><p>上面的代码虽然已经实现了我们希望的功能，但是一般并不会这么啰嗦的写。我们可以借助设置默认样式和 CSS 的样式覆盖特性来简化代码：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">    body &#123;</span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#b4e9bd</span>;</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">768px</span>)&#123;</span></span><br><span class="line">        body &#123;</span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#f4a8b9</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">992px</span>) &#123;</span></span><br><span class="line">        body &#123;</span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#bdaeee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="css">    <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">min-width:</span> <span class="number">1200px</span>) &#123;</span></span><br><span class="line">        body &#123;</span><br><span class="line"><span class="css">        <span class="selector-tag">background-color</span>: <span class="selector-id">#77c5ee</span>;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我们先设置个默认的背景色，然后随着屏幕尺寸变大，当满足大于 <code>768px</code> 的时候，就自动应用了相应的样式并覆盖掉默认的样式。接着屏幕继续变大，当满足大于 <code>992px</code> 的时候，又将大于 <code>768px</code> 的样式覆盖掉。以此类推，当屏幕大于 <code>1200px</code> 的时候就没有可以覆盖掉它的媒体查询了。</p><p>媒体查询有好处也有坏处，坏处就是移动端和桌面端所需要的样式是并不相同的，甚至移动端有一些页面元素也不需要显示，但是依然会将所有的代码都下载下来，甚至不需要显示的一些图片等资源也会被下载下来。</p><h4 id="rem布局"><a href="#rem布局" class="headerlink" title="rem布局"></a>rem布局</h4><p><code>rem</code> 屏幕与像素的一章中有讲到，是一个尺寸单位。有一个与它类似的单位是 <code>em</code>，这个单位与 <code>px</code> 的换算基于当前容器的字号，则字号所以经常被用在段落首行缩进上：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        div &#123;</span><br><span class="line">            text-indent: 2em;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        这是一段话。这是一段话。这是一段话。</span><br><span class="line">        这是一段话。这是一段话。这是一段话。</span><br><span class="line">        这是一段话。这是一段话。这是一段话。</span><br><span class="line">        这是一段话。这是一段话。这是一段话。</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        这是一段话。这是一段话。这是一段话。</span><br><span class="line">        这是一段话。这是一段话。这是一段话。</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545925122734.png" alt="1545925122734"></p><p>但是 <code>em</code> 并不适合布局，浏览器默认字号是 <code>16px</code>，但是每一个页面元素的字号并不全部相同，那么 <code>1em</code> 在不同的元素中可能都不相同，会给我们带来换算上的麻烦。而 <code>rem</code> 基于根标签（<code>html</code>）的字号，这样整个页面中 <code>1rem</code> 的值每个元素中都是相同的。</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        html &#123;</span><br><span class="line">            font-size: 20px;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 10rem;</span><br><span class="line">            height: 10rem;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#69ccf1</span>;</span></span><br><span class="line">            position: relative;</span><br><span class="line">            top: 100px;</span><br><span class="line">            left: 100px;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p><img src="/uploads/2018/Web页面布局/1545927069923.png" alt="1545927069923"></p><p>将 <code>html</code> 的字号改为 <code>20px</code>，<code>10rem</code> 的确相当于 <code>200px</code>。这样的好处是什么呢，那就是我们可以只更改根元素的字号，就可以让页面其他使用 <code>rem</code> 的元素都进行改变而不用改它们的样式。最简单的方法就是配合媒体查询，不同的屏幕像素，然后给根元素一个不同的字号。</p><p>这个字号该如何计算呢？这个并没有一个标准，我们可以将屏幕分成 20 份，然后将每一份的值做为字号。比如移动端如果 <code>viewport</code> 的 <code>device-width</code> 为 360 像素，我们就可以将字号设置为 <code>360 / 20 = 18px</code>。下面看代码实现：</p><div><div class="fold_hider"><div class="close hider_title"> 点击显示/隐藏代码</div></div><div class="fold"><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">device-width:</span> <span class="number">360px</span>) &#123;</span></span><br><span class="line">            html &#123;</span><br><span class="line">                font-size: 18px;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">device-width:</span> <span class="number">375px</span>) &#123;</span></span><br><span class="line">            html &#123;</span><br><span class="line"><span class="css">                <span class="selector-tag">font-size</span>: 18<span class="selector-class">.75px</span>;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="keyword">@media</span> screen <span class="keyword">and</span> (<span class="attribute">device-width:</span> <span class="number">768px</span>) &#123;</span></span><br><span class="line">            html &#123;</span><br><span class="line"><span class="css">                <span class="selector-tag">font-size</span>: 38<span class="selector-class">.4px</span>;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.box</span> &#123;</span></span><br><span class="line">            width: 10rem;</span><br><span class="line">            height: 10rem;</span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span>: <span class="selector-id">#69ccf1</span>;</span></span><br><span class="line">            margin: 2em auto;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-class">.info</span> &#123;</span></span><br><span class="line">            text-align: center;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"box"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">class</span>=<span class="string">"info"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> box = <span class="built_in">document</span>.querySelector(<span class="string">".box"</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">let</span> info = <span class="built_in">document</span>.querySelector(<span class="string">".info"</span>)</span></span><br><span class="line"><span class="javascript">        info.innerHTML = <span class="string">"box width: "</span> + box.clientWidth + <span class="string">"&lt;/br&gt;"</span></span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"box height: "</span> + box.clientHeight + <span class="string">"&lt;/br&gt;"</span></span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"screen width: "</span> + <span class="built_in">window</span>.screen.width + <span class="string">"&lt;/br&gt;"</span></span></span><br><span class="line"><span class="javascript">        info.innerHTML += <span class="string">"screen height: "</span> + <span class="built_in">window</span>.screen.height + <span class="string">"&lt;br&gt;"</span></span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></div></div><p>安卓端显示：</p><p><img src="/uploads/2018/Web页面布局/1545929942772.png" alt="1545929942772"></p><p>苹果手机显示：</p><p><img src="/uploads/2018/Web页面布局/1545930012006.png" alt="1545930012006"></p><p>iPad显示：</p><p><img src="/uploads/2018/Web页面布局/1545930039919.png" alt="1545930039919"></p><p>PC端显示：</p><p><img src="/uploads/2018/Web页面布局/1545930095963.png" alt="1545930095963"></p><p>由于 PC 端 Win10 的原因，对显示器进行了 1.25 的缩放，所以 <code>1536 × 1.25 = 1920</code> 才是实际的分辨率。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><ul><li><a href="http://www.bootcss.com/" target="_blank" rel="noopener">bootstrap</a></li><li><a href="http://www.ruanyifeng.com/blog/2015/07/flex-grammar.html" target="_blank" rel="noopener">Flex - 阮一峰</a></li><li><a href="http://www.runoob.com/cssref/css3-pr-mediaquery.html" target="_blank" rel="noopener">媒体查询</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;使用现代前端技术开发的应用，不管是 Web 页面，还是混合开发的手机 APP，都离不开页面元素的布局。而布局又可以说是页面开发里最麻烦的地方，不仅要兼容不同的设备，还要兼容不同的浏览器，还很可能一不小心改错了一个值就造成整个页面的雪崩。这里汇总下关于页面布局的基础知识以及一些开发中的经验。&lt;br&gt;
    
    </summary>
    
    
      <category term="Web" scheme="http://www.yunfwe.cn/categories/Web/"/>
    
    
      <category term="web" scheme="http://www.yunfwe.cn/tags/web/"/>
    
      <category term="css" scheme="http://www.yunfwe.cn/tags/css/"/>
    
      <category term="flex" scheme="http://www.yunfwe.cn/tags/flex/"/>
    
  </entry>
  
  <entry>
    <title>从零开始搭建Vue开发环境</title>
    <link href="http://www.yunfwe.cn/2018/12/21/2018/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BAVue%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    <id>http://www.yunfwe.cn/2018/12/21/2018/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BAVue%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</id>
    <published>2018-12-21T04:50:00.000Z</published>
    <updated>2018-12-20T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Vue (读音 /vjuː/，类似于 view) 是一套用于构建用户界面的渐进式框架。与其它大型框架不同的是，Vue 被设计为可以自底向上逐层应用。Vue 的核心库只关注视图层，不仅易于上手，还便于与第三方库或既有项目整合。另一方面，当与现代化的工具链以及各种支持类库结合使用时，Vue 也完全能够为复杂的单页应用提供驱动。本篇文章记录不使用 vue-cli 的自动化功能，手动搭建一个 Vue 的开发环境。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><table><thead><tr><th>软件</th><th>版本</th></tr></thead><tbody><tr><td>操作系统</td><td>Windows 10</td></tr><tr><td>Node.js</td><td>v10.13.0</td></tr><tr><td>Chrome浏览器</td><td>70</td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="初始化项目目录"><a href="#初始化项目目录" class="headerlink" title="初始化项目目录"></a>初始化项目目录</h3><p>创建一个空的目录作为项目目录，并在目录内执行 <code>npm init --yes</code></p><pre><code>D:\Workspace\webapp&gt;npm init --yesWrote to D:\Workspace\webapp\package.json:{&quot;name&quot;: &quot;webapp&quot;,&quot;version&quot;: &quot;1.0.0&quot;,&quot;description&quot;: &quot;&quot;,&quot;main&quot;: &quot;index.js&quot;,&quot;scripts&quot;: {    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;},&quot;keywords&quot;: [],&quot;author&quot;: &quot;&quot;,&quot;license&quot;: &quot;ISC&quot;}</code></pre><p>并创建新目录 <code>src</code> 作为代码的存放目录。在 <code>src</code> 目录中创建 <code>index.html</code> 写入以下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="加速-npm-包下载"><a href="#加速-npm-包下载" class="headerlink" title="加速 npm 包下载"></a>加速 npm 包下载</h3><p>默认的 npm 非常连接官方的 npm 源，下载速度非常慢，可以使用 <code>cnpm</code> 来加速下载。</p><p>首先全局安装 cnpm<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g cnpm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure></p><p>之后就可以使用 cnpm 来开心的下载 npm 包了，但是 cnpm 下载某些包会出现依赖无法完全解决的问题，导致包无法正常使用，这种情况就只好配合 npm 来使用了。</p><p>还有一种加速 npm 包下载的方法，就是让默认的 npm 命令使用国内的 npm 镜像站。可以注意到，上一条安装 cnpm 的命令中，就使用了 <code>--registry=https://registry.npm.taobao.org</code> 临时将下载源切换到 taobao 提供的 npm 镜像站。这里使用 <code>nrm</code> 工具来切换镜像站，nrm 工具也需要先使用 npm 来安装。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g nrm --registry=https://registry.npm.taobao.org</span><br></pre></td></tr></table></figure><p><code>nrm ls</code> 命令可以看到当前默认使用的是 npm 的官方源</p><pre><code>D:\Workspace\webapp&gt;nrm ls* npm ---- https://registry.npmjs.org/cnpm --- http://r.cnpmjs.org/taobao - https://registry.npm.taobao.org/nj ----- https://registry.nodejitsu.com/rednpm - http://registry.mirror.cqupt.edu.cn/npmMirror  https://skimdb.npmjs.com/registry/edunpm - http://registry.enpmjs.org/</code></pre><p>使用 <code>nrm use taobao</code> 将默认源切换到 taobao 提供的镜像站</p><pre><code>D:\Workspace\webapp&gt;nrm use taobaoRegistry has been set to: https://registry.npm.taobao.org/D:\Workspace\webapp&gt;nrm lsnpm ---- https://registry.npmjs.org/cnpm --- http://r.cnpmjs.org/* taobao - https://registry.npm.taobao.org/nj ----- https://registry.nodejitsu.com/rednpm - http://registry.mirror.cqupt.edu.cn/npmMirror  https://skimdb.npmjs.com/registry/edunpm - http://registry.enpmjs.org/</code></pre><h3 id="搭建-webpack-开发环境"><a href="#搭建-webpack-开发环境" class="headerlink" title="搭建 webpack 开发环境"></a>搭建 webpack 开发环境</h3><h4 id="安装-webpack"><a href="#安装-webpack" class="headerlink" title="安装 webpack"></a>安装 webpack</h4><p>Vue 官方推荐的开发方式是配合 <code>webpack</code> 打包工具，那么首先把 webpack 环境搭建起来。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install webpack webpack-cli --save-dev</span><br></pre></td></tr></table></figure><p>webpack3 中，webpack和它的命令行工具都包含在一个包中，但在 webpack4 中，官方将两者分开了，所以必须两个包都安装才可以使用 <code>webpack</code> 命令。官方推荐局部安装 webpack ，直接输入 webpack 命令是没法找到的，高版本的 node.js 可以使用 npx 命令来执行 webpack，或者直接使用相对路径执行 webpack。</p><pre><code>D:\Workspace\webapp&gt;webpack -v&apos;webpack&apos; 不是内部或外部命令，也不是可运行的程序或批处理文件。D:\Workspace\webapp&gt;npx webpack -v4.28.0D:\Workspace\webapp&gt;node_modules\.bin\webpack -v4.28.0</code></pre><h4 id="使用-webpack-打包"><a href="#使用-webpack-打包" class="headerlink" title="使用 webpack 打包"></a>使用 webpack 打包</h4><p>接下来在 src 目录下编写一个 <code>main.js</code>，文件内容如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello webpack!&lt;h1&gt;"</span></span><br></pre></td></tr></table></figure><p>将 <code>main.js</code> 打包为 <code>bundle.js</code>，我们一般将打包后的文件单独放到 <code>dist</code> 目录下：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npx webpack src\main.js -o dist\bundle.js --mode development</span><br></pre></td></tr></table></figure><pre><code>D:\Workspace\webapp&gt;npx webpack src\main.js -o dist\bundle.js --mode developmentHash: 8a16b3a0c76c2b1d9f8aVersion: webpack 4.28.0Time: 94msBuilt at: 2018-12-20 22:58:15    Asset      Size  Chunks             Chunk Namesbundle.js  3.85 KiB    main  [emitted]  mainEntrypoint main = bundle.js[./src/main.js] 82 bytes {main} [built]</code></pre><p>如果不加上 <code>--mode development</code>，webpack 则默认使用 <code>production</code> 级别去打包，如果代码里有 <code>console.log</code> 等无关程序运行逻辑的代码都会被清理掉，这样不方便项目的调试。这时可以看到项目目录下多出来一个 <code>dist</code> 目录，目录中有一个打包好的 <code>bundle.js</code>。这个例子中并没有在 <code>main.js</code> 里引入第三方的文件，如果引入了，webpack 也会一并打包为一个 <code>bundle.js</code>。</p><p>在 <code>index.html</code> 里引入打包好的 <code>bundle.js</code>：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../dist/bundle.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>浏览器查看效果：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545318454063.png" alt="1545318454063"></p><h4 id="webpack-配置文件"><a href="#webpack-配置文件" class="headerlink" title="webpack 配置文件"></a>webpack 配置文件</h4><p>用命令行的方式是非常不方便，如果关闭了终端，下次使用 webpack 编译代码就还需要输入长长的一串代码，我们可以将代码写入到 webpack 的配置文件中，并配合 <code>package.json</code> 提供的自定义脚本命令功能来实现方便的编译。</p><p>与 <code>package.json</code> 同级的目录下创建 <code>webpack.config.js</code> 文件，当前项目目录下为：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545318902621.png" alt="1545318902621"></p><p><code>webpack.config.js</code> 里写入如下内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, <span class="string">'./src/main.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">"development"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码语法使用 node.js 的语法，并使用 <code>module.exports</code> 将配置暴露出去，其中 <code>entry</code> 表示入口文件，也就是我们的 <code>main.js</code> 所在的目录。<code>output</code> 提供一个输出的目录和打包后的文件名。<code>mode</code> 则是配置使用哪种模式进行打包。之后我们对 webpack 的配置也都是围绕这个文件进行。</p><p>这是在命令行只输入 <code>npx webpack</code> 命令，可以看到也编译成功了。</p><p>接着修改 <code>package.json</code>，在 <code>scripts</code> 项中添加 <code>&quot;build&quot;: &quot;webpack&quot;</code>，这里就不需要借助 npx 工具来执行 webpack 了，npm 会在合适的位置运行 webpack 命令。</p><p>当前 <code>package.json</code> 内容如下：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"webapp"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"webpack"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"keywords"</span>: [],</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"webpack"</span>: <span class="string">"^4.28.0"</span>,</span><br><span class="line">    <span class="attr">"webpack-cli"</span>: <span class="string">"^3.1.2"</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台运行 <code>npm run build</code></p><pre><code>D:\Workspace\webapp&gt;npm run build&gt; webapp@1.0.0 build D:\Workspace\webapp&gt; webpackHash: 8a16b3a0c76c2b1d9f8aVersion: webpack 4.28.0Time: 95msBuilt at: 2018-12-20 23:25:53    Asset      Size  Chunks             Chunk Namesbundle.js  3.85 KiB    main  [emitted]  mainEntrypoint main = bundle.js[./src/main.js] 82 bytes {main} [built]</code></pre><p>预设的命令执行成功了。</p><h4 id="webpack-dev-server-配置"><a href="#webpack-dev-server-配置" class="headerlink" title="webpack-dev-server 配置"></a>webpack-dev-server 配置</h4><p>每次更改了代码，每次都需要重新编译，并刷新浏览器页面，这样是非常浪费时间的。而且通过文件的方式在浏览器预览效果，后期可能会出现各种问题。<code>webpack-dev-server</code> 则提供了一个支持时时编译，并自动刷新浏览器的功能。</p><p>我们首先安装它：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install webpack-dev-server --save-dev</span><br></pre></td></tr></table></figure><p>webpack-dev-server 也支持直接通过命令行参数启动，但是既然已经使用了 <code>webpack.config.js</code> 来管理配置，那么就不提倡命令行参数启动了。修改 <code>webpack.config.js</code> 内容如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, <span class="string">'./src/main.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">"development"</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        open: <span class="literal">true</span>,</span><br><span class="line">        port: <span class="number">3000</span>,</span><br><span class="line">        hot: <span class="literal">true</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们添加了 <code>devServer</code> 和 <code>plugins</code> 配置项，并导入了一个新的包 <code>webpack</code>。<br><code>devServer</code> 里配置的三个属性，<code>open</code> 表示自动帮我们打开浏览器，<code>port</code> 表示服务监听在 3000 端口，<code>hot</code> 表示开启热加载功能。热加载功能一个需要注意的地方就是需要在 <code>plugins</code> 里添加这个插件，否则热加载功能是关闭的，所以才有了 <code>new webpack.HotModuleReplacementPlugin()</code> 这段代码。</p><p>还有一个需要注意的地方是，使用 <code>webpack-dev-server</code> 时一定要将 <code>mode</code> 设置为 <code>development</code>，否则每次热更新都非常慢，因为编译为 <code>production</code> 是非常耗时且消耗 CPU 资源的，但是可以给打包后的代码带来更小的体积。</p><p>接着在 <code>package.json</code> 中添加命令，并修改 <code>build</code> 命令构建 <code>production</code> 级别的代码：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">"scripts": &#123;</span><br><span class="line">  "test": "echo \"Error: no test specified\" &amp;&amp; exit 1",</span><br><span class="line">  "build": "webpack --mode production",</span><br><span class="line">  "dev": "webpack-dev-server"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>控制台输入 <code>npm run dev</code> 命令，可以看到 <code>webpack-dev-server</code> 开始执行了，片刻，浏览器也自动打开了项目的根目录的页面：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545320800406.png" alt="1545320800406"></p><p><code>index.html</code> 在 <code>src</code> 目录下，点击 <code>src</code> 目录则打开了先前的页面。修改 <code>main.js</code> 里的内容为如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello Vue!&lt;h1&gt;"</span></span><br></pre></td></tr></table></figure><p>可以看到每次对代码 <code>Ctrl + S</code> 保存一次，控制台就多输出一些内容，如果内容有 <code>Compiled successfully.</code> 则表示自动编译成功了，当我们兴高采烈的刷新浏览器时发现，怎么一点变化都没！这是因为 <code>webpack-dev-server</code> 并不是直接将编译后的代码保存在磁盘上，而且放在了内存中。而我们刚才的 <code>index.html</code> 引入的还是之前编译好的 <code>bundle.js</code> 文件。</p><p>修改 <code>index.html</code> 将引入 <code>bundle.js</code> 的代码改为 <code>&lt;script src=&quot;/bundle.js&quot;&gt;&lt;/script&gt;</code>，接着重启服务或者刷新浏览器试试：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545322079036.png" alt="1545322079036"></p><p>而且每次修改了 <code>main.js</code> 后都会自动帮我们编译并刷新浏览器。<br>还有个小问题，<code>webpack-dev-server</code> 每次打开浏览器能不能直接定位到 <code>index.html</code> 而不是我们手动进入 <code>src</code> 目录呢？答案是肯定的，修改 <code>devServer</code> 的属性如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">devServer: &#123;</span><br><span class="line">    open: <span class="literal">true</span>,</span><br><span class="line">    port: <span class="number">3000</span>,</span><br><span class="line">    hot: <span class="literal">true</span>,</span><br><span class="line">    contentBase: <span class="string">"src"</span>,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p><code>contentBase</code> 会告诉 <code>webpack-dev-server</code> 以哪个目录作为根目录，然后重启 <code>webpack-dev-server</code> 可以看到浏览器自动打开的就是我们希望看到的页面了。</p><p>但是。。。当我们自动修改了 <code>main.js</code> 的时候，<code>webpack-dev-server</code> 会自动编译并把它放入内存，而 <code>index.html</code> 依然在物理磁盘上，那么我们能不能把这个文件也放入内存？这时还需要借助一个 <code>html-webpack-plugin</code> 的插件，接下来安装并使用它：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install html-webpack-plugin --save-dev</span><br></pre></td></tr></table></figure><p>修改 <code>webpack.config.js</code> 为如下内容：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>)</span><br><span class="line"><span class="keyword">const</span> htmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">"html-webpack-plugin"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, <span class="string">'./src/main.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">"development"</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        open: <span class="literal">true</span>,</span><br><span class="line">        port: <span class="number">3000</span>,</span><br><span class="line">        hot: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// contentBase: "src",</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">        <span class="keyword">new</span> htmlWebpackPlugin(&#123;</span><br><span class="line">            template: path.join(__dirname, <span class="string">"./src/index.html"</span>),</span><br><span class="line">            filename: <span class="string">"index.html"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里我们做了三处更改，首先引入了 <code>html-webpack-plugin</code> 这个插件，然后注释掉了 <code>contentBase: &quot;src&quot;</code>，接着初始化了 <code>htmlWebpackPlugin</code> 的对象，并将 <code>index.html</code> 的路径和文件名提供给插件。</p><p>还需要修改 <code>index.html</code> 将引入 <code>bundle.js</code> 的代码去掉：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后重启 <code>webpack-dev-server</code> 可以看到，又打开了熟悉的页面。为什么我们没有引入 <code>bundle.js</code> 还可以正常显示页面呢？打开控制台可以看到，<code>html-webpack-plugin</code> 已经帮我们自动加入这句代码了。</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545323432735.png" alt="1545323432735"></p><p>其实这个插件最重要的一点是，我们执行 <code>npm run build</code> 编译项目的时候，<code>html-webpack-plugin</code> 还会帮我们把处理好的 <code>index.html</code> 文件放入 <code>dist</code> 目录中。</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545323871346.png" alt="1545323871346"></p><h4 id="webpack-处理-css"><a href="#webpack-处理-css" class="headerlink" title="webpack 处理 css"></a>webpack 处理 css</h4><p>webpack 会自动处理 <code>main.js</code> 中通过 <code>import</code> 引入的其他 JavaScript 代码，同样也可以处理通过 <code>import</code> 引入的 <code>css</code> 样式文件，不过需要使用专门的 <code>css-loader</code> 来进行处理。我们需要先安装打包处理 css 文件的两个包：<code>style-loader</code> 和 <code>css-loader</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install style-loader css-loader --save-dev</span><br></pre></td></tr></table></figure><p>现在 webpack 还不认识 css 文件，还需要修改 <code>webpack.config.js</code> 增加处理 css 文件的规则，修改后配置文件内容如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>)</span><br><span class="line"><span class="keyword">const</span> htmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">"html-webpack-plugin"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, <span class="string">'./src/main.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">"development"</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        open: <span class="literal">true</span>,</span><br><span class="line">        port: <span class="number">3000</span>,</span><br><span class="line">        hot: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// contentBase: "src",</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">        <span class="keyword">new</span> htmlWebpackPlugin(&#123;</span><br><span class="line">            template: path.join(__dirname, <span class="string">"./src/index.html"</span>),</span><br><span class="line">            filename: <span class="string">"index.html"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>其中新添了 <code>module</code> 配置项，并在其中添加了 <code>rules</code>。每一条规则都是一个对象格式，其中 <code>test</code> 是正则表达式，用于匹配以 <code>.css</code> 结尾的文件，<code>use</code> 配置了使用哪些加载器来处理匹配到的文件，加载器是从后往前处理的，css 文件先通过 <code>css-loader</code> 处理，然后才经过 <code>style-loader</code> 处理。 </p><p>接着在 src 目录下新建 css 文件夹用于存放公共的 css 样式文件。css 目录中创建 <code>base.css</code> 文件来编写一些基础样式，文件内容如下：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>接着在 <code>main.js</code> 里引入这个样式文件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello Vue!&lt;h1&gt;"</span></span><br></pre></td></tr></table></figure><p>由于更改了 webpack 的配置文件，所以需要重启 <code>webpack-dev-server</code>，然后浏览器查看效果：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545358020146.png" alt="1545358020146"></p><p>样式成功引入了。</p><h5 id="webpack-中使用-less"><a href="#webpack-中使用-less" class="headerlink" title="webpack 中使用 less"></a>webpack 中使用 less</h5><p>对于习惯用 less 的语法来写 css 的开发者，webpack 也提供了相应的加载器可以很方便的处理 less 代码。我们首先需要安装 less 的编译器以及 less 的加载器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install less less-loader --save-dev</span><br></pre></td></tr></table></figure><p>然后 <code>rules</code> 规则中添加对 less 文件的处理：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>css 目录中编写 <code>base.less</code> 文件：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@baseColor:</span> blue;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="selector-tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>: <span class="variable">@baseColor</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>然后 <code>main.js</code> 中引入这个文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.css'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.less'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello Vue!&lt;h1&gt;"</span></span><br></pre></td></tr></table></figure></p><p>重启 <code>webpack-dev-server</code>，浏览器查看效果：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545358756477.png" alt="1545358756477"></p><h5 id="webpack-中使用-sass"><a href="#webpack-中使用-sass" class="headerlink" title="webpack 中使用 sass"></a>webpack 中使用 sass</h5><p>webpack 处理 sass 语法编写的文件和 less 原理相同，不过由于 sass 是通过 ruby 写的编译器，通过 npm 安装会非常麻烦，而通过 cnpm 就非常容易了。同样先安装 sass 的编译器和加载器：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install node-sass sass-loader --save-dev</span><br></pre></td></tr></table></figure><p>webpack 配置文件中添加处理 <code>.scss</code> 文件的规则：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>css 目录中编写 <code>base.scss</code> 文件：</p><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$baseColor</span>: pink;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="selector-tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="variable">$baseColor</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>main.js</code> 引入这个文件：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.css'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.less'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.scss'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello Vue!&lt;h1&gt;"</span></span><br></pre></td></tr></table></figure><p>重启 <code>webpack-dev-server</code>，浏览器查看效果：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545359590223.png" alt="1545359590223"></p><h4 id="webpack-处理其他资源"><a href="#webpack-处理其他资源" class="headerlink" title="webpack 处理其他资源"></a>webpack 处理其他资源</h4><p>css 中经常会引入一些背景图片、字体图标等文件，如果 webpack 不对这些文件也进行处理，那网页还是会出问题的。用 webpack 打包小图片和小图标还可以完美的解决客户端和浏览器因为传输小图片造成的 HTTP 资源浪费问题。之前我们解决这种问题通常是采用精灵图的方式。</p><p>处理这些资源我们需要安装 <code>url-loader</code>，它又依赖于 <code>file-loader</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install url-loader file-loader --save-dev</span><br></pre></td></tr></table></figure><h5 id="处理背景图片"><a href="#处理背景图片" class="headerlink" title="处理背景图片"></a>处理背景图片</h5><p>同处理 css 文件的过程，我们也需要在 webpack 配置文件中增加处理图片文件的规则：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.(jpg|png|gif|bmg|jpeg)$/</span>, <span class="attr">use</span>: [<span class="string">'url-loader'</span>]&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 src 目录下创建 <code>images</code> 目录</p><p>现在我们给网页增加一个背景图：<img src="/uploads/2018/从零开始搭建Vue开发环境/bg.png"> </p><p>将背景图保存为 <code>bg.png</code>，并放入 <code>src/images</code> 目录中，然后修改 <code>base.css</code> 中引入这个图片作为背景：</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">html</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">url</span>(../images/bg.png);</span><br><span class="line">    <span class="attribute">background-repeat</span>: repeat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>重启 <code>webpack-dev-server</code> 后，页面背景图被成功加载了。</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545361651804.png" alt="1545361651804"></p><p>这些图片 webpack 是如何处理的呢？我们不妨 F12 开发者模式查看下：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545361745537.png" alt="1545361745537"></p><p>webpack 将图片以 Base64 的编码格式直接写入了 css 样式中，这样浏览器就不需要再次发起一次对图片的 HTTP 请求了。Base64 编码也有个不足的地方是，编码后的文件比源文件要增大三分之一，如果是小文件，Base64 的优势还是非常明显的，但是如果图片尺寸非常大，那带来的额外网络资源消耗就非常不划算了。我们可以通过给 <code>url-loader</code> 插件进行传参，来手动控制将多大尺寸的图片进行 Base64 编码。</p><p>修改 webpack 配置文件，我们用 get 请求传参的方式给 <code>url-loader</code> 传递参数：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.(jpg|png|gif|bmg|jpeg)$/</span>, <span class="attr">use</span>: [<span class="string">'url-loader?limit=8192'</span>]&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这表示只有小于 8192 字节的图片，我们才需要进行 Base64 编码。图片的大小是 13.4K 明显超过了限制。重启 <code>webpack-dev-server</code> 查看效果：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545362554480.png" alt="1545362554480"></p><p>现在文件名是一个32位的哈希值来表示，这样做的好处是可以避免如果项目中有内容完全相同的文件，就不需要处理两次了。当然这个名字的结构我们也是可以自定义的：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;,</span><br><span class="line">        &#123;   <span class="attr">test</span>: <span class="regexp">/\.(jpg|png|gif|bmg|jpeg)$/</span>, </span><br><span class="line">            use: [<span class="string">'url-loader?limit=8192&amp;name=[name]-[hash:8].[ext]'</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>我们将文件的原名称放在第一位，后面紧跟8位的哈希值，后面带上原来的扩展名，修改 webpack 配置文件后并重启 <code>webpack-dev-server</code>：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545362934429.png" alt="1545362934429"></p><h5 id="处理字体图标文件"><a href="#处理字体图标文件" class="headerlink" title="处理字体图标文件"></a>处理字体图标文件</h5><p>一些 css 样式库自带了图标以及字体文件，比如 <code>Bootstrap</code>，如果我们不对这些资源进行处理的话，页面也是无法正常显示的，下面就使用 <code>Bootstrap</code> 试试图标字体该如何处理。</p><p>首先安装 <code>bootstrap</code>：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install bootstrap@3 --save</span><br></pre></td></tr></table></figure><p>由于我们只使用 Bootstrap 提供的样式，所以就不引入 <code>jquery</code> 等依赖了。</p><p>修改 webpack 配置文件，添加处理图标字体的规则：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;,</span><br><span class="line">        &#123;   <span class="attr">test</span>: <span class="regexp">/\.(jpg|png|gif|bmg|jpeg)$/</span>, </span><br><span class="line">            use: [<span class="string">'url-loader?limit=8192&amp;name=[name]-[hash:8].[ext]'</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.(ttf|eot|svg|woff|woff2)$/</span>, <span class="attr">use</span>: <span class="string">'url-loader'</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 <code>main.js</code> 中引入 <code>bootstrap.css</code> 并向 <code>div</code> 元素中追加一个图标：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.css'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.less'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.scss'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../node_modules/bootstrap/dist/css/bootstrap.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello Vue!&lt;h1&gt;"</span></span><br><span class="line"><span class="keyword">let</span> icon = <span class="built_in">document</span>.createElement(<span class="string">'i'</span>)</span><br><span class="line">icon.className = <span class="string">"glyphicon glyphicon-music"</span></span><br><span class="line">app.appendChild(icon)</span><br></pre></td></tr></table></figure></p><p>重启 <code>webpack-dev-server</code>：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545364136761.png" alt="1545364136761"></p><p>小小的图标出现了。</p><h4 id="webpack-中-babel-配置"><a href="#webpack-中-babel-配置" class="headerlink" title="webpack 中 babel 配置"></a>webpack 中 babel 配置</h4><p>webpack 虽然支持一部分 ES6 语法，但是我们还是无法放开了写 ES6 语法的。这时我们就需要一款工具，来自动帮我们把高版本的 JavaScript 语法转变为较低版本的，这样对于 webpack 和浏览器兼容性都比较好，而且我们也可以享受 ES6 甚至更高版本的语法带来的编程体验。这款工具就叫做 <code>Babel</code>。</p><p>安装 <code>Babel</code> 需要两套包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cnpm install babel-core@6 babel-loader@7 babel-plugin-transform-runtime --save-dev</span><br><span class="line">cnpm install babel-preset-env babel-preset-stage-0 --save-dev</span><br></pre></td></tr></table></figure></p><p>接着修改 webpack 配置文件，让 <code>.js</code> 文件先通过 Babel 进行处理：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;,</span><br><span class="line">        &#123;   <span class="attr">test</span>: <span class="regexp">/\.(jpg|png|gif|bmg|jpeg)$/</span>, </span><br><span class="line">            use: [<span class="string">'url-loader?limit=8192&amp;name=[name]-[hash:8].[ext]'</span>]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.(ttf|eot|svg|woff|woff2)$/</span>, <span class="attr">use</span>: <span class="string">'url-loader'</span>&#125;,</span><br><span class="line">        &#123;<span class="attr">test</span>: <span class="regexp">/\.js$/</span>, <span class="attr">use</span>: <span class="string">'babel-loader'</span>, <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>&#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这里通过 <code>babel-loader</code> 对 js 文件进行处理，并排除了 <code>node_modules</code> 中的 js 文件。如果不排除 <code>node_modules</code>，Babel 会将其中的所有 js 文件都打包编译，这样可能照成很多无法预料的结果，这显然不是我们希望的。</p><p>到这一步还没有结束，我们还需要给 Babel 提供一个配置文件，告诉 Babel 编译 js 文件的一些配置。配置文件名称是 <code>.babelrc</code>，文件内容格式是 JSON。</p><p>在项目主目录下创建 <code>.babelrc</code> 文件，并写入如下内容：</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"presets"</span>: [</span><br><span class="line">      <span class="string">"env"</span>,</span><br><span class="line">      <span class="string">"stage-0"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"plugins"</span>: [</span><br><span class="line">      <span class="string">"transform-runtime"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到配置文件的内容和之前安装的几个包是相关的，其中 <code>plugins</code> 里放的就是之前安装的 <code>babel-plugin-transform-runtime</code>。而 <code>presets</code> 里的东西就更厉害了，如果我们要编译不同语法的 js 代码，比如 React 的 jsx 语法，ES6 甚至 ES7/8 的语法，就需要使用 <code>babel-presets-*</code> 相对应的包了。这些包里包含了不同标准代码的转码规则。</p><p>接下来修改 <code>main.js</code> 添加一些 ES6 才支持的语法：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.css'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.less'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.scss'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../node_modules/bootstrap/dist/css/bootstrap.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello Vue!&lt;h1&gt;"</span></span><br><span class="line"><span class="keyword">let</span> icon = <span class="built_in">document</span>.createElement(<span class="string">'i'</span>)</span><br><span class="line">icon.className = <span class="string">"glyphicon glyphicon-music"</span></span><br><span class="line">app.appendChild(icon)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> info = &#123;<span class="attr">name</span>: <span class="string">"xiaoming"</span>, <span class="attr">age</span>: <span class="number">20</span>&#125;</span><br><span class="line">    <span class="keyword">static</span> show()&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Person.info.name, Person.info.age)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Person.show()</span><br></pre></td></tr></table></figure><p>重启 <code>webpack-dev-server</code>，打开浏览器开发者选项，可以看到我们用 <code>class</code> 定义的类，并调用类里静态方法的代码执行成功了。</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545367738483.png" alt="1545367738483"></p><h4 id="文件总结"><a href="#文件总结" class="headerlink" title="文件总结"></a>文件总结</h4><p>现在的目录树是：</p><pre><code>webapp├── dist│   ├── bundle.js│   └── index.html├── node_modules ...├── src│   ├── css│   │   ├── base.css│   │   ├── base.less│   │   └── base.scss│   ├── images│   │   └── bg.png│   ├── index.html│   └── main.js├── .babelrc├── package.json└── webpack.config.js</code></pre><p>文件内容：</p><p><code>base.css</code>:<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">* &#123;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">html</span> &#123;</span><br><span class="line">    <span class="attribute">background</span>: <span class="built_in">url</span>(../images/bg.png);</span><br><span class="line">    <span class="attribute">background-repeat</span>: repeat;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">text-align</span>: center;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>base.less</code>:<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@baseColor:</span> blue;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="selector-tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">color</span>: <span class="variable">@baseColor</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>base.scss</code>:<br><figure class="highlight scss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$baseColor</span>: pink;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="selector-tag">h1</span> &#123;</span><br><span class="line">        <span class="attribute">background-color</span>: <span class="variable">$baseColor</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>index.html</code>:<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Document<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p><code>main.js</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.css'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.less'</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'./css/base.scss'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">'../node_modules/bootstrap/dist/css/bootstrap.css'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> app = <span class="built_in">document</span>.getElementById(<span class="string">"app"</span>)</span><br><span class="line">app.innerHTML = <span class="string">"&lt;h1&gt;Hello Vue!&lt;h1&gt;"</span></span><br><span class="line"><span class="keyword">let</span> icon = <span class="built_in">document</span>.createElement(<span class="string">'i'</span>)</span><br><span class="line">icon.className = <span class="string">"glyphicon glyphicon-music"</span></span><br><span class="line">app.appendChild(icon)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">    <span class="keyword">static</span> info = &#123;<span class="attr">name</span>: <span class="string">"xiaoming"</span>, <span class="attr">age</span>: <span class="number">20</span>&#125;</span><br><span class="line">    <span class="keyword">static</span> show()&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(Person.info.name, Person.info.age)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">Person.show()</span><br></pre></td></tr></table></figure></p><p><code>.babelrc</code>:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"presets"</span>: [</span><br><span class="line">      <span class="string">"env"</span>,</span><br><span class="line">      <span class="string">"stage-0"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">"plugins"</span>: [</span><br><span class="line">      <span class="string">"transform-runtime"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>package.json</code>:<br><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"webapp"</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="attr">"description"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"main"</span>: <span class="string">"index.js"</span>,</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"test"</span>: <span class="string">"echo \"Error: no test specified\" &amp;&amp; exit 1"</span>,</span><br><span class="line">    <span class="attr">"build"</span>: <span class="string">"webpack --mode production"</span>,</span><br><span class="line">    <span class="attr">"dev"</span>: <span class="string">"webpack-dev-server"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"keywords"</span>: [],</span><br><span class="line">  <span class="attr">"author"</span>: <span class="string">""</span>,</span><br><span class="line">  <span class="attr">"license"</span>: <span class="string">"ISC"</span>,</span><br><span class="line">  <span class="attr">"devDependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"babel-core"</span>: <span class="string">"^6.26.3"</span>,</span><br><span class="line">    <span class="attr">"babel-loader"</span>: <span class="string">"^7.1.5"</span>,</span><br><span class="line">    <span class="attr">"babel-plugin-transform-runtime"</span>: <span class="string">"^6.23.0"</span>,</span><br><span class="line">    <span class="attr">"babel-preset-env"</span>: <span class="string">"^1.7.0"</span>,</span><br><span class="line">    <span class="attr">"babel-preset-stage-0"</span>: <span class="string">"^6.24.1"</span>,</span><br><span class="line">    <span class="attr">"css-loader"</span>: <span class="string">"^2.0.1"</span>,</span><br><span class="line">    <span class="attr">"file-loader"</span>: <span class="string">"^3.0.1"</span>,</span><br><span class="line">    <span class="attr">"html-webpack-plugin"</span>: <span class="string">"^3.2.0"</span>,</span><br><span class="line">    <span class="attr">"less"</span>: <span class="string">"^3.9.0"</span>,</span><br><span class="line">    <span class="attr">"less-loader"</span>: <span class="string">"^4.1.0"</span>,</span><br><span class="line">    <span class="attr">"node-sass"</span>: <span class="string">"^4.11.0"</span>,</span><br><span class="line">    <span class="attr">"sass-loader"</span>: <span class="string">"^7.1.0"</span>,</span><br><span class="line">    <span class="attr">"style-loader"</span>: <span class="string">"^0.23.1"</span>,</span><br><span class="line">    <span class="attr">"url-loader"</span>: <span class="string">"^1.1.2"</span>,</span><br><span class="line">    <span class="attr">"webpack"</span>: <span class="string">"^4.28.0"</span>,</span><br><span class="line">    <span class="attr">"webpack-cli"</span>: <span class="string">"^3.1.2"</span>,</span><br><span class="line">    <span class="attr">"webpack-dev-server"</span>: <span class="string">"^3.1.10"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="attr">"bootstrap"</span>: <span class="string">"^3.4.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>webpack.config.js</code>:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>)</span><br><span class="line"><span class="keyword">const</span> htmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">"html-webpack-plugin"</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, <span class="string">'./src/main.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">"development"</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        open: <span class="literal">true</span>,</span><br><span class="line">        port: <span class="number">3000</span>,</span><br><span class="line">        hot: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// contentBase: "src",</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">        <span class="keyword">new</span> htmlWebpackPlugin(&#123;</span><br><span class="line">            template: path.join(__dirname, <span class="string">"./src/index.html"</span>),</span><br><span class="line">            filename: <span class="string">"index.html"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;,</span><br><span class="line">            &#123;   <span class="attr">test</span>: <span class="regexp">/\.(jpg|png|gif|bmg|jpeg)$/</span>, </span><br><span class="line">                use: [<span class="string">'url-loader?limit=8192&amp;name=[name]-[hash:8].[ext]'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.(ttf|eot|svg|woff|woff2)$/</span>, <span class="attr">use</span>: <span class="string">'url-loader'</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.js$/</span>, <span class="attr">use</span>: <span class="string">'babel-loader'</span>, <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="webpack-与-Vue-的结合"><a href="#webpack-与-Vue-的结合" class="headerlink" title="webpack 与 Vue 的结合"></a>webpack 与 Vue 的结合</h3><h4 id="安装-vue"><a href="#安装-vue" class="headerlink" title="安装 vue"></a>安装 vue</h4><p>这一步比较简单，直接用 cnpm 安装即可。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install vue --save</span><br></pre></td></tr></table></figure><h4 id="编写-Vue-代码"><a href="#编写-Vue-代码" class="headerlink" title="编写 Vue 代码"></a>编写 Vue 代码</h4><p>删除 <code>main.js</code> 原来的内容，新的内容如下：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">"#app"</span>,</span><br><span class="line">    data:&#123;</span><br><span class="line">        msg:<span class="string">"Hello Vue"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>并修改 <code>index.html</code>：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span>&#123;&#123;msg&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure><p>启动 <code>webpack-dev-server</code> 后，预料的 <strong>Hello Vue</strong> 并没有出现，打开浏览器控制台，这时出现了一个异常：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545369241673.png" alt="1545369241673"></p><h4 id="Vue-中的一个坑"><a href="#Vue-中的一个坑" class="headerlink" title="Vue 中的一个坑"></a>Vue 中的一个坑</h4><p>为什么和我们直接在页面中通过 <code>script</code> 标签引入 <code>vue.js</code> 的结果不同呢？先来看 Vue 的警告是什么。</p><pre><code>[Vue warn]: You are using the runtime-only build of Vue where the template compiler is not available. Either pre-compile the templates into render functions, or use the compiler-included build.(found in &lt;Root&gt;)</code></pre><p>大致意思说，当前使用的是 <code>Runtime Only</code> 版本的 Vue，其中的模板编译器不可用，所以直接在 <code>index.html</code> 里写的模板字符串就没办法被编译了。解决方案也给了两个，要么预先将模板编译成 <code>render</code> 方法，要么使用包含编译器的 Vue.js 文件。</p><p>这是因为我们通过 <code>import Vue from &quot;vue&quot;</code> 导入的 Vue，是个精简版的 Vue…，把模板编译的功能给阉割了，所以模板字符串就没法被正常的替换了。可以查看 <code>node_modules\vue\package.json</code> 文件中 <code>&quot;main&quot;: &quot;dist/vue.runtime.common.js&quot;</code>，Vue 默认导出的是 <code>dist/vue.runtime.common.js</code> 这个文件。</p><p>我们可以在 <code>main.js</code> 中手动导入完整版的 <code>vue.js</code> 文件试试：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue/dist/vue.js"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">"#app"</span>,</span><br><span class="line">    data:&#123;</span><br><span class="line">        msg:<span class="string">"Hello Vue"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>问题似乎是解决了：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545370099363.png" alt="1545370099363"></p><p>但这并不是官方推荐的做法，否则 vue 的包不会默认导出不带编译器的 <code>Runtime Only</code> 版本了。在 vue 的包目录中，完整版的 <code>vue.js</code> 304K 的大小，而 <code>vue.runtime.common.js</code> 才 210K 大小。</p><p>Vue2 中的 <code>template</code> 模板会先经过模板编译器编译成 <code>render</code> 函数，最终都通过调用 <code>render</code> 函数将页面呈现出来。模板的编译功能可以离线进行，也可以在浏览器上进行。在浏览器上进行编译模板需要消耗更多的内存和CPU资源，所以离线编译模板会让页面的体验更佳。</p><p>如何使用 webpack 离线编译 Vue 模板，之后会讲到，下面先来看看如何使用 <code>render</code> 的方式渲染模板</p><h4 id="使用-render-渲染模板"><a href="#使用-render-渲染模板" class="headerlink" title="使用 render 渲染模板"></a>使用 render 渲染模板</h4><p>修改 <code>main.js</code> 的内容为如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue/dist/vue.js"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> hello = &#123;</span><br><span class="line">    template: <span class="string">"&lt;h1&gt;&#123;&#123;msg&#125;&#125;&lt;/h1&gt;"</span>,</span><br><span class="line">    data()&#123;</span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">            msg:<span class="string">"Hello Render"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">"#app"</span>,</span><br><span class="line">    render: <span class="function"><span class="keyword">function</span>(<span class="params">createElement</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createElement(hello)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>修改 <code>index.html</code> 去掉模板字符串：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>这里我们定义了一个新的 <code>hello</code> 模板，<code>render</code> 函数会接收一个方法，用这个方法可以将指定的模板渲染成 DOM 结构的对象（虚拟DOM），<code>render</code> 需要返回这个对象，然后这个对象被 Patch 到真实的 DOM 中(<code>el: &quot;#app&quot;</code>)。</p><p>查看浏览器，页面被成功的渲染出来了：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545372544693.png" alt="1545372544693"></p><p>但结果似乎有个不太一样的地方，我们用模板字符串或者使用 <code>components</code> 申明的子组件，都包含在 <code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</code> 容器中，而使用 <code>render</code> 渲染的模板，却直接将 <code>&lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</code> 替换了！</p><h4 id="使用-webpack-处理-vue-文件"><a href="#使用-webpack-处理-vue-文件" class="headerlink" title="使用 webpack 处理 vue 文件"></a>使用 webpack 处理 vue 文件</h4><p>官方推荐的做法是将 Vue 的所有模板都定义为组件，单独写入以 <code>.vue</code> 结尾的文件，然后使用 <code>vue-loader</code> 和 <code>vue-template-compiler</code> 将 <code>.vue</code> 模板文件都离线编译处理成 JavaScript 代码。这样自然就不需要使用完整版 Vue 自带的模板编译功能了。</p><p>接下来安装这两个包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install vue-loader vue-template-compiler --save-dev</span><br></pre></td></tr></table></figure></p><p>修改 webpack 配置文件，引入 vue 插件，以及增加对 <code>.vue</code> 文件的处理规则：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>)</span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>)</span><br><span class="line"><span class="keyword">const</span> htmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">"html-webpack-plugin"</span>)</span><br><span class="line"><span class="keyword">const</span> VueLoaderPlugin = <span class="built_in">require</span>(<span class="string">'vue-loader/lib/plugin'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: path.join(__dirname, <span class="string">'./src/main.js'</span>),</span><br><span class="line">    output: &#123;</span><br><span class="line">        path: path.join(__dirname, <span class="string">"./dist"</span>),</span><br><span class="line">        filename: <span class="string">"bundle.js"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    mode: <span class="string">"development"</span>,</span><br><span class="line">    devServer: &#123;</span><br><span class="line">        open: <span class="literal">true</span>,</span><br><span class="line">        port: <span class="number">3000</span>,</span><br><span class="line">        hot: <span class="literal">true</span>,</span><br><span class="line">        <span class="comment">// contentBase: "src",</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> webpack.HotModuleReplacementPlugin(),</span><br><span class="line">        <span class="keyword">new</span> VueLoaderPlugin(),</span><br><span class="line">        <span class="keyword">new</span> htmlWebpackPlugin(&#123;</span><br><span class="line">            template: path.join(__dirname, <span class="string">"./src/index.html"</span>),</span><br><span class="line">            filename: <span class="string">"index.html"</span></span><br><span class="line">        &#125;)</span><br><span class="line">    ],</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.css$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]&#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.less$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'less-loader'</span>]&#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.scss$/</span>, <span class="attr">use</span>: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>,<span class="string">'sass-loader'</span>]&#125;,</span><br><span class="line">            &#123;   <span class="attr">test</span>: <span class="regexp">/\.(jpg|png|gif|bmg|jpeg)$/</span>, </span><br><span class="line">                use: [<span class="string">'url-loader?limit=8192&amp;name=[name]-[hash:8].[ext]'</span>]</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.(ttf|eot|svg|woff|woff2)$/</span>, <span class="attr">use</span>: <span class="string">'url-loader'</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.js$/</span>, <span class="attr">use</span>: <span class="string">'babel-loader'</span>, <span class="attr">exclude</span>: <span class="regexp">/node_modules/</span>&#125;,</span><br><span class="line">            &#123;<span class="attr">test</span>: <span class="regexp">/\.vue$/</span>, <span class="attr">use</span>: <span class="string">'vue-loader'</span>&#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>src 目录下新建 <code>App.vue</code> 文件，然后写入如下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        &#123;&#123;msg&#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    data()&#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">            msg: <span class="string">"Hello App!"</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>main.js</code> 中引入并渲染这个组件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App.vue"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">"#app"</span>,</span><br><span class="line">    render: <span class="function"><span class="keyword">function</span>(<span class="params">createElement</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createElement(App)</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p><p>重启 <code>webpack-dev-server</code>，<strong>Hello App!</strong> 成功的在页面显示了出来。</p><h4 id="子组件使用"><a href="#子组件使用" class="headerlink" title="子组件使用"></a>子组件使用</h4><p>我们接着在 src 目录创建一个 <code>components</code> 目录用来保存子组件。</p><p>在 <code>components</code> 目录中创建 <code>Login.vue</code> 文件，并写入如下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>登陆<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        账号：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在 <code>App.vue</code> 中引入并使用这个组件：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        &#123;&#123;msg&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">login</span>&gt;</span><span class="tag">&lt;/<span class="name">login</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> login <span class="keyword">from</span> <span class="string">'./components/Login.vue'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    data()&#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">            msg: <span class="string">"Hello App!"</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    components:&#123;</span><br><span class="line"><span class="javascript">        <span class="string">'login'</span>: login</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>当前浏览器页面：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545376885738.png" alt="1545376885738"></p><h4 id="路由的使用"><a href="#路由的使用" class="headerlink" title="路由的使用"></a>路由的使用</h4><p>接下来使用路由来导航到其他组件，需要先安装 Vue 的路由模块：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cnpm install vue-router --save</span><br></pre></td></tr></table></figure><p>在 <code>components</code> 目录中创建 <code>Register.vue</code> 文件，并写入如下内容：<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        账号：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        确认密码：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>我们在 <code>App.vue</code> 中通过路由访问这两个组件：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        &#123;&#123;msg&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/login"</span>&gt;</span>登陆<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/register"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> login <span class="keyword">from</span> <span class="string">'./components/Login.vue'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> register <span class="keyword">from</span> <span class="string">'./components/Register.vue'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    data()&#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">            msg: <span class="string">"Hello App!"</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    components:&#123;</span><br><span class="line"><span class="javascript">        <span class="string">'login'</span>: login,</span></span><br><span class="line"><span class="javascript">        <span class="string">'register'</span>: register</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>然后在 src 目录下创建一个单独的 <code>router.js</code> 文件来存放路由配置信息：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> VueRouter <span class="keyword">from</span> <span class="string">'vue-router'</span></span><br><span class="line"></span><br><span class="line">Vue.use(VueRouter)</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> login <span class="keyword">from</span> <span class="string">'./components/Login.vue'</span></span><br><span class="line"><span class="keyword">import</span> register <span class="keyword">from</span> <span class="string">'./components/Register.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="keyword">new</span> VueRouter(&#123;</span><br><span class="line">    routes:[</span><br><span class="line">        &#123;<span class="attr">path</span>:<span class="string">"/login"</span>, <span class="attr">component</span>: login&#125;,</span><br><span class="line">        &#123;<span class="attr">path</span>:<span class="string">"/register"</span>, <span class="attr">component</span>: register&#125;,</span><br><span class="line">    ]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>在 <code>main.js</code> 中应用这个路由：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">"vue"</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">"./App.vue"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> router <span class="keyword">from</span> <span class="string">"./router.js"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> vm = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">"#app"</span>,</span><br><span class="line">    render: <span class="function"><span class="keyword">function</span>(<span class="params">createElement</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createElement(App)</span><br><span class="line">    &#125;,</span><br><span class="line">    router: router</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>浏览器查看效果：<br><img src="/uploads/2018/从零开始搭建Vue开发环境/1545376885740.gif" alt="1545376885740"></p><h4 id="vue-中使用-less"><a href="#vue-中使用-less" class="headerlink" title="vue 中使用 less"></a>vue 中使用 less</h4><p>Vue 的样式写在模板文件的 <code>style</code> 标签中，并且可以给 <code>style</code> 标签使用 <code>lang</code> 属性来表明要使用的 css 语法。给 <code>style</code> 标签添加 <code>scoped</code> 属性可以让样式只对当前组件生效。</p><p>编辑 <code>App.vue</code> 的代码，内容如下：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">        &#123;&#123;msg&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/login"</span>&gt;</span>登陆<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-link</span> <span class="attr">to</span>=<span class="string">"/register"</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">router-link</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">router-view</span>&gt;</span><span class="tag">&lt;/<span class="name">router-view</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> login <span class="keyword">from</span> <span class="string">'./components/Login.vue'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">import</span> register <span class="keyword">from</span> <span class="string">'./components/Register.vue'</span></span></span><br><span class="line"><span class="javascript"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span></span><br><span class="line">    data()&#123;</span><br><span class="line"><span class="javascript">        <span class="keyword">return</span> &#123;</span></span><br><span class="line"><span class="javascript">            msg: <span class="string">"Hello App!"</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    components:&#123;</span><br><span class="line"><span class="javascript">        <span class="string">'login'</span>: login,</span></span><br><span class="line"><span class="javascript">        <span class="string">'register'</span>: register</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">lang</span>=<span class="string">"less"</span> <span class="attr">scoped</span>&gt;</span></span><br><span class="line"><span class="css">    <span class="selector-id">#app</span> &#123;</span></span><br><span class="line">        @line: 30px;</span><br><span class="line">        a &#123;</span><br><span class="line">            display: inline-block;</span><br><span class="line">            width: 80px;</span><br><span class="line"><span class="css">            <span class="selector-tag">height</span>: <span class="keyword">@line</span>;</span></span><br><span class="line">            text-decoration: none;</span><br><span class="line">            border: 1px solid skyblue;</span><br><span class="line">            text-align: center;</span><br><span class="line"><span class="css">            <span class="selector-tag">line-height</span>: <span class="keyword">@line</span>;</span></span><br><span class="line">            border-radius: 5px;</span><br><span class="line"><span class="css">            <span class="selector-tag">color</span>: <span class="selector-id">#666666</span>;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">transition</span>: <span class="selector-tag">all</span> 0<span class="selector-class">.3s</span> <span class="selector-tag">ease</span>;</span></span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-tag">a</span><span class="selector-pseudo">:hover</span> &#123;</span></span><br><span class="line">            background-color: skyblue;</span><br><span class="line">            color: white;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="css">        <span class="selector-tag">a</span><span class="selector-pseudo">:active</span> &#123;</span></span><br><span class="line"><span class="css">            <span class="selector-tag">background-color</span><span class="selector-pseudo">:rgb(0</span>, 255, 157);</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure><p>之前已经配置了 less 加载器，所以可以在页面上直接看到效果了：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/123124124531.gif" alt="123124124531"></p><p>Vue 是如何保证加上 <code>scoped</code> 属性的 <code>style</code> 标签只作用于当前的组件而不会影响其他组件呢？可以看到，Vue 自动给当前组件的所有标签都加上了 <code>data-v-7ba5bd90</code> 这个属性，这个属性就相当于每个组件的唯一标识。只要在样式中选择只给带有这个标识的标签应用样式，这样就做到各组件互不影响了。</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545380420213.png" alt="1545380420213"></p><h4 id="编译打包-Vue-项目"><a href="#编译打包-Vue-项目" class="headerlink" title="编译打包 Vue 项目"></a>编译打包 Vue 项目</h4><p>当项目完成后，就可以将项目编译测试部署了，下面运行 <code>npm run build</code> 将项目打包测试，最终我们生成了一个 111KB 的 <code>bundle.js</code> 文件，浏览器里打开 <code>index.html</code> 也测试无误。</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545380926047.png" alt="1545380926047"></p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545380946230.png" alt="1545380946230"></p><p>到这里 “从零开始搭建Vue开发环境” 就完成了。</p><p>当前项目目录树：</p><pre><code>webapp├── dist│   ├── bundle.js│   └── index.html|── node_modules ...├── src│   ├── App.vue│   ├── components│   │   ├── Login.vue│   │   └── Register.vue│   ├── css│   │   ├── base.css│   │   ├── base.less│   │   └── base.scss│   ├── images│   │   └── bg.png│   ├── index.html│   ├── main.js│   └── router.js├── .babelrc├── package.json└── webpack.config.js</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="Chrome-Vue-拓展"><a href="#Chrome-Vue-拓展" class="headerlink" title="Chrome Vue 拓展"></a>Chrome Vue 拓展</h3><p>使用 Chrome 的 Vue 拓展插件，可以很方便的调试 Vue 项目，安装插件需要访问 Google 商店，安装地址：<a href="https://chrome.google.com/webstore/detail/nhdogjmejiglipccpnnnanhbledajbpd" target="_blank" rel="noopener">点击打开</a></p><p>使用效果：</p><p><img src="/uploads/2018/从零开始搭建Vue开发环境/1545381267338.png" alt="1545381267338"></p><h3 id="项目文件打包下载"><a href="#项目文件打包下载" class="headerlink" title="项目文件打包下载"></a>项目文件打包下载</h3><p><a href="/uploads/2018/从零开始搭建Vue开发环境/webapp-vue2.zip">点击下载</a></p><p>解压后进入 <code>webapp</code> 目录，执行 <code>npm install</code> 或者 <code>cnpm install</code> 安装依赖。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Vue (读音 /vjuː/，类似于 view) 是一套用于构建用户界面的渐进式框架。与其它大型框架不同的是，Vue 被设计为可以自底向上逐层应用。Vue 的核心库只关注视图层，不仅易于上手，还便于与第三方库或既有项目整合。另一方面，当与现代化的工具链以及各种支持类库结合使用时，Vue 也完全能够为复杂的单页应用提供驱动。本篇文章记录不使用 vue-cli 的自动化功能，手动搭建一个 Vue 的开发环境。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Vue" scheme="http://www.yunfwe.cn/categories/Vue/"/>
    
    
      <category term="web" scheme="http://www.yunfwe.cn/tags/web/"/>
    
      <category term="vue" scheme="http://www.yunfwe.cn/tags/vue/"/>
    
      <category term="webpack" scheme="http://www.yunfwe.cn/tags/webpack/"/>
    
  </entry>
  
  <entry>
    <title>Cordova混合开发环境搭建</title>
    <link href="http://www.yunfwe.cn/2018/12/09/2018/Cordova%E6%B7%B7%E5%90%88%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/"/>
    <id>http://www.yunfwe.cn/2018/12/09/2018/Cordova%E6%B7%B7%E5%90%88%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/</id>
    <published>2018-12-09T04:50:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<!-- created: 2018-12-09 12:50:00 --><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Cordova提供了一组设备相关的API，通过这组API，移动应用能够以JavaScript访问原生的设备功能，如摄像头、麦克风等。Cordova还提供了一组统一的JavaScript类库，以及为这些类库所用的设备相关的原生后台代码。Cordova支持如下移动操作系统：iOS, Android,ubuntu phone os, Blackberry, Windows Phone, Palm WebOS, Bada 和 Symbian。<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><blockquote><p>下面是在Windows平台编译安卓apk为例。如果是其他平台，本文档也有一定参考价值</p></blockquote><h3 id="安装应用"><a href="#安装应用" class="headerlink" title="安装应用"></a>安装应用</h3><table><thead><tr><th style="text-align:left">软件</th><th style="text-align:left">版本要求</th><th>下载</th></tr></thead><tbody><tr><td style="text-align:left">Node.js</td><td style="text-align:left">最新LTS版即可</td><td><a href="http://nodejs.cn/download/" target="_blank" rel="noopener">下载地址</a></td></tr><tr><td style="text-align:left">jdk</td><td style="text-align:left">1.8 以上</td><td><a href="https://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">下载地址</a></td></tr><tr><td style="text-align:left">Android SDK</td><td style="text-align:left">最新版即可</td><td><a href="http://tools.android-studio.org/index.php/sdk/" target="_blank" rel="noopener">下载地址</a></td></tr><tr><td style="text-align:left">gradle</td><td style="text-align:left">最新版即可</td><td><a href="https://gradle.org/releases/" target="_blank" rel="noopener">下载地址</a></td></tr><tr><td style="text-align:left">ant</td><td style="text-align:left">最新版即可</td><td><a href="https://ant.apache.org/bindownload.cgi" target="_blank" rel="noopener">下载地址</a></td></tr></tbody></table><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><blockquote><p>根据实际软件的安装目录配置环境变量</p></blockquote><table><thead><tr><th>变量名称</th><th>值</th></tr></thead><tbody><tr><td>JAVA_HOME</td><td>D:\Application\Java\jdk1.8.0_101</td></tr><tr><td>CLASSPATH</td><td>.;%JAVA_HOME%\lib\dt.jar;%JAVA_HOME%\lib\tools.jar;</td></tr><tr><td>ANDROID_HOME</td><td>D:\Application\android\sdk</td></tr></tbody></table><p><strong>Path环境变量中添加如下值</strong></p><p><img src="/uploads/2018/Cordova混合开发环境搭建/1544333928085.png" alt="1544333928085"></p><h3 id="验证环境变量"><a href="#验证环境变量" class="headerlink" title="验证环境变量"></a>验证环境变量</h3><p>java</p><pre><code>&gt; java -versionjava version &quot;1.8.0_101&quot;Java(TM) SE Runtime Environment (build 1.8.0_101-b13)Java HotSpot(TM) 64-Bit Server VM (build 25.101-b13, mixed mode)</code></pre><p>gradle</p><pre><code>&gt; gradle -v------------------------------------------------------------Gradle 5.0------------------------------------------------------------Build time:   2018-11-26 11:48:43 UTCRevision:     7fc6e5abf2fc5fe0824aec8a0f5462664dbcd987Kotlin DSL:   1.0.4Kotlin:       1.3.10Groovy:       2.5.4Ant:          Apache Ant(TM) version 1.9.13 compiled on July 10 2018JVM:          1.8.0_101 (Oracle Corporation 25.101-b13)OS:           Windows 10 10.0 amd64</code></pre><p>ant</p><pre><code>&gt; ant -vApache Ant(TM) version 1.10.5 compiled on July 10 2018Trying the default build file: build.xmlBuildfile: build.xml does not exist!Build failed</code></pre><p>node.js</p><pre><code>&gt; node -vv10.13.0</code></pre><h3 id="安装-Android-SDK"><a href="#安装-Android-SDK" class="headerlink" title="安装 Android SDK"></a>安装 Android SDK</h3><p>进入 Android SDK 的安装目录，执行 <code>SDK Manager.exe</code> ，安装如下模块：</p><p><img src="/uploads/2018/Cordova混合开发环境搭建/1544338294525.png" alt="1544338294525"></p><h3 id="安装-Cordova"><a href="#安装-Cordova" class="headerlink" title="安装 Cordova"></a>安装 Cordova</h3><blockquote><p>node.js 默认会将全局安装的模块还有下载的缓存放在C盘，可以通过更改配置文件来改变安装的位置。</p></blockquote><p>注意：根据 node.js 的实际安装位置或个人喜好酌情修改</p><pre><code>&gt; npm config set prefix &quot;D:\Application\nodejs&quot;&gt; npm config set cache &quot;D:\Application\nodejs\node_cache&quot;</code></pre><p>接下来就可以安装 Cordova 了，使用默认的仓库安装会比较慢，可以考虑使用淘宝的镜像站来安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm config set registry &quot;https://registry.npm.taobao.org&quot;</span><br><span class="line">npm install -g cordova</span><br></pre></td></tr></table></figure><pre><code>&gt; cordova -v8.1.2 (cordova-lib@8.1.1)</code></pre><p>如果没有报错，那么 cordova 就安装完了。</p><h2 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h2><h3 id="创建应用"><a href="#创建应用" class="headerlink" title="创建应用"></a>创建应用</h3><blockquote><p>接下来就用 Cordova 创建第一个应用程序，并打包为 Android APK。</p></blockquote><pre><code>&gt; cordova create myappCreating a new cordova project.</code></pre><p>这样一个初始项目目录就构建完成了，还需要添加相应的目标平台，比如 Android 还是 IOS。</p><pre><code>&gt; cordova platform lsInstalled platforms:Available platforms:  android ~7.1.1  browser ~5.0.1  ios ~4.5.4  osx ~4.0.1  windows ~6.0.0</code></pre><p>添加某个支持的平台使用 <code>cordova platform add</code> 命令，删除某个平台将 <code>add</code> 换成 <code>rm</code> 即可。</p><pre><code>&gt; cordova platform add androidUsing cordova-fetch for cordova-android@~7.1.1Adding android project...Creating Cordova project for the Android platform:        Path: platforms\android        Package: io.cordova.hellocordova        Name: HelloCordova        Activity: MainActivity        Android target: android-27Android project created with cordova-android@7.1.4Android Studio project detectedAndroid Studio project detectedDiscovered plugin &quot;cordova-plugin-whitelist&quot; in config.xml. Adding it to the projectInstalling &quot;cordova-plugin-whitelist&quot; for android               This plugin is only applicable for versions of cordova-android greater than 4.0. If you have a previous platform version, you do *not* need this plugin since the whitelist will be built in.Adding cordova-plugin-whitelist to package.jsonSaved plugin info for &quot;cordova-plugin-whitelist&quot; to config.xml--save flag or autosave detectedSaving android@~7.1.4 into config.xml file ...</code></pre><h3 id="编译项目"><a href="#编译项目" class="headerlink" title="编译项目"></a>编译项目</h3><p>执行：<code>cordova build android</code>，如果编译成功，最后会出现 <code>BUILD SUCCESSFUL</code> 以及 apk 安装包的位置。默认是 DEBUG 模式的编译，如果是发行版可以使用 <code>cordova build android --release</code></p><p><strong>注意</strong>：第一次编译的时候，Gradle 会下载一些依赖，这些依赖会安装在用户家目录下的 <code>.gradle</code> 目录中，这一步我也没有什么好的办法，只能祈祷网络好一点能赶紧下载完。编译后的 apk 都是没有签名的，如果是 <code>release</code> 模式编译的 apk，不签名的话是无法安装的。</p><p>如果通过USB连接了安卓手机，则可以直接使用 <code>cordova run android</code> 命令将 apk 部署到手机上测试，手机需要打开USB调试模式，并允许通过 USB 安装 apk 包。</p><p>打开效果如下：</p><p><img src="/uploads/2018/Cordova混合开发环境搭建/1544338825661.png" width="300"></p><h3 id="调试项目"><a href="#调试项目" class="headerlink" title="调试项目"></a>调试项目</h3><p>可以通过 Chrome 浏览器调试页面，或者直接使用 Chrome 浏览器配合真机调试</p><h4 id="使用浏览器调试"><a href="#使用浏览器调试" class="headerlink" title="使用浏览器调试"></a>使用浏览器调试</h4><p>首先安装浏览器平台的支持，然后使用浏览器调试页面。</p><pre><code>&gt; cordova platform add browserUsing cordova-fetch for cordova-browser@~5.0.1Adding browser project...Creating Cordova project for cordova-browser:        Path: D:\Workspace\myapp\platforms\browser        Name: HelloCordovaInstalling &quot;cordova-plugin-whitelist&quot; for browser--save flag or autosave detectedSaving browser@~5.0.4 into config.xml file ...</code></pre><p>然后执行 <code>cordova run browser</code> 会直接打开浏览器显示页面，这时候可以使用 <code>F12</code> 打开控制台调试了。</p><p><img src="/uploads/2018/Cordova混合开发环境搭建/1544360041683.png" alt="1544360041683"></p><h4 id="使用浏览器调试真机"><a href="#使用浏览器调试真机" class="headerlink" title="使用浏览器调试真机"></a>使用浏览器调试真机</h4><p>将安卓手机通过USB连接电脑，并安装好驱动（Win10貌似自带驱动），然后打开USB调试模式并允许通过USB安装应用程序。<br>执行 <code>cordova run android</code> 命令，这时手机上应该已经自动安装并打开了程序。</p><p>通过 Chrome 浏览器打开页面 <code>chrome://inspect/#devices</code>，Devices 中已经出现了自己的手机机型以及一个 cordova 的 WebView 条目，然后点击 <code>inspect</code>:</p><p><img src="/uploads/2018/Cordova混合开发环境搭建/1544360589393.png" alt="1544360589393"><br><img src="/uploads/2018/Cordova混合开发环境搭建/1544360677819.png" alt="1544360677819"></p><p>可以看到就跟调试普通页面一样，鼠标在不同的标签上划过，手机app上对应的标签也会高亮显示：</p><p><img src="/uploads/2018/Cordova混合开发环境搭建/49A7953522E667BB0ECF3D8C4D6676B7.jpg" width="300"></p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="一个获取设备信息的demo"><a href="#一个获取设备信息的demo" class="headerlink" title="一个获取设备信息的demo"></a>一个获取设备信息的demo</h3><p>首先安装获取设备信息的 cordova 插件</p><pre><code>&gt; cordova plugin add cordova-plugin-deviceInstalling &quot;cordova-plugin-device&quot; for androidAndroid Studio project detectedInstalling &quot;cordova-plugin-device&quot; for browserAdding cordova-plugin-device to package.jsonSaved plugin info for &quot;cordova-plugin-device&quot; to config.xml</code></pre><p><code>cordova plugin add</code> 命令会自动给已安装的所有平台都安装上指定的插件。</p><p>删除项目目录下 www 目录中的所有文件，然后重新创建 <code>index.html</code>，写入以下内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"X-UA-Compatible"</span> <span class="attr">content</span>=<span class="string">"ie=edge"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>设备信息<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line">        * &#123;</span><br><span class="line">            margin: 0;</span><br><span class="line">            padding: 0;</span><br><span class="line">        &#125;</span><br><span class="line">        #content &#123;</span><br><span class="line">            position: fixed;</span><br><span class="line">            height: 90%;</span><br><span class="line">            width: 100%;</span><br><span class="line">            background-color: #c7c7c7;</span><br><span class="line">            text-align: center</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        #btn &#123;</span><br><span class="line">            position: fixed;</span><br><span class="line">            bottom: 0;</span><br><span class="line">            width: 100%;</span><br><span class="line">            height: 10%;</span><br><span class="line">            border: 1px solid skyblue;</span><br><span class="line">            background-color: #fff;</span><br><span class="line">            font-size: 18px;</span><br><span class="line">        &#125;</span><br><span class="line">        #btn:active &#123;</span><br><span class="line">            background-color: skyblue;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">"btn"</span>&gt;</span>获取信息<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"cordova.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">        document.addEventListener("deviceready", onDeviceReady, false);</span><br><span class="line">        function onDeviceReady() &#123;</span><br><span class="line">            var btn = document.getElementById("btn")</span><br><span class="line">            var content = document.getElementById("content")</span><br><span class="line">            btn.onclick = function()&#123;</span><br><span class="line">                content.innerHTML = ""</span><br><span class="line">                for (let i of ['cordova','model','platform','uuid',</span><br><span class="line">                            'version','manufacturer','serial'])&#123;</span><br><span class="line">                    let tmp = document.createElement("p")</span><br><span class="line">                    tmp.innerText = i + ': ' + device[i]</span><br><span class="line">                    content.appendChild(tmp)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>运行：<code>cordova run browser</code> 在浏览器上点击获取信息的按钮，显示如下：</p><p><img src="/uploads/2018/Cordova混合开发环境搭建/1544362788456.png" alt="1544362788456"></p><p>运行：<code>cordova run android</code> 在手机上点击获取信息的按钮，显示如下：</p><p><img src="/uploads/2018/Cordova混合开发环境搭建/1544362880491.png" width="300"></p>]]></content>
    
    <summary type="html">
    
      &lt;!-- created: 2018-12-09 12:50:00 --&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Cordova提供了一组设备相关的API，通过这组API，移动应用能够以JavaScript访问原生的设备功能，如摄像头、麦克风等。Cordova还提供了一组统一的JavaScript类库，以及为这些类库所用的设备相关的原生后台代码。Cordova支持如下移动操作系统：iOS, Android,ubuntu phone os, Blackberry, Windows Phone, Palm WebOS, Bada 和 Symbian。&lt;br&gt;
    
    </summary>
    
    
      <category term="Cordova" scheme="http://www.yunfwe.cn/categories/Cordova/"/>
    
    
      <category term="html5" scheme="http://www.yunfwe.cn/tags/html5/"/>
    
      <category term="cordova" scheme="http://www.yunfwe.cn/tags/cordova/"/>
    
  </entry>
  
  <entry>
    <title>Pyenv Python版本管理器</title>
    <link href="http://www.yunfwe.cn/2018/10/08/2018/Pyenv%20Python%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%99%A8/"/>
    <id>http://www.yunfwe.cn/2018/10/08/2018/Pyenv%20Python%E7%89%88%E6%9C%AC%E7%AE%A1%E7%90%86%E5%99%A8/</id>
    <published>2018-10-08T04:50:00.000Z</published>
    <updated>2025-07-22T07:12:54.870Z</updated>
    
    <content type="html"><![CDATA[<!-- created: 2018-10-20 12:50:00 --><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Node.js 有一个非常好用的版本管理器叫 <code>nvm</code>，可以很方便的安装和管理多种 node.js 的版本，于是开始寻找 Python 是否也存在类似的工具，这样可以方便的切换 Python2 和 Python3 的环境，以及 Python 发布新版本后可以迅速的体验一番，而且还不会对当前系统环境照成影响。所幸 遇到了 pyenv 这个工具。<br>项目主页：<a href="https://github.com/pyenv/pyenv" target="_blank" rel="noopener">https://github.com/pyenv/pyenv</a><br><a id="more"></a></p></blockquote><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>这里在 ubuntu 16.04 上安装 pyenv，其他发行版上安装方法也都大同小异。</p><h3 id="安装-pyenv"><a href="#安装-pyenv" class="headerlink" title="安装 pyenv"></a>安装 pyenv</h3><p>pyenv 默认会安装在 <code>~/.pyenv</code>，可以通过设置环境变量 <code>PYENV_ROOT</code> 来改变这个目录。如果是普通用户，就最好将 pyenv 安装到自己家目录了。</p><p><strong>安装依赖</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install curl git</span><br></pre></td></tr></table></figure></p><p><strong>使用自动化脚本安装pyenv</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PYENV_ROOT=<span class="string">"/usr/local/pyenv"</span></span><br><span class="line">curl -L https://github.com/pyenv/pyenv-installer/raw/master/bin/pyenv-installer | bash</span><br></pre></td></tr></table></figure></p><p><strong>修改 .bashrc 使其自动加载 pyenv</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'export PYENV_ROOT="/usr/local/pyenv"'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'export PATH="/usr/local/pyenv/bin:$PATH"'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'eval "$(pyenv init -)"'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">'eval "$(pyenv virtualenv-init -)"'</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">exec</span> bash</span><br></pre></td></tr></table></figure><p>这时可以检查 <code>pyenv</code> 命令是否可用了。</p><pre><code>root@localhost:~# pyenvpyenv 1.2.7Usage: pyenv &lt;command&gt; [&lt;args&gt;]Some useful pyenv commands are:    commands    List all available pyenv commands    local       Set or show the local application-specific Python version    global      Set or show the global Python version    shell       Set or show the shell-specific Python version    install     Install a Python version using python-build    uninstall   Uninstall a specific Python version    rehash      Rehash pyenv shims (run this after installing executables)    version     Show the current Python version and its origin    versions    List all Python versions available to pyenv    which       Display the full path to an executable    whence      List all Python versions that contain the given executableSee `pyenv help &lt;command&gt;&apos; for information on a specific command.For full documentation, see: https://github.com/pyenv/pyenv#readme</code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="查看可以安装的-Python-环境"><a href="#查看可以安装的-Python-环境" class="headerlink" title="查看可以安装的 Python 环境"></a>查看可以安装的 Python 环境</h3><p><strong>命令：</strong> <code>pyenv install --list</code></p><p>这条命令会列出当前可用的所有Python环境，可以看到可选的环境官方的加上第三方的是非常多的</p><h3 id="安装目标-Python-环境"><a href="#安装目标-Python-环境" class="headerlink" title="安装目标 Python 环境"></a>安装目标 Python 环境</h3><p><strong>命令：</strong> <code>pyenv install ${version}</code></p><p>只需要将 <code>${version}</code> 写成上面列出的所有可选的 Python 环境即可，Python 的源码包会存放到 <code>${PYENV_ROOT}</code> 目录下的 <code>cache</code> 目录下(如果没有需要手动创建)，默认从官方镜像站下载，如果速度比较慢，可以选择手动从国内镜像站下载，手动将源码包放入这个目录，然后再执行安装命令。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先安装编译Python需要的开发包和开发工具</span></span><br><span class="line">apt-get install zlib1g-dev libbz2-dev libssl-dev libncurses5-dev  \</span><br><span class="line">libsqlite3-dev libreadline-dev tk-dev libgdbm-dev libdb-dev \</span><br><span class="line">libpcap-dev xz-utils libexpat-dev gcc make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 手动放置源码包的方式</span></span><br><span class="line"><span class="comment"># mkdir $&#123;PYENV_ROOT&#125;/cache</span></span><br><span class="line"><span class="comment"># cd $&#123;PYENV_ROOT&#125;/cache</span></span><br><span class="line"><span class="comment"># wget https://www.python.org/ftp/python/3.6.6/Python-3.6.6.tar.xz</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行编译安装</span></span><br><span class="line">pyenv install 3.6.6</span><br></pre></td></tr></table></figure><p>如果需要将 Python 编译为动态共享库的方式，则需要将编译参数通过环境变量传给 pyenv</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">env PYTHON_CONFIGURE_OPTS=<span class="string">"--enable-shared"</span> pyenv install 3.6.6</span><br></pre></td></tr></table></figure><p><strong>安装完成</strong></p><pre><code>root@localhost:~# env PYTHON_CONFIGURE_OPTS=&quot;--enable-shared&quot; pyenv install 3.6.6Installing Python-3.6.6...Installed Python-3.6.6 to /usr/local/pyenv/versions/3.6.6</code></pre><h3 id="列出当前版本"><a href="#列出当前版本" class="headerlink" title="列出当前版本"></a>列出当前版本</h3><p><strong>命令：</strong> <code>pyenv version</code> 查看当前版本</p><pre><code>root@localhost:~# pyenv versionsystem (set by /usr/local/pyenv/version)</code></pre><p><strong>命令：</strong> <code>pyenv versions</code> 查看当前可用版本</p><pre><code>root@localhost:~# pyenv versions* system (set by /usr/local/pyenv/version)  3.6.6</code></pre><h3 id="切换当前-shell-会话的-Python-版本"><a href="#切换当前-shell-会话的-Python-版本" class="headerlink" title="切换当前 shell 会话的 Python 版本"></a>切换当前 shell 会话的 Python 版本</h3><p><strong>命令：</strong> <code>pyenv shell 3.6.6</code></p><pre><code>root@localhost:~# python -VPython 2.7.12root@localhost:~# pyenv shell 3.6.6root@localhost:~# python -VPython 3.6.6</code></pre><p>这个命令并不会影响其他会话里的 Python 版本，而且在关闭这个 shell 会话后，设置就消失了，所以只是临时的。</p><h3 id="指定全局的-Python-版本"><a href="#指定全局的-Python-版本" class="headerlink" title="指定全局的 Python 版本"></a>指定全局的 Python 版本</h3><p><strong>命令：</strong> <code>pyenv global 3.6.6</code></p><p>这时全局的 Python 版本都变成了指定的 <code>3.6.6</code>，如果想设置回系统默认的版本可以使用 <code>pyenv global system</code></p><h3 id="设置某个目录使用的-Python-版本"><a href="#设置某个目录使用的-Python-版本" class="headerlink" title="设置某个目录使用的 Python 版本"></a>设置某个目录使用的 Python 版本</h3><p><strong>命令：</strong> <code>pyenv local 3.6.6</code></p><p>这个目录就比较有意思了，当进入某个目录后，然后在这个目录下执行这个命令，那么以后只要切换到这个目录，那么使用的 Python 版本就是指定的这个版本了。</p><p>如果想取消这个设置，可以删除这个目录下的 <code>.python-version</code> 文件</p><h3 id="卸载已安装的-Python-版本"><a href="#卸载已安装的-Python-版本" class="headerlink" title="卸载已安装的 Python 版本"></a>卸载已安装的 Python 版本</h3><p><strong>命令：</strong> <code>pyenv uninstall 3.6.6</code></p><p>辛辛苦苦安装上，我就不测试执行了。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>再配合上 Python 的虚拟环境，简直强无敌啊，更重要的是，非 root 用户也可以随意的安装配置不同的 Python 版本了。</p>]]></content>
    
    <summary type="html">
    
      &lt;!-- created: 2018-10-20 12:50:00 --&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Node.js 有一个非常好用的版本管理器叫 &lt;code&gt;nvm&lt;/code&gt;，可以很方便的安装和管理多种 node.js 的版本，于是开始寻找 Python 是否也存在类似的工具，这样可以方便的切换 Python2 和 Python3 的环境，以及 Python 发布新版本后可以迅速的体验一番，而且还不会对当前系统环境照成影响。所幸 遇到了 pyenv 这个工具。&lt;br&gt;项目主页：&lt;a href=&quot;https://github.com/pyenv/pyenv&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/pyenv/pyenv&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/categories/Python/"/>
    
    
      <category term="python" scheme="http://www.yunfwe.cn/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>Bottle 轻量级Web框架</title>
    <link href="http://www.yunfwe.cn/2018/07/12/2018/Bottle%20%E8%BD%BB%E9%87%8F%E7%BA%A7Web%E6%A1%86%E6%9E%B6/"/>
    <id>http://www.yunfwe.cn/2018/07/12/2018/Bottle%20%E8%BD%BB%E9%87%8F%E7%BA%A7Web%E6%A1%86%E6%9E%B6/</id>
    <published>2018-07-12T04:50:00.000Z</published>
    <updated>2018-07-14T16:00:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Bottle 是一个快速、简单、轻量级的 Python Web 框架，Bottle 作为一个单独的文件模块分发，而且除了标准库没有任何第三方依赖，但是麻雀虽小五脏俱全，所以非常适合第一次接触 Python Web 开发的新手入门学习使用。Bottle 支持URL映射、模板引擎、访问表单、文件上传等功能。内建 HTTP 开发服务器，而且还支持 Paste, Gevent, gunicorn 等高性能 WSGI 服务器。本文通过阅读<a href="http://bottlepy.org/docs/0.12/" target="_blank" rel="noopener">官方文档</a> 并结合自己的实际测试编写而成。<br><a id="more"></a></p></blockquote><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="快速安装体验"><a href="#快速安装体验" class="headerlink" title="快速安装体验"></a>快速安装体验</h3><p>Bottle 的安装非常简单，可以通过 <code>easy_install bottle</code> 或者使用 <code>pip install bottle</code> 来安装，甚至可以直接下载 <a href="https://github.com/defnull/bottle/raw/master/bottle.py" target="_blank" rel="noopener">Bottle.py</a> (最新版，非稳定版) 放到程序目录下来使用。Bottle 可以运行在 <strong>Python2.5+</strong> 和 <strong>Python3.x</strong> 上。</p><p>目前 Bottle 稳定版为 <code>0.12.13</code>，开发版为 <code>0.13-dev</code>。<a href="https://github.com/bottlepy/bottle" target="_blank" rel="noopener">点此打开Github地址</a></p><p><strong>看一个简单的例子：</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hello/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.template(<span class="string">'&lt;b&gt;Hello &#123;&#123;name&#125;&#125;&lt;/b&gt;!'</span>, name=name)</span><br><span class="line"></span><br><span class="line">app.run(host=<span class="string">"localhost"</span>, port=<span class="number">8080</span>)</span><br></pre></td></tr></table></figure></p><p><strong>启动脚本：</strong></p><pre><code>(python3) root@ubuntu:~# python demo.pyBottle v0.12.13 server starting up (using WSGIRefServer())...Listening on http://localhost:8080/Hit Ctrl-C to quit.</code></pre><p><strong>使用浏览器或者 curl 测试：</strong></p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/hello/yunfwe        &lt;b&gt;Hello yunfwe&lt;/b&gt;!</code></pre><p>如果学过 Flask 框架，可以发现它们的语法非常相似。</p><h3 id="教程"><a href="#教程" class="headerlink" title="教程"></a>教程</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><p>Bottle 不依赖任何第三方库，所以可以直接将 <code>bottle.py</code> 下载到项目目录中使用，但这通常下载的是最新开发版。</p><pre><code>$ wget https://github.com/defnull/bottle/raw/master/bottle.py</code></pre><p>如果更喜欢稳定版，可以在 PyPi 上获取，推荐使用 pip 包管理器来安装，或者使用 easy_install 也可以。</p><pre><code>$ sudo pip install bottle$ sudo easy_install bottle</code></pre><p>Bottle 支持 Python2.5 或者更高版本才能正常运行，如果你没有权限在系统范围内安装，可以使用 Python虚拟环境 <code>virtualenv</code>。</p><h4 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a>Hello World</h4><p>安装成功后，从最简单的 “Hello World” 示例开始吧！</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/hello')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'localhost'</span>, port=<span class="number">8080</span>, debug=<span class="literal">True</span>, reloader=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>运行此代码，访问 <code>http://localhost:8080/hello</code>，将在浏览器中看到 “Hello World!”，下面是它的工作原理：</p><p>使用 <code>app.route()</code> 装饰器装饰的函数 <code>hello()</code>，与 <code>app.route()</code> 传入的路径参数 <code>/hello</code> 做绑定，当浏览器请求 URL 时，如果匹配了这个路径，将调用这个路径所绑定的函数，并将函数的返回值发送回浏览器，就是这么简单。路由是这个框架最重要的概念，你可以根据需求定义任何数量的路由。</p><p>最后一行的 <code>app.run()</code> 会启动一个内置的开发服务器，它根据传递的参数在 <code>localhost</code> 上的 <code>8080</code> 端口启动服务，直到你通过 <code>Ctrl-C</code> 停止这个服务。<code>debug=True</code> 会以调试模式启动服务，在开发过程中是非常有用，但是在程序发布后应该是关闭的。<code>reloader=True</code> 也是在开发时非常有用的一个小技巧，Bottle 会自动检测当前脚本是否更新，如果有更新会自动帮你重新运行程序，这样就免去每次改了代码，需要手动停止程序再重新启动程序的过程，这个配置在生产环境也应该是关闭的。</p><h4 id="请求路由"><a href="#请求路由" class="headerlink" title="请求路由"></a>请求路由</h4><p>上一章中，我们只构建了一个只有一条路由，而且非常简单的 Web 应用程序。多个 <code>app.route()</code> 都可以绑定到通一个回调函数上，看下面的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="meta">@app.route('/hello/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">(name=<span class="string">'yunfwe'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.template(<span class="string">'Hello &#123;&#123;name&#125;&#125;!\n'</span>, name=name)</span><br></pre></td></tr></table></figure><p>浏览器访问：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/Hello yunfwe!root@ubuntu:~# curl http://127.0.0.1:8080/hello/bottleHello bottle!</code></pre><p>这个示例告诉我们两件事：可以将多个路由绑定到同一个函数上，并且可以向URL添加通配符，并通过关键字参数访问它们。</p><h5 id="动态路由"><a href="#动态路由" class="headerlink" title="动态路由"></a>动态路由</h5><p>包含通配符的路由称为动态路由，并且可以匹配满足条件的所有URL。简单的通配符由尖括号中的名称组成，例如：<code>&lt;name&gt;</code>。<br>路由 <code>/hello/&lt;name&gt;</code> 会匹配 <code>/hello/alice</code> 以及 <code>/hello/bob</code> 等，如果遇到了下一个斜杆 <code>/</code> 则不会匹配，例如：<code>/hello/mr/smith</code>。</p><p>每个通配符都将匹配到的部分作为关键字参数传递给路由绑定的回调函数，所以回调函数应该提供参数接收它们，否则将会抛出异常。通过动态路由，可以设计出漂亮而且有意义的URL，下面是一些示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/wiki/&lt;pagename&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_wiki_page</span><span class="params">(pagename)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/&lt;action&gt;/&lt;user&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user_api</span><span class="params">(action, user)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h5 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h5><p>还可以使用过滤器来定义更具体的通配符，在将URL匹配到的部分传递给回调函数前通过过滤器来转换它们。</p><p>当前内置的几个过滤器：</p><ul><li><code>:int</code> 仅匹配正整数，并将值转为整数后传递给回调</li><li><code>:float</code> 类似于 <code>:int</code>，将值转为浮点数后传递给回调</li><li><code>:path</code> 以非贪婪的方式匹配包含斜杠字符在内的所有字符，并且可以用于匹配多个路径段</li><li><code>:re[:exp]</code> 允许使用自定义的正则表达式匹配，匹配的值不会被修改或者转换。</li></ul><p><strong>示例：</strong><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/int/&lt;val:int&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_int</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str(val) + <span class="string">'\n'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/float/&lt;val:float&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_float</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str(val) + <span class="string">'\n'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/path/&lt;val:path&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_path</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str(val) + <span class="string">'\n'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/re/&lt;val:re:[a-z]+&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_re</span><span class="params">(val)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str(val) + <span class="string">'\n'</span></span><br></pre></td></tr></table></figure></p><p><strong>结果：</strong></p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/int/123123root@ubuntu:~# curl http://127.0.0.1:8080/float/1.11.1root@ubuntu:~# curl http://127.0.0.1:8080/path/usr/local/usr/local/root@ubuntu:~# curl http://127.0.0.1:8080/re/abcdefabcdef</code></pre><h5 id="HTTP请求方法"><a href="#HTTP请求方法" class="headerlink" title="HTTP请求方法"></a>HTTP请求方法</h5><p>HTTP协议为不同的任务定义了几种请求方法，<code>GET</code> 方法是 Bottle 路由的默认方法，如果需要处理其他方法，比如 <code>POST</code>, <code>PUT</code>, <code>DELETE</code> 等方法，需要添加一个 <code>method</code> 参数到 <code>app.route()</code> 装饰器上，或者使用 <code>app.get()</code>, <code>app.post()</code>, <code>app.put()</code>, <code>app.delete()</code> 这四个备选装饰器。</p><p><code>POST</code> 方法常用于 HTML 表单提交，下面示例演示如何使用 <code>POST</code> 处理登陆表单。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用 @app.route('/login')</span></span><br><span class="line"><span class="meta">@app.get('/login')  </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'''</span></span><br><span class="line"><span class="string">        &lt;form action="/login" method="post"&gt;</span></span><br><span class="line"><span class="string">            Username: &lt;input name="username" type="text" /&gt;</span></span><br><span class="line"><span class="string">            Password: &lt;input name="password" type="password" /&gt;</span></span><br><span class="line"><span class="string">            &lt;input value="Login" type="submit" /&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者使用 @app.route('/login', method='POST')</span></span><br><span class="line"><span class="meta">@app.post('/login') </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_login</span><span class="params">()</span>:</span></span><br><span class="line">    username = bottle.request.forms.get(<span class="string">'username'</span>)</span><br><span class="line">    password = bottle.request.forms.get(<span class="string">'password'</span>)</span><br><span class="line">    <span class="keyword">if</span> username == <span class="string">'root'</span> <span class="keyword">and</span> password == <span class="string">'123456'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;p&gt;Your login information was correct.&lt;/p&gt;\n"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;p&gt;Login failed.&lt;/p&gt;\n"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'localhost'</span>, port=<span class="number">8080</span>, debug=<span class="literal">True</span>, reloader=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><strong>使用浏览器或者 curl 验证结果：</strong></p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/login -X GET        &lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;            Username: &lt;input name=&quot;username&quot; type=&quot;text&quot; /&gt;            Password: &lt;input name=&quot;password&quot; type=&quot;password&quot; /&gt;            &lt;input value=&quot;Login&quot; type=&quot;submit&quot; /&gt;        &lt;/form&gt;root@ubuntu:~# curl http://127.0.0.1:8080/login -X POST --data &apos;username=root&amp;password=654321&apos;&lt;p&gt;Login failed.&lt;/p&gt;root@ubuntu:~# curl http://127.0.0.1:8080/login -X POST --data &apos;username=root&amp;password=123456&apos;&lt;p&gt;Your login information was correct.&lt;/p&gt;</code></pre><p>或者还可以在一个回调函数里同时处理 <code>GET</code> 和 <code>POST</code> 请求，需要传给 <code>method</code> 参数一个列表，将需要的 HTTP 方法加入到列表中 例如：<code>method=[&#39;GET&#39;, &#39;POST&#39;]</code>，然后在回调函数中通过 <code>bottle.request.method</code> 来判断当前请求的方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/login', method=['GET', 'POST'])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> bottle.request.method == <span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'''</span></span><br><span class="line"><span class="string">        &lt;form action="/login" method="post"&gt;</span></span><br><span class="line"><span class="string">            Username: &lt;input name="username" type="text" /&gt;</span></span><br><span class="line"><span class="string">            Password: &lt;input name="password" type="password" /&gt;</span></span><br><span class="line"><span class="string">            &lt;input value="Login" type="submit" /&gt;</span></span><br><span class="line"><span class="string">        &lt;/form&gt;</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line">    <span class="keyword">if</span> bottle.request.method == <span class="string">'POST'</span>:</span><br><span class="line">        username = bottle.request.forms.get(<span class="string">'username'</span>)</span><br><span class="line">        password = bottle.request.forms.get(<span class="string">'password'</span>)</span><br><span class="line">        <span class="keyword">if</span> username == <span class="string">'root'</span> <span class="keyword">and</span> password == <span class="string">'123456'</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Your login information was correct.&lt;/p&gt;\n"</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"&lt;p&gt;Login failed.&lt;/p&gt;\n"</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'localhost'</span>, port=<span class="number">8080</span>, debug=<span class="literal">True</span>, reloader=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><strong>特殊方法：HEAD 和 ANY</strong></p><p><code>HEAD</code> 方法和 <code>GET</code> 方法类似，但是 <code>HEAD</code> 方法并不返回消息体，只返回 HTTP 协议头部信息。<code>HEAD</code> 方法常用来测试链接的有效性。当对 Bottle 的 <code>GET</code> 路由使用 <code>HEAD</code> 方法访问时，Bottle 会正常按照 <code>GET</code> 请求处理，但是并不会返回消息体（回调函数的返回结果）。</p><p><code>ANY</code> 方法会匹配所有请求方法，但也只会在没有定义其他更具体的路由时。这对于将请求重定向到更具体的子应用程序的代理路由很有用。</p><h5 id="显式路由配置"><a href="#显式路由配置" class="headerlink" title="显式路由配置"></a>显式路由配置</h5><p>如果不想使用装饰器的方式来定义路由，可以显式的将某个函数传递给某个路由，下面看一个简单的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line">app.route(<span class="string">'/'</span>, <span class="string">'GET'</span>, hello)</span><br></pre></td></tr></table></figure><p>或者使用一个工厂函数：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setup_routing</span><span class="params">(app, urls)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> u <span class="keyword">in</span> urls:</span><br><span class="line">        app.route(*u)</span><br><span class="line"></span><br><span class="line">urls = [</span><br><span class="line">    (<span class="string">'/'</span>, <span class="string">'GET'</span>, hello),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line">setup_routing(app, urls)</span><br></pre></td></tr></table></figure><h5 id="错误页面"><a href="#错误页面" class="headerlink" title="错误页面"></a>错误页面</h5><p>如果出现任何问题，Bottle 会显示一个包含错误信息但非常简单的错误页面，可以通过 <code>app.error()</code> 装饰器来覆盖特定 HTTP 状态码的默认页面：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.error(404)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error404</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Nothing here, Sorry!\nError Message: %s\n'</span> % str(error)</span><br></pre></td></tr></table></figure><p>当访问一个未定义的页面时：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/abcNothing here, Sorry!Error Message: (404, &quot;Not found: &apos;/abc&apos;&quot;)</code></pre><p>还可以捕捉 <code>abort()</code> 主动抛出的错误：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/abort')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_abort</span><span class="params">()</span>:</span></span><br><span class="line">    bottle.abort(<span class="number">500</span>, <span class="string">' Server error'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.error(500)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">error500</span><span class="params">(error)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Error Message: %s\n'</span> % str(error)</span><br></pre></td></tr></table></figure><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/abortError Message: (500, &apos; Server error&apos;)</code></pre><h4 id="生成响应"><a href="#生成响应" class="headerlink" title="生成响应"></a>生成响应</h4><p>在存 WSGI 中，一个标准的 WSGI 应用必须返回可迭代的字符串。而 Bottle 更灵活，支持多种类型，并且会自动添加一个合适的 <code>Content-Type</code> 头部。下面是路由绑定的回调函数允许返回的类型列表：</p><ul><li><strong>dict</strong>：返回字典类型的数据会自动转换为 JSON 字符串，并设置 <code>Content-Type</code> 类型为 <code>application/json</code>。</li><li><strong>空字符串，False，None或其他非真值</strong>：会产生一个空输出，并将 <code>Content-Length</code> 设置为 0。</li><li><strong>Unicode</strong>：会使用 <code>Content-Type</code> 中指定的编码（默认UTF-8）自动编码，然后将其视为普通字符串。</li><li><strong>Byte</strong>：字节类型，Bottle 将整个字节串作为一个整体返回，并且根据长度设置 <code>Content-Length</code>。</li><li><strong>HTTPError或HTTPResponse</strong>：返回一个 HTTPError 或 HTTPResponse 的实例，如果是 HTTPError，则会运行错误处理程序</li><li><strong>文件对象</strong>：具有 <code>.read()</code> 方法的所有内容都被视为文件对象，并传递给定义在 WSGI 服务框架中的 <code>wsgi.file_wrapper</code> 可调用对象。一些 WSGI 服务器可以利用更优的系统调用(<code>sendfile</code>) 来高效的传输文件。<code>Content-Length</code> 或 <code>Content-Type</code> 都不会自动设置。</li><li><strong>迭代器和生成器</strong>：只要是可以产生或迭代 Unicode, Byte, HTTPError, HTTPResponse 类型，就可以在回调函数中使用。</li></ul><p>下面看一些示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/dict')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_dict</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'msg'</span>:<span class="string">'hello bottle'</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/false')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_false</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/unicode')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_unicode</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">u'喵喵喵'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/byte')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_byte</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b'abcabc'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/response')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_response</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.HTTPResponse(body=<span class="string">'hello bottle'</span>, status=<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/file')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_file</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> open(<span class="string">'/etc/issue'</span>,<span class="string">'rb'</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/generators')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_generators</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">        <span class="keyword">yield</span> str(i)</span><br></pre></td></tr></table></figure><p>结果：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/dict{&quot;msg&quot;: &quot;hello bottle&quot;}root@ubuntu:~# curl http://127.0.0.1:8080/falseroot@ubuntu:~# curl http://127.0.0.1:8080/unicode喵喵喵root@ubuntu:~# curl http://127.0.0.1:8080/byteabcabcabcabcroot@ubuntu:~# curl http://127.0.0.1:8080/responsehello bottleroot@ubuntu:~# curl http://127.0.0.1:8080/fileUbuntu 16.04.5 LTS \n \lroot@ubuntu:~# curl http://127.0.0.1:8080/generators0123456789</code></pre><h5 id="更改默认编码"><a href="#更改默认编码" class="headerlink" title="更改默认编码"></a>更改默认编码</h5><p>Bottle 使用 <code>Content-Type</code> 标头的字符集参数来决定如何对 Unicode 字符串进行编码。此标头默认为 <code>text/html;charset=UTF8</code>，并且可以使用 <code>bottle.response.content_type</code> 来进行修改。<br>例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/gbk')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_latin</span><span class="params">()</span>:</span></span><br><span class="line">    bottle.response.content_type = <span class="string">'text/html; charset=gbk'</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">u'这些文字将使用gbk编码'</span></span><br></pre></td></tr></table></figure><h5 id="处理静态文件"><a href="#处理静态文件" class="headerlink" title="处理静态文件"></a>处理静态文件</h5><p>Bottle 没有像 Flask 一样默认提供了静态文件路由，必须手动添加路由和回调来控制要提供的文件。虽然你可以直接返回一个文件对象，Bottle 提供的 <code>static_file()</code> 以一种安全和方便的方式提供文件访问，默认会自动检测文件拓展类型，并提供合适的 <code>mimetype</code>。浏览器对于文本文件，图像文件等可能会直接浏览而不是下载，这时可以使用 <code>download=True</code> 来使浏览器强制下载文件。如果想指定客户端拿到的文件名，可以使用 <code>download=filename</code>，客户端将自动将文件保存为传给 <code>download</code> 的文件名。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/static/filepath:path')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">server_static</span><span class="params">(filepath)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.static_file(filepath, root=<span class="string">'/your/static/files/path'</span>)</span><br></pre></td></tr></table></figure><p>指定静态文件的根目录时一定要小心，如果使用了相对路径，很有可能并不是你想象得那样。可以试试使用 <code>os.path.dirname(os.path.abspath(__file__))</code> 巧妙的获取脚本所在目录。</p><h5 id="HTTP错误和重定向"><a href="#HTTP错误和重定向" class="headerlink" title="HTTP错误和重定向"></a>HTTP错误和重定向</h5><p>调用 <code>bottle.abort()</code> 函数是生成 HTTP 错误页面的快捷方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/restricted')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restricted</span><span class="params">()</span>:</span></span><br><span class="line">    bottle.abort(<span class="number">401</span>, <span class="string">"Sorry, access denied."</span>)</span><br></pre></td></tr></table></figure><p>如果将客户端重定向到其他URL，可以使用 <code>bottle.redirect()</code>，它会发送 <code>303 See Other</code>，并且添加 <code>Location</code> 头部来告诉客户端新的地址在哪。你还可以提供不同的 HTTP 状态码作为重定向函数的第二个参数。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/old')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">old</span><span class="params">()</span>:</span></span><br><span class="line">    bottle.redirect(<span class="string">"/new"</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/new')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'New page.'</span></span><br></pre></td></tr></table></figure><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/old -LNew page.</code></pre><h5 id="response-对象"><a href="#response-对象" class="headerlink" title="response 对象"></a>response 对象</h5><p>响应的元数据，比如 HTTP 状态码、响应标头 还有 Cookie 存储在 <code>bottle.response</code> 对象中。你可以直接或使用预定义的方法操作这些元数据，直到它们被传输到浏览器。这里介绍最常见的用例和功能。</p><p><strong>状态码</strong><br>HTTP 状态码控制浏览器的行为，默认值为 <code>200 OK</code>。可以通过设置 <code>bottle.response.status</code> 来更改状态吗，在大多数情况下不需要手动设置，但使用 <code>abort()</code> 或者返回 <code>HTTPResponse</code> 实例时需要提供状态码。</p><p><strong>响应头</strong></p><p>修改响应头，比如添加 <code>Cache-Control</code> 或者修改 <code>Content-Type</code> 可以通过 <code>bottle.response.set_header()</code> 和 <code>bottle.response.add_header()</code> 来修改。它们接受两个参数，一个标头名，一个值。这两个方法的区别是，<code>set_header()</code> 会覆盖已有的标头名，而 <code>add_header()</code> 则会继续添加一个即使已存在的标头。</p><h5 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h5><p>Cookie 是一种用户客户端跟踪技术，Bottle 中可以通过 <code>bottle.request.get_cookie()</code> 和 <code>bottle.response.set_cookie()</code> 获取和设置 Cookie。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/cookie')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_cookie</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> bottle.request.get_cookie(<span class="string">"visited"</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Welcome back! Nice to see you again\n"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bottle.response.set_cookie(<span class="string">"visited"</span>, <span class="string">"yes"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello there! Nice to meet you\n"</span></span><br></pre></td></tr></table></figure><p>使用 curl 测试访问，第一次将 Cookie 保存到文件，第二次带上 Cookie 去访问：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/cookie -c cookie.txtHello there! Nice to meet youroot@ubuntu:~# curl http://127.0.0.1:8080/cookie -b cookie.txtWelcome back! Nice to see you again</code></pre><p><code>set_cookie()</code> 方法接受许多其他关键字参数来控制 Cookie 的生存期和行为，这里介绍一些常用的设置：</p><ul><li><strong>max_age</strong>：表示 Cookie 创建后多久过期，单位为秒。如果为 0，表示立即过期，为 -1 表示关闭窗口后 Cookie 就过期。</li><li><strong>expires</strong>：指定一个 Cookie 的过期时间点，值是 UNIX 时间戳，现在已被 max_age 取代。</li><li><strong>domain</strong>：允许读取 Cookie 的域，可以使多个web服务器共享 Cookie。</li><li><strong>path</strong>：指定与 Cookie 关联在一起的网页。默认情况下 Cookie 会与创建它的页面，以及该页面下的子页面关联。</li><li><strong>secure</strong>：限制 Cookie 使用 HTTPS 连接，默认不限制。</li><li><strong>httponly</strong>：限制客户端 JavaScript 读取 Cookie。</li></ul><p>如果没有设置 Cookie 有效期，则默认在页面会话结束后立即过期，在使用 Cookie 时应该考虑下面这些问题：</p><ul><li>在大多数浏览器中，Cookie 的大小限制为 4K 的文本</li><li>有些用户将浏览器设置为不接受 Cookie。</li><li>Cookie 存储在客户端，不以任何方式加密，攻击者可能通过 XSS 漏洞窃取用户的 Cookie。</li><li>Cookie 很容易伪造，不要过于相信 Cookie。</li></ul><p><strong>Cookie 签名</strong></p><p>如上所述，恶意客户很容易伪造 Cookie，Bottle 可以对 Cookie 进行签名加密，以防止这种伪造。你只需在 <code>set_cookie()</code> 和 <code>get_cookie()</code> 时通过 <code>secret</code> 参数提供密钥签名。如果 cookie 未签名，或者签名不匹配，<code>get_cookie()</code> 将返回 <code>None</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/cookie')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_cookie</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">if</span> bottle.request.get_cookie(<span class="string">"visited"</span>, secret=<span class="string">'qweasd'</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Welcome back! Nice to see you again\n"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        bottle.response.set_cookie(<span class="string">"visited"</span>, <span class="string">"yes"</span>, secret=<span class="string">'qweasd'</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"Hello there! Nice to meet you\n"</span></span><br></pre></td></tr></table></figure><p>接下来用 curl 验证结果</p><pre><code>root@ubuntu:~# cat cookie.txt # Netscape HTTP Cookie File# http://curl.haxx.se/docs/http-cookies.html# This file was generated by libcurl! Edit at your own risk.127.0.0.1    FALSE    /    FALSE    0    visited    yesroot@ubuntu:~# curl http://127.0.0.1:8080/cookie -b cookie.txtHello there! Nice to meet youroot@ubuntu:~# curl http://127.0.0.1:8080/cookie -c cookie.txtHello there! Nice to meet youroot@ubuntu:~# curl http://127.0.0.1:8080/cookie -b cookie.txtWelcome back! Nice to see you againroot@ubuntu:~# cat cookie.txt # Netscape HTTP Cookie File# http://curl.haxx.se/docs/http-cookies.html# This file was generated by libcurl! Edit at your own risk.127.0.0.1    FALSE    /    FALSE    0    visited    &quot;!7Bk4nXY6kRKp8QWKVN4ZWQ==?gASVEwAAAAAAAACMB3Zpc2l0ZWSUjAN5ZXOUhpQu&quot;</code></pre><p>可以看到，之前的 <code>cookie.txt</code> 文件里，<code>visited</code> 字段的值是明文的，带着旧的 Cookie 访问服务，服务已经不承认旧的 Cookie 了。之后重新保存新的 Cookie，才可以继续使用。而新的 <code>cookie.txt</code> 文件里，<code>visited</code> 字段的值已经是加密后的。</p><p>Cookie 将所有信息都保存到了客户端，这样是极不安全的，对应的有比较安全的 Session 技术，将用户信息保存在服务端，通过在 Cookie 中保存一个 SessionID，然后使用 SessionID 来获取用户信息。可惜 Bottle 并没有实现 Session，想在 Bottle 中使用 Session 技术，还需要利用第三方实现。</p><h4 id="请求数据"><a href="#请求数据" class="headerlink" title="请求数据"></a>请求数据</h4><p>Cookie, HTTP 标头, HTML <code>&lt;form&gt;</code> 字段和其他请求数据可以通过全局的 <code>request</code> 对象获取。即使在多线程多客户端连接的环境，这个特殊的对象也始终引用当前请求。</p><p>该对象是 <code>BaseRequest</code> 的子类，它有丰富的访问数据的 API，我们这里介绍最常用的。</p><h5 id="FormsDict"><a href="#FormsDict" class="headerlink" title="FormsDict"></a>FormsDict</h5><p>Bottle 使用一种特殊类型的字典来存储表单数据和 Cookie。<code>FormsDict</code> 的行为就像一个普通字典，但是有一些额外的功能，使你使用的更方便。</p><p><strong>属性访问</strong>：字典中的所有值都可以作为属性访问，这些虚拟属性返回 Unicode 字符串，即使该值丢失或者 Unicode 解码失败。这种情况下，字符串为空，但仍存在：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">name = bottle.request.cookies.name</span><br><span class="line">name = bottle.request.cookies.getunicode(<span class="string">'name'</span>) <span class="comment"># encoding='utf-8' (default)</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    name = bottle.request.cookies.get(<span class="string">'name'</span>, <span class="string">''</span>).decode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="keyword">except</span> UnicodeError:</span><br><span class="line">    name = <span class="string">u''</span></span><br></pre></td></tr></table></figure><p><strong>每个键多个值</strong>：<code>FormsDict</code> 是 <code>MultiDict</code> 的子类，可以为每个键存储多个值。标准字典访问方法只能返回单个值，但 <code>getall()</code> 方法返回指定键的所有值的列表。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> choice <span class="keyword">in</span> request.forms.getall(<span class="string">'multiple_choice'</span>):</span><br><span class="line">    do_something(choice)</span><br></pre></td></tr></table></figure><p><strong>WTForms支持</strong>：一些库（例如<code>WTForms</code>）希望将 Unicode 字典作为输入，<code>FormsDict.decode()</code> 会自动解码所有值并返回自身的副本，同时保留每个键的所有值和功能。</p><h5 id="Cookie-1"><a href="#Cookie-1" class="headerlink" title="Cookie"></a>Cookie</h5><p>前面已经讲到使用 <code>set_cookie()</code> 和 <code>get_cookie()</code> 来设置和获取 Cookie，客户端发送的所有 Cookie 还可以通过 <code>FormsDict</code> 获取，下面看一个简单的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/count')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">counter</span><span class="params">()</span>:</span></span><br><span class="line">    count = int(bottle.request.cookies.get(<span class="string">'counter'</span>,<span class="string">'0'</span>))</span><br><span class="line">    count += <span class="number">1</span></span><br><span class="line">    bottle.response.set_cookie(<span class="string">'counter'</span>, str(count))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Count: %d\n'</span> % count</span><br></pre></td></tr></table></figure><p>使用 curl 或者浏览器不停的刷新页面，可以看到计数器一直在增加：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/count -b cookie.txt -c cookie.txtCount: 1root@ubuntu:~# curl http://127.0.0.1:8080/count -b cookie.txt -c cookie.txtCount: 2root@ubuntu:~# curl http://127.0.0.1:8080/count -b cookie.txt -c cookie.txtCount: 3root@ubuntu:~# curl http://127.0.0.1:8080/count -b cookie.txt -c cookie.txtCount: 4root@ubuntu:~# curl http://127.0.0.1:8080/count -b cookie.txt -c cookie.txtCount: 5</code></pre><h5 id="HTTP-标头"><a href="#HTTP-标头" class="headerlink" title="HTTP 标头"></a>HTTP 标头</h5><p>客户端发送的所有 HTTP 标头都存储在 <code>WSGIHeaderDict</code> 中，可以通过 <code>BaseRequest.headers</code> 属性访问。<code>WSGIHeaderDict</code> 的键基本上都是不区分大小写的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/headers')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">headers</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.request.headers.get(<span class="string">'User-Agent'</span>) + <span class="string">'\n'</span></span><br></pre></td></tr></table></figure><p>打印出客户端标识：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/headerscurl/7.47.0</code></pre><h5 id="HTML-表单处理"><a href="#HTML-表单处理" class="headerlink" title="HTML 表单处理"></a>HTML 表单处理</h5><p>在 HTML 中，典型的 <code>&lt;form&gt;</code> 看起来像这样：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/login"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    Username: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">type</span>=<span class="string">"text"</span> /&gt;</span></span><br><span class="line">    Password: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">type</span>=<span class="string">"password"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">value</span>=<span class="string">"Login"</span> <span class="attr">type</span>=<span class="string">"submit"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>action</code> 属性指定将接收表单数据的 URL，<code>method</code> 定义要使用的 HTTP 方法。用 <code>method=&quot;get&quot;</code> 返回的表单，可以使用 <code>BaseRequest.query</code> 来接收，但 GET 请求并不是安全的，所以在返回用户名和密码用 POST 方法。通过 POST 返回的表单存储在 <code>BaseRequest.forms</code>。服务端代码可能如下所示：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.post('/login') </span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_login</span><span class="params">()</span>:</span></span><br><span class="line">    username = bottle.request.forms.get(<span class="string">'username'</span>)</span><br><span class="line">    password = bottle.request.forms.get(<span class="string">'password'</span>)</span><br><span class="line">    <span class="keyword">if</span> username == <span class="string">'root'</span> <span class="keyword">and</span> password == <span class="string">'123456'</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;p&gt;Your login information was correct.&lt;/p&gt;\n"</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&lt;p&gt;Login failed.&lt;/p&gt;\n"</span></span><br></pre></td></tr></table></figure><p>还有其他几个属性可以用于访问表单数据，下面给出一个整体概述：</p><table><thead><tr><th>属性</th><th>GET 表单字段</th><th>POST 表单字段</th><th>文件上传</th></tr></thead><tbody><tr><td>BaseRequest.query</td><td>yes</td><td>no</td><td>no</td></tr><tr><td>BaseRequest.forms</td><td>no</td><td>yes</td><td>no</td></tr><tr><td>BaseRequest.files</td><td>no</td><td>no</td><td>yes</td></tr><tr><td>BaseRequest.params</td><td>yes</td><td>yes</td><td>no</td></tr><tr><td>BaseRequest.GET</td><td>yes</td><td>no</td><td>no</td></tr><tr><td>BaseRequest.POST</td><td>no</td><td>yes</td><td>yes</td></tr></tbody></table><h5 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h5><p>为了支持文件上传，我们需要修改 <code>&lt;form&gt;</code> 标签。首先需要添加标签 <code>enctype=&quot;multipart/form-data&quot;</code> 来告诉浏览器如何编码，然后添加 <code>&lt;input type=&quot;file&quot; /&gt;</code> 来让用户选择文件：</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"/upload"</span> method=<span class="string">"post"</span> enctype=<span class="string">"multipart/form-data"</span>&gt;</span><br><span class="line">  Select a file: &lt;input type=<span class="string">"file"</span> name=<span class="string">"upload"</span> /&gt;</span><br><span class="line">  &lt;input type=<span class="string">"submit"</span> value=<span class="string">"Start upload"</span> /&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p>Bottle 使用 <code>BaseRequest.files</code> 存储上传的文件以及一些有关上传的元数据，它是 <code>FileUpload</code> 的实例。下面是个服务端保存上传的文件的示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/upload', method='POST')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_upload</span><span class="params">()</span>:</span></span><br><span class="line">    upload = bottle.request.files.get(<span class="string">'upload'</span>)</span><br><span class="line">    filename = upload.filename</span><br><span class="line">    upload_root = <span class="string">"/tmp"</span></span><br><span class="line">    upload.save(upload_root)</span><br><span class="line">    <span class="keyword">return</span> filename + <span class="string">'\n'</span></span><br></pre></td></tr></table></figure><p>使用 curl 测试上传文件</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/upload -F &quot;upload=@/etc/issue&quot;issueroot@ubuntu:~# cat /tmp/issue Ubuntu 16.04.5 LTS \n \l</code></pre><p><code>FileUpload.filename</code> 会对文件名清理和规范化，以防止文件名中出现不支持的字符或路径导致错误。如果想访问未经修改的文件名，可以通过访问 <code>FileUpload.raw_filename</code>。</p><p><code>FileUpload.save</code> 将文件安全高效的存储到硬盘，如果想手动操作文件数据流，可以访问 <code>FileUpload.file</code>：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/upload', method='POST')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_upload</span><span class="params">()</span>:</span></span><br><span class="line">    upload = bottle.request.files.get(<span class="string">'upload'</span>)</span><br><span class="line">    <span class="keyword">return</span> upload.file.read()</span><br></pre></td></tr></table></figure><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/upload -F &quot;upload=@/etc/issue&quot;Ubuntu 16.04.5 LTS \n \l</code></pre><p>这里使用了最危险的读取文件的方法，如果文件非常大，可能系统内存会耗尽，所以最好不要这样做。</p><h5 id="JSON-内容"><a href="#JSON-内容" class="headerlink" title="JSON 内容"></a>JSON 内容</h5><p>如果客户端将 <code>Content-Type: application/json</code> 的内容发送到服务器，<code>BaseRequest.json</code> 属性会包含已解析的数据（数据结构正常的情况下）。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/json', method='POST')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_json</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.request.json</span><br></pre></td></tr></table></figure><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/json -X POST -H &apos;content-type: application/json&apos; -d &apos;{&quot;msg&quot;:&quot;hello world&quot;}&apos;{&quot;msg&quot;: &quot;hello world&quot;}</code></pre><h5 id="原始请求体"><a href="#原始请求体" class="headerlink" title="原始请求体"></a>原始请求体</h5><p>你可以通过原始数据作为类文件对象访问 <code>BaseRequest.body</code>。这是 <code>BytesIO</code> 缓冲区或临时文件，具体取决于内容长度和 <code>BaseRequest.MEMFILE_MAX</code> 的设置（默认1M大小）。可以通过 <code>bottle.request[&#39;wsgi.input&#39;]</code> 来访问它。</p><p>上传的内容非常大的情况下（比如上传一个巨大的JSON内容），可以在程序开始提供给 <code>bottle.BaseRequest.MEMFILE_MAX</code> 一个合适的值。否则将抛出 <code>413 Request Entity Too Large</code>。</p><h5 id="WSGI-环境"><a href="#WSGI-环境" class="headerlink" title="WSGI 环境"></a>WSGI 环境</h5><p>每个 <code>BaseRequest</code> 实例都包含一个 WSGI 环境字典，如果想直接访问它，可以通过 <code>BaseRequest.environ</code> 来直接访问：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/getip')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getip</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.request.environ.get(<span class="string">'REMOTE_ADDR'</span>)</span><br></pre></td></tr></table></figure><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/getip127.0.0.1</code></pre><h4 id="模板引擎"><a href="#模板引擎" class="headerlink" title="模板引擎"></a>模板引擎</h4><p>Bottle 附带了一个快速而强大的内置模板引擎，名为 <code>Simple Template Engine</code>，要渲染模板，可以使用 <code>template()</code> 函数或者 <code>view()</code> 装饰器。需要做的就是将模板名称和关键字参数传递给模板：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/hello')</span></span><br><span class="line"><span class="meta">@app.route('/hello/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_template</span><span class="params">(name=<span class="string">'World'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> bottle.template(<span class="string">'hello'</span>, name=name)</span><br></pre></td></tr></table></figure><p>这里传递的模板名为 <code>hello</code>，Bottle 会在脚本所在目录和所在目录中的 <code>views</code> 目录下寻找模板文件，可以通过将路径添加到 <code>bottle.TEMPLATE_PATH</code>列表中来增加 Bottle 的搜索路径。模板文件的拓展名为 <code>tpl</code>，接着在脚本目录下创建 <code>views</code> 目录，然后在这个目录下新建 <code>hello.tpl</code> 文件，写入如下内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%if name == &apos;World&apos;:</span><br><span class="line">    &lt;h1&gt;Hello &#123;&#123;name&#125;&#125;!&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;This is a test.&lt;/p&gt;</span><br><span class="line">%else:</span><br><span class="line">    &lt;h1&gt;Hello &#123;&#123;name.title()&#125;&#125;!&lt;/h1&gt;</span><br><span class="line">    &lt;p&gt;How are you?&lt;/p&gt;</span><br><span class="line">%end</span><br></pre></td></tr></table></figure><p>测试访问，可以看到模板中根据 <code>name</code> 的值进行了逻辑处理</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/hello    &lt;h1&gt;Hello World!&lt;/h1&gt;    &lt;p&gt;This is a test.&lt;/p&gt;root@ubuntu:~# curl http://127.0.0.1:8080/hello/abc    &lt;h1&gt;Hello Abc!&lt;/h1&gt;    &lt;p&gt;How are you?&lt;/p&gt;</code></pre><p>也可以直接将模板字符串传递给 <code>template()</code> 函数，但是并不推荐这样做 例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.route('/hello')</span></span><br><span class="line"><span class="meta">@app.route('/hello/&lt;name&gt;')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test_template</span><span class="params">(name=<span class="string">'World'</span>)</span>:</span></span><br><span class="line">    hello = <span class="string">"""%if name == 'World':</span></span><br><span class="line"><span class="string">    &lt;h1&gt;Hello &#123;&#123;name&#125;&#125;!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;This is a test.&lt;/p&gt;</span></span><br><span class="line"><span class="string">%else:</span></span><br><span class="line"><span class="string">    &lt;h1&gt;Hello &#123;&#123;name.title()&#125;&#125;!&lt;/h1&gt;</span></span><br><span class="line"><span class="string">    &lt;p&gt;How are you?&lt;/p&gt;</span></span><br><span class="line"><span class="string">%end"""</span></span><br><span class="line">    <span class="keyword">return</span> bottle.template(hello, name=name)</span><br></pre></td></tr></table></figure><p>模板使用 <code>%</code> 开始编写 Python 的代码，使用 <code>%end</code> 结束代码块，更详细的语法规则 下面会讲到。<br>模板在编译后，将缓存在内存中，在清楚缓存之前，对模板的任何改动都不会立即生效，可以通过调用 <code>bottle.TEMPLATES.clear()</code> 来清理缓存，如果在调试模式下将禁用缓存。</p><h4 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h4><p>Bottle 的核心功能涵盖了最常见的用例，但作为一个微框架，它有其局限性，插件为框架添加缺少的功能，这就是插件发挥作用的地方。</p><h5 id="体验插件"><a href="#体验插件" class="headerlink" title="体验插件"></a>体验插件</h5><p>这里看看 <code>SQLitePlugin</code> 插件的简单用法，首先通过pip安装这个插件：<code>pip install bottle-sqlite</code>，然后看下面示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"><span class="keyword">from</span> bottle_sqlite <span class="keyword">import</span> SQLitePlugin</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line">sqlite_plugin = SQLitePlugin(dbfile=<span class="string">'/tmp/test.db'</span>)</span><br><span class="line">app.install(sqlite_plugin)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/createdb')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(db)</span>:</span></span><br><span class="line">    db.execute(<span class="string">'create table data (key varchar, value varchar)'</span>)</span><br><span class="line">    db.commit()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'True\n'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/set')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db_set</span><span class="params">(db)</span>:</span></span><br><span class="line">    key = bottle.request.params.get(<span class="string">'k'</span>)</span><br><span class="line">    value = bottle.request.params.get(<span class="string">'v'</span>)</span><br><span class="line">    db.execute(<span class="string">'insert into data values (?,?)'</span>, (key, value))</span><br><span class="line">    db.commit()</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'True\n'</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/get')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">db_get</span><span class="params">(db)</span>:</span></span><br><span class="line">    key = bottle.request.params.get(<span class="string">'k'</span>)</span><br><span class="line">    c = db.execute(<span class="string">'select value from data where key=?'</span>, (key,))</span><br><span class="line">    row = c.fetchone()</span><br><span class="line">    print(row)</span><br><span class="line">    <span class="keyword">return</span> row[<span class="number">0</span>] + <span class="string">'\n'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'localhost'</span>, port=<span class="number">8080</span>, debug=<span class="literal">True</span>, reloader=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>对接口进行测试：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/createdbTrueroot@ubuntu:~# curl &quot;http://127.0.0.1:8080/set?k=a&amp;v=qwe&quot;Trueroot@ubuntu:~# curl &quot;http://127.0.0.1:8080/get?k=a&quot;qwe</code></pre><p>对 <code>app</code> 对象安装 <code>SQLitePlugin</code> 插件，接着在需要使用数据库的地方，给回调函数添加 <code>db</code> 关键字即可，关键字的位置无所谓。插件检测到添加了 <code>db</code> 的关键字后，会将一个打开的 <code>sqlite3.Connection</code> 对象传递给 <code>db</code> 关键字，这样就可以在回掉函数中操作数据库了。</p><h5 id="卸载插件"><a href="#卸载插件" class="headerlink" title="卸载插件"></a>卸载插件</h5><p>卸载插件非常简单，调用 <code>app.uninstall()</code> 函数即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">app.uninstall(sqlite_plugin)    <span class="comment"># 卸载指定的插件</span></span><br><span class="line">app.uninstall(SQLitePlugin)     <span class="comment"># 卸载这个类型的所有插件</span></span><br><span class="line">app.uninstall(<span class="string">'sqlite'</span>)         <span class="comment"># 卸载以这个名称开头的所有插件</span></span><br><span class="line">app.uninstall(<span class="literal">True</span>)             <span class="comment"># 一次性卸载所有插件</span></span><br></pre></td></tr></table></figure><h5 id="将插件安装到指定的路由"><a href="#将插件安装到指定的路由" class="headerlink" title="将插件安装到指定的路由"></a>将插件安装到指定的路由</h5><p>有时候并不想全局安装某个插件，可以单独将这个插件安装到某个路由上：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sqlite_plugin = SQLitePlugin(dbfile=<span class="string">'/tmp/test.db'</span>)</span><br><span class="line"><span class="meta">@app.route('/create', apply=[sqlite_plugin])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(db)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>将需要应用到这个路由的插件添加到 <code>apply</code> 参数的列表中就可以了。</p><h5 id="黑名单插件"><a href="#黑名单插件" class="headerlink" title="黑名单插件"></a>黑名单插件</h5><p>有时候不想让某个函数应用某个插件，可以使用 <code>skip</code> 来跳过这些插件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sqlite_plugin = SQLitePlugin(dbfile=<span class="string">'/tmp/test.db'</span>)</span><br><span class="line">app.install(sqlite_plugin)</span><br><span class="line"><span class="meta">@app.route('/create', skip=[sqlite_plugin])</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>如果设置 <code>skip=True</code> 将跳过所有插件。</p><h5 id="插件与子程序"><a href="#插件与子程序" class="headerlink" title="插件与子程序"></a>插件与子程序</h5><p>将一个 Bottle 程序挂挂载到另一个 Bottle 程序上，相当于在主程序上创建一个代理路由，访问该代理路由的请求都转发到相应的子程序。此类代理路由是禁用插件的，安装在主程序上的插件并不会影响到子程序 例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"><span class="keyword">from</span> bottle_sqlite <span class="keyword">import</span> SQLitePlugin</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line">blog = bottle.Bottle()</span><br><span class="line"></span><br><span class="line">sqlite_plugin = SQLitePlugin(dbfile=<span class="string">'/tmp/test.db'</span>)</span><br><span class="line">app.install(sqlite_plugin)</span><br><span class="line"></span><br><span class="line"><span class="meta">@blog.route('/db')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">blog_db</span><span class="params">(db=<span class="string">'Not sqlite db\n'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str(db)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/db')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">app_db</span><span class="params">(db=<span class="string">'Not sqlite db\n'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> str(db)</span><br><span class="line"></span><br><span class="line">app.mount(<span class="string">'/blog'</span>, blog)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    app.run(host=<span class="string">'localhost'</span>, port=<span class="number">8080</span>, debug=<span class="literal">True</span>, reloader=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>访问这几个路由：</p><pre><code>root@ubuntu:~# curl http://127.0.0.1:8080/db&lt;sqlite3.Connection object at 0x7fad044429d0&gt;root@ubuntu:~# curl http://127.0.0.1:8080/blog/dbNot sqlite db</code></pre><p>使用 <code>app.mount()</code> 函数将 <code>blog</code> 的所有路由挂载到 <code>app</code> 的 <code>/blog</code> 路由下。</p><h4 id="实际开发"><a href="#实际开发" class="headerlink" title="实际开发"></a>实际开发</h4><p>现在已经可以使用Bottle开发简单的应用了，下面这些知识可以帮助你提高工作效率。</p><h5 id="默认应用"><a href="#默认应用" class="headerlink" title="默认应用"></a>默认应用</h5><p>Bottle 维护一个全局堆栈的 Bottle 实例，并使用堆栈顶部作为某些模块级函数和装饰器的默认值，例如 <code>bottle.route()</code> 装饰器，是调用默认应用程序的快捷方式：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route</span><br><span class="line"></span><br><span class="line"><span class="meta">@route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br></pre></td></tr></table></figure><p>对于小型应用程序会非常方便，但是只要导入模块，就会将路由安装到全局应用程序中。为了避免这种导入，Bottle 提供了更明确的方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> Bottle</span><br><span class="line"></span><br><span class="line">app = Bottle()</span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'hello world'</span></span><br></pre></td></tr></table></figure><p>分离应用程序对象可以大大提高可重用性，其他开发人员也可以安全的从你的模块中导入对象并使用 <code>Bottle.mount()</code> 将应用程序合并在一起。另外还可以使用应用程序堆栈来隔离路由：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> route, default_app</span><br><span class="line">default_app.push()</span><br><span class="line"></span><br><span class="line"><span class="meta">@route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World'</span></span><br><span class="line"></span><br><span class="line">app = default_app.pop()</span><br></pre></td></tr></table></figure><h5 id="调试模式"><a href="#调试模式" class="headerlink" title="调试模式"></a>调试模式</h5><p>在开发早期，调试模式非常有用，可以在有错误发生时显示更详细的错误信息，并且模板不会缓存，插件也会立即应用。</p><p>可以通过调用 <code>bottle.debug(True)</code> 或者在 <code>app.run()</code> 中设置 <code>debug</code> 参数为 <code>True</code>。</p><h5 id="自动加载运行"><a href="#自动加载运行" class="headerlink" title="自动加载运行"></a>自动加载运行</h5><p>在开发过程中，修改了代码必须手动重启服务才可以测试更改，自动重新加载器可以帮你完成这些工作：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line">app = bottle.Bottle()</span><br><span class="line">app.run(reloader=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h5 id="命令行界面"><a href="#命令行界面" class="headerlink" title="命令行界面"></a>命令行界面</h5><p>从版本 <code>0.10</code> 开始，就可以使用 Bottle 作为命令行工具：</p><pre><code>root@ubuntu:~# python -m bottleUsage: bottle.py [options] package.module:appOptions:-h, --help            show this help message and exit--version             show version number.-b ADDRESS, --bind=ADDRESS                        bind socket to ADDRESS.-s SERVER, --server=SERVER                        use SERVER as backend.-p PLUGIN, --plugin=PLUGIN                        install additional plugin/s.--debug               start server in debug mode.--reload              auto-reload on file changes.Error: No application specified.</code></pre><p>只用指定应用模块启动即可：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World'</span></span><br></pre></td></tr></table></figure><p>将代码保存为 <code>hello.py</code>，然后通过命令行启动：<code>python -m bottle --debug --reload hello:app</code>，<code>hello</code> 是模块名，<code>app</code> 是应用对象。</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>Bottle 应用程序的配置存储在 <code>Bottle.config</code> 这个类似于字典的对象里，可以用与通过配置告诉插件需要做什么，也可以存储自己的配置。</p><h4 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h4><p><code>Bottle.config</code> 的行为看起来很想普通字典，所有常见的字典方法都能按照预期工作，让我们看看一些例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'autojson'</span>]    = <span class="literal">False</span>      <span class="comment"># 关闭JSON自动转换的特性</span></span><br><span class="line">app.config[<span class="string">'sqlite.db'</span>]   = <span class="string">':memory:'</span> <span class="comment"># 告诉SQLite插件使用哪个数据库</span></span><br><span class="line">app.config[<span class="string">'myapp.param'</span>] = <span class="string">'value'</span>    <span class="comment"># 自定义配置值</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 一次性配置多个值</span></span><br><span class="line">app.config.update(&#123;</span><br><span class="line">    <span class="string">'autojson'</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">'sqlite.db'</span>: <span class="string">':memory:'</span>,</span><br><span class="line">    <span class="string">'myapp.param'</span>: <span class="string">'value'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加默认值</span></span><br><span class="line">app.config.setdefault(<span class="string">'myapp.param2'</span>, <span class="string">'some default'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取值</span></span><br><span class="line">param  = app.config[<span class="string">'myapp.param'</span>]</span><br><span class="line">param2 = app.config.get(<span class="string">'myapp.param2'</span>, <span class="string">'fallback value'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在路由中从配置获取数据的例子</span></span><br><span class="line"><span class="meta">@app.route('/about', view='about.rst')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">about</span><span class="params">()</span>:</span></span><br><span class="line">    email = app.config.get(<span class="string">'my.email'</span>, <span class="string">'nomail@example.com'</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">'email'</span>: email&#125;</span><br></pre></td></tr></table></figure><p><code>app</code> 对象并不是总是可用的，但是你可以在请求上下文中，使用 <code>request</code> 对象获取当前应用程序对象和它的配置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> request</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">is_admin</span><span class="params">(user)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> user == request.app.config[<span class="string">'myapp.admin_user'</span>]</span><br></pre></td></tr></table></figure><h4 id="命名约定"><a href="#命名约定" class="headerlink" title="命名约定"></a>命名约定</h4><p>为了更好的开发，插件和应用程序应遵守一些简单的命名规则：</p><ul><li>所有的键名都应该是小写字符串，不能有特殊字符，但下划线除外。</li><li>命名空间由 “.” 分隔，比如 <code>namespace.field</code>。</li><li>Bottle 使用根命名空间进行自己的配置，插件应将所有变量存储在自己的命名空间中，例如 <code>sqlite.db</code>。</li><li>自定义的配置也应该有单独的命名空间，比如 <code>myapp.*</code></li></ul><h4 id="从文件加载配置"><a href="#从文件加载配置" class="headerlink" title="从文件加载配置"></a>从文件加载配置</h4><p>如果想使非程序员也能够配置程序，或想给程序带来高的可配置性，那么配置文件很有用。这里提供了配置文件的一种非常常见的语法：</p><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[bottle]</span></span><br><span class="line"><span class="attr">debug</span> = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="section">[sqlite]</span></span><br><span class="line"><span class="attr">db</span> = /tmp/test.db</span><br><span class="line"><span class="attr">commit</span> = auto</span><br><span class="line"></span><br><span class="line"><span class="section">[myapp]</span></span><br><span class="line"><span class="attr">admin_user</span> = defnull</span><br></pre></td></tr></table></figure><p>现在可以通过 <code>load_config()</code> 方法加载这些配置文件：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.config.load_config(<span class="string">'/etc/myapp.conf'</span>)</span><br></pre></td></tr></table></figure><h4 id="从嵌套的字典加载配置"><a href="#从嵌套的字典加载配置" class="headerlink" title="从嵌套的字典加载配置"></a>从嵌套的字典加载配置</h4><p>另一个常用的方法使 <code>load_dict()</code>。这个方法将嵌套的字典转换为具有命名空间键和值的平面字典。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 从字典中加载配置</span></span><br><span class="line">app.config.load_dict(&#123;</span><br><span class="line">    <span class="string">'autojson'</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">'sqlite'</span>: &#123; <span class="string">'db'</span>: <span class="string">':memory:'</span> &#125;,</span><br><span class="line">    <span class="string">'myapp'</span>: &#123;</span><br><span class="line">        <span class="string">'param'</span>: <span class="string">'value'</span>,</span><br><span class="line">        <span class="string">'param2'</span>: <span class="string">'value2'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">assert</span> app.config[<span class="string">'myapp.param'</span>] == <span class="string">'value'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从json文件中加载配置</span></span><br><span class="line"><span class="keyword">with</span> open(<span class="string">'/etc/myapp.json'</span>) <span class="keyword">as</span> fp:</span><br><span class="line">    app.config.load_dict(json.load(fp))</span><br></pre></td></tr></table></figure><h4 id="监听配置更改"><a href="#监听配置更改" class="headerlink" title="监听配置更改"></a>监听配置更改</h4><p>每次更改 Bottle 中的值时，都将触发应用程序对象上的 <code>config</code> 钩子。此钩子可用于在运行时对配置更改做出反应，例如重新连接到新数据库、更改后端服务上的调试设置 或者调整工作线程池的大小。钩子的回调函数接收两个参数(键, 新值)，并在字典中实际值更改之前调用，如果回调函数引发异常将取消更改，并保留原值。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@app.hook('config')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">on_config_change</span><span class="params">(key, value)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> key == <span class="string">'debug'</span>:</span><br><span class="line">        switch_own_debug_mode_to(value)</span><br></pre></td></tr></table></figure><p>钩子的回调函数不能改变要存储到字典中的值，只能有过滤器的用处。</p><h4 id="过滤器和其他元数据"><a href="#过滤器和其他元数据" class="headerlink" title="过滤器和其他元数据"></a>过滤器和其他元数据</h4><p><code>ConfigDict</code> 允许你存储元数据和配置键，目前定义了两个源字段：</p><ul><li><strong>help</strong>: 帮助或说明字符串，可由调试、内省或管理工具去帮助站点管理员配置应用程序。</li><li><strong>filter</strong>: 接收和返回单个值的可调用对象，如果你为键定义了过滤器，那么存储到该键的所有值都先通过过滤器。过滤器可以对值进行检查和修改，或者抛出异常。下面看个例子：</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomePlugin</span><span class="params">(object)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">setup</span><span class="params">(app)</span>:</span></span><br><span class="line">        app.config.meta_set(<span class="string">'some.int'</span>, <span class="string">'filter'</span>, int)</span><br><span class="line">        app.config.meta_set(<span class="string">'some.list'</span>, <span class="string">'filter'</span>,</span><br><span class="line">            <span class="keyword">lambda</span> val: str(val).split(<span class="string">';'</span>))</span><br><span class="line">        app.config.meta_set(<span class="string">'some.list'</span>, <span class="string">'help'</span>,</span><br><span class="line">            <span class="string">'A semicolon separated list.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">apply</span><span class="params">(self, callback, route)</span>:</span></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line">app = bottle.default_app()</span><br><span class="line">app.install(SomePlugin())</span><br><span class="line"></span><br><span class="line">app.config[<span class="string">'some.list'</span>] = <span class="string">'a;b;c'</span>     <span class="comment"># 自动转为列表</span></span><br><span class="line">app.config[<span class="string">'some.int'</span>] = <span class="string">'not an int'</span> <span class="comment"># 抛出异常</span></span><br></pre></td></tr></table></figure><h3 id="简单模板引擎"><a href="#简单模板引擎" class="headerlink" title="简单模板引擎"></a>简单模板引擎</h3><p>Bottle 附带一个快速、功能强大且易学的内置模板引擎，简称 <code>SimpleTemplate</code>。 <code>view()</code> 和 <code>template()</code> 函数帮助用户使用这个引擎。这里解释模板语法，并提供几个常用的示例。</p><p><strong>基本 API 使用</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> SimpleTemplate</span><br><span class="line">tpl = SimpleTemplate(<span class="string">'Hello &#123;&#123;name&#125;&#125;!'</span>)</span><br><span class="line">tpl.render(name=<span class="string">'World'</span>)</span><br><span class="line"><span class="comment"># 结果：u'Hello World!'</span></span><br></pre></td></tr></table></figure><p>使用 <code>template()</code> 函数可以简化这个过程</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> bottle <span class="keyword">import</span> template</span><br><span class="line">template(<span class="string">'Hello &#123;&#123;name&#125;&#125;!'</span>, name=<span class="string">'World'</span>)</span><br></pre></td></tr></table></figure><h4 id="SimpleTemplate-语法"><a href="#SimpleTemplate-语法" class="headerlink" title="SimpleTemplate 语法"></a>SimpleTemplate 语法</h4><p>Python 是一种非常强大的语言，但它严格的缩进使它很难用于模板语言。<code>SimpleTemplate</code> 取消了这些限制，允许你编写干净，可读和可维护的模板，同时保留 Python 语言的功能。</p><h5 id="内联表达式"><a href="#内联表达式" class="headerlink" title="内联表达式"></a>内联表达式</h5><p>上面已经学习了两个大括号这样的语法，实际上可以在大括号中使用任何 Python 表达式：</p><pre><code>&gt;&gt;&gt; template(&apos;Hello {{name}}!&apos;, name=&apos;World&apos;)&apos;Hello World!&apos;&gt;&gt;&gt; template(&apos;Hello {{name.title() if name else "stranger"}}!&apos;, name=None)&apos;Hello stranger!&apos;&gt;&gt;&gt; template(&apos;Hello {{name.title() if name else "stranger"}}!&apos;, name=&apos;mArC&apos;)&apos;Hello Marc!&apos;</code></pre><p>如果传入的字符串包含 HTML 字符，则会自动转义来防止 XSS 攻击，但是你可以使用 <code>!</code> 来表示禁止转义：</p><pre><code>&gt;&gt;&gt; template(&apos;Hello {{name}}&apos;, name=&apos;&lt;b&gt;World&lt;/b&gt;&apos;)&apos;Hello &amp;lt;b&amp;gt;World&amp;lt;/b&amp;gt;&apos;&gt;&gt;&gt; template(&apos;Hello {{!name}}&apos;, name=&apos;&lt;b&gt;World&lt;/b&gt;&apos;)&apos;Hello &lt;b&gt;World&lt;/b&gt;&apos;</code></pre><h5 id="嵌入-Python-代码"><a href="#嵌入-Python-代码" class="headerlink" title="嵌入 Python 代码"></a>嵌入 Python 代码</h5><p>模板引擎允许你在模板中嵌入 Python 代码行或块。代码行以 <code>%</code> 开头，代码快由 <code>&lt;%</code> 和 <code>%&gt;</code> 包围：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">% name = "Bob"  # 行级别的 Python 代码</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Some plain text in between<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">%</span></span></span><br><span class="line"><span class="tag">  # 块级别的 <span class="attr">Python</span> 代码</span></span><br><span class="line"><span class="tag">  <span class="attr">name</span> = <span class="string">name.title().strip()</span></span></span><br><span class="line"><span class="tag">%&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>More plain text<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>嵌入的 Python 代码遵循常规 Python 语法，但有两个额外的语法规则：</p><ul><li>缩进被忽略，你可以根据需要在语句前尽可能多的放置空格，这样可以与周围的代码对其，提高可读性。</li><li>缩进的块现在必须用 <code>%end</code> 显式关闭，比如：</li></ul><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  % for item in basket:</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  % end</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure><h5 id="空白符控制"><a href="#空白符控制" class="headerlink" title="空白符控制"></a>空白符控制</h5><p>代码块和代码行在模板中总是跨行的，在模板被渲染后，代码段会被删除，但是模板中并不会出现悬空的空白行，例如：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line"> % if True:</span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>content<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"> % end</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>被渲染后成为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">span</span>&gt;</span>content<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>如果想跳过代码段前面的换行符，可以使用双反斜杠结束文本：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>\\</span><br><span class="line"> %if True:</span><br><span class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>content<span class="tag">&lt;/<span class="name">span</span>&gt;</span>\\</span><br><span class="line"> %end</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>渲染后的效果是：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>content<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="模板功能"><a href="#模板功能" class="headerlink" title="模板功能"></a>模板功能</h4><p>每个模板都预置了一些函数，可以帮助处理一些常见的功能。这些函数直接可用，无需安装或导入。</p><p>注意：在 0.12 版本之前，<code>include()</code> 和 <code>rebase()</code> 是语法关键字，而不是函数。</p><h5 id="include"><a href="#include" class="headerlink" title="include"></a>include</h5><p><strong>include(sub_template, </strong>variables)**</p><p>使用指定的变量渲染子模版，并将生成的文本插入到当前模板。该函数返回包含在子模板中传递或定义的局部变量的字典:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">% include('header.tpl', title='Page Title')</span><br><span class="line">Page Content</span><br><span class="line">% include('footer.tpl')</span><br></pre></td></tr></table></figure><h5 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h5><p><strong>rebase(name, </strong>variables)**</p><p>将当前模板标记为稍后包含在不同的模板中，呈现当前模板后，其将生成的文本存储在一个名为 <code>base</code> 的变量中，并传递给基本模板，然后呈现该模板：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">% rebase('base.tpl', title='Page Title')</span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Page Content ...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><p>以下是 <code>base.tpl</code> 的内容：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;title or 'No title'&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  &#123;&#123;!base&#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>渲染的最终结果：</p><pre><code>&gt;&gt;&gt; from bottle import template&gt;&gt;&gt; t = &apos;&apos;&apos;% rebase(&apos;base.tpl&apos;, title=&apos;Page Title&apos;)... &lt;p&gt;Page Content ...&lt;/p&gt;&apos;&apos;&apos;&gt;&gt;&gt; print(template(t))&lt;html&gt;&lt;head&gt;&lt;title&gt;Page Title&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;p&gt;Page Content ...&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</code></pre><h5 id="defined"><a href="#defined" class="headerlink" title="defined"></a>defined</h5><p><strong>defined(name)</strong></p><p>测试一个变量名是否定义：</p><pre><code>&gt;&gt;&gt; t = &apos;&apos;&apos;% if defined(&quot;title&quot;):... &lt;p&gt;defined title&lt;/&gt;... % else:... &lt;p&gt;not defined title&lt;/p&gt;... % end&apos;&apos;&apos;&gt;&gt;&gt; template(t)&apos;&lt;p&gt;not defined title&lt;/p&gt;\n&apos;&gt;&gt;&gt; template(t, title=&apos;test&apos;)&apos;&lt;p&gt;defined title&lt;/&gt;\n&apos;</code></pre><h5 id="get"><a href="#get" class="headerlink" title="get"></a>get</h5><p><strong>get(name, default=None)</strong></p><p>和字典的 <code>get</code> 方法相似：</p><pre><code>&gt;&gt;&gt; t = &apos;&apos;&apos;% print(get(&apos;title&apos;))&apos;&apos;&apos;&gt;&gt;&gt; template(t)None&apos;&apos;&gt;&gt;&gt; template(t, title=&apos;abc&apos;)abc&apos;&apos;</code></pre><h5 id="setdefault"><a href="#setdefault" class="headerlink" title="setdefault"></a>setdefault</h5><p><strong>setdefault(name, default)</strong></p><p>如果变量没有定义，创建它并提供一个默认值，否则返回它的值：</p><pre><code>&gt;&gt;&gt; t = &apos;&apos;&apos;% setdefault(&quot;title&quot;, &quot;abc&quot;)... {{title}}&apos;&apos;&apos;&gt;&gt;&gt; template(t)&apos;abc&apos;&gt;&gt;&gt; template(t, title=&apos;title&apos;)&apos;title&apos;</code></pre><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>目前我最喜欢的部署方式是使用 <code>gunicorn</code>，如果想通过协程的方式提高程序的并发，还会搭配 <code>gevent</code>。它们都可以很方便的通过 <code>pip</code> 安装</p><h3 id="gunicorn"><a href="#gunicorn" class="headerlink" title="gunicorn"></a>gunicorn</h3><h4 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h4><p><code>pip install gunicorn</code></p><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>gunicorn 最好通过配置文件的方式启动，配置文件可以是普通的键值对的文本，也可以是一个可执行的 Python 文件，采用 Python 文件的方式更灵活，所以我更喜欢这个。下面看一个配置文件的例子：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line">DEBUG = os.environ.get(<span class="string">'DEBUG'</span>,<span class="string">'FALSE'</span>).upper() <span class="keyword">in</span> [<span class="string">'TRUE'</span>,<span class="string">'1'</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># gunicorn config</span></span><br><span class="line">path_of_current_file = os.path.abspath(__file__)</span><br><span class="line">path_of_current_dir = os.path.dirname(path_of_current_file)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, path_of_current_dir)</span><br><span class="line">worker_class = <span class="string">'gevent'</span></span><br><span class="line">workers = multiprocessing.cpu_count()</span><br><span class="line">chdir = path_of_current_dir</span><br><span class="line">worker_connections = <span class="number">1000</span></span><br><span class="line">timeout = <span class="number">30</span></span><br><span class="line">max_requests = <span class="number">2000</span></span><br><span class="line">loglevel = <span class="string">'info'</span></span><br><span class="line">bind = <span class="string">"0.0.0.0:8000"</span></span><br><span class="line">pidfile = <span class="string">'%s/run/gunicorn.pid'</span> % path_of_current_dir</span><br><span class="line"><span class="keyword">if</span> DEBUG:</span><br><span class="line">    reload = <span class="literal">True</span></span><br><span class="line">    debug = <span class="literal">True</span></span><br><span class="line">    errorlog = <span class="string">"-"</span></span><br><span class="line">    accesslog = <span class="string">"-"</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    reload = <span class="literal">False</span></span><br><span class="line">    debug = <span class="literal">False</span></span><br><span class="line">    errorlog = <span class="string">'%s/logs/error.log'</span> % path_of_current_dir</span><br><span class="line">    accesslog = <span class="string">'%s/logs/access.log'</span> % path_of_current_dir</span><br></pre></td></tr></table></figure><p>配置文件的代码很简单，会自动根据当前系统CPU核数来配置生成多少个工作进程，还可以采用多进程配合多线程的方式，但这里选择了使用协程用以更好的支持并发。</p><p>并且配置文件编写了通过环境变量获取是否进入DEBUG模式的代码，让程序的配置更灵活。更多 <code>gunicron</code> 的配置说明可以查看官方文档：<a href="https://docs.gunicorn.org/en/stable/" target="_blank" rel="noopener">点此打开</a></p><h4 id="配合Gevent"><a href="#配合Gevent" class="headerlink" title="配合Gevent"></a>配合Gevent</h4><p>使用 Gevent 可以在几乎不修改任何代码的情况下让 Web 性能获取飙升，安装也非常简单 <code>pip install gevent</code>。在上面的配置文件中，<code>worker_class</code> 已经指定了要使用 <code>gevent</code></p><h4 id="启动程序"><a href="#启动程序" class="headerlink" title="启动程序"></a>启动程序</h4><p><code>gunicorn</code> 的启动方式也非常简单，直接使用命令行将应用程序对象和配置文件传递给 <code>gunicorn</code>:</p><p><strong>hello.py</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bottle</span><br><span class="line"></span><br><span class="line">app = bottle.Bottle()</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Hello World'</span></span><br></pre></td></tr></table></figure><p><strong>启动</strong>:</p><pre><code>root@ubuntu: # gunicorn hello:app -c config.py [2018-10-16 11:42:45 +0000] [46823] [INFO] Starting gunicorn 19.6.0[2018-10-16 11:42:45 +0000] [46823] [INFO] Listening at: http://0.0.0.0:8000 (46823)[2018-10-16 11:42:45 +0000] [46823] [INFO] Using worker: gevent[2018-10-16 11:42:45 +0000] [46827] [INFO] Booting worker with pid: 46827[2018-10-16 11:42:45 +0000] [46828] [INFO] Booting worker with pid: 46828[2018-10-16 11:42:45 +0000] [46829] [INFO] Booting worker with pid: 46829[2018-10-16 11:42:45 +0000] [46830] [INFO] Booting worker with pid: 46830</code></pre><p>但是默认是前台启动的，如果想启动后就放入后台执行，可以将 <code>daemon=True</code> 写入配置文件，或者直接在命令行添加 <code>-D</code> 参数。</p><h4 id="使用-Nginx-做静态资源服务器"><a href="#使用-Nginx-做静态资源服务器" class="headerlink" title="使用 Nginx 做静态资源服务器"></a>使用 Nginx 做静态资源服务器</h4><p>gunicorn 是 WSGI 服务器，并不擅长处理静态资源，可以将静态文件交给 Nginx 处理。使用 Nginx 配置动静分离，将动态的请求转发到 gunicorn ，将静态资源直接返回给客户端，这样又可以提升不少的性能。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="可用插件列表"><a href="#可用插件列表" class="headerlink" title="可用插件列表"></a>可用插件列表</h3><p>官网列出的 Bottle 现在可用的插件：<a href="http://bottlepy.org/docs/0.12/plugins/index.html" target="_blank" rel="noopener">点击打开</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Bottle 是一个快速、简单、轻量级的 Python Web 框架，Bottle 作为一个单独的文件模块分发，而且除了标准库没有任何第三方依赖，但是麻雀虽小五脏俱全，所以非常适合第一次接触 Python Web 开发的新手入门学习使用。Bottle 支持URL映射、模板引擎、访问表单、文件上传等功能。内建 HTTP 开发服务器，而且还支持 Paste, Gevent, gunicorn 等高性能 WSGI 服务器。本文通过阅读&lt;a href=&quot;http://bottlepy.org/docs/0.12/&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;官方文档&lt;/a&gt; 并结合自己的实际测试编写而成。&lt;br&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/categories/Python/"/>
    
    
      <category term="bottle" scheme="http://www.yunfwe.cn/tags/bottle/"/>
    
      <category term="python" scheme="http://www.yunfwe.cn/tags/python/"/>
    
  </entry>
  
  <entry>
    <title>WebSocket 协议分析</title>
    <link href="http://www.yunfwe.cn/2018/06/22/2018/WebSocket%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/"/>
    <id>http://www.yunfwe.cn/2018/06/22/2018/WebSocket%E5%8D%8F%E8%AE%AE%E5%88%86%E6%9E%90/</id>
    <published>2018-06-22T12:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.870Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>WebSocket协议是基于TCP的一种新的网络协议。它实现了浏览器与服务器全双工(full-duplex)通信——允许服务器主动发送信息给客户端。它弥补了 HTTP 协议只能只能由客户端，而无法实现服务器主动推送消息。在此之前，浏览器想了解服务端有没有更新数据只能每隔一段时间就发送一个HTTP请求去询问，这样的效率是非常低下的。而通过 WebSocket，服务器和客户端可以建立一条稳定的连接，并且可以双向通信。</p></blockquote><a id="more"></a><h2 id="协议分析"><a href="#协议分析" class="headerlink" title="协议分析"></a>协议分析</h2><p>WebSocket 协议的规范可以翻阅 <a href="https://tools.ietf.org/html/rfc6455" target="_blank" rel="noopener">RFC 6455</a></p><p>WebSocket协议有两部分：握手和数据传输。由客户端主动发送连接请求，握手信息是标准的HTTP协议，并通过 <code>Upgrade</code> 字段来表示升级为 <code>WebSocket</code> 协议，因此 WebSocket 的请求也很容易的可以穿过HTTP代理等服务。</p><h3 id="握手阶段"><a href="#握手阶段" class="headerlink" title="握手阶段"></a>握手阶段</h3><p>客户端发起的握手请求：</p><pre><code>GET /chat HTTP/1.1Host: server.example.comUpgrade: WebSocketConnection: UpgradeSec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==Origin: http://example.comSec-WebSocket-Protocol: chat, superchatSec-WebSocket-Version: 13</code></pre><p>来自服务端的响应：</p><pre><code>HTTP/1.1 101 Switching ProtocolsUpgrade: WebSocketConnection: UpgradeSec-WebSocket-Accept:s3pPLMBiTxaQ9kYGzzhZRbK+xOo=Sec-WebSocket-Protocol: chat</code></pre><p>接下来看各字段具体作用</p><ul><li><code>Upgrade: WebSocket</code>：这是一个特殊的HTTP请求，目的是将客户端和服务端的通信协议从HTTP协议升级到 WebSocket 协议。</li><li><code>Sec-WebSocket-Key</code>：这是一段Base64加密的密钥。</li><li><code>Sec-WebSocket-Accept</code>：服务端收到客户端发来的密钥后追加一段魔法字符串，并将结果进行SHA-1散列签名后再经过Base64加密返回客户端。</li><li><code>Sec-WebSocket-Protocol</code>：表示客户端提供的可供选择的自协议，及服务端选中的支持的子协议。</li><li><code>Origin</code>：服务器端用于区分未授权的 websocket 浏览器。</li><li><code>HTTP/1.1 101 Switching Protocols</code>：其中101为服务器返回的状态码，所有非101的状态码都表示握手并未完成。</li></ul><p>在对 <code>Sec-WebSocket-Accept</code> 的解释中，有一个魔法字符串，这个魔法字符串是 WebSocket 标准中规定的一个常量：<code>258EAFA5-E914-47DA-95CA-C5AB0DC85B11</code>。这个常量只是定制标准时随机生成的一个标识符而已。</p><h3 id="传输阶段"><a href="#传输阶段" class="headerlink" title="传输阶段"></a>传输阶段</h3><p>Websocket协议通过序列化的数据帧传输数据。数据封包协议中定义了opcode、payload length、Payload data等字段。其中要求：<strong>客户端向服务器传输的数据帧必须进行掩码处理，服务器若接收到未经过掩码处理的数据帧，则必须主动关闭连接。服务器向客户端传输的数据帧一定不能进行掩码处理，客户端若接收到经过掩码处理的数据帧，则必须主动关闭连接。</strong></p><p>具体数据帧格式如下所示：</p><pre><code>0                   1                   2                   30 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1+-+-+-+-+-------+-+-------------+-------------------------------+|F|R|R|R| opcode|M| Payload len |    Extended payload length    ||I|S|S|S|  (4)  |A|     (7)     |             (16/64)           ||N|V|V|V|       |S|             |   (if payload len==126/127)   || |1|2|3|       |K|             |                               |+-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +|     Extended payload length continued, if payload len == 127  |+ - - - - - - - - - - - - - - - +-------------------------------+|                               |Masking-key, if MASK set to 1  |+-------------------------------+-------------------------------+| Masking-key (continued)       |          Payload Data         |+-------------------------------- - - - - - - - - - - - - - - - +:                     Payload Data continued ...                :+ - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +|                     Payload Data continued ...                |+---------------------------------------------------------------+</code></pre><p>00010001</p><p><strong>FIN：</strong>标识是否为此消息的最后一个数据包，占 1 bit<br><strong>RSV1, RSV2, RSV3：</strong> 用于扩展协议，一般为0，各占1bit<br><strong>Opcode：</strong>数据包类型（frame type），占4bits</p><ul><li><code>0x0</code>：标识一个中间数据包</li><li><code>0x1</code>：标识一个text类型数据包</li><li><code>0x2</code>：标识一个binary类型数据包</li><li><code>0x3-7</code>：保留</li><li><code>0x8</code>：标识一个断开连接类型数据包</li><li><code>0x9</code>：标识一个ping类型数据包</li><li><code>0xA</code>：表示一个pong类型数据包</li><li><code>0xB-F</code>：保留</li></ul><p><strong>MASK：</strong>占1bits 用于标识PayloadData是否经过掩码处理。如果是1，Masking-key域的数据即是掩码密钥，用于解码PayloadData。客户端发出的数据帧需要进行掩码处理，所以此位是1。<br><strong>Payload length：</strong>Payload data的长度，占7bits，7+16bits，7+64bits。如果其值在0-125，则是payload的真实长度。如果值是126，则后面2个字节形成的16bits无符号整型数的值是payload的真实长度。如果值是127，则后面8个字节形成的64bits无符号整型数的值是payload的真实长度。<br><strong>Masking-key：</strong>如果是客户端发送的数据，长度信息之后的4个字节是掩码，<br><strong>Payload data：</strong>应用层数据，客户端发往服务端需要将数据的每一位和掩码的第 N%4 位进行异或运算。</p><p>而服务端返回的数据则不需要掩码和加密数据。</p><h2 id="实现服务端"><a href="#实现服务端" class="headerlink" title="实现服务端"></a>实现服务端</h2><p>接下来使用 Python3 来实现一个简单的 WebSocket 回声服务器，并每个比特的分析 WebSocket 协议的头部。</p><h3 id="编写代码"><a href="#编写代码" class="headerlink" title="编写代码"></a>编写代码</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'0.0.0.0'</span></span><br><span class="line">PORT = <span class="number">2000</span></span><br><span class="line">MAGIC_STRING = <span class="string">'258EAFA5-E914-47DA-95CA-C5AB0DC85B11'</span></span><br><span class="line"></span><br><span class="line">HTTP_RESPONSE = (</span><br><span class="line">    <span class="string">'HTTP/1.1 101 Switching Protocols\r\n'</span></span><br><span class="line">    <span class="string">"Upgrade: websocket\r\n"</span></span><br><span class="line">    <span class="string">"Connection: Upgrade\r\n"</span></span><br><span class="line">    <span class="string">"Sec-WebSocket-Accept: &#123;KEY&#125;\r\n"</span></span><br><span class="line">    <span class="string">"WebSocket-Location: ws://&#123;HOST&#125;/echo\r\n\r\n"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>这里定义监听在 TCP 2000 端口，还有 WebSocket 标准定义的魔法字符串，以及通过 HTTP 协议建立 WebSocket 连接的响应模板字符串。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">handshake</span><span class="params">(conn)</span>:</span></span><br><span class="line">    headers = &#123;&#125;</span><br><span class="line">    raw_headers = conn.recv(<span class="number">4096</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> len(raw_headers): <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    header, data = raw_headers.split(<span class="string">b'\r\n\r\n'</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> header.split(<span class="string">b'\r\n'</span>)[<span class="number">1</span>:]:</span><br><span class="line">        key, val = line.split(<span class="string">b': '</span>, <span class="number">1</span>)</span><br><span class="line">        headers[key] = val</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        sec_key = headers[<span class="string">b'Sec-WebSocket-Key'</span>]</span><br><span class="line">    <span class="keyword">except</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    res_key = base64.b64encode(hashlib.sha1(sec_key + MAGIC_STRING.encode()).digest())</span><br><span class="line">    http_response = HTTP_RESPONSE.format(KEY=res_key.decode(), HOST=HOST)</span><br><span class="line">    conn.send(http_response.encode())</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>解析客户端发来的 WebSocket 握手请求，请求头中的 <code>Sec-WebSocket-Key</code> 和魔法字符串拼接后的SHA1的值经过Base64编码返回客户端，这一步握手就成功了，接下来的数据传输就是通过 WebSocket 协议进行了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">parseData</span><span class="params">(package)</span>:</span></span><br><span class="line">    fin = package[<span class="number">0</span>] &gt;&gt; <span class="number">7</span>              <span class="comment"># 第一个字节(8 bit)右移7位获得FIN的比特位。</span></span><br><span class="line">    opcode = package[<span class="number">0</span>] &amp; <span class="number">0b1111</span>       <span class="comment"># 与运算获取最后四个比特位(opcode)的值</span></span><br><span class="line">    mask_flag = package[<span class="number">1</span>] &gt;&gt; <span class="number">7</span>        <span class="comment"># 客户端必须将MASK设置为1（必须将数据进行掩码处理）</span></span><br><span class="line">    data_length = package[<span class="number">1</span>] &amp; <span class="number">0b1111111</span>   <span class="comment"># 计算数据长度</span></span><br><span class="line">    <span class="keyword">if</span> data_length == <span class="number">126</span>:             <span class="comment"># 如果数据长度126，则之后的2个字节也是长度信息</span></span><br><span class="line">        masks = package[<span class="number">4</span>:<span class="number">8</span>]           <span class="comment"># 所以掩码值就在第 4,5,6,7 这四个字节</span></span><br><span class="line">        raw_data = package[<span class="number">8</span>:]         <span class="comment"># 实际的数据所在字节</span></span><br><span class="line">    <span class="keyword">elif</span> data_length == <span class="number">127</span>:           <span class="comment"># 如果数据长度127，则之后的8个字节也是长度信息</span></span><br><span class="line">        masks = package[<span class="number">10</span>:<span class="number">14</span>]         <span class="comment"># 所以掩码值就在第 10,11,12,13 这四个字节</span></span><br><span class="line">        raw_data = package[<span class="number">14</span>:]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        masks = package[<span class="number">2</span>:<span class="number">6</span>]           <span class="comment"># 如果长度在0-125，则 2,3,4,5 就是掩码的值</span></span><br><span class="line">        raw_data = package[<span class="number">6</span>:]</span><br><span class="line">    data = <span class="string">b""</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> B <span class="keyword">in</span> raw_data:</span><br><span class="line">        tmp = B ^ masks[i % <span class="number">4</span>]         <span class="comment"># 将数据的每个字节与掩码进行异或运算</span></span><br><span class="line">        data += struct.pack(<span class="string">'B'</span>, tmp)  <span class="comment"># 然后将值打包为二进制</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> data</span><br></pre></td></tr></table></figure><p>解析接收到的 WebSocket 数据帧，并返回解密后的数据部分。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">packData</span><span class="params">(data)</span>:</span></span><br><span class="line">    finAndOpcode = struct.pack(<span class="string">'B'</span>, <span class="number">0b10000001</span>)</span><br><span class="line">    maskAndLength = struct.pack(<span class="string">'B'</span>, len(data))</span><br><span class="line">    <span class="keyword">return</span> finAndOpcode+maskAndLength+data</span><br></pre></td></tr></table></figure><p>构建服务端返回客户端的数据帧，因为不需要对数据按字节异或加密，所以代码比较简单。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">startServer</span><span class="params">()</span>:</span></span><br><span class="line">    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class="number">1</span>)</span><br><span class="line">    sock.bind((HOST, PORT))</span><br><span class="line">    sock.listen(<span class="number">5</span>)</span><br><span class="line">    print(<span class="string">'Server listen on %s:%s ...'</span> % (HOST,PORT))</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        conn, addr = sock.accept()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> handshake(conn): </span><br><span class="line">            print(<span class="string">"Client %s:%s handshake failed!"</span> % addr)</span><br><span class="line">        print(<span class="string">"Client %s:%s handshake success!"</span> % addr)</span><br><span class="line">        data = conn.recv(<span class="number">4096</span>)</span><br><span class="line">        print(<span class="string">'Raw data: '</span>, data, sep=<span class="string">''</span>)</span><br><span class="line">        print(<span class="string">'Fact data: '</span>+parseData(data).decode())</span><br><span class="line">        conn.send(packData(parseData(data)))</span><br><span class="line">        conn.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        startServer()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        print(<span class="string">"Server exit..."</span>)</span><br></pre></td></tr></table></figure><p>创建套接字监听，并启动服务，当有客户端握手成功后，将客户端发来的数据原样返回并关闭连接。运行脚本，然后看看效果吧！</p><h3 id="浏览器测试"><a href="#浏览器测试" class="headerlink" title="浏览器测试"></a>浏览器测试</h3><p>这里在 Chrome 浏览器中做演示，<code>F12</code> 进入开发者模式，然后点击 <code>Console</code>，现在就打开 JavaScript 的交互界面了。然后输入如下代码：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://127.0.0.1:2000/echo"</span>)</span><br><span class="line">ws.onmessage = <span class="function"><span class="params">data</span> =&gt;</span> &#123;<span class="built_in">console</span>.log(<span class="string">"Recv: "</span>+data.data)&#125;</span><br><span class="line">ws.send(<span class="string">"Hi! 喵喵喵"</span>)</span><br></pre></td></tr></table></figure><p>可以看到，发送给服务端的字符串又被原样返回了。</p><p><img src="/uploads/2018/websocket/20180624225605.png" alt></p><p>服务端也可以看到终端上的输出：</p><pre><code>yunfwe@zhzz:/mnt/c/Users/yunfwe/Desktop$ python3 server.pyServer listen on 0.0.0.0:2000 ...Client 127.0.0.1:53117 handshake success!Raw data: b&apos;\x81\x8d7\x91\xc6\x8b\x7f\xf8\xe7\xab\xd2\x07sn\xa1$#\x1d\x82&apos;Fact data: Hi! 喵喵喵</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>客户端一般都是浏览器等程序，如果感兴趣的话也可以试试用 Python 实现一个简单的 WebSocket 客户端。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;WebSocket协议是基于TCP的一种新的网络协议。它实现了浏览器与服务器全双工(full-duplex)通信——允许服务器主动发送信息给客户端。它弥补了 HTTP 协议只能只能由客户端，而无法实现服务器主动推送消息。在此之前，浏览器想了解服务端有没有更新数据只能每隔一段时间就发送一个HTTP请求去询问，这样的效率是非常低下的。而通过 WebSocket，服务器和客户端可以建立一条稳定的连接，并且可以双向通信。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="WebSocket" scheme="http://www.yunfwe.cn/categories/WebSocket/"/>
    
    
      <category term="websocket" scheme="http://www.yunfwe.cn/tags/websocket/"/>
    
  </entry>
  
  <entry>
    <title>一步步搭建PXE网络装机</title>
    <link href="http://www.yunfwe.cn/2018/06/03/2018/%E4%B8%80%E6%AD%A5%E6%AD%A5%E6%90%AD%E5%BB%BAPXE%E7%BD%91%E7%BB%9C%E8%A3%85%E6%9C%BA/"/>
    <id>http://www.yunfwe.cn/2018/06/03/2018/%E4%B8%80%E6%AD%A5%E6%AD%A5%E6%90%AD%E5%BB%BAPXE%E7%BD%91%E7%BB%9C%E8%A3%85%E6%9C%BA/</id>
    <published>2018-06-03T06:44:00.000Z</published>
    <updated>2025-07-22T07:12:54.871Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>PXE (preboot execute environment，预启动执行环境) 是由 Intel 公司设计的协议，它可以使计算机通过网络启动。当计算机引导时，BIOS 把 PXE client 调入内存执行，并显示出命令菜单，经用户选择后，PXE client将放置在远端的操作系统通过网络下载到本地运行。除了可以通过网络直接运行操作系统外，也可以用于通过网络来将系统安装到本地。在运维中工作中，通过 PXE 来为机房服务器批量部署系统是非常方便的。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>PXE 对运行环境没有什么需求，只需能提供 <code>tftp</code>, <code>dhcp</code>, <code>http</code> 等服务的系统即可。这里使用 Linux 环境来搭建PXE服务。使用 <code>dnsmasq</code> 这个小巧玲珑的软件提供 <code>tftp</code> 和 <code>dhcp</code> 服务，使用 <code>Nginx</code> 来提供 <code>http</code> 服务。</p><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><p>PXE 的启动原理是 PXE client 在网卡的 ROM 中，可以在计算机开机的时候选择通过硬盘引导还是 PXE 等引导方式，比如 DELL 的服务器在出现开机 LOGO 画面后通过键入 <code>F12</code> 来进入 PXE 引导，Vmware 新创建的虚拟机在第一次启动的时候如果没有装载光驱或者ISO镜像，则会尝试通过网络引导。如果是笔记本或者台式机可以在开机的时候进入引导菜单，然后选择通过网卡设备启动。</p><p>当进入 PXE 引导界面后，PXE client 会向网络中的 dhcp 服务器请求IP地址，dhcp 服务器发现是个 PXE client 的请求会将分配好的IP和引导程序的访问地址返回给 PXE client。这个引导程序一般是名为 <code>pxelinux.0</code> 的文件，这个文件是通过 tftp 协议发送给 PXE client 的。当客户端成功获取到引导文件和引导文件的相关配置文件后就成功加载出引导菜单。这个菜单则是我们通过更改 <code>pxelinux.0</code> 的配置文件来的。下面是通过Vmware引导的效果：<br><img src="/uploads/2018/pxe/0x13622a42wirg7g.jpeg" alt></p><p>如果在30秒内没做任何选择则默认从本地磁盘启动，这样就避免了某些将PXE启动作为第一启动项的服务器重启后误重装系统。当选择了某个项目的时候，比如 <code>Install CentOS6.8 for vmware</code> 则向服务器获取根据配置文件中指定的 CentOS 内核文件和启动参数。当需要的数据都准备好后，系统则开始启动 Linux 内核，接下来的操作就跟普通的安装系统没两样了，只不过需要的数据都是通过网络获取的。比如安装 CentOS 过程中需要的所有 rpm 包都是通过 http 服务提供的 CentOS 镜像站提供的了。</p><p>但是如何通过 PXE 来同时安装成百上千台服务器呢？在安装系统的过程中，总会遇到各种需要交互的地方，比如给硬盘分区，选择语言，创建用户等地方，幸好大部分的系统安装镜像都支持通过 Kickstart 自动应答在安装过程中免人工干预的进行系统安装。就像是你的所有问题的回答我先写成一个文件，然后你需要问的时候先从文件中找答案一样。自动应答文件通常是 <code>ks.cfg</code> 文件，此文件的位置大多通过在启动 Linux 内核的时候通过启动参数的方式告诉内核。</p><p>接下来就看看 PXE 启动该如何配置。</p><h3 id="服务配置"><a href="#服务配置" class="headerlink" title="服务配置"></a>服务配置</h3><h4 id="安装-dnsmasq"><a href="#安装-dnsmasq" class="headerlink" title="安装 dnsmasq"></a>安装 dnsmasq</h4><p>可以首先从Linux发行版的官方仓库中找找有没有 <code>dnsmasq</code> 的软件包，如果没有可以下载编译。</p><p><strong>编译方法：</strong><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">wget http://www.thekelleys.org.uk/dnsmasq/dnsmasq-2.79.tar.xz</span><br><span class="line">tar xf dnsmasq-2.79.tar.xz</span><br><span class="line"><span class="built_in">cd</span> dnsmasq-2.79 &amp;&amp; make</span><br><span class="line">cp src/dnsmasq /usr/<span class="built_in">local</span>/bin/</span><br></pre></td></tr></table></figure></p><p>只需要将 dnsmasq 的二进制文件放到系统环境变量就可以了，接下来给它提供一个配置文件来告诉它要启动哪些服务。源码目录下有一个官方提供的配置文件模板，不过我们并不需要这么多的配置。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/pxeboot          <span class="comment"># PXE启动所需要的文件就都放到这里了</span></span><br><span class="line"><span class="built_in">cd</span> /data/pxeboot</span><br><span class="line">vim dnsmasq.conf</span><br></pre></td></tr></table></figure><p>然后写入以下内容：</p><pre><code># enable dhcpdhcp-range=192.168.4.10,192.168.4.200,12hdhcp-option=3,192.168.4.254dhcp-option=option:dns-server,114.114.114.114,119.29.29.29#dhcp-boot=pxelinux.0dhcp-boot=undionly.kpxe# disable dnsport=0# enable tftpenable-tftptftp-root=/data/pxeboot</code></pre><p>一定要注意，<code>dhcp-range</code> 给客户端分配的IP地址池一定要是自己网段的。根据前面讲解的 PXE 启动的原理，可能大家会比较好奇，为什么这里 dhcp 推送的是 <code>undionly.kpxe</code> 这个文件呢？这个会在下面讲到，接下来就可以先启动 dnsmasq 了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dnsmasq -C dnsmasq.conf -d      <span class="comment"># 如果不加 -d 参数，dnsmasq 则进入后台运行</span></span><br></pre></td></tr></table></figure><pre><code>[root@localhost pxeboot]# dnsmasq -C dnsmasq.conf -ddnsmasq: started, version 2.79 DNS disableddnsmasq: compile time options: IPv6 GNU-getopt no-DBus no-i18n no-IDN ......dnsmasq-dhcp: DHCP, IP range 192.168.4.10 -- 192.168.4.200, lease time 12hdnsmasq-tftp: TFTP root is /data/pxeboot </code></pre><p>现在基础的 <code>dhcp</code> 和 <code>tftp</code> 服务已经搭建完成了，<code>dhcp</code> 监听在 <code>udp 67</code> 端口，<code>tftp</code> 监听在 <code>udp 69</code>，使用前最好关闭服务器的 selinux 和 iptables。</p><h4 id="安装-Nginx"><a href="#安装-Nginx" class="headerlink" title="安装 Nginx"></a>安装 Nginx</h4><p>也不一定非要使用 Nginx，只要是能提供通过 HTTP 协议对文件进行访问服务的程序都可以，只不过感觉 Nginx 用起来更得心应手一些。同样，如果可以从发行版的官方仓库安装就非常省事了，或者手动编译也可以。</p><p><strong>编译方法：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">wget http://nginx.org/download/nginx-1.14.0.tar.gz</span><br><span class="line">tar xf nginx-1.14.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.14.0</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --without-http_rewrite_module</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>因为用不到 Nginx 的 rewrite 规则，而且这个模块依赖 pcre 库，所以就去掉了，接下来简单的配置下 Nginx。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/wwwroot/pxefiles         <span class="comment"># /data/wwwroot 作为HTTP根目录</span></span><br><span class="line">vim /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><p>然后写入以下内容：</p><pre><code>worker_processes  4;events {    worker_connections  1024;}http {    include       mime.types;    default_type  application/octet-stream;    sendfile        on;    autoindex       on;    keepalive_timeout  65;    server {        listen       80;        server_name  localhost;        location / {            root   /data/wwwroot;            index  index.html index.htm;        }        error_page   500 502 503 504  /50x.html;        location = /50x.html {            root   html;        }    }}</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx     <span class="comment"># 启动Nginx服务</span></span><br></pre></td></tr></table></figure><h4 id="安装-ipxe-引导文件"><a href="#安装-ipxe-引导文件" class="headerlink" title="安装 ipxe 引导文件"></a>安装 ipxe 引导文件</h4><p>为什么这里又出现了 ipxe 引导文件呢？理论上来说，只是用 pxelinux.0 确实也可以引导各种系统，但是 pxelinux.0  只支持使用 tftp 协议来加载需要的文件。 tftp 在使用 UDP 传输数据，为了保证文件的完整性，tftp 自己实现了一套数据校验机制，但是却大大降低了文件传输效率。而且某些未知情况下 tftp 在局域网内居然只有 KB 级别的传输速率。于是，一些支持 http 、ftp、nfs 等文件传输协议的引导程序诞生了，ipxe 就是其中一种。</p><p>ipxe 提供的引导文件针对不同使用场合又分好几种，比如 <code>.pxe</code>，<code>.kpxe</code>，<code>.kkpxe</code> 格式的引导文件。比较常见的是 <code>.pxe</code>，<code>.kpxe</code>，其中的区别可以看这里：<a href="http://etherboot.org/wiki/gpxe_imagetypes" target="_blank" rel="noopener">点此打开</a>，这里使用 <code>undionly.kpxe</code> 引导文件，采用链式加载的方法加载 pxelinux.0。这样就可以实现既使用 ipxe 提供的网络协议支持，还可以使用 pxelinux.0 提供的引导界面了。</p><p><strong>编译 undionly.kpxe：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">git <span class="built_in">clone</span> git://git.ipxe.org/ipxe.git</span><br><span class="line"><span class="built_in">cd</span> ipxe/src</span><br><span class="line">vim embed.ipxe</span><br></pre></td></tr></table></figure><p>写入如下内容：</p><pre><code>#!ipxedhcpchain tftp://${next-server}/menu.ipxe</code></pre><p>其中 <code>${next-server}</code> 会自动解析为 dhcp 服务器的地址，tftp 也搭建在这个地址上。当通过 dhcp 获取到IP地址后，通过 tftp 协议请求 <code>menu.ipxe</code> 文件，然后 ipxe 会解析和执行文件里的内容，这个文件可以说就是 ipxe 的配置文件了。接着编译出 undionly.kpxe，这样 undionly.kpxe 才会默认就加载同目录下的 menu.ipxe 文件了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make bin/undionly.kpxe EMBED=embed.ipxe</span><br><span class="line">cp bin/undionly.kpxe /data/pxeboot/</span><br></pre></td></tr></table></figure><p>其中编译步骤需要 <code>lzma.h</code> 这个头文件，需要安装你的发行版上提供这个头文件的软件包。编译好的 <code>undionly.kpxe</code> 可以保存下来下次搭建环境的时候直接用，如果服务是搭建在 Windows 系统上也可以使用这个编译好的文件。</p><p>然后编辑 <code>menu.ipxe</code> 文件，配置接下来的文件都通过 http 协议来访问，并且链接到 pxelinux.0。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /data/pxeboot/menu.ipxe</span><br></pre></td></tr></table></figure><p>写入如下内容：</p><pre><code>#!ipxeset 210:string http://192.168.4.6/pxefiles/set 209:string pxelinux.cfg/defaultchain ${210:string}pxelinux.0</code></pre><p>其中 <code>set 210:string</code> 定义了请求的文件的主目录，因为之前创建的 <code>/data/wwwroot/</code> 为 http 的根目录，<code>/data/wwwroot/pxefiles/</code> 目录中存放 pxelinux.0 相关的数据文件。其中的服务器IP地址需要替换为你实际的服务器IP。<br><code>set 209:string</code> 则定义了 pxelinux.0 直接加载 <code>pxelinux.cfg/default</code> 这个配置文件，否则 pxelinux.0 会阶梯性的查找配置文件，如果都没找到最后默认才加载 <code>pxelinux.cfg/default</code>。</p><h4 id="安装-pxelinux-0-引导文件"><a href="#安装-pxelinux-0-引导文件" class="headerlink" title="安装 pxelinux.0 引导文件"></a>安装 pxelinux.0 引导文件</h4><p>接下来的操作就是在 <code>/data/wwwroot/pxefiles/</code> 目录下进行了，因为 <code>ipxe</code> 启动后剩下的文件都是通过 http 协议访问的。</p><p>pxelinux.0 可以通过发行版的 <code>syslinux</code> 包来获取，或者自己从官方下载也可，这里采用从官方下载的方式。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src/</span><br><span class="line">wget https://mirrors.edge.kernel.org/pub/linux/utils/boot/syslinux/Testing/3.86/syslinux-3.86-pre4.tar.xz</span><br><span class="line">tar xf syslinux-3.86-pre4.tar.xz</span><br><span class="line"><span class="built_in">cd</span> syslinux-3.86-pre4</span><br><span class="line">cp com32/menu/vesamenu.c32 /data/wwwroot/pxefiles/</span><br><span class="line">cp core/pxelinux.0 /data/wwwroot/pxefiles/</span><br><span class="line">cp memdisk/memdisk /data/wwwroot/pxefiles/</span><br></pre></td></tr></table></figure><p>syslinux 最新版是16年发布的 6.04，但是使用中发现无法引导 ESXI，而且 pxelinux.0 引导后还要加载好几个 <code>.c32</code> 文件，所以采用老一点的 3.86 版本。 接着给 pxelinux.0 提供配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /data/wwwroot/pxefiles/</span><br><span class="line">mkdir pxelinux.cfg</span><br><span class="line">vim pxelinux.cfg/default</span><br></pre></td></tr></table></figure><p>写入以下内容：</p><pre><code>default vesamenu.c32timeout 300menu title Welcome to PXE server!menu background splash.jpgmenu color border 0 #ffffffff #00000000menu color sel 7 #ffffffff #ff000000menu color title 0 #ffffffff #00000000menu color tabmsg 0 #ffffffff #00000000menu color unsel 0 #ffffffff #00000000menu color hotsel 0 #ff000000 #ffffffffmenu color hotkey 7 #ffffffff #ff000000menu color scrollbar 0 #ffffffff #00000000label local    menu label Boot from local drive    menu default    localboot 0xffff</code></pre><p>这里为了界面美观使用了一张背景图片: <code>splash.jpg</code>，图片需要是一张 640*480 像素的 jpg 图片，并根据图片的主题颜色调整下页面边框、文字等颜色，如果不需要使用背景图片的话可以将 <code>menu background</code> 和 <code>menu color</code> 的配置项都删掉或者注释掉。</p><p>其中 <code>timeout 300</code> 会在引导界面30秒无操作就就启动下面 <code>label</code> 中定义为 <code>menu default</code> 的条目。到这一步已经可以尝试将虚拟机或者主机通过 PXE 启动，看看是否可以加载出引导界面了。<br><img src="/uploads/2018/pxe/6vkt321i87dn5iut.jpg" alt></p><p>接下来，试试通过 PXE 实际启动或安装一些系统吧！</p><h3 id="网络启动"><a href="#网络启动" class="headerlink" title="网络启动"></a>网络启动</h3><blockquote><p>即使是通过网络安装，也是需要系统的镜像包的。最好先将需要安装的系统的镜像下载到本地，当然如果对自己网速很自信的话是可以直接通过公网来安装系统的（方法见附录）。</p></blockquote><h4 id="安装-CentOS"><a href="#安装-CentOS" class="headerlink" title="安装 CentOS"></a>安装 CentOS</h4><h5 id="下载系统镜像"><a href="#下载系统镜像" class="headerlink" title="下载系统镜像"></a>下载系统镜像</h5><p>下载最新的CentOS镜像可以去官网或者国内的镜像站找，旧版本的可以在<a href="https://wiki.centos.org/Download" target="_blank" rel="noopener">官网</a>里找到。或者一个简单的方法，<code>http://mirror.nsc.liu.se/centos-store/6.8/isos/x86_64/</code>  把其中的6.8改为相应的版本号就可以了。</p><p>这里使用和机房服务器系统版本一致的 CentOS 6.8 镜像，如果只是想安装一个最小化的 CentOS 系统的话，选择 <code>minimal.iso</code>，而如果想安装带桌面的甚至想搭建一个本地的yum源，就使用 <code>bin-DVD1.iso</code> 和 <code>bin-DVD2.iso</code> 这两个镜像。其中 <code>bin-DVD2.iso</code> 不可用于系统安装，因为里面只是额外的RPM包，搭建 yum源的话可以将两个镜像的内容合并到一个目录中。还有个是 <code>LiveCD.iso</code> 或者 <code>LiveDVD.iso</code> 的镜像，这种镜像可以直接刻录到光盘并从光盘启动系统。</p><p>这里直接使用 <code>bin-DVD</code> 的镜像。</p><h5 id="配置安装源"><a href="#配置安装源" class="headerlink" title="配置安装源"></a>配置安装源</h5><p>首先将 <code>bin-DVD1.iso</code> 和 <code>bin-DVD2.iso</code> 的内容合并到一个目录中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/wwwroot/yum/CentOS6.8/ </span><br><span class="line">mount -o loop CentOS-6.8-x86_64-bin-DVD1.iso /mnt/</span><br><span class="line">cp -rf /mnt/* /data/wwwroot/yum/CentOS6.8/</span><br><span class="line">umount /mnt/</span><br><span class="line">mount -o loop CentOS-6.8-x86_64-bin-DVD2.iso /mnt/</span><br><span class="line">cp -rf /mnt/* /data/wwwroot/yum/CentOS6.8/      <span class="comment"># 所有同名文件都覆盖掉</span></span><br><span class="line">umount /mnt/</span><br><span class="line">ln -s /data/wwwroot/yum/ /data/wwwroot/pxefiles/yum</span><br></pre></td></tr></table></figure></p><p>这里创建了一个软链接的原因是 <code>menu.ipxe</code> 中定义为pxe主目录在 <code>/data/wwwroot/pxefiles/</code> 中。</p><h5 id="准备自动应答文件"><a href="#准备自动应答文件" class="headerlink" title="准备自动应答文件"></a>准备自动应答文件</h5><p>每次安装完 CentOS 的系统后不知道大家是否有留意root用户家目录下的三个文本文件 <code>anaconda-ks.cfg</code>，<code>install.log</code>，<code>install.log.syslog</code>。其中 <code>anaconda-ks.cfg</code> 就是系统安装过程中的所有问答产生的 <code>ks.cfg</code> 自动应答文件，这个是可以直接拿来用的。</p><p>如果这个文件被删除了，那么也可以通过软件包 <code>system-config-kickstart</code> 来定制，此工具需要在图形化界面下或者配置好了X11转移的环境中使用。使用 <code>yum -y install system-config-kickstart</code> 安装后使用 <code>system-config-kickstart</code> 运行程序。<br><img src="/uploads/2018/pxe/5mqiz0t4cj3kl885.png" alt></p><p>配置好后使用 <code>Ctrl+S</code> 保存并退出，将制作好的 <code>ks.cfg</code> 文件或者 <code>anaconda-ks.cfg</code> 复制到刚才创建的yum源中。因为不同的主机类型可能对应着不同的自动应答文件，所以可以保存为针对不同安装类型或平台的自动应答文件。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /root/anaconda-ks.cfg /data/wwwroot/yum/CentOS6.8/ks-minimal-vmware.cfg</span><br></pre></td></tr></table></figure><p><code>ks-minimal-vmware.cfg</code> 文件内容为：</p><pre><code>installreboottexturl --url=http://192.168.4.6/yum/CentOS6.8lang zh_CN.UTF-8keyboard usnetwork --onboot yes --device eth0 --mtu=1500 --bootproto dhcp --noipv6# root passwd : 123456rootpw  --iscrypted $6$5dCFp4Me$YkPWb8h0M/wRUPH3puKXcmbhsErJxfFPCXTtIzfglpfHriMBJsRtqjS5Ewh6Vj/h3mnRdXfsAGcadD3TpRAlk1firewall --service=sshauthconfig --enableshadow --passalgo=sha512selinux --disabledtimezone --utc Asia/Shanghaibootloader --location=mbr --driveorder=sda --append=&quot;crashkernel=auto rhgb rhgb quiet quiet&quot;zerombrclearpart --all --drives=sdapart /boot --fstype=ext4 --size=500part swap --size=2048part / --fstype=ext4 --grow --size=1repo --name=&quot;CentOS&quot;  --baseurl=http://192.168.4.6/yum/CentOS6.8 --cost=100%packages@Base@Core%postcd /etc/yum.repos.d/mkdir bakmv * bakcat &gt;&gt; CentOS-Base.repo &lt;&lt;END[base]name=CentOS-$releasever Basebaseurl=http://192.168.4.6/yum/CentOS6.8enabled=1gpgcheck=0ENDyum updateyum -y install lrzsz</code></pre><p>其中配置了 root 密码为 <code>123456</code>，只安装了最基础的软件包。在安装完之后自动配置系统的yum源到本地服务器上，并且安装 <code>lrzsz</code> 工具包。这里密码是通过加密后的，也可以直接使用 <code>rootpw 123456</code> 这种方式。其中 <code>reboot</code> 会在安装完成后自动重启。</p><h5 id="添加PXE启动项"><a href="#添加PXE启动项" class="headerlink" title="添加PXE启动项"></a>添加PXE启动项</h5><p>该为 pxelinux.0 添加 CentOS6.8 的启动项了，编辑 <code>pxelinux.cfg/default</code>，在 <code>label local</code> 前添加如下配置块：</p><pre><code>label centos6.8    menu label Install CentOS6.8 for vmware (minimal install)    kernel /yum/CentOS6.8/images/pxeboot/vmlinuz    append initrd=/yum/CentOS6.8/images/pxeboot/initrd.img ks=http://192.168.4.6/yum/CentOS6.8/ks-minimal-vmware.cfg ksdevice=eth0</code></pre><p><code>kernel</code> 和 <code>initrd</code> 可以使用文件对于URL的相对路径，加载的内核也是 CentOS 镜像中提供的支持PXE启动的内核文件。<code>ks</code> 是传给内核的参数，制定了自动应答文件的位置。内核启动后就不是由PXE控制网卡了，就无法使用相对路径的方式获取文件，所以自动应答文件要使用全路径。<code>ksdevice</code> 在单网卡的情况下可以不指定，如果是多网卡的服务器不指定 <code>ksdevice</code> 的话，安装过程则会停在让你手动选择要使用的网卡界面。</p><h5 id="开始安装"><a href="#开始安装" class="headerlink" title="开始安装"></a>开始安装</h5><p>再次进入PXE引导界面，可以看到刚才新加的启动项生效了，接着选择它并回车。<br><img src="/uploads/2018/pxe/3ihwi58wc69mw74s.jpg" alt></p><p>可以看到剩下的过程根本没有人工干预就安装完成了。<br><img src="/uploads/2018/pxe/x4veg4eehtzk2o75.jpg" alt></p><p>安装完成后会自动重启。</p><h4 id="安装-Ubuntu"><a href="#安装-Ubuntu" class="headerlink" title="安装 Ubuntu"></a>安装 Ubuntu</h4><h5 id="下载系统镜像-1"><a href="#下载系统镜像-1" class="headerlink" title="下载系统镜像"></a>下载系统镜像</h5><p>镜像可以从Ubuntu官网下载，也可以在中科大或其他的国内开源镜像站中下载。<a href="http://mirrors.ustc.edu.cn/ubuntu-releases/" target="_blank" rel="noopener">点此打开</a></p><p>这里使用 <code>ubuntu-16.04.4-server-amd64.iso</code> 这个镜像，最新的 <code>ubuntu-18.04</code> 并没有经过测试，不知道是否还能用此方法进行安装。</p><h5 id="配置安装源-1"><a href="#配置安装源-1" class="headerlink" title="配置安装源"></a>配置安装源</h5><p>同理将镜像解压到web目录。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/wwwroot/apt/ubuntu16.04</span><br><span class="line">mount -o loop ubuntu-16.04.4-server-amd64.iso /mnt/</span><br><span class="line">cp -rf /mnt/* /data/wwwroot/apt/ubuntu16.04</span><br><span class="line">umount /mnt/</span><br><span class="line">ln -s /data/wwwroot/apt/ /data/wwwroot/pxefiles/apt</span><br></pre></td></tr></table></figure><h5 id="准备自动应答文件-1"><a href="#准备自动应答文件-1" class="headerlink" title="准备自动应答文件"></a>准备自动应答文件</h5><p>也可以在 ubuntu 上使用 <code>system-config-kickstart</code> 工具来制作自动应答文件，使用前先安装：<code>apt install system-config-kickstart</code>。ubuntu 的自动应答文件不可以和 CentOS 的通用。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /data/wwwroot/apt/ubuntu16.04/ks-server-vmware.cfg</span><br></pre></td></tr></table></figure><p>文件内容如下：</p><pre><code>lang en_USlangsupport en_USkeyboard usmousetimezone Asia/Shanghairootpw --disabled# ubuntu password: 123456user ubuntu --fullname &quot;ubuntu&quot; --iscrypted --password $1$4C9x9TxO$PfPaSIUWQwN80J0MtEyQ3.reboottextinstallurl --url http://192.168.4.6/apt/ubuntu16.04/bootloader --location=mbr zerombr yesclearpart --all --initlabel part / --fstype ext4 --size 1 --grow part swap --size 2048 auth  --useshadow  --enablemd5 network --bootproto=dhcp --device=eth0firewall --disabled skipx%packages@^minimal@coreopenssh-server</code></pre><p>其中新建了一个叫 <code>ubuntu</code> 的用户，用户密码是 <code>123456</code>。默认没有配置root用户的密码，可以使用普通用户登陆后使用 <code>sudo</code> 来切换到 root 用户。ubuntu 默认是不允许 root 用户登陆的，需要修改 <code>/etc/ssh/sshd_config</code> 中的 <code>PermitRootLogin</code> 为 <code>yes</code>。</p><h5 id="添加PXE启动项-1"><a href="#添加PXE启动项-1" class="headerlink" title="添加PXE启动项"></a>添加PXE启动项</h5><p>编辑 <code>pxelinux.cfg/default</code> 添加如下 <code>label</code> 块：</p><pre><code>label ubuntu server 16.04    menu label Install Ubuntu server 16.04.4 (minimal install)    kernel /apt/ubuntu16.04/install/netboot/ubuntu-installer/amd64/linux    append initrd=apt/ubuntu16.04/install/netboot/ubuntu-installer/amd64/initrd.gz ks=http://192.168.4.6/apt/ubuntu16.04/ks-server-vmware.cfg  --- live-installer/net-image=http://192.168.4.6/apt/ubuntu16.04/install/filesystem.squashfs</code></pre><h5 id="开始安装-1"><a href="#开始安装-1" class="headerlink" title="开始安装"></a>开始安装</h5><p><img src="/uploads/2018/pxe/2b5ofwx57dqotb0o.jpg" alt></p><p><img src="/uploads/2018/pxe/8rpwsvrzb3qmt4n1.png" alt></p><p>安装完成后会自动重启。</p><h4 id="安装-ESXI"><a href="#安装-ESXI" class="headerlink" title="安装 ESXI"></a>安装 ESXI</h4><h5 id="下载系统镜像-2"><a href="#下载系统镜像-2" class="headerlink" title="下载系统镜像"></a>下载系统镜像</h5><p>在官网下载需要登陆，<a href="https://my.vmware.com/web/vmware/details?downloadGroup=ESXI650&amp;productId=614" target="_blank" rel="noopener">官方下载地址</a>。如果是用于服务器安装，那最好找找有没有服务器官方提供的针对服务器硬件的 ESXI 版本，比如戴尔官方提供的定制版 ESXI <a href="https://www.dell.com/support/article/cn/zh/cndhs1/sln290857/dell%E5%AE%9A%E5%88%B6%E7%9A%84esxi-%E7%B3%BB%E7%BB%9F%E4%B8%8B%E8%BD%BD%E5%8F%8A%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E?lang=zh" target="_blank" rel="noopener">戴尔官方下载地址</a></p><p>这里使用戴尔官方提供的 <code>VMware ESXi 5.5 Update 3</code> <a href="https://downloads.dell.com/FOLDER03324804M/1/VMware-VMvisor-Installer-5.5.0.update03-3029944.x86_64-Dell_Customized-A00.iso" target="_blank" rel="noopener">点此下载</a></p><h5 id="配置安装源-2"><a href="#配置安装源-2" class="headerlink" title="配置安装源"></a>配置安装源</h5><p>ESXI 的镜像比较特殊，需要做些调整才可以通过 PXE 安装。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/wwwroot/esxi/5.5</span><br><span class="line">mount -o loop VMware-VMvisor-Installer-5.5.0.update03-3029944.x86_64-Dell_Customized-A00.iso /mnt</span><br><span class="line">cp -rf /mnt/* /data/wwwroot/esxi/5.5/</span><br><span class="line">umount /mnt</span><br><span class="line">ln -s /data/wwwroot/esxi/ /data/wwwroot/pxefiles/esxi</span><br></pre></td></tr></table></figure></p><p>修改 <code>exsi/5.5</code> 目录中的 <code>boot.cfg</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sed -i <span class="string">'1a\prefix=/esxi/5.5/'</span> /data/wwwroot/esxi/5.5/boot.cfg</span><br><span class="line">sed -i <span class="string">'6s/\///g'</span> /data/wwwroot/esxi/5.5/boot.cfg</span><br><span class="line">sed -i <span class="string">'s/^kernel=.*$/kernel=tboot.b00/g'</span> /data/wwwroot/esxi/5.5/boot.cfg</span><br></pre></td></tr></table></figure><h5 id="准备自动应答文件-2"><a href="#准备自动应答文件-2" class="headerlink" title="准备自动应答文件"></a>准备自动应答文件</h5><p>编辑 <code>/data/wwwroot/esxi/5.5/ks.cfg</code>，写入如下内容：</p><pre><code>accepteularootpw 12345678clearpart --firstdisk=local --overwritevmfsinstall --firstdisk=local  --overwritevmfsnetwork --bootproto=dhcp --device=vmnic0reboot</code></pre><p>root 用户的密码是 <code>12345678</code></p><h5 id="添加PXE启动项-2"><a href="#添加PXE启动项-2" class="headerlink" title="添加PXE启动项"></a>添加PXE启动项</h5><p>编辑 <code>pxelinux.cfg/default</code> 添加如下 <code>label</code> 块：</p><pre><code>label Install ESXI 5.5 for dell    menu label Install ESXI 5.5 for dell    kernel /esxi/5.5/mboot.c32    append -c /esxi/5.5/boot.cfg ks=http://192.168.4.6/esxi/5.5/ks.cfg </code></pre><h5 id="开始安装-2"><a href="#开始安装-2" class="headerlink" title="开始安装"></a>开始安装</h5><p>虽然下载的是针对服务器的，但是为了方便截图依然使用虚拟机测试。需要注意的是，虚拟机安装 ESXI 需要将操作系统设置为 <code>VMware EXS(X)</code><br><img src="/uploads/2018/pxe/a05bhdk9pm6i7c3c.png" alt></p><p>然后正常进入PXE引导菜单<br><img src="/uploads/2018/pxe/b9k26937082vpanv.jpg" alt></p><p><img src="/uploads/2018/pxe/6sj1599227upe6k0.png" alt></p><p>安装完成后会自动重启。</p><h4 id="安装-Windows"><a href="#安装-Windows" class="headerlink" title="安装 Windows"></a>安装 Windows</h4><p>Windows 系统的安装就比较特殊了，因为不像 Linux 可以通过内核引导启动，虽然也可以实现无人应答安装，但是研究的成本高于工作中的实际成本，所以这里只实现了可以通过网络手动安装 Windows 系统。</p><p>Windows 系统的安装需要一个 WinPE 的安装环境，先通过网络引导启动 WinPE，然后在 WinPE 环境中安装 Windows 镜像。</p><h5 id="下载系统镜像-3"><a href="#下载系统镜像-3" class="headerlink" title="下载系统镜像"></a>下载系统镜像</h5><p>除了可以在微软官方下载镜像，也可以在国内好心人制作的 <a href="https://msdn.itellyou.cn/" target="_blank" rel="noopener"><strong>MSDN I Tell You</strong></a> 里下载。</p><p>这里使用 <code>windows_server_2008_R2_standard_enterprise_and_datacenter_x64_dvd_x15-59777.iso</code> 这个镜像。</p><h5 id="配置镜像站"><a href="#配置镜像站" class="headerlink" title="配置镜像站"></a>配置镜像站</h5><p>首先需要一个带网络功能的 WinPE，如果不嫌麻烦的话可以百度如何制作 WinPE 镜像，如果采用第三方提供做好的 WinPE 就需要保证镜像是否是干净安全的，而且还需要集成了网卡驱动，如果是用于服务器安装，可能还需要集成 Raid 卡的驱动。</p><p>这里使用无垠PE制作的 <code>Win8PE64网络版.iso</code> <a href="https://pan.baidu.com/s/1U0UrufcDA3RMIFkBKucBEQ" target="_blank" rel="noopener">点此打开网盘分享</a> 密码：<code>sees</code>。其中有一个 <code>win8pe_x64_raid_network.iso</code> 的镜像据说是集成了 Raid 卡驱动适用于服务器的 WinPE，实际还并未测试过。</p><p>PXE环境对中文的支持能力几乎没有，所以下载后需要将文件名中的中文去掉，然后放到相应目录。然后将 Windows 系统安装镜像解压。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/wwwroot/windows/windows_server_2008_x64</span><br><span class="line">mv Win8PE64网络版.iso /data/wwwroot/windows/win8pe.iso</span><br><span class="line">ln -s /data/wwwroot/windows/ /data/wwwroot/pxefiles/windows</span><br><span class="line">mount -o loop windows_server_2008_R2_standard_enterprise_and_datacenter_x64_dvd_x15-59777.iso /mnt</span><br><span class="line">cp -rf /mnt/* /data/wwwroot/windows/windows_server_2008_x64/</span><br><span class="line">umount /mnt</span><br></pre></td></tr></table></figure><p>接下来就是另一个比较麻烦的地方了，因为在 WinPE 中通过网络安装 Windows 系统最简单方便的方法就是在 Linux 上创建 Samba 共享，然后 WinPE 中挂载使用。Samba 软件也可以从发行版的官方仓库中获得，或者手动编译安装。</p><p><strong>编译安装 Samba：</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget https://download.samba.org/pub/samba/stable/samba-4.8.2.tar.gz</span><br><span class="line">tar xf samba-4.8.2.tar.gz</span><br><span class="line"><span class="built_in">cd</span> samba-4.8.2</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/samba</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><p>配置过程中如果出现了什么错误，就根据提示自行解决依赖。接着配置 Samba 共享目录并启动服务。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/<span class="built_in">local</span>/samba/etc/smb.conf</span><br></pre></td></tr></table></figure><p>写入如下内容：</p><pre><code>[global]workgroup = MYGROUPserver string = Samba Serverserver role = standalone serverlog file = /dev/stdoutmax log size = 50dns proxy = no pam password change = yesmap to guest = bad userusershare allow guests = yescreate mask = 0664force create mode = 0664directory mask = 0775force directory mode = 0775force user = rootforce group = rootfollow symlinks = yesload printers = noprinting = bsdprintcap name = /dev/nulldisable spoolss = yessocket options = TCP_NODELAYstrict locking = novfs objects = recyclerecycle:keeptree = yesrecycle:versions = yesmin protocol = SMB2[public]path = /data/wwwroot/windows/browsable = yesread only = yesguest ok = yesveto files = /._*/.apdisk/.AppleDouble/.DS_Store/.TemporaryItems/.Trashes/desktop.ini/ehthumbs.db/Network Trash Folder/Temporary Items/Thumbs.db/delete veto files = yes</code></pre><p>启动 Samba 服务后可以在 Windows 上连接试试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/samba/sbin/smbd -D</span><br></pre></td></tr></table></figure><p>在 Windows 资源管理器中输入 <code>\\192.168.4.6</code> 就可以打开共享的目录了。<br><img src="/uploads/2018/pxe/2w9a7x5g6s92nk48.png" alt></p><h5 id="添加PXE启动项-3"><a href="#添加PXE启动项-3" class="headerlink" title="添加PXE启动项"></a>添加PXE启动项</h5><p>还记得之前和 pxelinux.0 同一目录的 <code>memdisk</code> 文件吧，这通过这个文件可以将 iso 镜像加载到内存中启动，就利用这个方式来启动 WinPE 镜像。</p><p>编辑 <code>pxelinux.cfg/default</code> 添加如下 <code>label</code> 块：</p><pre><code>label Install windows for vmware (WinPE)    menu label Install Windows for vmware (WinPE)    kernel memdisk    append initrd=/windows/win8pe.iso ksdevice=bootif raw iso</code></pre><h5 id="开始安装-3"><a href="#开始安装-3" class="headerlink" title="开始安装"></a>开始安装</h5><p>选择启动 WinPE<br><img src="/uploads/2018/pxe/7oc9iwmnn6hc5i0w.jpg" alt></p><p>进入 WinPE 桌面环境后连接到服务端的 Samba 共享目录，然后执行 Windows 系统安装镜像中的 <code>setup.exe</code><br><img src="/uploads/2018/pxe/b78i7o7u8y0e231r.jpg" alt></p><p>剩下的步骤就是 Windows 系统的普遍安装方式了。</p><h4 id="Ubuntu-LiveCD"><a href="#Ubuntu-LiveCD" class="headerlink" title="Ubuntu LiveCD"></a>Ubuntu LiveCD</h4><p>LiveCD 是个比较有意思的模式，用于直接通过光盘或者镜像启动 Linux，相当于直接将光盘作为根文件系统，在不安装到硬盘的情况下就可以体验到当前发行版了。而且稍加修改就可以通过网络来启动，由于不依赖硬盘启动，个人认为还可以将 LiveCD 模式当作救援模式使用，因为 LiveCD 模式下相当于正常启动了 Linux 系统，因此也可以正常使用包管理器来安装软件，以及挂载和卸载硬盘。</p><p>LiveCD 需要通过 NFS 来加载镜像内容，因此还需要搭建一个 NFS 目录共享。</p><h5 id="下载系统镜像-4"><a href="#下载系统镜像-4" class="headerlink" title="下载系统镜像"></a>下载系统镜像</h5><p>由于 Ubuntu Server 的镜像不支持 LiveCD 模式，所以这里使用桌面版的 Ubuntu-16.04 镜像。镜像名为：<code>ubuntu-16.04.3-desktop-amd64.iso</code></p><h5 id="配置-NFS-共享"><a href="#配置-NFS-共享" class="headerlink" title="配置 NFS 共享"></a>配置 NFS 共享</h5><p>各发行版的 NFS 使用的软件包名称都不太一样，可以借助搜索引擎获取你所使用的发行版是如何安装 NFS 共享软件包的，这里就使用 CentOS 6.8 的 NFS 共享为例。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/wwwroot/apt/ubuntu16.04-desktop/</span><br><span class="line">mount -o loop ubuntu-16.04.3-desktop-amd64.iso /mnt/</span><br><span class="line">cp -rf /mnt/* /data/wwwroot/apt/ubuntu16.04-desktop/</span><br><span class="line">umount /mnt</span><br><span class="line">yum install -y rpcbind nfs-utils</span><br><span class="line">vim /etc/exports</span><br></pre></td></tr></table></figure><p>写入如下内容：</p><pre><code>/data/wwwroot/apt/ubuntu16.04-desktop/    *    (ro,sync,no_root_squash)</code></pre><p>启动 NFS 服务</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service rpcbind restart</span><br><span class="line">service nfs restart</span><br></pre></td></tr></table></figure><p>共享成功后可以在其他主机上看到自己的共享：</p><pre><code>[root@localhost ~]# showmount -e 192.168.4.6Export list for 192.168.4.6:/data/wwwroot/apt/ubuntu16.04-desktop *[root@localhost ~]#</code></pre><h5 id="添加PXE启动项-4"><a href="#添加PXE启动项-4" class="headerlink" title="添加PXE启动项"></a>添加PXE启动项</h5><p>编辑 <code>pxelinux.cfg/default</code> 添加如下 <code>label</code> 块：</p><pre><code>label Ubuntu 16.04 amd64    menu label Ubuntu 16.04 amd64 LiveCD    kernel /apt/ubuntu16.04-desktop/casper/vmlinuz.efi    append initrd=/apt/ubuntu16.04-desktop/casper/initrd.lz boot=casper netboot=nfs nfsroot=192.168.4.133:/data/wwwroot/apt/ubuntu16.04-desktop/  splash locale=zh_CN url=http://192.168.4.133/apt/ubuntu16.04-desktop/preseed/ubuntu.seed</code></pre><h5 id="进入-LiveCD-模式"><a href="#进入-LiveCD-模式" class="headerlink" title="进入 LiveCD 模式"></a>进入 LiveCD 模式</h5><p><img src="/uploads/2018/pxe/0x13622a42wirg7g.jpeg" alt></p><p>加载过程可能会比较慢，但最后还是成功进入了 Ubuntu 桌面。<br><img src="/uploads/2018/pxe/78c56779m1mk3qjx.jpeg" alt></p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p><strong>附件：</strong><a href="/uploads/2018/pxe/files.tar.xz">点击下载</a><br>压缩包里包含了所有的配置文件和dnsmasq, pxelinux.0, undionly.kpxe 这些就可以免去编译安装了。</p><p>再介绍一个好玩的，通过中科大网络启动服务来安装系统 <a href="https://lug.ustc.edu.cn/wiki/server/pxe/start?bootswatch-theme=cosmo" target="_blank" rel="noopener">点此访问</a></p><p>如果觉得手动配置PXE启动的每一个环节非常麻烦，可以试试自动化装机神器 <a href="http://cobbler.github.io/" target="_blank" rel="noopener"><strong>Cobbler</strong></a>。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;PXE (preboot execute environment，预启动执行环境) 是由 Intel 公司设计的协议，它可以使计算机通过网络启动。当计算机引导时，BIOS 把 PXE client 调入内存执行，并显示出命令菜单，经用户选择后，PXE client将放置在远端的操作系统通过网络下载到本地运行。除了可以通过网络直接运行操作系统外，也可以用于通过网络来将系统安装到本地。在运维中工作中，通过 PXE 来为机房服务器批量部署系统是非常方便的。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="PXE" scheme="http://www.yunfwe.cn/categories/PXE/"/>
    
    
      <category term="pxe" scheme="http://www.yunfwe.cn/tags/pxe/"/>
    
  </entry>
  
  <entry>
    <title>一起动手写一个VPN</title>
    <link href="http://www.yunfwe.cn/2018/05/24/2018/%E4%B8%80%E8%B5%B7%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AAVPN/"/>
    <id>http://www.yunfwe.cn/2018/05/24/2018/%E4%B8%80%E8%B5%B7%E5%8A%A8%E6%89%8B%E5%86%99%E4%B8%80%E4%B8%AAVPN/</id>
    <published>2018-05-24T15:21:00.000Z</published>
    <updated>2025-07-22T07:12:54.871Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>了解了OpenVPN之后，发现通过一个UDP隧道来打通NAT网络非常有意思，于是就萌发出使用Python来实现一个类似于OpenVPN的隧道，OpenVPN不仅支持UDP协议还支持TCP协议，但是这里并不会像OpenVPN设计的这么复杂完善，只使用简单的UDP协议和密码认证。也通过这个小程序来更深入的学习下Linux网络相关的知识。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>VPN隧道的实现依赖于Linux内核提供的 <code>tun/tap</code> 虚拟网络接口，只要不是太古董级别的Linux系统，或者其他类Unix系统就都可以支持。可以查看是否存在设备文件 <code>/dev/net/tun</code>，如果存在则表示支持 <code>tun/tap</code> 功能，对于早些的Linux内核，设备文件还可能是 <code>/dev/tun</code>。</p><p>其中 <code>tun</code> 是模拟的三层网络设备，只支持三层以上的协议，只能做到点对点隧道，而 <code>tap</code> 则可以模拟二层网络设备，<code>arp</code> 协议等二层协议也是支持的，可以实现多机组成的虚拟局域网。<code>tun</code> 也可以通过数据转发的方式实现互通。</p><p>服务端代码为了更高的性能和不依赖第三方库使用Python3完成，客户端就尽量兼容更多版本的Python。网络使用常用的 <code>tun</code> 虚拟网卡。</p><h2 id="编程"><a href="#编程" class="headerlink" title="编程"></a>编程</h2><p>先来理解一下使用 <code>tun</code> 的VPN是如何实现的呢？简单来说 就是 <code>/dev/net/tun</code> 设备实现了应用层直接处理网络数据包的能力。当使用 <code>/dev/net/tun</code> 创建了虚拟网卡设备后，发到这个网卡的数据包会被 <code>/dev/net/tun</code> 拦截并返回给打开它上上层程序，上层程序可以通过 <code>udp</code>、<code>tcp</code> 甚至 <code>icmp</code> 协议将原始的数据包发送到目标主机。当目标主机通过网络接受到数据包后再写入到 <code>/dev/net/tun</code> 设备中，<code>/dev/net/tun</code> 再将数据包注入到内核的网络协议栈按照正常到达的数据包来处理。VPN大部分采用的是通过 <code>udp</code> 协议发送到对端的，如果是通过 <code>tcp</code> 协议传输，<code>tcp</code> 包内部包裹着另一个 <code>tcp</code> 包，如果发生了丢包重传现象，内部的 <code>tcp</code> 包和外部的 <code>tcp</code> 包可能发生混乱。</p><h3 id="服务端程序"><a href="#服务端程序" class="headerlink" title="服务端程序"></a>服务端程序</h3><blockquote><p>服务端程序使用 Python3 开发，只使用了标准库</p></blockquote><h4 id="导入需要的模块"><a href="#导入需要的模块" class="headerlink" title="导入需要的模块"></a>导入需要的模块</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> fcntl <span class="keyword">import</span> ioctl</span><br><span class="line"><span class="keyword">from</span> select <span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line"><span class="keyword">from</span> ipaddress <span class="keyword">import</span> ip_network</span><br></pre></td></tr></table></figure><p>可能大多数人都熟悉 <code>os</code>, <code>sys</code>, <code>time</code> 这些模块，而对其他的就不太了解了。其中 <code>struct</code> 是一个将Python的数据类型转换为C语言中的数据类型的字节流的模块。<code>fnctl.ioctl</code> 用来对设备的一些特性进行控制，比如这里来设定要启用的虚拟网卡的类型和网卡名称。<code>select</code> 是 <code>I/O多路复用</code> 的一个实现，用来在单线程中高效的利用网络I/O。<code>ipaddress</code> 模块是Python3新增的模块，用来解析IP地址的。</p><h4 id="定义一些常量"><a href="#定义一些常量" class="headerlink" title="定义一些常量"></a>定义一些常量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DEBUG = <span class="literal">True</span></span><br><span class="line">PASSWORD = <span class="string">b'4fb88ca224e'</span></span><br><span class="line"></span><br><span class="line">BIND_ADDRESS = <span class="string">'0.0.0.0'</span>,<span class="number">2003</span></span><br><span class="line">NETWORK = <span class="string">'10.0.0.0/24'</span></span><br><span class="line">BUFFER_SIZE = <span class="number">4096</span></span><br><span class="line">MTU = <span class="number">1400</span></span><br><span class="line"></span><br><span class="line">IPRANGE = list(map(str,ip_network(NETWORK)))[<span class="number">1</span>:]</span><br><span class="line">LOCAL_IP = IPRANGE.pop(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">TUNSETIFF = <span class="number">0x400454ca</span></span><br><span class="line">IFF_TUN   = <span class="number">0x0001</span></span><br><span class="line">IFF_TAP   = <span class="number">0x0002</span></span><br></pre></td></tr></table></figure><p>在这里定义了一些常量，比如认证的密码，服务监听的地址，以及整个网络段。其中不太好理解的可能是 <code>TUNSETIFF</code>, <code>IFF_TUN</code> 和 <code>IFF_TAP</code> 这三个常量。这三个常量实际上是定义在 <code>linux/if_tun.h</code> 这个头文件中，因为用Python来实现 <code>tun</code> 隧道 所以也需要使用这三个常量。<code>TUNSETIFF</code> 这个常量是告诉 <code>ioctl</code> 要完成虚拟网卡的注册，而<code>IFF_TUN</code> 和 <code>IFF_TAP</code> 则表示是要使用 <code>tun</code> 类型还是 <code>tap</code> 类型的虚拟网卡。</p><h4 id="创建和启动虚拟网卡"><a href="#创建和启动虚拟网卡" class="headerlink" title="创建和启动虚拟网卡"></a>创建和启动虚拟网卡</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createTunnel</span><span class="params">(tunName=<span class="string">'tun%d'</span>,tunMode=IFF_TUN)</span>:</span></span><br><span class="line">    tunfd = os.open(<span class="string">"/dev/net/tun"</span>, os.O_RDWR)</span><br><span class="line">    ifn = ioctl(tunfd, TUNSETIFF, struct.pack(<span class="string">b"16sH"</span>, tunName.encode(), tunMode))</span><br><span class="line">    tunName = ifn[:<span class="number">16</span>].decode().strip(<span class="string">"\x00"</span>)</span><br><span class="line">    <span class="keyword">return</span> tunfd,tunName</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">startTunnel</span><span class="params">(tunName,peerIP)</span>:</span></span><br><span class="line">    os.popen(<span class="string">'ifconfig %s %s dstaddr %s mtu %s up'</span> % </span><br><span class="line">                (tunName, LOCAL_IP, peerIP, MTU)).read()</span><br><span class="line">    </span><br><span class="line">now = <span class="keyword">lambda</span> :time.strftime(<span class="string">'[%Y/%m/%d %H:%M:%S] '</span>)</span><br></pre></td></tr></table></figure><p>先看 <code>createTunnel</code> 函数，默认是使用 <code>tun</code> 类型的虚拟网卡，<code>os.open</code> 是更底层的文件读写方式，事实上，常用的 <code>open(&#39;filename&#39;)</code> 方法就是对 <code>os.open</code> 的高级封装，<code>os.O_RDWR</code> 标志以读写模式打开 <code>tun</code> 的设备文件。然后使用 <code>ioctl</code> 来创建一个虚拟网卡，并返回创建成功后的网卡名称，默认是按照 <code>tun0</code>，<code>tun1</code> 依次增加的。</p><p><code>startTunnel</code> 就是用 <code>ifconfig</code> 命令为这个虚拟网卡配置IP地址。<code>MTU</code> 之所以设置为 1400 因为Linux默认网卡的 <code>MTU</code> 是 1500，但是隧道来的数据包还要包裹一层 <code>udp</code> 封装发往对端，如果隧道的 <code>MTU</code> 也设置为 1500 的话，那最终通过 <code>udp</code> 封装后肯定会超出物理网卡的界限，最终会被拆分为两个数据包发送二照成不必要的浪费。 <code>now</code> 是一个 <code>lambda</code> 表达式，给下面的打印调试信息使用。</p><h4 id="VPN的核心实现"><a href="#VPN的核心实现" class="headerlink" title="VPN的核心实现"></a>VPN的核心实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Server</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.sessions = []</span><br><span class="line">        self.readables = []</span><br><span class="line">        self.udp = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">        self.udp.bind(BIND_ADDRESS)</span><br><span class="line">        self.readables.append(self.udp)</span><br><span class="line">        self.tunInfo = &#123;</span><br><span class="line">            <span class="string">'tunName'</span>:<span class="literal">None</span>, <span class="string">'tunfd'</span>:<span class="literal">None</span>, </span><br><span class="line">            <span class="string">'addr'</span>:<span class="literal">None</span>, <span class="string">'tunAddr'</span>:<span class="literal">None</span>, <span class="string">'lastTime'</span>:<span class="literal">None</span></span><br><span class="line">            &#125;</span><br><span class="line">        print(<span class="string">'Server listen on %s:%s...'</span> % BIND_ADDRESS)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getTunByAddr</span><span class="params">(self, addr)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.sessions:</span><br><span class="line">            <span class="keyword">if</span> i[<span class="string">'addr'</span>] == addr: <span class="keyword">return</span> i[<span class="string">'tunfd'</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getAddrByTun</span><span class="params">(self,tunfd)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.sessions:</span><br><span class="line">            <span class="keyword">if</span> i[<span class="string">'tunfd'</span>] == tunfd: <span class="keyword">return</span> i[<span class="string">'addr'</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">createSession</span><span class="params">(self, addr)</span>:</span></span><br><span class="line">        tunfd,tunName = createTunnel()</span><br><span class="line">        tunAddr = IPRANGE.pop(<span class="number">0</span>)</span><br><span class="line">        startTunnel(tunName,tunAddr)</span><br><span class="line">        self.sessions.append(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">'tunName'</span>:tunName, <span class="string">'tunfd'</span>:tunfd, <span class="string">'addr'</span>:addr, </span><br><span class="line">                <span class="string">'tunAddr'</span>:tunAddr, <span class="string">'lastTime'</span>:time.time()</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">        self.readables.append(tunfd)</span><br><span class="line">        reply = <span class="string">'%s;%s'</span> % (tunAddr,LOCAL_IP)</span><br><span class="line">        self.udp.sendto(reply.encode(), addr)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delSessionByTun</span><span class="params">(self, tunfd)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> tunfd == <span class="number">-1</span>: <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.sessions:</span><br><span class="line">            <span class="keyword">if</span> i[<span class="string">'tunfd'</span>] == tunfd:</span><br><span class="line">                self.sessions.remove(i)</span><br><span class="line">                IPRANGE.append(i[<span class="string">'tunAddr'</span>])</span><br><span class="line">        self.readables.remove(tunfd)</span><br><span class="line">        os.close(tunfd)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">updateLastTime</span><span class="params">(self, tunfd)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> self.sessions:</span><br><span class="line">            <span class="keyword">if</span> i[<span class="string">'tunfd'</span>] == tunfd:</span><br><span class="line">                i[<span class="string">'lastTime'</span>] = time.time()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cleanExpireTun</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> self.sessions:</span><br><span class="line">                <span class="keyword">if</span> (time.time() - i[<span class="string">'lastTime'</span>]) &gt; <span class="number">60</span>:</span><br><span class="line">                    self.delSessionByTun(i[<span class="string">'tunfd'</span>])</span><br><span class="line">                    <span class="keyword">if</span> DEBUG: print(<span class="string">'Session: %s:%s expired!'</span> % i[<span class="string">'addr'</span>])</span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">auth</span><span class="params">(self,addr,data,tunfd)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b'\x00'</span>:</span><br><span class="line">            <span class="keyword">if</span> tunfd == <span class="number">-1</span>:</span><br><span class="line">                self.udp.sendto(<span class="string">b'r'</span>, addr)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                self.updateLastTime(tunfd)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> data == <span class="string">b'e'</span>:</span><br><span class="line">            <span class="keyword">if</span> self.delSessionByTun(tunfd):</span><br><span class="line">                <span class="keyword">if</span> DEBUG: print(<span class="string">"Client %s:%s is disconnect"</span> % addr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">if</span> data == PASSWORD:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">if</span> DEBUG: print(<span class="string">'Clinet %s:%s connect failed'</span> % addr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_forever</span><span class="params">(self)</span>:</span></span><br><span class="line">        cleanThread = Thread(target=self.cleanExpireTun)</span><br><span class="line">        cleanThread.setDaemon(<span class="literal">True</span>)</span><br><span class="line">        cleanThread.start()</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            readab = select(self.readables, [], [], <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">for</span> r <span class="keyword">in</span> readab:</span><br><span class="line">                <span class="keyword">if</span> r == self.udp:</span><br><span class="line">                    data, addr = self.udp.recvfrom(BUFFER_SIZE)</span><br><span class="line">                    <span class="keyword">if</span> DEBUG: print(now()+<span class="string">'from    (%s:%s)'</span> % addr, data[:<span class="number">10</span>])</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        tunfd = self.getTunByAddr(addr)</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            os.write(tunfd,data)</span><br><span class="line">                        <span class="keyword">except</span> OSError:</span><br><span class="line">                            <span class="keyword">if</span> <span class="keyword">not</span> self.auth(addr,data,tunfd):<span class="keyword">continue</span></span><br><span class="line">                            self.createSession(addr)</span><br><span class="line">                            <span class="keyword">if</span> DEBUG: print(<span class="string">'Clinet %s:%s connect successful'</span> % addr)</span><br><span class="line">                    <span class="keyword">except</span> OSError: <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        addr = self.getAddrByTun(r)</span><br><span class="line">                        data = os.read(r, BUFFER_SIZE)</span><br><span class="line">                        self.udp.sendto(data,addr)</span><br><span class="line">                        <span class="keyword">if</span> DEBUG: print(now()+<span class="string">'to      (%s:%s)'</span> % addr, data[:<span class="number">10</span>])</span><br><span class="line">                    <span class="keyword">except</span> Exception:</span><br><span class="line">                        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure><p>一步一步的来看，首先定义了一个 <code>Server</code> 的类。在初始化方法 <code>__init__</code> 中，<code>self.sessions = []</code> 用来保存连接的用户会话，<code>self.readables = []</code> 用来保存为每个会话创建的隧道的文件描述符，接着创建了一个 <code>udp</code> 的网络套接字，并将这个套接字加入到 <code>self.readables</code> 中。<code>self.tunInfo</code> 定义了每个会话保存的隧道信息。</p><p>接下来的 <code>getTunByAddr</code> 是通过接受到的 <code>udp</code> 数据包的来源信息找到需要注入到哪条隧道中，<code>getAddrByTun</code> 正好相反，根据从隧道来的数据找到是要通过 <code>udp</code> 发往哪个主机。</p><p><code>createSession</code> 则是客户端连接成功后为它创建一个会话和相应的虚拟网卡，并且将客户端的网卡配置信息通过 <code>udp</code> 发送过去。 <code>delSessionByTun</code> 是用来清理用户会话和虚拟网卡。</p><p><code>updateLastTime</code> 用来在客户端发送来心跳包后更新用户最后一次发送心跳包的时间戳，<code>cleanExpireTun</code> 用来清理已经超过一分钟没有发来心跳包的客户端，认为这个客户端已经失去了连接，但是可能因为网络故障等原因没有正常关闭隧道。</p><p><code>auth</code> 则是对客户端发来的数据进行处理，如何客户端发来 <code>b&#39;\x00&#39;</code> 则表明这是一个心跳包，但是如果并不存在这个心跳包源主机的会话，可能因为网络原因服务端清理了这个客户端的会话，就发送 <code>b&#39;r&#39;</code> 告诉客户端重新认证。否则就更新这个会话的最后心跳包的时间戳。客户端在退出的时候会发送 <code>b&#39;e&#39;</code> 到服务端，然后服务端会主动清理这个客户端的会话。最后会匹配数据包是否是认证密码，如果认证成功了就返回 <code>True</code> 程序会继续处理。</p><p><code>run_forever</code> 是整个服务运转的核心了，首先使用一个新线程启动会话清理方法，然后进入事件循环，使用 <code>select</code> 监听 <code>udp</code> 网络套接字和隧道套接字的可读事件，一旦某个套接字有数据过来了 <code>select</code> 则会返回这个套接字对象，然后判断这个套接字是网络套接字还是隧道套接字，如果是网络套接字则首先尝试将数据写入到客户端所在的隧道中，如果数据内容不是一个正确的网络数据包格式或者没有找到这个客户端地址相关联的隧道，就进入异常处理模式，因为新客户端的连接和心跳包导致进入异常处理的频率是比较小的 所以并不会对整体性能照成很大的影响，如果在一开始就进行数据内容判断的话 就非常影响程序的性能了，因为毕竟接收到的大多都是合法的能写入到隧道的数据包。</p><p>接着如果可读对象是一个隧道文件描述符的话，就找到客户端的网络地址，通过 <code>udp</code> 将读取到的数据包发送给客户端，并且如果出现了任何异常的话 就跳过。</p><h4 id="程序执行入口"><a href="#程序执行入口" class="headerlink" title="程序执行入口"></a>程序执行入口</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        Server().run_forever()</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        print(<span class="string">'Closing vpn server ...'</span>)</span><br></pre></td></tr></table></figure><p>创建一个匿名对象并且启动 <code>run_forever</code> 方法。</p><h3 id="客户端程序"><a href="#客户端程序" class="headerlink" title="客户端程序"></a>客户端程序</h3><blockquote><p>客户端就比较简单了，只需要将网络来的数据写入隧道，隧道来的数据通过网络发送出去</p></blockquote><h4 id="导入需要的模块-1"><a href="#导入需要的模块-1" class="headerlink" title="导入需要的模块"></a>导入需要的模块</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> unicode_literals</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> fcntl <span class="keyword">import</span> ioctl</span><br><span class="line"><span class="keyword">from</span> select <span class="keyword">import</span> select</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br></pre></td></tr></table></figure><p>因为需要尽可能的支持更多的Python版本，所以需要使用一些兼容性相关的小技巧。</p><h4 id="定义一些常量-1"><a href="#定义一些常量-1" class="headerlink" title="定义一些常量"></a>定义一些常量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">PASSWORD = <span class="string">b'4fb88ca224e'</span></span><br><span class="line"></span><br><span class="line">MTU = <span class="number">1400</span></span><br><span class="line">BUFFER_SIZE = <span class="number">4096</span></span><br><span class="line">KEEPALIVE = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">TUNSETIFF = <span class="number">0x400454ca</span></span><br><span class="line">IFF_TUN   = <span class="number">0x0001</span></span><br><span class="line">IFF_TAP   = <span class="number">0x0002</span></span><br></pre></td></tr></table></figure><p>同服务端，客户端也需要配置隧道，客户端多了一个 <code>KEEPALIVE</code> 的常量，用来定义多久向服务端发送心跳包。</p><h4 id="创建和启动虚拟网卡-1"><a href="#创建和启动虚拟网卡-1" class="headerlink" title="创建和启动虚拟网卡"></a>创建和启动虚拟网卡</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createTunnel</span><span class="params">(tunName=<span class="string">'tun%d'</span>,tunMode=IFF_TUN)</span>:</span></span><br><span class="line">    tunfd = os.open(<span class="string">"/dev/net/tun"</span>, os.O_RDWR)</span><br><span class="line">    ifn = ioctl(tunfd, TUNSETIFF, struct.pack(<span class="string">b"16sH"</span>, tunName.encode(), tunMode))</span><br><span class="line">    tunName = ifn[:<span class="number">16</span>].decode().strip(<span class="string">"\x00"</span>)</span><br><span class="line">    <span class="keyword">return</span> tunfd,tunName</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">startTunnel</span><span class="params">(tunName, localIP, peerIP)</span>:</span></span><br><span class="line">    os.popen(<span class="string">'ifconfig %s %s dstaddr %s mtu %s up'</span> % </span><br><span class="line">            (tunName, localIP, peerIP, MTU)).read()</span><br></pre></td></tr></table></figure><p><code>startTunnel</code> 有个不同的地方是还需要知道对端（服务端）的隧道IP。</p><h4 id="VPN的核心实现-1"><a href="#VPN的核心实现-1" class="headerlink" title="VPN的核心实现"></a>VPN的核心实现</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Client</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.udp = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">        self.udp.settimeout(<span class="number">5</span>)</span><br><span class="line">        self.to = SERVER_ADDRESS</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">keepalive</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_keepalive</span><span class="params">(udp, to)</span>:</span></span><br><span class="line">            <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">                time.sleep(KEEPALIVE)</span><br><span class="line">                udp.sendto(<span class="string">b'\x00'</span>, to)</span><br><span class="line">        k = Thread(target=_keepalive, args=(self.udp, self.to), name=<span class="string">'keepalive'</span>)</span><br><span class="line">        k.setDaemon(<span class="literal">True</span>)</span><br><span class="line">        k.start()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.udp.sendto(PASSWORD,self.to)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            data,addr = self.udp.recvfrom(BUFFER_SIZE)</span><br><span class="line">            tunfd,tunName = createTunnel()</span><br><span class="line">            localIP,peerIP = data.decode().split(<span class="string">';'</span>)</span><br><span class="line">            print(<span class="string">'Local ip: %s\tPeer ip: %s'</span> % (localIP,peerIP))</span><br><span class="line">            startTunnel(tunName,localIP,peerIP)</span><br><span class="line">            <span class="keyword">return</span> tunfd</span><br><span class="line">        <span class="keyword">except</span> socket.timeout:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_forever</span><span class="params">(self)</span>:</span></span><br><span class="line">        print(<span class="string">'Start connect to server...'</span>)</span><br><span class="line">        tunfd = self.login()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> tunfd:</span><br><span class="line">            print(<span class="string">"Connect failed!"</span>)</span><br><span class="line">            sys.exit(<span class="number">0</span>)</span><br><span class="line">        print(<span class="string">'Connect to server successful'</span>)</span><br><span class="line">        self.keepalive()</span><br><span class="line">        readables = [self.udp, tunfd]</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                readab = select(readables, [], [], <span class="number">10</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">                self.udp.sendto(<span class="string">b'e'</span>, self.to)</span><br><span class="line">                <span class="keyword">raise</span> KeyboardInterrupt</span><br><span class="line">            <span class="keyword">for</span> r <span class="keyword">in</span> readab:</span><br><span class="line">                <span class="keyword">if</span> r == self.udp:</span><br><span class="line">                    data, addr = self.udp.recvfrom(BUFFER_SIZE)</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        os.write(tunfd, data)</span><br><span class="line">                    <span class="keyword">except</span> OSError:</span><br><span class="line">                        <span class="keyword">if</span> data == <span class="string">b'r'</span>:</span><br><span class="line">                            os.close(tunfd)</span><br><span class="line">                            readables.remove(tunfd)</span><br><span class="line">                            print(<span class="string">'Reconnecting...'</span>)</span><br><span class="line">                            tunfd = self.login()</span><br><span class="line">                            readables.append(tunfd)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    data = os.read(tunfd, BUFFER_SIZE)</span><br><span class="line">                    self.udp.sendto(data, self.to)</span><br></pre></td></tr></table></figure><p>和服务端的比较类似，不同的是客户端需要处理的是登陆、从服务端接收到隧道配置信息然后创建和启动隧道和处理服务端发来的 <code>b&#39;r&#39;</code> 重连命令。还会启动一个定期发送心跳包的线程，这个主要是因为在传统的 NAT 模型中，UDP会话可能在短短的几分钟甚至几十秒钟就会被网关设备清理掉，导致VPN隧道断开。而不断地发送心跳包则可以保持网关设备上客户端和服务端的UDP会话。</p><h4 id="程序执行入口-1"><a href="#程序执行入口-1" class="headerlink" title="程序执行入口"></a>程序执行入口</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        SERVER_ADDRESS = (sys.argv[<span class="number">1</span>], int(sys.argv[<span class="number">2</span>]))</span><br><span class="line">        Client().run_forever()</span><br><span class="line">    <span class="keyword">except</span> IndexError:</span><br><span class="line">        print(<span class="string">'Usage: %s [remote_ip] [remote_port]'</span> % sys.argv[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">        print(<span class="string">'Closing vpn client ...'</span>)</span><br></pre></td></tr></table></figure><p>这里通过命令行获取客户端要连接的服务端IP和端口，如果参数出错并给出相应的提示信息。</p><h3 id="运行结果"><a href="#运行结果" class="headerlink" title="运行结果"></a>运行结果</h3><p>在服务端使用Python3运行服务端程序：</p><pre><code>root@ubuntu:~# python3 vpnserver.py Server listen on 0.0.0.0:2003...</code></pre><p>服务正常监听，然后客户端启动客户端程序：</p><pre><code>[root@localhost ~]# python vpnclient.py 192.168.4.233 2003Start connect to server...Local ip: 10.0.0.2    Peer ip: 10.0.0.1Connect to server successful[root@localhost ~]# ifconfig tun0tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00          inet addr:10.0.0.2  P-t-P:10.0.0.1  Mask:255.255.255.255        UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1400  Metric:1        RX packets:0 errors:0 dropped:0 overruns:0 frame:0        TX packets:0 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:500         RX bytes:0 (0.0 b)  TX bytes:0 (0.0 b)</code></pre><p>客户端连接成功后打印出连接信息，并且可以看到多出来一块 <code>tun0</code> 的虚拟网卡。</p><pre><code>root@ubuntu:~# python3 vpnserver.py Server listen on 0.0.0.0:2003...[2018/05/26 13:47:13] from    (192.168.4.6:58502) b&apos;4fb88ca224&apos;Clinet 192.168.4.6:58502 connect successful[2018/05/26 13:47:23] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:47:33] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:47:43] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:47:53] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:48:03] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:48:13] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:48:23] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:48:33] from    (192.168.4.6:58502) b&apos;\x00&apos;[2018/05/26 13:48:43] from    (192.168.4.6:58502) b&apos;\x00&apos;root@ubuntu:~# ifconfig tun0tun0      Link encap:UNSPEC  HWaddr 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00          inet addr:10.0.0.1  P-t-P:10.0.0.2  Mask:255.255.255.255        UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1400  Metric:1        RX packets:0 errors:0 dropped:0 overruns:0 frame:0        TX packets:0 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:500         RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</code></pre><p>可以看到服务端也打印出客户端连接成功的消息，以及打印出每次从客户端发来的数据包信息。同样也有一条到客户端的虚拟网卡。接着尝试服务端是否可以直接PING通客户端了。</p><pre><code>root@ubuntu:~# ping 10.0.0.2 -c 2 PING 10.0.0.2 (10.0.0.2) 56(84) bytes of data.64 bytes from 10.0.0.2: icmp_seq=1 ttl=64 time=0.814 ms64 bytes from 10.0.0.2: icmp_seq=2 ttl=64 time=0.569 ms--- 10.0.0.2 ping statistics ---2 packets transmitted, 2 received, 0% packet loss, time 999msrtt min/avg/max/mdev = 0.569/0.691/0.814/0.125 ms[2018/05/26 13:51:40] to      (192.168.4.6:58502) b&apos;\x00\x00\x08\x00E\x00\x00T\x19\xdd&apos;[2018/05/26 13:51:40] from    (192.168.4.6:58502) b&apos;\x00\x00\x08\x00E\x00\x00T\x99V&apos;[2018/05/26 13:51:41] to      (192.168.4.6:58502) b&apos;\x00\x00\x08\x00E\x00\x00T\x19\xe4&apos;[2018/05/26 13:51:41] from    (192.168.4.6:58502) b&apos;\x00\x00\x08\x00E\x00\x00T\x99W&apos;</code></pre><p>可以看到隧道是正常的，并且服务端打印出了去的两个ICMP包和回来的两个ICMP包，接着关闭客户端程序。</p><pre><code>[2018/05/26 13:54:45] from    (192.168.4.6:58502) b&apos;e&apos;Client 192.168.4.6:58502 is disconnect</code></pre><p>服务端接收到了 <code>b&#39;e&#39;</code> 后打印客户端断开连接的消息，接着发现 <code>tun0</code> 这块虚拟网卡也消失了。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>服务端程序就完成了，但是还是存在非常多的问题，比如用户认证的安全性，<code>select</code> 的性能和支持的最大客户端数量可以使用更好的 <code>epoll</code> 方式，但是 <code>select</code> 的平台兼容性比较强，如果考虑把程序移植到 Windows 的话可以继续使用（不考虑移植到Windows，但是Windows的tap驱动软件是否提供了这种可能？）。客户端断开后重连IP就会改变，如果能给客户端固定IP就好了，以及没法监控每个客户端的流量和控制客户端的速率。服务端应该采用配置文件的方式来更改运行的参数，并且应该能够使用守护进程的方式运行并处理 <code>kill</code> 命令发送的信号，这样这个程序就比较完善了。</p><p>注意：程序中多次出现的 <code>b&#39;e&#39;</code>, <code>b&#39;r&#39;</code> 这样的字符，这只是表示Python中 <code>Byte</code> 类型的数据。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;了解了OpenVPN之后，发现通过一个UDP隧道来打通NAT网络非常有意思，于是就萌发出使用Python来实现一个类似于OpenVPN的隧道，OpenVPN不仅支持UDP协议还支持TCP协议，但是这里并不会像OpenVPN设计的这么复杂完善，只使用简单的UDP协议和密码认证。也通过这个小程序来更深入的学习下Linux网络相关的知识。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/categories/Python/"/>
    
    
      <category term="python" scheme="http://www.yunfwe.cn/tags/python/"/>
    
      <category term="vpn" scheme="http://www.yunfwe.cn/tags/vpn/"/>
    
      <category term="udp" scheme="http://www.yunfwe.cn/tags/udp/"/>
    
  </entry>
  
  <entry>
    <title>愉快的用 Vim 写代码</title>
    <link href="http://www.yunfwe.cn/2018/05/11/2018/%E6%84%89%E5%BF%AB%E7%9A%84%E7%94%A8Vim%E5%86%99%E4%BB%A3%E7%A0%81/"/>
    <id>http://www.yunfwe.cn/2018/05/11/2018/%E6%84%89%E5%BF%AB%E7%9A%84%E7%94%A8Vim%E5%86%99%E4%BB%A3%E7%A0%81/</id>
    <published>2018-05-11T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.871Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Vim 是一款高可定制的文本编辑器软件，而大多数人使用 vim 应该是从 Linux 的教科书里得知的吧。vim 来自于 vi 编辑器，而 vi 在1976年就发布了，经过如此多年的进化，可以说是非常成熟和强大了。但是 vim 的学习曲线比较陡，但是对 vim 学习的越深入，使用 vim 提升的效率就越高。这里是这几天对 vim 的学习，打造出的一款比较得心应手的编程工具。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>在 Ubuntu 16.04 和 Ubuntu 18.04 上测试成功，理论上比较高的 Vim 版本都可以。Mac 没测试环境 ╮(╯▽╰)╭ ，Windows 就用 IDE 了，不想用 IDE 还可以使用 Notepad++ 或者 VScode。Vim 胜在是安装在服务器上的，这样需要远程连接服务器来写代码调试的话就非常方便了。先秀几张效果截图。</p><p><strong>代码补全</strong><br><img src="/uploads/2018/vim/1fsp4b39a33kd72v.jpeg" alt></p><p><strong>文件分屏</strong><br><img src="/uploads/2018/vim/r5utf7qitfk2o807.jpeg" alt></p><p><strong>文件操作</strong><br><img src="/uploads/2018/vim/15t4t2ae954qzzc7.jpeg" alt></p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>自己写的配置已经开源在了 Github 上 <a href="https://github.com/yunfwe/vimconf" target="_blank" rel="noopener">点击浏览</a></p><p>因为安装过程中需要联网安装插件，所以务必保证网络正常，并且已经安装 git 命令行工具。</p><p>输入以下命令安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &lt;(curl -s https://raw.githubusercontent.com/yunfwe/vimconf/master/install.sh)</span><br></pre></td></tr></table></figure></p><p>Vim 的配置被安装到了家目录下的 <code>.vimrc</code> 文件和 <code>.vim</code> 目录，如果安装之前存在着两个目录，脚本将自动备份。如果想卸载也非常简单，手动删除家目录下的 <code>.vimrc</code> 和 <code>.vim</code> 即可，或者执行提供好的卸载脚本也可以：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source &lt;(curl -s https://raw.githubusercontent.com/yunfwe/vimconf/master/uninstall.sh)</span><br></pre></td></tr></table></figure></p><h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>Vim 的配置文件非常强大，是一种专门的 <code>Vim Script</code> 的语言编写，大部分的 Vim 插件也都是用这个语言写的</p><p>这里看看配置文件的内容，以及各内容的说明</p><pre><code>&quot; curl -fLo ~/.vim/autoload/plug.vim --create-dirs https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim&quot; vim -c &quot;PlugInstall&quot; -c &quot;q&quot; -c &quot;q&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 使用plug&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;call plug#begin(&apos;~/.vim/plugged&apos;)Plug &apos;scrooloose/nerdtree&apos;      &quot; 目录树插件Plug &apos;vim-airline/vim-airline&apos;  &quot; 状态栏插件Plug &apos;vim-airline/vim-airline-themes&apos; &quot; 状态栏主题插件Plug &apos;joshdick/onedark.vim&apos;     &quot; 状态栏主题使用的颜色Plug &apos;jiangmiao/auto-pairs&apos;     &quot; 自动补全引号括号Plug &apos;vim-scripts/SuperTab&apos;     &quot; 提高Tab键能力的插件&quot;Plug &apos;vim-scripts/c.vim&apos;        &quot; 官方C语言插件Plug &apos;rkulla/pydiction&apos;         &quot; 轻量级的Python补全插件Plug &apos;luochen1990/rainbow&apos;      &quot; 为不同的括号添加颜色的插件call plug#end()&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</code></pre><p>Vim 的配置文件中，用双引号开头表示注释，是被 Vim 忽略的，Vim 安装插件最简单的方法就是使用插件管理器，但是插件管理器也是 Vim 的一个插件，所以这个插件就需要手动安装了，因此安装脚本的开头就是从 Github 上获取这个插件管理器，然后放到相应的目录中后 先用一个简单的只包含需要安装其他插件指令的配置文件启动 Vim 并安装其他插件。</p><p>插件大多数人都选择直接从 github 上获取，所以插件名就可以不用写 github 的全路径，只需要用户名和仓库名就可以了，Vim 的插件管理器还有非常多的种类，但是 <code>vim-plug</code> 可以并发下载安装插件，比其他种类的更轻，更快。</p><pre><code>&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 实用设置&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;当打开vim且没有文件时自动打开NERDTreeautocmd vimenter * if !argc() | NERDTree | endif&quot; 只剩 NERDTree时自动关闭autocmd bufenter * if (winnr(&quot;$&quot;) == 1 &amp;&amp; exists(&quot;b:NERDTreeType&quot;) &amp;&amp; b:NERDTreeType == &quot;primary&quot;) | q | endifset autoread        &quot; 设置当文件被改动时自动载入if has(&quot;autocmd&quot;)    au BufReadPost * if line(&quot;&apos;\&quot;&quot;) &gt; 1 &amp;&amp; line(&quot;&apos;\&quot;&quot;) &lt;= line(&quot;$&quot;) | exe &quot;normal! g&apos;\&quot;&quot; | endifendif&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 编码设置&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;set langmenu=zh_CN.UTF-8set helplang=cnset termencoding=utf-8set encoding=utf8set fileencodings=utf8,ucs-bom,gbk,cp936,gb2312,gb18030&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 通用设置&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;let mapleader = &quot;,&quot;      &quot; 定义&lt;leader&gt;键set nocompatible         &quot; 设置不兼容原始vi模式filetype on              &quot; 设置开启文件类型侦测filetype plugin on       &quot; 设置加载对应文件类型的插件set noeb                 &quot; 关闭错误的提示syntax enable            &quot; 开启语法高亮功能syntax on                &quot; 自动语法高亮set t_Co=256             &quot; 开启256色支持set cmdheight=1          &quot; 设置命令行的高度set showcmd              &quot; select模式下显示选中的行数set scrolloff=3          &quot; 光标移动到buffer的顶部和底部时保持3行距离 set ruler                &quot; 总是显示光标位置set laststatus=2         &quot; 总是显示状态栏set number               &quot; 开启行号显示set cursorline           &quot; 高亮显示当前行set whichwrap+=&lt;,&gt;,h,l   &quot; 设置光标键跨行set virtualedit=block,onemore   &quot; 允许光标出现在最后一个字符的后面set incsearch            &quot; 实时搜索set mouse-=a             &quot; 不允许使用鼠标操作set noeb vb t_vb=        &quot; 关闭终端响铃&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 代码缩进和排版&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;set autoindent           &quot; 设置自动缩进set cindent              &quot; 设置使用C/C++语言的自动缩进方式set cinoptions=g0,:0,N-s,(0    &quot; 设置C/C++语言的具体缩进方式set smartindent          &quot; 智能的选择对其方式filetype indent on       &quot; 自适应不同语言的智能缩进set expandtab            &quot; 将制表符扩展为空格set tabstop=4            &quot; 设置编辑时制表符占用空格数set shiftwidth=4         &quot; 设置格式化时制表符占用空格数set softtabstop=4        &quot; 设置4个空格为制表符set smarttab             &quot; 在行和段开始处使用制表符&quot;set nowrap               &quot; 禁止折行set wrap                 &quot; 自动折行set iskeyword+=_,$,@,%,#,-  &quot; 带有如下符号的单词不要被换行分割set backspace=2          &quot; 使用回车键正常处理indent,eol,start等&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 代码补全&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;set wildmenu             &quot; vim自身命名行模式智能补全set completeopt-=preview &quot; 补全时不显示窗口，只显示补全列表set matchtime=1          &quot; 匹配括号高亮的时间（单位是十分之一秒）&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 代码折叠&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;set foldmethod=syntax   &quot; 设置基于语法进行代码折叠set nofoldenable        &quot; 关闭折叠代码&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 缓存设置&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;set nobackup            &quot; 设置不备份set noswapfile          &quot; 禁止生成临时文件set autoread            &quot; 文件在vim之外修改过，自动重新读入set autowrite           &quot; 设置自动保存set confirm             &quot; 在处理未保存或只读文件的时候，弹出确认&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</code></pre><p>正如每个配置项的注释所言，这个是对 Vim 编辑器的一些配置。</p><pre><code>&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 新文件标题&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;新建.c,.h,.sh,.java文件，自动插入文件头 autocmd BufNewFile *.cpp,*.[ch],*.sh,*.rb,*.java,*.py exec &quot;:call SetTitle()&quot; &quot;&quot;定义函数SetTitle，自动插入文件头 func SetTitle()     &quot;如果文件类型为.sh文件     if &amp;filetype == &apos;sh&apos;         call setline(1,&quot;\#!/bin/bash&quot;)         call append(line(&quot;.&quot;), &quot;&quot;)     elseif &amp;filetype == &apos;python&apos;        call setline(1,&quot;#!/usr/bin/env python&quot;)        call append(line(&quot;.&quot;),&quot;# -*- coding:utf-8 -*-&quot;)        call append(line(&quot;.&quot;)+1,&quot;# Author: root  date: &quot;.strftime(&quot;%Y-%m-%d&quot;))        call append(line(&quot;.&quot;)+2, &quot;&quot;)         call append(line(&quot;.&quot;)+3, &quot;&quot;)     elseif &amp;filetype == &apos;ruby&apos;        call setline(1,&quot;#!/usr/bin/env ruby&quot;)        call append(line(&quot;.&quot;),&quot;# encoding: utf-8&quot;)        call append(line(&quot;.&quot;)+1, &quot;&quot;)        call append(line(&quot;.&quot;)+2, &quot;&quot;)        &quot;    elseif &amp;filetype == &apos;mkd&apos;        &quot;        call setline(1,&quot;&lt;head&gt;&lt;meta charset=\&quot;UTF-8\&quot;&gt;&lt;/head&gt;&quot;)    else         call setline(1, &quot;/*************************************************************************&quot;)         call append(line(&quot;.&quot;), &quot;    &gt; File Name: &quot;.expand(&quot;%&quot;))         call append(line(&quot;.&quot;)+1, &quot;    &gt; Author: root&quot;)         call append(line(&quot;.&quot;)+2, &quot;    &gt; Mail: root@localhost.com&quot;)         call append(line(&quot;.&quot;)+3, &quot;    &gt; Created Time: &quot;.strftime(&quot;%Y-%m-%d&quot;))         call append(line(&quot;.&quot;)+4, &quot; ************************************************************************/&quot;)         call append(line(&quot;.&quot;)+5, &quot;&quot;)    endif    if expand(&quot;%:e&quot;) == &apos;cpp&apos;        call append(line(&quot;.&quot;)+6, &quot;#include &lt;iostream&gt;&quot;)        call append(line(&quot;.&quot;)+7, &quot;using namespace std;&quot;)        call append(line(&quot;.&quot;)+8, &quot;&quot;)        call append(line(&quot;.&quot;)+9, &quot;&quot;)    endif    if &amp;filetype == &apos;c&apos;        call append(line(&quot;.&quot;)+6, &quot;#include &lt;stdio.h&gt;&quot;)        call append(line(&quot;.&quot;)+7, &quot;&quot;)        call append(line(&quot;.&quot;)+8, &quot;&quot;)    endif    if expand(&quot;%:e&quot;) == &apos;h&apos;        call append(line(&quot;.&quot;)+6, &quot;#ifndef _&quot;.toupper(expand(&quot;%:r&quot;)).&quot;_H&quot;)        call append(line(&quot;.&quot;)+7, &quot;#define _&quot;.toupper(expand(&quot;%:r&quot;)).&quot;_H&quot;)        call append(line(&quot;.&quot;)+8, &quot;#endif&quot;)        call append(line(&quot;.&quot;)+9, &quot;&quot;)    endif    if &amp;filetype == &apos;java&apos;        call append(line(&quot;.&quot;)+6,&quot;public class &quot;.expand(&quot;%:r&quot;))        call append(line(&quot;.&quot;)+7,&quot;&quot;)    endif    &quot;新建文件后，自动定位到文件末尾endfunc autocmd BufNewFile * normal G&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</code></pre><p>这段配置就用到了定义函数，逻辑判断等语法，作用是在 Vim 编辑新文件的时候，根据文件名来自动生成不同的文件头部信息，为了方便，可以把代码中的 <code>Author</code> 和 <code>Mail</code> 配置为自己的信息，这样就不用每次创建了文件之后再修改了。</p><pre><code>&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 键盘命令&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;nnoremap &lt;C-N&gt; :bn&lt;CR&gt;nnoremap &lt;C-P&gt; :bp&lt;CR&gt;nmap &lt;Esc&gt;&lt;Esc&gt;&lt;Esc&gt; :qa!&lt;CR&gt; &quot; 连续三个Esc不保存退出全部&quot; 切换NERDTree map &lt;F3&gt; :NERDTreeToggle&lt;CR&gt;:autocmd BufRead,BufNewFile *.dot map &lt;F5&gt; :w&lt;CR&gt;:!dot -Tjpg -o %&lt;.jpg % &amp;&amp; eog %&lt;.jpg  &lt;CR&gt;&lt;CR&gt; &amp;&amp; exec &quot;redr!&quot;&quot;C，C++ 按F5编译运行map &lt;F5&gt; :call CompileRunGcc()&lt;CR&gt;func! CompileRunGcc()    exec &quot;w&quot;    if &amp;filetype == &apos;c&apos;        &quot;exec &quot;!g++ % -o %&lt;&quot;        &quot;exec &quot;!time ./%&lt;&quot;        exec &quot;!g++ % -o %&lt; &amp;&amp; time ./%&lt;&quot;    elseif &amp;filetype == &apos;cpp&apos;        &quot;exec &quot;!g++ % -std=c++11 -o %&lt;&quot;        &quot;exec &quot;!time ./%&lt;&quot;        exec &quot;!g++ % -std=c++11 -o %&lt; &amp;&amp; time ./%&lt;&quot;    elseif &amp;filetype == &apos;java&apos;         &quot;exec &quot;!javac %&quot;         &quot;exec &quot;!time java %&lt;&quot;        exec &quot;!javac % &amp;&amp; time java %&lt;&quot;    elseif &amp;filetype == &apos;sh&apos;        :!time bash %    elseif &amp;filetype == &apos;python&apos;        exec &quot;!time python %&quot;    elseif &amp;filetype == &apos;html&apos;        exec &quot;!firefox % &amp;&quot;    elseif &amp;filetype == &apos;go&apos;        &quot;        exec &quot;!go build %&lt;&quot;        exec &quot;!time go run %&quot;    elseif &amp;filetype == &apos;mkd&apos;        exec &quot;!~/.vim/markdown.pl % &gt; %.html &amp;&quot;        exec &quot;!firefox %.html &amp;&quot;    endifendfunc&quot;代码调试map &lt;F8&gt; :call Rungdb()&lt;CR&gt;func! Rungdb()    exec &quot;w&quot;    if &amp;filetype == &apos;cpp&apos;        &quot;exec &quot;!g++ % -std=c++11 -g -o %&lt;&quot;        &quot;exec &quot;!gdb ./%&lt;&quot;        exec &quot;!g++ % -std=c++11 -g -o %&lt; &amp;&amp; gdb ./%&lt;&quot;    elseif &amp;filetype == &apos;c&apos;        &quot;exec &quot;!gcc % -g -o %&lt;&quot;        &quot;exec &quot;!gdb ./%&lt;&quot;        exec &quot;!gcc % -g -o %&lt; &amp;&amp; gdb ./%&lt;&quot;    elseif &amp;filetype == &apos;python&apos;        exec &quot;!python -m pdb %&quot;    elseif &amp;filetype == &apos;go&apos;        &quot;exec &quot;!go build -o %&lt; %&quot;        &quot;exec &quot;!gdb ./%&lt;&quot;        exec &quot;!go build -o %&lt; % &amp;&amp; gdb ./%&lt;&quot;    endifendfunc&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</code></pre><p>定义了一些快捷键，比如在同时编辑多个文件时 <code>Ctrl + p</code> 和 <code>Ctrl + n</code> 可以切换到上一个或下一个，连击三次 <code>Esc</code> 会不保存退出全部文件， <code>F3</code> 会切换是否显示文件目录树，<code>F5</code> 编译运行和 <code>F8</code> 调试。还有就是插件自己的快捷键，比如使用 <code>Ctrl + w + w</code> 可以切换窗口，使用 <code>s</code> 或者 <code>i</code> 可以分割窗口。使用 <code>m</code> 可以显示文件操作菜单，这些都是 <code>NERDTree</code> 目录树插件的快捷键，还可以自己按照 Vim 的规则定义一些方便的快捷键。</p><pre><code>&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 主题&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;set background=darklet g:onedark_termcolors=256colorscheme onedark</code></pre><p>这里就是应用了下载的第一个插件的那个主题，感觉非常养眼，不 是没那么毁眼。其中有几个特殊的字符需要特殊的几种字体才能看到，我喜欢用的 <code>Consolas</code> 字体是没问题的。</p><pre><code>&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; 插件配置&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; airlinelet g:airline_theme=&quot;onedark&quot;let g:airline_powerline_fonts = 1let g:airline#extensions#tabline#enabled = 1if !exists(&apos;g:airline_symbols&apos;)    let g:airline_symbols = {}endiflet g:airline_left_sep = &apos;&apos;let g:airline_left_alt_sep = &apos;&apos;let g:airline_right_sep = &apos;&apos;let g:airline_right_alt_sep = &apos;&apos;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; nerdtree&quot;let g:NERDTreeFileExtensionHighlightFullName = 1&quot;let g:NERDTreeExactMatchHighlightFullName = 1&quot;let g:NERDTreePatternMatchHighlightFullName = 1&quot;let g:NERDTreeHighlightFolders = 1          &quot;let g:NERDTreeHighlightFoldersFullName = 1  &quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; pydiction let g:pydiction_location = &apos;~/.vim/plugged/pydiction/complete-dict&apos;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot; rainbowlet g:rainbow_active = 1 &quot;0 if you want to enable it later via :RainbowToggle&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;</code></pre><p>顾名思义，就是针对安装的插件的配置了，不同的插件会读取其中不同的值来产生不同的行为。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>如果体验了和平常不同的 Vim 后对它产生了浓厚的兴趣，那么对 Vim 的使用进行一次深入的学习那就最好不过了。</p><ul><li><a href="http://vimcdoc.sourceforge.net/doc/help.html" target="_blank" rel="noopener">官方中文文档在线</a></li><li><a href="http://vimcdoc.sourceforge.net/" target="_blank" rel="noopener">官方中文文档下载</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Vim 是一款高可定制的文本编辑器软件，而大多数人使用 vim 应该是从 Linux 的教科书里得知的吧。vim 来自于 vi 编辑器，而 vi 在1976年就发布了，经过如此多年的进化，可以说是非常成熟和强大了。但是 vim 的学习曲线比较陡，但是对 vim 学习的越深入，使用 vim 提升的效率就越高。这里是这几天对 vim 的学习，打造出的一款比较得心应手的编程工具。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Vim" scheme="http://www.yunfwe.cn/categories/Vim/"/>
    
    
      <category term="vim" scheme="http://www.yunfwe.cn/tags/vim/"/>
    
      <category term="linux" scheme="http://www.yunfwe.cn/tags/linux/"/>
    
  </entry>
  
  <entry>
    <title>OpenVPN 穿越NAT网络</title>
    <link href="http://www.yunfwe.cn/2018/05/03/2018/OpenVPN%20%E7%A9%BF%E8%B6%8ANAT%E7%BD%91%E7%BB%9C/"/>
    <id>http://www.yunfwe.cn/2018/05/03/2018/OpenVPN%20%E7%A9%BF%E8%B6%8ANAT%E7%BD%91%E7%BB%9C/</id>
    <published>2018-05-03T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>想和朋友联机打局域网游戏，在家需要连接到公司办公，如果是机密信息还要保证数据的加密传输，而且还要简单稳定好用，那么OpenVPN绝对是不二之选，OpenVPN是一个基于OpenSSL库的应用层VPN实现，完全开源免费，而且支持的平台众多，Linux平台，Windows平台，Android和IOS平台也都支持。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>想要连通两个NAT后的网络，比如家里的局域网和公司的局域网就必须存在一个公网IP来做数据中转。这里使用阿里云的一台主机来做数据中转。</p><p>系统使用的是 Ubuntu 16.04.03 64位<br>OpenVPN 使用最新的稳定版 2.3.18 <a href="https://swupdate.openvpn.org/community/releases/openvpn-2.3.18.tar.xz" target="_blank" rel="noopener"><strong>点此下载</strong></a></p><p>如果下载不了，可能需要自备梯子或者从其他地方下载。如果使用的 CentOS 系列安装可能需要先关闭 SElinux。</p><h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>也可以选择直接从官方仓库中下载安装使用。</p><h3 id="解决依赖"><a href="#解决依赖" class="headerlink" title="解决依赖"></a>解决依赖</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt-get install make gcc g++ libssl-dev liblzo2-dev libpam-dev unzip</span><br></pre></td></tr></table></figure><p>这里只适用于 Ubuntu 系统</p><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xf openvpn-2.3.18.tar.xz</span><br><span class="line"><span class="built_in">cd</span> openvpn-2.3.18</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/openvpn</span><br><span class="line">make -j4 &amp;&amp; make install</span><br><span class="line">mkdir /etc/openvpn</span><br><span class="line">cp -rf sample/ /etc/openvpn/    <span class="comment"># 拷贝配置文件模块</span></span><br><span class="line">cp /etc/openvpn/sample/sample-config-files/server.conf /etc/openvpn/</span><br></pre></td></tr></table></figure><p>由于系统环境的复杂，配置过程中可能会缺少某些库的头文件，只需要找到这些头文件所在的包然后安装下就好了。</p><h3 id="配置证书"><a href="#配置证书" class="headerlink" title="配置证书"></a>配置证书</h3><h4 id="服务端证书"><a href="#服务端证书" class="headerlink" title="服务端证书"></a>服务端证书</h4><h5 id="配置easy-rsa"><a href="#配置easy-rsa" class="headerlink" title="配置easy-rsa"></a>配置easy-rsa</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc/openvpn</span><br><span class="line">git <span class="built_in">clone</span> -b release/2.x https://github.com/OpenVPN/easy-rsa.git</span><br><span class="line"><span class="built_in">cd</span> /etc/openvpn/easy-rsa/easy-rsa/2.0</span><br></pre></td></tr></table></figure><p>然后编辑 <code>vars</code> 文件，修改下列内容的值为随意内容。需要注意的是，值不可以是空的。</p><pre><code>export KEY_COUNTRY=&quot;US&quot;export KEY_PROVINCE=&quot;California&quot;export KEY_CITY=&quot;SanFrancisco&quot;export KEY_ORG=&quot;Fort-Funston&quot;export KEY_EMAIL=&quot;me@myhost.mydomain&quot;export KEY_OU=&quot;MyOrganizationalUnit&quot;</code></pre><p>我这里修改为了如下内容</p><pre><code>export KEY_COUNTRY=&quot;CN&quot;export KEY_PROVINCE=&quot;BeiJing&quot;export KEY_CITY=&quot;BeiJing&quot;export KEY_ORG=&quot;wu&quot;export KEY_EMAIL=&quot;admin@localhost.com&quot;export KEY_OU=&quot;openvpn&quot;</code></pre><p>接着修改 <code>export KEY_NAME=&quot;EasyRSA&quot;</code> 这句话，将 <code>EasyRSA</code> 改为自己喜欢的名字，这里就简单的使用 <code>server</code>，修改后就可以保存退出了。</p><h5 id="创建根证书"><a href="#创建根证书" class="headerlink" title="创建根证书"></a>创建根证书</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> vars</span><br><span class="line">./clean-all</span><br><span class="line">./build-ca</span><br></pre></td></tr></table></figure><p>这一步一路的回车就好，因为已经在 <code>vars</code> 文件中配置过了。</p><pre><code>root@ubuntu:/etc/openvpn/easy-rsa/easy-rsa/2.0# ./build-ca Generating a 2048 bit RSA private key............................................................+++..........................+++writing new private key to &apos;ca.key&apos;-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &apos;.&apos;, the field will be left blank.-----Country Name (2 letter code) [CN]:State or Province Name (full name) [BeiJing]:Locality Name (eg, city) [BeiJing]:Organization Name (eg, company) [wu]:Organizational Unit Name (eg, section) [openvpn]:Common Name (eg, your name or your server&apos;s hostname) [wu CA]:Name [server]:Email Address [admin@localhost.com]:</code></pre><h5 id="颁发服务端证书"><a href="#颁发服务端证书" class="headerlink" title="颁发服务端证书"></a>颁发服务端证书</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-key-server server</span><br></pre></td></tr></table></figure><p>这个 <code>server</code> 就是刚才 <code>export KEY_NAME=&quot;EasyRSA&quot;</code> 中指定的名字。之后就是一路的回车，当遇到两个问答的时候都回答 <code>y</code> 就可以了。</p><pre><code>root@ubuntu:/etc/openvpn/easy-rsa/easy-rsa/2.0# ./build-key-server serverGenerating a 2048 bit RSA private key.......................+++..............+++writing new private key to &apos;server.key&apos;-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &apos;.&apos;, the field will be left blank.-----Country Name (2 letter code) [CN]:State or Province Name (full name) [BeiJing]:Locality Name (eg, city) [BeiJing]:Organization Name (eg, company) [wu]:Organizational Unit Name (eg, section) [openvpn]:Common Name (eg, your name or your server&apos;s hostname) [server]:Name [server]:Email Address [admin@localhost.com]:Please enter the following &apos;extra&apos; attributesto be sent with your certificate requestA challenge password []:An optional company name []:Using configuration from /etc/openvpn/easy-rsa/easy-rsa/2.0/openssl-1.0.0.cnfCheck that the request matches the signatureSignature okThe Subject&apos;s Distinguished Name is as followscountryName           :PRINTABLE:&apos;CN&apos;stateOrProvinceName   :PRINTABLE:&apos;BeiJing&apos;localityName          :PRINTABLE:&apos;BeiJing&apos;organizationName      :PRINTABLE:&apos;wu&apos;organizationalUnitName:PRINTABLE:&apos;openvpn&apos;commonName            :PRINTABLE:&apos;server&apos;name                  :PRINTABLE:&apos;server&apos;emailAddress          :IA5STRING:&apos;admin@localhost.com&apos;Certificate is to be certified until Apr 30 07:50:21 2028 GMT (3650 days)Sign the certificate? [y/n]:y1 out of 1 certificate requests certified, commit? [y/n]yWrite out database with 1 new entriesData Base Updated</code></pre><h5 id="生成Diffie-Hellman文件"><a href="#生成Diffie-Hellman文件" class="headerlink" title="生成Diffie-Hellman文件"></a>生成Diffie-Hellman文件</h5><blockquote><p>Diffie-Hellman是一种确保共享KEY安全穿越不安全网络的方法</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./build-dh</span><br><span class="line">/usr/<span class="built_in">local</span>/openvpn/sbin/openvpn --genkey --secret keys/ta.key</span><br></pre></td></tr></table></figure><p>这一步需要的时间会长一些。</p><h4 id="客户端证书"><a href="#客户端证书" class="headerlink" title="客户端证书"></a>客户端证书</h4><h5 id="颁发客户端证书"><a href="#颁发客户端证书" class="headerlink" title="颁发客户端证书"></a>颁发客户端证书</h5><p>使用 <code>build-key</code> 命令可以颁发一个不带密码的证书，如果需要带密码保护的证书，可以使用 <code>build-key-pass</code> 命令。这里使用不带密码的凭证，证书名为 <code>client1</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./build-key client1</span><br></pre></td></tr></table></figure><p>同理 一路回车后最后两个问答输入 <code>y</code></p><pre><code>root@ubuntu:/etc/openvpn/easy-rsa/easy-rsa/2.0# ./build-key client1Generating a 2048 bit RSA private key....................+++..............................+++writing new private key to &apos;client1.key&apos;-----You are about to be asked to enter information that will be incorporatedinto your certificate request.What you are about to enter is what is called a Distinguished Name or a DN.There are quite a few fields but you can leave some blankFor some fields there will be a default value,If you enter &apos;.&apos;, the field will be left blank.-----Country Name (2 letter code) [CN]:State or Province Name (full name) [BeiJing]:Locality Name (eg, city) [BeiJing]:Organization Name (eg, company) [wu]:Organizational Unit Name (eg, section) [openvpn]:Common Name (eg, your name or your server&apos;s hostname) [client1]:Name [server]:Email Address [admin@localhost.com]:Please enter the following &apos;extra&apos; attributesto be sent with your certificate requestA challenge password []:An optional company name []:Using configuration from /etc/openvpn/easy-rsa/easy-rsa/2.0/openssl-1.0.0.cnfCheck that the request matches the signatureSignature okThe Subject&apos;s Distinguished Name is as followscountryName           :PRINTABLE:&apos;CN&apos;stateOrProvinceName   :PRINTABLE:&apos;BeiJing&apos;localityName          :PRINTABLE:&apos;BeiJing&apos;organizationName      :PRINTABLE:&apos;wu&apos;organizationalUnitName:PRINTABLE:&apos;openvpn&apos;commonName            :PRINTABLE:&apos;client1&apos;name                  :PRINTABLE:&apos;server&apos;emailAddress          :IA5STRING:&apos;admin@localhost.com&apos;Certificate is to be certified until Apr 30 07:58:09 2028 GMT (3650 days)Sign the certificate? [y/n]:y1 out of 1 certificate requests certified, commit? [y/n]yWrite out database with 1 new entriesData Base Updated</code></pre><h4 id="安置证书"><a href="#安置证书" class="headerlink" title="安置证书"></a>安置证书</h4><p>现在所有的证书都在 <code>keys</code> 目录中，为了方便使用，将 <code>keys</code> 目录直接软链到 <code>/etc/openvpn/</code> 下 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s /etc/openvpn/easy-rsa/easy-rsa/2.0/keys/ /etc/openvpn/keys</span><br></pre></td></tr></table></figure><p>到这里，安装的部分就结束了。</p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h3><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>编辑服务端配置文件：<code>/etc/openvpn/server.conf</code> 修改内容如下：</p><pre><code>port 2001proto udpdev tunca keys/ca.crtcert keys/server.crtkey keys/server.key  dh keys/dh2048.pemserver 10.0.0.0 255.255.255.0ifconfig-pool-persist ipp.txtpush &quot;route 10.0.0.0 255.255.255.0&quot;client-to-clientkeepalive 10 120tls-auth keys/ta.key 0 cipher AES-256-CBCauth SHA256key-direction 0user nobodygroup nogrouppersist-keypersist-tunstatus openvpn-status.logverb 3</code></pre><p>需要注意的是，这里使用 udp 的 2001 端口，在阿里云等环境，还需要配置相应的安全组策略来开放这个端口的流量。</p><h4 id="Linux配置"><a href="#Linux配置" class="headerlink" title="Linux配置"></a>Linux配置</h4><p>开启 Linux 的内核转发功能，编辑 <code>/etc/sysctl.conf</code> 文件，取消掉 <code>#net.ipv4.ip_forward=1</code> 之前的注释。然后执行 <code>sysctl -p</code> 命令。</p><pre><code>root@ubuntu:/etc/openvpn# sysctl -pnet.ipv4.ip_forward = 1vm.swappiness = 0net.ipv4.neigh.default.gc_stale_time = 120net.ipv4.conf.all.rp_filter = 0net.ipv4.conf.default.rp_filter = 0net.ipv4.conf.default.arp_announce = 2net.ipv4.conf.lo.arp_announce = 2net.ipv4.conf.all.arp_announce = 2net.ipv4.tcp_max_tw_buckets = 5000net.ipv4.tcp_syncookies = 1net.ipv4.tcp_max_syn_backlog = 1024net.ipv4.tcp_synack_retries = 2net.ipv6.conf.all.disable_ipv6 = 1net.ipv6.conf.default.disable_ipv6 = 1net.ipv6.conf.lo.disable_ipv6 = 1</code></pre><p>还需要确保 iptable 的 <code>FORWARD</code> 链允许数据转发</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -P FORWARD ACCEPT</span><br></pre></td></tr></table></figure><h4 id="启动OpenVPN"><a href="#启动OpenVPN" class="headerlink" title="启动OpenVPN"></a>启动OpenVPN</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/openvpn/sbin/openvpn --<span class="built_in">cd</span> /etc/openvpn/ --config /etc/openvpn/server.conf</span><br></pre></td></tr></table></figure><p>以调试模式启动 OpenVPN，如果启动过程中有什么错误的话会显示在输出里，确定没有问题了，可以添加 <code>--daemon</code> 参数在后台运行 OpenVPN</p><pre><code>root@ubuntu:/etc/openvpn# /usr/local/openvpn/sbin/openvpn --cd /etc/openvpn/ --config /etc/openvpn/server.conf Thu May  3 16:32:55 2018 OpenVPN 2.3.18 x86_64-unknown-linux-gnu [SSL (OpenSSL)] [LZO] [EPOLL] [MH] [IPv6] built on May  3 2018Thu May  3 16:32:55 2018 library versions: OpenSSL 1.0.2g  1 Mar 2016, LZO 2.08Thu May  3 16:32:55 2018 Diffie-Hellman initialized with 2048 bit keyThu May  3 16:32:55 2018 Control Channel Authentication: using &apos;keys/ta.key&apos; as a OpenVPN static key fileThu May  3 16:32:55 2018 Outgoing Control Channel Authentication: Using 160 bit message hash &apos;SHA1&apos; for HMAC authenticationThu May  3 16:32:55 2018 Incoming Control Channel Authentication: Using 160 bit message hash &apos;SHA1&apos; for HMAC authenticationThu May  3 16:32:55 2018 Socket Buffers: R=[212992-&gt;212992] S=[212992-&gt;212992]Thu May  3 16:32:55 2018 ROUTE_GATEWAY 172.31.143.253/255.255.240.0 IFACE=eth0 HWADDR=00:16:3e:08:fb:5fThu May  3 16:32:55 2018 TUN/TAP device tun0 openedThu May  3 16:32:55 2018 TUN/TAP TX queue length set to 100Thu May  3 16:32:55 2018 do_ifconfig, tt-&gt;ipv6=0, tt-&gt;did_ifconfig_ipv6_setup=0Thu May  3 16:32:55 2018 /sbin/ifconfig tun0 10.0.0.1 pointopoint 10.0.0.2 mtu 1500Thu May  3 16:32:55 2018 /sbin/route add -net 10.0.0.0 netmask 255.255.255.0 gw 10.0.0.2Thu May  3 16:32:55 2018 GID set to nogroupThu May  3 16:32:55 2018 UID set to nobodyThu May  3 16:32:55 2018 UDPv4 link local (bound): [undef]Thu May  3 16:32:55 2018 UDPv4 link remote: [undef]Thu May  3 16:32:55 2018 MULTI: multi_init called, r=256 v=256Thu May  3 16:32:55 2018 IFCONFIG POOL: base=10.0.0.4 size=62, ipv6=0Thu May  3 16:32:55 2018 IFCONFIG POOL LISTThu May  3 16:32:55 2018 Initialization Sequence Completed</code></pre><p>使用 <code>ifconfig</code> 命令，应该可以看到多出来了一块 <code>tun0</code> 的网卡。</p><h4 id="制作客户端ovpn文件"><a href="#制作客户端ovpn文件" class="headerlink" title="制作客户端ovpn文件"></a>制作客户端ovpn文件</h4><p>为了方便客户端的连接，可以在服务端制作好客户端的配置文件，只需将文件下发给客户端，就可以直接使用了。这个文件的拓展名是 ovpn </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/openvpn/</span><br><span class="line">mkdir make_clients</span><br><span class="line">cp sample/sample-config-files/client.conf make_clients/</span><br><span class="line">cd make_clients</span><br></pre></td></tr></table></figure><p>然后编辑 <code>client.conf</code> 为以下内容，其中连接服务器的 IP 需要修改为自己的。</p><pre><code>clientdev tunproto udpremote 47.xxx.xxx.155 2001resolv-retry infinitenobinduser nobodygroup nogrouppersist-keypersist-tunremote-cert-tls servercipher AES-256-CBCauth SHA256key-direction 1verb 3explicit-exit-notify 1</code></pre><p>还记得刚才颁发的客户端证书 <code>client1</code> 吧，先为这个证书生成一份配置文件。使用一个自动化脚本来完成配置文件的创建。新建 <code>make_config.sh</code> 脚本，然后写入如下内容</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># First argument: Client identifier</span></span><br><span class="line"></span><br><span class="line">KEY_DIR=/etc/openvpn/keys</span><br><span class="line">OUTPUT_DIR=./files</span><br><span class="line">BASE_CONFIG=./client.conf</span><br><span class="line"></span><br><span class="line">cat <span class="variable">$&#123;BASE_CONFIG&#125;</span> \</span><br><span class="line">    &lt;(<span class="built_in">echo</span> -e <span class="string">'&lt;ca&gt;'</span>) \</span><br><span class="line">    <span class="variable">$&#123;KEY_DIR&#125;</span>/ca.crt \</span><br><span class="line">    &lt;(<span class="built_in">echo</span> -e <span class="string">'&lt;/ca&gt;\n&lt;cert&gt;'</span>) \</span><br><span class="line">    <span class="variable">$&#123;KEY_DIR&#125;</span>/<span class="variable">$&#123;1&#125;</span>.crt \</span><br><span class="line">    &lt;(<span class="built_in">echo</span> -e <span class="string">'&lt;/cert&gt;\n&lt;key&gt;'</span>) \</span><br><span class="line">    <span class="variable">$&#123;KEY_DIR&#125;</span>/<span class="variable">$&#123;1&#125;</span>.key \</span><br><span class="line">    &lt;(<span class="built_in">echo</span> -e <span class="string">'&lt;/key&gt;\n&lt;tls-auth&gt;'</span>) \</span><br><span class="line">    <span class="variable">$&#123;KEY_DIR&#125;</span>/ta.key \</span><br><span class="line">    &lt;(<span class="built_in">echo</span> -e <span class="string">'&lt;/tls-auth&gt;'</span>) \</span><br><span class="line">    &gt; <span class="variable">$&#123;OUTPUT_DIR&#125;</span>/<span class="variable">$&#123;1&#125;</span>.ovpn</span><br></pre></td></tr></table></figure><p>开始创建</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">chmod +x make_config.sh</span><br><span class="line">mkdir files</span><br><span class="line">./make_config.sh client1</span><br></pre></td></tr></table></figure><p>这个 <code>client1</code> 就是用户证书的名字，也只有存在才可以创建成功。脚本正常执行后可以在 <code>files</code> 目录中看到 <code>client1.ovpn</code> 文件，这个文件中已经包含了客户端所需要的密钥以及连接信息，所以只需要将这个文件发给用户，然后在客户端上导入就可以直接连接了。不过要注意，基于密钥的认证方式，每个密钥只允许同时一台机器连接使用。</p><h3 id="客户端连接"><a href="#客户端连接" class="headerlink" title="客户端连接"></a>客户端连接</h3><p>首先需要将生成的 ovpn 文件发送给用户的机器上，然后还需要安装适合当前平台的客户端。</p><h4 id="在-Linux-上登陆-OpenVPN"><a href="#在-Linux-上登陆-OpenVPN" class="headerlink" title="在 Linux 上登陆 OpenVPN"></a>在 Linux 上登陆 OpenVPN</h4><p>Linux上编译出的 <code>openvpn</code> 程序既可以是服务端，也可以是客户端，所以只需要再下载下来源码包编译一次就可以了。连接也非常方便，直接使用 <code>openvpn --config client1.ovpn</code> 即可。如果想后台运行，也只需要添加 <code>--daemon</code> 参数。</p><p>当连接成功后，可以看到多出来一块 <code>tun0</code> 的网卡</p><pre><code>tun0: flags=4305&lt;UP,POINTOPOINT,RUNNING,NOARP,MULTICAST&gt;  mtu 1500        inet 10.0.0.6  netmask 255.255.255.255  destination 10.0.0.5        inet6 fe80::bf9f:2316:1d8c:83d1  prefixlen 64  scopeid 0x20&lt;link&gt;        unspec 00-00-00-00-00-00-00-00-00-00-00-00-00-00-00-00  txqueuelen 100  (UNSPEC)        RX packets 1  bytes 84 (84.0 B)        RX errors 0  dropped 0  overruns 0  frame 0        TX packets 5  bytes 276 (276.0 B)        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</code></pre><p>服务端IP为 <code>10.0.0.1</code>，可以看看能不能PING通</p><pre><code>root@raspberrypi:~# ping 10.0.0.1 -c 4PING 10.0.0.1 (10.0.0.1) 56(84) bytes of data.64 bytes from 10.0.0.1: icmp_seq=1 ttl=64 time=62.2 ms64 bytes from 10.0.0.1: icmp_seq=2 ttl=64 time=61.7 ms64 bytes from 10.0.0.1: icmp_seq=3 ttl=64 time=68.1 ms64 bytes from 10.0.0.1: icmp_seq=4 ttl=64 time=68.1 ms--- 10.0.0.1 ping statistics ---4 packets transmitted, 4 received, 0% packet loss, time 3005msrtt min/avg/max/mdev = 61.782/65.097/68.185/3.103 ms</code></pre><h4 id="在-Windows-上登陆-OpenVPN"><a href="#在-Windows-上登陆-OpenVPN" class="headerlink" title="在 Windows 上登陆 OpenVPN"></a>在 Windows 上登陆 OpenVPN</h4><p>Windows 客户端需要在官方下载，下载时可能需要自备梯子，下载地址：<a href="https://openvpn.net/index.php/open-source/downloads.html" target="_blank" rel="noopener">点此打开</a></p><p>下载安装成功后，第一次打开会弹出一个窗口，说没有可以读取的配置文件，这时候只需右击系统状态栏里OpenVPN的小图标，然后选择 <code>Import file...</code> 打开刚才生成的 <code>client1.ovpn</code> 就可以了。然后再次右击小图标，点击 <code>Connect</code>，等弹出的窗口自动退出口，系统也会通知 OpenVPN 是否连接成功。</p><p>在 Windows 上也是可以PING通服务器的</p><pre><code>C:\Users\yunfwe\Desktop&gt;ping 10.0.0.1正在 Ping 10.0.0.1 具有 32 字节的数据:来自 10.0.0.1 的回复: 字节=32 时间=68ms TTL=64来自 10.0.0.1 的回复: 字节=32 时间=71ms TTL=64来自 10.0.0.1 的回复: 字节=32 时间=62ms TTL=64来自 10.0.0.1 的回复: 字节=32 时间=60ms TTL=6410.0.0.1 的 Ping 统计信息:    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，往返行程的估计时间(以毫秒为单位):    最短 = 60ms，最长 = 71ms，平均 = 65ms</code></pre><h4 id="在-Android-上登陆-OpenVPN"><a href="#在-Android-上登陆-OpenVPN" class="headerlink" title="在 Android 上登陆 OpenVPN"></a>在 Android 上登陆 OpenVPN</h4><p>在谷歌应用商店里可以找到一款名为 <code>openvpn-connect</code> 的apk，使用这个软件也可以通过导入ovpn文件的方式连接到服务器。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;想和朋友联机打局域网游戏，在家需要连接到公司办公，如果是机密信息还要保证数据的加密传输，而且还要简单稳定好用，那么OpenVPN绝对是不二之选，OpenVPN是一个基于OpenSSL库的应用层VPN实现，完全开源免费，而且支持的平台众多，Linux平台，Windows平台，Android和IOS平台也都支持。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="OpenVPN" scheme="http://www.yunfwe.cn/categories/OpenVPN/"/>
    
    
      <category term="openvpn" scheme="http://www.yunfwe.cn/tags/openvpn/"/>
    
  </entry>
  
  <entry>
    <title>ESP8266 WiFi开发板</title>
    <link href="http://www.yunfwe.cn/2018/04/29/2018/ESP8266%20WiFi%E5%BC%80%E5%8F%91%E6%9D%BF/"/>
    <id>http://www.yunfwe.cn/2018/04/29/2018/ESP8266%20WiFi%E5%BC%80%E5%8F%91%E6%9D%BF/</id>
    <published>2018-04-29T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>ESP8266串口WIFI模块，超低成本（只需10RMB左右）的物联网开发板，而且有非常丰富的引脚，超低的功耗。ESP8266内部有一个完整的 32bit MCU 核心，主频支持80Mz和160Mz。这个模块支持 IEEE802.11 b/g/n 协议，完整的 TCP/IP 协议栈，可以为现有的设备添加联网功能。而且除了C语言，还可以使用 Python, JavaScript, Lua脚本语言来为ESP8266写程序，极大降低了学习ESP8266的门槛。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>在 Win10 下进行开发，因为更熟悉 Python 所以使用 MicroPython 来进行开发。</p><h3 id="硬件"><a href="#硬件" class="headerlink" title="硬件"></a>硬件</h3><ul><li><strong>ESP8266开发板</strong> 这里使用基于 ESP8266-12F 的 D1 WiFi UNO R3 开发板。</li><li><strong>数据线</strong> 普通安卓的数据线就可以，D1 开发板集成了 CH340 USB转TTL芯片。</li></ul><p>如果是其他系统的话，需要确保 CH340 的驱动有安装。</p><p><strong>D1 WiFi UNO R3</strong> 开发板：<br><img src="/uploads/2018/esp8266/kl8hd3a.jpg" alt></p><h3 id="软件"><a href="#软件" class="headerlink" title="软件"></a>软件</h3><ul><li><strong>esptool</strong> 固件烧录工具</li><li><strong>PuTTY</strong> 串口连接工具</li><li><strong>esp8266 MicroPython固件</strong> <a href="http://micropython.org/resources/firmware/esp8266-20171101-v1.9.3.bin" target="_blank" rel="noopener">点此下载</a></li></ul><h3 id="烧录固件"><a href="#烧录固件" class="headerlink" title="烧录固件"></a>烧录固件</h3><p>esptool 需要Python运行环境的支持，所以需要提前安装 Python 然后配置好环境变量，或者也可以下载其他的固件烧写工具。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install esptool</span><br></pre></td></tr></table></figure><p>装好之后从设备管理器中查看端口，如果是linux环境，应该是 <code>/dev/ttyUSB*</code>，然后先使用 <code>esptool.py</code> 命令擦除固件数据。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esptool.py --port COM4 erase_flash</span><br></pre></td></tr></table></figure><pre><code>esptool.py v2.3.1Connecting....Detecting chip type... ESP8266Chip is ESP8266EXFeatures: WiFiUploading stub...Running stub...Stub running...Erasing flash (this may take a while)...Chip erase completed successfully in 9.7sHard resetting via RTS pin...</code></pre><p>接着就可以将下载好的固件文件烧录到板子里了，固件的bin文件要选择实际的文件。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">esptool.py --port COM4 --baud 460800 write_flash --flash_size=detect 0 esp8266.bin</span><br></pre></td></tr></table></figure><pre><code>esptool.py v2.3.1Connecting....Detecting chip type... ESP8266Chip is ESP8266EXFeatures: WiFiUploading stub...Running stub...Stub running...Changing baud rate to 460800Changed.Configuring flash size...Auto-detected Flash size: 4MBFlash params set to 0x0040Compressed 600888 bytes to 392073...Wrote 600888 bytes (392073 compressed) at 0x00000000 in 8.8 seconds (effective 546.1 kbit/s)...Hash of data verified.Leaving...Hard resetting via RTS pin...</code></pre><p>烧录成功后就可以打开PuTTY，设置好COM口，波特率 115200 然后连接了。</p><pre><code>[开头这里乱码正常]#4 ets_task(40100130, 3, 3fff837c, 4)OSError: [Errno 2] ENOENTMicroPython v1.9.3-8-g63826ac5c on 2017-11-01; ESP module with ESP8266Type &quot;help()&quot; for more information.&gt;&gt;&gt;</code></pre><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="MicroPython"><a href="#MicroPython" class="headerlink" title="MicroPython"></a>MicroPython</h3><blockquote><p>通过 MicroPython 的使用一些代码来认识下 ESP8266 的硬件</p></blockquote><h4 id="MicroPython-简单认识"><a href="#MicroPython-简单认识" class="headerlink" title="MicroPython 简单认识"></a>MicroPython 简单认识</h4><p>MicroPython 使用Python3的语法，使用 <code>help(&#39;modules&#39;)</code> 命令可以看到支持的所有模块，</p><pre><code>&gt;&gt;&gt; help(&apos;modules&apos;)__main__          http_client_ssl   sys               urandom_boot             http_server       time              ure_onewire          http_server_ssl   uasyncio/__init__ urequests_webrepl          inisetup          uasyncio/core     urllib/urequestapa102            json              ubinascii         uselectarray             lwip              ucollections      usocketbtree             machine           uctypes           usslbuiltins          math              uerrno            ustructdht               micropython       uhashlib          utimeds18x20           neopixel          uheapq            utimeqerrno             network           uio               uzlibesp               ntptime           ujson             webreplexample_pub_button                  onewire           umqtt/robust      webrepl_setupexample_sub_led   os                umqtt/simple      websocketflashbdev         port_diag         uos               websocket_helperframebuf          select            upipgc                socket            upip_utarfilehttp_client       ssd1306           upyshPlus any modules on the filesystem&gt;&gt;&gt;</code></pre><p>其中跟板子硬件相关的模块主要是 <code>esp</code> 和 <code>machine</code>，其他大多就是与网络有关的模块了，可以看出来还是比较丰富的。<br>简单的测试了下，对Python3的语法支持还是比较完善的，除了基本的数据类型和语法甚至 lambda表达式、列表解析、装饰器、生成器也都支持。</p><p>具体使用查看 <a href="http://docs.micropython.org/en/latest/pyboard/index.html" target="_blank" rel="noopener">MicroPython官方文档</a></p><h4 id="查看资源信息"><a href="#查看资源信息" class="headerlink" title="查看资源信息"></a>查看资源信息</h4><p>内存信息可以使用 <code>micropython.mem_info()</code> 获取</p><pre><code>&gt;&gt;&gt; import micropython&gt;&gt;&gt; micropython.mem_info()stack: 2112 out of 8192GC: total: 35968, used: 9744, free: 26224No. of 1-blocks: 48, 2-blocks: 24, max blk sz: 264, max free sz: 1132</code></pre><p>8K的栈，35K的堆。。。不过这资源对于它也是够了。</p><p>Flash大小可以使用 <code>esp.flash_size()</code> 获取</p><pre><code>&gt;&gt;&gt; import esp&gt;&gt;&gt; str(esp.flash_size()/1024/1024) + &apos; MB&apos;&apos;4.0 MB&apos;</code></pre><p>4MB的存储空间，除去系统占用的只是存放一些简单的程序脚本也完全够用了。</p><h4 id="测试MCU的速度"><a href="#测试MCU的速度" class="headerlink" title="测试MCU的速度"></a>测试MCU的速度</h4><p>ESP8266内置的MCU主频支持80MHz和160MHz，那么测试下这样的速度到底有多快呢。</p><p>在终端使用 <code>Ctrl + e</code> 进入代码粘贴模式，然后 <code>Ctrl + d</code> 提交或者 <code>Ctrl + c</code> 取消，然后键入以下代码。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> machine</span><br><span class="line"><span class="keyword">import</span> micropython</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">toTime</span><span class="params">(tus)</span>:</span></span><br><span class="line">    ts = [<span class="string">' us'</span>, <span class="string">' ms'</span>, <span class="string">' s'</span>]</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> ts:</span><br><span class="line">        <span class="keyword">if</span> tus &lt; <span class="number">1000</span>:<span class="keyword">return</span> str(tus)+t</span><br><span class="line">        tus = tus / <span class="number">1000</span></span><br><span class="line">    </span><br><span class="line"><span class="meta">@micropython.native</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(count)</span>:</span></span><br><span class="line">    t1 = time.ticks_us()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(count):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    t2 = time.ticks_us()-t1</span><br><span class="line">    print(<span class="string">'Loop %s times for %s'</span>%(count, toTime(t2)))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop_start</span><span class="params">(count=<span class="number">10000</span>)</span>:</span></span><br><span class="line">    cur_freq = machine.freq()</span><br><span class="line">    machine.freq(<span class="number">80000000</span>)</span><br><span class="line">    freq = <span class="keyword">lambda</span> :str(int(machine.freq()/<span class="number">1000000</span>))</span><br><span class="line">    print(<span class="string">'Present freq: %sMHz'</span> % freq())</span><br><span class="line">    loop(count)</span><br><span class="line">    machine.freq(<span class="number">160000000</span>)</span><br><span class="line">    print(<span class="string">'Present freq: %sMHz'</span> % freq())</span><br><span class="line">    loop(count)</span><br><span class="line">    machine.freq(cur_freq)</span><br></pre></td></tr></table></figure><pre><code>&gt;&gt;&gt; loop_start()Present freq: 80MHzLoop 10000 times for 30.567 msPresent freq: 160MHzLoop 10000 times for 15.299 ms&gt;&gt;&gt;</code></pre><p>代码提交后调用 <code>loop_start()</code> 方法，可以看到在默认的 80MHz 下和调节到 160MHz 下的空循环10000次需要多长时间，差不多每次循环使用不到16微妙。其中 <code>micropython.native</code> 装饰器能让代码以机器码的速度运行，如果好奇的话可以试试没有这个装饰器的执行速度。</p><p>将板子重启后，修改代码去掉那个加速的装饰器，然后重新提交代码执行测试（重启后可能得退出PuTTY后重连才能操作），可以看到速度慢了十几倍。</p><pre><code>&gt;&gt;&gt; loop_start()Present freq: 80MHzLoop 10000 times for 460.035 msPresent freq: 160MHzLoop 10000 times for 230.091 ms&gt;&gt;&gt;</code></pre><h3 id="网络功能"><a href="#网络功能" class="headerlink" title="网络功能"></a>网络功能</h3><blockquote><p>既然它是WiFi开发板，那么最大的特点应该是可以接入WiFi网络，并且通过网络和其他设备交换数据。</p></blockquote><h4 id="连接WiFi"><a href="#连接WiFi" class="headerlink" title="连接WiFi"></a>连接WiFi</h4><p>终端执行 <code>help()</code> 函数会显示一个基础的连接WiFi的方法，现在就来连接到一个WiFi试试。这里为了测试方便，用笔记本开了个热点给开发板用。</p><p>ESP8266跟连接WiFi相关的库是 <code>network</code> 库，先来看看这个库的使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> network</span><br><span class="line"></span><br><span class="line">wlan = network.WLAN(network.STA_IF) <span class="comment"># 创建一个WiFi对象</span></span><br><span class="line">wlan.active(<span class="literal">True</span>)       <span class="comment"># 激活接口</span></span><br><span class="line">wlan.scan()             <span class="comment"># 扫描目标</span></span><br><span class="line">wlan.isconnected()      <span class="comment"># 检查是否已经连接</span></span><br><span class="line">wlan.connect(<span class="string">'zhzz'</span>, <span class="string">'12365470'</span>) <span class="comment"># 连接到WiFi</span></span><br><span class="line">wlan.config(<span class="string">'mac'</span>)      <span class="comment"># 获取接口的mac地址</span></span><br><span class="line">wlan.ifconfig()         <span class="comment"># 获取接口的IP/掩码/网关/DNS信息</span></span><br></pre></td></tr></table></figure><p>ESP8266如果断线会自动重连，<code>ifconfig()</code> 方法不仅可以查看当前IP，还可以配置静态IP，只需要将 <code>IP/netmask/gw/DNS</code> 作为一个元组或列表传入即可。比如:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wlan.ifconfig((&apos;192.168.137.2&apos;,&apos;255.255.255.0&apos;,&apos;192.168.137.1&apos;,&apos;119.29.29.29&apos;))</span><br></pre></td></tr></table></figure><p>修改后会立即生效，如果在 <code>wlan.connect()</code> 之前就配置好了静态IP，这样就不会再向路由器发起DHCP请求了。</p><pre><code>C:\Users\yunfwe\Desktop&gt;ping 192.168.137.2正在 Ping 192.168.137.2 具有 32 字节的数据:来自 192.168.137.2 的回复: 字节=32 时间=1ms TTL=255来自 192.168.137.2 的回复: 字节=32 时间=3ms TTL=255来自 192.168.137.2 的回复: 字节=32 时间=1ms TTL=255来自 192.168.137.2 的回复: 字节=32 时间=1ms TTL=255192.168.137.2 的 Ping 统计信息:    数据包: 已发送 = 4，已接收 = 4，丢失 = 0 (0% 丢失)，往返行程的估计时间(以毫秒为单位):    最短 = 1ms，最长 = 3ms，平均 = 1ms</code></pre><p>只要连接WiFi成功后，再次重启开发板也会自动连接，不过配置的静态IP就丢失了，需要重新配置。如果不想让开发板在启动的时候自动连接WiFi，可以在使用后执行 <code>wlan.active(False)</code>。但是开发板还是保存了WiFi的连接信息，想彻底清除这个连接信息可以执行 <code>wlan.connect(&#39;&#39;,&#39;&#39;)</code>。</p><p>如果想看到更多的连接细节，可以启用系统的调式功能</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> esp</span><br><span class="line">esp.osdebug(<span class="number">0</span>)      <span class="comment"># 将调试信息重定向到UART(0)</span></span><br><span class="line">esp.osdebug(<span class="literal">None</span>)   <span class="comment"># 关闭调试信息</span></span><br></pre></td></tr></table></figure><h4 id="AP模式"><a href="#AP模式" class="headerlink" title="AP模式"></a>AP模式</h4><p>ESP8266除了可以连接WiFi外，还可以作为一个AP来使用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wlan.disconnect()   <span class="comment"># 先断开先前的连接</span></span><br><span class="line">wlan.active(<span class="literal">False</span>)  <span class="comment"># 取消激活接口</span></span><br><span class="line">ap = network.WLAN(network.AP_IF)    <span class="comment"># 创建AP对象</span></span><br><span class="line">ap.active(<span class="literal">True</span>)     <span class="comment"># 激活AP</span></span><br><span class="line">ap.config(essid=<span class="string">'esp8266'</span>,password=<span class="string">'12345678'</span>, </span><br><span class="line">    authmode=network.AUTH_WPA2_PSK)          <span class="comment"># AP的SSID和密码，认证方式使用wpa2</span></span><br><span class="line"><span class="comment"># ap.config(essid='esp8266',authmode=network.AUTH_OPEN)   # 或者创建没有密码的WiFi</span></span><br></pre></td></tr></table></figure><p>如果想更改AP模式分配的网段，也可以使用 <code>ap.ifconfig()</code> 来设置。这个时候用手机或者电脑就可以连接到此设备了。</p><p>同时，ESP8266还支持 AP+STA 模式，这样就可以充当一个无线中继器了。还有 <code>SmartConfig</code> 技术，可以实现不连接开发板的情况下自动配置开发板连接WiFi，可惜比较遗憾的是，MicroPython 上并没有实现或者找到如何实现这样的功能。。。</p><h4 id="WebREPL"><a href="#WebREPL" class="headerlink" title="WebREPL"></a>WebREPL</h4><p>ESP8266 还提供了一个在浏览器上远程打开 MicroPython 提示符的功能就是 WebREPL，而且在这个页面上还可以实现上传文件等功能，把自己写好的代码上传到开发板，然后让它开机运行。</p><p>打开这个功能非常简单，首先配置这个服务</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> webrepl_setup</span><br></pre></td></tr></table></figure><p>执行后会询问你是否开机自启，输入 E 允许开机自启后需要配置一个连接密码来提高安全性，之后问你是否重启，输入 y 重启后可以看到提示符多了一行信息</p><pre><code>WebREPL daemon started on ws://0.0.0.0:8266Started webrepl in normal modeOSError: [Errno 2] ENOENTMicroPython v1.9.3-8-g63826ac5c on 2017-11-01; ESP module with ESP8266Type &quot;help()&quot; for more information.&gt;&gt;&gt;</code></pre><p>这个时候 可以打开官方提供的连接页面：<a href="http://micropython.org/webrepl/" target="_blank" rel="noopener">点此打开</a>，输入IP和端口，连接成功后如下<br><img src="/uploads/2018/esp8266/hcn0xg6d537fqkzv.jpg" alt></p><p>还记得刚才写的测试MCU速度的脚本吗，现在把这个脚本也加入到系统里吧，这样每次开机后都可以使用这个测试的功能了。</p><p>把刚才的程序代码写入到一个名叫 <code>mcu.py</code> 的文件，在终端执行如下代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">os.listdir(<span class="string">'/'</span>)</span><br></pre></td></tr></table></figure></p><p>可以看到，一共有两个文件，一个是 <code>boot.py</code>，一个是 <code>webrepl.cfg.py</code>，其中 <code>boot.py</code> 会在开机的时候自动运行，<code>webrepl.cfg.py</code> 里面记录的就是Web上连接的时候需要的密码了。现在将 <code>boot.py</code> 下载下来，然后修改这个文件，在最后一行添加 <code>from mcu import loop_start</code>，然后将 <code>mcu.py</code> 和 <code>boot.py</code> 上传回去，然后重启板子。</p><pre><code>&gt;&gt;&gt; os.listdir(&apos;/&apos;)[&apos;boot.py&apos;, &apos;webrepl_cfg.py&apos;, &apos;mcu.py&apos;]&gt;&gt;&gt; loop_start()Present freq: 80MHzLoop 10000 times for 30.56 msPresent freq: 160MHzLoop 10000 times for 15.296 ms&gt;&gt;&gt;</code></pre><p>可以看到，<code>loop_start()</code> 函数在启动的时候就会自动导入了，也就是说 <code>mcu.py</code> 被自动运行了，利用 <code>boot.py</code> 这样就可以实现开机的时候自动为WiFi配置静态IP了。</p><h4 id="UDP-TCP"><a href="#UDP-TCP" class="headerlink" title="UDP/TCP"></a>UDP/TCP</h4><p>能使用UDP/TCP进行通讯，这才是物联网的第一步，MicroPython 上的 <code>socket</code> 模块提供了对网络套接字的支持。下面用几个例子来看看如何使用。</p><h5 id="广播自己的IP地址"><a href="#广播自己的IP地址" class="headerlink" title="广播自己的IP地址"></a>广播自己的IP地址</h5><p>开发板连接上WiFi了，但是你并不知道板子的IP怎么办，除了登陆路由器来查看它的IP，还可以让它主动告诉你啊。</p><p>下面看代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> network</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">broadcast_ip</span><span class="params">()</span>:</span></span><br><span class="line">    wlan = network.WLAN(network.STA_IF)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> wlan.isconnected():</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">3</span>):</span><br><span class="line">        s.sendto(<span class="string">b'Hi! i am ESP8266!'</span>, (<span class="string">'255.255.255.255'</span>,<span class="number">2001</span>))</span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure></p><p>将此代码保存为 <code>ip.py</code> 然后修改 <code>boot.py</code> 文件末尾添加：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ip <span class="keyword">import</span> broadcast_ip</span><br><span class="line">broadcast_ip()</span><br></pre></td></tr></table></figure></p><p>这里选择了向整个局域网内的2001端口发送UDP广播，也可以定点向某台主机发送，但是如果自己的IP也是DHCP获取的，那么可能下一次就又得该代码了。</p><p>然后编写接收端的代码，接收端的代码在自己的电脑上运行。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">s.bind((<span class="string">''</span>,<span class="number">2001</span>))</span><br><span class="line">print(<span class="string">'Start listen on: 0.0.0.0:2001'</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    d, a = s.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    print(<span class="string">"From: %s:%s\tMessage: %s"</span> % (a[<span class="number">0</span>], a[<span class="number">1</span>], d.decode()))</span><br></pre></td></tr></table></figure><p>然后保存为 <code>find_esp8266.py</code> 并启动脚本，接着重启开发板，几秒钟后可以看到收到开发板发来的消息了。</p><pre><code>C:\Users\yunfwe\Desktop&gt;python find_esp8266.pyStart listen on: 0.0.0.0:2001From: 192.168.137.197:4097      Message: Hi! i am ESP8266!From: 192.168.137.197:4097      Message: Hi! i am ESP8266!From: 192.168.137.197:4097      Message: Hi! i am ESP8266!</code></pre><h5 id="获取NAT出口的公网IP"><a href="#获取NAT出口的公网IP" class="headerlink" title="获取NAT出口的公网IP"></a>获取NAT出口的公网IP</h5><p>局域网内的主机都是通过NAT方式共享一个公网IP来访问互联网的，那么怎么获取自己出口的这个IP呢？如果自己有台公网上的服务器，让ESP8266向它发个包就知道了，可是大多数人都是没有公网上的服务器的，这样还可以利用第三方提供的查询服务。</p><p>这里使用搜狐的查询接口: <a href="http://pv.sohu.com/cityjson?ie=utf-8" target="_blank" rel="noopener">点此打开</a>，通过原始TCP套接字手动构建一个 HTTP 请求来访问数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_nat_ip</span><span class="params">()</span>:</span></span><br><span class="line">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    ip = socket.getaddrinfo(<span class="string">'pv.sohu.com'</span>,<span class="number">0</span>)[<span class="number">0</span>][<span class="number">-1</span>][<span class="number">0</span>]</span><br><span class="line">    s.connect((ip,<span class="number">80</span>))</span><br><span class="line">    request  = <span class="string">b'GET /cityjson?ie=utf-8 HTTP/1.1\r\n'</span></span><br><span class="line">    request += <span class="string">b'Host: pv.sohu.com\r\n\r\n'</span></span><br><span class="line">    size = s.send(request)</span><br><span class="line">    header, data = s.recv(<span class="number">1024</span>).decode().split(<span class="string">'\r\n\r\n'</span>)</span><br><span class="line">    data = data.split(<span class="string">'='</span>)[<span class="number">1</span>][<span class="number">1</span>:<span class="number">-1</span>]</span><br><span class="line">    data = json.loads(data)</span><br><span class="line">    s.close()</span><br><span class="line">    print(<span class="string">'NAT IP: %s'</span> % data[<span class="string">'cip'</span>])</span><br><span class="line"></span><br><span class="line">get_nat_ip()</span><br></pre></td></tr></table></figure><p>在板子上执行看看吧！</p><h3 id="硬件IO"><a href="#硬件IO" class="headerlink" title="硬件IO"></a>硬件IO</h3><p>通过网络来控制硬件，这样才能构建出各种智能硬件，先看看这块板子的引脚说明</p><table><thead><tr><th width="25%">引脚</th><th>说明</th><th width="25%">IC 内部引脚</th></tr></thead><tbody><tr><td>D0(RX)</td><td>串口接收</td><td>GPIO3</td></tr><tr><td>D1(TX)</td><td>串口发送</td><td>GPIO1</td></tr><tr><td>D2</td><td>I/O，不支持中断、PWM、I2C、以及1-wire</td><td>GPIO16</td></tr><tr><td>D3/SCL/D15</td><td>I/O，默认模式下I2C的SCL</td><td>GPIO5</td></tr><tr><td>D4/SDA/D14</td><td>I/O，默认模式下I2C的SDA</td><td>GPIO4</td></tr><tr><td>D5/SCK/D13</td><td>I/O，SPI的时钟</td><td>GPIO14</td></tr><tr><td>D6/MISO/D11</td><td>I/O，SPI的MISO</td><td>GPIO12</td></tr><tr><td>D7/MOSI/D11</td><td>I/O，SPI的MOSI</td><td>GPIO13</td></tr><tr><td>D8</td><td>I/O，上拉，低电平时进入FLASH模式</td><td>GPIO0</td></tr><tr><td>D9/TX1</td><td>I/O，上拉</td><td>GPIO2</td></tr><tr><td>D10/SS</td><td>I/O，下拉，SPI时默认的片选(SS)</td><td>GPIO15</td></tr><tr><td>A0</td><td>AD输入，0-3.3V</td><td>ADC</td></tr></tbody></table><ul><li>所有的IO工作电平为 <strong>3.3V</strong>，可瞬间承受 5V</li><li>除D2外，所有 I/O 都支持中断，PWM，I2C，和 1-wire</li></ul><h4 id="GPIO"><a href="#GPIO" class="headerlink" title="GPIO"></a>GPIO</h4><p>ESP8266-12F 板载了一颗蓝光的LED灯，就试试用代码控制这个灯吧。这颗灯会在 GPIO2 输出为高电平的时候灭掉，输出为低电平的时候亮起来，这样通过控制 GPIO2 口的电平高低就可以控制这颗LED的亮灭了。</p><p>ESP8266 跟硬件控制相关的库是 <code>machine</code>，下面看看用 MicroPython 如何控制 GPIO</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> machine <span class="keyword">import</span> Pin</span><br><span class="line"></span><br><span class="line">led = Pin(<span class="number">2</span>, Pin.OUT)   <span class="comment"># 将GPIO的2号引脚设置为输出</span></span><br><span class="line">led.value(<span class="number">1</span>)            <span class="comment"># 将这个引脚设置为输出高电平</span></span><br><span class="line">led.value(<span class="number">0</span>)            <span class="comment"># 将这个引脚设置为输出低电平</span></span><br><span class="line">led.on()                <span class="comment"># 相当于led.value(1)</span></span><br><span class="line">led.off()               <span class="comment"># 相当于led.value(0)</span></span><br><span class="line">led.value()             <span class="comment"># 获取当前的电平值</span></span><br></pre></td></tr></table></figure><p>可以看到，执行 <code>led = Pin(2, Pin.OUT)</code> 的时候，本来灭着的LED灯突然亮了，接着执行 <code>led.value(1)</code> 的时候，LED灯灭了，这个时候 GPIO2 引脚输出的是高电平，如果在这个引脚上接一个LED灯或者其他设备，这个设备就开始工作了。</p><p><strong>D1 WiFi UNO R3</strong> 这块板子上还板载了一颗接在 GPIO 14号引脚的LED灯，也可以通过 GPIO 直接控制这颗灯的亮灭，利用这个灯做一个 Blink LED 吧。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> machine <span class="keyword">import</span> Pin</span><br><span class="line"></span><br><span class="line">led = Pin(<span class="number">14</span>,Pin.OUT, value=<span class="number">1</span>)  <span class="comment"># 创建时初始值为1</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    led.on()</span><br><span class="line">    time.sleep(<span class="number">0.5</span>)</span><br><span class="line">    led.off()</span><br><span class="line">    time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>这颗LED灯已经开始以亮 0.5 秒，灭 1 秒的频率无限的闪下去了。</p><h4 id="PWM"><a href="#PWM" class="headerlink" title="PWM"></a>PWM</h4><p>通过设置 GPIO 口的输出电平，只能控制灯的亮灭，那有没有什么办法可以调节灯的亮度呢，那就是 PWM。<br>那什么是 PWM 呢？还记得刚才让 LED 灯闪烁的例子吗，亮 0.5 秒，灭 1 秒，这样的频率肉眼很容易就观察出来了。那么如果减少这个休眠的时间，亮 1 毫秒，灭 2 毫秒，这样的频率，人的肉眼几乎就观察不出来了，而且看到的就是LED只有原来的 1/3 的亮度了。这里就引出了一个概念：占空比 通电时间占总时间的比例。而 PWM 就是调节这个的。</p><p>下面使用PWM测试下 GPIO14 上的这颗LED灯</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> machine <span class="keyword">import</span> Pin, PWM</span><br><span class="line"></span><br><span class="line">led = PWM(Pin(<span class="number">14</span>))      <span class="comment"># 对 GPIO14 进行PWM控制</span></span><br><span class="line">led.freq()              <span class="comment"># 获取当前的频率</span></span><br><span class="line">led.freq(<span class="number">1000</span>)          <span class="comment"># 调整当前的频率</span></span><br><span class="line">led.duty()              <span class="comment"># 获取当前的占空比</span></span><br><span class="line">led.duty(<span class="number">1000</span>)          <span class="comment"># 现在LED应该是满亮</span></span><br><span class="line">led.duty(<span class="number">500</span>)           <span class="comment"># 现在LED应该是半亮</span></span><br><span class="line">led.duty(<span class="number">10</span>)            <span class="comment"># 现在LED应该是微亮</span></span><br><span class="line">led.deinit()            <span class="comment"># 关闭对 GPIO14 的PWM控制</span></span><br></pre></td></tr></table></figure><p>利用这个性质可以做出一个好看的呼吸灯特效，下面看代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep_ms</span><br><span class="line"><span class="keyword">from</span> machine <span class="keyword">import</span> Pin, PWM</span><br><span class="line"></span><br><span class="line">led = PWM(Pin(<span class="number">2</span>), freq=<span class="number">1000</span>, duty=<span class="number">0</span>)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">1001</span>,<span class="number">10</span>):</span><br><span class="line">        led.duty(i)</span><br><span class="line">        sleep_ms(<span class="number">20</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>,<span class="number">0</span>,<span class="number">-10</span>):</span><br><span class="line">        led.duty(i)</span><br><span class="line">        sleep_ms(<span class="number">10</span>)</span><br><span class="line">led.deinit()</span><br></pre></td></tr></table></figure><h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h4><p>ESP8266的内存实在太小了，因此 MicroPython 并没有为ESP8266实现多线程的功能，那么如果想通过网络来控制呼吸灯应该怎么做到呢？可以试试用定时器。</p><p>定时器类似于 JavaScript 的 <code>setTimeout</code> 和 <code>setInterval</code>，因为它们实现的功能是一摸一样的。MicroPython 的 <code>machine.Timer()</code> 会在给定的时间段执行一次或者周期性的执行这个回掉函数，下面看看具体是如何使用的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> machine <span class="keyword">import</span> Timer</span><br><span class="line">t1 = Timer(<span class="number">-1</span>)      <span class="comment"># 传给构造器一个ID，如果这个ID是-1，会初始化一个虚拟定时器</span></span><br><span class="line">t1.init(period=<span class="number">5000</span>, mode=Timer.ONE_SHOT, callback=<span class="keyword">lambda</span> t:print(<span class="number">1</span>))</span><br><span class="line">t2 = Timer(<span class="number">0</span>)</span><br><span class="line">t2.init(period=<span class="number">2000</span>, mode=Timer.PERIODIC, callback=<span class="keyword">lambda</span> t:print(<span class="number">2</span>))</span><br><span class="line">t2.deinit()         <span class="comment"># 取消定时器。</span></span><br></pre></td></tr></table></figure><p>参数 <code>period</code> 是每个周期的时间，单位是毫秒。<code>mode</code> 是运行模式，是只运行一次还是周期性运行。<code>callback</code> 则是到了这个时间周期然后执行的函数。如果这个 <code>period</code> 时间非常短的话，而且周期性的运行一个函数，这个函数将自己的数据保存在全局环境中，等到下个运行周期到了再继续处理数据，如果存在多个不同回掉函数的定时器，切换速度非常快的情况下，不就相当于多个函数在同时运行了吗。定时器每次调用回掉函数的时候，还会将自己本身作为参数传给回掉函数。</p><p>下面看代码，运用上面所学的网络套接字，呼吸灯，还有定时器的知识来完成一个可以在局域网甚至公网来控制的呼吸灯。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> machine</span><br><span class="line"><span class="keyword">import</span> network</span><br><span class="line"></span><br><span class="line">wlan = network.WLAN(network.STA_IF)</span><br><span class="line">wlan.active(<span class="literal">True</span>)</span><br><span class="line">wlan.ifconfig((<span class="string">'192.168.1.10'</span>, <span class="string">'255.255.255.0'</span>, <span class="string">'192.168.1.1'</span>, <span class="string">'119.29.29.29'</span>))</span><br><span class="line">wlan.connect(<span class="string">'SSID'</span>, <span class="string">'PASSWORD'</span>)</span><br><span class="line"></span><br><span class="line">ap = network.WLAN(network.AP_IF)</span><br><span class="line">ap.active(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">led_timer = machine.Timer(<span class="number">1</span>)</span><br><span class="line">keep_alive_timer = machine.Timer(<span class="number">2</span>)</span><br><span class="line">net_control_timer = machine.Timer(<span class="number">3</span>)</span><br><span class="line">led = machine.PWM(machine.Pin(<span class="number">2</span>), freq=<span class="number">1000</span>, duty=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">up = <span class="number">1</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">breathing_light</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> led, up, count</span><br><span class="line">    <span class="keyword">if</span> up == <span class="number">1</span>:</span><br><span class="line">        count += <span class="number">3</span></span><br><span class="line">        led.duty(count)</span><br><span class="line">        <span class="keyword">if</span> count &gt; <span class="number">1000</span>:</span><br><span class="line">            up = <span class="number">0</span></span><br><span class="line">    <span class="keyword">if</span> up == <span class="number">0</span>:</span><br><span class="line">        count -= <span class="number">3</span></span><br><span class="line">        led.duty(count)</span><br><span class="line">        <span class="keyword">if</span> count == <span class="number">3</span>:</span><br><span class="line">            up = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">keep_alive</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> s</span><br><span class="line">    s.sendto(<span class="string">b'ESP8266-msg: live'</span>,(<span class="string">'1.1.1.1'</span>,<span class="number">2002</span>))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">net_control</span><span class="params">(t)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> s,led_timer,led</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        data,addr = s.recvfrom(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    print(<span class="string">'From: %s:%s\tRecv: %s'</span> % (addr[<span class="number">0</span>],addr[<span class="number">1</span>],data.decode()))</span><br><span class="line">    <span class="keyword">if</span> data <span class="keyword">in</span> [<span class="string">b'on'</span>,<span class="string">b'start'</span>]:</span><br><span class="line">        led_timer.init(period=<span class="number">10</span>, mode=machine.Timer.PERIODIC, callback=breathing_light)</span><br><span class="line">    <span class="keyword">elif</span> data == <span class="string">b'stop'</span>:</span><br><span class="line">        led_timer.deinit()</span><br><span class="line">    <span class="keyword">elif</span> data == <span class="string">b'off'</span>:</span><br><span class="line">        led_timer.deinit()</span><br><span class="line">        led.duty(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> wlan.isconnected():</span><br><span class="line">    time.sleep_ms(<span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">s.setblocking(<span class="number">0</span>)</span><br><span class="line">s.bind((<span class="string">'0.0.0.0'</span>,<span class="number">2002</span>))</span><br><span class="line">keep_alive_timer.init(period=<span class="number">10000</span>, mode=machine.Timer.PERIODIC, callback=keep_alive)</span><br><span class="line">net_control_timer.init(period=<span class="number">10</span>, mode=machine.Timer.PERIODIC, callback=net_control)</span><br><span class="line">print(<span class="string">'Running...'</span>)</span><br></pre></td></tr></table></figure><p>将代码中的连接 WiFi 的<code>SSID</code>和<code>PASSWORD</code>换成实际的，<code>keep_alive</code> 函数主要是保持一条与公网主机的UDP通道，如果没有公网主机可以注释掉下面 <code>keep_alive_timer</code> 定时器的语句。程序启动了一个UDP端口，接受来自局域网主机的控制，如果存在公网主机，也可以在公网主机上向开发板发送数据。UDP套接字设置为了非阻塞模式，然后定时器每10毫秒会询问一次是否收到UDP数据，如果收到了 <code>on</code> 或者 <code>start</code> 数据，就启动呼吸灯的定时器，呼吸灯定时器的回掉函数将当前的状态保存在了全局变量中，执行一次更改亮度的操作后就退出了，等待下个10毫秒继续执行。这样多个定时器如果存在互相调用，就不会因为发生阻塞而影响其他定时器的运行了。</p><p>当ESP8266和公网建立通信后，那么可以玩的地方更多了，比如接收温湿度传感器的数据，然后监控环境温度并定期将温度上传到服务器，或者接入微信公众平台用微信来控制单片机，这些就又是一个很大的话题了。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>板子还在继续折腾中。。。等折腾出其他好玩的了继续更新</p><!-- ### 参考资料1. http://www.cnblogs.com/yafengabc/p/8680938.html2. https://blog.csdn.net/qq_28877125/article/category/6792283/13. https://blog.csdn.net/xh870189248/article/details/77985541 -->]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;ESP8266串口WIFI模块，超低成本（只需10RMB左右）的物联网开发板，而且有非常丰富的引脚，超低的功耗。ESP8266内部有一个完整的 32bit MCU 核心，主频支持80Mz和160Mz。这个模块支持 IEEE802.11 b/g/n 协议，完整的 TCP/IP 协议栈，可以为现有的设备添加联网功能。而且除了C语言，还可以使用 Python, JavaScript, Lua脚本语言来为ESP8266写程序，极大降低了学习ESP8266的门槛。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="IoT" scheme="http://www.yunfwe.cn/categories/IoT/"/>
    
    
      <category term="esp8266" scheme="http://www.yunfwe.cn/tags/esp8266/"/>
    
  </entry>
  
  <entry>
    <title>玩转树莓派</title>
    <link href="http://www.yunfwe.cn/2018/04/24/2018/%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BE/"/>
    <id>http://www.yunfwe.cn/2018/04/24/2018/%E7%8E%A9%E8%BD%AC%E6%A0%91%E8%8E%93%E6%B4%BE/</id>
    <published>2018-04-24T02:12:00.000Z</published>
    <updated>2018-04-25T02:12:00.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Raspberry Pi 中文名为树莓派，原本是为学习计算机编程教育而设计的只有卡片大小的微型电脑，上面可以运行 Linux 甚至 Windows 10 loT 系统。树莓派虽小，却五脏俱全，而且拥有丰富的拓展接口，是学习Linux、嵌入式、物联网的利器。</p></blockquote><a id="more"></a><h2 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h2><h3 id="准备工具"><a href="#准备工具" class="headerlink" title="准备工具"></a>准备工具</h3><ul><li>树莓派，当前最新版本是 这里使用的是树莓派3B</li><li>读卡器，给树莓派烧录系统用，因为树莓派的系统安装在内存卡。</li><li>最好 8G 或以上的 Micro SD 卡，但是也不用太大，否则可能不稳定甚至不支持。</li><li>最好 5V 2.5A 电源（普通安卓充电器也可以），如果需要为树莓派扩展硬件的话，电源需要比较给力。</li><li>鼠标、键盘、HDMI转VGA线还有显示器，不过这些并不是必须的，看情况使用。</li></ul><h3 id="安装系统"><a href="#安装系统" class="headerlink" title="安装系统"></a>安装系统</h3><h4 id="下载镜像包"><a href="#下载镜像包" class="headerlink" title="下载镜像包"></a>下载镜像包</h4><p>镜像包可以选择官方的镜像，或者第三方的镜像</p><p>官方下载：<a href="https://www.raspberrypi.org/downloads/" target="_blank" rel="noopener">https://www.raspberrypi.org/downloads/</a><br>Ubuntu：<a href="https://wiki.ubuntu.com/ARM/RaspberryPi" target="_blank" rel="noopener">https://wiki.ubuntu.com/ARM/RaspberryPi</a></p><p>这里下载官方系统的Lite版，<a href="http://director.downloads.raspberrypi.org/raspbian_lite/images/raspbian_lite-2018-04-19/2018-04-18-raspbian-stretch-lite.zip" target="_blank" rel="noopener">点此下载</a>。</p><h3 id="解压和烧录"><a href="#解压和烧录" class="headerlink" title="解压和烧录"></a>解压和烧录</h3><p>可以在Linux下和Windows下进行烧录，Windows下需要下载 Win32 Disk IMager 工具进行烧录，linux下可以直接使用dd命令。</p><h4 id="Linux下烧录"><a href="#Linux下烧录" class="headerlink" title="Linux下烧录"></a>Linux下烧录</h4><p>将内存卡插入到读卡器，然后读卡器插入电脑，读卡器设备被系统映射为了 <code>/dev/sdc</code>。</p><p><strong>注意</strong>：Linux需要看看读卡器被系统映射为了哪个设备文件，如果指定错了设备文件，后果可能不堪设想。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 先卸载一下 确保系统没有主动挂载这个设备，如果存在多个分区，需要卸载多个</span><br><span class="line">umount /dev/sdc1</span><br><span class="line">unzip 2018-04-18-raspbian-stretch-lite.zip</span><br><span class="line">sudo dd if=2018-04-18-raspbian-stretch-lite.img of=/dev/sdc bs=4M</span><br></pre></td></tr></table></figure><h4 id="Windows下烧录"><a href="#Windows下烧录" class="headerlink" title="Windows下烧录"></a>Windows下烧录</h4><p>先将下载的xz镜像解压为img文件，然后使用 Win32 Disk IMager 工具烧录到内存卡。</p><p><img src="/uploads/2018/raspberry/ap6e59p5abi3u94q.png" alt><br>需要注意的是，选择SD卡的设备，然后选择好解压后的img镜像后点击 write 开始写入。</p><h3 id="启动树莓派"><a href="#启动树莓派" class="headerlink" title="启动树莓派"></a>启动树莓派</h3><p>正常来说，插入内存卡，插入网线就可以开机了，树莓派默认会DHCP获取IP地址，但是如果局域网不存在DHCP服务，那启动后会在获取DHCP地址过程中等待五六分钟，而且这种情况没有显示器就没法操作树莓派了。</p><h4 id="配置静态IP"><a href="#配置静态IP" class="headerlink" title="配置静态IP"></a>配置静态IP</h4><p>但是对于不存在DHCP服务的局域网，可以在启动树莓派之前就配置好树莓派的IP地址，这样启动后就会自动应用配置的IP，连显示器和键盘也不需要了。</p><p>以下操作在 Linux 上进行。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/sdc2 /mnt# 烧录后树莓派的rootfs在sdc的第二个分区上</span><br><span class="line">vim /mnt/etc/network/interfaces # 编辑这个文件为下面内容，将IP信息替换为合适的信息</span><br></pre></td></tr></table></figure><pre><code># This file describes the network interfaces available on your system# and how to activate them. For more information, see interfaces(5).# The loopback network interfaceauto loiface lo inet loopback# Source interfaces# Please check /etc/network/interfaces.d before changing this file# as interfaces may have been defined in /etc/network/interfaces.d# See LP: #1262951# source /etc/network/interfaces.d/*.cfgauto eth0iface eth0 inet static    address 192.168.2.220    netmask 255.255.255.0    network 192.168.2.0    broadcast 192.168.2.255    gateway 192.168.2.254    # dns-* options are implemented by the resolvconf package, if installed    dns-nameservers 119.29.29.29    dns-nameservers 223.5.5.5</code></pre><h4 id="自动启动SSH服务"><a href="#自动启动SSH服务" class="headerlink" title="自动启动SSH服务"></a>自动启动SSH服务</h4><p>系统默认启动是不启动SSH服务的，所以还要修改下 <code>rc.local</code> 文件，将 SSH服务 在系统启动后也跟着起来。</p><p>编辑 <code>/mnt/etc/rc.local</code> 添加内容：<code>systemctl start ssh.servic</code></p><h4 id="开机启动"><a href="#开机启动" class="headerlink" title="开机启动"></a>开机启动</h4><p>插入内存卡，连接网线，连接电源的那一刻树莓派就自动启动了。默认用户名：pi 默认密码：raspberry，ssh连接下试试吧。</p><h2 id="系统定制"><a href="#系统定制" class="headerlink" title="系统定制"></a>系统定制</h2><blockquote><p>定制只能在 Linux 环境下进行，这里使用 ubuntu 16.04 64位系统。</p></blockquote><p>对原始的img镜像文件进行修改定制，这样如果以后需要频繁重装系统，或者用于商业目的时，可能就有这种需求了。</p><h3 id="安装需要的包"><a href="#安装需要的包" class="headerlink" title="安装需要的包"></a>安装需要的包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">apt-get update</span><br><span class="line">apt-get install qemu qemu-user qemu-user-static kpartx</span><br></pre></td></tr></table></figure><h3 id="将镜像挂在到系统目录"><a href="#将镜像挂在到系统目录" class="headerlink" title="将镜像挂在到系统目录"></a>将镜像挂在到系统目录</h3><p>需要先将系统镜像映射到loop设备文件，才能正常挂载镜像文件中的分区</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">losetup /dev/loop0 2018-04-18-raspbian-stretch-lite.img</span><br><span class="line">kpartx -av /dev/loop0</span><br><span class="line">mount /dev/mapper/loop0p2 /mnt/</span><br></pre></td></tr></table></figure><p>这样就将镜像的 rootfs 挂载到了 /mnt 下，系统镜像有两个分区，分别被映射为了 /dev/mapper/loop0p1 和 loop0p2， 其中loop0p1是内核存放分区，暂时是不需要的。</p><h3 id="修改镜像中的数据"><a href="#修改镜像中的数据" class="headerlink" title="修改镜像中的数据"></a>修改镜像中的数据</h3><p>qemu 提供了一个非常有意思的功能，可以 chroot 到异构CPU的二进制组成的根文件系统中，这样就可以在 x86 上对 ARM 的根文件系统的程序做调式了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">modprobe binfmt_misc</span><br><span class="line">echo &apos;:arm:M::\x7fELF\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x28\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-static-arm-binfmt:P&apos; &gt; /proc/sys/fs/binfmt_misc/register</span><br><span class="line">cp /usr/bin/qemu-arm-static /mnt/usr/bin/# 将此文件拷贝到ARM的根中</span><br><span class="line">chroot /mnt/ bash</span><br></pre></td></tr></table></figure><p>执行了 chroot 之后，如果没有报错就切换到树莓派的根文件系统了，可以看看当前根的二进制文件是不是 ARM 架构的了 <code>file /bin/bash</code>，或者执行 <code>uname -a</code> 可以看到 内核也被模拟成了 ARM 架构的。</p><p>接下来就可以进行一些安装配置和修改文件等操作了，比如修改网卡的配置文件配置一个静态的IP地址，这样启动树莓派后就可以直接连接了。接下来修改 apt 源为阿里云源，加快软件下载速度。</p><p>修改：<code>/etc/apt/sources.list</code></p><pre><code>deb http://mirrors.aliyun.com/raspbian/raspbian stretch main contrib non-free rpi</code></pre><p>之后可以 <code>apt-get update</code> 然后安装需要的软件了。这时候就可以执行 <code>systemctl enable ssh.service</code> 命令，将SSH服务加入开机自启了。</p><p>修改完后退出了 chroot 环境，然后对 /mnt 目录进行卸载。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">exit # 执行exit命令或者 Ctrl + d 就可以退出了</span><br><span class="line">umount /mnt# 如果卸载不掉，使用 fuser -ka /mnt 强制卸载</span><br><span class="line">kpartx -d /dev/loop0# 卸载loop0中的分区映射</span><br><span class="line">losetup -d /dev/loop0# 卸载img文件和loop0的映射</span><br></pre></td></tr></table></figure><h3 id="刷入内存卡进行开机验证"><a href="#刷入内存卡进行开机验证" class="headerlink" title="刷入内存卡进行开机验证"></a>刷入内存卡进行开机验证</h3><p>一些不当的修改可能导致无法开机，而且一些特殊的软件包会对内核进行更改，这种情况下就无法使用这种方式定制了。建议每次修改完系统镜像后都进行一次归档保存，并且记录每次归档的修改信息，这样如果某次修改出现了问题导致无法开机，就可以回退到上一次归档的镜像而不是重头再来了。</p><h2 id="功能和拓展"><a href="#功能和拓展" class="headerlink" title="功能和拓展"></a>功能和拓展</h2><h3 id="连接WiFi"><a href="#连接WiFi" class="headerlink" title="连接WiFi"></a>连接WiFi</h3><p>树莓派3B默认是包含了WiFi和蓝牙模块的，配置连接WiFi路由器也很简单。</p><p>首先安装连接WiFi使用的程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install wpasupplicant</span><br></pre></td></tr></table></figure></p><h4 id="连接WPA加密的WiFi"><a href="#连接WPA加密的WiFi" class="headerlink" title="连接WPA加密的WiFi"></a>连接WPA加密的WiFi</h4><p>创建配置文件: <code>/etc/wpa_supplicant/wpa_supplicant.conf</code></p><pre><code>network={        ssid=&quot;SSID&quot;        key_mgmt=WPA-PSK        psk=&quot;PASSWORD&quot;}</code></pre><p>将 <code>SSID</code> 和 <code>PASSWORD</code> 替换成要连接的用户名和密码就可以了。</p><p>然后执行 <code>wpa_supplicant</code> 命令手动连接到WiFi</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wpa_supplicant -i wlan0 -c /etc/wpa_supplicant/wpa_supplicant.conf</span><br></pre></td></tr></table></figure><p>这种方式连接WiFi 如果有错误会打印错误信息，适合手动调试WiFi，等连接无误后，<code>ifconfig</code> 命令可以看到 <code>wlan0</code> 这块网卡。这个时候还是没有IP地址的，需要手动配置一个IP地址或者使用 <code>dhclient wlan0</code> 命令来自动获取IP地址。</p><p>还可以让系统 <code>networking</code> 服务来开机自动连接，修改网卡配置文件：<code>/etc/network/interfaces</code> 添加以下内容</p><pre><code>auto wlan0iface wlan0 inet dhcp　　wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf</code></pre><p>或者配置为静态IP地址</p><pre><code>auto wlan0iface wlan0 inet static    address 192.168.0.2    netmask 255.255.255.0    gateway 192.168.0.1    dns-nameservers 119.29.29.29    dns-nameservers 114.114.114.114　　wpa-conf /etc/wpa_supplicant/wpa_supplicant.conf</code></pre><p><strong>注意</strong>: 使用 <code>systemctl restart networking.service</code> 时，如果长时间没有反应，千万不要强行停止，否则可能会各种问题</p><h4 id="连接隐藏的WiFi"><a href="#连接隐藏的WiFi" class="headerlink" title="连接隐藏的WiFi"></a>连接隐藏的WiFi</h4><p>修改配置文件：<code>/etc/wpa_supplicant/wpa_supplicant.conf</code> 为以下内容</p><pre><code>network={    ssid=&quot;SSID&quot;    scan_ssid=1    psk=&quot;PASSWORD&quot;}</code></pre><p>同理，将 <code>SSID</code> 和 <code>PASSWORD</code> 替换为自己实际的，其他步骤和上面的一致。</p><h4 id="连接没密码的WiFi"><a href="#连接没密码的WiFi" class="headerlink" title="连接没密码的WiFi"></a>连接没密码的WiFi</h4><p>修改配置文件：<code>/etc/wpa_supplicant/wpa_supplicant.conf</code> 为以下内容</p><pre><code>network={        ssid=&quot;SSID&quot;        key_mgmt=NONE}</code></pre><h4 id="添加多个WiFi"><a href="#添加多个WiFi" class="headerlink" title="添加多个WiFi"></a>添加多个WiFi</h4><p>可以在配置文件中添加多个 <code>network</code> 配置块来添加多个WiFi配置，<code>wpa_supplicant</code> 将会自动连接可以连接的WiFi，也可以手动配置优先级来偏重连接某个WiFi。</p><pre><code>network={    ssid=&quot;SSID1&quot;    psk=&quot;PASSWORD1&quot;    priority=1    id_str=&quot;homeOne&quot;}network={    ssid=&quot;SSID2&quot;    psk=&quot;PASSWORD2&quot;    priority=2    id_str=&quot;homeTwo&quot;}</code></pre><h3 id="使用4G上网"><a href="#使用4G上网" class="headerlink" title="使用4G上网"></a>使用4G上网</h3><p>由于树莓派3B并没有自带4G模块，所以想使用SIM卡拨号上网就需要另外买一个4G模块。树莓派3B也没有适用于4G模块的 Mini PCI-e 接口，所以还需要买一个 Mini PCI-e 转 USB 的4G模块专用开发板。</p><p>这里4G模块使用 华为ME909s-821，SIM卡使用联通实名制的4G卡，需要先保证4G卡可以正常上网。</p><p>安装4G拨号软件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install wvdial</span><br></pre></td></tr></table></figure></p><p>修改配置文件：<code>/etc/wvdial.conf</code> 添加如下内容</p><pre><code>[Dialer wcdma]Init1 = ATZInit2 = ATQ0 V1 E1 S0=0Init3 = AT+CGDCONT=1,&quot;IP&quot;,&quot;3gnet&quot;Modem Type = Analog ModemBaud = 9600New PPPD = yesModem = /dev/ttyUSB0ISDN = 0Phone = *99#Password = guestUsername = guest</code></pre><p>需要注意的地方是 <code>Modem = /dev/ttyUSB0</code> ，需要找到4G模块的设备文件，如果不确定4G模块的设备文件是啥，可以先记录下 <code>/dev/</code> 目录下的所有文件名，然后插上后看看多出来了哪些，4G模块会多出来5个设备文件，一般第一个 <code>ttyUSB*</code> 设备文件是 <code>Modem</code> 的设备文件，也就是 <code>/dev/ttyUSB0</code>，但是如果已经存在了其它的 <code>ttyUSB*</code> 文件，则4G模块的设备文件会依次往后排。</p><p>将4G模块插入 Mini PCI-e 接口将SIM卡插入到卡槽，天线最好接上，否则信号可能太差导致拨号失败。<br><img src="/uploads/2018/raspberry/50tj5q84rn5g2wj8.jpg" alt></p><p>使用 <code>wvdial wcdma</code> 命令开始拨号，当出现如下信息时，则拨号成功了</p><pre><code>--&gt; local  IP address 10.90.80.32--&gt; pppd: XE[01]--&gt; remote IP address 10.64.64.64--&gt; pppd: XE[01]--&gt; primary   DNS address 123.123.123.123--&gt; pppd: XE[01]--&gt; secondary DNS address 123.123.123.124--&gt; pppd: XE[01]</code></pre><p>这时候使用 <code>ifconfig</code> 可以看到 <code>ppp0</code> 接口已经连接</p><pre><code>ppp0      Link encap:Point-to-Point Protocol          inet addr:10.90.80.32  P-t-P:10.64.64.64  Mask:255.255.255.255        UP POINTOPOINT RUNNING NOARP MULTICAST  MTU:1500  Metric:1        RX packets:6 errors:0 dropped:0 overruns:0 frame:0        TX packets:7 errors:0 dropped:0 overruns:0 carrier:0        collisions:0 txqueuelen:3         RX bytes:66 (66.0 B)  TX bytes:129 (129.0 B)</code></pre><p>然后替换默认路由到点对点拨号的对端IP就可以使用4G上网了</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip ro replace default via 10.64.64.6</span><br><span class="line">ping www.baidu.com -c 4</span><br></pre></td></tr></table></figure><pre><code>root@raspberrypi:~# ip ro replace default via 10.64.64.64 root@raspberrypi:~# ping www.baidu.com -c 4PING www.a.shifen.com (61.135.169.121) 56(84) bytes of data.64 bytes from 61.135.169.121: icmp_seq=1 ttl=54 time=36.2 ms64 bytes from 61.135.169.121: icmp_seq=2 ttl=54 time=25.9 ms64 bytes from 61.135.169.121: icmp_seq=3 ttl=54 time=21.9 ms64 bytes from 61.135.169.121: icmp_seq=4 ttl=54 time=19.8 ms--- www.a.shifen.com ping statistics ---4 packets transmitted, 4 received, 0% packet loss, time 3003msrtt min/avg/max/mdev = 19.859/25.984/36.220/6.300 msroot@raspberrypi:~# </code></pre><p>还有一些需要注意的地方，如果使用物联网卡，需要确保物联网卡是否支持4G，是否支持数据业务，以及4G模块支持的网络和运营商。</p><p>将 <code>wvdial</code> 程序 <code>Ctrl + c</code> 后4G就自动断开了。</p><h3 id="使用GPS模块"><a href="#使用GPS模块" class="headerlink" title="使用GPS模块"></a>使用GPS模块</h3><p>如果想用树莓派做行车记录仪之类的东西，GPS模块就必不可少了，这里使用 NEO-7N-0-002 GPS模块。<br>这款GPS模块支持通过USB连接到树莓派，也支持和树莓派直接进行串口连接。</p><h4 id="USB连接"><a href="#USB连接" class="headerlink" title="USB连接"></a>USB连接</h4><p>直接使用普通的数据线连接，自带陶瓷天线，但是最好外接天线。使用自带的陶瓷天线定位时最好将GPS模块放到靠窗的位置，户外效果最佳，否则将无法定位。</p><p>连接如下，通过USB连接后设备被映射为 <code>/dev/ttyACM0</code><br><img src="/uploads/2018/raspberry/ashdlaiefjaef.png" alt></p><p>当橘红色的灯按频率闪灭，而不是常亮时就定位成功了，使用 <code>cat /dev/ttyACM0</code> 命令查看GPS模块的输出只需要关心 <code>$GPGGA</code> 的内容就可以，定位成功的信息是这样子的</p><pre><code>root@raspberrypi:~# cat /dev/ttyACM0 |grep GPGGA$GPGGA,025456.00,?955.49947,N,?1619.28218,E,2,08,1.52,98.4,M,-8.7,M,,0000*74$GPGGA,025457.00,?955.49948,N,?1619.28211,E,2,08,1.52,98.5,M,-8.7,M,,0000*72$GPGGA,025458.00,?955.49960,N,?1619.28209,E,2,08,1.52,98.4,M,-8.7,M,,0000*7F$GPGGA,025459.00,?955.49967,N,?1619.28204,E,2,08,1.52,98.3,M,-8.7,M,,0000*73</code></pre><p>其中 <code>?955.49947,N,?1619.28218,E</code> N前面的浮点数表示北纬，E前面的浮点数表示东经，为了防止位置信息泄露，所以其中有一位数字用 <code>?</code> 代替了，想了解 <code>$GPGGA</code> 的更多详细信息，可以翻阅 <code>GPGGA</code> 卫星数据格式。</p><h4 id="串口连接"><a href="#串口连接" class="headerlink" title="串口连接"></a>串口连接</h4><p>由于树莓派3B自带的串口被用于蓝牙了，所以最省事的方法就是使用USB转TTL线，将TTL线的 +5V 接到GPS模块的 VCC 引脚， GND 接到GPS模块的 GND，TXD 接到GPS模块的 RXD，RXD 接到GPS模块的 TXD，也就是说TTL线的输入输出要和GPS模块的输入输出交叉接。</p><p>但是不知道是不是这款GPS模块板子上印刷错了，导致TTL线的 RXD 必须和 GPS模块上印刷的 RXD 引脚相接才能正常接收数据，由于只需要从GPS模块上接收数据，所以TTL线的 TXD 也可以不和GPS模块相接。</p><p>接线图如下<br><img src="/uploads/2018/raspberry/mvoi31xz4nd0sgyw.png" alt></p><p>使用 <code>minicom -D /dev/ttyUSB0 -b 9600</code> 命令就可以获取GPS数据了。如果要处理GPS数据，可以用程序直连串口获取。摁下 <code>Ctrl + a</code> 松开后摁 <code>x</code> 然后敲下回车就退出 <code>minicom</code> 了。</p><h3 id="设备和设备文件绑定"><a href="#设备和设备文件绑定" class="headerlink" title="设备和设备文件绑定"></a>设备和设备文件绑定</h3><p>前面的4G模块使用的是 <code>/dev/ttyUSB0</code> 设备文件，TTL线使用的也是 <code>/dev/ttyUSB0</code>，如果同时使用这两个模块，重启后谁也无法确定当前的 <code>/dev/ttyUSB0</code> 是哪个模块，这种情况可以使用 <code>udev</code> 规则来绑定设备和设备文件。</p><p>使用 <code>udevadm info --attribute-walk --name=/dev/ttyUSB0</code> 可以查看当前 <code>/dev/ttyUSB0</code> 设备的详细信息，然后通过这些信息匹配来为设备文件建立一个软连接，这样每次可以通过软连接来访问设备了。</p><p>添加文件：<code>/etc/udev/rules.d/mydevice.rules</code></p><pre><code>KERNEL==&quot;ttyUSB*&quot;, ATTRS{idVendor}==&quot;1a86&quot;, ATTRS{idProduct}==&quot;7523&quot;, MODE:=&quot;0666&quot;, GROUP:=&quot;dialout&quot;,  SYMLINK+=&quot;ttl0&quot;KERNEL==&quot;ttyUSB*&quot;, ATTRS{bInterfaceNumber}==&quot;02&quot;, MODE:=&quot;0666&quot;, GROUP:=&quot;dialout&quot;,  SYMLINK+=&quot;hw4g0&quot;KERNEL==&quot;ttyUSB*&quot;, ATTRS{bInterfaceNumber}==&quot;03&quot;, MODE:=&quot;0666&quot;, GROUP:=&quot;dialout&quot;,  SYMLINK+=&quot;hw4g1&quot;KERNEL==&quot;ttyUSB*&quot;, ATTRS{bInterfaceNumber}==&quot;04&quot;, MODE:=&quot;0666&quot;, GROUP:=&quot;dialout&quot;,  SYMLINK+=&quot;hw4g2&quot;KERNEL==&quot;ttyUSB*&quot;, ATTRS{bInterfaceNumber}==&quot;05&quot;, MODE:=&quot;0666&quot;, GROUP:=&quot;dialout&quot;,  SYMLINK+=&quot;hw4g3&quot;KERNEL==&quot;ttyUSB*&quot;, ATTRS{bInterfaceNumber}==&quot;06&quot;, MODE:=&quot;0666&quot;, GROUP:=&quot;dialout&quot;,  SYMLINK+=&quot;hw4g4&quot;</code></pre><p>这样同时使用GPS和4G模块就可以通过访问 <code>/dev/ttl0</code> 和 <code>/dev/hw4g0</code> 来实现了。<code>udev</code> 规则的编写可以执行 <code>man udev</code> 获取。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>资料参考：</p><ul><li><a href="https://www.cnblogs.com/shubin/p/7746399.html" target="_blank" rel="noopener">树莓派命令行配置WiFi网络</a></li><li><a href="https://blog.csdn.net/jiaojian8063868/article/details/79295570" target="_blank" rel="noopener">树莓派调试华为4G模块</a></li><li><a href="https://blog.csdn.net/qq_32384313/article/details/77725544" target="_blank" rel="noopener">华为LTE模块AT拨号上网</a></li><li><a href="https://www.cnblogs.com/huhubun/p/4083718.html" target="_blank" rel="noopener">树莓派调试GPS模块</a></li><li><a href="https://blog.csdn.net/walleva96/article/details/78347612" target="_blank" rel="noopener">udev绑定USB串口的方式</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Raspberry Pi 中文名为树莓派，原本是为学习计算机编程教育而设计的只有卡片大小的微型电脑，上面可以运行 Linux 甚至 Windows 10 loT 系统。树莓派虽小，却五脏俱全，而且拥有丰富的拓展接口，是学习Linux、嵌入式、物联网的利器。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="IoT" scheme="http://www.yunfwe.cn/categories/IoT/"/>
    
    
      <category term="ubuntu" scheme="http://www.yunfwe.cn/tags/ubuntu/"/>
    
      <category term="raspberry" scheme="http://www.yunfwe.cn/tags/raspberry/"/>
    
  </entry>
  
  <entry>
    <title>Peewee 轻量级ORM框架</title>
    <link href="http://www.yunfwe.cn/2018/03/20/2018/Peewee%20%E8%BD%BB%E9%87%8F%E7%BA%A7ORM%E6%A1%86%E6%9E%B6/"/>
    <id>http://www.yunfwe.cn/2018/03/20/2018/Peewee%20%E8%BD%BB%E9%87%8F%E7%BA%A7ORM%E6%A1%86%E6%9E%B6/</id>
    <published>2018-03-20T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.870Z</updated>
    
    <content type="html"><![CDATA[<!-- created: 2018-03-13 10:12:00--><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>Peewee 是Python的一款轻量级ORM框架。ORM 是对象-关系映射（Object-Relational Mapping），是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。ORM 屏蔽了底层数据库操作的细节，使代码几乎不用修改即可支持不同的底层数据库存储。支持Python2.7和3.4以上的版本，内置对SQLite, MySQL和Postgresql的支持。本文通过阅读官方文档翻译而来。<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>这里使用 Windows 版的 Python 3.6 和当前最新版的 peewee 3.1.3。</p><p>Github地址：<a href="https://github.com/coleifer/peewee" target="_blank" rel="noopener">https://github.com/coleifer/peewee</a></p><h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>这里使用 pip 命令安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install peewee</span><br></pre></td></tr></table></figure><p>也可以将代码 git 下来 使用 setup 安装</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/coleifer/peewee.git </span><br><span class="line">cd peewee </span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure><p>如果底层想要使用 MySQL 数据库需要安装 MySQL 的连接驱动：<code>pip install pymysql</code>，并且配置好一个可用的 MySQL 数据库。Postgres 同理，Postgres 的连接驱动：<code>pip install psycopg2</code>。</p><p> SQLite 是 Python 标准库的模块，不需要额外安装和配置，也更简单方便，所以这里就以 SQLite 为例。</p><h3 id="快速体验"><a href="#快速体验" class="headerlink" title="快速体验"></a>快速体验</h3><p>先来体验一下 peewee 对数据交互带来的方便吧。</p><h4 id="创建数据模型"><a href="#创建数据模型" class="headerlink" title="创建数据模型"></a>创建数据模型</h4><p>先理解下什么 ORM ，ORM 是将编程语言中的对象映射为数据库中的数据，比如说 可以将编程语言中的一个类，映射为数据库的一个表，这个类被称为模型类（Model class）。模型类的字段实例（Field instance），映射为数据库中表的字段。模型实例（Model instance）映射为数据库中表的每一行数据。</p><p>建议在命令行中执行下面的代码，这样就更直观的知道每一步都发生了什么。</p><p>在项目中使用 peewee 时，刚开始最好创建一个模型类，peewee 会自动根据这个模型类在数据库中创建好表。下面看看模型类如何定义的：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">db = SqliteDatabase(<span class="string">'people.db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField()</span><br><span class="line">    birthday = DateField()</span><br><span class="line">    is_relative = BooleanField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db <span class="comment"># This model uses the "people.db" database.</span></span><br></pre></td></tr></table></figure><p>当我们使用外键建立模型之间的关系时，peewee 可以很容易的做到这一点。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pet</span><span class="params">(Model)</span>:</span></span><br><span class="line">    owner = ForeignKeyField(Person, backref=<span class="string">'pets'</span>)</span><br><span class="line">    name = CharField()</span><br><span class="line">    animal_type = CharField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db <span class="comment"># this model uses the "people.db" database</span></span><br></pre></td></tr></table></figure><p>现在创建好了模型，让我们连接到数据库。虽然在执行第一条查询的时候会自动连接数据库，但是手动连接可以立即显示数据库连接的任何错误，在使用完后手动关闭数据库连接也是个很好的习惯。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.connect()</span><br></pre></td></tr></table></figure><p>首先在数据库中创建存储数据的表。这将创建具有适当列，索引，序列和外键约束的表：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.create_tables([Person, Pet])</span><br></pre></td></tr></table></figure><p>可以看到 当前目录 已经出现了一个 <code>people.db</code> 的 SQLite 数据库文件。</p><h4 id="存储数据"><a href="#存储数据" class="headerlink" title="存储数据"></a>存储数据</h4><p>现在开始存储一些数据，我们将使用 <code>save()</code> 和 <code>create()</code> 方法添加和修改表中的记录</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line">uncle_bob = Person(name=<span class="string">'Bob'</span>, birthday=date(<span class="number">1960</span>, <span class="number">1</span>, <span class="number">15</span>), is_relative=<span class="literal">True</span>)</span><br><span class="line">uncle_bob.save() <span class="comment"># bob is now stored in the database. Returns: 1</span></span><br></pre></td></tr></table></figure><p>调用 <code>save()</code> 将返回修改的行数。也可使用 <code>create()</code> 方法来添加一个人：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grandma = Person.create(name=<span class="string">'Grandma'</span>, birthday=date(<span class="number">1935</span>, <span class="number">3</span>, <span class="number">1</span>), is_relative=<span class="literal">True</span>)</span><br><span class="line">herb = Person.create(name=<span class="string">'Herb'</span>, birthday=date(<span class="number">1950</span>, <span class="number">5</span>, <span class="number">5</span>), is_relative=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>如果想更改某行，修改模型实例的属性，然后调用 <code>save()</code> 方法就会同步到数据库了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">grandma.name = <span class="string">'Grandma L.'</span></span><br><span class="line">grandma.save()</span><br></pre></td></tr></table></figure><p>现在已经在数据库中存储了三个人，让我们给他们一些宠物。奶奶不喜欢宠物，但Herb是宠物的爱好者。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">bob_kitty = Pet.create(owner=uncle_bob, name=<span class="string">'Kitty'</span>, animal_type=<span class="string">'cat'</span>)</span><br><span class="line">herb_fido = Pet.create(owner=herb, name=<span class="string">'Fido'</span>, animal_type=<span class="string">'dog'</span>)</span><br><span class="line">herb_mittens = Pet.create(owner=herb, name=<span class="string">'Mittens'</span>, animal_type=<span class="string">'cat'</span>)</span><br><span class="line">herb_mittens_jr = Pet.create(owner=herb, name=<span class="string">'Mittens Jr'</span>, animal_type=<span class="string">'cat'</span>)</span><br></pre></td></tr></table></figure><p>经过漫长的时间后，Mittens 生病死亡了，现在从数据库中删的它。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">herb_mittens.delete_instance()</span><br></pre></td></tr></table></figure><p><code>delete_instance()</code> 方法也会返回删除的行数。</p><p>叔叔 Bob 觉得在 Herb 的房间死了太多动物，所以收养了他的狗 Fido。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">herb_fido.owner = uncle_bob</span><br><span class="line">herb_fido.save()</span><br><span class="line">bob_fido = herb_fido <span class="comment"># rename our variable for clarity</span></span><br></pre></td></tr></table></figure><h4 id="检索数据"><a href="#检索数据" class="headerlink" title="检索数据"></a>检索数据</h4><p>数据库的优势在于可以通过SQL语句来检索数据，现在看看 peewee 中是如何检索数据的。</p><h5 id="查询一条记录"><a href="#查询一条记录" class="headerlink" title="查询一条记录"></a>查询一条记录</h5><p>让我们从数据库中获取奶奶的记录，从数据库获取单条记录使用 <code>select.get()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grandma = Person.select().where(Person.name == <span class="string">'Grandma L.'</span>).get()</span><br></pre></td></tr></table></figure><p>我们也可以使用等效的缩写 <code>Model.get()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grandma = Person.get(Person.name == <span class="string">'Grandma L.'</span>)</span><br></pre></td></tr></table></figure><h5 id="列出记录"><a href="#列出记录" class="headerlink" title="列出记录"></a>列出记录</h5><p>让我们列出所有人的记录</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select():</span><br><span class="line">    print(person.name, person.is_relative)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Bob TrueGrandma L. TrueHerb False</code></pre><p>让我们列出所有的猫和它们主人的名字</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query = Pet.select().where(Pet.animal_type == <span class="string">'cat'</span>)</span><br><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> query:</span><br><span class="line">    print(pet.name, pet.owner.name)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Kitty BobMittens Jr Herb</code></pre><p>但是这样的查询有一个很大的问题，因为我们想要知道宠物主人的名字，但是 Pet 表中并没有这一个字段，所以当访问 <code>pet.owner.name</code> 的时候，peewee 不得不执行额外的查询来检索宠物的所有者，这样的情况通常应该是避免的。</p><p>我们应当使用 join 进行关联查询来避免额外的开销</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">query = (Pet</span><br><span class="line">         .select(Pet, Person)</span><br><span class="line">         .join(Person)</span><br><span class="line">         .where(Pet.animal_type == <span class="string">'cat'</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> query:</span><br><span class="line">    print(pet.name, pet.owner.name)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Kitty BobMittens Jr Herb</code></pre><p>让我们看看 Bob 有哪些宠物</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> Pet.select().join(Person).where(Person.name == <span class="string">'Bob'</span>):</span><br><span class="line">    print(pet.name)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>KittyFido</code></pre><p>我们还有一个很酷的方法获取 Bob 的宠物，因为我们已经有一个表示 Bob 的对象，所以我们可以这样做</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> Pet.select().where(Pet.owner == uncle_bob):</span><br><span class="line">    print(pet.name)</span><br></pre></td></tr></table></figure><h5 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h5><p>让我们添加一个 <code>order_by()</code> 方法来让它们按照字母顺序排序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> pet <span class="keyword">in</span> Pet.select().where(Pet.owner == uncle_bob).order_by(Pet.name):</span><br><span class="line">    print(pet.name)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>FidoKitty</code></pre><p>让我们按照年纪 从年轻到年老列出人们</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select().order_by(Person.birthday.desc()):</span><br><span class="line">    print(person.name, person.birthday)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Bob 1960-01-15Herb 1950-05-05Grandma L. 1935-03-01</code></pre><h5 id="结合过滤器表达式"><a href="#结合过滤器表达式" class="headerlink" title="结合过滤器表达式"></a>结合过滤器表达式</h5><p>Peewee 支持任意嵌套的表达式。让我们得到所有生日不一的人</p><p>1940之前的人（Grandma）<br>1959年之后的人（Bob）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">d1940 = date(<span class="number">1940</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">d1960 = date(<span class="number">1960</span>, <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">query = (Person</span><br><span class="line">         .select()</span><br><span class="line">         .where((Person.birthday &lt; d1940) | (Person.birthday &gt; d1960)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    print(person.name, person.birthday)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Bob 1960-01-15Grandma L. 1935-03-01</code></pre><p>现在看看生日在1940年至1960年之间的人</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">query = (Person</span><br><span class="line">         .select()</span><br><span class="line">         .where(Person.birthday.between(d1940, d1960)))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    print(person.name, person.birthday)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Herb 1950-05-05</code></pre><h5 id="聚合和预获取"><a href="#聚合和预获取" class="headerlink" title="聚合和预获取"></a>聚合和预获取</h5><p>现在让我们列出所有的人和他们有多少宠物</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select():</span><br><span class="line">    print(person.name, person.pets.count(), <span class="string">'pets'</span>)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Bob 2 petsGrandma L. 0 petsHerb 1 pets</code></pre><p>在这种情况下，我们又为返回的每个人执行了附加查询！我们可以通过执行join并使用sql函数来聚合结果来避免这种情况。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query = (Person</span><br><span class="line">         .select(Person, fn.COUNT(Pet.id).alias(<span class="string">'pet_count'</span>))</span><br><span class="line">         .join(Pet, JOIN.LEFT_OUTER)  <span class="comment"># include people without pets.</span></span><br><span class="line">         .group_by(Person)</span><br><span class="line">         .order_by(Person.name))</span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    <span class="comment"># "pet_count" becomes an attribute on the returned model instances.</span></span><br><span class="line">    print(person.name, person.pet_count, <span class="string">'pets'</span>)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Bob 2 petsGrandma L. 0 petsHerb 1 pets</code></pre><p>一只宠物只能有一个主人，所以当进行从 Pet 到 Person 的 join 操作时，它们通常都会进行一次匹配。当我们从 Person 到 Pet 的 join 时，情况会不同，因为一个人可能没有宠物，或者他们可能有几只宠物。因为我们使用关系数据库，当我们从 Person 到 Pet 的 join 时，那么每个宠物都会重复每个拥有多个宠物的人。</p><p>它看起来像这样：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">query = (Person</span><br><span class="line">         .select(Person, Pet)</span><br><span class="line">         .join(Pet, JOIN.LEFT_OUTER)</span><br><span class="line">         .order_by(Person.name, Pet.name))</span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    <span class="comment"># We need to check if they have a pet instance attached, since not all</span></span><br><span class="line">    <span class="comment"># people have pets.</span></span><br><span class="line">    <span class="keyword">if</span> hasattr(person, <span class="string">'pet'</span>):</span><br><span class="line">        print(person.name, person.pet.name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(person.name, <span class="string">'no pets'</span>)</span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>Bob FidoBob KittyGrandma L. no petsHerb Mittens Jr</code></pre><p>通常这种类型的重复是不可取的，我们可以使用一种 <code>prefetch()</code> 的特殊方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query = Person.select().order_by(Person.name).prefetch(Pet)</span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> query:</span><br><span class="line">    print(person.name)</span><br><span class="line">    <span class="keyword">for</span> pet <span class="keyword">in</span> person.pets:</span><br><span class="line">        print(<span class="string">'  *'</span>, pet.name)</span><br></pre></td></tr></table></figure><h5 id="SQL-函数"><a href="#SQL-函数" class="headerlink" title="SQL 函数"></a>SQL 函数</h5><p>这将使用一个 SQL 方法来查找名字以大写或者小写 g 开头的人</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">expression = fn.Lower(fn.Substr(Person.name, <span class="number">1</span>, <span class="number">1</span>)) == <span class="string">'g'</span></span><br><span class="line"><span class="keyword">for</span> person <span class="keyword">in</span> Person.select().where(expression):</span><br><span class="line">    print(person.name)</span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Grandma L.</code></pre><p>这只是 peewee 的基础，你还可以使查询更复杂，其他的 SQL 子句也可以使用，比如 <code>group_by()</code>, <code>having()</code>, <code>limit()</code>, <code>offset()</code></p><h4 id="关闭数据库"><a href="#关闭数据库" class="headerlink" title="关闭数据库"></a>关闭数据库</h4><p>当使用完数据库，我们应该关闭它</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.close()</span><br></pre></td></tr></table></figure><h4 id="从数据库导出模型"><a href="#从数据库导出模型" class="headerlink" title="从数据库导出模型"></a>从数据库导出模型</h4><p>如果已经存在的数据库，可以使用模型生成器 <code>pwiz</code> 自动生成 peewee 模型</p><p>比如将刚才 <code>people.db</code> 的数据再导出模型</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pwiz -e sqlite people.db</span><br></pre></td></tr></table></figure><p>如果想导出 MySQL 库的数据 可以这样做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pwiz -e mysql -H localhost -p3306 -uuser -Ppassword  dbname &gt; db.py</span><br></pre></td></tr></table></figure></p><h3 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h3><h4 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h4><p>Peewee 的 <code>Database</code> 对象表示到数据库的连接。<code>Database</code> 类将实例化打开的数据库连接所需的所有信息，这些信息可用于：</p><ul><li>打开和关闭连接</li><li>执行查询请求</li><li>事务管理</li><li>内省表，列，索引和约束</li><li>模型整合</li></ul><p>peewee支持 SQLite, MySQL 和 Postgres。每个数据库类都提供了一些基本的数据库特定的配置选项</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># SQLite database using WAL journal mode and 64MB cache.</span></span><br><span class="line">sqlite_db = SqliteDatabase(<span class="string">'/path/to/app.db'</span>, pragmas=(</span><br><span class="line">    (<span class="string">'journal_mode'</span>, <span class="string">'wal'</span>),</span><br><span class="line">    (<span class="string">'cache_size'</span>, <span class="number">-1024</span> * <span class="number">64</span>)))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to a MySQL database on network.</span></span><br><span class="line">mysql_db = MySQLDatabase(<span class="string">'dbname'</span>, user=<span class="string">'root'</span>, password=<span class="string">'db_password'</span>,</span><br><span class="line">                         host=<span class="string">'10.1.0.8'</span>, port=<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to a Postgres database.</span></span><br><span class="line">pg_db = PostgresqlDatabase(<span class="string">'my_app'</span>, user=<span class="string">'postgres'</span>, password=<span class="string">'secret'</span>,</span><br><span class="line">                           host=<span class="string">'10.1.0.9'</span>, port=<span class="number">5432</span>)</span><br></pre></td></tr></table></figure><p>Peewee 通过特定的扩展模块提供了对 SQLite 和 Postgres 的高级支持。要使用扩展功能，需要导入特殊数据库模块的 <code>Database</code> 类</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playhouse.sqlite_ext <span class="keyword">import</span> SqliteExtDatabase</span><br><span class="line"><span class="comment"># Use SQLite (will register a REGEXP function and set busy timeout to 3s).</span></span><br><span class="line">db = SqliteExtDatabase(<span class="string">'/path/to/app.db'</span>, regexp_function=<span class="literal">True</span>, timeout=<span class="number">3</span>,</span><br><span class="line">                       pragmas=((<span class="string">'journal_mode'</span>, <span class="string">'wal'</span>),))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> playhouse.postgres_ext <span class="keyword">import</span> PostgresqlExtDatabase</span><br><span class="line"><span class="comment"># Use Postgres (and register hstore extension).</span></span><br><span class="line">db = PostgresqlExtDatabase(<span class="string">'dbname'</span>, user=<span class="string">'postgres'</span>, register_hstore=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p><code>Database</code> 类的初始化方法第一个参数是期望的数据库名称，剩下的参数将传给建立连接的底层数据库驱动程序</p><h4 id="使用URL连接数据库"><a href="#使用URL连接数据库" class="headerlink" title="使用URL连接数据库"></a>使用URL连接数据库</h4><p><code>playhouse</code> 模块提供了一个 <code>connect()</code> 函数，它接受数据库URL 并返回一个数据库实例</p><p>示例：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> playhouse.db_url <span class="keyword">import</span> connect</span><br><span class="line"></span><br><span class="line"><span class="comment"># Connect to the database URL defined in the environment, falling</span></span><br><span class="line"><span class="comment"># back to a local Sqlite database if no database URL is specified.</span></span><br><span class="line">db = connect(os.environ.get(<span class="string">'DATABASE'</span>) <span class="keyword">or</span> <span class="string">'sqlite:///default.db'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br></pre></td></tr></table></figure></p><p>数据库URL示例：</p><ul><li><code>sqlite:///my_database.db</code> 将为 <code>my_database.db</code> 在当前目录创建 <code>SqliteDatabase</code> 实例。</li><li><code>sqlite:///:memory</code> 将要创建在内存中的 <code>SqliteDatabase</code> 实例。</li><li><code>postgresql://postgres:my_password@localhost:5432/my_database</code> 将创建一个 <code>PostgresqlDatabase</code> 实例。并提供用户名和密码以及连接的主机和端口</li><li><code>mysql://user:passwd@ip:port/my_db</code> 将为本地 MySQL 数据库创建 <code>MySQLDatabase</code> 的实例。</li></ul><h4 id="数据库运行时配置"><a href="#数据库运行时配置" class="headerlink" title="数据库运行时配置"></a>数据库运行时配置</h4><p>有时候直到运行时数据库配置才会直到，这些值可以从配置文件或者环境变量获取。在这种情况下可以通过将 <code>None</code> 指定为数据库名来推迟数据库的初始化。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">database = SqliteDatabase(<span class="literal">None</span>)  <span class="comment"># Un-initialized database.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = database</span><br></pre></td></tr></table></figure><p>这时候尝试连接数据库时会抛出一个异常</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">database.connect()</span><br><span class="line">Exception: Error, database <span class="keyword">not</span> properly initialized before opening connection</span><br></pre></td></tr></table></figure><p>可以手动调用 init() 方法来初始化数据库</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">database_name = raw_input(<span class="string">'What is the name of the db? '</span>)</span><br><span class="line">database.init(database_name, host=<span class="string">'localhost'</span>, user=<span class="string">'postgres'</span>)</span><br></pre></td></tr></table></figure><h4 id="动态定义数据库"><a href="#动态定义数据库" class="headerlink" title="动态定义数据库"></a>动态定义数据库</h4><p>为了更好地控制数据库的定义/初始化方式，可以使用 <code>Proxy()</code> 方法，<code>Proxy()</code> 方法充当占位符，然后在运行时您可以将其交换出一个不同的对象。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">database_proxy = Proxy()  <span class="comment"># Create a proxy for our db.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = database_proxy  <span class="comment"># Use proxy for our DB.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username = CharField()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Based on configuration, use a different database.</span></span><br><span class="line"><span class="keyword">if</span> app.config[<span class="string">'DEBUG'</span>]:</span><br><span class="line">    database = SqliteDatabase(<span class="string">'local.db'</span>)</span><br><span class="line"><span class="keyword">elif</span> app.config[<span class="string">'TESTING'</span>]:</span><br><span class="line">    database = SqliteDatabase(<span class="string">':memory:'</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    database = PostgresqlDatabase(<span class="string">'mega_production_db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Configure our proxy to use the db we specified in config.</span></span><br><span class="line">database_proxy.initialize(database)</span><br></pre></td></tr></table></figure><h4 id="连接管理"><a href="#连接管理" class="headerlink" title="连接管理"></a>连接管理</h4><p>打开一个数据库连接，使用 <code>Database.connect()</code> 方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db = SqliteDatabase(<span class="string">':memory:'</span>) </span><br><span class="line">db.connect()</span><br></pre></td></tr></table></figure><p>如果尝试再次调用 <code>connect()</code> 将会得到一个 <code>OperationalError</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">db.connect()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"/home/charles/pypath/peewee.py"</span>, line <span class="number">2390</span>, <span class="keyword">in</span> connect</span><br><span class="line">    <span class="keyword">raise</span> OperationalError(<span class="string">'Connection already opened.'</span>)</span><br><span class="line">peewee.OperationalError: Connection already opened.</span><br></pre></td></tr></table></figure><p>为了阻止这个异常，可以添加参数 <code>reuse_if_open = True</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.connect()</span><br><span class="line">db.connect(reuse_if_open = <span class="literal">True</span>)</span><br></pre></td></tr></table></figure><blockquote><p>注意：如果数据库连接已打开，则返回 <code>False</code></p></blockquote><p>调用 <code>close()</code> 将关闭已打开的数据库连接，再次调用 <code>close()</code> 则只会返回 <code>False</code></p><blockquote><p>小提示：虽然在使用之前没必要显式连接到数据库，但时最好明确连接。这样如果连接失败，在打开的时候就可以捕获该异常，而不是执行数据库操作的时候。如果在使用数据库连接池。则需要调用 <code>connect()</code> 和 <code>close()</code> 以确保连接正确回收。</p></blockquote><p>Peewee 使用线程本地存储跟踪连接状态，使得 Peewee 数据库对象可以安全的用于多个线程，每个线程都拥有自己的连接。</p><p>数据库对象本身可以使用 <code>with</code> 上下文管理器，在上下文管理器中打开一个连接，在连接关闭之前提交，如果错误发生，这种情况下事务将回滚。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.is_closed()  <span class="comment"># True</span></span><br><span class="line"><span class="keyword">with</span> db:</span><br><span class="line">    print(db.is_closed())  <span class="comment"># False</span></span><br><span class="line"></span><br><span class="line">db.is_closed()  <span class="comment"># True</span></span><br></pre></td></tr></table></figure><p><code>connection_context()</code> 方法也可用于装饰器</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@db.connection_context()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">prepare_database</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="comment"># DB connection will be managed by the decorator, which opens</span></span><br><span class="line">    <span class="comment"># a connection, calls function, and closes upon returning.</span></span><br><span class="line">    db.create_tables(MODELS)  <span class="comment"># Create schema.</span></span><br><span class="line">    load_fixture_data(db)</span><br></pre></td></tr></table></figure><p>使用 <code>Database.connection()</code> 方法可以获取底层数据库驱动的原始对象。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.connection()</span><br><span class="line"><span class="comment"># &lt;sqlite3.Connection object at 0x0574DF20&gt;</span></span><br></pre></td></tr></table></figure><h4 id="连接池"><a href="#连接池" class="headerlink" title="连接池"></a>连接池</h4><p>连接池由 <code>Playhouse</code> 扩展库中包含的池模块提供</p><ul><li>超时后的连接收回</li><li>最大连接数上限</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playhouse.pool <span class="keyword">import</span> PooledMySQLDatabase</span><br><span class="line"></span><br><span class="line">db = PooledMySQLDatabase(</span><br><span class="line">    <span class="string">'my_database'</span>,</span><br><span class="line">    max_connections=<span class="number">8</span>,</span><br><span class="line">    stale_timeout=<span class="number">300</span>,</span><br><span class="line">    time_out=<span class="number">60</span>,</span><br><span class="line">    user=<span class="string">'root'</span>, </span><br><span class="line">    password=<span class="string">'db_password'</span>,</span><br><span class="line">    host=<span class="string">'10.1.0.8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br></pre></td></tr></table></figure><p>以下数据库连接池类可用：</p><ul><li><code>PooledPostgresqlDatabase</code></li><li><code>PooledPostgresqlExtDatabase</code></li><li><code>PooledMySQLDatabase</code></li><li><code>PooledSqliteDatabase</code></li><li><code>PooledSqliteExtDatabase</code></li></ul><h4 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h4><p>如果想直接执行 SQL 语句，可以使用 <code>Database.execute_sql()</code> 方法。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">db = SqliteDatabase(<span class="string">'my_app.db'</span>)</span><br><span class="line">db.connect()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of executing a simple query and ignoring the results.</span></span><br><span class="line">db.execute_sql(<span class="string">"ATTACH DATABASE ':memory:' AS cache;"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Example of iterating over the results of a query using the cursor.</span></span><br><span class="line">cursor = db.execute_sql(<span class="string">'SELECT * FROM users WHERE status = ?'</span>, (ACTIVE,))</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> cursor.fetchall():</span><br><span class="line">    <span class="comment"># Do something with row, which is a tuple containing column data.</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><h4 id="事务管理"><a href="#事务管理" class="headerlink" title="事务管理"></a>事务管理</h4><p>Peewee 提供了几个用于处理事务的接口，最常用的是 <code>Database.atomic()</code> 方法，它也支持嵌套事务。<br>如果包装块中发生异常，则当前事务将回滚，否则将提交。</p><p>而在 <code>atomic()</code> 上下文管理器包装的代码块内部时，可以通过调用 <code>Transaction.rollback()</code> 或者 <code>Transaction.commit()</code> 显性的回滚或提交事务。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db.atomic() <span class="keyword">as</span> transaction:  <span class="comment"># Opens new transaction.</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        save_some_objects()</span><br><span class="line">    <span class="keyword">except</span> ErrorSavingData:</span><br><span class="line">        <span class="comment"># Because this block of code is wrapped with "atomic", a</span></span><br><span class="line">        <span class="comment"># new transaction will begin automatically after the call</span></span><br><span class="line">        <span class="comment"># to rollback().</span></span><br><span class="line">        transaction.rollback()</span><br><span class="line">        error_saving = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    create_report(error_saving=error_saving)</span><br><span class="line">    <span class="comment"># Note: no need to call commit. Since this marks the end of the</span></span><br><span class="line">    <span class="comment"># wrapped block of code, the `atomic` context manager will</span></span><br><span class="line">    <span class="comment"># automatically call commit for us.</span></span><br></pre></td></tr></table></figure><p><code>atomic()</code> 不仅可以用作上下文管理器，还可用做装饰器</p><p>用作装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">db = SqliteDatabase(<span class="string">':memory:'</span>)</span><br><span class="line"><span class="keyword">with</span> db.atomic() <span class="keyword">as</span> txn:</span><br><span class="line">    <span class="comment"># This is the outer-most level, so this block corresponds to</span></span><br><span class="line">    <span class="comment"># a transaction.</span></span><br><span class="line">    User.create(username=<span class="string">'charlie'</span>)</span><br><span class="line">    <span class="keyword">with</span> db.atomic() <span class="keyword">as</span> nested_txn:</span><br><span class="line">        <span class="comment"># This block corresponds to a savepoint.</span></span><br><span class="line">        User.create(username=<span class="string">'huey'</span>)</span><br><span class="line">        <span class="comment"># This will roll back the above create() query.</span></span><br><span class="line">        nested_txn.rollback()</span><br><span class="line">    User.create(username=<span class="string">'mickey'</span>)</span><br><span class="line"><span class="comment"># When the block ends, the transaction is committed (assuming no error</span></span><br><span class="line"><span class="comment"># occurs). At that point there will be two users, "charlie" and "mickey".</span></span><br></pre></td></tr></table></figure></p><p>还可使用 <code>atomic()</code> 方法来获取或创建数据：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">with</span> db.atomic():</span><br><span class="line">        user = User.create(username=username)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Success'</span></span><br><span class="line"><span class="keyword">except</span> peewee.IntegrityError:</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Failure: %s is already in use.'</span> % username</span><br></pre></td></tr></table></figure></p><p>用作装饰器：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@db.atomic()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_user</span><span class="params">(username)</span>:</span></span><br><span class="line">    <span class="comment"># This statement will run in a transaction. If the caller is already</span></span><br><span class="line">    <span class="comment"># running in an `atomic` block, then a savepoint will be used instead.</span></span><br><span class="line">    <span class="keyword">return</span> User.create(username=username)</span><br><span class="line">create_user(<span class="string">'charlie'</span>)</span><br></pre></td></tr></table></figure></p><p>保存点：</p><p>可以像显式创建事务一样，也可以使用 <code>savepoint()</code> 方法显式创建保存点。保存点必须发生在一个事务中，但可以任意嵌套。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> db.transaction() <span class="keyword">as</span> txn:</span><br><span class="line">    <span class="keyword">with</span> db.savepoint() <span class="keyword">as</span> sp:</span><br><span class="line">        User.create(username=<span class="string">'mickey'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">with</span> db.savepoint() <span class="keyword">as</span> sp2:</span><br><span class="line">        User.create(username=<span class="string">'zaizee'</span>)</span><br><span class="line">        sp2.rollback()  <span class="comment"># "zaizee" will not be saved, but "mickey" will be.</span></span><br></pre></td></tr></table></figure><p>如果手动提交或回滚保存点，则不会自动创建新的保存点。这与事务的行为不同，它会在手动提交/回滚之后自动打开新的事务。</p><h4 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h4><p>所有查询都使用标准库 <code>logging</code> 模块记录到 peewee 命名空间。查询使用 <code>DEBUG</code> 级别。<br>如果你对查询有兴趣，你可以简单地注册一个处理程序。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Print all queries to stderr.</span></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logger = logging.getLogger(<span class="string">'peewee'</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line">logger.addHandler(logging.StreamHandler())</span><br></pre></td></tr></table></figure><h3 id="模型和字段"><a href="#模型和字段" class="headerlink" title="模型和字段"></a>模型和字段</h3><p>模型类、字段实例和模型实例都映射到了数据库</p><table><thead><tr><th>项</th><th>对应于</th></tr></thead><tbody><tr><td>模型类</td><td>数据库</td></tr><tr><td>字段实例</td><td>表中的列</td></tr><tr><td>模型实例</td><td>表中的行</td></tr></tbody></table><p>下面的例子演示了定义数据库连接和模型类的方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个数据库的实例</span></span><br><span class="line">db = SqliteDatabase(<span class="string">'my_app.db'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个指定数据库的基础模型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义模型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    username = CharField(unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 定义模型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tweet</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">'tweets'</span>)</span><br><span class="line">    message = TextField()</span><br><span class="line">    created_date = DateTimeField(default=datetime.datetime.now)</span><br><span class="line">    is_published = BooleanField(default=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><h4 id="字段"><a href="#字段" class="headerlink" title="字段"></a>字段</h4><p>字段类用于描述模型属性到数据库字段的映射，每一个字段类型都有一个相应的 SQL 存储类型，如 <code>varchar</code>, <code>int</code>。并且python的数据类型和 SQL 存储类型之间的转换是透明的。</p><p>在创建模型类时，字段被定义为类属性。有一种特殊类型的字段 <code>ForeignKeyField</code>，可以以更直观的方式表示模型之间的外键关系。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">'messages'</span>)</span><br><span class="line">    body = TextField()</span><br><span class="line">    send_date = DateTimeField()</span><br></pre></td></tr></table></figure><p>这允许你编写如下的代码：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print(some_message.user.username)</span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> some_user.messages:</span><br><span class="line">    print(message.body)</span><br></pre></td></tr></table></figure><h5 id="字段类型表"><a href="#字段类型表" class="headerlink" title="字段类型表"></a>字段类型表</h5><table><thead><tr><th>字段类型</th><th>Sqlite</th><th>Postgresql</th><th>MySQL</th></tr></thead><tbody><tr><td>IntegerField</td><td>integer</td><td>integer</td><td>integer</td></tr><tr><td>BigIntegerField</td><td>integer</td><td>bigint</td><td>bigint</td></tr><tr><td>SmallIntegerField</td><td>integer</td><td>smallint</td><td>smallint</td></tr><tr><td>AutoField</td><td>integer</td><td>serial</td><td>integer</td></tr><tr><td>FloatField</td><td>real</td><td>real</td><td>real</td></tr><tr><td>DoubleField</td><td>real</td><td>double precision</td><td>double precision</td></tr><tr><td>DecimalField</td><td>decimal</td><td>numeric</td><td>numeric</td></tr><tr><td>CharField</td><td>varchar</td><td>varchar</td><td>varchar</td></tr><tr><td>FixedCharField</td><td>char</td><td>char</td><td>char</td></tr><tr><td>TextField</td><td>text</td><td>text</td><td>longtext</td></tr><tr><td>BlobField</td><td>blob</td><td>bytea</td><td>blob</td></tr><tr><td>BitField</td><td>integer</td><td>bigint</td><td>bigint</td></tr><tr><td>BigBitField</td><td>blob</td><td>bytea</td><td>blob</td></tr><tr><td>UUIDField</td><td>text</td><td>uuid</td><td>varchar(40)</td></tr><tr><td>DateTimeField</td><td>datetime</td><td>timestamp</td><td>datetime</td></tr><tr><td>DateField</td><td>date</td><td>date</td><td>date</td></tr><tr><td>TimeField</td><td>time</td><td>time</td><td>time</td></tr><tr><td>TimestampField</td><td>integer</td><td>integer</td><td>integer</td></tr><tr><td>IPField</td><td>integer</td><td>bigint</td><td>bigint</td></tr><tr><td>BooleanField</td><td>integer</td><td>boolean</td><td>bool</td></tr><tr><td>BareField</td><td>untyped</td><td>不支持</td><td>不支持</td></tr><tr><td>ForeignKeyField</td><td>integer</td><td>integer</td><td>integer</td></tr></tbody></table><h5 id="字段初始参数"><a href="#字段初始参数" class="headerlink" title="字段初始参数"></a>字段初始参数</h5><p>所有字段类型接受的参数与默认值</p><ul><li><code>null = False</code> – 布尔值，表示是否允许存储空值</li><li><code>index = False</code> – 布尔值，表示是否在此列上创建索引</li><li><code>unique = False</code> – 布尔值，表示是否在此列上创建唯一索引</li><li><code>column_name = None</code> – 如果和属性名不同，底层的数据库字段使用这个值</li><li><code>default = None</code> – 字段默认值，可以是一个函数，将使用函数返回的值</li><li><code>primary_key = False</code> – 布尔值，此字段是否是主键</li><li><code>constraints = None</code> - 一个或多个约束的列表 例如：<code>[Check(&#39;price &gt; 0&#39;)]</code></li><li><code>sequence = None</code> – 序列填充字段（如果后端数据库支持）</li><li><code>collation = None</code> – 用于排序字段/索引的排序规则</li><li><code>unindexed = False</code> – 表示虚拟表上的字段应该是未索引的（仅用于sqlite）</li><li><code>choices = None</code> – 一个可选的迭代器，包含两元数组<code>（value, display）</code></li><li><code>help_text = None</code> – 表示字段的帮助文本</li><li><code>verbose_name = None</code> – 表示用户友好的字段名</li></ul><p>一些字段的特殊参数</p><table><thead><tr><th>字段类型</th><th>特殊参数</th></tr></thead><tbody><tr><td>CharField</td><td>max_length</td></tr><tr><td>FixedCharField</td><td>max_length</td></tr><tr><td>DateTimeField</td><td>formats</td></tr><tr><td>DateField</td><td>formats</td></tr><tr><td>TimeField</td><td>formats</td></tr><tr><td>TimestampField</td><td>resolution, utc</td></tr><tr><td>DecimalField</td><td>max_digits, decimal_places, auto_round, rounding</td></tr><tr><td>ForeignKeyField</td><td>model, field, backref, on_delete, on_update, extra</td></tr><tr><td>BareField</td><td>coerce</td></tr></tbody></table><h5 id="字段默认值"><a href="#字段默认值" class="headerlink" title="字段默认值"></a>字段默认值</h5><p>创建对象时，peewee 可以为字段提供默认值，例如将字段的默认值<code>null</code>设置为<code>0</code><br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    context = TextField()</span><br><span class="line">    read_count = IntegerField(default=<span class="number">0</span>)</span><br></pre></td></tr></table></figure></p><p>如果想提供一个动态值，比如当前时间，可以传入一个函数</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    context = TextField()</span><br><span class="line">    timestamp = DateTimeField(default=datetime.datetime.now)</span><br></pre></td></tr></table></figure><p>数据库还可以提供字段的默认值。虽然 peewee 没有明确提供设置服务器端默认值的 API，但您可以使用 <code>constraints</code> 参数来指定服务器默认值：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    context = TextField()</span><br><span class="line">    timestamp = DateTimeField(constraints=[SQL(<span class="string">'DEFAULT CURRENT_TIMESTAMP'</span>)])</span><br></pre></td></tr></table></figure><h5 id="外键字段"><a href="#外键字段" class="headerlink" title="外键字段"></a>外键字段</h5><p><code>foreignkeyfield</code> 是一种特殊的字段类型，允许一个模型引用另一个模型。通常外键将包含与其相关的模型的主键（但您可以通过指定一个字段来指定特定的列）。</p><p>可以通过追加 <code>_id</code> 的外键字段名称来访问原始外键值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tweets = Tweet.select()</span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> tweets:</span><br><span class="line">    <span class="comment"># Instead of "tweet.user", we will just get the raw ID value stored</span></span><br><span class="line">    <span class="comment"># in the column.</span></span><br><span class="line">    print(tweet.user_id, tweet.message)</span><br></pre></td></tr></table></figure><p><code>ForeignKeyField</code> 允许将反向引用属性绑定到目标模型。隐含地，这个属性将被命名为 <code>classname_set</code>，其中 classname 是类的小写名称，但可以通过参数覆盖 backref：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Message</span><span class="params">(Model)</span>:</span></span><br><span class="line">    from_user = ForeignKeyField(User)</span><br><span class="line">    to_user = ForeignKeyField(User, backref=<span class="string">'received_messages'</span>)</span><br><span class="line">    text = TextField()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> some_user.message_set:</span><br><span class="line">    <span class="comment"># We are iterating over all Messages whose from_user is some_user.</span></span><br><span class="line">    print(message)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> message <span class="keyword">in</span> some_user.received_messages:</span><br><span class="line">    <span class="comment"># We are iterating over all Messages whose to_user is some_user</span></span><br><span class="line">    print(message)</span><br></pre></td></tr></table></figure><h5 id="日期字段"><a href="#日期字段" class="headerlink" title="日期字段"></a>日期字段</h5><p><code>DateField</code> <code>TimeField</code> 和 <code>DateTimeField</code> 字段</p><p><code>DateField</code> 包含 <code>year</code> <code>month</code> <code>day</code><br><code>TimeField</code> 包含 <code>hour</code> <code>minute</code> <code>second</code><br><code>DateTimeField</code> 包含以上所有</p><h4 id="创建模型表"><a href="#创建模型表" class="headerlink" title="创建模型表"></a>创建模型表</h4><p>为了开始使用模型，它需要打开一个到数据库的连接并创建表。Peewee 将运行必要的 <code>CREATE TABLE</code> 查询，另外创建约束和索引。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Connect to our database.</span></span><br><span class="line">db.connect()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create the tables.</span></span><br><span class="line">db.create_tables([User, Tweet])</span><br></pre></td></tr></table></figure><p>默认情况下，Peewee 将确定表是否已经存在，并有条件地创建它们。如果你想禁用它，指定 <code>safe=False</code>。</p><h4 id="模型选项和表格元数据"><a href="#模型选项和表格元数据" class="headerlink" title="模型选项和表格元数据"></a>模型选项和表格元数据</h4><p>为了不污染模型空间，模型的配置被放置在名为 <code>Meta</code> 的特殊类中</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line">contacts_db = SqliteDatabase(<span class="string">'contacts.db'</span>)</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        database = contacts_db</span><br></pre></td></tr></table></figure><p>模型一旦定义，访问元数据应该访问 <code>ModelClass._meta</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Person._meta.fields</span><br><span class="line">Person._meta.primary_key</span><br><span class="line">Person._meta.database</span><br></pre></td></tr></table></figure><p>有几个选项可以指定为Meta属性。虽然大多数选项都是可继承的，但有些选项是特定于表的，不会被子类继承。</p><table><thead><tr><th>选项</th><th>含义</th><th>是否可继承</th></tr></thead><tbody><tr><td>database</td><td>模型的数据库</td><td>是</td></tr><tr><td>table_name</td><td>用于存储数据的表的名称</td><td>否</td></tr><tr><td>table_function</td><td>函数动态生成表名</td><td>是</td></tr><tr><td>indexes</td><td>要索引的字段列表</td><td>是</td></tr><tr><td>primary_key</td><td>一个 <code>CompositeKey</code> 实例</td><td>是</td></tr><tr><td>constraints</td><td>表约束列表</td><td>是</td></tr><tr><td>schema</td><td>模型的数据库概要</td><td>是</td></tr><tr><td>only_save_dirty</td><td>当调用 <code>model.save()</code> 时，只保存脏字段</td><td>是</td></tr><tr><td>options</td><td>用于创建表扩展选项的字典</td><td>是</td></tr><tr><td>table_alias</td><td>用于查询中的表的别名</td><td>否</td></tr><tr><td>depends_on</td><td>此表依赖于另一个表的创建</td><td>否</td></tr><tr><td>without_rowid</td><td>指示表不应该有rowid（仅限SQLite）</td><td>否</td></tr></tbody></table><p>不可被继承的例子</p><pre><code>&gt;&gt;&gt; db = SqliteDatabase(&apos;:memory:&apos;)&gt;&gt;&gt; class ModelOne(Model):...     class Meta:...         database = db...         table_name = &apos;model_one_tbl&apos;...&gt;&gt;&gt; class ModelTwo(ModelOne):...     pass...&gt;&gt;&gt; ModelOne._meta.database is ModelTwo._meta.databaseTrue&gt;&gt;&gt; ModelOne._meta.table_name == ModelTwo._meta.table_nameFalse</code></pre><p>自定义主键或者没有主键可以用 <code>CompositeKey</code> 或者将主键设置为 <code>False</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogToTag</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="string">"""A simple "through" table for many-to-many relationship."""</span></span><br><span class="line">    blog = ForeignKeyField(Blog)</span><br><span class="line">    tag = ForeignKeyField(Tag)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = CompositeKey(<span class="string">'blog'</span>, <span class="string">'tag'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NoPrimaryKey</span><span class="params">(Model)</span>:</span></span><br><span class="line">    data = IntegerField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = <span class="literal">False</span></span><br></pre></td></tr></table></figure><h4 id="索引和约束"><a href="#索引和约束" class="headerlink" title="索引和约束"></a>索引和约束</h4><p>Peewee 可以在单列或多列上创建索引，可以包含 <code>UNIQUE</code> 约束。Peewee 还在模型和字段上支持用户定义的约束。</p><h5 id="单列索引和约束"><a href="#单列索引和约束" class="headerlink" title="单列索引和约束"></a>单列索引和约束</h5><p>单列索引是使用字段初始化参数定义的。以下示例在用户名字段上添加唯一索引，并在电子邮件字段上添加常规索引：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">User</span> （<span class="title">Model</span> ）：</span></span><br><span class="line">    username  =  CharField （unique = True ）</span><br><span class="line">    email  =  CharField （index = <span class="literal">True</span> ）</span><br></pre></td></tr></table></figure><p>要在列上添加用户定义的约束，可以使用constraints参数传递它 。您可能希望将默认值指定为架构的一部分，或者添加一个 CHECK 约束，例如：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField(unique=<span class="literal">True</span>)</span><br><span class="line">    price = DecimalField(constraints=[Check(<span class="string">'price &lt; 10000'</span>)])</span><br><span class="line">    created = DateTimeField(</span><br><span class="line">        constraints=[SQL(<span class="string">"DEFAULT (datetime('now'))"</span>)])</span><br></pre></td></tr></table></figure><h5 id="多列索引"><a href="#多列索引" class="headerlink" title="多列索引"></a>多列索引</h5><p>多列索引可以使用嵌套元组定义为元属性。每个数据库索引都是一个两个元素的元组，第一部分是字段名称的元组，第二部分是布尔值，指示索引是否应该是唯一的。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Transaction</span><span class="params">(Model)</span>:</span></span><br><span class="line">    from_acct = CharField()</span><br><span class="line">    to_acct = CharField()</span><br><span class="line">    amount = DecimalField()</span><br><span class="line">    date = DateTimeField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        indexes = (</span><br><span class="line">            <span class="comment"># create a unique on from/to/date</span></span><br><span class="line">            ((<span class="string">'from_acct'</span>, <span class="string">'to_acct'</span>, <span class="string">'date'</span>), <span class="literal">True</span>),</span><br><span class="line">            <span class="comment"># create a non-unique on from/to</span></span><br><span class="line">            ((<span class="string">'from_acct'</span>, <span class="string">'to_acct'</span>), <span class="literal">False</span>),</span><br><span class="line">        )</span><br></pre></td></tr></table></figure><h5 id="创建高级索引"><a href="#创建高级索引" class="headerlink" title="创建高级索引"></a>创建高级索引</h5><p>Peewee 支持更结构化的 API，以便使用该 <code>Model.add_index()</code> 方法在模型上声明索引，或直接使用 <code>ModelIndexhelper</code> 类。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = TextField()</span><br><span class="line">    timestamp = TimestampField()</span><br><span class="line">    status = IntegerField()</span><br><span class="line">    flags = IntegerField()</span><br><span class="line"><span class="comment"># Add an index on "name" and "timestamp" columns.</span></span><br><span class="line">Article.add_index(Article.name, Article.timestamp)</span><br><span class="line"><span class="comment"># Add a partial index on name and timestamp where status = 1.</span></span><br><span class="line">Article.add_index(Article.name, Article.timestamp,</span><br><span class="line">                  where=(Article.status == <span class="number">1</span>))</span><br><span class="line"><span class="comment"># Create a unique index on timestamp desc, status &amp; 4.</span></span><br><span class="line">idx = Article.index(</span><br><span class="line">    Article.timestamp.desc(),</span><br><span class="line">    Article.flags.bin_and(<span class="number">4</span>),</span><br><span class="line">    unique=<span class="literal">True</span>)</span><br><span class="line">Article.add_index(idx)</span><br></pre></td></tr></table></figure><h5 id="表约束"><a href="#表约束" class="headerlink" title="表约束"></a>表约束</h5><p>Peewee允许您为您添加任意约束Model，这将在创建模式时成为表定义的一部分。</p><p>例如，假设您有一个具有两列组合主键的人员表格，即人员的姓名。您希望将另一个表与人员表相关联，为此，您需要定义一个外键约束：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Model)</span>:</span></span><br><span class="line">    first = CharField()</span><br><span class="line">    last = CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = CompositeKey(<span class="string">'first'</span>, <span class="string">'last'</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pet</span><span class="params">(Model)</span>:</span></span><br><span class="line">    owner_first = CharField()</span><br><span class="line">    owner_last = CharField()</span><br><span class="line">    pet_name = CharField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        constraints = [SQL(<span class="string">'FOREIGN KEY(owner_first, owner_last) '</span></span><br><span class="line">                           <span class="string">'REFERENCES person(first, last)'</span>)]</span><br></pre></td></tr></table></figure><p>也可以使用 <code>CHECK</code> 在表级别实施约束：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(Model)</span>:</span></span><br><span class="line">    name = CharField(unique=<span class="literal">True</span>)</span><br><span class="line">    price = DecimalField()</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        constraints = [Check(<span class="string">'price &lt; 10000'</span>)]</span><br></pre></td></tr></table></figure><h4 id="其他主键"><a href="#其他主键" class="headerlink" title="其他主键"></a>其他主键</h4><h5 id="非整数主键"><a href="#非整数主键" class="headerlink" title="非整数主键"></a>非整数主键</h5><p>如果想使用非整数主键，可以在创建字段时指定 <code>primary_key=True</code>。当希望使用非自动增量主键为模型创建新实例时，您需要确保 <code>save()</code> 指定 <code>force_insert=True</code>。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UUIDModel</span><span class="params">(Model)</span>:</span></span><br><span class="line">    id = UUIDField(primary_key=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><p>自动递增ID在新行插入数据库时​​会自动生成，当调用 <code>save()</code> 时 peewee 会根据主键值的存在性来确定是否执行 <code>insert</code> 和 <code>update</code>。由于在上一个例子中，数据库驱动程序不会生成新的ID，所以需要手动指定它。在第一次调用 <code>save()</code> 时，传入：<code>force_insert = True</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="comment"># This works because .create() will specify `force_insert=True`.</span></span><br><span class="line">obj1 = UUIDModel.create(id=uuid.uuid4())</span><br><span class="line"><span class="comment"># This will not work, however. Peewee will attempt to do an update:</span></span><br><span class="line">obj2 = UUIDModel(id=uuid.uuid4())</span><br><span class="line">obj2.save() <span class="comment"># WRONG</span></span><br><span class="line">obj2.save(force_insert=<span class="literal">True</span>) <span class="comment"># CORRECT</span></span><br><span class="line"><span class="comment"># Once the object has been created, you can call save() normally.</span></span><br><span class="line">obj2.save()</span><br></pre></td></tr></table></figure><h5 id="复合主键"><a href="#复合主键" class="headerlink" title="复合主键"></a>复合主键</h5><p>Peewee 对复合键有基本的支持。为了使用组合键，必须将 <code>primary_key</code> 模型选项的属性设置为一个 <code>CompositeKey</code> 实例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BlogToTag</span><span class="params">(Model)</span>:</span></span><br><span class="line">    <span class="string">"""A simple "through" table for many-to-many relationship."""</span></span><br><span class="line">    blog = ForeignKeyField(Blog)</span><br><span class="line">    tag = ForeignKeyField(Tag)</span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = CompositeKey(<span class="string">'blog'</span>, <span class="string">'tag'</span>)</span><br></pre></td></tr></table></figure><h6 id="手动指定主键"><a href="#手动指定主键" class="headerlink" title="手动指定主键"></a>手动指定主键</h6><p>有时不希望数据库自动为主键生成值，例如在批量加载关系数据时。要一次性处理这个问题，您可以简单地告诉 peewee <code>auto_increment</code> 在导入期间关闭：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">data = load_user_csv() <span class="comment"># load up a bunch of data</span></span><br><span class="line"></span><br><span class="line">User._meta.auto_increment = <span class="literal">False</span> <span class="comment"># turn off auto incrementing IDs</span></span><br><span class="line"><span class="keyword">with</span> db.transaction():</span><br><span class="line">    <span class="keyword">for</span> row <span class="keyword">in</span> data:</span><br><span class="line">        u = User(id=row[<span class="number">0</span>], username=row[<span class="number">1</span>])</span><br><span class="line">        u.save(force_insert=<span class="literal">True</span>) <span class="comment"># &lt;-- force peewee to insert row</span></span><br><span class="line"></span><br><span class="line">User._meta.auto_increment = <span class="literal">True</span></span><br></pre></td></tr></table></figure><p>如果想要始终控制主键，则不要使用 <code>PrimaryKeyField</code> 字段类型，而要使用正常 <code>IntegerField</code>（或其他列类型）：</p><pre><code>class User(BaseModel):    id = IntegerField(primary_key=True)    username = CharField()&gt;&gt;&gt; u = User.create(id=999, username=&apos;somebody&apos;)&gt;&gt;&gt; u.id999&gt;&gt;&gt; User.get(User.username == &apos;somebody&apos;).id999</code></pre><h5 id="没有主键的模型"><a href="#没有主键的模型" class="headerlink" title="没有主键的模型"></a>没有主键的模型</h5><p>如果你想创建一个没有主键的模型，你可以在内部类 <code>Meta</code> 中指定 ：<code>primary_key = False</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyData</span><span class="params">(BaseModel)</span>:</span></span><br><span class="line">    timestamp = DateTimeField()</span><br><span class="line">    value = IntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        primary_key = <span class="literal">False</span></span><br></pre></td></tr></table></figure><h3 id="更改和查询"><a href="#更改和查询" class="headerlink" title="更改和查询"></a>更改和查询</h3><p>本章将介绍在关系型数据库上执行 CRUD 操作</p><ul><li><code>Model.create()</code>，用于执行 INSERT 请求。</li><li><code>Model.save()</code> 和 <code>Model.update()</code> 执行 UPDATE 请求。</li><li><code>Model.delete_instance()</code> 和 <code>Model.delete()</code> 执行 DELETE 请求。</li><li><code>Model.select()</code>，用于执行 SELECT 请求。</li></ul><h4 id="创建一条新记录"><a href="#创建一条新记录" class="headerlink" title="创建一条新记录"></a>创建一条新记录</h4><p>可以使用 <code>Model.create()</code> 创建一个新的模型实例。此方法接受关键字参数，其中键与模型字段的名称相对应。返回一个新实例并将一行添加到表中。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">User.create(username=<span class="string">'Charlie'</span>)</span><br></pre></td></tr></table></figure><p>这将插入一行新数据到数据库中，主键将自动检索并存储在模型实例中。或者还可以先创建模型实例，然后调用 <code>save()</code></p><pre><code>&gt;&gt;&gt; user = User(username=&apos;Charlie&apos;)&gt;&gt;&gt; user.save()  # save() returns the number of rows modified.1&gt;&gt;&gt; user.id1&gt;&gt;&gt; huey = User()&gt;&gt;&gt; huey.username = &apos;Huey&apos;&gt;&gt;&gt; huey.save()1&gt;&gt;&gt; huey.id2</code></pre><p>当模型有外键时，可以在创建新记录时直接将模型实例分配给外键字段。</p><pre><code>&gt;&gt;&gt; tweet = Tweet.create(user=huey, message=&apos;Hello!&apos;)</code></pre><p>也可以使用相关对象主键的值：</p><pre><code>&gt;&gt;&gt; tweet = Tweet.create(user=2, message=&apos;Hello again!&apos;)</code></pre><p>如果只是想插入数据而不需要创建模型实例，则可以使用 <code>Model.insert()</code>：</p><pre><code>&gt;&gt;&gt; User.insert(username=&apos;Mickey&apos;).execute()3</code></pre><h4 id="批量插入"><a href="#批量插入" class="headerlink" title="批量插入"></a>批量插入</h4><p>可以通过调用 <code>insert_many()</code> 高效率的插入大量数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">data_source = [</span><br><span class="line">    &#123;<span class="string">'field1'</span>: <span class="string">'val1-1'</span>, <span class="string">'field2'</span>: <span class="string">'val1-2'</span>&#125;,</span><br><span class="line">    &#123;<span class="string">'field1'</span>: <span class="string">'val2-1'</span>, <span class="string">'field2'</span>: <span class="string">'val2-2'</span>&#125;,</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 最快的方法</span></span><br><span class="line">MyModel.insert_many(data_source).execute()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用元组 并指定插入的字段</span></span><br><span class="line">fields = [MyModel.field1, MyModel.field2]</span><br><span class="line">data = [(<span class="string">'val1-1'</span>, <span class="string">'val1-2'</span>),</span><br><span class="line">        (<span class="string">'val2-1'</span>, <span class="string">'val2-2'</span>),</span><br><span class="line">        (<span class="string">'val3-1'</span>, <span class="string">'val3-2'</span>)]</span><br><span class="line">MyModel.insert_many(data, fields=fields)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以包含在一个事务中</span></span><br><span class="line"><span class="keyword">with</span> db.atomic():</span><br><span class="line">    MyModel.insert_many(data, fields=fields)</span><br></pre></td></tr></table></figure><p>如果要批量加载的数据存储在另一个表中，则还可以创建其源为 SELECT 请求的 INSERT 请求。使用 方法：<code>Model.insert_from()</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query = (TweetArchive</span><br><span class="line">         .insert_from(</span><br><span class="line">             Tweet.select(Tweet.user, Tweet.message),</span><br><span class="line">             fields=[Tweet.user, Tweet.message])</span><br><span class="line">         .execute())</span><br></pre></td></tr></table></figure><h4 id="更新数据"><a href="#更新数据" class="headerlink" title="更新数据"></a>更新数据</h4><p>一旦模型具有主键，后续的任何 <code>save()</code> 都将导致 UPDATE 而不是 INSERT，该模型的主键不会改变。</p><pre><code>&gt;&gt;&gt; user.save()1&gt;&gt;&gt; user.id2&gt;&gt;&gt; user.username = &apos;Tom&apos;&gt;&gt;&gt; user.save()1&gt;&gt;&gt; user.id2</code></pre><p>如果想更新多条记录，使用 <code>Model.update()</code></p><pre><code>&gt;&gt;&gt; today = datetime.today()&gt;&gt;&gt; query = Tweet.update(is_published=True).where(Tweet.creation_date &lt; today)&gt;&gt;&gt; query.execute()  # Returns the number of rows that were updated.4</code></pre><h4 id="原子更新"><a href="#原子更新" class="headerlink" title="原子更新"></a>原子更新</h4><p>peewee 允许执行原子更新。假设需要更新计数器，天真的方法是这样写的：</p><pre><code>&gt;&gt;&gt; for stat in Stat.select().where(Stat.url == request.url):...     stat.counter += 1...     stat.save()</code></pre><p>这样速度不仅特别慢，如果多进程同时更新计数器，还会受到竞争条件的影响。可以使用 <code>update()</code> 自动更新计数器。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query = Stat.update(counter=Stat.counter + <span class="number">1</span>).where(Stat.url == request.url)</span><br><span class="line">query.execute()</span><br></pre></td></tr></table></figure><p>还可以使这些更新语句更复杂些。让我们给所有员工一个奖金，等于他们以前的奖金加上他们工资的10％：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query = Employee.update(bonus=(Employee.bonus + (Employee.salary * <span class="number">.1</span>)))</span><br><span class="line">query.execute()</span><br></pre></td></tr></table></figure><p>还可以使用子查询来更新值：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">subquery = Tweet.select(fn.COUNT(Tweet.id)).where(Tweet.user == User.id)</span><br><span class="line">update = User.update(num_tweets=subquery)</span><br><span class="line">update.execute()</span><br></pre></td></tr></table></figure><h4 id="删除记录"><a href="#删除记录" class="headerlink" title="删除记录"></a>删除记录</h4><p>要删除单个模型实例，可以使用 <code>Model.delete_instance()</code>，<code>delete_instance()</code> 方法将删除给定的模型实例，并可以递归删除任何依赖对象（指定 <code>recursive=True</code>）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = User.get(User.id == <span class="number">1</span>)</span><br><span class="line">user.delete_instance()</span><br></pre></td></tr></table></figure><p>要删除多行，可以使用删除命令：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query = Tweet.delete().where(Tweet.creation_date &lt; one_year_ago)</span><br><span class="line">query.execute()</span><br></pre></td></tr></table></figure><h4 id="查询一条记录-1"><a href="#查询一条记录-1" class="headerlink" title="查询一条记录"></a>查询一条记录</h4><p>可以使用 <code>Model.get()</code> 方法来检索查询匹配到的单个实例。对于主键查找，还可以使用快捷方式 <code>Model.get_by_id()</code>。如果没有查询到结果，将返回一个异常</p><pre><code>&gt;&gt;&gt; User.get(User.id == 1)&lt;__main__.User object at 0x25294d0&gt;&gt;&gt;&gt; User.get_by_id(1)  # Same as above.&lt;__main__.User object at 0x252df10&gt;&gt;&gt;&gt; User[1]  # Also same as above.&lt;__main__.User object at 0x252dd10&gt;&gt;&gt;&gt; User.get(User.id == 1).usernameu&apos;Charlie&apos;&gt;&gt;&gt; User.get(User.username == &apos;Charlie&apos;)&lt;__main__.User object at 0x2529410&gt;&gt;&gt;&gt; User.get(User.username == &apos;nobody&apos;)UserDoesNotExist: instance matching query does not exist:SQL: SELECT t1.&quot;id&quot;, t1.&quot;username&quot; FROM &quot;user&quot; AS t1 WHERE t1.&quot;username&quot; = ?PARAMS: [&apos;nobody&apos;]</code></pre><p>对于更高级的查询，可以使用 <code>SelectBase.get()</code>。</p><pre><code>&gt;&gt;&gt; (Tweet...  .select()...  .join(User)...  .where(User.username == &apos;charlie&apos;)...  .order_by(Tweet.created_date.desc())...  .get())&lt;__main__.Tweet object at 0x2623410&gt;</code></pre><h4 id="获取或创建"><a href="#获取或创建" class="headerlink" title="获取或创建"></a>获取或创建</h4><p>Peewee 有一个用于执行获取或者创建类型操作的方法 <code>Model.get_or_create()</code>，它首先尝试检索匹配的行，否则将创建一个新行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user, created = User.get_or_create(username=username)</span><br></pre></td></tr></table></figure><h4 id="选择多行"><a href="#选择多行" class="headerlink" title="选择多行"></a>选择多行</h4><p>可以使用 <code>Model.select()</code> 从表中检索多行，peewee 允许迭代以及检索和切片这些行</p><pre><code>&gt;&gt;&gt; query = User.select()&gt;&gt;&gt; [user.username for user in query][&apos;Charlie&apos;, &apos;Huey&apos;, &apos;Peewee&apos;]&gt;&gt;&gt; query[1]&lt;__main__.User at 0x7f83e80f5550&gt;&gt;&gt;&gt; query[1].username&apos;Huey&apos;&gt;&gt;&gt; query[:2][&lt;__main__.User at 0x7f83e80f53a8&gt;, &lt;__main__.User at 0x7f83e80f5550&gt;]</code></pre><p>除了返回模型实例之外，选择查询还可以返回字典，元组和命名集。</p><pre><code>&gt;&gt;&gt; query = User.select().dicts()&gt;&gt;&gt; for row in query:...     print(row){&apos;id&apos;: 1, &apos;username&apos;: &apos;Charlie&apos;}{&apos;id&apos;: 2, &apos;username&apos;: &apos;Huey&apos;}{&apos;id&apos;: 3, &apos;username&apos;: &apos;Peewee&apos;}</code></pre><h4 id="过滤"><a href="#过滤" class="headerlink" title="过滤"></a>过滤</h4><p>可以使用普通的Python操作符来过滤特定的记录。 Peewee 支持多种查询操作符。</p><pre><code>&gt;&gt;&gt; user = User.get(User.username == &apos;Charlie&apos;)&gt;&gt;&gt; for tweet in Tweet.select().where(Tweet.user == user, Tweet.is_published == True):...     print(tweet.user.username, &apos;-&gt;&apos;, tweet.message)...Charlie -&gt; hello worldCharlie -&gt; this is fun&gt;&gt;&gt; for tweet in Tweet.select().where(Tweet.created_date &lt; datetime.datetime(2011, 1, 1)):...     print(tweet.message, tweet.created_date)...Really old tweet 2010-01-01 00:00:00</code></pre><p>还可以使用 join 后过滤</p><pre><code>&gt;&gt;&gt; for tweet in Tweet.select().join(User).where(User.username == &apos;Charlie&apos;):...     print(tweet.message)hello worldthis is funlook at this picture of my food</code></pre><p>如果想表达复杂的逻辑，还可以使用 <code>|</code> 或者 <code>&amp;</code> 操作符</p><pre><code>&gt;&gt;&gt; Tweet.select().join(User).where(...     (User.username == &apos;Charlie&apos;) |...     (User.username == &apos;Peewee Herman&apos;))</code></pre><h4 id="排序-1"><a href="#排序-1" class="headerlink" title="排序"></a>排序</h4><p>要按顺序返回行，要使用 <code>order_by()</code> 方法</p><pre><code>&gt;&gt;&gt; for t in Tweet.select().order_by(Tweet.created_date):...     print(t.pub_date)...2010-01-01 00:00:002011-06-07 14:08:482011-06-07 14:12:57&gt;&gt;&gt; for t in Tweet.select().order_by(Tweet.created_date.desc()):...     print(t.pub_date)...2011-06-07 14:12:572011-06-07 14:08:482010-01-01 00:00:00</code></pre><p>还可以使用 <code>+</code> 和 <code>-</code> 前缀来指示排序：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># The following queries are equivalent:</span></span><br><span class="line">Tweet.select().order_by(Tweet.created_date.desc())</span><br><span class="line"></span><br><span class="line">Tweet.select().order_by(-Tweet.created_date)  <span class="comment"># Note the "-" prefix.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Similarly you can use "+" to indicate ascending order, though ascending</span></span><br><span class="line"><span class="comment"># is the default when no ordering is otherwise specified.</span></span><br><span class="line">User.select().order_by(+User.username)</span><br></pre></td></tr></table></figure><p>还可以使用 join 连接后排序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query = (Tweet</span><br><span class="line">         .select()</span><br><span class="line">         .join(User)</span><br><span class="line">         .order_by(User.username, Tweet.created_date.desc()))</span><br></pre></td></tr></table></figure><p>当对计算值进行排序时，可以包含必需的 sql 表达式，或者分配给该值别名。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Let's start with our base query. We want to get all usernames and the number of</span></span><br><span class="line"><span class="comment"># tweets they've made. We wish to sort this list from users with most tweets to</span></span><br><span class="line"><span class="comment"># users with fewest tweets.</span></span><br><span class="line">query = (User</span><br><span class="line">         .select(User.username, fn.COUNT(Tweet.id).alias(<span class="string">'num_tweets'</span>))</span><br><span class="line">         .join(Tweet, JOIN.LEFT_OUTER)</span><br><span class="line">         .group_by(User.username))</span><br></pre></td></tr></table></figure><p>还可以在 select 中使用 <code>COUNT</code> 表达式来排序</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">query = (User</span><br><span class="line">         .select(User.username, fn.COUNT(Tweet.id).alias(<span class="string">'num_tweets'</span>))</span><br><span class="line">         .join(Tweet, JOIN.LEFT_OUTER)</span><br><span class="line">         .group_by(User.username)</span><br><span class="line">         .order_by(fn.COUNT(Tweet.id).desc()))</span><br></pre></td></tr></table></figure><h4 id="获取随机记录"><a href="#获取随机记录" class="headerlink" title="获取随机记录"></a>获取随机记录</h4><p>偶尔可能想从数据库中提取一条随机记录，可以通过 <code>random</code> 或 <code>rand</code>（取决于你的数据库）来完成这个任务：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Postgresql and Sqlite use the Random function</span></span><br><span class="line"><span class="comment"># Pick 5 lucky winners:</span></span><br><span class="line">LotteryNumber.select().order_by(fn.Random()).limit(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># MySQL uses Rand:</span></span><br><span class="line"><span class="comment"># Pick 5 lucky winners:</span></span><br><span class="line">LotterNumber.select().order_by(fn.Rand()).limit(<span class="number">5</span>)</span><br></pre></td></tr></table></figure><h4 id="分页"><a href="#分页" class="headerlink" title="分页"></a>分页</h4><p><code>paginate()</code> 方法可以轻松对记录进行分页，<code>paginate()</code> 方法需要两个参数，<code>page_number</code>, 和 <code>items_per_page</code>。</p><pre><code>&gt;&gt;&gt; for tweet in Tweet.select().order_by(Tweet.id).paginate(2, 10):...     print(tweet.message)...tweet 10tweet 11tweet 12tweet 13tweet 14tweet 15tweet 16tweet 17tweet 18tweet 19</code></pre><h4 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h4><p>可以计算任何查询中选择的行数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;&gt;&gt; Tweet.select().count()</span><br><span class="line">100</span><br><span class="line">&gt;&gt;&gt; Tweet.select().where(Tweet.id &gt; 50).count()</span><br><span class="line">50</span><br></pre></td></tr></table></figure><h4 id="汇总"><a href="#汇总" class="headerlink" title="汇总"></a>汇总</h4><p>假设你有一些用户，并希望得到他们的列表以及每个人的推文数量。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">query = (User</span><br><span class="line">         .select(User, fn.Count(Tweet.id).alias(<span class="string">'count'</span>))</span><br><span class="line">         .join(Tweet, JOIN.LEFT_OUTER)</span><br><span class="line">         .group_by(User))</span><br></pre></td></tr></table></figure><h4 id="返回标量值"><a href="#返回标量值" class="headerlink" title="返回标量值"></a>返回标量值</h4><p>可以通过调用 <code>Query.scalar()</code> 来返回标量值：</p><pre><code>&gt;&gt;&gt; PageView.select(fn.Count(fn.Distinct(PageView.url))).scalar()100</code></pre><p>您可以通过传递 <code>as_tuple=true</code> 来返回多个标量值：</p><pre><code>&gt;&gt;&gt; Employee.select(...     fn.Min(Employee.salary), fn.Max(Employee.salary)... ).scalar(as_tuple=True)(30000, 50000)</code></pre><h4 id="SQL函数，子查询和原始表达式"><a href="#SQL函数，子查询和原始表达式" class="headerlink" title="SQL函数，子查询和原始表达式"></a>SQL函数，子查询和原始表达式</h4><p>要使用特殊的 SQL 函数，需要使用 <code>fn</code> 的对象来构造请求<br>假设要获取所有以字母 <code>a</code> 开头的用户列表：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Select the user's id, username and the first letter of their username, lower-cased</span></span><br><span class="line">first_letter = fn.LOWER(fn.SUBSTR(User.username, <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">query = User.select(User, first_letter.alias(<span class="string">'first_letter'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Alternatively we could select only users whose username begins with 'a'</span></span><br><span class="line">a_users = User.select().where(first_letter == <span class="string">'a'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> a_users:</span><br><span class="line">    print(user.username)</span><br></pre></td></tr></table></figure><p>有时候想传入一些任意的 SQL ，可以使用特殊的 SQL 类来做到这点</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># We'll query the user table and annotate it with a count of tweets for</span></span><br><span class="line"><span class="comment"># the given user</span></span><br><span class="line">query = (User</span><br><span class="line">         .select(User, fn.Count(Tweet.id).alias(<span class="string">'ct'</span>))</span><br><span class="line">         .join(Tweet)</span><br><span class="line">         .group_by(User))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now we will order by the count, which was aliased to "ct"</span></span><br><span class="line">query = query.order_by(SQL(<span class="string">'ct'</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># You could, of course, also write this as:</span></span><br><span class="line">query = query.order_by(fn.COUNT(Tweet.id))</span><br></pre></td></tr></table></figure><p>有两种方法可以用 peewee 执行手动编写的 SQL 语句：</p><ol><li><code>Database.execute_sql()</code> 用户执行任意类型的查询</li><li>用于执行 SELECT 查询和返回模型实例的 <code>RawQuery</code></li></ol><h4 id="安全和SQL注入"><a href="#安全和SQL注入" class="headerlink" title="安全和SQL注入"></a>安全和SQL注入</h4><p>默认情况下，peewee会参数化查询，所以用户传入的参数将被转义。这条规则唯一的例外是，如果你正在编写一个原始的 sql 查询或传入一个可能包含不可信数据的 sql 对象。为了减轻这一点，请确保任何用户定义的数据都作为查询参数传入，而不是实际的 sql 查询的一部分：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Bad! DO NOT DO THIS!</span></span><br><span class="line">query = MyModel.raw(<span class="string">'SELECT * FROM my_table WHERE data = %s'</span> % (user_data,))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Good. `user_data` will be treated as a parameter to the query.</span></span><br><span class="line">query = MyModel.raw(<span class="string">'SELECT * FROM my_table WHERE data = %s'</span>, user_data)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Bad! DO NOT DO THIS!</span></span><br><span class="line">query = MyModel.select().where(SQL(<span class="string">'Some SQL expression %s'</span> % user_data))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Good. `user_data` will be treated as a parameter.</span></span><br><span class="line">query = MyModel.select().where(SQL(<span class="string">'Some SQL expression %s'</span>, user_data))</span><br></pre></td></tr></table></figure><h4 id="返回元组-字典-名称元组"><a href="#返回元组-字典-名称元组" class="headerlink" title="返回元组/字典/名称元组"></a>返回元组/字典/名称元组</h4><p>有时候不需要创建模型实例的开销，只需要数据即可，可以使用：</p><ul><li>dicts()</li><li>namedtuples()</li><li>tuples()</li><li>objects() – 接受用行元组调用的任意构造函数。</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stats = (Stat</span><br><span class="line">         .select(Stat.url, fn.Count(Stat.url))</span><br><span class="line">         .group_by(Stat.url)</span><br><span class="line">         .tuples())</span><br><span class="line"></span><br><span class="line"><span class="comment"># iterate over a list of 2-tuples containing the url and count</span></span><br><span class="line"><span class="keyword">for</span> stat_url, stat_count <span class="keyword">in</span> stats:</span><br><span class="line">    print(stat_url, stat_count)</span><br></pre></td></tr></table></figure><p>同样也可以使用 <code>dicts()</code> 将数据作为字典返回</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">stats = (Stat</span><br><span class="line">         .select(Stat.url, fn.Count(Stat.url).alias(<span class="string">'ct'</span>))</span><br><span class="line">         .group_by(Stat.url)</span><br><span class="line">         .dicts())</span><br><span class="line"></span><br><span class="line"><span class="comment"># iterate over a list of 2-tuples containing the url and count</span></span><br><span class="line"><span class="keyword">for</span> stat <span class="keyword">in</span> stats:</span><br><span class="line">    print(stat[<span class="string">'url'</span>], stat[<span class="string">'ct'</span>])</span><br></pre></td></tr></table></figure><h3 id="查询操作符"><a href="#查询操作符" class="headerlink" title="查询操作符"></a>查询操作符</h3><p>Peewee 支持以下类型的比较：</p><table><thead><tr><th>对照</th><th>含义</th></tr></thead><tbody><tr><td>==</td><td>x 等于 y</td></tr><tr><td>&lt;</td><td>x 小于 y</td></tr><tr><td>&lt;=</td><td>x 小于或等于 y</td></tr><tr><td>></td><td>x 大于 y</td></tr><tr><td>>=</td><td>x 大于或等于 y</td></tr><tr><td>!=</td><td>x 不等于 y</td></tr><tr><td>&lt;&lt;</td><td>x IN y, y 是一个列表或查询</td></tr><tr><td>>&gt;</td><td>x IS y, 当 y 是 None 或者 NULL</td></tr><tr><td>%</td><td>x LIKE y, 当 y 可能包含通配符</td></tr><tr><td>**</td><td>x ILIKE y, 当 y 可能包含通配符</td></tr><tr><td>^</td><td>x XOR y</td></tr><tr><td>~</td><td>非 (例如：NOT x)</td></tr></tbody></table><p>还有一些查询可以用方法：</p><table border="1"><colgroup><col width="32%"><col width="68%"></colgroup><thead valign="bottom"><tr><th>方法</th><th>含义</th></tr></thead><tbody valign="top"><tr><td><code><span>.contains(substr)</span></code></td><td>通配符搜索子字符串</td></tr><tr><td><code><span>.startswith(prefix)</span></code></td><td>搜索以<code>prefix</code>为前缀的值</td></tr><tr><td><code><span>.endswith(suffix)</span></code></td><td>搜索以<code>suffix</code>为后缀的值</td></tr><tr><td><code><span>.between(low,</span><span>high)</span></code></td><td>搜索<code><span>low</span></code>和 <code><span>high</span></code>之间的值</td></tr><tr><td><code><span>.regexp(exp)</span></code></td><td>正则表达式匹配</td></tr><tr><td><code><span>.bin_and(value)</span></code></td><td>二进制 AND</td></tr><tr><td><code><span>.bin_or(value)</span></code></td><td>二进制 OR</td></tr><tr><td><code><span>.in_(value)</span></code></td><td>值是否属于</td></tr><tr><td><code><span>.not_in(value)</span></code></td><td>值是否不属于</td></tr><tr><td><code><span>.is_null(is_null)</span></code></td><td>是 NULL 或者不是 NULL </td></tr><tr><td><code><span>.concat(other)</span></code></td><td>连接两个字符串</td></tr><tr><td><code><span>.distinct()</span></code></td><td>标记不同的选择列</td></tr></tbody></table><p>要使用逻辑运算符来组合子句，使用：</p><table border="1"><colgroup><col width="18%"><col width="22%"><col width="60%"></colgroup><thead valign="bottom"><tr><th>操作符</th><th>意思</th><th>示例</th></tr></thead><tbody valign="top"><tr><td><code><span>&amp;</span></code></td><td>AND</td><td><code><span>(User.is_active</span><span>==</span><span>True)</span><span>&amp;</span><span>(User.is_admin</span><span>==</span><span>True)</span></code></td></tr><tr><td><code><span>|</span></code></td><td>OR</td><td><code><span>(User.is_admin)</span><span>|</span><span>(User.is_superuser)</span></code></td></tr><tr><td><code><span>~</span></code></td><td>NOT</td><td><code><span>~(User.username</span><span>&lt;&lt;</span><span>[‘foo’,</span><span>‘bar’,</span><span>‘baz’])</span></code></td></tr></tbody></table><p>如何使用查询操作符的示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Find the user whose username is "charlie".</span></span><br><span class="line">User.select().where(User.username == <span class="string">'charlie'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find the users whose username is in [charlie, huey, mickey]</span></span><br><span class="line">User.select().where(User.username &lt;&lt; [<span class="string">'charlie'</span>, <span class="string">'huey'</span>, <span class="string">'mickey'</span>])</span><br><span class="line"></span><br><span class="line">Employee.select().where(Employee.salary.between(<span class="number">50000</span>, <span class="number">60000</span>))</span><br><span class="line"></span><br><span class="line">Employee.select().where(Employee.name.startswith(<span class="string">'C'</span>))</span><br><span class="line"></span><br><span class="line">Blog.select().where(Blog.title.contains(search_string))</span><br></pre></td></tr></table></figure><p>这里是如何组合表达式的示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Find any users who are active administrations.</span></span><br><span class="line">User.select().where(</span><br><span class="line">  (User.is_admin == <span class="literal">True</span>) &amp;</span><br><span class="line">  (User.is_active == <span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find any users who are either administrators or super-users.</span></span><br><span class="line">User.select().where(</span><br><span class="line">  (User.is_admin == <span class="literal">True</span>) |</span><br><span class="line">  (User.is_superuser == <span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find any Tweets by users who are not admins (NOT IN).</span></span><br><span class="line">admins = User.select().where(User.is_admin == <span class="literal">True</span>)</span><br><span class="line">non_admin_tweets = Tweet.select().where(~(Tweet.user &lt;&lt; admins))</span><br><span class="line"></span><br><span class="line"><span class="comment"># Find any users who are not my friends (strangers).</span></span><br><span class="line">friends = User.select().where(User.username.in_([<span class="string">'charlie'</span>, <span class="string">'huey'</span>, <span class="string">'mickey'</span>]))</span><br><span class="line">strangers = User.select().where(User.id.not_in(friends))</span><br></pre></td></tr></table></figure><p>请记住：</p><ul><li>使用 <code>.in_()</code> 和 <code>.not_in()</code> 替换 <code>in</code> 和 <code>not in</code></li><li>使用 <code>&amp;</code> 替换 <code>and</code></li><li>使用 <code>|</code> 替换 <code>or</code></li><li>使用 <code>~</code> 替换 <code>not</code></li><li>使用 <code>.is_null()</code> 替换 <code>is None</code> 或者 <code>== None</code></li><li>在使用逻辑运算符时，不要忘记使用圆括号包含比较结果</li></ul><h4 id="用户自定义操作符"><a href="#用户自定义操作符" class="headerlink" title="用户自定义操作符"></a>用户自定义操作符</h4><p>如果发现自己需要的操作符不在上表中，可以非常容易的自定义操作符，比如取模运算</p><p>这里是如何在 SQLite 中添加取模运算的支持：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> Expression <span class="comment"># the building block for expressions</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mod</span><span class="params">(lhs, rhs)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> Expression(lhs, <span class="string">'%'</span>, rhs)</span><br></pre></td></tr></table></figure><p>现在可以将自定义运算符来构建更丰富的查询</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Users with even ids.</span></span><br><span class="line">User.select().where(mod(User.id, <span class="number">2</span>) == <span class="number">0</span>)</span><br></pre></td></tr></table></figure><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>Peewee 的详细使用说明请翻阅 <a href="http://docs.peewee-orm.com/en/latest/index.html" target="_blank" rel="noopener">Peewee官方文档</a></p>]]></content>
    
    <summary type="html">
    
      &lt;!-- created: 2018-03-13 10:12:00--&gt;
&lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Peewee 是Python的一款轻量级ORM框架。ORM 是对象-关系映射（Object-Relational Mapping），是一种为了解决面向对象与关系数据库存在的互不匹配的现象的技术。简单的说，ORM是通过使用描述对象和数据库之间映射的元数据，将程序中的对象自动持久化到关系数据库中。ORM 屏蔽了底层数据库操作的细节，使代码几乎不用修改即可支持不同的底层数据库存储。支持Python2.7和3.4以上的版本，内置对SQLite, MySQL和Postgresql的支持。本文通过阅读官方文档翻译而来。&lt;br&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/categories/Python/"/>
    
    
      <category term="python" scheme="http://www.yunfwe.cn/tags/python/"/>
    
      <category term="peewee" scheme="http://www.yunfwe.cn/tags/peewee/"/>
    
  </entry>
  
  <entry>
    <title>PHP基础学习</title>
    <link href="http://www.yunfwe.cn/2018/03/12/2018/PHP%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/"/>
    <id>http://www.yunfwe.cn/2018/03/12/2018/PHP%E5%9F%BA%E7%A1%80%E5%AD%A6%E4%B9%A0/</id>
    <published>2018-03-12T03:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.870Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>PHP全称PHP Hypertext Preprocessor，是一种通用开源脚本语言。语法吸收了C语言、Java和Perl的特点，利于学习，使用广泛，主要适用于Web开发领域。PHP 独特的语法混合了C、Java、Perl以及PHP自创的语法。它可以比CGI或者Perl更快速地执行动态网页。用PHP做出的动态页面与其他的编程语言相比，PHP是将程序嵌入到HTML文档中去执行，执行效率比完全生成HTML标记的CGI要高许多；PHP还可以执行编译后代码，编译可以达到加密和优化代码运行，使代码运行更快。<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="搭建Windows开发环境"><a href="#搭建Windows开发环境" class="headerlink" title="搭建Windows开发环境"></a>搭建Windows开发环境</h3><blockquote><p>系统环境为<code>Windows 10</code>，这里使用当前最新版，Windows版PHP下载地址为：<a href="http://windows.php.net/download/" target="_blank" rel="noopener">点此打开</a></p></blockquote><ul><li>当前最新版PHP为<code>7.2.3</code> <a href="http://windows.php.net/downloads/releases/php-7.2.3-nts-Win32-VC15-x64.zip" target="_blank" rel="noopener">点此下载</a></li><li>F盘中创建<code>phpstudy</code>目录</li><li>在<code>phpstudy</code>目录中创建<code>php-7.2.3</code>、<code>src</code>目录</li><li>将下载好的<code>php-7.2.3-nts-Win32-VC15-x64.zip</code>解压到<code>php-7.2.3</code>目录中</li><li>将<code>php-7.2.3</code>目录下的<code>php.ini-development</code>重命名为<code>php.ini</code></li><li>创建<code>start.bat</code>文件，并写入以下内容<figure class="highlight bat"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">F:\<span class="title">phpstudy</span>\<span class="title">php</span>-7.2.3\<span class="title">php.exe</span> -<span class="title">S</span> 127.0.0.1:8088 -<span class="title">t</span> <span class="title">F</span>:\<span class="title">phpstudy</span>\<span class="title">src</span></span></span><br></pre></td></tr></table></figure></li></ul><p>当前目录结构应该如下所示：<br><img src="/uploads/2018/php/ihpp259ge84l7z8a.png" alt></p><p>双击<code>start.bat</code>会打开一个cmd窗口 显示内容如下：</p><pre><code>F:\phpstudy&gt;F:\phpstudy\php-7.2.3\php.exe -S 127.0.0.1:8088 -t F:\phpstudy\srcPHP 7.2.3 Development Server started at Tue Mar  6 13:00:13 2018Listening on http://127.0.0.1:8088Document root is F:\phpstudy\srcPress Ctrl-C to quit.</code></pre><ul><li><p>在<code>src</code>目录下创建<code>phpinfo.php</code>文件，并写入以下内容</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    phpinfo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>打开浏览器访问: <code>http://127.0.0.1:8088/phpinfo.php</code> 出现如下信息 PHP开发环境就搭建完成了。<br><img src="/uploads/2018/php/n88y0ui8xb35a6p0.png" alt></p></li></ul><h2 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h2><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h3><h4 id="PHP标记"><a href="#PHP标记" class="headerlink" title="PHP标记"></a>PHP标记</h4><p>PHP只会解析文档中<code>&lt;?php ... ?&gt;</code>代码块的内容，其他的内容都会忽略</p><p>如果文件内容是纯PHP代码，最好在文件末尾删除PHP的结束标记，这样可以避免在PHP结束标记之后万一意外加入了空格或者换行符，会导致 PHP 开始输出这些空白，而脚本中此时并无输出的意图。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Hello World"</span>;</span><br><span class="line">    <span class="comment">// Other Code</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Last statement"</span></span><br><span class="line">    <span class="comment">// 脚本结束，不需要 <span class="meta">?&gt;</span> 作为结束标记</span></span><br></pre></td></tr></table></figure><p>PHP还有一种标记方式<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=<span class="string">"php"</span>&gt;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello World'</span>;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure></p><p>显然<code>&lt;?php ... ?&gt;</code>的方式更为方便</p><h4 id="嵌入到HTML文档"><a href="#嵌入到HTML文档" class="headerlink" title="嵌入到HTML文档"></a>嵌入到HTML文档</h4><p>因为PHP只会解析文档中的PHP标记，所以可以很方便的将PHP嵌入到HTML文档中<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;This is going to be ignored by PHP <span class="keyword">and</span> displayed by the browser.&lt;/p&gt;</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">echo</span> <span class="string">'While this is going to be parsed.'</span>; <span class="meta">?&gt;</span></span><br><span class="line">&lt;p&gt;This will also be ignored by PHP <span class="keyword">and</span> displayed by the browser.&lt;/p&gt;</span><br></pre></td></tr></table></figure></p><p>将文档保存为<code>src</code>目录下的<code>index.php</code>，然后浏览器访问<code>http://127.0.0.1:8088/</code>。<br>可以看到三条语句都被打印出来了，但是通过PHP的<code>echo</code>打印的语句需要先解析，所以速度肯定是比较慢的。</p><p>PHP解析器遇到<code>?&gt;</code>结束标记时就简单的将其后内容原样输出直到再碰到下一个<code>&lt;?php</code>标记。例外的是出于条件语句中间时，PHP解析器会根据条件判断来决定哪些输出，哪些跳过。如下所示：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> (<span class="keyword">true</span>): <span class="meta">?&gt;</span></span><br><span class="line">  This will show <span class="keyword">if</span> the expression is <span class="keyword">true</span>.</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">else</span>: <span class="meta">?&gt;</span></span><br><span class="line">  Otherwise this will show.</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>当<code>if</code>的条件为<code>true</code>时，输出<code>This will show if the expression is true.</code>，否则输出<code>Otherwise this will show.</code>。要输出大段文本时，跳出PHP解析模式通常比将文本通过<code>echo</code>或<code>print</code>输出更有效率。</p><h4 id="指令分隔符"><a href="#指令分隔符" class="headerlink" title="指令分隔符"></a>指令分隔符</h4><p>PHP和C或者Perl一样，每条语句的末尾使用分号结束指令。如果指令是PHP代码的最后一行，则可以省略掉分号。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"First line&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Last line"</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>如果想要省略掉<code>?&gt;</code> 则最后一行语句必须有分号<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"First line&lt;br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Last line"</span>;</span><br></pre></td></tr></table></figure></p><h4 id="注释"><a href="#注释" class="headerlink" title="注释"></a>注释</h4><p>PHP支持三种注释方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// This is a one-line c++ style comment</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line">This is a multi line comment</span><br><span class="line">yet another line of comment</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line"># This is a one-line shell-style comment</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure></p><h3 id="类型"><a href="#类型" class="headerlink" title="类型"></a>类型</h3><blockquote><p>PHP支持9种原始数据类型，其中有四种标量类型，三种复合类型，两种特殊类型</p></blockquote><h4 id="标量类型"><a href="#标量类型" class="headerlink" title="标量类型"></a>标量类型</h4><h5 id="boolean-布尔型"><a href="#boolean-布尔型" class="headerlink" title="boolean 布尔型"></a>boolean 布尔型</h5><p>要指定一个布尔值，使用常量<code>TRUE</code>和<code>FALSE</code>，两个都<strong>不区分大小写</strong>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="keyword">true</span>;</span><br><span class="line">$b = <span class="keyword">false</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>当整数和浮点数的零，空字符串，空数组，NULL，从空标记生成的SimpleXML对象转换为布尔型时 都会认为是FALSE，其他的值都被认为是TRUE</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump((bool) <span class="string">""</span>);</span><br><span class="line">var_dump((bool) <span class="number">0</span>);</span><br><span class="line">var_dump((bool) <span class="number">0.0</span>);</span><br><span class="line">var_dump((bool) []);</span><br><span class="line">var_dump((bool) <span class="keyword">NULL</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="integer-整型"><a href="#integer-整型" class="headerlink" title="integer 整型"></a>integer 整型</h5><p>所有的正整数和负整数都属于整数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a = 1234;          // 十进制数</span><br><span class="line">$a = -123;          // 负数</span><br><span class="line">$a = 0123;          // 八进制数 (等于十进制 83)</span><br><span class="line">$a = 0x1A;          // 十六进制数 (等于十进制 26)</span><br><span class="line">$a = 0b11111111;    // 二进制数字 (等于十进制 255)</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p>其他类型转为整数时，FALSE会转为0，TRUE会转为1，浮点型会向下取整。</p><p><strong>注意</strong>：32位平台整数最大为2147483647，64位平台整数最大为9223372036854775807。溢出后将自动转为浮点型。</p><h5 id="float-浮点型"><a href="#float-浮点型" class="headerlink" title="float 浮点型"></a>float 浮点型</h5><p>浮点型就是带小数位的数，可以用以下任一语法定义：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">1.234</span>; </span><br><span class="line">$b = <span class="number">1.2e3</span>; </span><br><span class="line">$c = <span class="number">7E-10</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h5 id="string-字符串"><a href="#string-字符串" class="headerlink" title="string 字符串"></a>string 字符串</h5><p>一个字符串就是由一系列的字符组成，其中每个字符等同于一个字节。这意味着PHP只能支持256的字符集，因此不支持Unicode 。</p><p>PHP的字符串有四种方式表达</p><ul><li>单引号</li><li>双引号</li><li>heredoc语法结构</li><li>nowdoc语法结构 (PHP 5.3.0 起)</li></ul><h6 id="单引号"><a href="#单引号" class="headerlink" title="单引号"></a>单引号</h6><p>定义一个字符串的最简单的方法是用单引号把它包围起来（字符 ‘）。</p><p>要表达一个单引号自身，需在它的前面加个反斜线（\）来转义。要表达一个反斜线自身，则用两个反斜线（\\）。其它任何方式的反斜线都会被当成反斜线本身：也就是说如果想使用其它转义序列例如 \r 或者 \n，并不代表任何特殊含义，就单纯是这两个字符本身。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'this is a simple string'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'You can also have embedded newlines in </span></span><br><span class="line"><span class="string">strings this way as it is</span></span><br><span class="line"><span class="string">okay to do'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Arnold once said: "I\'ll be back"'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'You deleted C:\\*.*?'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'You deleted C:\*.*?'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'This will not expand: \n a newline'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Variables do not $expand $either'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>this is a simple stringYou can also have embedded newlines in strings this way as it is okay to doArnold once said: &quot;I&apos;ll be back&quot;You deleted C:\*.*?You deleted C:\*.*?This will not expand: \n a newlineVariables do not $expand $either</code></pre><h6 id="双引号"><a href="#双引号" class="headerlink" title="双引号"></a>双引号</h6><p>如果字符串是包围在双引号<code>(&quot;)</code>中， PHP 将对一些特殊的字符进行解析：</p><center><strong>转义字符</strong></center><table><thead><tr><th width="180">序列</th><th>含义</th></tr></thead><tbody><tr><td>\n</td><td>换行（ASCII 字符集中的 LF 或 0x0A）</td></tr><tr><td>\r</td><td>回车（ASCII 字符集中的 CR 或 0x0D）</td></tr><tr><td>\t</td><td>水平制表符（ASCII 字符集中的 HT 或 0x09）</td></tr><tr><td>\v</td><td>垂直制表符（ASCII 字符集中的 VT 或 0x0B）（自PHP 5.2.5 起）</td></tr><tr><td>\e</td><td>Escape（ASCII 字符集中的 ESC 或 0x1B）（自PHP 5.4.0 起）</td></tr><tr><td>\f</td><td>换页（ASCII 字符集中的 FF 或 0x0C）（自PHP 5.2.5 起）</td></tr><tr><td>\</td><td>反斜线</td></tr><tr><td>\$</td><td>美元标记</td></tr><tr><td>\”</td><td>双引号</td></tr><tr><td>[0-7]{1,3}</td><td>符合该正则表达式序列的是一个以八进制方式来表达的字符</td></tr><tr><td>\x[0-9A-Fa-f]{1,2}</td><td>符合该正则表达式序列的是一个以十六进制方式来表达的字符</td></tr></tbody></table><p>用双引号定义的字符串最重要的特征是变量会被解析</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"World"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Hello $a"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Hello World</code></pre><h6 id="Heredoc结构"><a href="#Heredoc结构" class="headerlink" title="Heredoc结构"></a>Heredoc结构</h6><p>第三种表达字符串的方法是用 heredoc 句法结构：<code>&lt;&lt;&lt;</code>。在该运算符之后要提供一个标识符，然后换行。接下来是字符串 string 本身，最后要用前面定义的标识符作为结束标志。</p><p>结束时所引用的标识符必须在该行的第一列，而且，标识符的命名也要像其它标签一样遵守 PHP 的规则：只能包含字母、数字和下划线，并且必须以字母和下划线作为开头。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = <span class="string">&lt;&lt;&lt;END</span></span><br><span class="line"><span class="string">Example of string</span></span><br><span class="line"><span class="string">spanning multiple lines&lt;/br&gt;</span></span><br><span class="line"><span class="string">END;</span></span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"></span><br><span class="line">$name = <span class="string">'MyName'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;END</span></span><br><span class="line"><span class="string">My name is <span class="subst">$name</span>.</span></span><br><span class="line"><span class="string">END;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Example of string spanning multiple lines.My name is MyName.</code></pre><p>自 PHP 5.3.0 起还可以在 Heredoc 结构中用双引号来声明标识符：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;"FOOBAR"</span></span><br><span class="line"><span class="string">Hello World!</span></span><br><span class="line"><span class="string">FOOBAR;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h6 id="Nowdoc-结构"><a href="#Nowdoc-结构" class="headerlink" title="Nowdoc 结构"></a>Nowdoc 结构</h6><p>就象 heredoc 结构类似于双引号字符串，Nowdoc 结构是类似于单引号字符串的。Nowdoc 结构很象 heredoc 结构，但是 nowdoc 中不进行解析操作。</p><p>一个 nowdoc 结构也用和 heredocs 结构一样的标记<code>&lt;&lt;&lt;</code>， 但是跟在后面的标识符要用单引号括起来，即<code>&lt;&lt;&lt;&#39;END&#39;</code>。Heredoc 结构的所有规则也同样适用于 Nowdoc 结构，尤其是结束标识符的规则。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = <span class="string">&lt;&lt;&lt;'END'</span></span><br><span class="line"><span class="string">Example of string</span></span><br><span class="line"><span class="string">spanning multiple lines&lt;/br&gt;</span></span><br><span class="line"><span class="string">END;</span></span><br><span class="line"><span class="keyword">echo</span> $str;</span><br><span class="line"></span><br><span class="line">$name = <span class="string">'MyName'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;'END'</span></span><br><span class="line"><span class="string">My name is <span class="subst">$name</span>.</span></span><br><span class="line"><span class="string">END;</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Example of string spanning multiple linesMy name is $name.</code></pre><h6 id="变量解析"><a href="#变量解析" class="headerlink" title="变量解析"></a>变量解析</h6><p>当使用双引号或者Heredoc结构定义时，其中的变量将会解析。</p><p>变量解析有两种语法规则，一种简单规则，一种复杂规则。简单规则最常见和方便，它可以用最少的代码在一个string中嵌入一个变量、一个array的值、或一个object的属性。</p><p>复杂规则是用花括号包围的表达式。</p><p><strong>简单规则</strong></p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$name = <span class="string">'Tom'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Hello $name&lt;/br&gt;"</span>;</span><br><span class="line">$juices = <span class="keyword">array</span>(<span class="string">"apple"</span>, <span class="string">"orange"</span>, <span class="string">"koolaid1"</span> =&gt; <span class="string">"purple"</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"He drank some $juices[0] juice.&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"He drank some $juices[koolaid1] juice.&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">people</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $john = <span class="string">"John Smith"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$people = <span class="keyword">new</span> people();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"My name is $people-&gt;john."</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Hello TomHe drank some apple juice.He drank some purple juice.My name is John Smith.</code></pre><p><strong>复杂规则</strong></p><p>复杂语法不是因为其语法复杂而得名，而是因为它可以使用复杂的表达式。</p><p>任何具有 string 表达的标量变量，数组单元或对象属性都可使用此语法。只需简单地像在 string 以外的地方那样写出表达式，然后用花括号把它括起来即可。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$name = &apos;Tom&apos;;</span><br><span class="line">echo &quot;Hello &#123;$name&#125;&lt;/br&gt;&quot;;</span><br><span class="line">$juices = array(&quot;apple&quot;, &quot;orange&quot;, &quot;koolaid1&quot; =&gt; &quot;purple&quot;);</span><br><span class="line">echo &quot;He drank some &#123;$juices[0]&#125; juice.&lt;/br&gt;&quot;;</span><br><span class="line">echo &quot;He drank some &#123;$juices[&apos;koolaid1&apos;]&#125; juice.&lt;/br&gt;&quot;;</span><br><span class="line"></span><br><span class="line">class people &#123;</span><br><span class="line">    public $john = &quot;John Smith&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$people = new people();</span><br><span class="line">echo &quot;My name is &#123;$people-&gt;john&#125;.&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure><p><strong>注意</strong>：只有通过花括号才能正确解析带引号的键名<code>{$juices[&#39;koolaid1&#39;]}</code></p><p>输出：</p><pre><code>Hello TomHe drank some apple juice.He drank some purple juice.My name is John Smith.</code></pre><h6 id="存取和修改字符串"><a href="#存取和修改字符串" class="headerlink" title="存取和修改字符串"></a>存取和修改字符串</h6><p>string 中的字符可以通过一个从 0 开始的下标，用类似 array 结构中的方括号包含对应的数字来访问和修改，比如 <code>$str[42]</code>。可以把 string 当成字符组成的 array。函数 <code>substr()</code> 和 <code>substr_replace()</code> 可用于操作多于一个字符的情况。</p><p>小提示：string 也可用花括号访问，比如 <code>$str{42}</code>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$str = <span class="string">'This is a test'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"First: $str[1]&lt;/br&gt;"</span>;</span><br><span class="line">$last = $str[strlen($str)<span class="number">-1</span>];</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Last: $last&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$str = <span class="string">'Look at the sea'</span>;</span><br><span class="line">$str[strlen($str)<span class="number">-1</span>] = <span class="string">'e'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$str"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>First: hLast: tLook at the see</code></pre><h4 id="复合类型"><a href="#复合类型" class="headerlink" title="复合类型"></a>复合类型</h4><h5 id="array-数组"><a href="#array-数组" class="headerlink" title="array 数组"></a>array 数组</h5><p>PHP 中的数组实际上是一个有序映射。映射是一种把 values 关联到 keys 的类型。此类型在很多方面做了优化，因此可以把它当成真正的数组，或列表（向量），散列表（是映射的一种实现），字典，集合，栈，队列以及更多可能性。由于数组元素的值也可以是另一个数组，树形结构和多维数组也是允许的。</p><p>定义数组：可以用 <code>array()</code> 语言结构来新建一个数组。它接受任意数量用逗号分隔的 <code>键（key） =&gt; 值（value）</code>对。</p><p>数组的键可以是一个整数或字符串，值可以是任意类型的值。自 5.4 开始可以使用<code>[]</code>代替<code>array()</code>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$array = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">"foo"</span> =&gt; <span class="string">"bar"</span>,</span><br><span class="line">    <span class="string">"bar"</span> =&gt; <span class="string">"foo"</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自 5.4 开始</span></span><br><span class="line">$array = [</span><br><span class="line">    <span class="string">"foo"</span> =&gt; <span class="string">"bar"</span>,</span><br><span class="line">    <span class="string">"bar"</span> =&gt; <span class="string">"foo"</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有键名的索引数组</span></span><br><span class="line">$array = [<span class="string">"foo"</span>, <span class="string">"bar"</span>, <span class="number">6</span>=&gt;<span class="string">"hello"</span>, <span class="string">"world"</span>];</span><br><span class="line">var_dump($array);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>如果键名重复，则会使用最后一个键名，前面的都被覆盖了。没有键名的索引数组，键名默认从0开始，如果只对部分单元指定键名，其后面的键名会根据这个单元的键名开始。</p><p>输出：</p><pre><code>array(4) {     [0]=&gt; string(3) &quot;foo&quot;     [1]=&gt; string(3) &quot;bar&quot;     [6]=&gt; string(5) &quot;hello&quot;     [7]=&gt; string(5) &quot;world&quot; }</code></pre><p>使用方括号访问和修改数组单元</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$array = <span class="keyword">array</span>(</span><br><span class="line">    <span class="string">"foo"</span> =&gt; <span class="string">"bar"</span>,</span><br><span class="line">    <span class="number">42</span>    =&gt; <span class="number">24</span>,</span><br><span class="line">    <span class="string">"multi"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">         <span class="string">"dimensional"</span> =&gt; <span class="keyword">array</span>(</span><br><span class="line">             <span class="string">"array"</span> =&gt; <span class="string">"foo"</span></span><br><span class="line">         )</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\$array['foo'] = &#123;$array['foo']&#125;&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\$array[42] = $array[42]&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\$array['multi']['dimensional']['array'] = </span></span><br><span class="line"><span class="string">    &#123;$array['multi']['dimensional']['array']&#125;&lt;/br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>$array[&apos;foo&apos;] = bar$array[42] = 24$array[&apos;multi&apos;][&apos;dimensional&apos;][&apos;array&apos;] = foo</code></pre><p>小提示：和字符串一样 数组也可以使用花括号访问单元 例如 <code>array{&#39;foo&#39;}</code></p><p>要修改某个值，通过其键名给该单元赋一个新值，要删除某个键值对，对其调用<code>unset()</code>函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="number">5</span> =&gt; <span class="number">1</span>, <span class="number">12</span> =&gt; <span class="number">2</span>);</span><br><span class="line">$arr[] = <span class="number">56</span>;    <span class="comment">// This is the same as $arr[13] = 56;</span></span><br><span class="line">                <span class="comment">// at this point of the script</span></span><br><span class="line">$arr[<span class="string">"x"</span>] = <span class="number">42</span>; <span class="comment">// This adds a new element to</span></span><br><span class="line">                <span class="comment">// the array with key "x"       </span></span><br><span class="line"><span class="keyword">unset</span>($arr[<span class="number">5</span>]); <span class="comment">// This removes the element from the array</span></span><br><span class="line"><span class="keyword">unset</span>($arr);    <span class="comment">// This deletes the whole array</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="object-对象"><a href="#object-对象" class="headerlink" title="object 对象"></a>object 对象</h5><p>要创建一个新的对象 object，使用 new 语句实例化一个类：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">do_foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Doing foo."</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$bar = <span class="keyword">new</span> foo;</span><br><span class="line">$bar-&gt;do_foo();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="callable-可调用"><a href="#callable-可调用" class="headerlink" title="callable 可调用"></a>callable 可调用</h5><p>一些函数如 <code>call_user_func()</code> 或 <code>usort()</code> 可以接受用户自定义的回调函数作为参数。回调函数不止可以是简单函数，还可以是对象的方法，包括静态类方法。除了普通的用户自定义函数外，也可传递匿名函数给回调参数。</p><h4 id="特殊类型"><a href="#特殊类型" class="headerlink" title="特殊类型"></a>特殊类型</h4><h5 id="resource-资源"><a href="#resource-资源" class="headerlink" title="resource 资源"></a>resource 资源</h5><p>资源 resource 是一种特殊变量，保存了到外部资源的一个引用。资源是通过专门的函数来建立和使用的。由于资源类型变量保存有为打开文件、数据库连接、图形画布区域等的特殊句柄，因此将其它类型的值转换为资源没有意义。引用计数系统是 Zend 引擎的一部分，可以自动检测到一个资源不再被引用了（和 Java 一样）。这种情况下此资源使用的所有外部资源都会被垃圾回收系统释放。因此，很少需要手工释放内存。</p><h5 id="NULL-无类型"><a href="#NULL-无类型" class="headerlink" title="NULL 无类型"></a>NULL 无类型</h5><p>特殊的 NULL 值表示一个变量没有值。NULL 类型唯一可能的值就是 NULL。</p><p>在下列情况下一个变量被认为是 NULL：</p><ul><li>被赋值为 NULL。</li><li>尚未被赋值。</li><li>被 unset()。</li></ul><p>PHP 包括几个函数可以判断变量的类型，例如：<code>gettype()</code>，<code>is_array()</code>，<code>is_float()</code>，<code>is_int()</code>，<code>is_object()</code> 和 <code>is_string()</code></p><h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><p>PHP 中的变量用一个美元符号后面跟变量名来表示。变量名是区分大小写的。<code>$this</code> 是一个特殊的变量，它不能被赋值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$var = <span class="string">'Bob'</span>;</span><br><span class="line">$Var = <span class="string">'Joe'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$var, $Var"</span>;      <span class="comment">// 输出 "Bob, Joe"</span></span><br><span class="line"></span><br><span class="line">$<span class="number">4</span>site = <span class="string">'not yet'</span>;     <span class="comment">// 非法变量名；以数字开头</span></span><br><span class="line">$_4site = <span class="string">'not yet'</span>;    <span class="comment">// 合法变量名；以下划线开头</span></span><br><span class="line">$i站点is = <span class="string">'mansikka'</span>;  <span class="comment">// 合法变量名；可以用中文</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>PHP 也提供了另外一种方式给变量赋值：引用赋值。这意味着新的变量简单的引用了原始变量。改动新的变量将影响到原始变量，反之亦然。<br>使用引用赋值，简单地将一个 <code>&amp;</code> 符号加到将要赋值的变量前。例如，下列代码片断将输出“My name is Bob”两次：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$foo = <span class="string">'Bob'</span>;              <span class="comment">// 将 'Bob' 赋给 $foo</span></span><br><span class="line">$bar = &amp;$foo;              <span class="comment">// 通过 $bar 引用 $foo</span></span><br><span class="line">$bar = <span class="string">"My name is $bar"</span>;  <span class="comment">// 修改 $bar 变量</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$bar&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $foo;                 <span class="comment">// $foo 的值也被修改</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="预定义变量"><a href="#预定义变量" class="headerlink" title="预定义变量"></a>预定义变量</h4><p>对于全部脚本而言，PHP 提供了大量的预定义变量。这些变量将所有的外部变量表示成内建环境变量，并且将错误信息表示成返回头。</p><ul><li>超全局变量 — 超全局变量是在全部作用域中始终可用的内置变量</li><li>$GLOBALS — 引用全局作用域中可用的全部变量</li><li>$_SERVER — 服务器和执行环境信息</li><li>$_GET — HTTP GET 变量</li><li>$_POST — HTTP POST 变量</li><li>$_FILES — HTTP 文件上传变量</li><li>$_REQUEST — HTTP Request 变量</li><li>$_SESSION — Session 变量</li><li>$_ENV — 环境变量</li><li>$_COOKIE — HTTP Cookies</li><li>$php_errormsg — 前一个错误信息</li><li>$HTTP_RAW_POST_DATA — 原生POST数据</li><li>$http_response_header — HTTP 响应头</li><li>$argc — 传递给脚本的参数数目</li><li>$argv — 传递给脚本的参数数组</li></ul><h4 id="变量范围"><a href="#变量范围" class="headerlink" title="变量范围"></a>变量范围</h4><p>一个局部函数范围将被引入。任何用于函数内部的变量按缺省情况将被限制在局部函数范围内。例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">1</span>; <span class="comment">/* global scope */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $a; <span class="comment">/* reference to local scope variable */</span></span><br><span class="line">&#125;</span><br><span class="line">Test();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这个脚本不会有任何输出，因为 echo 语句引用了一个局部版本的变量 $a，而且在这个范围内，它并没有被赋值。你可能注意到 PHP 的全局变量和 C 语言有一点点不同，在 C 语言中，全局变量在函数中自动生效，除非被局部变量覆盖。这可能引起一些问题，有些人可能不小心就改变了一个全局变量。PHP 中全局变量在函数中使用时必须声明为 <code>global</code>。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">1</span>;</span><br><span class="line">$b = <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sum</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $a, $b;</span><br><span class="line">    $b = $a + $b;</span><br><span class="line">&#125;</span><br><span class="line">Sum();</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在全局范围内访问变量的第二个办法，是用特殊的 PHP 自定义<code>$GLOBALS</code> 数组。前面的例子可以写成：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Sum</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $GLOBALS[<span class="string">'b'</span>] = $GLOBALS[<span class="string">'a'</span>] + $GLOBALS[<span class="string">'b'</span>];</span><br><span class="line">&#125;</span><br><span class="line">Sum();</span><br><span class="line"><span class="keyword">echo</span> $b;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><code>$GLOBALS</code> 是一个关联数组，每一个变量为一个元素，键名对应变量名，值对应变量的内容。<code>$GLOBALS</code> 之所以在全局范围内存在，是因为 <code>$GLOBALS</code> 是一个超全局变量。</p><h4 id="可变变量"><a href="#可变变量" class="headerlink" title="可变变量"></a>可变变量</h4><p>可变变量，就是一个变量的变量名可以动态的设置和使用。语法形式是PHP的特殊语法，其他语言中少见。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">'hello'</span>;</span><br><span class="line">$$a = <span class="string">'world'</span>;  <span class="comment">// 相当于$hello = 'world'</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$a $&#123;$a&#125;&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"$a $hello"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>hello worldhello world</code></pre><h4 id="来自PHP之外的变量"><a href="#来自PHP之外的变量" class="headerlink" title="来自PHP之外的变量"></a>来自PHP之外的变量</h4><h5 id="HTML表单（GET和POST）"><a href="#HTML表单（GET和POST）" class="headerlink" title="HTML表单（GET和POST）"></a>HTML表单（GET和POST）</h5><p>当一个表单提交给 PHP 脚本时，表单中的信息会自动在脚本中可用。有很多方法访问此信息，例如：</p><p>test.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"welcome.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        E-mail: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"email"</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>welcome.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    Welcome <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">"name"</span>]; <span class="meta">?&gt;</span>&lt;br&gt;</span><br><span class="line">    Your email address is: <span class="meta">&lt;?php</span> <span class="keyword">echo</span> $_POST[<span class="string">"email"</span>]; <span class="meta">?&gt;</span></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>访问 <code>http://127.0.0.1:8088/test.html</code>，输入信息后提交，可以看到跳转到了<code>http://127.0.0.1:8088/welcome.php</code>页面，并且前面输入的数据已经被PHP通过<code>_POST</code>获取了。</p><p>GET也类似，只需要将<code>test.html</code>中的<code>method=&quot;post&quot;</code>改为<code>method=&quot;get&quot;</code>，然后将<code>welcome.php</code>中的<code>$_POST</code>改为<code>$_GET</code>就可以了。但是在上传敏感数据的时候比如用户密码时最好使用POST方法，GET方法会将数据编码到URL上，这样其他用户也可能会获取密码信息了。</p><h5 id="IMAGE-SUBMIT-变量名"><a href="#IMAGE-SUBMIT-变量名" class="headerlink" title="IMAGE SUBMIT 变量名"></a>IMAGE SUBMIT 变量名</h5><p>当提交表单时，可以用一幅图像代替标准的提交按钮，用类似这样的标记：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"image"</span> <span class="attr">src</span>=<span class="string">"image.gif"</span> <span class="attr">name</span>=<span class="string">"sub"</span> /&gt;</span></span><br></pre></td></tr></table></figure><p>当用户点击到图像中的某处时，相应的表单会被传送到服务器，并加上两个变量 sub_x 和 sub_y。它们包含了用户点击图像的坐标。有经验的用户可能会注意到被浏览器发送的实际变量名包含的是一个点而不是下划线（即 sub.x 和 sub.y），但 PHP 自动将点转换成了下划线。</p><h5 id="HTTP-Cookies"><a href="#HTTP-Cookies" class="headerlink" title="HTTP Cookies"></a>HTTP Cookies</h5><p>使用<code>$_COOKIE</code>可以获取HTTP Cookies数据，在获取前可以使用<code>setcookie()</code>函数设定cookies。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>($_COOKIE[<span class="string">'count'</span>])) &#123;</span><br><span class="line">    $count = $_COOKIE[<span class="string">'count'</span>] + <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $count = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">setcookie(<span class="string">'count'</span>, $count, time()+<span class="number">3600</span>);</span><br><span class="line"><span class="keyword">echo</span> $count;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>浏览器访问然后刷新数据，可以看到每刷新一次数字就增加1。</p><h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><p>常量表示脚本执行期间不能改变值。传统上常量标识符总是大写的。</p><p>可以使用<code>const</code>关键字定义常量，而且一旦定义就不可以再修改或者取消定义。常量只能包含boolean、integer、float、string，虽然也可以定义resource常量，但应该尽量避免。与变量不同，不应该在常量前面加上<code>$</code>符号。用<code>get_defined_constants()</code>获取所有已定义的常量列表。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">define(<span class="string">"CONSTANT"</span>, <span class="string">"Hello world1.&lt;/br&gt;"</span>);</span><br><span class="line"><span class="keyword">echo</span> CONSTANT;</span><br><span class="line"><span class="keyword">const</span> CONSTANT2 = <span class="string">'Hello world2.&lt;/br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> CONSTANT2;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Hello world1.Hello world2.</code></pre><p>小提示：和使用 <code>define()</code> 来定义常量相反的是，使用 <code>const</code> 关键字定义常量必须处于最顶端的作用区域，因为用此方法是在编译时定义的。这就意味着不能在函数内，循环内以及 if 语句之内用 const 来定义常量。</p><h4 id="魔法常量"><a href="#魔法常量" class="headerlink" title="魔法常量"></a>魔法常量</h4><p>PHP 向它运行的任何脚本提供了大量的预定义常量。不过很多常量都是由不同的扩展库定义的，只有在加载了这些扩展库时才会出现，或者动态加载后，或者在编译时已经包括进去了。</p><p>有八个魔术常量它们的值随着它们在代码中的位置改变而改变。例如 <code>__LINE__</code> 的值就依赖于它在脚本中所处的行来决定。这些特殊的常量不区分大小写，如下：</p><table><thead><tr><th>名称</th><th>说明</th></tr></thead><tbody><tr><td><code>__LINE__</code></td><td>文件中的当前行号。</td></tr><tr><td><code>__FILE__</code></td><td>文件的完整路径和文件名。</td></tr><tr><td><code>__DIR__</code></td><td>文件所在的目录。</td></tr><tr><td><code>__FUNCTION__</code></td><td>函数名称。</td></tr><tr><td><code>__CLASS__</code></td><td>类的名称。</td></tr><tr><td><code>__TRAIT__</code></td><td>Trait 的名字。Trait 名包括其被声明的作用区域。</td></tr><tr><td><code>__METHOD__</code></td><td>类的方法名。返回该方法被定义时的名字。</td></tr><tr><td><code>__NAMESPACE__</code></td><td>当前命名空间的名称。</td></tr></tbody></table><h3 id="运算符"><a href="#运算符" class="headerlink" title="运算符"></a>运算符</h3><h4 id="运算符优先级"><a href="#运算符优先级" class="headerlink" title="运算符优先级"></a>运算符优先级</h4><p>下表按照优先级从高到低列出了运算符。同一行中的运算符具有相同优先级，此时它们的结合方向决定求值顺序。</p><table><thead><tr><th width="150">结合方向</th><th>运算符</th><th>附加信息</th></tr></thead><tbody><tr><td>无</td><td><code>clone</code> <code>new</code></td><td>clone 和 new</td></tr><tr><td>左</td><td><code>[</code></td><td><span>array()</span></td></tr><tr><td>右</td><td><code>**</code></td><td>算术运算符</td></tr><tr><td>右</td><td><code>++</code><code>–</code></td><td>类型和递增／递减</td></tr><tr><td>无</td><td><code>instanceof</code></td><td>类型</td></tr><tr><td>右</td><td><code>!</code></td><td>逻辑运算符</td></tr><tr><td>左</td><td><code><em></em></code><code>/</code><code>%</code></td><td>算术运算符</td></tr><tr><td>左</td><td><code>+</code><code>-</code><code>.</code></td><td>算术运算符和字符串运算符</td></tr><tr><td>左</td><td><code>&lt;&lt;</code><code>&gt;&gt;</code></td><td>位运算符</td></tr><tr><td>无</td><td><code>&lt;</code><code>&lt;=</code><code>&gt;</code><code>&gt;=</code></td><td>比较运算符</td></tr><tr><td>无</td><td><code>== </code><code>!=</code><code>===</code><code>!==</code><code>&lt;&gt;</code><code>&lt;=&gt;</code></td><td>比较运算符</td></tr><tr><td>左</td><td><code>&amp;</code></td><td>位运算符和引用</td></tr><tr><td>左</td><td><code>^</code></td><td>位运算符</td></tr><tr><td>左</td><td><code>|</code></td><td>位运算符</td></tr><tr><td>左</td><td><code>&amp;&amp;</code></td><td>逻辑运算符</td></tr><tr><td>左</td><td><code>||</code></td><td>逻辑运算符</td></tr><tr><td>左</td><td><code>??</code></td><td>比较运算符</td></tr><tr><td>左</td><td><code>?:</code></td><td>三元运算符</td></tr><tr><td>右</td><td><code>=</code><code>+=</code><code>-=</code><code>=</code><code>**=</code><code>/=</code><code>.=</code><code>%=</code><code>&amp;=</code><code>|=</code><code>^=</code><code>&lt;&lt;=</code><code>&gt;&gt;=</code></td><td>赋值运算符</td></tr><tr><td>左</td><td><code>and</code></td><td>逻辑运算符</td></tr><tr><td>左</td><td><code>xor</code></td><td>逻辑运算符</td></tr><tr><td>左</td><td><code>or</code></td><td>逻辑运算符</td></tr></tbody></table><h4 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h4><table><thead><tr><th>例子</th><th>名称</th><th>结果</th></tr></thead><tbody><tr><td>-$a</td><td>取反</td><td>$a 的负值。</td></tr><tr><td>$a + $b</td><td>加法</td><td>$a 和 $b 的和。</td></tr><tr><td>$a - $b</td><td>减法</td><td>$a 和 $b 的差。</td></tr><tr><td>$a * $b</td><td>乘法</td><td>$a 和 $b 的积。</td></tr><tr><td>$a / $b</td><td>除法</td><td>$a 除以 $b 的商。</td></tr><tr><td>$a % $b</td><td>取模</td><td>$a 除以 $b 的余数。</td></tr><tr><td>$a ** $b</td><td>取幂</td><td>$a 的 $b 次方。</td></tr></tbody></table><h4 id="赋值运算符"><a href="#赋值运算符" class="headerlink" title="赋值运算符"></a>赋值运算符</h4><p>基本的赋值运算符是“=”。一开始可能会以为它是“等于”，其实不是的。它实际上意味着把右边表达式的值赋给左边的运算数。</p><p>赋值运算表达式的值也就是所赋的值。也就是说，“$a = 3”的值是 3。这样就可以做一些小技巧：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = ($b = <span class="number">4</span>) + <span class="number">5</span>; <span class="comment">// $a 现在成了 9，而 $b 成了 4。</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>在基本赋值运算符之外，还有适合于所有二元算术，数组集合和字符串运算符的“组合运算符”，这样可以在一个表达式中使用它的值并把表达式的结果赋给它，例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">3</span>;</span><br><span class="line">$a += <span class="number">5</span>; <span class="comment">// sets $a to 8, as if we had said: $a = $a + 5;</span></span><br><span class="line">$b = <span class="string">"Hello "</span>;</span><br><span class="line">$b .= <span class="string">"There!"</span>; <span class="comment">// 将 $b 的值设置为 "Hello There!", 相当于 $b = $b . "There!";</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>小提示：<code>.</code>在PHP中用作两个字符串连接。</p><p>PHP 支持引用赋值，使用“$var = &amp;$othervar;”语法。引用赋值意味着两个变量指向了同一个数据，没有拷贝任何东西。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">3</span>;</span><br><span class="line">$b = &amp;$a; <span class="comment">// $b 是 $a 的引用</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"$a\n"</span>; <span class="comment">// 输出 3</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"$b\n"</span>; <span class="comment">// 输出 3</span></span><br><span class="line">$a = <span class="number">4</span>; <span class="comment">// 修改 $a</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"$a\n"</span>; <span class="comment">// 输出 4</span></span><br><span class="line"><span class="keyword">print</span> <span class="string">"$b\n"</span>; <span class="comment">// 也输出 4，因为 $b 是 $a 的引用，因此也被改变</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="位运算符"><a href="#位运算符" class="headerlink" title="位运算符"></a>位运算符</h4><table><thead><tr><th width="110">例子</th><th width="130">名称</th><th>结果</th></tr></thead><tbody><tr><td>$a &amp; $b</td><td>And（按位与）</td><td>将把 <var><var>$a</var></var> 和 <var><var>$b</var></var> 中都为 1 的位设为 1。</td></tr><tr><td>$a | $b</td><td>Or（按位或）</td><td>将把 <var><var>$a</var></var> 和 <var><var>$b</var></var> 中任何一个为 1 的位设为 1。</td></tr><tr><td>$a ^ $b</td><td>Xor（按位异或）</td><td>将把 <var><var>$a</var></var> 和 <var><var>$b</var></var> 中一个为 1 另一个为 0 的位设为 1。</td></tr><tr><td>~ $a</td><td>Not（按位取反）</td><td>将 <var><var>$a</var></var> 中为 0 的位设为 1，反之亦然。</td></tr><tr><td>$a &lt;&lt; $b</td><td>Shift left（左移）</td><td>将 <var><var>$a</var></var> 中的位向左移动 <var><var>$b</var></var> 次（每一次移动都表示“乘以 2”）。</td></tr><tr><td>$a &gt;&gt; $b</td><td>Shift right（右移）</td><td>将 <var><var>$a</var></var> 中的位向右移动 <var><var>$b</var></var> 次（每一次移动都表示“除以 2”）。</td></tr></tbody></table><h4 id="比较运算符"><a href="#比较运算符" class="headerlink" title="比较运算符"></a>比较运算符</h4><table><thead><tr><th width="120">例子</th><th width="120">名称</th><th>结果</th></tr></thead><tbody><tr><td>$a == $b</td><td>等于</td><td>TRUE，如果类型转换后 $a 等于 $b。</td></tr><tr><td>$a === $b</td><td>全等</td><td>TRUE，如果 $a 等于 $b，并且它们的类型也相同。</td></tr><tr><td>$a != $b</td><td>不等</td><td>TRUE，如果类型转换后 $a 不等于 $b。</td></tr><tr><td>$a &lt;&gt; $b</td><td>不等</td><td>TRUE，如果类型转换后 $a 不等于 $b。</td></tr><tr><td>$a !== $b</td><td>不全等</td><td>TRUE，如果 $a 不等于 $b，或者它们的类型不同。</td></tr><tr><td>$a &lt; $b</td><td>小与</td><td>TRUE，如果 $a 严格小于 $b。</td></tr><tr><td>$a &gt; $b</td><td>大于</td><td>TRUE，如果 $a 严格大于 $b。</td></tr><tr><td>$a &lt;= $b</td><td>小于等于</td><td>TRUE，如果 $a 小于或者等于 $b。</td></tr><tr><td>$a &gt;= $b</td><td>大于等于</td><td>TRUE，如果 $a 大于或者等于 $b。</td></tr><tr><td>$a &lt;=&gt; $b</td><td>太空船运算符</td><td>当$a小于、等于、大于$b时 分别返回一个小于、等于、大于0的integer 值。 PHP7开始提供.</td></tr><tr><td>$a ?? $b ?? $c</td><td>NULL 合并操作符</td><td>从左往右第一个存在且不为 NULL 的操作数。如果都没有定义且不为 NULL，则返回 NULL。PHP7开始提供。</td></tr></tbody></table><h4 id="错误控制运算符"><a href="#错误控制运算符" class="headerlink" title="错误控制运算符"></a>错误控制运算符</h4><p>PHP 支持一个错误控制运算符：@。当将其放置在一个 PHP 表达式之前，该表达式可能产生的任何错误信息都被忽略掉。</p><p>如果用 <code>set_error_handler()</code> 设定了自定义的错误处理函数，仍然会被调用，但是此错误处理函数可以（并且也应该）调用 <code>error_reporting()</code>，而该函数在出错语句前有 @ 时将返回 0。</p><p><code>@</code> 运算符只对表达式有效。</p><h4 id="执行运算符"><a href="#执行运算符" class="headerlink" title="执行运算符"></a>执行运算符</h4><p>PHP 支持一个执行运算符：反引号（``）。注意这不是单引号！PHP 将尝试将反引号中的内容作为 shell 命令来执行，并将其输出信息返回。使用反引号运算符`的效果与函数 shell_exec() 相同。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> `ipconfig`;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意：反引号运算符在激活了安全模式或者关闭了 <code>shell_exec()</code> 时是无效的。</p><h4 id="递增／递减运算符"><a href="#递增／递减运算符" class="headerlink" title="递增／递减运算符"></a>递增／递减运算符</h4><table><thead><tr><th>例子</th><th>名称</th><th>效果</th></tr></thead><tbody><tr><td>++$a</td><td>前加</td><td>$a 的值加一，然后返回 $a。</td></tr><tr><td>$a++</td><td>后加</td><td>返回 $a，然后将 $a 的值加一。</td></tr><tr><td>–$a</td><td>前减</td><td>$a 的值减一， 然后返回 $a。</td></tr><tr><td>$a–</td><td>后减</td><td>返回 $a，然后将 $a 的值减一。</td></tr></tbody></table><h4 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h4><table><thead><tr><th width="150">例子</th><th width="150">名称</th><th>结果</th></tr></thead><tbody><tr><td>$a and $b</td><td>And（逻辑与）</td><td><code>TRUE</code>，如果 <var><var>$a</var></var> 和 <var><var>$b</var></var> 都为 <code>TRUE</code>。</td></tr><tr><td>$a or $b</td><td>Or（逻辑或）</td><td><code>TRUE</code>，如果 <var><var>$a</var></var> 或 <var><var>$b</var></var> 任一为 <code>TRUE</code>。</td></tr><tr><td>$a xor $b</td><td>Xor（逻辑异或）</td><td><code>TRUE</code>，如果 <var><var>$a</var></var> 或 <var><var>$b</var></var> 任一为 <code>TRUE</code>，但不同时是。</td></tr><tr><td>!$a</td><td>Not（逻辑非）</td><td><code>TRUE</code>，如果 <var><var>$a</var></var> 不为 <code>TRUE</code>。</td></tr><tr><td>$a &amp;&amp;$b</td><td>And（逻辑与）</td><td><code>TRUE</code>，如果 <var><var>$a</var></var> 和 <var><var>$b</var></var> 都为 <code>TRUE</code>。</td></tr><tr><td>$a || $b</td><td>Or（逻辑或）</td><td><code>TRUE</code>，如果 <var><var>$a</var></var> 或 <var><var>$b</var></var> 任一为 <code>TRUE</code>。</td></tr></tbody></table><h4 id="字符串运算符"><a href="#字符串运算符" class="headerlink" title="字符串运算符"></a>字符串运算符</h4><p>有两个字符串（string）运算符。第一个是连接运算符 <code>.</code>，它返回其左右参数连接后的字符串。第二个是连接赋值运算符 <code>.=</code>，它将右边参数附加到左边的参数之后。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="string">"Hello "</span>;</span><br><span class="line">$b = $a . <span class="string">"World!"</span>; <span class="comment">// 现在 $b 等于 "Hello World!"</span></span><br><span class="line"></span><br><span class="line">$a = <span class="string">"Hello "</span>;</span><br><span class="line">$a .= <span class="string">"World!"</span>;     <span class="comment">// 现在 $a 等于 "Hello World!"</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="数组运算符"><a href="#数组运算符" class="headerlink" title="数组运算符"></a>数组运算符</h4><table><thead><tr><th width="150">例子</th><th width="150">名称</th><th>结果</th></tr></thead><tbody><tr><td>$a + $b</td><td>联合</td><td><var><var>$a</var></var> 和 <var><var>$b</var></var> 的联合。</td></tr><tr><td>$a == $b</td><td>相等</td><td>如果 <var><var>$a</var></var> 和 <var><var>$b</var></var> 具有相同的键／值对则为 <code>TRUE</code>。</td></tr><tr><td>$a === $b</td><td>全等</td><td>如果 <var><var>$a</var></var> 和 <var><var>$b</var></var> 具有相同的键／值对并且顺序和类型都相同则为 <code>TRUE</code>。</td></tr><tr><td>$a != $b</td><td>不等</td><td>如果 <var><var>$a</var></var> 不等于 <var><var>$b</var></var> 则为 <code>TRUE</code>。</td></tr><tr><td>$a &lt;&gt;$b</td><td>不等</td><td>如果 <var><var>$a</var></var> 不等于 <var><var>$b</var></var> 则为 <code>TRUE</code>。</td></tr><tr><td>$a !== $b</td><td>不全等</td><td>如果 <var><var>$a</var></var> 不全等于 <var><var>$b</var></var> 则为 <code>TRUE</code>。</td></tr></tbody></table><h4 id="类型运算符"><a href="#类型运算符" class="headerlink" title="类型运算符"></a>类型运算符</h4><p><code>instanceof</code> 用于确定一个 PHP 变量是否属于某一类 class 的实例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotMyClass</span></span>&#123;&#125;</span><br><span class="line">$a = <span class="keyword">new</span> MyClass;</span><br><span class="line">var_dump($a <span class="keyword">instanceof</span> MyClass);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">var_dump($a <span class="keyword">instanceof</span> NotMyClass);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>bool(true) bool(false)</code></pre><h3 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a>流程控制</h3><p>任何 PHP 脚本都是由一系列语句构成的。一条语句可以是一个赋值语句，一个函数调用，一个循环，一个条件语句或者甚至是一个什么也不做的语句（空语句）。语句通常以分号结束。此外，还可以用花括号将一组语句封装成一个语句组。语句组本身可以当作是一行语句。</p><h4 id="条件判断"><a href="#条件判断" class="headerlink" title="条件判断"></a>条件判断</h4><h5 id="if"><a href="#if" class="headerlink" title="if"></a>if</h5><p>语法：</p><pre><code>&lt;?phpif (expr) {    statement}?&gt;</code></pre><p>如果有多个表达式，使用花括号括起来</p><p>例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> ($a &gt; $b) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a is greater than b"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="if-else"><a href="#if-else" class="headerlink" title="if-else"></a>if-else</h5><p>语法：</p><pre><code>&lt;?phpif (expr) {    statement} else {    statement}?&gt;</code></pre><p>例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">2</span>;</span><br><span class="line">$b = <span class="number">4</span>;</span><br><span class="line"><span class="keyword">if</span> ($a &gt; $b) &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"a is greater than b"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">echo</span> <span class="string">"a is NOT greater than b"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="if-elseif-else"><a href="#if-elseif-else" class="headerlink" title="if-elseif-else"></a>if-elseif-else</h5><p>语法：</p><pre><code>&lt;?phpif (expr) {    statement} elseif (expr) {    statement} else {    statement}?&gt;</code></pre><p>例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">2</span>;</span><br><span class="line">$b = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">if</span> ($a &gt; $b) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a is bigger than b"</span>;</span><br><span class="line">&#125; <span class="keyword">elseif</span> ($a == $b) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a is equal to b"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a is smaller than b"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在同一个 if 语句中可以有多个 elseif 部分，其中第一个表达式值为 TRUE 的 elseif 部分将会执行。在 PHP 中，也可以写成”else if”，它和”elseif”的行为完全一样。</p><h4 id="流程控制的替代语法"><a href="#流程控制的替代语法" class="headerlink" title="流程控制的替代语法"></a>流程控制的替代语法</h4><p>PHP 提供了一些流程控制的替代语法，包括 if，while，for，foreach 和 switch。替代语法的基本形式是把左花括号 <code>{</code> 换成冒号 <code>:</code> ，把右花括号 <code>}</code> 分别换成 endif;，endwhile;，endfor;，endforeach; 以及 endswitch;。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> $a = <span class="number">5</span>; <span class="meta">?&gt;</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">if</span> ($a == <span class="number">5</span>): <span class="meta">?&gt;</span></span><br><span class="line">    A is equal to <span class="number">5</span></span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">endif</span>; <span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>同样还可以用在 else 和 elseif 中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">6</span>;</span><br><span class="line"><span class="keyword">if</span> ($a == <span class="number">5</span>):</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a equals 5"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"..."</span>;</span><br><span class="line"><span class="keyword">elseif</span> ($a == <span class="number">6</span>):</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a equals 6"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"!!!"</span>;</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"a is neither 5 nor 6"</span>;</span><br><span class="line"><span class="keyword">endif</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意：不支持在同一个控制块内混合使用两种语法。</p><h4 id="循环"><a href="#循环" class="headerlink" title="循环"></a>循环</h4><h5 id="while循环"><a href="#while循环" class="headerlink" title="while循环"></a>while循环</h5><p>while 循环是 PHP 中最简单的循环类型。它和 C 语言中的 while 表现地一样。while 语句的基本格式是：</p><pre><code>while (expr) {    statement}</code></pre><p>如果表达式只有一句 也可以将花括号省略掉。</p><p>while 语句的含义很简单，只要 while 的表达式值为 TRUE ，就重复执行嵌套中的循环语句，表达式的值在每次开始循环时检查，直到表达式为 FALSE 为止。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ($i &lt;= <span class="number">10</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $i++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="do-while循环"><a href="#do-while循环" class="headerlink" title="do-while循环"></a>do-while循环</h5><p>do-while 循环是先循环 后判断，所以 do-while 不管表达式是否为 TRUE 都会至少循环一次。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">   <span class="keyword">echo</span> $i++;</span><br><span class="line">&#125; <span class="keyword">while</span> ($i &lt;= <span class="number">10</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="for循环"><a href="#for循环" class="headerlink" title="for循环"></a>for循环</h5><p>for循环是相对比较复杂但同时更强大的循环方法。for循环的语法是：</p><pre><code>for (expr1; expr2; expr3) {    statement}</code></pre><p>第一个表达式(expr1)在循环前执行一次。第二个表达式在每次循环开始前执行，如果值为 TRUE 则继续执行，FALSE 则跳出循环。第三个表达式在每次循环之后被执行。</p><p>每个表达式都可以为空或包括逗号分隔的多个表达式，表达式 expr2 中，所有用逗号分隔的表达式都会计算，但只取最后一个结果。expr2 为空意味着将无限循环下去。如果死循环，可以在循环语句中使用break跳出去。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= <span class="number">10</span>; $i++) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">for</span> ($i = <span class="number">1</span>; ; $i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($i &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> $i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>PHP 也支持用冒号的 for 循环的替代语法。</p><pre><code>for (expr1; expr2; expr3):    statement;    ...endfor;</code></pre><h5 id="foreach"><a href="#foreach" class="headerlink" title="foreach"></a>foreach</h5><p>foreach 语法结构提供了遍历数组的简单方式。foreach 仅能够应用于数组和对象，如果尝试应用于其他数据类型的变量，或者未初始化的变量将发出错误信息。有两种语法：</p><pre><code>foreach (array_expression as $value)    statementforeach (array_expression as $key =&gt; $value)    statement</code></pre><p>第一种格式遍历给定的 array_expression 数组。每次循环中，当前单元的值被赋给 $value 并且数组内部的指针向前移一步（因此下一次循环中将会得到下一个单元）。</p><p>第二种格式做同样的事，只除了当前单元的键名也会在每次循环中被赋给变量 $key。</p><p>可以很容易地通过在 $value 之前加上 &amp; 来修改数组的元素。此方法将以引用赋值而不是拷贝一个值。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">foreach</span> ($arr <span class="keyword">as</span> &amp;$value) &#123;</span><br><span class="line">    $value = $value * <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// $arr is now array(2, 4, 6, 8)</span></span><br><span class="line"><span class="keyword">unset</span>($value); <span class="comment">// 最后取消掉引用</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>PHP 5.5 增添了遍历一个数组的数组的功能并且把嵌套的数组解包到循环变量中，只需将 list() 作为值提供。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$array = [</span><br><span class="line">    [<span class="number">1</span>, <span class="number">2</span>],</span><br><span class="line">    [<span class="number">3</span>, <span class="number">4</span>],</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($array <span class="keyword">as</span> <span class="keyword">list</span>($a, $b)) &#123;</span><br><span class="line">    <span class="comment">// $a contains the first element of the nested array,</span></span><br><span class="line">    <span class="comment">// and $b contains the second element.</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"A: $a; B: $b\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>list() 中的单元可以少于嵌套数组的，此时多出来的数组单元将被忽略。如果 list() 中列出的单元多于嵌套数组则会发出一条消息级别的错误信息。</p><h4 id="break-跳出循环"><a href="#break-跳出循环" class="headerlink" title="break 跳出循环"></a>break 跳出循环</h4><p>break 结束当前 for，foreach，while，do-while 或者 switch 结构的执行。</p><p>break 可以接受一个可选的数字参数来决定跳出几重循环。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$arr = <span class="keyword">array</span>(<span class="string">'one'</span>, <span class="string">'two'</span>, <span class="string">'three'</span>, <span class="string">'four'</span>, <span class="string">'stop'</span>, <span class="string">'five'</span>);</span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">list</span> (, $val) = each($arr)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ($val == <span class="string">'stop'</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;    <span class="comment">/* You could also write 'break 1;' here. */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$val&lt;br /&gt;\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 使用可选参数 */</span></span><br><span class="line"></span><br><span class="line">$i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> (++$i) &#123;</span><br><span class="line">    <span class="keyword">switch</span> ($i) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"At 5&lt;br /&gt;\n"</span>;</span><br><span class="line">        <span class="keyword">break</span> <span class="number">1</span>;  <span class="comment">/* 只退出 switch. */</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">10</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"At 10; quitting&lt;br /&gt;\n"</span>;</span><br><span class="line">        <span class="keyword">break</span> <span class="number">2</span>;  <span class="comment">/* 退出 switch 和 while 循环 */</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意：在PHP 5.4.0 之后，取消变量作为参数传递（例如 <code>$num = 2; break $num;</code>）。</p><h4 id="continue-跳出本次循环"><a href="#continue-跳出本次循环" class="headerlink" title="continue 跳出本次循环"></a>continue 跳出本次循环</h4><p>continue 在循环结构用用来跳过本次循环中剩余的代码并在条件求值为真时开始执行下一次循环。</p><p>小提示：注意在 PHP 中 switch 语句被认为是可以使用 continue 的一种循环结构。<br>continue 接受一个可选的数字参数来决定跳过几重循环到循环结尾。默认值是 1，即跳到当前循环末尾。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">list</span> ($key, $value) = each($arr)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!($key % <span class="number">2</span>)) &#123; <span class="comment">// skip odd members</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    do_something_odd($value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$i = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ($i++ &lt; <span class="number">5</span>) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Outer&lt;br /&gt;\n"</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Middle&lt;br /&gt;\n"</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"Inner&lt;br /&gt;\n"</span>;</span><br><span class="line">            <span class="keyword">continue</span> <span class="number">3</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"This never gets output.&lt;br /&gt;\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Neither does this.&lt;br /&gt;\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意：在PHP 5.4.0 之后，取消变量作为参数传递（例如 <code>$num = 2; continue $num;</code>）。</p><h4 id="switch-分支选择"><a href="#switch-分支选择" class="headerlink" title="switch 分支选择"></a>switch 分支选择</h4><p>switch 语句类似于具有同一个表达式的一系列 if 语句。很多场合下需要把同一个变量（或表达式）与很多不同的值比较，并根据它等于哪个值来执行不同的代码。这正是 switch 语句的用途。</p><p>小提示：注意和其它语言不同，continue 语句作用到 switch 上的作用类似于 break。如果在循环中有一个 switch 并希望 continue 到外层循环中的下一轮循环，用 continue 2。</p><p>switch 结构示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">switch</span> ($i) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"i equals 0"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"i equals 1"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"i equals 2"</span>;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"i is not equal to 0, 1 or 2"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>switch 结构中 case 的目标还可以是字符串。case 会依次执行。如果没有 break 将会继续执行下面的 case 代码。default 是所有的 case 都没有匹配时执行。</p><h4 id="declare"><a href="#declare" class="headerlink" title="declare"></a>declare</h4><p>declare 结构用来设定一段代码的执行指令。declare 的语法和其它流程控制结构相似：</p><pre><code>declare (directive)    statement</code></pre><p>directive 部分允许设定 declare 代码段的行为。目前只认识两个指令：ticks 以及 encoding，declare 调试内部程序使用.</p><p><code>declare(ticks=n)</code> 和 <code>register_tick_function(&#39;handel_function&#39;)</code> 一般是配合使用的。<code>ticks</code> 参数表示运行多少语句调用一次 <code>register_tick_function</code> 的函数。并且declare支持两种写法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span>(ticks = <span class="number">1</span>); <span class="comment">//整个脚本</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(ticks = <span class="number">1</span>) &#123; </span><br><span class="line">    ......  <span class="comment">// 内部的代码做记录</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span>(ticks=<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// A function called on each tick event</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">tick_handler</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"tick_handler() called\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">register_tick_function(<span class="string">'tick_handler'</span>);</span><br><span class="line">$a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span> ($a &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    $a += <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">print</span>($a);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>encoding 指令来对每段脚本指定其编码方式。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">declare</span>(encoding=<span class="string">'ISO-8859-1'</span>);</span><br><span class="line"><span class="comment">// code here</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在 PHP 5.3 中除非在编译时指定了 <code>--enable-zend-multibyte</code>，否则 declare 中的 encoding 值会被忽略。</p><h4 id="return"><a href="#return" class="headerlink" title="return"></a>return</h4><p>如果在一个函数中调用 return 语句，将立即结束此函数的执行并将它的参数作为函数的值返回。return 也会终止 eval() 语句或者脚本文件的执行。</p><p>如果在全局范围中调用，则当前脚本文件中止运行。如果当前脚本文件是被 include 的或者 require 的，则控制交回调用文件。此外，如果当前脚本是被 include 的，则 return 的值会被当作 include 调用的返回值。如果在主脚本文件中调用 return，则脚本中止运行。如果当前脚本文件是在 php.ini 中的配置选项 <code>auto_prepend_file</code> 或者 <code>auto_append_file</code>所指定的，则此脚本文件中止运行。</p><h4 id="require"><a href="#require" class="headerlink" title="require"></a>require</h4><p>require 和 include 几乎完全一样，除了处理失败的方式不同之外。require 在出错时产生 <code>E_COMPILE_ERROR</code> 级别的错误。换句话说将导致脚本中止而 include 只产生警告 <code>E_WARNING</code> ，脚本会继续运行。</p><p>还有一个和 require 作用完全相同的是 <code>require_once</code>，不同的是如果这个文件已经被包含，<code>require_once</code> 则不会再次包含这个文件。</p><h4 id="include"><a href="#include" class="headerlink" title="include"></a>include</h4><p>被包含文件先按参数给出的路径寻找，如果没有给出目录（只有文件名）时则按照 <code>include_path</code> 指定的目录寻找。如果在 <code>include_path</code> 下没找到该文件则 include 最后才在调用脚本文件所在的目录和当前工作目录下寻找。如果最后仍未找到文件则 include 结构会发出一条警告；这一点和 require 不同，后者会发出一个致命错误。<code>include_path</code> 是在 <code>php.ini</code> 配置文件中定义的。</p><p>如果定义了路径——不管是绝对路径还是当前目录的相对路径 <code>include_path</code> 都会被完全忽略。例如一个文件以 <code>../</code> 开头，则解析器会在当前目录的父目录下寻找该文件。</p><p>当一个文件被包含时，其中所包含的代码继承了 include 所在行的变量范围。从该处开始，调用文件在该行处可用的任何变量在被调用的文件中也都可用。不过所有在包含文件中定义的函数和类都具有全局作用域。</p><p>vars.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$color = <span class="string">'green'</span>;</span><br><span class="line">$fruit = <span class="string">'apple'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>test.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"A $color $fruit"</span>; <span class="comment">// A</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'vars.php'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"A $color $fruit"</span>; <span class="comment">// A green apple</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>如果 include 出现于调用文件中的一个函数里，则被调用的文件中所包含的所有代码将表现得如同它们是在该函数内部定义的一样。所以它将遵循该函数的变量范围。</p><p>test2.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $color;</span><br><span class="line">    <span class="keyword">include</span> <span class="string">'vars.php'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"A $color $fruit"</span>;</span><br><span class="line">&#125;</span><br><span class="line">foo();                      <span class="comment">// A green apple</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"A $color $fruit"</span>;     <span class="comment">// A green</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p><code>include_once</code> 可以用于在脚本执行期间同一个文件有可能被包含超过一次的情况下，想确保它只被包含一次以避免函数重定义，变量重新赋值等问题。</p><h4 id="goto-跳转"><a href="#goto-跳转" class="headerlink" title="goto 跳转"></a>goto 跳转</h4><p>goto 操作符可以用来跳转到程序中的另一位置。该目标位置可以用目标名称加上冒号来标记，而跳转指令是 goto 之后接上目标位置的标记。PHP 中的 goto 有一定限制，目标位置只能位于同一个文件和作用域，也就是说无法跳出一个函数或类方法，也无法跳入到另一个函数。也无法跳入到任何循环或者 switch 结构中。可以跳出循环或者 switch，通常的用法是用 goto 代替多层的 break。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">goto</span> a;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Foo'</span>;</span><br><span class="line"> </span><br><span class="line">a:</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Bar'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>跳出循环示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">for</span>($i=<span class="number">0</span>,$j=<span class="number">50</span>; $i&lt;<span class="number">100</span>; $i++) &#123;</span><br><span class="line">  <span class="keyword">while</span>($j--) &#123;</span><br><span class="line">    <span class="keyword">if</span>($j==<span class="number">17</span>) <span class="keyword">goto</span> end; </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"i = $i"</span>;</span><br><span class="line">end:</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'j hit 17'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>goto 可以跳出循环 而不可以跳进循环内。</p><h3 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h3><h4 id="自定义函数"><a href="#自定义函数" class="headerlink" title="自定义函数"></a>自定义函数</h4><p>任何有效的 PHP 代码都有可能出现在函数内部，甚至包括其它函数和类定义。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">foo();</span><br><span class="line">bar();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"I don't exist until foo() is called."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到，函数并非只有定义后才能调用。而且bar()函数只有foo()函数调用后才会创建的。</p><p>PHP 中的所有函数和类都具有全局作用域，可以定义在一个函数之内而在之外调用，反之亦然。PHP 不支持函数重载，也不可能取消定义或者重定义已声明的函数。PHP 的函数支持可变数量的参数和默认参数。</p><p>在 PHP 中还可以递归调用函数，但是要避免递归超过100-200层，因为可能会使堆栈崩溃从而使当前脚本终止。 无限递归可视为编程错误。</p><h4 id="函数参数"><a href="#函数参数" class="headerlink" title="函数参数"></a>函数参数</h4><h5 id="普通参数"><a href="#普通参数" class="headerlink" title="普通参数"></a>普通参数</h5><p>通过参数列表可以传递信息到函数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">takes_array</span><span class="params">($input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$input[0] + $input[1] = "</span>, $input[<span class="number">0</span>]+$input[<span class="number">1</span>];</span><br><span class="line">&#125;</span><br><span class="line">takes_array([<span class="number">2</span>, <span class="number">4</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="传递引用"><a href="#传递引用" class="headerlink" title="传递引用"></a>传递引用</h5><p>默认情况下，函数参数通过值传递。如果希望允许函数修改它的参数值，必须通过引用传递参数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add_some_extra</span><span class="params">(&amp;$string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $string .= <span class="string">'and something extra.'</span>;</span><br><span class="line">&#125;</span><br><span class="line">$str = <span class="string">'This is a string, '</span>;</span><br><span class="line">add_some_extra($str);</span><br><span class="line"><span class="keyword">echo</span> $str;    <span class="comment">// outputs 'This is a string, and something extra.'</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="参数默认值"><a href="#参数默认值" class="headerlink" title="参数默认值"></a>参数默认值</h5><p>在函数中可以给参数提供一个默认值</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makecoffee</span><span class="params">($type = <span class="string">"cappuccino"</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Making a cup of $type.\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> makecoffee();</span><br><span class="line"><span class="keyword">echo</span> makecoffee(<span class="keyword">null</span>);</span><br><span class="line"><span class="keyword">echo</span> makecoffee(<span class="string">"espresso"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>默认值必须是常量表达式，不能是诸如变量，类成员，或者函数调用等。</p><p>注意：当使用默认参数时，任何默认参数必须放在任何非默认参数的右侧。否则，函数将不会按照预期的情况工作。</p><p>比如下面代码将不能正确运行：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeyogurt</span><span class="params">($type = <span class="string">"acidophilus"</span>, $flavour)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Making a bowl of $type $flavour.\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> makeyogurt(<span class="string">"raspberry"</span>);   <span class="comment">// won't work as expected</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="类型声明"><a href="#类型声明" class="headerlink" title="类型声明"></a>类型声明</h5><p>类型声明允许函数在调用时要求参数为特定类型。 如果给出的值类型不对，那么将会产生一个错误： 在PHP 5中，这将是一个可恢复的致命错误，而在PHP 7中将会抛出一个TypeError异常。</p><p>为了指定一个类型声明，类型应该加到参数名前。这个声明可以通过将参数的默认值设为NULL来实现允许传递NULL。</p><p>可用类型：</p><table><thead><tr><th>类型</th><th>描述</th><th>最低PHP版本</th></tr></thead><tbody><tr><td>类/接口名</td><td>参数必须是特定的类或接口的名称</td><td>PHP 5.0.0</td></tr><tr><td>self</td><td>参数必须是自身的方法</td><td>PHP 5.0.0</td></tr><tr><td>array</td><td>参数必须是一个数组</td><td>PHP 5.1.0</td></tr><tr><td>callable</td><td>参数必须是一个可调用对象</td><td>PHP 5.4.0</td></tr><tr><td>bool</td><td>参数必须是一个布尔值</td><td>PHP 7.0.0</td></tr><tr><td>float</td><td>参数必须是一个浮点数</td><td>PHP 7.0.0</td></tr><tr><td>int</td><td>参数必须是一个整型</td><td>PHP 7.0.0</td></tr><tr><td>string</td><td>参数必须是一个字符串</td><td>PHP 7.0.0</td></tr></tbody></table><p>基础类类型声明：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span> <span class="keyword">extends</span> <span class="title">C</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// This doesn't extend C.</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">E</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(C $c)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> get_class($c).<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">f(<span class="keyword">new</span> C);</span><br><span class="line">f(<span class="keyword">new</span> D);</span><br><span class="line">f(<span class="keyword">new</span> E);       <span class="comment">// 这里会报错，因为f()只接受C类和C类的子类的实例</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h5 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a>可变参数</h5><p>PHP 在用户自定义函数中支持可变数量的参数列表。在 PHP 5.6 及以上的版本中，由 <code>...</code> 语法实现；在 PHP 5.5 及更早版本中，使用函数 <code>func_num_args()</code>，<code>func_get_arg()</code>，和 <code>func_get_args()</code> 。</p><p>在 PHP 5.6+<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">(...$numbers)</span> </span>&#123;</span><br><span class="line">    $acc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> ($numbers <span class="keyword">as</span> $n) &#123;</span><br><span class="line">        $acc += $n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $acc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>还可以使用 <code>...</code> 来提供参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($a, $b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $a + $b;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> add(...[<span class="number">1</span>, <span class="number">2</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在 PHP 5.5 和之前版本访问参数列表</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $acc = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">foreach</span> (func_get_args() <span class="keyword">as</span> $n) &#123;</span><br><span class="line">        $acc += $n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $acc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> sum(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="返回值"><a href="#返回值" class="headerlink" title="返回值"></a>返回值</h4><p>值通过使用可选的返回语句返回。可以返回包括数组和对象的任意类型。返回语句会立即中止函数的运行，并且将控制权交回调用该函数的代码行。如果省略了 return，则返回值为 NULL。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">square</span><span class="params">($num)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $num * $num;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> square(<span class="number">4</span>);   <span class="comment">// outputs '16'.</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>函数不能返回多个值，但可以通过返回一个数组来得到类似的效果。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">small_numbers</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">array</span> (<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">list</span> ($zero, $one, $two) = small_numbers();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>从函数返回一个引用，必须在函数声明和指派返回值给一个变量时都使用引用运算符 &amp;：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> &amp;<span class="title">returns_reference</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> $someref;</span><br><span class="line">&#125;</span><br><span class="line">$newref =&amp; returns_reference();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>返回一个对象：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getC</span><span class="params">()</span>: <span class="title">C</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> C;</span><br><span class="line">&#125;</span><br><span class="line">var_dump(getC());</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="可变函数"><a href="#可变函数" class="headerlink" title="可变函数"></a>可变函数</h4><p>PHP 支持可变函数的概念。这意味着如果一个变量名后有圆括号，PHP 将寻找与变量的值同名的函数，并且尝试执行它。可变函数可以用来实现包括回调函数，函数表在内的一些用途。</p><p>可变函数不能用于例如 echo，print，unset()，isset()，empty()，include，require 以及类似的语言结构。需要使用自己的包装函数来将这些结构用作可变函数。</p><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"In foo()&lt;br /&gt;\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">($arg = <span class="string">''</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"In bar(); argument was '$arg'.&lt;br /&gt;\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 使用 echo 的包装函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echoit</span><span class="params">($string)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $string;</span><br><span class="line">&#125;</span><br><span class="line">$func = <span class="string">'foo'</span>;</span><br><span class="line">$func();        <span class="comment">// 将调用 foo()</span></span><br><span class="line">$func = <span class="string">'bar'</span>;</span><br><span class="line">$func(<span class="string">'test'</span>);  <span class="comment">// 将调用 bar()</span></span><br><span class="line">$func = <span class="string">'echoit'</span>;</span><br><span class="line">$func(<span class="string">'test'</span>);  <span class="comment">// 将调用 echoit()</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>也可以用可变函数的语法来调用一个对象的方法。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Variable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $name = <span class="string">'Bar'</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;$name(); <span class="comment">// This calls the Bar() method</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"This is Bar"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> Foo();</span><br><span class="line">$funcname = <span class="string">"Variable"</span>;</span><br><span class="line">$foo-&gt;$funcname();   <span class="comment">// This calls $foo-&gt;Variable()</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="内置函数"><a href="#内置函数" class="headerlink" title="内置函数"></a>内置函数</h4><p>PHP 有很多标准的函数和结构。还有一些函数需要和特定地 PHP 扩展模块一起编译，否则在使用它们的时候就会得到一个致命的“未定义函数”错误。例如，要使用 image 函数中的 <code>imagecreatetruecolor()</code>，需要在编译 PHP 的时候加上 GD 的支持。或者，要使用 <code>mysql_connect()</code> 函数，就需要在编译 PHP 的时候加上 MySQL 支持。有很多核心函数已包含在每个版本的 PHP 中如字符串和变量函数。调用 <code>phpinfo()</code> 或者 <code>get_loaded_extensions()</code> 可以得知 PHP 加载了那些扩展库。</p><h4 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h4><p>匿名函数也叫闭包函数，就是创建一个没有函数名的函数。最经常用作回调函数。</p><p>闭包函数也可以作为变量的值来使用。PHP 会自动把此种表达式转换成内置类 Closure 的对象实例。把一个 closure 对象赋值给一个变量的方式与普通变量赋值的语法是一样的，最后也要加上分号：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$greet = <span class="function"><span class="keyword">function</span><span class="params">($name)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    printf(<span class="string">"Hello %s\r\n"</span>, $name);</span><br><span class="line">&#125;;</span><br><span class="line">$greet(<span class="string">'World'</span>);</span><br><span class="line">$greet(<span class="string">'PHP'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>闭包可以从父作用域中继承变量。 任何此类变量都应该用 use 语言结构传递进去。 PHP 7.1 起，不能传入此类变量： superglobals、 $this 或者和参数重名。</p><p>从父作用域继承变量<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$message = <span class="string">'hello'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 没有 "use"</span></span><br><span class="line">$example = <span class="function"><span class="keyword">function</span> <span class="params">()</span> </span>&#123;</span><br><span class="line">    var_dump($message);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">echo</span> $example().<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承 $message</span></span><br><span class="line">$example = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">($message)</span> </span>&#123;</span><br><span class="line">    var_dump($message);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">echo</span> $example().<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承变量的值是在定义函数时，而不是在调用时定义的</span></span><br><span class="line">$message = <span class="string">'world'</span>;</span><br><span class="line"><span class="keyword">echo</span> $example().<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新设置 $message</span></span><br><span class="line">$message = <span class="string">'hello'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 继承引用</span></span><br><span class="line">$example = <span class="function"><span class="keyword">function</span> <span class="params">()</span> <span class="title">use</span> <span class="params">(&amp;$message)</span> </span>&#123;</span><br><span class="line">    var_dump($message);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">echo</span> $example().<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 父作用域中的更改值反映在函数调用中。</span></span><br><span class="line">$message = <span class="string">'world'</span>;</span><br><span class="line"><span class="keyword">echo</span> $example().<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 匿名函数也可以接受参数。</span></span><br><span class="line">$example = <span class="function"><span class="keyword">function</span> <span class="params">($arg)</span> <span class="title">use</span> <span class="params">($message)</span> </span>&#123;</span><br><span class="line">    var_dump($arg . <span class="string">' '</span> . $message);</span><br><span class="line">&#125;;</span><br><span class="line">$example(<span class="string">"hello"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>Notice: Undefined variable: message in F:\phpstudy\src\index.php on line 6NULL string(5) &quot;hello&quot; string(5) &quot;hello&quot; string(5) &quot;hello&quot; string(5) &quot;world&quot; string(11) &quot;hello world&quot;</code></pre><p>这些变量都必须在函数或类的头部声明。 从父作用域中继承变量与使用全局变量是不同的。全局变量存在于一个全局的范围，无论当前在执行的是哪个函数。而闭包的父作用域是定义该闭包的函数。</p><p>小提示：可以在闭包中使用 <code>func_num_args()</code>，<code>func_get_arg()</code> 和 <code>func_get_args()</code>。</p><h3 id="类与对象"><a href="#类与对象" class="headerlink" title="类与对象"></a>类与对象</h3><p>自 PHP 5 起完全重写了对象模型以得到更佳性能和更多特性。这是自 PHP 4 以来的最大变化。PHP 5 具有完整的对象模型。<br>PHP 5 中的新特性包括访问控制，抽象类和 final 类与方法，附加的魔术方法，接口，对象复制和类型约束。<br>PHP 对待对象的方式与引用和句柄相同，即每个变量都持有对象的引用，而不是整个对象的拷贝。</p><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><p>每个类的定义都以关键字 class 开头，后面跟着类名，后面跟着一对花括号，里面包含有类的属性与方法的定义。<br>一个类可以包含有属于自己的常量，变量（称为”属性”）以及函数（称为”方法”）。</p><h5 id="类的定义"><a href="#类的定义" class="headerlink" title="类的定义"></a>类的定义</h5><p>一个简单的类定义：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 属性声明</span></span><br><span class="line">    <span class="keyword">public</span> $var = <span class="string">'a default value'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 方法声明</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;var;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h5 id="this-伪变量"><a href="#this-伪变量" class="headerlink" title="$this 伪变量"></a>$this 伪变量</h5><p>当一个方法在类定义内部被调用时，有一个可用的伪变量 $this。$this 是一个到主叫对象的引用</p><p>$this 的使用示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="keyword">$this</span>)) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">'$this is defined ('</span>;</span><br><span class="line">            <span class="keyword">echo</span> get_class(<span class="keyword">$this</span>);</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">")\n"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">"\$this is not defined.\n"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        A::foo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> A();</span><br><span class="line">$a-&gt;foo();</span><br><span class="line">A::foo();</span><br><span class="line">$b = <span class="keyword">new</span> B();</span><br><span class="line">$b-&gt;bar();</span><br><span class="line">B::bar();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>$this is defined (A) $this is not defined. $this is not defined. $this is not defined.</code></pre><h5 id="new-创建实例"><a href="#new-创建实例" class="headerlink" title="new 创建实例"></a>new 创建实例</h5><p>要创建一个类的实例，必须使用 new 关键字。当创建新对象时该对象总是被赋值，除非该对象定义了构造函数并且在出错时抛出了一个异常。</p><p>如果在 new 之后跟着的是一个包含有类名的字符串，则该类的一个实例被创建。如果该类属于一个名字空间，则必须使用其完整名称。</p><p>创建一个实例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$instance = <span class="keyword">new</span> SimpleClass();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 也可以这样做</span></span><br><span class="line">$className = <span class="string">'Foo'</span>;</span><br><span class="line">$instance = <span class="keyword">new</span> $className(); <span class="comment">// Foo()</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>当把一个对象已经创建的实例赋给一个新变量时，新变量会访问同一个实例，就和用该对象赋值一样。此行为和给函数传递入实例时一样。可以用克隆给一个已创建的对象建立一个新实例。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleClass</span> </span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line">$instance = <span class="keyword">new</span> SimpleClass();</span><br><span class="line">$assigned   =  $instance;</span><br><span class="line">$reference  =&amp; $instance;</span><br><span class="line">$instance-&gt;var = <span class="string">'$assigned will have this value'</span>;</span><br><span class="line">$instance = <span class="keyword">null</span>; <span class="comment">// $instance and $reference become null</span></span><br><span class="line"></span><br><span class="line">var_dump($instance);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">var_dump($reference);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">var_dump($assigned);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>NULL NULL object(SimpleClass)#1 (1) {     [&quot;var&quot;]=&gt; string(30) &quot;$assigned will have this value&quot; }</code></pre><h5 id="class"><a href="#class" class="headerlink" title="::class"></a>::class</h5><p>自 PHP 5.5 起，关键词 class 也可用于类名的解析。使用 <code>ClassName::class</code> 你可以获取一个字符串，包含了类 ClassName 的完全限定名称。这对使用了 命名空间 的类尤其有用。</p><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">NS</span> &#123;</span><br><span class="line">    <span class="title">class</span> <span class="title">ClassName</span> &#123; &#125;</span><br><span class="line">    <span class="title">echo</span> <span class="title">ClassName</span>::<span class="title">class</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>NS\ClassName</code></pre><h4 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h4><p>类的变量成员叫做”属性”，属性声明是由关键字 <code>public</code>，<code>protected</code> 或者 <code>private</code> 开头，然后跟一个普通的变量声明来组成。属性中的变量可以初始化，但是初始化的值必须是常数，这里的常数是指 PHP 脚本在编译阶段时就可以得到其值，而不依赖于运行时的信息才能求值。</p><p>在类的成员方法里面，可以用 <code>-&gt;</code>（对象运算符）：<code>$this-&gt;property</code>（其中 property 是该属性名）这种方式来访问非静态属性。静态属性则是用 <code>::</code>（双冒号）：<code>self::$property</code> 来访问。更多静态属性与非静态属性的区别参见 static 关键字。</p><p>属性声明：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">   <span class="comment">// 错误的属性声明</span></span><br><span class="line">   <span class="keyword">public</span> $var1 = <span class="string">'hello '</span> . <span class="string">'world'</span>;</span><br><span class="line">   <span class="keyword">public</span> $var2 = <span class="string">&lt;&lt;&lt;EOD</span></span><br><span class="line"><span class="string">hello world</span></span><br><span class="line"><span class="string">EOD;</span></span><br><span class="line">   <span class="keyword">public</span> $var3 = <span class="number">1</span>+<span class="number">2</span>;</span><br><span class="line">   <span class="keyword">public</span> $var4 = <span class="keyword">self</span>::myStaticMethod();</span><br><span class="line">   <span class="keyword">public</span> $var5 = $myVar;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 正确的属性声明</span></span><br><span class="line">   <span class="keyword">public</span> $var6 = myConstant;</span><br><span class="line">   <span class="keyword">public</span> $var7 = <span class="keyword">array</span>(<span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">   <span class="comment">//在 PHP 5.3.0 及之后，下面的声明也正确</span></span><br><span class="line">   <span class="keyword">public</span> $var8 = <span class="string">&lt;&lt;&lt;'EOD'</span></span><br><span class="line"><span class="string">hello world</span></span><br><span class="line"><span class="string">EOD;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="类常量"><a href="#类常量" class="headerlink" title="类常量"></a>类常量</h4><p>可以把在类中始终保持不变的值定义为常量。在定义和使用常量的时候不需要使用 $ 符号。常量的值必须是一个定值，不能是变量，类属性，数学运算的结果或函数调用。</p><p>定义和使用一个常量：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> constant = <span class="string">'constant value'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">showConstant</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span>  <span class="keyword">self</span>::constant . <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> MyClass::constant . <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line">$classname = <span class="string">"MyClass"</span>;</span><br><span class="line"><span class="keyword">echo</span> $classname::constant . <span class="string">"\n"</span>; <span class="comment">// 自 5.3.0 起</span></span><br><span class="line"></span><br><span class="line">$class = <span class="keyword">new</span> MyClass();</span><br><span class="line">$class-&gt;showConstant();</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $class::constant.<span class="string">"\n"</span>; <span class="comment">// 自 PHP 5.3.0 起</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="类的自动加载"><a href="#类的自动加载" class="headerlink" title="类的自动加载"></a>类的自动加载</h4><p>在编写面向对象程序时，很多开发者为每个类新建一个 PHP 文件。 这会带来一个烦恼：每个脚本的开头，都需要 include 一个长长的列表。</p><p>在 PHP 5 中，已经不再需要这样了。 <code>spl_autoload_register()</code> 函数可以注册任意数量的自动加载器，当使用尚未被定义的类和接口时自动去加载。通过注册自动加载器，脚本引擎在 PHP 出错失败前有了最后一个机会加载所需的类。</p><p>尝试分别从 MyClass1.php 和 MyClass2.php 文件中加载 MyClass1 和 MyClass2 类。</p><p>MyClass1.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">VAR</span> = <span class="string">'MyClass1&lt;/br&gt;'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>MyClass2.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">VAR</span> = <span class="string">'MyClass2&lt;/br&gt;'</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>MyClass3.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">spl_autoload_register(<span class="function"><span class="keyword">function</span> <span class="params">($class_name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">require_once</span> $class_name . <span class="string">'.php'</span>;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">$obj  = <span class="keyword">new</span> MyClass1();</span><br><span class="line">$obj2 = <span class="keyword">new</span> MyClass2();</span><br><span class="line"><span class="keyword">echo</span> $obj::VAR;</span><br><span class="line"><span class="keyword">echo</span> $obj2::VAR;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>当 new 一个尚未定义的类 MyClass1 时，将自动寻找文件名为类名的 php 文件，也就是 MyClass1.php 文件。</p><p>当加载的类文件不存在时，将抛出一个异常，可以用 <code>try/catch</code> 进行异常处理</p><p>抛出一个异常并在 <code>try/catch</code> 语句块中演示：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">spl_autoload_register(<span class="function"><span class="keyword">function</span> <span class="params">($name)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Want to load $name.\n"</span>;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">"Unable to load $name."</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    $obj = <span class="keyword">new</span> NonLoadableClass();</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $e-&gt;getMessage(), <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>Want to load NonLoadableClass.Unable to load NonLoadableClass.</code></pre><h4 id="构造函数和析构函数"><a href="#构造函数和析构函数" class="headerlink" title="构造函数和析构函数"></a>构造函数和析构函数</h4><h5 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h5><p>PHP 5 允行开发者在一个类中定义一个方法作为构造函数。具有构造函数的类会在每次创建新对象时先调用此方法，所以非常适合在使用对象之前做一些初始化工作。</p><p>如果子类中定义了构造函数则不会隐式调用其父类的构造函数。要执行父类的构造函数，需要在子类的构造函数中调用 <code>parent::__construct()</code>。如果子类没有定义构造函数则会如同一个普通的类方法一样从父类继承。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"In BaseClass constructor&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubClass</span> <span class="keyword">extends</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::__construct();</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"In SubClass constructor&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherSubClass</span> <span class="keyword">extends</span> <span class="title">BaseClass</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> BaseClass();</span><br><span class="line">$obj = <span class="keyword">new</span> SubClass();</span><br><span class="line">$obj = <span class="keyword">new</span> OtherSubClass();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>In BaseClass constructorIn BaseClass constructorIn SubClass constructorIn BaseClass constructor</code></pre><p>为了实现向后兼容性，如果 PHP 5 在类中找不到 <code>__construct()</code> 函数并且也没有从父类继承一个的话，它就会尝试寻找旧式的构造函数，也就是和类同名的函数。因此唯一会产生兼容性问题的情况是：类中已有一个名为 <code>__construct()</code> 的方法却被用于其它用途时。</p><p>与其它方法不同，当 <code>__construct()</code> 被与父类 <code>__construct()</code> 具有不同参数的方法覆盖时，PHP 不会产生一个 E_STRICT 错误信息。</p><p>自 PHP 5.3.3 起，在命名空间中，与类名同名的方法不再作为构造函数。这一改变不影响不在命名空间中的类。</p><h5 id="析构函数"><a href="#析构函数" class="headerlink" title="析构函数"></a>析构函数</h5><p>PHP 5 引入了析构函数的概念，这类似于其它面向对象的语言，如 C++。析构函数会在到某个对象的所有引用都被删除或者当对象被显式销毁时执行。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyDestructableClass</span> </span>&#123;</span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">print</span> <span class="string">"In constructor&lt;/br&gt;"</span>;</span><br><span class="line">       <span class="keyword">$this</span>-&gt;name = <span class="string">"MyDestructableClass"</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">print</span> <span class="string">"Destroying "</span> . <span class="keyword">$this</span>-&gt;name . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> MyDestructableClass();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>和构造函数一样，父类的析构函数不会被引擎暗中调用。要执行父类的析构函数，必须在子类的析构函数体中显式调用 <code>parent::__destruct()</code>。此外也和构造函数一样，子类如果自己没有定义析构函数则会继承父类的。</p><p>析构函数即使在使用 <code>exit()</code> 终止脚本运行时也会被调用。在析构函数中调用 <code>exit()</code> 将会中止其余关闭操作的运行。</p><h4 id="访问控制"><a href="#访问控制" class="headerlink" title="访问控制"></a>访问控制</h4><p>对属性或方法的访问控制，是通过在前面添加关键字 <code>public</code>（公有），<code>protected</code>（受保护）或 <code>private</code>（私有）来实现的。被定义为公有的类成员可以在任何地方被访问。被定义为受保护的类成员则可以被其自身以及其子类和父类访问。被定义为私有的类成员则只能被其定义所在的类访问。</p><h5 id="属性的访问控制"><a href="#属性的访问控制" class="headerlink" title="属性的访问控制"></a>属性的访问控制</h5><p>类属性必须定义为公有，受保护，私有之一。如果没有定义 默认是公有。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define MyClass</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $public = <span class="string">'Public'</span>;</span><br><span class="line">    <span class="keyword">protected</span> $protected = <span class="string">'Protected'</span>;</span><br><span class="line">    <span class="keyword">private</span> $private = <span class="string">'Private'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">printHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;public;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;protected;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;private;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> MyClass();</span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;public; <span class="comment">// 这行能被正常执行</span></span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;protected; <span class="comment">// 这行会产生一个致命错误</span></span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;private; <span class="comment">// 这行也会产生一个致命错误</span></span><br><span class="line">$obj-&gt;printHello(); <span class="comment">// 输出 Public、Protected 和 Private</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define MyClass2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass2</span> <span class="keyword">extends</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 可以对 public 和 protected 进行重定义，但 private 而不能</span></span><br><span class="line">    <span class="keyword">protected</span> $protected = <span class="string">'Protected2'</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">printHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;public;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;protected;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;private;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj2 = <span class="keyword">new</span> MyClass2();</span><br><span class="line"><span class="keyword">echo</span> $obj2-&gt;public; <span class="comment">// 这行能被正常执行</span></span><br><span class="line"><span class="keyword">echo</span> $obj2-&gt;private; <span class="comment">// 未定义 private</span></span><br><span class="line"><span class="keyword">echo</span> $obj2-&gt;protected; <span class="comment">// 这行会产生一个致命错误</span></span><br><span class="line">$obj2-&gt;printHello(); <span class="comment">// 输出 Public、Protected2 和 Undefined</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="方法的访问控制"><a href="#方法的访问控制" class="headerlink" title="方法的访问控制"></a>方法的访问控制</h5><p>类中的方法可以被定义为公有，私有或受保护。如果没有设置这些关键字，则该方法默认为公有。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define MyClass</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 声明一个公有的构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="comment">// 声明一个公有的方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">MyPublic</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="comment">// 声明一个受保护的方法</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">MyProtected</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="comment">// 声明一个私有的方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">MyPrivate</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">    <span class="comment">// 此方法为公有</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Foo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;MyPublic();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;MyProtected();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;MyPrivate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myclass = <span class="keyword">new</span> MyClass;</span><br><span class="line">$myclass-&gt;MyPublic(); <span class="comment">// 这行能被正常执行</span></span><br><span class="line">$myclass-&gt;MyProtected(); <span class="comment">// 这行会产生一个致命错误</span></span><br><span class="line">$myclass-&gt;MyPrivate(); <span class="comment">// 这行会产生一个致命错误</span></span><br><span class="line">$myclass-&gt;Foo(); <span class="comment">// 公有，受保护，私有都可以执行</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Define MyClass2</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass2</span> <span class="keyword">extends</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 此方法为公有</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Foo2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;MyPublic();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;MyProtected();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;MyPrivate(); <span class="comment">// 这行会产生一个致命错误</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myclass2 = <span class="keyword">new</span> MyClass2;</span><br><span class="line">$myclass2-&gt;MyPublic(); <span class="comment">// 这行能被正常执行</span></span><br><span class="line">$myclass2-&gt;Foo2(); <span class="comment">// 公有的和受保护的都可执行，但私有的不行</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;testPrivate();</span><br><span class="line">        <span class="keyword">$this</span>-&gt;testPublic();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPublic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Bar::testPublic&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">testPrivate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Bar::testPrivate&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> <span class="keyword">extends</span> <span class="title">Bar</span> </span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">testPublic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Foo::testPublic&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">testPrivate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Foo::testPrivate&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myFoo = <span class="keyword">new</span> foo();</span><br><span class="line">$myFoo-&gt;test(); <span class="comment">// 输出：Bar::testPrivate </span></span><br><span class="line">                <span class="comment">// 输出：Foo::testPublic</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="对象继承"><a href="#对象继承" class="headerlink" title="对象继承"></a>对象继承</h4><p>继承已为大家所熟知的一个程序设计特性，PHP 的对象模型也使用了继承。继承将会影响到类与类，对象与对象之间的关系。比如，当扩展一个类，子类就会继承父类所有公有的和受保护的方法。除非子类覆盖了父类的方法，被继承的方法都会保留其原有功能。 继承对于功能的设计和抽象是非常有用的，而且对于类似的对象增加新功能就无须重新再写这些公用的功能。</p><p>一个类可以在声明中用 extends 关键字继承另一个类的方法和属性。PHP不支持多重继承，一个类只能继承一个基类。被继承的方法和属性可以通过用同样的名字重新声明被覆盖。但是如果父类定义方法时使用了 final，则该方法不可被覆盖。可以通过 <code>parent::</code> 来访问被覆盖的方法或属性。当覆盖方法时，参数必须保持一致否则 PHP 将发出 E_STRICT 级别的错误信息。但构造函数例外，构造函数可在被覆盖时使用不同的参数。</p><p>简单的继承示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printItem</span><span class="params">($string)</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Foo: '</span> . $string . <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printPHP</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'PHP is great.'</span> . <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">bar</span> <span class="keyword">extends</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printItem</span><span class="params">($string)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Bar: '</span> . $string . <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> foo();</span><br><span class="line">$bar = <span class="keyword">new</span> bar();</span><br><span class="line">$foo-&gt;printItem(<span class="string">'baz'</span>); <span class="comment">// Output: 'Foo: baz'</span></span><br><span class="line">$foo-&gt;printPHP();       <span class="comment">// Output: 'PHP is great' </span></span><br><span class="line">$bar-&gt;printItem(<span class="string">'baz'</span>); <span class="comment">// Output: 'Bar: baz'</span></span><br><span class="line">$bar-&gt;printPHP();       <span class="comment">// Output: 'PHP is great'</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>继承后可以重新定义父类的方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleClass</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'a default value'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtendClass</span> <span class="keyword">extends</span> <span class="title">SimpleClass</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 重新定义父类方法</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">displayVar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Extending class&lt;/br&gt;"</span>;</span><br><span class="line">        <span class="keyword">parent</span>::displayVar();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$extended = <span class="keyword">new</span> ExtendClass();</span><br><span class="line">$extended-&gt;displayVar();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Extending classa default value</code></pre><h4 id="范围解析操作符"><a href="#范围解析操作符" class="headerlink" title="范围解析操作符(::)"></a>范围解析操作符(::)</h4><p>范围解析操作符或者更简单地说是一对冒号，可以用于访问静态成员，类常量，还可以用于覆盖类中的属性和方法。</p><p>当在类定义之外引用到这些项目时，要使用类名。</p><p>在类的外部使用<code>::</code>操作符<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> CONST_VALUE = <span class="string">'A constant value&lt;/br&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$classname = <span class="string">'MyClass'</span>;</span><br><span class="line"><span class="keyword">echo</span> $classname::CONST_VALUE; <span class="comment">// 自 PHP 5.3.0 起</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> MyClass::CONST_VALUE;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>A constant valueA constant value</code></pre><p>在类的内部使用<code>::</code>操作符<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> CONST_VALUE = <span class="string">'A constant value&lt;/br&gt;'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherClass</span> <span class="keyword">extends</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $my_static = <span class="string">'static var'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">doubleColon</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">parent</span>::CONST_VALUE;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">self</span>::$my_static . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$classname = <span class="string">'OtherClass'</span>;</span><br><span class="line">$classname::doubleColon(); <span class="comment">// 自 PHP 5.3.0 起</span></span><br><span class="line">OtherClass::doubleColon();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>A constant valuestatic varA constant valuestatic var</code></pre><h4 id="static-关键字"><a href="#static-关键字" class="headerlink" title="static 关键字"></a>static 关键字</h4><p>声明类属性或方法为静态，就可以不实例化类而直接访问。静态属性不能通过一个类已实例化的对象来访问（但静态方法可以）。<br>如果没有指定访问控制，属性和方法默认为公有。<br>由于静态方法不需要通过对象即可调用，所以伪变量 <code>$this</code> 在静态方法中不可用。<br>静态属性不可以由对象通过 <code>-&gt;</code> 操作符来访问。<br>用静态方式调用一个非静态方法会导致一个 <code>E_STRICT</code> 级别的错误。<br>就像其它所有的 PHP 静态变量一样，静态属性只能被初始化为文字或常量，不能使用表达式。所以可以把静态属性初始化为整数或数组，但不能初始化为另一个变量或函数返回值，也不能指向一个对象。<br>可以用一个变量来动态调用类。但该变量的值不能为关键字 self，parent 或 static。</p><p>静态属性示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> $my_static = <span class="string">'foo'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">staticValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">self</span>::$my_static;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> <span class="keyword">extends</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">fooStatic</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">parent</span>::$my_static;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> Foo::$my_static . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$foo = <span class="keyword">new</span> Foo();</span><br><span class="line"><span class="keyword">print</span> $foo-&gt;staticValue() . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">print</span> $foo-&gt;my_static . <span class="string">"&lt;/br&gt;"</span>;      <span class="comment">// Undefined "Property" my_static </span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> $foo::$my_static . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">$classname = <span class="string">'Foo'</span>;</span><br><span class="line"><span class="keyword">print</span> $classname::$my_static . <span class="string">"&lt;/br&gt;"</span>; <span class="comment">// As of PHP 5.3.0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">print</span> Bar::$my_static . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">$bar = <span class="keyword">new</span> Bar();</span><br><span class="line"><span class="keyword">print</span> $bar-&gt;fooStatic() . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>静态方法示例:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">aStaticMethod</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Foo::aStaticMethod();</span><br><span class="line">$classname = <span class="string">'Foo'</span>;</span><br><span class="line">$classname::aStaticMethod(); <span class="comment">// 自 PHP 5.3.0 起</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h4><p>PHP 5 支持抽象类和抽象方法。定义为抽象的类不能被实例化。任何一个类，如果它里面至少有一个方法是被声明为抽象的，那么这个类就必须被声明为抽象的。被定义为抽象的方法只是声明了其调用方式（参数），不能定义其具体的功能实现。</p><p>继承一个抽象类的时候，子类必须定义父类中的所有抽象方法；另外，这些方法的访问控制必须和父类中一样（或者更为宽松）。例如某个抽象方法被声明为受保护的，那么子类中实现的方法就应该声明为受保护的或者公有的，而不能定义为私有的。此外方法的调用方式必须匹配，即类型和所需参数数量必须一致。例如，子类定义了一个可选参数，而父类抽象方法的声明里没有，则两者的声明并无冲突。 这也适用于 PHP 5.4 起的构造函数。在 PHP 5.4 之前的构造函数声明可以不一样的。</p><p>抽象类示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 强制要求子类定义这些方法</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prefixValue</span><span class="params">($prefix)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 普通方法（非抽象方法）</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">printOut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="keyword">$this</span>-&gt;getValue() . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteClass1</span> <span class="keyword">extends</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ConcreteClass1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prefixValue</span><span class="params">($prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;$prefix&#125;ConcreteClass1"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteClass2</span> <span class="keyword">extends</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"ConcreteClass2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prefixValue</span><span class="params">($prefix)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;$prefix&#125;ConcreteClass2"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$class1 = <span class="keyword">new</span> ConcreteClass1;</span><br><span class="line">$class1-&gt;printOut();</span><br><span class="line"><span class="keyword">echo</span> $class1-&gt;prefixValue(<span class="string">'FOO_'</span>) .<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$class2 = <span class="keyword">new</span> ConcreteClass2;</span><br><span class="line">$class2-&gt;printOut();</span><br><span class="line"><span class="keyword">echo</span> $class2-&gt;prefixValue(<span class="string">'FOO_'</span>) .<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>ConcreteClass1FOO_ConcreteClass1ConcreteClass2FOO_ConcreteClass2</code></pre><p>子类定义可选参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 我们的抽象方法仅需要定义需要的参数</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">prefixName</span><span class="params">($name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteClass</span> <span class="keyword">extends</span> <span class="title">AbstractClass</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 我们的子类可以定义父类签名中不存在的可选参数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">prefixName</span><span class="params">($name, $separator = <span class="string">"."</span>)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ($name == <span class="string">"Pacman"</span>) &#123;</span><br><span class="line">            $prefix = <span class="string">"Mr"</span>;</span><br><span class="line">        &#125; <span class="keyword">elseif</span> ($name == <span class="string">"Pacwoman"</span>) &#123;</span><br><span class="line">            $prefix = <span class="string">"Mrs"</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            $prefix = <span class="string">""</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"&#123;$prefix&#125;&#123;$separator&#125; &#123;$name&#125;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$class = <span class="keyword">new</span> ConcreteClass;</span><br><span class="line"><span class="keyword">echo</span> $class-&gt;prefixName(<span class="string">"Pacman"</span>), <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> $class-&gt;prefixName(<span class="string">"Pacwoman"</span>), <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Mr. PacmanMrs. Pacwoman</code></pre><h4 id="对象接口"><a href="#对象接口" class="headerlink" title="对象接口"></a>对象接口</h4><p>使用接口，可以指定某个类必须实现哪些方法，但不需要定义这些方法的具体内容。<br>接口是通过 <code>interface</code> 关键字来定义的，就像定义一个标准的类一样，但其中定义所有的方法都是空的。<br>接口中定义的所有方法都必须是公有，这是接口的特性。</p><p>要实现一个接口，使用 <code>implements</code> 操作符。类中必须实现接口中定义的所有方法，否则会报一个致命错误。类可以实现多个接口，用逗号来分隔多个接口的名称。</p><p>实现多个接口时，接口中的方法不能有重名。<br>接口也可以继承其他接口，通过使用 extends 操作符，接口允许多继承。<br>类要实现接口，必须使用和接口中所定义的方法完全一致的方式。否则会导致致命错误。</p><h5 id="实现接口"><a href="#实现接口" class="headerlink" title="实现接口"></a>实现接口</h5><p>接口示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 声明一个'iTemplate'接口</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">iTemplate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setVariable</span><span class="params">($name, $var)</span></span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHtml</span><span class="params">($template)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 实现接口</span></span><br><span class="line"><span class="comment">// 下面的写法是正确的</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Template</span> <span class="keyword">implements</span> <span class="title">iTemplate</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $vars = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setVariable</span><span class="params">($name, $var)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;vars[$name] = $var;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHtml</span><span class="params">($template)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;vars <span class="keyword">as</span> $name =&gt; $value) &#123;</span><br><span class="line">            $template = str_replace(<span class="string">'&#123;'</span> . $name . <span class="string">'&#125;'</span>, $value, $template);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> $template;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的写法是错误的，会报错，因为没有实现 getHtml()：</span></span><br><span class="line"><span class="comment">// Fatal error: Class BadTemplate contains 1 abstract methods</span></span><br><span class="line"><span class="comment">// and must therefore be declared abstract (iTemplate::getHtml)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BadTemplate</span> <span class="keyword">implements</span> <span class="title">iTemplate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $vars = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setVariable</span><span class="params">($name, $var)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;vars[$name] = $var;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="继承多个接口"><a href="#继承多个接口" class="headerlink" title="继承多个接口"></a>继承多个接口</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">b</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">c</span> <span class="keyword">extends</span> <span class="title">a</span>, <span class="title">b</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">baz</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">d</span> <span class="keyword">implements</span> <span class="title">c</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bar</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">baz</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="使用接口常量"><a href="#使用接口常量" class="headerlink" title="使用接口常量"></a>使用接口常量</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> b = <span class="string">'Interface constant'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出接口常量</span></span><br><span class="line"><span class="keyword">echo</span> a::b;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 错误写法，因为常量不能被覆盖。接口常量的概念和类常量是一样的。</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">b</span> <span class="keyword">implements</span> <span class="title">a</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> b = <span class="string">'Class constant'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="Trait"><a href="#Trait" class="headerlink" title="Trait"></a>Trait</h4><p>自 PHP 5.4.0 起，PHP 实现了一种代码复用的方法，称为 trait。可以将多个类中，共用的一些属性和方法提取出来做来公共trait类，就像是装配汽车的配件，如果你的类中要用到这些配件，就直接用 use 导入就可以了，相当于把 trait 中的代码复制到当前类中。因为 trait 不是类，所以不能有静态成员，类常量，当然也不可能被实例化。</p><h5 id="trait-使用"><a href="#trait-使用" class="headerlink" title="trait 使用"></a>trait 使用</h5><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> sayHello &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">say</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">sayHello</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$b = <span class="keyword">new</span> Base();</span><br><span class="line">$b-&gt;say();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>输出：</p><pre><code>Hello</code></pre><h5 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h5><p>从基类继承的成员会被 trait 插入的成员所覆盖。优先顺序是：当前类成员 &gt; trait的方法 &gt; 当前类继承的方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> SayWorld &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">parent</span>::sayHello();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> <span class="keyword">extends</span> <span class="title">Base</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SayWorld</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$o-&gt;sayHello();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Hello World!</code></pre><h5 id="多个-trait"><a href="#多个-trait" class="headerlink" title="多个 trait"></a>多个 trait</h5><p>通过逗号分隔，在 use 声明列出多个 trait，可以都插入到一个类中。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> Hello &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> World &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'World'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Hello</span>, <span class="title">World</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayExclamationMark</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$o-&gt;sayHello();</span><br><span class="line">$o-&gt;sayWorld();</span><br><span class="line">$o-&gt;sayExclamationMark();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Hello World!</code></pre><h5 id="同名冲突"><a href="#同名冲突" class="headerlink" title="同名冲突"></a>同名冲突</h5><p>如果两个 trait 都插入了一个同名的方法，如果没有明确解决冲突将会产生一个致命错误。<br>为了解决多个 trait 在同一个类中的命名冲突，需要使用 <code>insteadof</code> 操作符来明确指定使用冲突方法中的哪一个。<br>以上方式仅允许排除掉其它方法，<code>as</code> 操作符可以 为某个方法引入别名。 注意：<code>as</code> 操作符不会对方法进行重命名，也不会影响其方法。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> A &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">smallTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'a'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bigTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'A'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> B &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">smallTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'b'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">bigTalk</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'B'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Talker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">A</span>, <span class="title">B</span> &#123;</span><br><span class="line">        <span class="title">B</span>::<span class="title">smallTalk</span> <span class="title">insteadof</span> <span class="title">A</span>;</span><br><span class="line">        A::bigTalk <span class="keyword">insteadof</span> B;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Aliased_Talker</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">A</span>, <span class="title">B</span> &#123;</span><br><span class="line">        <span class="title">B</span>::<span class="title">smallTalk</span> <span class="title">insteadof</span> <span class="title">A</span>;</span><br><span class="line">        A::bigTalk <span class="keyword">insteadof</span> B;</span><br><span class="line">        B::bigTalk <span class="keyword">as</span> talk;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> Aliased_Talker();</span><br><span class="line">$a-&gt;smallTalk();    <span class="comment">// 输出 b</span></span><br><span class="line">$a-&gt;bigTalk();      <span class="comment">// 输出 A</span></span><br><span class="line">$a-&gt;talk();         <span class="comment">// 输出 B</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="修改方法的访问控制"><a href="#修改方法的访问控制" class="headerlink" title="修改方法的访问控制"></a>修改方法的访问控制</h5><p>使用 as 语法还可以用来调整方法的访问控制。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> HelloWorld &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 修改 sayHello 的访问控制</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass1</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HelloWorld</span> &#123; <span class="title">sayHello</span> <span class="title">as</span> <span class="title">protected</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给方法一个改变了访问控制的别名</span></span><br><span class="line"><span class="comment">// 原版 sayHello 的访问控制则没有发生变化</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HelloWorld</span> &#123; <span class="title">sayHello</span> <span class="title">as</span> <span class="title">private</span> <span class="title">myPrivateHello</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h5 id="从-trait-来组成-trait"><a href="#从-trait-来组成-trait" class="headerlink" title="从 trait 来组成 trait"></a>从 trait 来组成 trait</h5><p>正如 class 能够使用 trait 一样，其它 trait 也能够使用 trait。在 trait 定义时通过使用一个或多个 trait，能够组合其它 trait 中的部分或全部成员。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> Hello &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> World &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'World!'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">trait</span> HelloWorld &#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Hello</span>, <span class="title">World</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">HelloWorld</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$o = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$o-&gt;sayHello();</span><br><span class="line">$o-&gt;sayWorld();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Hello World!</code></pre><h5 id="trait-的抽象成员"><a href="#trait-的抽象成员" class="headerlink" title="trait 的抽象成员"></a>trait 的抽象成员</h5><p>为了对使用的类施加强制要求，trait 支持抽象方法的使用。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> Hello &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">sayHelloWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'Hello '</span>.<span class="keyword">$this</span>-&gt;getWorld();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWorld</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyHelloWorld</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $world;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">Hello</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getWorld</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;world;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">setWorld</span><span class="params">($val)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;world = $val;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> MyHelloWorld();</span><br><span class="line">$a-&gt;setWorld(<span class="string">"World!"</span>);</span><br><span class="line">$a-&gt;sayHelloWorld();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Hello World!</code></pre><h5 id="trait-的静态成员"><a href="#trait-的静态成员" class="headerlink" title="trait 的静态成员"></a>trait 的静态成员</h5><p>Traits 可以定义静态变量和静态方法</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> StaticExample &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">inc</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span> $c = <span class="number">0</span>;</span><br><span class="line">        $c = $c + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"$c\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">doSomething</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'Doing something'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Example</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">StaticExample</span>;</span><br><span class="line">&#125;</span><br><span class="line">$a = <span class="keyword">new</span> Example();</span><br><span class="line">$a-&gt;inc();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> Example::doSomething();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>1 Doing something</code></pre><h5 id="定义属性"><a href="#定义属性" class="headerlink" title="定义属性"></a>定义属性</h5><p>Trait 同样可以定义属性。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> PropertiesTrait &#123;</span><br><span class="line">    <span class="keyword">public</span> $x = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertiesExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">PropertiesTrait</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$example = <span class="keyword">new</span> PropertiesExample;</span><br><span class="line"><span class="keyword">echo</span> $example-&gt;x;       <span class="comment">// 输出 1</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>Trait 定义了一个属性后，类就不能定义同样名称的属性，否则会产生 fatal error。 有种情况例外：属性是兼容的（同样的访问可见度、初始默认值）。 在 PHP 7.0 之前，属性是兼容的，则会有 E_STRICT 的提醒。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">trait</span> PropertiesTrait &#123;</span><br><span class="line">    <span class="keyword">public</span> $same = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">public</span> $different = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertiesExample</span> </span>&#123;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">PropertiesTrait</span>;</span><br><span class="line">    <span class="keyword">public</span> $same = <span class="keyword">true</span>; <span class="comment">// PHP 7.0.0 后没问题，之前版本是 E_STRICT 提醒</span></span><br><span class="line">    <span class="keyword">public</span> $different = <span class="keyword">true</span>; <span class="comment">// 致命错误</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="匿名类"><a href="#匿名类" class="headerlink" title="匿名类"></a>匿名类</h4><p>PHP 7 开始支持匿名类。 匿名类很有用，可以创建一次性的简单对象。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// PHP 7 之前的代码</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Logger</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$util-&gt;setLogger(<span class="keyword">new</span> Logger());</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用了 PHP 7+ 后的代码</span></span><br><span class="line">$util-&gt;setLogger(<span class="keyword">new</span> <span class="class"><span class="keyword">class</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">log</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>可以传递参数到匿名类的构造器，也可以 extend 其他类、实现接口，以及像其他普通的类一样使用 trait。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SomeClass</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">SomeInterface</span> </span>&#123;&#125;</span><br><span class="line"><span class="keyword">trait</span> SomeTrait &#123;&#125;</span><br><span class="line"></span><br><span class="line">var_dump(new class(10) extends SomeClass implements SomeInterface &#123;</span><br><span class="line">    <span class="keyword">private</span> $num;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($num)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;num = $num;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">use</span> <span class="title">SomeTrait</span>;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>匿名类被嵌套进普通 Class 后，不能访问这个外部类的 private、protected方法或者属性。为了访问外部类 protected 属性或方法，匿名类可以 extend 此外部类。 为了使用外部类的 private 属性，必须通过构造器传进来。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Outer</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $prop = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">protected</span> $prop2 = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">func1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">func2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        return new class($this-&gt;prop) extends Outer &#123;</span><br><span class="line">            <span class="keyword">private</span> $prop3;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($prop)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">$this</span>-&gt;prop3 = $prop;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">func3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;prop2 + <span class="keyword">$this</span>-&gt;prop3 + <span class="keyword">$this</span>-&gt;func1();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> (<span class="keyword">new</span> Outer)-&gt;func2()-&gt;func3();     <span class="comment">// 输出 6</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="重载"><a href="#重载" class="headerlink" title="重载"></a>重载</h4><p>PHP中的”重载”与其它绝大多数面向对象语言不同。传统的”重载”是用于提供多个同名的类方法，但各方法的参数类型和个数不同。<br>PHP所提供的”重载”是指动态地”创建”类属性和方法。我们是通过魔术方法（magic methods）来实现的。当调用当前环境下未定义或不可见的类属性或方法时，重载方法会被调用。<br>所有的重载方法都必须被声明为 public。</p><h5 id="属性重载"><a href="#属性重载" class="headerlink" title="属性重载"></a>属性重载</h5><p><code>public void __set ( string $name , mixed $value )</code><br><code>public mixed __get ( string $name )</code><br><code>public bool __isset ( string $name )</code><br><code>public void __unset ( string $name )</code></p><p>注：mixed 说明一个参数可以接受多种不同的类型。</p><p>在给不可访问属性赋值时，<code>__set()</code> 会被调用。<br>读取不可访问属性的值时，<code>__get()</code> 会被调用。<br>当对不可访问属性调用 isset() 或 <code>empty()</code> 时，<code>__isset()</code> 会被调用。<br>当对不可访问属性调用 unset() 时，<code>__unset()</code> 会被调用。<br>参数 <code>$name</code> 是指要操作的变量名称。<code>__set()</code> 方法的 <code>$value</code> 参数指定了 <code>$name</code> 变量的值。<br>属性重载只能在对象中进行。在静态方法中，这些魔术方法将不会被调用。所以这些方法都不能被 声明为 static。从 PHP 5.3.0 起, 将这些魔术方法定义为 static 会产生一个警告。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PropertyTest</span> </span>&#123;</span><br><span class="line">     <span class="comment">/**  被重载的数据保存在此  */</span></span><br><span class="line">    <span class="keyword">private</span> $data = <span class="keyword">array</span>();</span><br><span class="line">     <span class="comment">/**  重载不能被用在已经定义的属性  */</span></span><br><span class="line">    <span class="keyword">public</span> $declared = <span class="number">1</span>;</span><br><span class="line">     <span class="comment">/**  只有从类外部访问这个属性时，重载才会发生 */</span></span><br><span class="line">    <span class="keyword">private</span> $hidden = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__set</span><span class="params">($name, $value)</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Setting '$name' to '$value'\n"</span>;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[$name] = $value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Getting '$name'\n"</span>;</span><br><span class="line">        <span class="keyword">if</span> (array_key_exists($name, <span class="keyword">$this</span>-&gt;data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data[$name];</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">'Not exists'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__isset</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Is '$name' set?\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;data[$name]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__unset</span><span class="params">($name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Unsetting '$name'\n"</span>;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;data[$name]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**  非魔术方法  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getHidden</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;hidden;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;pre&gt;\n"</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> PropertyTest;</span><br><span class="line">$obj-&gt;a = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;a . <span class="string">"\n\n"</span>;</span><br><span class="line"></span><br><span class="line">var_dump(<span class="keyword">isset</span>($obj-&gt;a));</span><br><span class="line"><span class="keyword">unset</span>($obj-&gt;a);</span><br><span class="line">var_dump(<span class="keyword">isset</span>($obj-&gt;a));</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;declared . <span class="string">"\n\n"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Let's experiment with the private property named 'hidden':\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Privates are visible inside the class, so __get() not used...\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;getHidden() . <span class="string">"\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Privates not visible outside of class, so __get() is used...\n"</span>;</span><br><span class="line"><span class="keyword">echo</span> $obj-&gt;hidden . <span class="string">"\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Setting &apos;a&apos; to &apos;1&apos;Getting &apos;a&apos;1Is &apos;a&apos; set?bool(true)Unsetting &apos;a&apos;Is &apos;a&apos; set?bool(false)1Let&apos;s experiment with the private property named &apos;hidden&apos;:Privates are visible inside the class, so __get() not used...2Privates not visible outside of class, so __get() is used...Getting &apos;hidden&apos;Not exists</code></pre><h5 id="方法重载"><a href="#方法重载" class="headerlink" title="方法重载"></a>方法重载</h5><p><code>public mixed __call ( string $name , array $arguments )</code><br><code>public static mixed __callStatic ( string $name , array $arguments )</code></p><p>在对象中调用一个不可访问方法时，<code>__call()</code> 会被调用。<br>在静态上下文中调用一个不可访问方法时，<code>__callStatic()</code> 会被调用。<br>$name 参数是要调用的方法名称。$arguments 参数是一个枚举数组，包含着要传递给方法 $name 的参数。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MethodTest</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span><span class="params">($name, $arguments)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注意: $name 的值区分大小写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Calling object method '$name' "</span></span><br><span class="line">             . implode(<span class="string">', '</span>, $arguments). <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**  PHP 5.3.0之后版本  */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">__callStatic</span><span class="params">($name, $arguments)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 注意: $name 的值区分大小写</span></span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"Calling static method '$name' "</span></span><br><span class="line">             . implode(<span class="string">', '</span>, $arguments). <span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> MethodTest;</span><br><span class="line">$obj-&gt;runTest(<span class="string">'in object context'</span>);</span><br><span class="line"></span><br><span class="line">MethodTest::runTest(<span class="string">'in static context'</span>);  <span class="comment">// PHP 5.3.0之后版本</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>Calling object method &apos;runTest&apos; in object contextCalling static method &apos;runTest&apos; in static context</code></pre><h4 id="遍历对象"><a href="#遍历对象" class="headerlink" title="遍历对象"></a>遍历对象</h4><p>PHP 5 提供了一种定义对象的方法使其可以通过单元列表来遍历，例如用 foreach 语句。默认情况下，所有可见属性都将被用于遍历。</p><h5 id="简单遍历"><a href="#简单遍历" class="headerlink" title="简单遍历"></a>简单遍历</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var1 = <span class="string">'value 1'</span>;</span><br><span class="line">    <span class="keyword">public</span> $var2 = <span class="string">'value 2'</span>;</span><br><span class="line">    <span class="keyword">public</span> $var3 = <span class="string">'value 3'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> $protected = <span class="string">'protected var'</span>;</span><br><span class="line">    <span class="keyword">private</span>   $private   = <span class="string">'private var'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">iterateVisible</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"MyClass::iterateVisible:\n"</span>;</span><br><span class="line">       <span class="keyword">foreach</span>(<span class="keyword">$this</span> <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">           <span class="keyword">print</span> <span class="string">"$key =&gt; $value\n"</span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$class = <span class="keyword">new</span> MyClass();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line"><span class="keyword">foreach</span>($class <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"$key =&gt; $value\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$class-&gt;iterateVisible();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>var1 =&gt; value 1var2 =&gt; value 2var3 =&gt; value 3MyClass::iterateVisible:var1 =&gt; value 1var2 =&gt; value 2var3 =&gt; value 3protected =&gt; protected varprivate =&gt; private var</code></pre><h5 id="实现-iterator-接口"><a href="#实现-iterator-接口" class="headerlink" title="实现 iterator 接口"></a>实现 iterator 接口</h5><p>更进一步，可以实现 Iterator 接口。可以让对象自行决定如何遍历以及每次遍历时那些值可用。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $var = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($array)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;var = $array;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rewind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"rewinding\n"</span>;</span><br><span class="line">        reset(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">current</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = current(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"current: $var\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = key(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"key: $var\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = next(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"next: $var\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">valid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = <span class="keyword">$this</span>-&gt;current() !== <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"valid: &#123;$var&#125;\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$values = <span class="keyword">array</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line">$it = <span class="keyword">new</span> MyIterator($values);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line"><span class="keyword">foreach</span> ($it <span class="keyword">as</span> $a =&gt; $b) &#123;</span><br><span class="line">    <span class="keyword">print</span> <span class="string">"$a: $b\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>rewindingcurrent: 1valid: 1current: 1key: 00: 1next: 2current: 2valid: 1current: 2key: 11: 2next: 3current: 3valid: 1current: 3key: 22: 3next: current: valid: </code></pre><h5 id="通过实现-IteratorAggregate"><a href="#通过实现-IteratorAggregate" class="headerlink" title="通过实现 IteratorAggregate"></a>通过实现 IteratorAggregate</h5><p>可以用 <code>IteratorAggregate</code> 接口以替代实现所有的 Iterator 方法。<code>IteratorAggregate</code> 只需要实现一个方法 <code>IteratorAggregate::getIterator()</code>，其应返回一个实现了 Iterator 的类的实例。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $var = <span class="keyword">array</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($array)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_array($array)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;var = $array;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">rewind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"rewinding\n"</span>;</span><br><span class="line">        reset(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">current</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = current(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"current: $var\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = key(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"key: $var\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = next(<span class="keyword">$this</span>-&gt;var);</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"next: $var\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">valid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        $var = <span class="keyword">$this</span>-&gt;current() !== <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"valid: &#123;$var&#125;\n"</span>;</span><br><span class="line">        <span class="keyword">return</span> $var;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCollection</span> <span class="keyword">implements</span> <span class="title">IteratorAggregate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $items = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">private</span> $count = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Required definition of interface IteratorAggregate</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyIterator(<span class="keyword">$this</span>-&gt;items);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span><span class="params">($value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;items[<span class="keyword">$this</span>-&gt;count++] = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$coll = <span class="keyword">new</span> MyCollection();</span><br><span class="line">$coll-&gt;add(<span class="string">'value 1'</span>);</span><br><span class="line">$coll-&gt;add(<span class="string">'value 2'</span>);</span><br><span class="line">$coll-&gt;add(<span class="string">'value 3'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> ($coll <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"key/value: [$key -&gt; $val]\n\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="魔术方法"><a href="#魔术方法" class="headerlink" title="魔术方法"></a>魔术方法</h4><p><code>__construct()</code>， <code>__destruct()</code>， <code>__call()</code>， <code>__callStatic()</code>， <code>__get()</code>， <code>__set()</code>， <code>__isset()</code>， <code>__unset()</code>， <code>__sleep()</code>， <code>__wakeup()</code>， <code>__toString()</code>， <code>__invoke()</code>， <code>__set_state()</code>，<code>__clone()</code> 和 <code>__debugInfo()</code> 等方法在 PHP 中被称为”魔术方法”（Magic methods）。在命名自己的类方法时不能使用这些方法名，除非是想使用其魔术功能。</p><p>PHP 将所有以 <code>__</code>（两个下划线）开头的类方法保留为魔术方法。所以在定义类方法时，除了上述魔术方法，建议不要以 <code>__</code> 为前缀。</p><table><thead><tr><th>魔法方法</th><th>说明</th></tr></thead><tbody><tr><td>__sleep</td><td>序列化对象前被调用，可用于清理对象</td></tr><tr><td>__wakeup</td><td>反序列化前被调用</td></tr><tr><td>__toString</td><td>可以将对象当成字符串 比如echo一个对象时调用</td></tr><tr><td>__invoke</td><td>可以让对象当函数进行调用</td></tr><tr><td>__set_state</td><td>调用 var_export() 导出类时此方法被调用</td></tr><tr><td>__debugInfo</td><td>调用 var_dump() 打印对象时被调用 PHP 5.6可用</td></tr></tbody></table><p>简单例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"This is "</span> . <span class="keyword">self</span>::class . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__debugInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> [<span class="string">"message"</span>=&gt;<span class="string">"called __debugInfo()"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"called __invoke()&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$f = <span class="keyword">new</span> foo;</span><br><span class="line"><span class="keyword">echo</span> $f;</span><br><span class="line"><span class="keyword">echo</span> $f();</span><br><span class="line">var_dump($f);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="final-关键字"><a href="#final-关键字" class="headerlink" title="final 关键字"></a>final 关键字</h4><p>PHP 5 新增了一个 final 关键字。如果父类中的方法被声明为 final，则子类无法覆盖该方法。如果一个类被声明为 final，则不能被继承。</p><p>final 方法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"BaseClass::test() called\n"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">moreTesting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"BaseClass::moreTesting() called\n"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildClass</span> <span class="keyword">extends</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">moreTesting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"ChildClass::moreTesting() called\n"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Results in Fatal error: Cannot override final method BaseClass::moreTesting()</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>final 类：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"BaseClass::test() called\n"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="comment">// 这里无论你是否将方法声明为final，都没有关系</span></span><br><span class="line">   <span class="keyword">final</span> <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">moreTesting</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">echo</span> <span class="string">"BaseClass::moreTesting() called\n"</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildClass</span> <span class="keyword">extends</span> <span class="title">BaseClass</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 产生 Fatal error: Class ChildClass may not inherit from final class (BaseClass)</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="对象复制"><a href="#对象复制" class="headerlink" title="对象复制"></a>对象复制</h4><p>在多数情况下，我们并不需要完全复制一个对象来获得其中属性。但有一个情况下确实需要：如果你有一个 GTK 窗口对象，该对象持有窗口相关的资源。你可能会想复制一个新的窗口，保持所有属性与原来的窗口相同，但必须是一个新的对象（因为如果不是新的对象，那么一个窗口中的改变就会影响到另一个窗口）。还有一种情况：如果对象 A 中保存着对象 B 的引用，当你复制对象 A 时，你想其中使用的对象不再是对象 B 而是 B 的一个副本，那么你必须得到对象 A 的一个副本。</p><p>对象复制可以通过 clone 关键字来完成（如果可能，这将调用对象的 <code>__clone()</code> 方法）。对象中的 <code>__clone()</code> 方法不能被直接调用。</p><p>当对象被复制后，PHP 5 会对对象的所有属性执行一个浅复制（shallow copy）。所有的引用属性 仍然会是一个指向原来的变量的引用。</p><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCloneable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $val = <span class="string">"val"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"called __clone()&lt;/br&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> MyCloneable();</span><br><span class="line">$obj2 = <span class="keyword">clone</span> $obj;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"obj =&gt; "</span>.$obj-&gt;val.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"obj2 =&gt; "</span>.$obj2-&gt;val.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">$obj2-&gt;val = <span class="string">"val2"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"obj =&gt; "</span>.$obj-&gt;val.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"obj2 =&gt; "</span>.$obj2-&gt;val.<span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="对象比较"><a href="#对象比较" class="headerlink" title="对象比较"></a>对象比较</h4><p>当使用比较运算符（==）比较两个对象变量时，比较的原则是：如果两个对象的属性和属性值都相等，而且两个对象是同一个类的实例，那么这两个对象变量相等。</p><p>而如果使用全等运算符（===），这两个对象变量一定要指向某个类的同一个实例（即同一个对象）。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseClass</span> </span>&#123;&#125;</span><br><span class="line">$b1 = <span class="keyword">new</span> BaseClass;</span><br><span class="line">$b2 = <span class="keyword">new</span> BaseClass;</span><br><span class="line">$b3 = $b2;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line">var_dump($b1 == $b2);       <span class="comment">// true</span></span><br><span class="line">var_dump($b1 === $b2);      <span class="comment">// false</span></span><br><span class="line">var_dump($b2 === $b3);      <span class="comment">// true</span></span><br><span class="line">var_dump($b2 == $b3);       <span class="comment">// false</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="类型约束"><a href="#类型约束" class="headerlink" title="类型约束"></a>类型约束</h4><p>PHP 5 可以使用类型约束。函数的参数可以指定必须为对象（在函数原型里面指定类的名字），接口，数组（PHP 5.1 起）或者 callable（PHP 5.4 起）。不过如果使用 NULL 作为参数的默认值，那么在调用函数的时候依然可以使用 NULL 作为实参。</p><p>如果一个类或接口指定了类型约束，则其所有的子类或实现也都如此。</p><p>类型约束不能用于标量类型如 int 或 string。Traits 也不允许。</p><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="comment">// 测试函数 第一个参数必须为 OtherClass 类的一个对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">(OtherClass $otherclass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> $otherclass-&gt;var;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 另一个测试函数 第一个参数必须为数组 </span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_array</span><span class="params">(array $input_array)</span> </span>&#123;</span><br><span class="line">        print_r($input_array);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">// 第一个参数必须为递归类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_interface</span><span class="params">(Traversable $iterator)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> get_class($iterator);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 第一个参数必须为回调类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test_callable</span><span class="params">(callable $callback, $data)</span> </span>&#123;</span><br><span class="line">        call_user_func($callback, $data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// OtherClass 类定义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OtherClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var = <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$myclass = <span class="keyword">new</span> MyClass;</span><br><span class="line">$otherclass = <span class="keyword">new</span> OtherClass;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 致命错误：第一个参数必须是 OtherClass 类的一个对象</span></span><br><span class="line">$myclass-&gt;test(<span class="string">'hello'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 致命错误：第一个参数必须为 OtherClass 类的一个实例</span></span><br><span class="line">$foo = <span class="keyword">new</span> stdClass;</span><br><span class="line">$myclass-&gt;test($foo);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 致命错误：第一个参数不能为 null</span></span><br><span class="line">$myclass-&gt;test(<span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：输出 Hello World </span></span><br><span class="line">$myclass-&gt;test($otherclass);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 致命错误：第一个参数必须为数组</span></span><br><span class="line">$myclass-&gt;test_array(<span class="string">'a string'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：输出数组</span></span><br><span class="line">$myclass-&gt;test_array(<span class="keyword">array</span>(<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：输出 ArrayObject</span></span><br><span class="line">$myclass-&gt;test_interface(<span class="keyword">new</span> ArrayObject(<span class="keyword">array</span>()));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确：输出 int(1)</span></span><br><span class="line">$myclass-&gt;test_callable(<span class="string">'var_dump'</span>, <span class="number">1</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>类型约束不只是用在类的成员函数里，也能使用在函数里：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 如下面的类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $var = <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试函数 第一个参数必须是 MyClass 类的一个对象</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyFunction</span> <span class="params">(MyClass $foo)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> $foo-&gt;var;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确</span></span><br><span class="line">$myclass = <span class="keyword">new</span> MyClass;</span><br><span class="line">MyFunction($myclass);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>类型约束允许 NULL 值：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/* 接受 NULL 值 */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">(stdClass $obj = NULL)</span> </span>&#123; &#125;</span><br><span class="line">test(<span class="keyword">NULL</span>);</span><br><span class="line">test(<span class="keyword">new</span> stdClass);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="后期静态绑定"><a href="#后期静态绑定" class="headerlink" title="后期静态绑定"></a>后期静态绑定</h4><p>自 PHP 5.3.0 起，PHP 增加了一个叫做后期静态绑定的功能，用于在继承范围内引用静态调用的类。</p><p>准确说，后期静态绑定工作原理是存储了在上一个”非转发调用”（non-forwarding call）的类名。当进行静态方法调用时，该类名即为明确指定的那个（通常在 :: 运算符左侧部分）；当进行非静态方法调用时，即为该对象所属的类。所谓的”转发调用”（forwarding call）指的是通过以下几种方式进行的静态调用：<code>self::</code>，<code>parent::</code>，<code>static::</code> 以及 <code>forward_static_call()</code>。可用 <code>get_called_class()</code> 函数来得到被调用的方法所在的类名，<code>static::</code> 则指出了其范围。</p><p>该功能从语言内部角度考虑被命名为”后期静态绑定”。”后期绑定”的意思是说，static:: 不再被解析为定义当前方法所在的类，而是在实际运行时计算的。也可以称之为”静态绑定”，因为它可以用于（但不限于）静态方法的调用。</p><h5 id="self-的限制"><a href="#self-的限制" class="headerlink" title="self:: 的限制"></a>self:: 的限制</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">self</span>::who();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">B::test();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>A</code></pre><h5 id="后期静态绑定的用法"><a href="#后期静态绑定的用法" class="headerlink" title="后期静态绑定的用法"></a>后期静态绑定的用法</h5><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">static</span>::who(); <span class="comment">// 后期静态绑定从这里开始</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span> <span class="keyword">extends</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">who</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__CLASS__</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">B::test();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>B</code></pre><p>在非静态环境下，所调用的类即为该对象实例所属的类。由于 $this-&gt; 会在同一作用范围内尝试调用私有方法，而 static:: 则可能给出不同结果。另一个区别是 static:: 只能用于静态属性。</p><h4 id="对象和引用"><a href="#对象和引用" class="headerlink" title="对象和引用"></a>对象和引用</h4><p>在php5 的对象编程经常提到的一个关键点是“默认情况下对象是通过引用传递的”。但其实这不是完全正确的。下面通过一些例子来说明。</p><p>PHP 的引用是别名，就是两个不同的变量名字指向相同的内容。在 PHP 5，一个对象变量已经不再保存整个对象的值。只是保存一个标识符来访问真正的对象内容。 当对象作为参数传递，作为结果返回，或者赋值给另外一个变量，另外一个变量跟原来的不是引用的关系，只是他们都保存着同一个标识符的拷贝，这个标识符指向同一个对象的真正内容。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $foo = <span class="number">1</span>;</span><br><span class="line">&#125;  </span><br><span class="line">$a = <span class="keyword">new</span> A;</span><br><span class="line">$b = $a;     <span class="comment">// $a ,$b都是同一个标识符的拷贝</span></span><br><span class="line">             <span class="comment">// ($a) = ($b) = &lt;id&gt;</span></span><br><span class="line">$b-&gt;foo = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">echo</span> $a-&gt;foo.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$c = <span class="keyword">new</span> A;</span><br><span class="line">$d = &amp;$c;    <span class="comment">// $c ,$d是引用</span></span><br><span class="line">             <span class="comment">// ($c,$d) = &lt;id&gt;</span></span><br><span class="line">$d-&gt;foo = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">echo</span> $c-&gt;foo.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"></span><br><span class="line">$e = <span class="keyword">new</span> A;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">($obj)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ($obj) = ($e) = &lt;id&gt;</span></span><br><span class="line">    $obj-&gt;foo = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foo($e);</span><br><span class="line"><span class="keyword">echo</span> $e-&gt;foo.<span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>222</code></pre><h4 id="对象序列化"><a href="#对象序列化" class="headerlink" title="对象序列化"></a>对象序列化</h4><p>所有php里面的值都可以使用函数serialize()来返回一个包含字节流的字符串来表示。unserialize()函数能够重新把字符串变回php原来的值。 序列化一个对象将会保存对象的所有变量，但是不会保存对象的方法，只会保存类的名字。</p><p>为了能够unserialize()一个对象，这个对象的类必须已经定义过。如果序列化类A的一个对象，将会返回一个跟类A相关，而且包含了对象所有变量值的字符串。 如果要想在另外一个文件中解序列化一个对象，这个对象的类必须在解序列化之前定义，可以通过包含一个定义该类的文件或使用函数<code>spl_autoload_register()</code>来实现。</p><p>classa.inc<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $one = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">show_one</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;one;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>page1.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"classa.inc"</span>);</span><br><span class="line">$a = <span class="keyword">new</span> A;</span><br><span class="line">$s = serialize($a);</span><br><span class="line"><span class="comment">// 把变量$s保存起来以便文件page2.php能够读到</span></span><br><span class="line">file_put_contents(<span class="string">'store'</span>, $s);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>page2.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">// 要正确了解序列化，必须包含下面一个文件</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">"classa.inc"</span>);</span><br><span class="line">$s = file_get_contents(<span class="string">'store'</span>);</span><br><span class="line">$a = unserialize($s);</span><br><span class="line"><span class="comment">// 现在可以使用对象$a里面的函数 show_one()</span></span><br><span class="line">$a-&gt;show_one();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>先执行 page1.php 再执行 page2.php 就可以看到结果了。</p><h3 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h3><h4 id="命名空间概述"><a href="#命名空间概述" class="headerlink" title="命名空间概述"></a>命名空间概述</h4><p>什么是命名空间？从广义上来说，命名空间是一种封装事物的方法。在很多地方都可以见到这种抽象概念。例如，在操作系统中目录用来将相关文件分组，对于目录中的文件来说，它就扮演了命名空间的角色。具体举个例子，文件 foo.txt 可以同时在目录/home/greg 和 /home/other 中存在，但在同一个目录中不能存在两个 foo.txt 文件。另外，在目录 /home/greg 外访问 foo.txt 文件时，我们必须将目录名以及目录分隔符放在文件名之前得到 /home/greg/foo.txt。这个原理应用到程序设计领域就是命名空间的概念。</p><p>在PHP中，命名空间用来解决在编写类库或应用程序时创建可重用的代码如类或函数时碰到的两类问题：</p><ol><li>用户编写的代码与PHP内部的类/函数/常量或第三方类/函数/常量之间的名字冲突。</li><li>为很长的标识符名称(通常是为了缓解第一类问题而定义的)创建一个别名（或简短）的名称，提高源代码的可读性。</li></ol><p>PHP 命名空间提供了一种将相关的类、函数和常量组合到一起的途径。</p><h4 id="定义命名空间"><a href="#定义命名空间" class="headerlink" title="定义命名空间"></a>定义命名空间</h4><p>虽然任意合法的PHP代码都可以包含在命名空间中，但只有以下类型的代码受命名空间的影响，它们是：类（包括抽象类和traits）、接口、函数和常量。</p><p>命名空间通过关键字namespace 来声明。如果一个文件中包含命名空间，它必须在其它所有代码之前声明命名空间，除了一个以外：declare关键字。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span>;</span><br><span class="line"><span class="keyword">const</span> CONNECT_OK = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span>  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>在声明命名空间之前唯一合法的代码是用于定义源文件编码方式的 declare 语句。另外，所有非 PHP 代码包括空白符都不能出现在命名空间的声明之前：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span>; <span class="comment">// 致命错误 -　命名空间必须是程序脚本的第一条语句</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>另外，与PHP其它的语言特征不同，同一个命名空间可以定义在多个文件中，即允许将同一个命名空间的内容分割存放在不同的文件中。</p><h4 id="定义子命名空间"><a href="#定义子命名空间" class="headerlink" title="定义子命名空间"></a>定义子命名空间</h4><p>与目录和文件的关系很象，PHP 命名空间也允许指定层次化的命名空间的名称。因此，命名空间的名字可以使用分层次的方式定义：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span>\<span class="title">Sub</span>\<span class="title">Level</span>;</span><br><span class="line"><span class="keyword">const</span> CONNECT_OK = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span>  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>上面的例子创建了常量 <code>MyProject\Sub\Level\CONNECT_OK</code>，类 <code>MyProject\Sub\Level\Connection</code> 和函数 <code>MyProject\Sub\Level\connect</code>。</p><h4 id="同一个文件多个命名空间"><a href="#同一个文件多个命名空间" class="headerlink" title="同一个文件多个命名空间"></a>同一个文件多个命名空间</h4><p>也可以在同一个文件中定义多个命名空间。在同一个文件中定义多个命名空间有两种语法形式。</p><p>简单组合语法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span>;</span><br><span class="line"><span class="keyword">const</span> CONNECT_OK = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span>  &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AnotherProject</span>;</span><br><span class="line"><span class="keyword">const</span> CONNECT_OK = <span class="number">1</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span>  &#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>不建议使用这种语法在单个文件中定义多个命名空间。建议使用下面的大括号形式的语法。</p><p>大括号语法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span> &#123;</span><br><span class="line"><span class="title">const</span> <span class="title">CONNECT_OK</span> = 1;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span>  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">AnotherProject</span> &#123;</span><br><span class="line"><span class="title">const</span> <span class="title">CONNECT_OK</span> = 1;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span>  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>在实际的编程实践中，非常不提倡在同一个文件中定义多个命名空间。这种方式的主要用于将多个 PHP 脚本合并在同一个文件中。</p><p>将全局的非命名空间中的代码与命名空间中的代码组合在一起，只能使用大括号形式的语法。全局代码必须用一个不带名称的 namespace 语句加上大括号括起来，例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span> &#123;</span><br><span class="line"><span class="title">const</span> <span class="title">CONNECT_OK</span> = 1;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Connection</span> </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connect</span><span class="params">()</span> </span>&#123; <span class="comment">/* ... */</span>  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> &#123; // <span class="title">global</span> <span class="title">code</span></span><br><span class="line"><span class="title">session_start</span>();</span><br><span class="line">$a = MyProject\connect();</span><br><span class="line"><span class="keyword">echo</span> MyProject\Connection::start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>除了开始的declare语句外，命名空间的括号外不得有任何PHP代码。</p><h4 id="使用命名空间：基础"><a href="#使用命名空间：基础" class="headerlink" title="使用命名空间：基础"></a>使用命名空间：基础</h4><p>在讨论如何使用命名空间之前，必须了解 PHP 是如何知道要使用哪一个命名空间中的元素的。可以将 PHP 命名空间与文件系统作一个简单的类比。在文件系统中访问一个文件有三种方式：</p><ol><li>相对文件名形式如foo.txt。它会被解析为 <code>currentdirectory/foo.txt</code>，其中 <code>currentdirectory</code> 表示当前目录。因此如果当前目录是 <code>/home/foo</code>，则该文件名被解析为 <code>/home/foo/foo.txt</code>。</li><li>相对路径名形式如 <code>subdirectory/foo.txt</code>。它会被解析为 <code>currentdirectory/subdirectory/foo.txt</code>。</li><li>绝对路径名形式如 <code>/main/foo.txt</code>。它会被解析为 <code>/main/foo.txt</code>。</li></ol><p>PHP 命名空间中的元素使用同样的原理。例如，类名可以通过三种方式引用：</p><ol><li>非限定名称，或不包含前缀的类名称，例如 <code>$a=new foo()</code>; 或 <code>foo::staticmethod();</code>。如果当前命名空间是 <code>currentnamespace</code>，foo 将被解析为 <code>currentnamespace\foo</code>。如果使用 foo 的代码是全局的，不包含在任何命名空间中的代码，则 foo 会被解析为 foo。 警告：如果命名空间中的函数或常量未定义，则该非限定的函数名称或常量名称会被解析为全局函数名称或常量名称。</li><li>限定名称，或包含前缀的名称，例如 <code>$a = new subnamespace\foo()</code>; 或 <code>subnamespace\foo::staticmethod()</code>;。如果当前的命名空间是 <code>currentnamespace</code>，则 foo 会被解析为 <code>currentnamespace\subnamespace\foo</code>。如果使用 foo 的代码是全局的，不包含在任何命名空间中的代码，foo 会被解析为 <code>subnamespace\foo</code>。</li><li>完全限定名称，或包含了全局前缀操作符的名称，例如，<code>$a = new \currentnamespace\foo();</code> 或 <code>\currentnamespace\foo::staticmethod();</code>。在这种情况下，foo 总是被解析为代码中的文字名 <code>currentnamespace\foo</code>。</li></ol><p>示例：</p><p>file1.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Foo</span>\<span class="title">Bar</span>\<span class="title">subnamespace</span>;</span><br><span class="line"><span class="keyword">const</span> FOO = <span class="number">1</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">staticmethod</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>file2.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Foo</span>\<span class="title">Bar</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'file1.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FOO = <span class="number">2</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="function"><span class="keyword">function</span> <span class="title">staticmethod</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 非限定名称 */</span></span><br><span class="line">foo(); <span class="comment">// 解析为方法 Foo\Bar\foo </span></span><br><span class="line">foo::staticmethod(); <span class="comment">// 解析为类 Foo\Bar\foo 的静态方法 staticmethod。</span></span><br><span class="line"><span class="keyword">echo</span> FOO; <span class="comment">// 解析为常量 Foo\Bar\FOO</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 限定名称 */</span></span><br><span class="line">subnamespace\foo(); <span class="comment">// 解析为函数 Foo\Bar\subnamespace\foo</span></span><br><span class="line">subnamespace\foo::staticmethod(); <span class="comment">// 解析为类 Foo\Bar\subnamespace\foo 的静态方法 staticmethod</span></span><br><span class="line"><span class="keyword">echo</span> subnamespace\FOO; <span class="comment">// 解析为常量 Foo\Bar\subnamespace\FOO</span></span><br><span class="line">                                  </span><br><span class="line"><span class="comment">/* 完全限定名称 */</span></span><br><span class="line">\Foo\Bar\foo(); <span class="comment">// 解析为函数 Foo\Bar\foo</span></span><br><span class="line">\Foo\Bar\foo::staticmethod(); <span class="comment">// 解析为类 Foo\Bar\foo, 以及类的方法 staticmethod</span></span><br><span class="line"><span class="keyword">echo</span> \Foo\Bar\FOO; <span class="comment">// 解析为常量 Foo\Bar\FOO</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>注意：访问任意全局类、函数或常量，都可以使用完全限定名称，例如 <code>\strlen()</code> 或 <code>\Exception</code> 或 <code>\INI_ALL</code>。</p><h4 id="命名空间和动态语言特征"><a href="#命名空间和动态语言特征" class="headerlink" title="命名空间和动态语言特征"></a>命名空间和动态语言特征</h4><p>PHP 命名空间的实现受到其语言自身的动态特征的影响。因此，如果要将下面的代码转换到命名空间中：</p><p>example1.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">classname</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span>,<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">funcname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span>,<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> constname = <span class="string">"global"</span>;</span><br><span class="line"></span><br><span class="line">$a = <span class="string">'classname'</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> $a; <span class="comment">// prints classname::__construct</span></span><br><span class="line">$b = <span class="string">'funcname'</span>;</span><br><span class="line">$b(); <span class="comment">// prints funcname</span></span><br><span class="line"><span class="keyword">echo</span> constant(<span class="string">'constname'</span>), <span class="string">"\n"</span>; <span class="comment">// prints global</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>必须使用完全限定名称（包括命名空间前缀的类名称）。注意因为在动态的类名称、函数名称或常量名称中，限定名称和完全限定名称没有区别，因此其前导的反斜杠是不必要的。</p><p>example2.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">namespacename</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">classname</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">__METHOD__</span>,<span class="string">"\n"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">funcname</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="keyword">__FUNCTION__</span>,<span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> constname = <span class="string">"namespaced"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span> <span class="string">'example1.php'</span>;</span><br><span class="line"></span><br><span class="line">$a = <span class="string">'classname'</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> $a; <span class="comment">// prints classname::__construct</span></span><br><span class="line">$b = <span class="string">'funcname'</span>;</span><br><span class="line">$b(); <span class="comment">// prints funcname</span></span><br><span class="line"><span class="keyword">echo</span> constant(<span class="string">'constname'</span>), <span class="string">"\n"</span>; <span class="comment">// prints global</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* note that if using double quotes, "\\namespacename\\classname" must be used */</span></span><br><span class="line">$a = <span class="string">'\namespacename\classname'</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> $a; <span class="comment">// prints namespacename\classname::__construct</span></span><br><span class="line">$a = <span class="string">'namespacename\classname'</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> $a; <span class="comment">// also prints namespacename\classname::__construct</span></span><br><span class="line">$b = <span class="string">'namespacename\funcname'</span>;</span><br><span class="line">$b(); <span class="comment">// prints namespacename\funcname</span></span><br><span class="line">$b = <span class="string">'\namespacename\funcname'</span>;</span><br><span class="line">$b(); <span class="comment">// also prints namespacename\funcname</span></span><br><span class="line"><span class="keyword">echo</span> constant(<span class="string">'\namespacename\constname'</span>), <span class="string">"\n"</span>; <span class="comment">// prints namespaced</span></span><br><span class="line"><span class="keyword">echo</span> constant(<span class="string">'namespacename\constname'</span>), <span class="string">"\n"</span>; <span class="comment">// also prints namespaced</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="NAMESPACE-常量"><a href="#NAMESPACE-常量" class="headerlink" title="__NAMESPACE__常量"></a>__NAMESPACE__常量</h4><p>PHP支持两种抽象的访问当前命名空间内部元素的方法，<code>__NAMESPACE__</code> 魔术常量和 <code>namespace</code> 关键字。</p><p><code>__NAMESPACE__</code> 示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="keyword">__NAMESPACE__</span>;     <span class="comment">// 输出 MyProject</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>全局代码：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">echo</span> <span class="keyword">__NAMESPACE__</span>;     <span class="comment">// 输出空白 __NAMESPACE__为空字符串。</span></span><br></pre></td></tr></table></figure></p><p>常量 <code>__NAMESPACE__</code> 在动态创建名称时很有用，例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get</span><span class="params">($classname)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $a = <span class="keyword">__NAMESPACE__</span> . <span class="string">'\\'</span> . $classname;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> $a;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="namespace关键字"><a href="#namespace关键字" class="headerlink" title="namespace关键字"></a>namespace关键字</h4><p>关键字 namespace 可用来显式访问当前命名空间或子命名空间中的元素。它等价于类中的 self 操作符。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">MyProject</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">blah</span>\<span class="title">blah</span> <span class="title">as</span> <span class="title">mine</span>; <span class="comment">// 查看下一节内容 使用命名空间：别名/导入</span></span><br><span class="line"></span><br><span class="line">blah\mine(); <span class="comment">// 调用函数 MyProject\blah\mine()</span></span><br><span class="line"><span class="keyword">namespace</span>\<span class="title">blah</span>\<span class="title">mine</span>(); <span class="comment">// 调用函数 MyProject\blah\mine()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>\<span class="title">func</span>(); <span class="comment">// 调用函数 MyProject\func()</span></span><br><span class="line"><span class="keyword">namespace</span>\<span class="title">sub</span>\<span class="title">func</span>(); <span class="comment">// 调用函数 MyProject\sub\func()</span></span><br><span class="line"><span class="keyword">namespace</span>\<span class="title">cname</span>::<span class="title">method</span>(); <span class="comment">// 调用 MyProject\cname 类的静态方法 "method" of class </span></span><br><span class="line">$a = <span class="keyword">new</span> <span class="keyword">namespace</span>\<span class="title">sub</span>\<span class="title">cname</span>(); <span class="comment">// MyProject\sub\cname 类的实例对象</span></span><br><span class="line">$b = <span class="keyword">namespace</span>\<span class="title">CONSTANT</span>; <span class="comment">// 将 MyProject\CONSTANT 的常量赋值给 $b</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="使用命名空间：别名-导入"><a href="#使用命名空间：别名-导入" class="headerlink" title="使用命名空间：别名/导入"></a>使用命名空间：别名/导入</h4><p>允许通过别名引用或导入外部的完全限定名称，是命名空间的一个重要特征。这有点类似于在类 unix 文件系统中可以创建对其它的文件或目录的符号连接。</p><p>所有支持命名空间的PHP版本支持三种别名或导入方式：为类名称使用别名、为接口使用别名或为命名空间名称使用别名。PHP 5.6开始允许导入函数或常量或者为它们设置别名。</p><p>在PHP中，别名是通过操作符 use 来实现的. 下面是一个使用所有可能的五种导入方式的例子：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">foo</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span> <span class="title">as</span> <span class="title">Another</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 下面的例子与 use My\Full\NSname as NSname 相同</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">NSname</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入一个全局类</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">ArrayObject</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// importing a function (PHP 5.6+)</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">function</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">functionName</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// aliasing a function (PHP 5.6+)</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">function</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">functionName</span> <span class="title">as</span> <span class="title">func</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// importing a constant (PHP 5.6+)</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">const</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">CONSTANT</span>;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> <span class="keyword">namespace</span>\<span class="title">Another</span>; <span class="comment">// 实例化 foo\Another 对象</span></span><br><span class="line">$obj = <span class="keyword">new</span> Another; <span class="comment">// 实例化 My\Full\Classname　对象</span></span><br><span class="line">NSname\subns\func(); <span class="comment">// 调用函数 My\Full\NSname\subns\func</span></span><br><span class="line">$a = <span class="keyword">new</span> ArrayObject(<span class="keyword">array</span>(<span class="number">1</span>)); <span class="comment">// 实例化 ArrayObject 对象</span></span><br><span class="line"><span class="comment">// 如果不使用 "use \ArrayObject" ，则实例化一个 foo\ArrayObject 对象</span></span><br><span class="line">func(); <span class="comment">// calls function My\Full\functionName</span></span><br><span class="line"><span class="keyword">echo</span> CONSTANT; <span class="comment">// echoes the value of My\Full\CONSTANT</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>注意对命名空间中的名称（包含命名空间分隔符的完全限定名称如 Foo\Bar以及相对的不包含命名空间分隔符的全局名称如 FooBar）来说，前导的反斜杠是不必要的也不推荐的，因为导入的名称必须是完全限定的，不会根据当前的命名空间作相对解析。<br>为了简化操作，PHP还支持在一行中使用多个use语句</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span> <span class="title">as</span> <span class="title">Another</span>, <span class="title">My</span>\<span class="title">Full</span>\<span class="title">NSname</span>;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> Another; <span class="comment">// 实例化 My\Full\Classname 对象</span></span><br><span class="line">NSname\subns\func(); <span class="comment">// 调用函数 My\Full\NSname\subns\func</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>导入操作是在编译执行的，但动态的类名称、函数名称或常量名称则不是。</p><p>导入和动态名称：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span> <span class="title">as</span> <span class="title">Another</span>, <span class="title">My</span>\<span class="title">Full</span>\<span class="title">NSname</span>;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> Another; <span class="comment">// 实例化一个 My\Full\Classname 对象</span></span><br><span class="line">$a = <span class="string">'Another'</span>;</span><br><span class="line">$obj = <span class="keyword">new</span> $a;      <span class="comment">// 实际化一个 Another 对象</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>另外，导入操作只影响非限定名称和限定名称。完全限定名称由于是确定的，故不受导入的影响。</p><p>导入和完全限定名称：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">use</span> <span class="title">My</span>\<span class="title">Full</span>\<span class="title">Classname</span> <span class="title">as</span> <span class="title">Another</span>, <span class="title">My</span>\<span class="title">Full</span>\<span class="title">NSname</span>;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> Another;         <span class="comment">// instantiates object of class My\Full\Classname</span></span><br><span class="line">$obj = <span class="keyword">new</span> \Another;        <span class="comment">// instantiates object of class Another</span></span><br><span class="line">$obj = <span class="keyword">new</span> Another\thing;   <span class="comment">// instantiates object of class My\Full\Classname\thing</span></span><br><span class="line">$obj = <span class="keyword">new</span> \Another\thing;  <span class="comment">// instantiates object of class Another\thing</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="全局空间"><a href="#全局空间" class="headerlink" title="全局空间"></a>全局空间</h4><p>如果没有定义任何命名空间，所有的类与函数的定义都是在全局空间，与 PHP 引入命名空间概念前一样。在名称前加上前缀 \ 表示该名称是全局空间中的名称，即使该名称位于其它的命名空间中时也是如此。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">A</span>\<span class="title">B</span>\<span class="title">C</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 这个函数是 A\B\C\fopen */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fopen</span><span class="params">()</span> </span>&#123; </span><br><span class="line">     <span class="comment">/* ... */</span></span><br><span class="line">     $f = \fopen(...); <span class="comment">// 调用全局的fopen函数</span></span><br><span class="line">     <span class="keyword">return</span> $f;</span><br><span class="line">&#125; </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="后备全局函数-常量"><a href="#后备全局函数-常量" class="headerlink" title="后备全局函数/常量"></a>后备全局函数/常量</h4><p>在一个命名空间中，当 PHP 遇到一个非限定的类、函数或常量名称时，它使用不同的优先策略来解析该名称。类名称总是解析到当前命名空间中的名称。因此在访问系统内部或不包含在命名空间中的类名称时，必须使用完全限定名称，例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">A</span>\<span class="title">B</span>\<span class="title">C</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exception</span> <span class="keyword">extends</span> \<span class="title">Exception</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">$a = <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'hi'</span>); <span class="comment">// $a 是类 A\B\C\Exception 的一个对象</span></span><br><span class="line">$b = <span class="keyword">new</span> \<span class="keyword">Exception</span>(<span class="string">'hi'</span>); <span class="comment">// $b 是类 Exception 的一个对象</span></span><br><span class="line">$c = <span class="keyword">new</span> ArrayObject; <span class="comment">// 致命错误, 找不到 A\B\C\ArrayObject 类</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>对于函数和常量来说，如果当前命名空间中不存在该函数或常量，PHP 会退而使用全局空间中的函数或常量。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">A</span>\<span class="title">B</span>\<span class="title">C</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> E_ERROR = <span class="number">45</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">strlen</span><span class="params">($str)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> \strlen($str) - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> E_ERROR, <span class="string">"\n"</span>; <span class="comment">// 输出 "45"</span></span><br><span class="line"><span class="keyword">echo</span> INI_ALL, <span class="string">"\n"</span>; <span class="comment">// 输出 "7" - 使用全局常量 INI_ALL</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> strlen(<span class="string">'hi'</span>), <span class="string">"\n"</span>; <span class="comment">// 输出 "1"</span></span><br><span class="line"><span class="keyword">if</span> (is_array(<span class="string">'hi'</span>)) &#123; <span class="comment">// 输出 "is not array"</span></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"is array\n"</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"is not array\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="名称解析规则"><a href="#名称解析规则" class="headerlink" title="名称解析规则"></a>名称解析规则</h4><p>名称解析遵循下列规则：</p><ol><li>对完全限定名称的函数，类和常量的调用在编译时解析。例如 new \A\B 解析为类 A\B。</li><li>所有的非限定名称和限定名称（非完全限定名称）根据当前的导入规则在编译时进行转换。例如，如果命名空间 A\B\C 被导入为 C，那么对 C\D\e() 的调用就会被转换为 A\B\C\D\e()。</li><li>在命名空间内部，所有的没有根据导入规则转换的限定名称均会在其前面加上当前的命名空间名称。例如，在命名空间 A\B 内部调用 C\D\e()，则 C\D\e() 会被转换为 A\B\C\D\e() 。</li><li>非限定类名根据当前的导入规则在编译时转换（用全名代替短的导入名称）。例如，如果命名空间 A\B\C 导入为C，则 new C() 被转换为 new A\B\C() 。</li><li>在命名空间内部（例如A\B），对非限定名称的函数调用是在运行时解析的。例如对函数 foo() 的调用是这样解析的：<ol><li>在当前命名空间中查找名为 A\B\foo() 的函数</li><li>尝试查找并调用 全局(global) 空间中的函数 foo()。</li></ol></li><li>在命名空间（例如A\B）内部对非限定名称或限定名称类（非完全限定名称）的调用是在运行时解析的。下面是调用 new C() 及 new D\E() 的解析过程： new C()的解析:<ol><li>在当前命名空间中查找A\B\C类。</li><li>尝试自动装载类A\B\C。</li></ol></li></ol><p>new D\E()的解析:</p><ol><li>在类名称前面加上当前命名空间名称变成：A\B\D\E，然后查找该类。</li><li>尝试自动装载类 A\B\D\E。</li></ol><p>为了引用全局命名空间中的全局类，必须使用完全限定名称 new \C()。</p><h3 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h3><h4 id="错误基础"><a href="#错误基础" class="headerlink" title="错误基础"></a>错误基础</h4><p>可悲的是，不管我们在写代码时多么小心，错误始终是有的。PHP将会为许多常见的我文件和运行问题提供错误，警告和一些通知，同时让我们知道如何检测和处理这些错误，使得调试程序容易的多。</p><p>PHP会报告与各种错误条件相对应的各种错误。</p><p>如果没有设置错误处理程序，则PHP将根据其配置处理错误。哪些错误报告或者哪些错误忽略是通过<code>error_reporting</code>指令控制（php.ini）。或者在运行时调用<code>error_reporting()</code>，但是不推荐这样配置，因为在脚本执行之前可能也会发生一些错误。</p><p>在开发环境，你应该配置<code>error_reporting</code>为<code>E_ALL</code>，因为你需要了解并解决PHP提出的问题。在生产环境，你可能希望将此设置的不太详细，比如 <code>E_ALL</code>, <code>E_NOTICE</code>, <code>E_STRICT</code>, <code>E_DEPRECATED</code>。但在许多情况下，<code>E_ALL</code>也是合适的，因为它可以提供潜在问题的早期预警。</p><p>PHP对错误的处理取决于两个 php.ini 指令。<code>display_errors</code> 控制是否将错误显示为脚本输出的一部分。应该始终在生产环境中禁用它，因为它可以包含诸如数据库密码之类的机密信息，但是它常常在开发环境启用，因为它可以确保立即报告问题。</p><p>除了显示错误，PHP也可以启用 <code>log_errors</code> 指令来记录错误日志。它将记录任何错误到错误日志文件，这在生产环境非常适用，你可以记录发生的错误，然后根据错误生成报告。</p><h4 id="PHP-7-错误处理"><a href="#PHP-7-错误处理" class="headerlink" title="PHP 7 错误处理"></a>PHP 7 错误处理</h4><p>PHP 7 改变了大多数错误的报告方式。不同于传统（PHP 5）的错误报告机制，现在大多数错误被作为 Error 异常抛出。</p><p>这种 Error 异常可以像 Exception 异常一样被第一个匹配的 <code>try / catch</code> 块所捕获。如果没有匹配的 catch 块，则调用异常处理函数（事先通过 <code>set_exception_handler()</code> 注册）进行处理。 如果尚未注册异常处理函数，则按照传统方式处理：被报告为一个致命错误（Fatal Error）。</p><p>Error 类并非继承自 Exception 类，所以不能用 <code>catch (Exception $e) { ... }</code> 来捕获 Error。你可以用 <code>catch (Error $e) { ... }</code>，或者通过注册异常处理函数 <code>set_exception_handler()</code> 来捕获 Error。</p><h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><h4 id="异常处理"><a href="#异常处理" class="headerlink" title="异常处理"></a>异常处理</h4><p>PHP 5 有一个类似于其他语言的异常处理模型。在PHP中可以主动抛出和捕获一个异常。代码被包含在 try 代码块中以便可以捕获，每一个 try 代码块都至少要有一个 catch 代码块或者 finally 代码块。</p><p>可以使用多个 catch 块来捕获不同类别的异常，代码正常执行（try 代码块中没有抛出异常）则不会执行所有 catch 代码块的内容，异常也可以在 catch 代码块中重新抛出。<br>当抛出异常时，将不会继续执行下面的代码，PHP将尝试查找第一个匹配的 catch 块，如果一个异常没有捕捉到，将发出一个未捕捉的异常的消息，除非处理程序已定义了 <code>set_exception_handler()</code>。</p><p>在 PHP 5 和更高的版本，finally 代码块可以在最后一个 catch 块后指定，finally 块在 try 和 catch 执行完后总会执行的，不管是否抛出异常，finally 块的内容总会执行。</p><p>除了代码运行产生的异常 还可以使用 throw 主动抛出一个异常，抛出的异常需要是一个异常的类的对象。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">inverse</span><span class="params">($x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!$x) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="keyword">Exception</span>(<span class="string">'Division by zero.&lt;/br&gt;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>/$x;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> inverse(<span class="number">5</span>) . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> inverse(<span class="number">0</span>) . <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line">&#125; <span class="keyword">catch</span> (<span class="keyword">Exception</span> $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'Caught exception: '</span>,  $e-&gt;getMessage();</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"Second finally.&lt;/br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Continue execution</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">"Hello World&lt;/br&gt;"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>0.2Caught exception: Division by zero.Second finally.Hello World</code></pre><h4 id="自定义异常"><a href="#自定义异常" class="headerlink" title="自定义异常"></a>自定义异常</h4><p>可以通过继承异常类来自定义异常，<code>Exception</code> 是所有异常的基类。</p><p>Exception 类摘要：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">    <span class="comment">/* 属性 */</span></span><br><span class="line">    <span class="keyword">protected</span> string $message ;     <span class="comment">// 异常消息内容</span></span><br><span class="line">    <span class="keyword">protected</span> int $code ;           <span class="comment">// 异常代码</span></span><br><span class="line">    <span class="keyword">protected</span> string $file ;        <span class="comment">// 抛出异常的文件名</span></span><br><span class="line">    <span class="keyword">protected</span> int $line ;           <span class="comment">// 抛出异常在该文件中的行号</span></span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> __construct ([ string $message = <span class="string">""</span> [, int $code = <span class="number">0</span> [, Throwable $previous = <span class="keyword">NULL</span> ]]] )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> string getMessage ( void )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> Throwable getPrevious ( void )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> int getCode ( void )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> string getFile ( void )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> int getLine ( void )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">array</span> getTrace ( void )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">public</span> string getTraceAsString ( void )</span><br><span class="line">    <span class="keyword">public</span> string __toString ( void )</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> void __clone ( void )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>继承异常类：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyException</span> <span class="keyword">extends</span> <span class="title">Exception</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> MyException(<span class="string">"自定义异常"</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (MyException $e) &#123;</span><br><span class="line">    <span class="keyword">echo</span> $e . <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"捕捉到了自定义异常&lt;/br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>MyException: 自定义异常 in F:\phpstudy\src\index.php:5 Stack trace: #0 {main}捕捉到了自定义异常</code></pre><h3 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h3><h4 id="生成器总览"><a href="#生成器总览" class="headerlink" title="生成器总览"></a>生成器总览</h4><p>生成器提供了一种更容易的方法来实现简单的对象迭代，相比较定义类实现 Iterator 接口的方式，性能开销和复杂性大大降低。</p><p>生成器允许你在 foreach 代码块中写代码来迭代一组数据而不需要在内存中创建一个数组, 那会使你的内存达到上限，或者会占据可观的处理时间。相反，你可以写一个生成器函数，就像一个普通的自定义函数一样, 和普通函数只返回一次不同的是, 生成器可以根据需要 yield 多次，以便生成需要迭代的值。</p><p>一个简单的例子就是使用生成器来重新实现 range() 函数。 标准的 range() 函数需要在内存中生成一个数组包含每一个在它范围内的值，然后返回该数组, 结果就是会产生多个很大的数组。 比如，调用 range(0, 1000000) 将导致内存占用超过 100 MB。</p><p>做为一种替代方法, 我们可以实现一个 xrange() 生成器, 只需要足够的内存来创建 Iterator 对象并在内部跟踪生成器的当前状态，这样只需要不到1K字节的内存。</p><p>将 range() 实现为生成器：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">xrange</span><span class="params">($start, $limit, $step = <span class="number">1</span>)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ($start &lt; $limit) &#123;</span><br><span class="line">        <span class="keyword">if</span> ($step &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LogicException(<span class="string">'Step must be +ve'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> ($i = $start; $i &lt;= $limit; $i += $step) &#123;</span><br><span class="line">            <span class="keyword">yield</span> $i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> ($step &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LogicException(<span class="string">'Step must be -ve'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> ($i = $start; $i &gt;= $limit; $i += $step) &#123;</span><br><span class="line">            <span class="keyword">yield</span> $i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意下面range()和xrange()输出的结果是一样的。</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Single digit odd numbers from range():  '</span>;</span><br><span class="line"><span class="keyword">foreach</span> (range(<span class="number">0</span>,<span class="number">10</span>) <span class="keyword">as</span> $number) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$number "</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;/br&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Single digit odd numbers from xrange(): '</span>;</span><br><span class="line"><span class="keyword">foreach</span> (xrange(<span class="number">0</span>,<span class="number">10</span>) <span class="keyword">as</span> $number) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$number "</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>生成器对象：当第一次调用生成器的时候，返回生成器类的一个对象。这个对象与迭代器对象使用相同的方式实现了迭代器接口，并提供可以调用的方法来处理生成器的状态，包括从它返回值或者向它发送值。</p><h4 id="生成器语法"><a href="#生成器语法" class="headerlink" title="生成器语法"></a>生成器语法</h4><p>一个生成器函数看起来像一个普通的函数，不同的是普通函数返回一个值，而一个生成器可以yield生成许多它所需要的值。</p><p>当一个生成器被调用的时候，它返回一个可以被遍历的对象.当你遍历这个对象的时候(例如通过一个foreach循环)，PHP 将会在每次需要值的时候调用生成器函数，并在产生一个值之后保存生成器的状态，这样它就可以在需要产生下一个值的时候恢复调用状态。</p><p>一旦不再需要产生更多的值，生成器函数可以简单退出，而调用生成器的代码还可以继续执行，就像一个数组已经被遍历完了。</p><p>在一个生成器函数中不可以存在 return ，否则将产生一个错误。</p><h5 id="yield-关键字"><a href="#yield-关键字" class="headerlink" title="yield 关键字"></a>yield 关键字</h5><p>生成器函数的核心是yield关键字。它最简单的调用形式看起来像一个return申明，不同之处在于普通return会返回值并终止函数的执行，而yield会返回一个值给循环调用此生成器的代码并且只是暂停执行生成器函数。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">gen_one_to_three</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> ($i = <span class="number">1</span>; $i &lt;= <span class="number">3</span>; $i++) &#123;</span><br><span class="line">        <span class="comment">//注意变量$i的值在不同的yield之间是保持传递的。</span></span><br><span class="line">        <span class="keyword">yield</span> $i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$generator = gen_one_to_three();</span><br><span class="line"><span class="keyword">foreach</span> ($generator <span class="keyword">as</span> $value) &#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"$value&lt;/br&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>123</code></pre><p>使用引用来生成值</p><p>生成函数可以像使用值一样来使用引用生成。这个和从函数返回一个引用一样：通过在函数名前面加一个引用符号。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> &amp;<span class="title">gen_reference</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $value = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">while</span> ($value &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">yield</span> $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们可以在循环中修改$number的值，而生成器是使用的引用值来生成</span></span><br><span class="line"><span class="comment">// 所以gen_reference()内部的$value值也会跟着变化。</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (gen_reference() <span class="keyword">as</span> &amp;$number) &#123;</span><br><span class="line">    <span class="keyword">echo</span> (--$number).<span class="string">'... '</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>输出：</p><pre><code>2... 1... 0... </code></pre><h3 id="引用的解释"><a href="#引用的解释" class="headerlink" title="引用的解释"></a>引用的解释</h3><h4 id="引用是什么"><a href="#引用是什么" class="headerlink" title="引用是什么"></a>引用是什么</h4><p>在 PHP 中引用意味着用不同的名字访问同一个变量内容。这并不像 C 的指针：例如你不能对他们做指针运算，他们并不是实际的内存地址…… 替代的是，引用是符号表别名。注意在PHP 中，变量名和变量内容是不一样的， 因此同样的内容可以有不同的名字。最接近的比喻是 Unix 的文件名和文件本身——变量名是目录条目，而变量内容则是文件本身。引用可以被看作是 Unix 文件系统中的硬链接。</p><h4 id="引用做什么"><a href="#引用做什么" class="headerlink" title="引用做什么"></a>引用做什么</h4><p>PHP 的引用允许用两个变量来指向同一个内容。意思是，当这样做时：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a =&amp; $b;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这意味着 $a 和 $b 指向了同一个变量。</p><p>同样的语法可以用在函数中，它返回引用，以及用在 new 运算符中</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$bar =&amp; <span class="keyword">new</span> fooclass();</span><br><span class="line">$foo =&amp; find_var($bar);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>自 PHP 5 起，new 自动返回引用，因此在此使用 =&amp; 已经过时了并且会产生 E_STRICT 级别的消息。</p><p>引用做的第二件事是用引用传递变量。这是通过在函数内建立一个本地变量并且该变量在呼叫范围内引用了同一个内容来实现的。例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(&amp;$var)</span> </span>&#123;</span><br><span class="line">    $var++;</span><br><span class="line">&#125;</span><br><span class="line">$a=<span class="number">5</span>;</span><br><span class="line">foo($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>将使 $a 变成 6。这是因为在 foo 函数中变量 $var 指向了和 $a 指向的同一个内容。</p><h4 id="引用不是什么"><a href="#引用不是什么" class="headerlink" title="引用不是什么"></a>引用不是什么</h4><p>如前所述，引用不是指针。这意味着下面的结构不会产生预期的效果：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(&amp;$var)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    $var =&amp; $GLOBALS[<span class="string">"baz"</span>];</span><br><span class="line">&#125;</span><br><span class="line">foo($bar);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这将使 foo 函数中的 $var 变量在函数调用时和 $bar 绑定在一起，但接着又被重新绑定到了 $GLOBALS[“baz”] 上面。不可能通过引用机制将 $bar 在函数调用范围内绑定到别的变量上面，因为在函数 foo 中并没有变量 $bar（它被表示为 $var，但是 $var 只有变量内容而没有调用符号表中的名字到值的绑定）。可以使用引用返回来引用被函数选择的变量。</p><h4 id="引用传递"><a href="#引用传递" class="headerlink" title="引用传递"></a>引用传递</h4><p>可以将一个变量通过引用传递给函数，这样该函数就可以修改其参数的值。语法如下：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">foo</span><span class="params">(&amp;$var)</span> </span>&#123;</span><br><span class="line">    $var++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a=<span class="number">5</span>;</span><br><span class="line">foo($a);</span><br><span class="line"><span class="comment">// $a is 6 here</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>以下内容可以通过引用传递：</p><ul><li>变量，例如 foo($a)</li><li>New 语句，例如 foo(new foobar())</li><li>从函数中返回的引用，例如：</li></ul><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> &amp;<span class="title">bar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $a = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">return</span> $a;</span><br><span class="line">&#125;</span><br><span class="line">foo(bar());</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>任何其它表达式都不能通过引用传递。</p><h4 id="引用返回"><a href="#引用返回" class="headerlink" title="引用返回"></a>引用返回</h4><p>引用返回用在当想用函数找到引用应该被绑定在哪一个变量上面时。不要用返回引用来增加性能，引擎足够聪明来自己进行优化。仅在有合理的技术原因时才返回引用！要返回引用，使用此语法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">foo</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $value = <span class="number">42</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> &amp;<span class="title">getValue</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> foo;</span><br><span class="line">$myValue = &amp;$obj-&gt;getValue(); <span class="comment">// $myValue 是 $obj-&gt;value 的引用，现在值是 42</span></span><br><span class="line">$obj-&gt;value = <span class="number">2</span>;</span><br><span class="line"><span class="keyword">echo</span> $myValue;                <span class="comment">// 打印 $obj-&gt;value 的值, 现在是 2</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="取消引用"><a href="#取消引用" class="headerlink" title="取消引用"></a>取消引用</h4><p>当 unset 一个引用，只是断开了变量名和变量内容之间的绑定。这并不意味着变量内容被销毁了。例如：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$a = <span class="number">1</span>;</span><br><span class="line">$b =&amp; $a;</span><br><span class="line"><span class="keyword">unset</span>($a);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>不会 unset $b，只是 $a。<br>再拿这个和 Unix 的 unlink 调用来类比一下可能有助于理解。</p><h4 id="引用定位"><a href="#引用定位" class="headerlink" title="引用定位"></a>引用定位</h4><p>许多 PHP 的语法结构是通过引用机制实现的，所以上述有关引用绑定的一切也都适用于这些结构。一些结构，例如引用传递和返回，已经在上面提到了。其它使用引用的结构有：</p><ul><li>global 引用</li></ul><p>当用 global $var 声明一个变量时实际上建立了一个到全局变量的引用。也就是说和这样做是相同的：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">$var =&amp; $GLOBALS[<span class="string">"var"</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>这意味着，例如，unset $var 不会 unset 全局变量。</p><ul><li>$this 在一个对象的方法中，$this 永远是调用它的对象的引用。</li></ul><h3 id="预定义变量-1"><a href="#预定义变量-1" class="headerlink" title="预定义变量"></a>预定义变量</h3><p>对于全部脚本而言，PHP 提供了大量的预定义变量。这些变量将所有的外部变量表示成内建环境变量，并且将错误信息表示成返回头。</p><h4 id="超全局变量"><a href="#超全局变量" class="headerlink" title="超全局变量"></a>超全局变量</h4><p>超全局变量 — 超全局变量是在全部作用域中始终可用的内置变量</p><p>PHP 中的许多预定义变量都是“超全局的”，这意味着它们在一个脚本的全部作用域中都可用。在函数或方法中无需执行 <code>global $variable;</code> 就可以访问它们。</p><p>这些超全局变量是：</p><ul><li>$GLOBALS</li><li>$_SERVER</li><li>$_GET</li><li>$_POST</li><li>$_FILES</li><li>$_COOKIE</li><li>$_SESSION</li><li>$_REQUEST</li><li>$_ENV</li></ul><h4 id="GLOBALS"><a href="#GLOBALS" class="headerlink" title="$GLOBALS"></a>$GLOBALS</h4><p><code>$GLOBALS</code> – 引用全局作用域中可用的全部变量，一个包含了全部变量的全局组合数组。变量的名字就是数组的键。</p><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    $foo = <span class="string">"local variable"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'$foo in global scope: '</span> . $GLOBALS[<span class="string">"foo"</span>] . <span class="string">"\n"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">'$foo in current scope: '</span> . $foo . <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$foo = <span class="string">"Example content"</span>;</span><br><span class="line">test();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="SERVER"><a href="#SERVER" class="headerlink" title="$_SERVER"></a>$_SERVER</h4><p><code>$_SERVER</code> – 服务器和执行环境信息。<code>$_SERVER</code> 是一个包含了诸如头信息(header)、路径(path)、以及脚本位置(script locations)等等信息的数组。这个数组中的项目由 Web 服务器创建。不能保证每个服务器都提供全部项目；服务器可能会忽略一些，或者提供一些没有在这里列举出来的项目。</p><ul><li><p><code>PHP_SELF</code> – 当前执行脚本的文件名，与 <code>document root</code> 有关。例如，在地址为 <code>http://example.com/foo/bar.php</code> 的脚本中使用 <code>$_SERVER[&#39;PHP_SELF&#39;]</code> 将得到 <code>/foo/bar.php</code>。__FILE__ 常量包含当前(例如包含)文件的完整路径和文件名。 从 PHP 4.3.0 版本开始，如果 PHP 以命令行模式运行，这个变量将包含脚本名。之前的版本该变量不可用。</p></li><li><p><code>argv</code> – 传递给该脚本的参数的数组。当脚本以命令行方式运行时，argv 变量传递给程序 C 语言样式的命令行参数。当通过 GET 方式调用时，该变量包含query string。</p></li><li><p><code>argc</code> – 包含命令行模式下传递给该脚本的参数的数目(如果运行在命令行模式下)。</p></li><li><p><code>GATEWAY_INTERFACE</code> – 服务器使用的 CGI 规范的版本；例如，”CGI/1.1”。</p></li><li><p><code>SERVER_ADDR</code> – 当前运行脚本所在的服务器的 IP 地址。</p></li><li><p><code>SERVER_NAME</code> – 当前运行脚本所在的服务器的主机名。如果脚本运行于虚拟主机中，该名称是由那个虚拟主机所设置的值决定。</p></li><li><p><code>SERVER_SOFTWARE</code> – 服务器标识字符串，在响应请求时的头信息中给出。</p></li><li><p><code>SERVER_PROTOCOL</code> – 请求页面时通信协议的名称和版本。例如，”HTTP/1.0”。</p></li><li><p><code>REQUEST_METHOD</code> – 访问页面使用的请求方法；例如，”GET”, “HEAD”，”POST”，”PUT”。</p></li><li><p><code>REQUEST_TIME</code> – 请求开始时的时间戳。从 PHP 5.1.0 起可用。</p></li><li><p><code>REQUEST_TIME_FLOAT</code> – 请求开始时的时间戳，微秒级别的精准度。 自 PHP 5.4.0 开始生效。</p></li><li><p><code>QUERY_STRING</code> – query string（查询字符串），如果有的话，通过它进行页面访问。</p></li><li><p><code>DOCUMENT_ROOT</code> – 当前运行脚本所在的文档根目录。在服务器配置文件中定义。</p></li><li><p><code>HTTP_ACCEPT</code> – 当前请求头中 Accept: 项的内容，如果存在的话。</p></li><li><p><code>HTTP_ACCEPT_CHARSET</code> – 当前请求头中 <code>Accept-Charset:</code> 项的内容，如果存在的话。例如：<code>iso-8859-1,*,utf-8</code>。</p></li><li><p><code>HTTP_ACCEPT_ENCODING</code> – 当前请求头中 <code>Accept-Encoding:</code> 项的内容，如果存在的话。例如：<code>gzip</code>。</p></li><li><p><code>HTTP_ACCEPT_LANGUAGE</code> – 当前请求头中 <code>Accept-Language:</code> 项的内容，如果存在的话。例如：<code>en</code>。</p></li><li><p><code>HTTP_CONNECTION</code> – 当前请求头中 <code>Connection:</code> 项的内容，如果存在的话。例如：<code>Keep-Alive</code>。</p></li><li><p><code>HTTP_HOST</code> – 当前请求头中 <code>Host:</code> 项的内容，如果存在的话。</p></li><li><p><code>HTTP_REFERER</code> – 引导用户代理到当前页的前一页的地址（如果存在）。由 user agent 设置决定。并不是所有的用户代理都会设置该项，有的还提供了修改 <code>HTTP_REFERER</code> 的功能。简言之，该值并不可信。</p></li><li><p><code>HTTP_USER_AGENT</code> – 当前请求头中 <code>User-Agent:</code> 项的内容，如果存在的话。该字符串表明了访问该页面的用户代理的信息。一个典型的例子是：<code>Mozilla/4.5 [en] (X11; U; Linux 2.2.9 i586)</code>。除此之外，你可以通过 <code>get_browser()</code> 来使用该值，从而定制页面输出以便适应用户代理的性能。</p></li><li><p><code>HTTPS</code> – 如果脚本是通过 HTTPS 协议被访问，则被设为一个非空的值。</p></li><li><p><code>REMOTE_ADDR</code> – 浏览当前页面的用户的 IP 地址。</p></li><li><p><code>REMOTE_HOST</code> – 浏览当前页面的用户的主机名。DNS 反向解析不依赖于用户的 <code>REMOTE_ADDR</code>。</p></li><li><p><code>REMOTE_PORT</code> – 用户机器上连接到 Web 服务器所使用的端口号。</p></li><li><p><code>REMOTE_USER</code> – 经验证的用户</p></li><li><p><code>REDIRECT_REMOTE_USER</code> – 验证的用户，如果请求已在内部重定向。</p></li><li><p><code>SCRIPT_FILENAME</code> – 当前执行脚本的绝对路径。</p></li><li><p><code>SERVER_ADMIN</code> – 该值指明了 Apache 服务器配置文件中的 <code>SERVER_ADMIN</code> 参数。如果脚本运行在一个虚拟主机上，则该值是那个虚拟主机的值。</p></li><li><p><code>SERVER_PORT</code> – Web 服务器使用的端口。默认值为 “80”。如果使用 SSL 安全连接，则这个值为用户设置的 HTTP 端口。</p></li><li><p><code>SERVER_SIGNATURE</code> – 包含了服务器版本和虚拟主机名的字符串。</p></li><li><p><code>PATH_TRANSLATED</code> – 当前脚本所在文件系统（非文档根目录）的基本路径。这是在服务器进行虚拟到真实路径的映像后的结果。</p></li><li><p><code>SCRIPT_NAME</code> – 包含当前脚本的路径。这在页面需要指向自己时非常有用。__FILE__ 常量包含当前脚本(例如包含文件)的完整路径和文件名。</p></li><li><p><code>REQUEST_URI</code> – URI 用来指定要访问的页面。例如 <code>/index.html</code>。</p></li><li><p><code>PHP_AUTH_DIGEST</code> – 当作为 Apache 模块运行时，进行 HTTP Digest 认证的过程中，此变量被设置成客户端发送的”Authorization” HTTP 头内容（以便作进一步的认证操作）。</p></li><li><p><code>PHP_AUTH_USER</code> – 当 PHP 运行在 Apache 或 IIS（PHP 5 是 ISAPI）模块方式下，并且正在使用 HTTP 认证功能，这个变量便是用户输入的用户名。</p></li><li><p><code>PHP_AUTH_PW</code> – 当 PHP 运行在 Apache 或 IIS（PHP 5 是 ISAPI）模块方式下，并且正在使用 HTTP 认证功能，这个变量便是用户输入的密码。</p></li><li><p><code>AUTH_TYPE</code> – 当 PHP 运行在 Apache 模块方式下，并且正在使用 HTTP 认证功能，这个变量便是认证的类型。</p></li><li><p><code>PATH_INFO</code> – 包含由客户端提供的、跟在真实脚本名称之后并且在查询语句（query string）之前的路径信息，如果存在的话。例如，如果当前脚本是通过 URL <code>http://www.example.com/php/path_info.php/some/stuff?foo=bar</code> 被访问，那么 <code>$_SERVER[&#39;PATH_INFO&#39;]</code> 将包含 <code>/some/stuff</code>。</p></li><li><p><code>ORIG_PATH_INFO</code> – 在被 PHP 处理之前，<code>PATH_INFO</code> 的原始版本。</p></li></ul><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;pre&gt;'</span>;</span><br><span class="line"><span class="keyword">echo</span> $_SERVER[<span class="string">'SERVER_NAME'</span>];</span><br><span class="line"><span class="keyword">echo</span> $_SERVER[<span class="string">'HTTP_USER_AGENT'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="GET"><a href="#GET" class="headerlink" title="$_GET"></a>$_GET</h4><p><code>$_GET</code> – HTTP GET 变量，通过 URL 参数传递给当前脚本的变量的数组。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Hello '</span> . htmlspecialchars($_GET[<span class="string">"name"</span>]) . <span class="string">'!'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>浏览器访问：<code>http://127.0.0.1:8088/?name=World</code></p><h4 id="POST"><a href="#POST" class="headerlink" title="$_POST"></a>$_POST</h4><p><code>$_POST</code> HTTP POST 变量，当 HTTP POST 请求的 <code>Content-Type</code> 是 <code>application/x-www-form-urlencoded</code> 或 <code>multipart/form-data</code> 时，会将变量以关联数组形式传入当前脚本。</p><p>示例：</p><p>post.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"post.php"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        Name: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>post.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> <span class="string">'Hello '</span> . htmlspecialchars($_POST[<span class="string">"name"</span>]) . <span class="string">'!'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>浏览器访问：<code>http://127.0.0.1:8088/post.html</code>，输入内容后提交。</p><h4 id="FILES"><a href="#FILES" class="headerlink" title="$_FILES"></a>$_FILES</h4><p><code>$_FILES</code> – HTTP 文件上传变量，通过 HTTP POST 方式上传到当前脚本的项目的数组</p><p>示例：</p><p>file.html<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"file.php"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">        File: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></p><p>file.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump($_FILES);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="REQUEST"><a href="#REQUEST" class="headerlink" title="$_REQUEST"></a>$_REQUEST</h4><p><code>$_REQUEST</code> – HTTP Request 变量，默认情况下包含了 <code>$_GET</code>，<code>$_POST</code> 和 <code>$_COOKIE</code> 的数组。</p><h4 id="SESSION"><a href="#SESSION" class="headerlink" title="$_SESSION"></a>$_SESSION</h4><p><code>$_SESSION</code> – Session 变量，当前脚本可用 SESSION 变量的数组。Session 是浏览器会话保持机制。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">session_start();</span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_SESSION[<span class="string">'count'</span>])) &#123;</span><br><span class="line">  $_SESSION[<span class="string">'count'</span>] = <span class="number">0</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  $_SESSION[<span class="string">'count'</span>]++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $_SESSION[<span class="string">'count'</span>];</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>然后不断的访问这个页面，可以看到数值不断增加。</p><h4 id="ENV"><a href="#ENV" class="headerlink" title="$_ENV"></a>$_ENV</h4><p><code>$_ENV</code> – 环境变量，通过环境方式传递给当前脚本的变量的数组。</p><p>这些变量被从 PHP 解析器的运行环境导入到 PHP 的全局命名空间。很多是由支持 PHP 运行的 Shell 提供的，并且不同的系统很可能运行着不同种类的 Shell，所以不可能有一份确定的列表。请查看你的 Shell 文档来获取定义的环境变量列表。</p><p>其他环境变量包含了 CGI 变量，而不管 PHP 是以服务器模块还是 CGI 处理器的方式运行。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump($_ENV);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><h4 id="COOKIE"><a href="#COOKIE" class="headerlink" title="$_COOKIE"></a>$_COOKIE</h4><p><code>$_COOKIE</code> – HTTP Cookies，通过 HTTP Cookies 方式传递给当前脚本的变量的数组。Cookie 也是浏览器会话保持机制，与 Session 不同的是，Session 的内容保存在服务器端，而 Cookie 的内容保存在浏览器，所以安全性不如 Session 。</p><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="keyword">isset</span>($_COOKIE[<span class="string">'count'</span>])) &#123;</span><br><span class="line">    $count = <span class="number">0</span>;</span><br><span class="line">    setcookie(<span class="string">'count'</span>, $count, time()+<span class="number">3600</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    $count = ++$_COOKIE[<span class="string">'count'</span>];</span><br><span class="line">    setcookie(<span class="string">'count'</span>, $count, time()+<span class="number">3600</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> $count;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>然后不断的访问这个页面，可以看到数值不断增加。</p><h4 id="http-response-header"><a href="#http-response-header" class="headerlink" title="$http_response_header"></a>$http_response_header</h4><p><code>$http_response_header</code> – HTTP 响应头，<code>$http_response_header</code> 将会被 HTTP 响应头信息填充。<code>$http_response_header</code> 将被创建于局部作用域中。</p><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">get_contents</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  file_get_contents(<span class="string">"http://www.baidu.com"</span>);</span><br><span class="line">  var_dump($http_response_header);</span><br><span class="line">&#125;</span><br><span class="line">get_contents();</span><br><span class="line"><span class="keyword">echo</span> <span class="string">'&lt;/br&gt;'</span>;</span><br><span class="line">var_dump($http_response_header);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>可以看到 <code>$http_response_header</code> 只在 <code>get_contents()</code> 中被创建。</p><h4 id="argc"><a href="#argc" class="headerlink" title="$argc"></a>$argc</h4><p><code>$argc</code> – 传递给脚本的参数数目，仅在命令行执行有效。</p><p>注意：脚本的文件名总是作为参数传递给当前脚本，因此 $argc 的最小值为 1。</p><p>argc.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">echo</span> $argc;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"\r\n"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>在终端里运行：<code>php argc.php a a a a</code> 输出：5</p><h4 id="argv"><a href="#argv" class="headerlink" title="$argv"></a>$argv</h4><p><code>$argv</code> – 传递给脚本的参数数组，仅在命令行执行有效。</p><p>argv.php<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">var_dump($argv);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>在终端里运行：<code>php argv.php a b c d</code><br>输出：</p><pre><code>array(5) {[0]=&gt;string(8) &quot;argv.php&quot;[1]=&gt;string(1) &quot;a&quot;[2]=&gt;string(1) &quot;b&quot;[3]=&gt;string(1) &quot;c&quot;[4]=&gt;string(1) &quot;d&quot;}</code></pre><h3 id="预定义接口"><a href="#预定义接口" class="headerlink" title="预定义接口"></a>预定义接口</h3><h4 id="Traversable-接口"><a href="#Traversable-接口" class="headerlink" title="Traversable 接口"></a>Traversable 接口</h4><p>Traversable（遍历）接口，检测一个类是否可以使用 foreach 进行遍历的接口。无法被单独实现的基本抽象接口。相反它必须由 IteratorAggregate 或 Iterator 接口实现。</p><p>接口摘要：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Traversable &#123; &#125;</span><br></pre></td></tr></table></figure><p>这个接口没有任何方法，它的作用仅仅是作为所有可遍历类的基本接口。</p><h4 id="Iterator-接口"><a href="#Iterator-接口" class="headerlink" title="Iterator 接口"></a>Iterator 接口</h4><p>Iterator（迭代器）接口，可在内部迭代自己的外部迭代器或类的接口。</p><p>接口摘要：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Iterator extends Traversable &#123;</span><br><span class="line"><span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> mixed current ( void )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> scalar key ( void )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> void next ( void )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> void rewind ( void )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> bool valid ( void )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>基本用法：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myIterator</span> <span class="keyword">implements</span> <span class="title">Iterator</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $position = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> $array = <span class="keyword">array</span>(</span><br><span class="line">        <span class="string">"firstelement"</span>,</span><br><span class="line">        <span class="string">"secondelement"</span>,</span><br><span class="line">        <span class="string">"lastelement"</span>,</span><br><span class="line">    );  </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;position = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">rewind</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        var_dump(<span class="keyword">__METHOD__</span>);</span><br><span class="line">        <span class="keyword">$this</span>-&gt;position = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">current</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        var_dump(<span class="keyword">__METHOD__</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;array[<span class="keyword">$this</span>-&gt;position];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">key</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        var_dump(<span class="keyword">__METHOD__</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;position;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        var_dump(<span class="keyword">__METHOD__</span>);</span><br><span class="line">        ++<span class="keyword">$this</span>-&gt;position;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">valid</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        var_dump(<span class="keyword">__METHOD__</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;array[<span class="keyword">$this</span>-&gt;position]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$it = <span class="keyword">new</span> myIterator;</span><br><span class="line"><span class="keyword">foreach</span>($it <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    var_dump($key, $value);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>只要实现了 Iterator 这个接口的类，它的对象就可以使用 foreach 迭代了。</p><p>其中要实现的方法：</p><ul><li><code>Iterator::current</code> — 返回当前元素，此函数没有参数，可返回任何类型。</li><li><code>Iterator::key</code> — 返回当前元素的键，此函数没有参数，成功返回标量，失败则返回 NULL。</li><li><code>Iterator::next</code> — 向前移动到下一个元素，此函数没有参数，任何返回都将被忽略。</li><li><code>Iterator::rewind</code> — 返回到迭代器的第一个元素，此函数没有参数，任何返回都将被忽略。</li><li><code>Iterator::valid</code> — 检查当前位置是否有效，此函数没有参数，返回将被转换为布尔型。成功时返回 TRUE， 或者在失败时返回 FALSE。</li></ul><h4 id="IteratorAggregate-接口"><a href="#IteratorAggregate-接口" class="headerlink" title="IteratorAggregate 接口"></a>IteratorAggregate 接口</h4><p>IteratorAggregate（聚合式迭代器）接口，创建外部迭代器的接口。</p><p>接口摘要：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IteratorAggregate extends Traversable &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> Traversable getIterator ( void )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>基本用法：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">myData</span> <span class="keyword">implements</span> <span class="title">IteratorAggregate</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $property1 = <span class="string">"Public property one"</span>;</span><br><span class="line">    <span class="keyword">public</span> $property2 = <span class="string">"Public property two"</span>;</span><br><span class="line">    <span class="keyword">public</span> $property3 = <span class="string">"Public property three"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;property4 = <span class="string">"last property"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getIterator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ArrayIterator(<span class="keyword">$this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> myData;</span><br><span class="line"><span class="keyword">foreach</span>($obj <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">    var_dump($key, $value);</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><p>方法：<code>IteratorAggregate::getIterator</code> 返回一个外部迭代器，此函数没有参数，返回实现了 Iterator 或 Traversable 接口的类的一个实例。</p><h4 id="ArrayAccess-接口"><a href="#ArrayAccess-接口" class="headerlink" title="ArrayAccess 接口"></a>ArrayAccess 接口</h4><p>ArrayAccess（数组式访问）接口，提供像访问数组一样访问对象的能力的接口。</p><p>接口摘要：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ArrayAccess &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> boolean offsetExists ( mixed $offset )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> mixed offsetGet ( mixed $offset )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> void offsetSet ( mixed $offset , mixed $value )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> void offsetUnset ( mixed $offset )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">obj</span> <span class="keyword">implements</span> <span class="title">arrayaccess</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $container = <span class="keyword">array</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;container = <span class="keyword">array</span>(</span><br><span class="line">            <span class="string">"one"</span>   =&gt; <span class="number">1</span>,</span><br><span class="line">            <span class="string">"two"</span>   =&gt; <span class="number">2</span>,</span><br><span class="line">            <span class="string">"three"</span> =&gt; <span class="number">3</span>,</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetSet</span><span class="params">($offset, $value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (is_null($offset)) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;container[] = $value;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;container[$offset] = $value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetExists</span><span class="params">($offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;container[$offset]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetUnset</span><span class="params">($offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">unset</span>(<span class="keyword">$this</span>-&gt;container[$offset]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">offsetGet</span><span class="params">($offset)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="keyword">$this</span>-&gt;container[$offset]) ? <span class="keyword">$this</span>-&gt;container[$offset] : <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> obj;</span><br><span class="line"></span><br><span class="line">var_dump(<span class="keyword">isset</span>($obj[<span class="string">"two"</span>]));</span><br><span class="line">var_dump($obj[<span class="string">"two"</span>]);</span><br><span class="line"><span class="keyword">unset</span>($obj[<span class="string">"two"</span>]);</span><br><span class="line">var_dump(<span class="keyword">isset</span>($obj[<span class="string">"two"</span>]));</span><br><span class="line">$obj[<span class="string">"two"</span>] = <span class="string">"A value"</span>;</span><br><span class="line">var_dump($obj[<span class="string">"two"</span>]);</span><br><span class="line">$obj[] = <span class="string">'Append 1'</span>;</span><br><span class="line">$obj[] = <span class="string">'Append 2'</span>;</span><br><span class="line">$obj[] = <span class="string">'Append 3'</span>;</span><br><span class="line">print_r($obj);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure></p><ul><li><code>ArrayAccess::offsetExists</code> – 检查一个偏移位置是否存在</li><li><code>ArrayAccess::offsetGet</code> – 获取一个偏移位置的值</li><li><code>ArrayAccess::offsetSet</code> – 设置一个偏移位置的值</li><li><code>ArrayAccess::offsetUnset</code> – 复位一个偏移位置的值</li></ul><h4 id="序列化接口"><a href="#序列化接口" class="headerlink" title="序列化接口"></a>序列化接口</h4><p>Serializable 自定义序列化的接口。</p><p>实现此接口的类将不再支持 <strong>sleep() 和 </strong>wakeup()。不论何时，只要有实例需要被序列化，serialize 方法都将被调用。它将不会调用 <code>__destruct()</code> 或有其他影响，除非程序化地调用此方法。当数据被反序列化时，类将被感知并且调用合适的 <code>unserialize()</code> 方法而不是调用 <code>__construct()</code>。如果需要执行标准的构造器，你应该在这个方法中进行处理。</p><p>接口摘要：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Serializable &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> string serialize ( void )</span><br><span class="line">    <span class="keyword">abstract</span> <span class="keyword">public</span> mixed unserialize ( string $serialized )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">obj</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> $data;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = <span class="string">"My private data"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">serialize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> serialize(<span class="keyword">$this</span>-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">unserialize</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;data = unserialize($data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">getData</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$obj = <span class="keyword">new</span> obj;</span><br><span class="line">$ser = serialize($obj);</span><br><span class="line">$newobj = unserialize($ser);</span><br><span class="line">var_dump($newobj-&gt;getData());</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><ul><li><code>Serializable::serialize</code> — 对象的字符串表示</li><li><code>Serializable::unserialize</code> — 构造对象</li></ul><h4 id="Closure-类"><a href="#Closure-类" class="headerlink" title="Closure 类"></a>Closure 类</h4><p>用于代表匿名函数的类。</p><p>匿名函数会产生这个类型的对象。在过去，这个类被认为是一个实现细节，但现在可以依赖它做一些事情。自 PHP 5.4 起，这个类带有一些方法，允许在匿名函数创建后对其进行更多的控制。</p><p>除了此处列出的方法，还有一个 <code>__invoke</code> 方法。这是为了与其他实现了 <code>__invoke()</code> 魔术方法 的对象保持一致性，但调用匿名函数的过程与它无关。</p><p>类摘要：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Closure &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    __construct ( void )</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Closure bind ( Closure $closure , object $newthis [, mixed $newscope = <span class="string">'static'</span> ] )</span><br><span class="line">    <span class="keyword">public</span> Closure bindTo ( object $newthis [, mixed $newscope = <span class="string">'static'</span> ] )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Closure::__construct</code> — 用于禁止实例化的构造函数</li><li><code>Closure::bind</code> — 复制一个闭包，绑定指定的$this对象和类作用域。</li><li><code>Closure::bindTo</code> — 复制当前闭包对象，绑定指定的$this对象和类作用域。</li></ul><h4 id="生成器类"><a href="#生成器类" class="headerlink" title="生成器类"></a>生成器类</h4><p>Generator 对象是从 generators 返回的，Generator 对象不能通过 new 实例化。</p><p>类摘要：</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Generator implements Iterator &#123;</span><br><span class="line">    <span class="comment">/* 方法 */</span></span><br><span class="line">    <span class="keyword">public</span> mixed current ( void )</span><br><span class="line">    <span class="keyword">public</span> mixed key ( void )</span><br><span class="line">    <span class="keyword">public</span> void next ( void )</span><br><span class="line">    <span class="keyword">public</span> void rewind ( void )</span><br><span class="line">    <span class="keyword">public</span> mixed send ( mixed $value )</span><br><span class="line">    <span class="keyword">public</span> void <span class="keyword">throw</span> ( <span class="keyword">Exception</span> $exception )</span><br><span class="line">    <span class="keyword">public</span> bool valid ( void )</span><br><span class="line">    <span class="keyword">public</span> void __wakeup ( void )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><code>Generator::current</code> — 返回当前产生的值</li><li><code>Generator::key</code> — 返回当前产生的键</li><li><code>Generator::next</code> — 生成器继续执行</li><li><code>Generator::rewind</code> — 重置迭代器</li><li><code>Generator::send</code> — 向生成器中传入一个值</li><li><code>Generator::throw</code> — 向生成器中抛入一个异常</li><li><code>Generator::valid</code> — 检查迭代器是否被关闭</li><li><code>Generator::__wakeup</code> — 序列化回调</li></ul><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>到这里 PHP 的基础语法就结束了，想要用 PHP 去解决一些实际的事情就需要学习 PHP 如何应用了。</p><p>本篇根据整理学习 <a href="http://php.net/manual/zh/index.php" target="_blank" rel="noopener">PHP 官方手册</a> 完成。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;PHP全称PHP Hypertext Preprocessor，是一种通用开源脚本语言。语法吸收了C语言、Java和Perl的特点，利于学习，使用广泛，主要适用于Web开发领域。PHP 独特的语法混合了C、Java、Perl以及PHP自创的语法。它可以比CGI或者Perl更快速地执行动态网页。用PHP做出的动态页面与其他的编程语言相比，PHP是将程序嵌入到HTML文档中去执行，执行效率比完全生成HTML标记的CGI要高许多；PHP还可以执行编译后代码，编译可以达到加密和优化代码运行，使代码运行更快。&lt;br&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="http://www.yunfwe.cn/categories/PHP/"/>
    
    
      <category term="php" scheme="http://www.yunfwe.cn/tags/php/"/>
    
  </entry>
  
  <entry>
    <title>MongoDB分片集群</title>
    <link href="http://www.yunfwe.cn/2018/03/02/2018/MongoDB%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4/"/>
    <id>http://www.yunfwe.cn/2018/03/02/2018/MongoDB%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4/</id>
    <published>2018-03-02T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>当面对海量数据的时候，单台MongoDB的承受能力显然达不到数据要求。分片(Sharding)是MongoDB将大型的集合分割到不同服务器上的方法。分片起源于关系型数据库的分区，但是和关系型数据库的分区相比，MongoDB已经帮用户做了所有能自动完成的事情。MongoDB会自动将需要分片的集合均衡的分布到不同的服务器上，配合副本集保障了数据的可用性和安全性，而这一切对用户都是透明的。</p></blockquote><a id="more"></a><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h3 id="分片的目的"><a href="#分片的目的" class="headerlink" title="分片的目的"></a>分片的目的</h3><p>高数据量和吞吐量的数据库应用会对单机的性能造成较大压力。随着数据的增大，单台MongoDB的QPS会严重下降。较大的查询甚至会将单机的CPU和内存资源耗尽。<br>为了解决MongoDB的性能问题，一般有两种解决方法：<strong>垂直扩展</strong>和<strong>水平扩展</strong>。</p><p><strong>垂直扩展</strong> 就是升级服务器的硬件，增加更多的CPU，增加更大的内存。但是这种方法很容易就达到硬件提升的瓶颈，而且可能需要付出更高的代价。<br><strong>水平扩展</strong> 就是一台服务器不行就多台，将数据分布到多个服务器上，需要查询数据的时候根据相应的算法知道数据存放在哪台服务器上就可以了。</p><h3 id="分片的设计"><a href="#分片的设计" class="headerlink" title="分片的设计"></a>分片的设计</h3><p>一个MongoDB分片集群有三种角色</p><ol><li><strong>分片服务器</strong>(Shard Server) mongod实例，用于存储实际的数据块。分片服务器可以是一个副本集集群共同来提供服务 防止单点故障。</li><li><strong>配置服务器</strong>(Config Server) mongod实例，存储整个集群和分片的元数据，就像是一本书的目录，保存的只是数据的分布表。</li><li><strong>路由服务器</strong>(Route Server) mongos实例，客户端由此接入，本身不存放数据，仅供程序连接，起到一个路由的作用。</li></ol><p>路由服务器对整个MongoDB分片集群进行了抽象，用户访问mongos提供的监听就像访问一个mongod一样。而分片服务器使用副本集来保障了数据的可用性和安全性。分片集群还提供了良好的扩展能力，随着数据量增大可以方便的增加分片服务器来扩展整个集群的容量。</p><p>用户对分片集群一次完整的读取数据过程如下：<br><img src="/uploads/2018/mongodb/h34achz523xvc160.png" alt></p><h3 id="数据分发"><a href="#数据分发" class="headerlink" title="数据分发"></a>数据分发</h3><p>在MongoDB分片集群中，将集合的数据拆分成<strong>块(chunk)</strong>，然后将块分不到不同的分片服务器上。<br>MongoDB的块大小默认是<code>64M</code>，大于<code>64M</code>的块将自动分裂为两个较小的块。MongoDB内置均衡器(balancer)就是用于拆分块和分发块的。</p><p>块的分发主要有两种方式：<strong>基于块的数量的分发</strong> 和 <strong>基于片键范围的定向分发</strong></p><h4 id="基于块的数量的分发"><a href="#基于块的数量的分发" class="headerlink" title="基于块的数量的分发"></a>基于块的数量的分发</h4><p>MongoDB内置均衡器按照集合的索引字段来进行数据分发，该字段叫做<strong>片键(sharded key)</strong><br>片键一般有三种类型：<strong>升序片键</strong>，<strong>随机片键</strong>和<strong>基于分组的片键</strong>。</p><h5 id="升序片键"><a href="#升序片键" class="headerlink" title="升序片键"></a>升序片键</h5><p>升序片键类似自增长的ID。假如集合foo有10个文档，1-4的文档所在块在分片服务器A上，5-8的文档所在块在分片服务器B上，9-10的文档所在块在分片服务器C上。当有新的文档需要写入时会插入到C服务器上所在的块，当块的大小超过限制后会分裂为两个块，分裂后的旧数据所在块可能会移动到其他服务器，继续新增的数据还会插入到拥有最大ID的块，导致所有的写请求都被路由到了C分片服务器上，数据写入不均匀。</p><p>但是如果按照片键进行范围读取时，数据可能都在同一个块上，读取的性能就比较高了。</p><h5 id="随机片键"><a href="#随机片键" class="headerlink" title="随机片键"></a>随机片键</h5><p>随机片键是指片键的值不是固定增长，而是一些没有规律的键值。由于写入数据是随机分发的，各分片增长的速度大致相同，减少了chunk 迁移的次数。使用随机分片的弊端是：写入的位置是随机的，如果使用Hash Index来产生随机值，那么范围查询的速度会很慢。</p><h5 id="基于分组的片键"><a href="#基于分组的片键" class="headerlink" title="基于分组的片键"></a>基于分组的片键</h5><p>基于分组的片键是两字段的复合片键，第一个字段用于分组，第二个字段用于自增，所以第二个字段最好是自增字段。这种片键策略是最好的，能够实现多热点数据的读写。</p><p>选择合适的片键需要对项目是写为主还是读为主的权衡。</p><h4 id="基于片键范围的定向分发"><a href="#基于片键范围的定向分发" class="headerlink" title="基于片键范围的定向分发"></a>基于片键范围的定向分发</h4><p>如果希望特定范围的块被分发到特定的分片服务器中，可以为分片添加标签，然后为标签指定相应的片键范围，这样，如果一个文档属于某个标签的片键范围，就会被定向到特定的分片服务器中了。</p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>使用三台测试机来搭建环境 使用不同的端口号来启动不同的MongoDB实例。</p><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><table><thead><tr><th>主机名</th><th style="text-align:center">系统</th><th style="text-align:right">IP</th></tr></thead><tbody><tr><td>mongo-A</td><td style="text-align:center">CentOS 6.8</td><td style="text-align:right">10.0.0.3</td></tr><tr><td>mongo-B</td><td style="text-align:center">CentOS 6.8</td><td style="text-align:right">10.0.0.4</td></tr><tr><td>mongo-C</td><td style="text-align:center">CentOS 6.8</td><td style="text-align:right">10.0.0.5</td></tr></tbody></table><h3 id="拓扑结构"><a href="#拓扑结构" class="headerlink" title="拓扑结构"></a>拓扑结构</h3><table><thead><tr><th style="text-align:center">mongo-A</th><th style="text-align:center">mongo-B</th><th style="text-align:center">mongo-C</th></tr></thead><tbody><tr><td style="text-align:center">Mongos</td><td style="text-align:center">Mongos</td><td style="text-align:center">Mongos</td></tr><tr><td style="text-align:center">Config Server</td><td style="text-align:center">Config Server</td><td style="text-align:center">Config Server</td></tr><tr><td style="text-align:center">Shard Server 1 主</td><td style="text-align:center">Shard Server 1 备</td><td style="text-align:center">Shard Server 1 仲裁</td></tr><tr><td style="text-align:center">Shard Server 2 主</td><td style="text-align:center">Shard Server 2 备</td><td style="text-align:center">Shard Server 2 仲裁</td></tr><tr><td style="text-align:center">Shard Server 3 主</td><td style="text-align:center">Shard Server 3 备</td><td style="text-align:center">Shard Server 3 仲裁</td></tr></tbody></table><h3 id="服务信息"><a href="#服务信息" class="headerlink" title="服务信息"></a>服务信息</h3><table><thead><tr><th>角色</th><th>数据目录</th><th>端口</th><th>副本集名称</th></tr></thead><tbody><tr><td>Mongos</td><td>None</td><td>27017</td><td>None</td></tr><tr><td>Config Server</td><td>/data/cs</td><td>20000</td><td>cs</td></tr><tr><td>Shard Server 1</td><td>/data/ss1</td><td>21001</td><td>ss1</td></tr><tr><td>Shard Server 2</td><td>/data/ss2</td><td>21002</td><td>ss2</td></tr><tr><td>Shard Server 3</td><td>/data/ss3</td><td>21003</td><td>ss3</td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="安装MongoDB"><a href="#安装MongoDB" class="headerlink" title="安装MongoDB"></a>安装MongoDB</h3><p>这里使用<code>Linux</code>平台当前最新版 <strong>3.6.3</strong> <a href="http://downloads.mongodb.org/linux/mongodb-linux-x86_64-3.6.3.tgz" target="_blank" rel="noopener">点此下载</a></p><p>所有节点全部执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tar xf mongodb-linux-x86_64-3.6.3.tgz -C /usr/local/</span><br><span class="line">ln -s /usr/local/mongodb-linux-x86_64-3.6.3/ /usr/local/mongodb</span><br><span class="line">mkdir -p /data/&#123;cs,ss1,ss2,ss3&#125;</span><br><span class="line">echo &apos;export PATH=/usr/local/mongodb/bin/:$PATH&apos; &gt; /etc/profile.d/mongodb.sh</span><br><span class="line">source /etc/profile.d/mongodb.sh</span><br></pre></td></tr></table></figure></p><h3 id="配置分片集群"><a href="#配置分片集群" class="headerlink" title="配置分片集群"></a>配置分片集群</h3><h4 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h4><p>所有节点执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mongod --configsvr --dbpath /data/cs --fork --logpath /var/log/mongodcs.log --bind_ip 0.0.0.0 --port 20000 --replSet cs </span><br><span class="line">mongod --shardsvr --dbpath /data/ss1 --fork --logpath /var/log/mongodss1.log --bind_ip 0.0.0.0 --port 21001 --replSet ss1</span><br><span class="line">mongod --shardsvr --dbpath /data/ss2 --fork --logpath /var/log/mongodss2.log --bind_ip 0.0.0.0 --port 21002 --replSet ss2</span><br><span class="line">mongod --shardsvr --dbpath /data/ss3 --fork --logpath /var/log/mongodss3.log --bind_ip 0.0.0.0 --port 21003 --replSet ss3</span><br></pre></td></tr></table></figure></p><h4 id="配置Config-Server"><a href="#配置Config-Server" class="headerlink" title="配置Config Server"></a>配置Config Server</h4><p>随便连接到一个服务器的20000端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo 127.0.0.1:20000</span><br></pre></td></tr></table></figure></p><p>初始化Config Server，在mongo中执行以下代码</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cfg = &#123;<span class="attr">_id</span>:<span class="string">"cs"</span>, <span class="attr">configsvr</span>:<span class="literal">true</span>, <span class="attr">members</span>:[ </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">host</span>:<span class="string">'10.0.0.3:20000'</span>&#125;, </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">1</span>,<span class="attr">host</span>:<span class="string">'10.0.0.4:20000'</span>&#125;,   </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">2</span>,<span class="attr">host</span>:<span class="string">'10.0.0.5:20000'</span>&#125;</span><br><span class="line">    ]&#125;;</span><br><span class="line">rs.initiate(cfg)</span><br></pre></td></tr></table></figure><p>结果输出：</p><pre><code>&gt; rs.initiate(cfg){    &quot;ok&quot; : 1,    &quot;operationTime&quot; : Timestamp(1519896701, 1),    &quot;$gleStats&quot; : {        &quot;lastOpTime&quot; : Timestamp(1519896701, 1),        &quot;electionId&quot; : ObjectId(&quot;000000000000000000000000&quot;)    },    &quot;$clusterTime&quot; : {        &quot;clusterTime&quot; : Timestamp(1519896701, 1),        &quot;signature&quot; : {            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),            &quot;keyId&quot; : NumberLong(0)        }    }}</code></pre><h4 id="配置Shard-Server-1"><a href="#配置Shard-Server-1" class="headerlink" title="配置Shard Server 1"></a>配置Shard Server 1</h4><p>连接mongo-A的21001端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo 10.0.0.3:21001</span><br></pre></td></tr></table></figure></p><p>初始化Shard Server 1<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cfg = &#123;<span class="attr">_id</span>:<span class="string">"ss1"</span>,<span class="attr">members</span>:[ </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">host</span>:<span class="string">'10.0.0.3:21001'</span>,<span class="attr">priority</span>:<span class="number">2</span>&#125;, </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">1</span>,<span class="attr">host</span>:<span class="string">'10.0.0.4:21001'</span>,<span class="attr">priority</span>:<span class="number">1</span>&#125;,   </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">2</span>,<span class="attr">host</span>:<span class="string">'10.0.0.5:21001'</span>,<span class="attr">arbiterOnly</span>:<span class="literal">true</span>&#125;] </span><br><span class="line">    &#125;;</span><br><span class="line">rs.initiate(cfg)</span><br></pre></td></tr></table></figure></p><h4 id="配置Shard-Server-2"><a href="#配置Shard-Server-2" class="headerlink" title="配置Shard Server 2"></a>配置Shard Server 2</h4><p>接着连接mongo-A的21002端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo 10.0.0.3:21002</span><br></pre></td></tr></table></figure></p><p>初始化Shard Server 2<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cfg = &#123;<span class="attr">_id</span>:<span class="string">"ss2"</span>,<span class="attr">members</span>:[ </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">host</span>:<span class="string">'10.0.0.3:21002'</span>,<span class="attr">priority</span>:<span class="number">2</span>&#125;, </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">1</span>,<span class="attr">host</span>:<span class="string">'10.0.0.4:21002'</span>,<span class="attr">priority</span>:<span class="number">1</span>&#125;,   </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">2</span>,<span class="attr">host</span>:<span class="string">'10.0.0.5:21002'</span>,<span class="attr">arbiterOnly</span>:<span class="literal">true</span>&#125;] </span><br><span class="line">    &#125;;</span><br><span class="line">rs.initiate(cfg)</span><br></pre></td></tr></table></figure></p><h4 id="配置Shard-Server-3"><a href="#配置Shard-Server-3" class="headerlink" title="配置Shard Server 3"></a>配置Shard Server 3</h4><p>连接mongo-A的21003端口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo 10.0.0.3:21003</span><br></pre></td></tr></table></figure></p><p>初始化Shard Server 3<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> cfg = &#123;<span class="attr">_id</span>:<span class="string">"ss3"</span>,<span class="attr">members</span>:[ </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">0</span>,<span class="attr">host</span>:<span class="string">'10.0.0.3:21003'</span>,<span class="attr">priority</span>:<span class="number">2</span>&#125;, </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">1</span>,<span class="attr">host</span>:<span class="string">'10.0.0.4:21003'</span>,<span class="attr">priority</span>:<span class="number">1</span>&#125;,   </span><br><span class="line">        &#123;<span class="attr">_id</span>:<span class="number">2</span>,<span class="attr">host</span>:<span class="string">'10.0.0.5:21003'</span>,<span class="attr">arbiterOnly</span>:<span class="literal">true</span>&#125;] </span><br><span class="line">    &#125;;</span><br><span class="line">rs.initiate(cfg)</span><br></pre></td></tr></table></figure></p><h4 id="配置mongos路由服务"><a href="#配置mongos路由服务" class="headerlink" title="配置mongos路由服务"></a>配置mongos路由服务</h4><p>选择一台服务器当作mongos路由服务，这里使用mongo-A</p><p>在mongo-A上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongos --configdb cs/10.0.0.3:20000,10.0.0.4:20000,10.0.0.5:20000 --fork --logpath /var/log/mongos.log --bind_ip 0.0.0.0</span><br></pre></td></tr></table></figure></p><p>mongos默认监听27017端口 也是mongod默认监听的端口</p><h4 id="添加分片服务器到集群"><a href="#添加分片服务器到集群" class="headerlink" title="添加分片服务器到集群"></a>添加分片服务器到集群</h4><p>登陆路由服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo 10.0.0.3:27017</span><br></pre></td></tr></table></figure></p><p>添加分片服务器到集群<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard(<span class="string">"ss1/10.0.0.3:21001,10.0.0.4:21001,10.0.0.5:21001"</span>)</span><br><span class="line">sh.addShard(<span class="string">"ss2/10.0.0.3:21002,10.0.0.4:21002,10.0.0.5:21002"</span>)</span><br><span class="line">sh.addShard(<span class="string">"ss3/10.0.0.3:21003,10.0.0.4:21003,10.0.0.5:21003"</span>)</span><br></pre></td></tr></table></figure></p><p>使用<code>sh.status()</code>查看集群状态</p><pre><code>mongos&gt; sh.status()--- Sharding Status --- sharding version: {    &quot;_id&quot; : 1,    &quot;minCompatibleVersion&quot; : 5,    &quot;currentVersion&quot; : 6,    &quot;clusterId&quot; : ObjectId(&quot;5a97c88a1b0ab73e5d64fc6c&quot;)}shards:        {  &quot;_id&quot; : &quot;ss1&quot;,  &quot;host&quot; : &quot;ss1/10.0.0.3:21001,10.0.0.4:21001&quot;,  &quot;state&quot; : 1 }        {  &quot;_id&quot; : &quot;ss2&quot;,  &quot;host&quot; : &quot;ss2/10.0.0.3:21002,10.0.0.4:21002&quot;,  &quot;state&quot; : 1 }        {  &quot;_id&quot; : &quot;ss3&quot;,  &quot;host&quot; : &quot;ss3/10.0.0.3:21003,10.0.0.4:21003&quot;,  &quot;state&quot; : 1 }active mongoses:        &quot;3.6.3&quot; : 1autosplit:        Currently enabled: yesbalancer:        Currently enabled:  yes        Currently running:  no        Failed balancer rounds in last 5 attempts:  0        Migration Results for the last 24 hours:                 No recent migrationsdatabases:        {  &quot;_id&quot; : &quot;config&quot;,  &quot;primary&quot; : &quot;config&quot;,  &quot;partitioned&quot; : true }mongos&gt;</code></pre><p>至此MongoDB分片集群就搭建完了。</p><h3 id="数据库的分片配置"><a href="#数据库的分片配置" class="headerlink" title="数据库的分片配置"></a>数据库的分片配置</h3><h4 id="激活数据库的分片功能"><a href="#激活数据库的分片功能" class="headerlink" title="激活数据库的分片功能"></a>激活数据库的分片功能</h4><p>激活<code>mydb</code>的分片功能</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.enableSharding(&quot;mydb&quot;)</span><br></pre></td></tr></table></figure><pre><code>mongos&gt; sh.enableSharding(&quot;mydb&quot;){    &quot;ok&quot; : 1,    &quot;$clusterTime&quot; : {        &quot;clusterTime&quot; : Timestamp(1519954632, 6),        &quot;signature&quot; : {            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),            &quot;keyId&quot; : NumberLong(0)        }    },    &quot;operationTime&quot; : Timestamp(1519954632, 6)}mongos&gt;</code></pre><h4 id="测试升序片键"><a href="#测试升序片键" class="headerlink" title="测试升序片键"></a>测试升序片键</h4><p>对<code>mydb</code>库的<code>test</code>集合进行分片，然后插入100000条数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use mydb</span><br><span class="line">sh.shardCollection(<span class="string">"mydb.test"</span>,&#123;<span class="attr">id</span>:<span class="number">1</span>&#125;)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">100000</span>; i++)&#123;</span><br><span class="line">    db.test.insert(&#123;<span class="string">"id"</span>:i,<span class="string">"name"</span>:<span class="string">"xiaoming"</span>,<span class="string">"age"</span>:<span class="number">22</span>,<span class="string">"data"</span>:<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以看到<code>test</code>集合的数据都集中在<code>ss3</code>副本集上。</p><pre><code>mongos&gt; db.test.stats(){    &quot;sharded&quot; : true,    &quot;capped&quot; : false,    &quot;ns&quot; : &quot;mydb.test&quot;,    &quot;count&quot; : 100000,    &quot;size&quot; : 8000000,    &quot;storageSize&quot; : 2519040,    &quot;totalIndexSize&quot; : 2592768,    &quot;indexSizes&quot; : {        &quot;_id_&quot; : 942080,        &quot;id_1&quot; : 1650688    },    &quot;avgObjSize&quot; : 80,    &quot;nindexes&quot; : 2,    &quot;nchunks&quot; : 1,    &quot;shards&quot; : {        &quot;ss3&quot; : {            &quot;ns&quot; : &quot;mydb.test&quot;,            &quot;size&quot; : 8000000,            &quot;count&quot; : 100000,            &quot;avgObjSize&quot; : 80,            &quot;storageSize&quot; : 2519040,            &quot;capped&quot; : false,            &quot;wiredTiger&quot; : {                &quot;metadata&quot; : {                    &quot;formatVersion&quot; : 1                },</code></pre><h4 id="测试哈希片键"><a href="#测试哈希片键" class="headerlink" title="测试哈希片键"></a>测试哈希片键</h4><p>使用哈希片键的方式重新插入100000条数据</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">use mydb</span><br><span class="line">db.test.drop()</span><br><span class="line">sh.shardCollection(<span class="string">"mydb.test"</span>,&#123;<span class="attr">id</span>:<span class="string">"hashed"</span>&#125;)</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">1</span>; i &lt;= <span class="number">100000</span>; i++)&#123;</span><br><span class="line">    db.test.insert(&#123;<span class="string">"id"</span>:i,<span class="string">"name"</span>:<span class="string">"xiaoming"</span>,<span class="string">"age"</span>:<span class="number">22</span>,<span class="string">"data"</span>:<span class="keyword">new</span> <span class="built_in">Date</span>()&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>再次使用<code>db.test.stats()</code>可以看到文档已经分散到三个副本集了。</p><pre><code>mongos&gt; db.test.stats(){    &quot;sharded&quot; : true,    &quot;capped&quot; : false,    &quot;ns&quot; : &quot;mydb.test&quot;,    &quot;count&quot; : 100000,    &quot;size&quot; : 8000000,    &quot;storageSize&quot; : 2572288,    &quot;totalIndexSize&quot; : 4280320,    &quot;indexSizes&quot; : {        &quot;_id_&quot; : 1040384,        &quot;id_hashed&quot; : 3239936    },    &quot;avgObjSize&quot; : 80,    &quot;nindexes&quot; : 2,    &quot;nchunks&quot; : 6,    &quot;shards&quot; : {        &quot;ss1&quot; : {            &quot;ns&quot; : &quot;mydb.test&quot;,            &quot;size&quot; : 2700400,            &quot;count&quot; : 33755,            &quot;avgObjSize&quot; : 80,            &quot;storageSize&quot; : 868352,            &quot;capped&quot; : false,            &quot;wiredTiger&quot; : {                &quot;metadata&quot; : {                    &quot;formatVersion&quot; : 1                },        ...        &quot;ss2&quot; : {            &quot;ns&quot; : &quot;mydb.test&quot;,            &quot;size&quot; : 2651440,            &quot;count&quot; : 33143,            &quot;avgObjSize&quot; : 80,            &quot;storageSize&quot; : 851968,            &quot;capped&quot; : false,            &quot;wiredTiger&quot; : {                &quot;metadata&quot; : {                    &quot;formatVersion&quot; : 1                },        ...        &quot;ss3&quot; : {            &quot;ns&quot; : &quot;mydb.test&quot;,            &quot;size&quot; : 2648160,            &quot;count&quot; : 33102,            &quot;avgObjSize&quot; : 80,            &quot;storageSize&quot; : 851968,            &quot;capped&quot; : false,            &quot;wiredTiger&quot; : {                &quot;metadata&quot; : {                    &quot;formatVersion&quot; : 1                },</code></pre><h3 id="分片集群的管理"><a href="#分片集群的管理" class="headerlink" title="分片集群的管理"></a>分片集群的管理</h3><h4 id="集群添加分片服务器"><a href="#集群添加分片服务器" class="headerlink" title="集群添加分片服务器"></a>集群添加分片服务器</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard(<span class="string">"ss1/10.0.0.3:21001,10.0.0.4:21001,10.0.0.5:21001"</span>)</span><br></pre></td></tr></table></figure><h4 id="从集群中移除分片服务器"><a href="#从集群中移除分片服务器" class="headerlink" title="从集群中移除分片服务器"></a>从集群中移除分片服务器</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line">db.runCommand(&#123;<span class="attr">removeshard</span>:<span class="string">"ss1"</span>&#125;)</span><br></pre></td></tr></table></figure><p>需要注意的是，如果要移除的分片服务器是某个集合的主键，需要先将数据移到其他节点。</p><h4 id="查看集群状态"><a href="#查看集群状态" class="headerlink" title="查看集群状态"></a>查看集群状态</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh.status()</span><br></pre></td></tr></table></figure><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;当面对海量数据的时候，单台MongoDB的承受能力显然达不到数据要求。分片(Sharding)是MongoDB将大型的集合分割到不同服务器上的方法。分片起源于关系型数据库的分区，但是和关系型数据库的分区相比，MongoDB已经帮用户做了所有能自动完成的事情。MongoDB会自动将需要分片的集合均衡的分布到不同的服务器上，配合副本集保障了数据的可用性和安全性，而这一切对用户都是透明的。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="MongoDB" scheme="http://www.yunfwe.cn/categories/MongoDB/"/>
    
    
      <category term="MongoDB" scheme="http://www.yunfwe.cn/tags/MongoDB/"/>
    
      <category term="NoSQL" scheme="http://www.yunfwe.cn/tags/NoSQL/"/>
    
  </entry>
  
  <entry>
    <title>MongoDB初探</title>
    <link href="http://www.yunfwe.cn/2018/02/27/2018/MongoDB%E5%88%9D%E6%8E%A2/"/>
    <id>http://www.yunfwe.cn/2018/02/27/2018/MongoDB%E5%88%9D%E6%8E%A2/</id>
    <published>2018-02-27T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>  MongoDB 是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。他支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><blockquote><p>在 CentOS6.8 上使用MongoDB的二进制包 只要不是太古老的Linux系统都可以直接运行。也可以选择在Windows上使用MongoDB。</p></blockquote><p><strong>各版本MongoDB下载地址</strong></p><table><thead><tr><th>系统类型</th><th>下载地址</th></tr></thead><tbody><tr><td>Linux</td><td><a href="http://dl.mongodb.org/dl/linux/" target="_blank" rel="noopener">点击打开</a></td></tr><tr><td>Windows</td><td><a href="http://dl.mongodb.org/dl/win32/x86_64" target="_blank" rel="noopener">点击打开</a></td></tr></tbody></table><p>下载合适的版本 这里使用<code>Linux</code>平台当前最新版 <strong>3.6.3</strong> <a href="http://downloads.mongodb.org/linux/mongodb-linux-x86_64-3.6.3.tgz" target="_blank" rel="noopener">点此下载</a></p><h2 id="入门篇"><a href="#入门篇" class="headerlink" title="入门篇"></a>入门篇</h2><h3 id="安装与启动"><a href="#安装与启动" class="headerlink" title="安装与启动"></a>安装与启动</h3><p>由于使用的是二进制版的<code>MongoDB</code>，直接解压就可以使用了。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf mongodb-linux-x86_64-3.6.3.tgz -C /usr/local/</span><br><span class="line">ln -s /usr/local/mongodb-linux-x86_64-3.6.3/ /usr/local/mongodb</span><br><span class="line">mkdir /usr/local/mongodb/data</span><br><span class="line">/usr/local/mongodb/bin/mongod --dbpath /usr/local/mongodb/</span><br></pre></td></tr></table></figure><p>当显示<code>waiting for connections on port 27017</code>时<code>MongoDB</code>就成功启动了。<br>使用<code>Ctrl</code>+<code>C</code>停止<code>MongoDB</code>。</p><h3 id="后台运行"><a href="#后台运行" class="headerlink" title="后台运行"></a>后台运行</h3><blockquote><p>如果想让<code>MongoDB</code>在后台运行 可以使用<code>--fork</code></p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongod --dbpath /usr/local/mongodb/data/ --fork --logpath /var/log/mongod.log</span><br></pre></td></tr></table></figure><p>使用<code>--fork</code>必须配合<code>--logpath</code>指定日志输出位置。</p><p>使用<code>--bind_ip 0.0.0.0</code>可以将服务监听到所有网络 <code>--port</code>配置监听端口。</p><p><strong>注意</strong>：3.6以前的版本默认是监听在<code>0.0.0.0</code>的，而3.6之后默认监听在<code>127.0.0.1</code>了。</p><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &apos;export PATH=/usr/local/mongodb/bin/:$PATH&apos; &gt; /etc/profile.d/mongodb.sh</span><br><span class="line">source /etc/profile.d/mongodb.sh</span><br></pre></td></tr></table></figure><p>这样就可以不用绝对路径来使用<code>mongo</code>相关的命令了。</p><p>使用<code>mongo</code>命令 进入<code>MongoDB</code>交互环境，使用<code>show dbs</code>列出当前默认数据库。</p><pre><code>&gt; show dbsadmin   0.000GBconfig  0.000GBlocal   0.000GB&gt; </code></pre><p>到了这一步<code>MongoDB</code>就安装启动成功了，接下来就看看<code>MongoDB</code>如何使用的吧。</p><h2 id="开发篇"><a href="#开发篇" class="headerlink" title="开发篇"></a>开发篇</h2><blockquote><p>MongoDB使用JavaScript做shell，自MongoDB 2.4以后的版本采用V8引擎执行所有JavaScript代码，对于熟悉JavaScript的开发者MongoDB可以说是非常亲切了。</p></blockquote><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><p>MongoDB是一种非关系型数据库<code>(NoSQL)</code>，非关系型数据库以键值对<code>(key-value)</code>存储。<br>键可以理解为关系型数据库的字段名，值为字段值。但是它的结构是不固定的，关系型数据库的每一条记录的字段都是相同的，而NoSQL可以有不同的键，并且NoSQL值的类型都可以是不同的。</p><p>数据库的概念 MongoDB中和关系型数据库相同，使用<code>show dbs</code>看到的就是已经存在的数据库。<br>而表的概念在MongoDB中叫做<code>集合</code>，表中的一行数据 在MongoDB中叫<code>文档</code>。表字段在MongoDB中叫<code>键(key)</code>，表字段值在MongoDB中叫<code>值(value)</code></p><p><strong>关系型数据库和非关系型数据库对比</strong></p><table><thead><tr><th>对比项</th><th>MongoDB</th><th>MySQL</th></tr></thead><tbody><tr><td>数据库</td><td>数据库</td><td>数据库</td></tr><tr><td>表格</td><td>集合</td><td>二维表</td></tr><tr><td>表记录</td><td>文档</td><td>一条记录</td></tr><tr><td>字段名</td><td>键</td><td>字段名</td></tr><tr><td>字段值</td><td>值</td><td>字段值</td></tr></tbody></table><p>题外话：MongoDB的数据库有点像Python中命令空间的概念，集合就是个列表，而文档就是一个字典了。字典里的键和值也对应着MongoDB的键和值。</p><p><strong>默认的数据库</strong></p><ul><li><strong>admin</strong> 类似于MySQL的默认mysql库 用于存放用户账户信息和权限。</li><li><strong>local</strong>  这个库用于存放主从复制相关的数据</li><li><strong>config</strong> 当MongoDB用于分片设置时 config数据库在内部使用，用于保存分片的相关信息</li></ul><h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><h4 id="切换数据库"><a href="#切换数据库" class="headerlink" title="切换数据库"></a>切换数据库</h4><p>使用<code>db</code>命令查看当前使用的数据库，使用<code>use &lt;DB&gt;</code>切换数据库</p><pre><code>&gt; show dbsadmin   0.000GBconfig  0.000GBlocal   0.000GB&gt; dbtest&gt; </code></pre><p>MongoDB默认使用的是<code>test</code>库，可是<code>show dbs</code>为什么没有看到<code>test</code>库呢？是因为MongoDB不需要什么创建数据库的语句，也不需要创建表的语句，在需要的时候 也就是你向库中写入数据的时候，如果不存在则才会自动创建。</p><p>接下来切换到<code>mydb</code>中</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use mydb</span><br></pre></td></tr></table></figure><h4 id="集合中插入文档"><a href="#集合中插入文档" class="headerlink" title="集合中插入文档"></a>集合中插入文档</h4><p>MongoDB中也不需要显性的创建一个集合，直接向某个集合中插入文档就可以了，如果集合不存在 则会自动创建。</p><h5 id="insert方法"><a href="#insert方法" class="headerlink" title="insert方法"></a>insert方法</h5><p>比如我在一个名为<code>person</code>的集合插入一条文档数据</p><pre><code>&gt; db.person.insert({&quot;name&quot;:&quot;xiaoming&quot;,&quot;age&quot;:21})WriteResult({ &quot;nInserted&quot; : 1 })&gt;</code></pre><p>现在看看库和集合是不是自动创建了呢</p><pre><code>&gt; show dbs;admin   0.000GBconfig  0.000GBlocal   0.000GBmydb    0.000GB&gt; show tables;person&gt; </code></pre><h4 id="查询集合中的文档"><a href="#查询集合中的文档" class="headerlink" title="查询集合中的文档"></a>查询集合中的文档</h4><h5 id="find方法"><a href="#find方法" class="headerlink" title="find方法"></a>find方法</h5><p>再向集合中插入一个文档</p><pre><code>&gt; db.person.insert({&quot;name&quot;:&quot;xiaohong&quot;,&quot;age&quot;:20})WriteResult({ &quot;nInserted&quot; : 1 })&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 21 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }&gt; </code></pre><p>使用<code>find</code>方法可以查看<code>person</code>集合中的所有文档，面向对象的操作方法 是不是感觉非常简单呢。<br>mongo会给每条文档自动生成<code>_id</code>键，这个可以理解为关系型数据库的主键。</p><p><code>find</code>方法使用查询条件来过滤输出，相当于关系型数据库的<code>where</code></p><h5 id="普通条件查询"><a href="#普通条件查询" class="headerlink" title="普通条件查询"></a>普通条件查询</h5><p>查询<code>name</code>为<code>xiaoming</code>的文档</p><pre><code>&gt; db.person.find({&quot;name&quot;:&quot;xiaoming&quot;}){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 21 }&gt; </code></pre><p>查询<code>age</code>小于<code>21</code>的文档</p><pre><code>&gt; db.person.find({&quot;age&quot;:{$lt:21}}){ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }&gt; </code></pre><p>小于等于使用<code>$lte</code>，大于使用<code>$gt</code>，大于等于使用<code>$gte</code>，不等于使用<code>$ne</code></p><h5 id="AND条件查询"><a href="#AND条件查询" class="headerlink" title="AND条件查询"></a>AND条件查询</h5><p>查询<code>name</code>为<code>xiaoming</code> 并且<code>age</code>为<code>21</code>的文档</p><pre><code>&gt; db.person.find({&quot;name&quot;:&quot;xiaoming&quot;,&quot;age&quot;:21}){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 21 }&gt;</code></pre><h5 id="OR条件查询"><a href="#OR条件查询" class="headerlink" title="OR条件查询"></a>OR条件查询</h5><p>查询<code>name</code>为<code>xiaoming</code> 或者<code>age</code>为<code>20</code>的文档，可以看到所有匹配的记录都被查到了。</p><pre><code>&gt; db.person.find({$or:[{&quot;name&quot;:&quot;xiaoming&quot;},{&quot;age&quot;:20}]}){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 21 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }&gt; </code></pre><h5 id="AND和OR联合使用"><a href="#AND和OR联合使用" class="headerlink" title="AND和OR联合使用"></a>AND和OR联合使用</h5><p>类似于 <code>WHERE name=&quot;xiaohong&quot; AND (name=&quot;xiaoming&quot; OR age=20)</code></p><pre><code>&gt; db.person.find({&quot;name&quot;:&quot;xiaohong&quot;,$or:[{&quot;name&quot;:&quot;xiaoming&quot;},{&quot;age&quot;:20}]}){ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }&gt;</code></pre><h5 id="limit方法"><a href="#limit方法" class="headerlink" title="limit方法"></a>limit方法</h5><p>使用<code>limit</code>方法可以只输出指定的文档条数</p><pre><code>&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952a2606b5ba9661fa06f1&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad106b5ba9661fa06f2&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad206b5ba9661fa06f3&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }&gt; db.person.find().limit(2){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }&gt; </code></pre><h5 id="skip方法"><a href="#skip方法" class="headerlink" title="skip方法"></a>skip方法</h5><p><code>skip</code>方法输出跳过多少条文档</p><pre><code>&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952a2606b5ba9661fa06f1&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad106b5ba9661fa06f2&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad206b5ba9661fa06f3&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }&gt; db.person.find().skip(2){ &quot;_id&quot; : ObjectId(&quot;5a952a2606b5ba9661fa06f1&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad106b5ba9661fa06f2&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad206b5ba9661fa06f3&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }&gt; </code></pre><h5 id="sort方法"><a href="#sort方法" class="headerlink" title="sort方法"></a>sort方法</h5><p><code>sort</code>方法对数据进行排序。<code>sort</code>方法可以通过参数指定排序的字段，并使用 <strong>1</strong> 和 <strong>-1</strong> 来指定排序的方式，其中 <strong>1</strong> 为升序排列，而 <strong>-1</strong> 是用于降序排列。</p><pre><code>&gt; db.person.find().sort({&quot;age&quot;:1}){ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad206b5ba9661fa06f3&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }&gt; db.person.find().sort({&quot;age&quot;:-1}){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad206b5ba9661fa06f3&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }&gt; </code></pre><p>题外话：可以使用<code>db.person.find().pretty()</code>来美化数据输出格式。</p><h4 id="更新文档数据"><a href="#更新文档数据" class="headerlink" title="更新文档数据"></a>更新文档数据</h4><blockquote><p>MongoDB中可以使用update和save方法来更新文档数据，两个方法的应用还是有些区别的。</p></blockquote><h5 id="update方法"><a href="#update方法" class="headerlink" title="update方法"></a>update方法</h5><blockquote><p>update方法 第一个参数是查询条件，第二个参数是要修改的键值</p></blockquote><pre><code>将name为xiaoming的记录 age值修改为22&gt; db.person.update({&quot;name&quot;:&quot;xiaoming&quot;},{$set:{&quot;age&quot;:22}})WriteResult({ &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 })&gt; db.person.find({&quot;name&quot;:&quot;xiaoming&quot;}){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 22 }&gt; </code></pre><p>需要注意的是 <code>update</code>默认只更新匹配到的第一条文档，如果想要更改所有匹配的 使用{multi:true}</p><pre><code>db.person.update({&quot;name&quot;:&quot;xiaoming&quot;}, {$set:{&quot;age&quot;:20}}, {multi:true})</code></pre><p>从<strong>3.2</strong>版本开始，MongoDB提供了<code>updateOne()</code>来更新单个文档，<code>updateMany()</code>来更新多个文档。</p><h5 id="save方法"><a href="#save方法" class="headerlink" title="save方法"></a>save方法</h5><blockquote><p>save方法直接传入一个新的文档保存到集合中，如果文档的_id存在 则会替换掉旧文档。</p></blockquote><p>使用<code>save</code>方法</p><pre><code>&gt; db.person.save({    &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;),     &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 })WriteResult({ &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 })&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }&gt; </code></pre><h4 id="删除文档"><a href="#删除文档" class="headerlink" title="删除文档"></a>删除文档</h4><blockquote><p>删除文档前 先使用find方法验证匹配条件是否正确是一个好习惯</p></blockquote><h5 id="remove方法"><a href="#remove方法" class="headerlink" title="remove方法"></a>remove方法</h5><blockquote><p>remove方法默认会删除所有匹配的文档，第二个参数传入<code>{justOne: true}</code>则只会删除匹配的一个。</p></blockquote><p>使用<code>remove</code>方法</p><pre><code>&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952a2606b5ba9661fa06f1&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad106b5ba9661fa06f2&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }{ &quot;_id&quot; : ObjectId(&quot;5a952ad206b5ba9661fa06f3&quot;), &quot;name&quot; : &quot;xiaoming&quot;, &quot;age&quot; : 20 }&gt; db.person.remove({&quot;name&quot;:&quot;xiaoming&quot;})WriteResult({ &quot;nRemoved&quot; : 3 })&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a951e3a06b5ba9661fa06ef&quot;), &quot;name&quot; : &quot;xiaobai&quot;, &quot;age&quot; : 22 }{ &quot;_id&quot; : ObjectId(&quot;5a951eb306b5ba9661fa06f0&quot;), &quot;name&quot; : &quot;xiaohong&quot;, &quot;age&quot; : 20 }&gt; </code></pre><p>想要删除集合中的所有文档 可以使用<code>remove({})</code>。MongoDB官方推荐使用<code>deleteOne</code>和<code>deleteMany</code>来删除文档。</p><h4 id="删除集合"><a href="#删除集合" class="headerlink" title="删除集合"></a>删除集合</h4><h5 id="drop方法"><a href="#drop方法" class="headerlink" title="drop方法"></a>drop方法</h5><pre><code>&gt; db.person.drop()true&gt; db.person.find()&gt;</code></pre><h4 id="删除数据库"><a href="#删除数据库" class="headerlink" title="删除数据库"></a>删除数据库</h4><h5 id="dropDatabase方法"><a href="#dropDatabase方法" class="headerlink" title="dropDatabase方法"></a>dropDatabase方法</h5><pre><code>&gt; db.dropDatabase(){ &quot;dropped&quot; : &quot;mydb&quot;, &quot;ok&quot; : 1 }&gt; show dbsadmin   0.000GBconfig  0.000GBlocal   0.000GB&gt; </code></pre><h2 id="运维篇"><a href="#运维篇" class="headerlink" title="运维篇"></a>运维篇</h2><h3 id="权限控制"><a href="#权限控制" class="headerlink" title="权限控制"></a>权限控制</h3><blockquote><p>默认MongoDB是没有启用权限控制的，这样无疑非常不安全。</p></blockquote><h4 id="添加管理员账号"><a href="#添加管理员账号" class="headerlink" title="添加管理员账号"></a>添加管理员账号</h4><pre><code>&gt; use adminswitched to db admin&gt; db.createUser({user:&quot;root&quot;,pwd:&quot;123456&quot;,roles:[{&quot;role&quot;:&quot;root&quot;,&quot;db&quot;:&quot;admin&quot;}]})Successfully added user: {    &quot;user&quot; : &quot;root&quot;,    &quot;roles&quot; : [        {            &quot;role&quot; : &quot;root&quot;,            &quot;db&quot; : &quot;admin&quot;        }    ]}&gt; </code></pre><h4 id="修改启动参数"><a href="#修改启动参数" class="headerlink" title="修改启动参数"></a>修改启动参数</h4><p>关闭MongoDB后重新启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /usr/local/mongodb/data/ --fork --logpath /var/log/mongod.log --bind_ip 0.0.0.0 --auth</span><br></pre></td></tr></table></figure></p><p>添加<code>--auth</code>参数则可以启用MongoDB的认证功能。</p><p>接下来重新连接MongoDB，看看操作是不是需要认证了。</p><pre><code>&gt; use adminswitched to db admin&gt; show tables2018-02-28T07:57:45.759+0000 E QUERY    [thread1] Error: listCollections failed: {    &quot;ok&quot; : 0,    &quot;errmsg&quot; : &quot;not authorized on admin to execute command { listCollections: 1.0, filter: {}, $db: \&quot;admin\&quot; }&quot;,    &quot;code&quot; : 13,    &quot;codeName&quot; : &quot;Unauthorized&quot;} </code></pre><h4 id="用户认证"><a href="#用户认证" class="headerlink" title="用户认证"></a>用户认证</h4><p>使用<code>db.auth(user,password)</code>来进行登陆数据库。</p><pre><code>&gt; use adminswitched to db admin&gt; db.auth(&quot;root&quot;,&quot;123456&quot;)1&gt; show tables;system.userssystem.version&gt; </code></pre><p>可以看到可以操作admin库了</p><h4 id="为其他库配置认证"><a href="#为其他库配置认证" class="headerlink" title="为其他库配置认证"></a>为其他库配置认证</h4><blockquote><p>需要注意的是 添加认证的库必须存在。</p></blockquote><p>还是需要先切换到admin库中才能为其他库创建认证。</p><pre><code>&gt; use adminswitched to db admin&gt; db.auth(&quot;root&quot;,&quot;123456&quot;)1&gt; db.createUser({user:&quot;op&quot;,pwd:&quot;123456&quot;,roles:[{&quot;role&quot;:&quot;readWrite&quot;,&quot;db&quot;:&quot;mydb&quot;}]})Successfully added user: {    &quot;user&quot; : &quot;op&quot;,    &quot;roles&quot; : [        {            &quot;role&quot; : &quot;readWrite&quot;,            &quot;db&quot; : &quot;mydb&quot;        }    ]}&gt; </code></pre><p>退出后重新登陆MongoDB</p><pre><code>&gt; use mydbswitched to db mydb&gt; show tables;2018-02-28T08:05:19.021+0000 E QUERY    [thread1] Error: listCollections failed: {    &quot;ok&quot; : 0,    &quot;errmsg&quot; : &quot;not authorized on mydb to execute command { listCollections: 1.0, filter: {}, $db: \&quot;mydb\&quot; }&quot;,    &quot;code&quot; : 13,    &quot;codeName&quot; : &quot;Unauthorized&quot;}&gt; db.auth(&quot;op&quot;,&quot;123456&quot;)1&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a96637de474606ab43c8e33&quot;) }{ &quot;_id&quot; : ObjectId(&quot;5a966385e474606ab43c8e34&quot;), &quot;a&quot; : 1 }&gt; </code></pre><h3 id="数据备份恢复"><a href="#数据备份恢复" class="headerlink" title="数据备份恢复"></a>数据备份恢复</h3><blockquote><p>数据备份恢复对于数据库系统来说是个非常重要的话题。</p></blockquote><h4 id="数据备份-mongodump"><a href="#数据备份-mongodump" class="headerlink" title="数据备份(mongodump)"></a>数据备份(mongodump)</h4><p>命令用法如下:<br><code>mongodump -h &lt;HOST&gt; -d &lt;DB&gt; -o &lt;PATH&gt;</code></p><p><code>-h</code> 指定连接的主机 格式是IP或者IP:PORT<br><code>-d</code> 指定备份的库名<br><code>-o</code> 指定备份的输出路径 默认是当前路径下的dump目录中</p><p>如果库需要认证的话 还需要使用<code>-u</code>和<code>-p</code>参数指定用户名和密码<br>如果不指定库名 则备份所有库。</p><p>比如:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongodump -h 127.0.0.1:27017 -d mydb -o /tmp/dump</span><br></pre></td></tr></table></figure></p><p>备份目标目录不存在会自动创建。</p><h4 id="数据恢复-mongorestore"><a href="#数据恢复-mongorestore" class="headerlink" title="数据恢复(mongorestore)"></a>数据恢复(mongorestore)</h4><p>命令用法如下:<br><code>mongorestore -h &lt;HOST&gt; -d &lt;DB&gt; &lt;PATH&gt;</code></p><p><code>-h</code> 指定连接的主机 格式是IP或者IP:PORT<br><code>-d</code> 指定备份的库名<br><code>&lt;PATH&gt;</code> 最后直接给出从哪恢复数据的目录</p><p>比如将刚才备份的mydb恢复到newdb中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongorestore -h 127.0.0.1:27017 -d newdb /tmp/dump/mydb/</span><br></pre></td></tr></table></figure></p><p>如果想恢复备份的所有库 可以不指定库名 然后指定所有库所在的父目录即可<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongorestore -h 127.0.0.1:27017  /tmp/dump/</span><br></pre></td></tr></table></figure></p><p>这样子就会按照库名进行恢复了。</p><h4 id="其他备份恢复方式"><a href="#其他备份恢复方式" class="headerlink" title="其他备份恢复方式"></a>其他备份恢复方式</h4><p>MongoDB还提供了<code>mongoexport</code>和<code>mongoimport</code>工具对数据进行备份，可以将数据备份为csv, json的格式。</p><p>或者还可以停掉MongoDB的服务 直接对MongoDB的数据目录进行备份，注意备份后的目录还存在<code>mongod.lock</code>文件的话需要删除才能在新的库上启动，不过如果存在<code>mongod.lock</code>文件 倒是需要担心备份的数据是否完整了。</p><h3 id="MongoDB集群"><a href="#MongoDB集群" class="headerlink" title="MongoDB集群"></a>MongoDB集群</h3><h4 id="MongoDB主从复制"><a href="#MongoDB主从复制" class="headerlink" title="MongoDB主从复制"></a>MongoDB主从复制</h4><blockquote><p>主从复制提供了数据的冗余备份，提高了数据的可用性，并可以保证数据的安全性。官方已经不推荐使用主从复制方式，搭建MongoDB集群还有更好的方式。</p></blockquote><p><strong>主从复制的好处</strong></p><ul><li>提高数据安全性，多台服务器同时硬盘损坏的概率是小于单台的</li><li>数据的高可用性，多台服务器同时宕机的概率是小于单台的</li><li>灾难恢复能力，当发生硬盘损坏，数据还有副本以便恢复</li><li>热备份能力，无需关闭或者降级服务就可以对数据进行备份、压缩等。</li><li>分布式读取数据，读取请求可以分发到多台服务器，降低单实例的读写压力。</li></ul><h5 id="主从复制原理"><a href="#主从复制原理" class="headerlink" title="主从复制原理"></a>主从复制原理</h5><p>MongoDB的主从复制至少需要两个节点，一个<code>Master</code>节点，其他的都是<code>Slave</code>节点。</p><p>还记得MongoDB启动后默认的<code>local</code>这个库吗，当<code>Master</code>进行写操作时，<code>Master</code>将写操作记录在<code>local</code>库的<code>oplog</code>集合里。<code>Slave</code>节点就通过读取<code>Master</code>节点的<code>oplog</code>将数据复制到自身一份，并且还会将复制信息写入到自己的<code>oplog</code>中，这样即使是<code>Slave</code>节点 也可以将自己作为同步源给其他<code>Slave</code>节点了。</p><p>需要注意的是，<code>oplog</code>是有固定大小的，到达最大大小后，新的记录会覆盖掉旧的记录。</p><h5 id="主从复制配置"><a href="#主从复制配置" class="headerlink" title="主从复制配置"></a>主从复制配置</h5><blockquote><p>需要先关闭已经运行的MongoDB进程</p></blockquote><p><strong><code>Master</code>节点执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /usr/local/mongodb/data/ --fork --logpath /var/log/mongod.log --bind_ip 0.0.0.0 --master</span><br></pre></td></tr></table></figure></p><p>可以看到只需要在主节点是添加<code>--master</code> 表示这一个<code>Master</code>节点就可以了。</p><p><strong><code>Slave</code>节点执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /usr/local/mongodb/data/ --fork --logpath /var/log/mongod.log --bind_ip 0.0.0.0 --slave --source 192.168.8.253:27017</span><br></pre></td></tr></table></figure></p><p><code>Slave</code>节点添加<code>--slave</code> 并指明<code>Master</code>节点的地址<code>--source 192.168.8.253:27017</code></p><h5 id="验证数据是否同步"><a href="#验证数据是否同步" class="headerlink" title="验证数据是否同步"></a>验证数据是否同步</h5><p><strong><code>Master</code>节点执行</strong></p><pre><code>&gt; use mydbswitched to db mydb&gt; db.test.insert({&quot;a&quot;:1})WriteResult({ &quot;nInserted&quot; : 1 })&gt; </code></pre><p><strong><code>Slave</code>节点执行</strong></p><pre><code>&gt; rs.slaveOk()&gt; use mydbswitched to db mydb&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a9619088cd96bc4a16514a9&quot;), &quot;a&quot; : 1 }&gt; </code></pre><p>由于<code>Slave</code>节点默认是不允许读写的，所以需要执行<code>rs.slaveOk()</code>来允许读取。</p><h4 id="MongoDB副本集"><a href="#MongoDB副本集" class="headerlink" title="MongoDB副本集"></a>MongoDB副本集</h4><blockquote><p><code>Replica Sets</code>方式，也是MongoDB官方推荐的方式。副本集方式比传统的主从复制改进的地方就是可以进行故障自动转移。如果主节点挂了，会自动选举一个从节点作为主，这个过程对用户是透明的。</p></blockquote><h5 id="副本集原理"><a href="#副本集原理" class="headerlink" title="副本集原理"></a>副本集原理</h5><p>一个副本集即为服务于同一数据集的多个 MongoDB 实例，其中一个为主节点，其余的都为从节点。主节点上能够完成读写操作，从节点仅能用于读操作。主节点需要记录所有改变数据库状态的操作，这些记录 保存在local数据库的oplog中，各个从节点通过此 oplog来复制数据并应用于本地。</p><p>集群中的各节点还会通过传递心跳信息来检测各自的健康状况。当主节点故障时。多个从节点会触发一次新的选举操作，并选举其中的一个成为新的主节点(通常谁的优先级更高，谁就是新的主节点)。心跳信息默认每2秒传递一次。<br>副本集中的副本节点在主节点挂掉后通过心跳机制检测到后，就会在集群内发起主节点的选举机制，自动选举出一位新的主服务器。</p><p>副本集可以包括三种节点：<strong>主节点</strong>、<strong>从节点</strong>、<strong>仲裁节点</strong>。</p><ol><li><p>主节点负责处理客户端请求，读、写数据, 记录在其上所有操作的oplog;</p></li><li><p>从节点定期轮询主节点的oplog进行同步数据。默认情况下从节点不支持客户端读取数据，但可以设置(<code>rs.slaveOk()</code>)；副本集的机制在于主节点出现故障的时候，余下的节点会选举出一个新的主节点，从而保证系统可以正常运行。</p></li><li><p>仲裁节点不复制数据，仅参与投票。由于它没有访问的压力，比较空闲，因此不容易出故障。由于副本集出现故障的时候，存活的节点必须大于副本集节点总数的一半，否则无法选举主节点，或者主节点会自动降级为从节点，整个副本集变为只读。因此，增加一个不容易出故障的仲裁节点，可以增加有效选票，降低整个副本集不可用的风险。仲裁节点可多于一个。也就是说只参与投票，不接收复制的数据，也不能成为活跃节点。仲裁节点并非必须存在。</p></li></ol><p>MongoDB 3.0之后官方推荐MongoDB副本集节点最少为3台，最多50台，仲裁节点最大为7个。为了避免脑裂发生 副本集成员最好为奇数。太多的副本集成员会增加复制成本，反而拖累整个集群。</p><h5 id="副本集配置"><a href="#副本集配置" class="headerlink" title="副本集配置"></a>副本集配置</h5><blockquote><p>注意：<code>--dbpath</code>的路径如果已经存在数据 最好先清除。</p></blockquote><p><strong>所有节点执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath /usr/local/mongodb/data/ --fork --logpath /var/log/mongod.log --bind_ip 0.0.0.0 --replSet rstest</span><br></pre></td></tr></table></figure></p><p>只需要在启动参数上增加<code>--replSet rstest</code>，<code>rstest</code>是副本集的名称。 </p><p><strong>登陆某个节点执行</strong></p><pre><code>&gt; var cfg = {_id:&quot;rstest&quot;,members:[     {_id:0,host:&apos;10.0.0.3:27017&apos;,priority:2},     {_id:1,host:&apos;10.0.0.4:27017&apos;,priority:1},       {_id:2,host:&apos;10.0.0.5:27017&apos;,arbiterOnly:true}] };&gt; rs.initiate(cfg){    &quot;ok&quot; : 1,    &quot;operationTime&quot; : Timestamp(1519793379, 1),    &quot;$clusterTime&quot; : {        &quot;clusterTime&quot; : Timestamp(1519793379, 1),        &quot;signature&quot; : {            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),            &quot;keyId&quot; : NumberLong(0)        }    }}rstest:SECONDARY&gt; </code></pre><p>将<code>10.0.0.3</code>的优先级配置为<code>2</code>，<code>10.0.0.5</code>配置为仲裁节点。<br>稍等一下，然后执行<code>rs.status()</code>方法看看<code>10.0.0.3</code>是否被选举为了<code>PRIMARY</code></p><pre><code>&quot;members&quot; : [        {            &quot;_id&quot; : 0,            &quot;name&quot; : &quot;10.0.0.3:27017&quot;,            &quot;health&quot; : 1,            &quot;state&quot; : 1,            &quot;stateStr&quot; : &quot;PRIMARY&quot;,            &quot;uptime&quot; : 228,            &quot;optime&quot; : {                &quot;ts&quot; : Timestamp(1519794123, 1),                &quot;t&quot; : NumberLong(2)            },            &quot;optimeDate&quot; : ISODate(&quot;2018-02-28T05:02:03Z&quot;),            &quot;electionTime&quot; : Timestamp(1519793982, 1),            &quot;electionDate&quot; : ISODate(&quot;2018-02-28T04:59:42Z&quot;),            &quot;configVersion&quot; : 1,            &quot;self&quot; : true        },</code></pre><p><code>rs.status()</code>方法可以详细的看到集群中每个节点的状态。</p><h5 id="验证副本集数据同步"><a href="#验证副本集数据同步" class="headerlink" title="验证副本集数据同步"></a>验证副本集数据同步</h5><p><strong>主节点插入数据</strong></p><pre><code>rstest:PRIMARY&gt; use mydbswitched to db mydbrstest:PRIMARY&gt; db.person.insert({&quot;a&quot;:1})WriteResult({ &quot;nInserted&quot; : 1 })rstest:PRIMARY&gt;</code></pre><p><strong>从节点验证数据</strong></p><pre><code>rstest:SECONDARY&gt; rs.slaveOk()rstest:SECONDARY&gt; show dbs;admin   0.000GBconfig  0.000GBlocal   0.000GBmydb    0.000GBrstest:SECONDARY&gt; use mydbswitched to db mydbrstest:SECONDARY&gt; db.person.find(){ &quot;_id&quot; : ObjectId(&quot;5a96386fe6101b17e4e221f0&quot;), &quot;a&quot; : 1 }rstest:SECONDARY&gt;</code></pre><h5 id="验证副本集故障转移"><a href="#验证副本集故障转移" class="headerlink" title="验证副本集故障转移"></a>验证副本集故障转移</h5><p><strong>关闭主节点服务</strong></p><pre><code>rstest:PRIMARY&gt; use adminswitched to db adminrstest:PRIMARY&gt; db.shutdownServer()</code></pre><p><strong>登陆其他节点查看主节点是否更变</strong></p><pre><code>&gt; rs.status()    {            &quot;_id&quot; : 1,            &quot;name&quot; : &quot;10.0.0.4:27017&quot;,            &quot;health&quot; : 1,            &quot;state&quot; : 1,            &quot;stateStr&quot; : &quot;PRIMARY&quot;,            &quot;uptime&quot; : 812,            &quot;optime&quot; : {                &quot;ts&quot; : Timestamp(1519794720, 1),                &quot;t&quot; : NumberLong(3)            },            &quot;optimeDate&quot; : ISODate(&quot;2018-02-28T05:12:00Z&quot;),            &quot;electionTime&quot; : Timestamp(1519794589, 1),            &quot;electionDate&quot; : ISODate(&quot;2018-02-28T05:09:49Z&quot;),            &quot;configVersion&quot; : 1,            &quot;self&quot; : true        },</code></pre><p>当原本的主节点上线后，会根据优先级重新选举，所以主节点就恢复到<code>10.0.0.3</code>上了。</p><h5 id="副本集的常用操作"><a href="#副本集的常用操作" class="headerlink" title="副本集的常用操作"></a>副本集的常用操作</h5><h6 id="查看集群配置信息"><a href="#查看集群配置信息" class="headerlink" title="查看集群配置信息"></a>查看集群配置信息</h6><p><code>local</code>库的<code>system.replset</code>集合存放着集群所有节点的信息，也可以使用<code>rs.conf()</code>来查看</p><pre><code>&gt; use local&gt; db.system.replset.find().pretty()&gt; rs.conf()</code></pre><h6 id="重新配置副本集"><a href="#重新配置副本集" class="headerlink" title="重新配置副本集"></a>重新配置副本集</h6><blockquote><p>注意：重新配置副本集必须在主节点上进行</p></blockquote><p>更改主从节点的优先级，使用<code>rs.reconf()</code>方法重新加载配置</p><pre><code>rstest:PRIMARY&gt; var cfg = {_id:&quot;rstest&quot;,members:[     {_id:0,host:&apos;10.0.0.3:27017&apos;,priority:1},     {_id:1,host:&apos;10.0.0.4:27017&apos;,priority:2},    {_id:2,host:&apos;10.0.0.5:27017&apos;,arbiterOnly:true}] };rstest:PRIMARY&gt; rs.reconfig(cfg){    &quot;ok&quot; : 1,    &quot;operationTime&quot; : Timestamp(1519795465, 1),    &quot;$clusterTime&quot; : {        &quot;clusterTime&quot; : Timestamp(1519795465, 1),        &quot;signature&quot; : {            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),            &quot;keyId&quot; : NumberLong(0)        }    }}rstest:PRIMARY&gt;</code></pre><h6 id="动态添加和删除节点"><a href="#动态添加和删除节点" class="headerlink" title="动态添加和删除节点"></a>动态添加和删除节点</h6><p>添加从节点</p><pre><code>rstest:PRIMARY&gt; rs.add(&quot;10.0.0.6:27017&quot;){    &quot;ok&quot; : 1,    &quot;operationTime&quot; : Timestamp(1519796327, 1),    &quot;$clusterTime&quot; : {        &quot;clusterTime&quot; : Timestamp(1519796327, 1),        &quot;signature&quot; : {            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),            &quot;keyId&quot; : NumberLong(0)        }    }}rstest:PRIMARY&gt;</code></pre><p>添加仲裁节点</p><pre><code>rstest:PRIMARY&gt; rs.addArb(&quot;10.0.0.7:27017&quot;){    &quot;ok&quot; : 1,    &quot;operationTime&quot; : Timestamp(1519796416, 1),    &quot;$clusterTime&quot; : {        &quot;clusterTime&quot; : Timestamp(1519796416, 1),        &quot;signature&quot; : {            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),            &quot;keyId&quot; : NumberLong(0)        }    }}</code></pre><p>删除节点</p><pre><code>rstest:PRIMARY&gt; rs.remove(&quot;10.0.0.7:27017&quot;){    &quot;ok&quot; : 1,    &quot;operationTime&quot; : Timestamp(1519796468, 1),    &quot;$clusterTime&quot; : {        &quot;clusterTime&quot; : Timestamp(1519796468, 1),        &quot;signature&quot; : {            &quot;hash&quot; : BinData(0,&quot;AAAAAAAAAAAAAAAAAAAAAAAAAAA=&quot;),            &quot;keyId&quot; : NumberLong(0)        }    }}</code></pre><h4 id="Mongodb分片集群"><a href="#Mongodb分片集群" class="headerlink" title="Mongodb分片集群"></a>Mongodb分片集群</h4><blockquote><p><code>Sharding cluster</code>是一种可以水平扩展的模式，在数据量很大时特给力。</p></blockquote><h5 id="分片集群原理"><a href="#分片集群原理" class="headerlink" title="分片集群原理"></a>分片集群原理</h5><p>在数据量非常大的情况下，单台MongoDB数据库的性能会严重下降，而将数据分片可以很好的解决单台服务器磁盘空间、内存、CPU等硬件资源的限制问题。</p><p>把数据水平拆分出去，降低单节点的访问压力。每个分片都是一个独立的数据库，所有的分片组合起来构成一个逻辑上的完整的数据库。因此，分片机制降低了每个分片的数据操作量及需要存储的数据量，达到多台服务器来应对不断增加的负载和数据的效果。</p><p>一个分片集群需要三种角色</p><ol><li>分片服务器(Shard Server) mongod实例，用于存储实际的数据块。分片服务器可以是一个副本集集群共同来提供服务 防止单点故障。</li><li>配置服务器(Config Server) mongod实例，存储整个集群和分片的元数据，就像是一本书的目录，保存的只是数据的分布表。</li><li>路由服务器(Route Server) mongos实例，客户端由此接入，本身不存放数据，仅供程序连接，起到一个路由的作用。</li></ol><p>分片集群在数据量非常大的情况下才能展现能力，这里只做简单讲解。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="MongoDB配置文件"><a href="#MongoDB配置文件" class="headerlink" title="MongoDB配置文件"></a>MongoDB配置文件</h3><p>实验中启动MongoDB都是通过命令行参数的方式启动的，这样显然并不是很友好。<br>可以将参数写入到配置文件中，然后启动的时候通过<code>--config</code>或者<code>-f</code>启动。</p><p>比如 可以将参数写入以下配置文件</p><pre><code>dbpath = /usr/local/mongodb/data/fork = truelogpath = /var/log/mongod.logbind_ip = 0.0.0.0auth = true</code></pre><p>像<code>--fork</code>和<code>--auth</code> 启用就填<code>true</code>，禁用就填<code>false</code></p><p>重新启动MongoDB</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">killall mongod</span><br><span class="line">mongod -f mongod.conf</span><br></pre></td></tr></table></figure><p>也可以登陆到MongoDB中，使用admin库的<code>shutdownServer</code>方法关闭服务。</p><pre><code>&gt; use adminswitched to db admin&gt; db.shutdownServer()server should be down...2018-02-28T08:24:49.077+0000 I NETWORK  [thread1] trying reconnect to 127.0.0.1:27017 (127.0.0.1) failed</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;  MongoDB 是一个基于分布式文件存储的数据库。由C++语言编写。旨在为WEB应用提供可扩展的高性能数据存储解决方案。MongoDB 是一个介于关系数据库和非关系数据库之间的产品，是非关系数据库当中功能最丰富，最像关系数据库的。他支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是他支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="MongoDB" scheme="http://www.yunfwe.cn/categories/MongoDB/"/>
    
    
      <category term="nosql" scheme="http://www.yunfwe.cn/tags/nosql/"/>
    
      <category term="mongodb" scheme="http://www.yunfwe.cn/tags/mongodb/"/>
    
  </entry>
  
  <entry>
    <title>高性能Web站点优化</title>
    <link href="http://www.yunfwe.cn/2018/02/17/2018/%E9%AB%98%E6%80%A7%E8%83%BDWeb%E7%AB%99%E7%82%B9%E4%BC%98%E5%8C%96/"/>
    <id>http://www.yunfwe.cn/2018/02/17/2018/%E9%AB%98%E6%80%A7%E8%83%BDWeb%E7%AB%99%E7%82%B9%E4%BC%98%E5%8C%96/</id>
    <published>2018-02-17T01:05:00.000Z</published>
    <updated>2025-07-22T07:12:54.872Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><blockquote><p>根据《构建高性能Web站点(修订版)》一书 加上自己的一些经验和理解写出了这篇博客，并在附录中留下了自己画的脑图。强烈推荐对Web站点优化有兴趣的开发者、web运维、架构师等阅读这本书。书中几乎涵盖了Web站点性能优化的所有内容，包括数据的网络传输、服务器并发处理能力、动态网页缓存、动态网页静态化、应用层数据缓存、分布式缓存、Web服务器缓存、反向代理缓存、脚本解释速度、页面组件分离、浏览器本地缓存、浏览器并发请求、文件的分发、数据库I/O优化、数据库访问、数据库分布式设计、负载均衡、分布式文件系统、性能监控等。</p></blockquote><a id="more"></a><h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><blockquote><p>由前端到后端的方式讲解web架构中可以优化的地方</p></blockquote><h3 id="客户端优化"><a href="#客户端优化" class="headerlink" title="客户端优化"></a>客户端优化</h3><blockquote><p>客户端指用户的浏览器 html页面最终由浏览器渲染为用户所看到的界面。常用的浏览器有Chrome、Firefox、IE/Edge、Opera等，通常使用更新版本的浏览器可以获得更高的性能和更好的用户体验。<br>浏览器一般都向下兼容，而由于历史遗留问题 依旧有大量用户使用较旧版本的浏览器 比如IE8/IE9 甚至还有IE6的用户，各浏览器的兼容性问题 也成了前端开发者要面临的严峻问题。</p></blockquote><h4 id="页面缓存"><a href="#页面缓存" class="headerlink" title="页面缓存"></a>页面缓存</h4><blockquote><p>使用HTTP协议的缓存协议 将资源服务器资源缓存到浏览器本地，用户只需和服务器请求需要更新的数据即可，这样大大提升了页面的加载速度 也降低了服务器的带宽使用。下面看看HTTP协议中有关缓存的内容</p></blockquote><h5 id="Last-Modified"><a href="#Last-Modified" class="headerlink" title="Last-Modified"></a>Last-Modified</h5><p>浏览器向服务器发起资源请求，服务器响应用户资源的同时在响应的HTTP头部中添加<code>Last-Modified</code>字段，字段的值是这个资源的最后修改时间。比如<code>Last-Modified: Thu, 15 Feb 2018 08:04:16 GMT</code></p><p>当客户端再次向浏览器请求这个资源时 会在HTTP请求头添加<code>If-Mondified-Since</code>字段，字段的值也是这个资源的最后修改时间。这意味着浏览器向服务器问 我请求的这个资源在此之后还有更新吗？这时候浏览器会检查这个资源在此之后有更新，如果没有更新就会返回<code>304 Not Mondified</code>。并不会返回资源的实体内容，而是告诉浏览器没有更新 可以使用本地缓存的内容。</p><p>如果服务器的资源发生改变了 则会重新向客户端发送更新后的资源，或者浏览器使用<code>Ctrl + F5</code>强制从服务器获取资源而无论资源是否有更新。</p><h5 id="ETag"><a href="#ETag" class="headerlink" title="ETag"></a>ETag</h5><p>服务端用一串编码对资源进行标记，这串编码就是ETag。ETag是服务器来生成的，生成的方式可以自定义，比如可以先计算哈希值 然后将这个哈希值作为ETag。</p><p>如果一个文件的Etag没有变化 那这个文件的内容也没有变化。浏览器向服务器请求某个资源，服务器响应这个资源时在相应HTTP头部中添加<code>ETag</code>标签 比如：<code>ETag: 50d0e11a7d7a4d0b5</code>。</p><p>当浏览器再次请求这个资源 会在HTTP请求头部添加<code>If-None-Match: 50d0e11a7d7a4d0b5</code>来询问服务器这个资源的Etag值还是这个吗？如果没有改变 服务器则响应<code>304 Not Mondified</code>。 </p><p>ETag是在HTTP/1.1中支持的缓存协商方法 主要是为了解决<code>Last-Modified</code>的一些缺点，比负载均衡环境中 很难保证各节点文件时间戳是完全相同的，这样客户端在不同的服务端轮询请求 无论内容是否改变 服务端都会发送全部的内容，这个时候只要使用ETag则可以避免这个问题。</p><p>但是<code>ETag</code>的生成会比<code>Last-Modified</code>更消耗CPU资源，而<code>Last-Modified</code>则对<code>HTTP/1.0</code>也有支持，Nginx则会同时返回这两个字段。</p><h5 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a>Expires</h5><blockquote><p>HTTP缓存的存在就是为了消灭不必要的请求 而<code>Last-Modified</code>和<code>ETag</code>明显还是存在请求和响应的，接下来的这两个协议就是完全不会发送HTTP请求的。</p></blockquote><p><code>Expires</code>告诉浏览器资源什么时候过期，在资源过期期间 浏览器会直接使用已缓存的资源而不会向服务器发起任何询问。</p><p><code>Expires</code>的值是允许资源缓存到什么时候的一个时间戳 比如：<code>Expires: Thu, 15 Feb 2018 08:04:16 GMT</code>，浏览器根据当前时间和资源的过期时间进行对比 如果资源没有过期的话则直接使用资源。如果资源过期 并且存在<code>ETag</code>或者<code>Last-Modified</code>的情况 浏览器则会根据这两个字段询问服务器。</p><h5 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a>Cache-Control</h5><p>如果浏览器的时间跟服务器的时间不一致 比如浏览器比服务器时间快了十分钟，那对于缓存五分钟的资源来说 浏览器总是认为资源是过期的，这时候<code>Expires</code>就无法正常工作了。</p><p>幸运的是<code>Cache-Control</code>是用来补足<code>Expires</code>的不足，<code>Cache-Control</code>的格式是<code>Cache-Control: max-age=&lt;second&gt;</code>。<code>max-age</code>指定了缓存过期的相对本地时间 单位是秒。比如这个资源可以缓存3600秒，那么在3600秒内 浏览器都不会询问资源是否有更新了。</p><p>使用<code>Ctrl + F5</code>的方式刷新页面 会忽略缓存协议 所有内容都直接向服务端重新请求<br>而使用<code>F5</code>或者点击浏览器的刷新按钮，它允许浏览器在请求中附加必要的缓存协议，但是不允许直接使用本地缓存，也就是说 它能让<code>Last-Modified</code>或<code>ETag</code>生效 但是会让<code>Expires</code>或<code>Cache-Control</code>失效</p><h5 id="浏览器请求过程"><a href="#浏览器请求过程" class="headerlink" title="浏览器请求过程"></a>浏览器请求过程</h5><p><img src="/uploads/2018/web/874zui0c06vwr9f2.jpg" alt></p><h4 id="代码优化"><a href="#代码优化" class="headerlink" title="代码优化"></a>代码优化</h4><blockquote><p>代码优化主要在提升用户体验上，这样即使用户网络质量不好的情况下 也经尽可能的提升用户体验。<br>比如当网络质量不好 页面加载缓慢的情况下 可以提供一个loading的画面给用户 也可以显著的提升用户体验。</p></blockquote><h5 id="HTML的渲染过程"><a href="#HTML的渲染过程" class="headerlink" title="HTML的渲染过程"></a>HTML的渲染过程</h5><blockquote><p>想知道一个页面是怎么出现在用户面前的 就需要了解浏览器是如何渲染html的</p></blockquote><p>浏览器在网络上获取到HTML的相应字节时就开始对<code>HTML</code>进行构建了，但是由于浏览器渲染的一些机制 遇到某些情况浏览器页面就被阻塞了，这也就是用户看到页面卡住而无法操作的的原因，这种情况是非常影响用户体验的。</p><p>当遇到以下情况时 浏览器的UI界面会被阻塞</p><ul><li>HTML的数据流被阻塞在了网络中 或者网络质量太差导致数据包接收过慢</li><li>未加载完的脚本或者脚本执行时间过长</li><li>遇到了script节点 但是此时还有未加载完的样式文件</li></ul><p>将<code>css</code>样式文件放到HTML文档中<code>head</code>标签内，<code>js</code>脚本文件最好放到<code>body</code>标签中的最下面，这样可以一定程度的避免<code>js</code>脚本的执行过程中导致浏览器UI阻塞了。</p><h5 id="懒加载技术"><a href="#懒加载技术" class="headerlink" title="懒加载技术"></a>懒加载技术</h5><blockquote><p>大家在查看百度图片的时候 会发现不断的滚动页面 就会有更多的图片加载出来，这个就是图片的懒加载技术。</p></blockquote><p>当业务查询出的数据量特别大时，如果全部传输给浏览器 不仅对浏览器 对服务器也会照成很大的压力。<br>而采用按需加载的方式，用户选择某个单元的时候 再加载这个单元需要的数据，这样既节约了系统相应时间，还提升了系统性能，更提高了用户体验 所以懒加载技术是非常有价值的。</p><p>懒加载技术也同样适用于<code>Vue</code>, <code>Angular2</code>等<code>SPA框架</code>(single page web application)。通过<code>webpack</code>打包的<code>SPA应用</code>是非常大的，浏览器第一次加载的时候可能会非常耗时，所以可以将不同路由对应的组件分割成不同的代码块，然后当路由被访问的时候才加载对应组件，这样就更加高效了。</p><h5 id="使用Ajax交换数据"><a href="#使用Ajax交换数据" class="headerlink" title="使用Ajax交换数据"></a>使用Ajax交换数据</h5><p>大部分的HTML页面渲染过程是在服务端完成的，但是通过Ajax技术可以在浏览器页面加载之后异步向服务器发送HTTP请求，获取到动态的数据后由客户端的<code>JavaScript</code>来将数据渲染到HTML页面中。这样后端只提供一套Web接口，数据的渲染部分由前端完成，后端不仅拥有了更高的通用性，也省去了对HTML页面渲染的CPU开销。</p><h5 id="加载动画"><a href="#加载动画" class="headerlink" title="加载动画"></a>加载动画</h5><p>当不得不存在一些耗时的页面时，使用加载动画 增加页面的趣味性也不失是一个好方法。可以在需要用户等待的页面时提供一个加载动画，然后数据准备完毕后移除动画。有了加载动画的存在 可以降低用户看到一片空白的等待页面由于不耐烦而关闭页面的概率。</p><h3 id="传输优化"><a href="#传输优化" class="headerlink" title="传输优化"></a>传输优化</h3><blockquote><p>HTML文档在到达浏览器这段中可以有哪些优化呢</p></blockquote><h4 id="减少数据传输量"><a href="#减少数据传输量" class="headerlink" title="减少数据传输量"></a>减少数据传输量</h4><h5 id="浏览器减少http请求"><a href="#浏览器减少http请求" class="headerlink" title="浏览器减少http请求"></a>浏览器减少http请求</h5><p>在页面中引用一个js文件和将js代码写入到html文档中 对于页面渲染结果来说是相同的，但是对于页面中引用js文件 浏览器需要向后端发送两次HTTP请求，而HTTP的请求和响应头部数据也是数据流的一部分，如果能减少HTTP的请求数量 也可以提升一部分浏览器渲染速度。</p><p>但是将css和js甚至图片都写入到一个html文档 显然是非常降低文档的可读性的，对日后的维护等影响也比较大。但是可以使用<code>webpack</code>等打包工具，将前端页面写完后 利用webpack打包成单个或者多个文件，浏览器只需要加载打包后的文件就可以了。而且<code>webpack</code>在打包过程中还会对代码进行压缩 去掉代码中没必要的空格、换行符，将代码中的变量名用a, b, c等简短的变量代替，打包后的代码大小也会大大减少。</p><h5 id="启用Keep-Alive"><a href="#启用Keep-Alive" class="headerlink" title="启用Keep-Alive"></a>启用Keep-Alive</h5><p>普通的一次HTTP请求 在服务器响应后就会关闭这次的TCP连接，下一个HTTP请求会继续开启和关闭一个TCP连接。如果能重用这个TCP连接就能省掉TCP连接和关闭的开销了，而<code>Keep-Alive</code>就是为此而生的。</p><p>只需要在HTTP头部加入<code>Connection: Keep-Alive</code>就可以启用<code>Keep-Alive</code>了，目前浏览器都支持<code>HTTP/1.1</code>协议，在<code>HTTP/1.1</code>协议中<code>Keep-Alive</code>是默认开启的。</p><h5 id="gzip压缩数据"><a href="#gzip压缩数据" class="headerlink" title="gzip压缩数据"></a>gzip压缩数据</h5><p>文本类型的数据拥有很大的压缩比，几乎可以达到80%以上 也就是说一个100KB的文档，通过<code>gzip</code>压缩后的大小可能只有20KB左右，在提升网络数据传输上效果是非常显著的。</p><p><code>gzip</code>压缩需要web服务器开启压缩功能，浏览器也需要在请求头部设置接受gzip压缩的字段：<code>Accept-Encoding: gzip, deflate</code>，表明浏览器支持gzip和deflate这两种压缩方式。</p><p>服务器接受到请求后判断浏览器是否支持压缩 如果支持就将数据压缩后传输。<br>浏览器接受到数据后判断是否是已压缩的，如果是压缩的就先解压。</p><p>需要注意的是 有些数据类型即使压缩也不会有很大的压缩比的 比如大部分的图片和视频文件，对它们进行压缩不仅浪费宝贵的CPU资源 也获得不了很大的实际效果。所以需要在服务器配置排除掉对这些数据的压缩。</p><h5 id="减少Cookie的大小"><a href="#减少Cookie的大小" class="headerlink" title="减少Cookie的大小"></a>减少Cookie的大小</h5><p>由于HTTP是无状态的协议，服务器需要知道用户的身份就将用户数据放入到<code>Cookie</code>中，<code>Cookie</code>也是HTTP请求头部的一个字段，<code>Cookie</code>的值的大小浏览器限制不得超过4KB。</p><p>浏览器在对某个域发起HTTP请求时，如果存在这个域的<code>Cookie</code>数据，那么就会携带上<code>Cookie</code>进行请求。如果Cookie过大的话 显然也会降低数据的传输效率，而且<code>Cookie</code>是不安全的数据存放方式 除非必须 应该尽量避免掉 换用更安全的<code>Session</code>技术。</p><h4 id="CDN加速"><a href="#CDN加速" class="headerlink" title="CDN加速"></a>CDN加速</h4><p>CDN的全称是<code>Content Delivery Network</code>，即内容分发网络。CDN系统将数据分发到各CDN节点(其实就是缓存服务器)，当用户访问时智能的选择离用户最近的CND节点。</p><p>CND对用户访问体验可以带来很大的提升，但是也要面临数据更新同步到各CDN节点再到用户浏览器中有一定的延迟问题。</p><h4 id="选择更合适的宽带"><a href="#选择更合适的宽带" class="headerlink" title="选择更合适的宽带"></a>选择更合适的宽带</h4><p>总所周知联通的线路和电信的线路互通性并不是太好，BGP机房就是服务器租用商通过技术的手段，实现不同运营商能共同访问一个IP，并且不同运营商之间都能达到最快的接入速度的相关网络技术。BGP机房在一定程度上解决了各用户南北互通的问题，提高了用户的访问速度。</p><h3 id="服务端优化"><a href="#服务端优化" class="headerlink" title="服务端优化"></a>服务端优化</h3><blockquote><p>服务端优化指服务端的负载均衡器、Web静态资源服务器、真实后端服务器等程序的优化</p></blockquote><h4 id="应用服务器"><a href="#应用服务器" class="headerlink" title="应用服务器"></a>应用服务器</h4><blockquote><p>这里将Web静态资源服务器和后端服务器都作为应用服务器</p></blockquote><h5 id="程序"><a href="#程序" class="headerlink" title="程序"></a>程序</h5><h6 id="多进程"><a href="#多进程" class="headerlink" title="多进程"></a>多进程</h6><p>使用多进程来提升服务器的并发能力和提高CPU的利用率。在Linux中和客户端每建立的一个TCP连接都作为一个进程打开的文件描述符，Linux对单个进程默认限制最大打开<code>1024</code>个文件描述符，能处理的<code>Socket文件描述符</code>就更少了。</p><p>除了提升Linux对最大文件描述符的限制外 通过多进程同时对外提供服务显然是更合适的方法，可以更高效的利用多核处理器的处理能力。</p><p>在Linux上使用<code>ulimit -n</code>可以查看当前最大文件描述符限制，使用<code>ulimit -n 4096</code>可以将最大文件描述符设置为4096。可以通过检索<code>/proc/&lt;PID&gt;/limits</code>文件查看正在运行的进程的最大文件描述符限制</p><p>Nginx中 修改<code>worker_processes</code>的值可以配置Nginx启动多少个worker进程 一般建立配置为<code>auto</code>。<br>Apache的prefork模型，就是采用大量的进程来处理用户请求，当用户接入时，fork一个进程去处理。这样的好处是每个用户的请求相对隔离，不会因为一个用户请求处理进程崩溃而影响到其他用户的请求。但是在高并发下 内存的大量消耗和频繁的上下文切换可能成为瓶颈。<br>php-fpm的fastcgi中 预先初始化多个cgi进程等待web服务器的动态页面请求，这样可以减少进程创建和销毁的开销。</p><p>Linux还有一个<code>OOM机制</code>(<code>Out Of Memory killer</code>)和进程的<code>优先级机制</code>(<code>nice值</code>)。</p><p>OOM机制会监控那些占用内存过大，尤其是瞬间很快消耗大量内存的进程，为了防止内存耗尽而内核会把该进程杀掉。为了防止重要的进程触发OOM机制而被杀死 可以设置进程<code>/proc/&lt;PID&gt;/oom_adj</code>文件的值为<code>-17</code>来临时关闭对这个进程的监控。但是最好还是不要对这些耗内存大的程序使用 否则照成sshd等重要的进程被杀死就得不偿失了。</p><p>优先级呢通过配置进程的nice值来更改进程占用CPU的百分比，nice值得范围是<code>-20到+19</code>，值越低 程序可以获取更多的CPU执行时间。使用<code>nice -n -19 nginx</code> 可以将Nginx进程的nice值设置为<code>-19</code>。Nginx派生的子进程也会继承这个nice值。对于已经存在的进程可以通过<code>renice -n 10 &lt;PID&gt;</code>将该进程的nice值设置为10，但是并不会对该进程的子进程生效。</p><h6 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h6><p>和多进程不同的是当客户建立连接后，派生一个线程去处理用户请求。线程的创建和销毁开销是低于进程的，内存使用也会减少一些。比如Apache的worker模型 同时使用了多进程和多线程，所有的线程共享同一个进程内存空间，如果一个线程崩溃 可能会影响到整个进程。</p><h6 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h6><p>大家可能对进程和线程比较熟悉 而对协程比较陌生。原生支持协程的语言并不多 但是协程非常适合在高并发环境下使用。</p><p>协程没有抢占式调度，由代码内主动放弃执行权切换到其他协程执行 因此也不存在上下文切换的开销。协程始终是运行在单线程内 所以也不存在变量共享的锁竞争。</p><p>Go语言对协程有良好的支持 所以非常适合高并发的服务端网络编程，Python语言<code>yield</code>关键字提供了对协程的基本支持，Gevent、Tornado等库都对协程有良好的支持。Python3.5之后引入<code>async/await</code>关键字对协程则有了非常好的支持。</p><h6 id="优化系统调用"><a href="#优化系统调用" class="headerlink" title="优化系统调用"></a>优化系统调用</h6><p>使用<code>strace</code>命令对Nginx的worker进程进行系统调用跟踪，可以分析出用户一次请求共进行了多少次系统调用。比如如果存在日志记录，那一定会存在每处理一条用户请求 都会向日志写入一条记录。每次对日志进行一次write操作 都是一次系统调用，如果关闭日志记录功能 就可以省掉一次日志写入的系统调用。但是对于Web服务器 日志存在的价值显然是高于能节约的响应时间。</p><p>使用<code>strace -c -p &lt;PID&gt;</code>可以对已启动的进程进行系统调用统计，使用<code>Ctrl</code>+<code>C</code>结束统计</p><pre><code>root@ubuntu:~# strace -c -p 18803strace: Process 18803 detached% time     seconds  usecs/call     calls    errors syscall------ ----------- ----------- --------- --------- ----------------100.00    0.000200          50         4           stat0.00    0.000000           0         1           write0.00    0.000000           0         1           open0.00    0.000000           0         2           close0.00    0.000000           0         1           fstat0.00    0.000000           0         1           writev0.00    0.000000           0         1           sendfile0.00    0.000000           0         2           recvfrom0.00    0.000000           0         2           setsockopt0.00    0.000000           0         2           epoll_wait0.00    0.000000           0         1           epoll_ctl0.00    0.000000           0         1           accept4------ ----------- ----------- --------- --------- ----------------100.00    0.000200                    19           total</code></pre><p>这里是Nginx的worker进行一次用户请求处理的系统调用统计，可以看到Nginx使用sendfile调用向用户发送数据。使用sendfile等更高效的大文件传输方式，尽量将操作在内核中完成，减少数据在内核态和用户态的复制。</p><p>使用更高效的系统调用方式和减少不必要的系统调用 就是对系统调用的优化了。</p><h6 id="尽量避免锁竞争"><a href="#尽量避免锁竞争" class="headerlink" title="尽量避免锁竞争"></a>尽量避免锁竞争</h6><p>只要涉及到多进程或多线程的变量共享问题 就会涉及到锁竞争了。只要使用了锁，多进程或多线程就变成了线性的等待锁资源，对于高并发状态 锁竞争会严重降低系统性能。所以在设计后端的时候 开发者需要尽量避免变量共享问题。</p><h6 id="更高效的IO模型"><a href="#更高效的IO模型" class="headerlink" title="更高效的IO模型"></a>更高效的IO模型</h6><p>Nginx的高并发能力源自它采用了<code>多路IO就绪通知机制</code>，常见的机制有<code>select</code>, <code>poll</code>, <code>epoll</code>等 其中Linux下性能最好的是<code>epoll</code>，跨平台的是<code>select</code>。</p><h6 id="程序代码跟踪分析"><a href="#程序代码跟踪分析" class="headerlink" title="程序代码跟踪分析"></a>程序代码跟踪分析</h6><p>很多语言都有代码性能分析工具，利用这些工具可以分析出一段代码运行各部分的耗时。通过优化这些耗时的代码 可以更好的提升性能和对用户的响应。</p><p>可以使用<code>xhprof</code>对PHP的程序进行性能分析，使用<code>cProfile</code>对Python的代码进行性能分析。</p><h5 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h5><blockquote><p>这个缓存是在服务端的缓存</p></blockquote><h6 id="字节码缓存"><a href="#字节码缓存" class="headerlink" title="字节码缓存"></a>字节码缓存</h6><p>PHP、Python等动态语言的执行首先需要将源代码编译为字节码，比如PHP的字节码是在<code>Zend虚拟机</code>中运行，Python的字节码是在<code>Python虚拟机</code>中运行。</p><p>这些脚本在执行过程中会先将源代码编译为字节码，而直接将字节码缓存起来就可以省掉编译的过程了。比如PHP的<code>XCache</code>。而Python可以通过<code>python -m compileall &lt;PATH&gt;</code>将单个py文件或者目录中全部的py文件编译为<code>.pyc</code>文件（Python3之后是生成在<code>__pycache__</code>目录中）。</p><h6 id="页面缓存-1"><a href="#页面缓存-1" class="headerlink" title="页面缓存"></a>页面缓存</h6><blockquote><p>后端生成的html页面 也可以先缓存起来 这样就不用重新生成了。</p></blockquote><p>页面缓存又分为三种</p><ul><li><strong>静态内容缓存</strong></li></ul><p>在Web服务器上将<code>html</code>, <code>css</code>, <code>js</code>等静态页面缓存到内存中或者<code>Memcached</code>等分布式缓存中。总所周知内存的速度是非常快的，对比从内存中取数据，从磁盘上取数据可以说是非常满的了。</p><p>如果存在代理服务器，在代理服务器上完成缓存可以更快的返回给用户 这样都不需要经过后端程序了。</p><ul><li><strong>动态内容缓存</strong></li></ul><p>动态页面的渲染后端可能需要从数据库中取数据 然后将数据渲染到html模板中 最后生成动态页面。对于一些时效性要求不高的页面，可以选择将页面缓存起来，提供一个缓存过期时间，在未过期之前就直接向用户返回缓存的页面。这样可以有效的减少对数据库的读写和CPU的页面渲染。</p><p>动态页面缓存也最好配置在代理服务器上。<code>Redis</code>的键值过期机制也非常适合做这种缓存服务器。</p><ul><li><strong>局部无缓存</strong></li></ul><p>如果一个页面中只有一部分的数据是需要更新的 其他部分的数据都不变 可以采用这种缓存方式。</p><p>比如采用SSI技术 只更新页面中动态的内容。但是需要服务器读取shtml模板页面，匹配和修改更新的内容，需要较大的CPU开销。</p><h6 id="数据库读写缓存"><a href="#数据库读写缓存" class="headerlink" title="数据库读写缓存"></a>数据库读写缓存</h6><blockquote><p>如果能将数据库的查询结果也缓存起来 就可以避免某些对数据库的查询了。</p></blockquote><p><strong>读缓存</strong></p><p>可以将<code>select</code>语句的查询结果缓存到缓存服务器中，当再次遇到相同的sql查询语句时就可以直接从缓存服务器获取结果而不必再次查询数据库了。但是需要注意缓存的生命周期，如果数据已经更新 而缓存还在生效 就会导致页面显示更新不及时。</p><p><strong>写缓存</strong></p><p>将频繁的数据库写入操作尝试合并为一次写入，比如累计用户登陆次数，先将数据存入memcached中，累计登陆10次后写入数据库中。但是这样想要获取准确的用户登陆次数信息 就要同时获取数据库记录而缓存服务器记录数的相加结果了，而且还要承受缓存服务器意外宕机导致的数据丢失问题。</p><h5 id="数据共享"><a href="#数据共享" class="headerlink" title="数据共享"></a>数据共享</h5><p>后端服务器群中的数据共享问题，比如用户上传了头像或者照片，因为负载均衡的原因只上传到了一台服务器上，这样下次用户换个设备登陆的时候可能就找不到上传的图片了。这个时候就需要让所有服务器共享一个数据存储。</p><p>数据可以通过<code>rsync</code>或者<code>scp</code>进行同步 但是服务器如果比较多 而站点刚好是用户上传数据比较频繁的类型，这两种方式显然就不适合了。还可以采用<code>NFS</code>或者<code>Samba</code>共享等方式，有条件的话可以使用<code>NAS网络存储</code>，或者使用开源的<code>分布式文件系统</code>，比如<code>FastDFS</code>，<code>HDFS</code>等。</p><h5 id="Web组件分离"><a href="#Web组件分离" class="headerlink" title="Web组件分离"></a>Web组件分离</h5><blockquote><p>随着业务的扩展和服务器规模的扩大，就需要对业务组件进行拆分了，将不同的组件部署在不同的服务器上。</p></blockquote><h6 id="不同组件使用不同的域名"><a href="#不同组件使用不同的域名" class="headerlink" title="不同组件使用不同的域名"></a>不同组件使用不同的域名</h6><p>比如百度知道的域名为<code>zhidao.baidu.com</code>，而百度知道中的图片存放在域名为<code>gss0.bdstatic.com</code>的服务器上。不同的域名可以指定不同的IP，不同的业务便可以分散到不同的服务器上了。</p><p>另一个好处是可以避开浏览器对同一个域名的并发数限制，将资源分散到不同的域名也增快了页面最终呈现的速度。</p><h5 id="数据库连接优化"><a href="#数据库连接优化" class="headerlink" title="数据库连接优化"></a>数据库连接优化</h5><p>大多数的后端程序都有数据库连接池的概念，由数据库连接池来维护与数据库的连接，程序只用从数据库连接池中获取和释放连接就可以。程序对数据库连接池的获取和释放连接是非常廉价的，而数据库连接池会保证池内拥有一定量可用的数据库连接。</p><h4 id="反向代理和负载均衡"><a href="#反向代理和负载均衡" class="headerlink" title="反向代理和负载均衡"></a>反向代理和负载均衡</h4><blockquote><p>当单台主机无法承受业务访问量的时候 就需要多台服务器同时工作了。而如何将用户请求均衡的分发到各后端服务器 就是负载均衡器的工作了，一般负载均衡器也是反向代理服务器。</p></blockquote><h5 id="动静分离"><a href="#动静分离" class="headerlink" title="动静分离"></a>动静分离</h5><p>将网站的静态资源和动态页面分离，一般PHP等后端服务并不擅长处理静态资源，这个时候就需要使用专业的静态资源服务器来处理网站的静态资源了。</p><p>比如以高并发著称的<code>Nginx</code>就非常适合做这件事情，由<code>Nginx</code>处理静态资源，动态内容则转发到后端的应用服务器处理。<code>Nginx</code>在这里也就是反向代理服务器了。</p><h5 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h5><p>通常由负载均衡软件或者专业的负载均衡设备来将用户请求分发到不同的后端服务器。</p><p>负载均衡器通常会根据一些算法来对用户请求进行分发，比如常用的<code>轮询</code>、<code>加权轮询</code>、<code>ip_hash</code>等。</p><p>负载均衡器往往还会对后端服务器进行健康检查，剔除意外宕机的后端服务器 以免某个用户刚好访问到宕机的服务器。同时负载均衡器上还要注意用户的登陆状态保持功能。</p><p>还可以在负载均衡器上配置<code>ssl</code> 这样就可以免去配置所有的后端服务器而获得一个<code>https</code>的网站了。</p><h5 id="负载均衡的方式"><a href="#负载均衡的方式" class="headerlink" title="负载均衡的方式"></a>负载均衡的方式</h5><h6 id="Nginx或者HAProxy"><a href="#Nginx或者HAProxy" class="headerlink" title="Nginx或者HAProxy"></a>Nginx或者HAProxy</h6><p>四层负载均衡只根据传输层协议内容进行转发，而不关心传输层以上的数据。<br>七层负载均衡则根据应用层协议内容进行转发，可以对应用层协议进行更精确的控制，比如可以判断用户的访问设备，然后根据设备发送不同的页面。</p><p>而<code>Nginx</code>和<code>HAProxy</code>对则四层负载均衡和七层负载均衡都有较好的支持。</p><h6 id="HTTP重定向"><a href="#HTTP重定向" class="headerlink" title="HTTP重定向"></a>HTTP重定向</h6><p>通过返回<code>302状态码</code>将用户请求按照算法重定向到其他的服务器域名。</p><p>优点是比较简单，容易实现，负载均衡器只做请求分发 所以不会是IO瓶颈。<br>缺点是浏览器需要两次请求服务器才能完成一次访问，性能略差，302状态码还有可能降低搜索引擎的排名。</p><h6 id="DNS简单轮询"><a href="#DNS简单轮询" class="headerlink" title="DNS简单轮询"></a>DNS简单轮询</h6><p>同一个域名添加多条A记录，用户进行DNS查询时依照轮询算法返回某一个服务器的IP地址。</p><p>优点是将负载均衡工作交给了DNS，省去维护负载均衡器的麻烦，同时DNS支持基于地理位置的解析，可以返回给用户最近的服务器地址。<br>缺点：DNS是多级解析，每一级都可能有缓存，修改了DNS可能不会立即生效，控制权在运营商手里。实际上大型网站经常利用DNS作为第一级的负载均衡。</p><h6 id="LVS负载均衡器"><a href="#LVS负载均衡器" class="headerlink" title="LVS负载均衡器"></a>LVS负载均衡器</h6><blockquote><p>LVS负载均衡器是所有软件负载均衡器中性能最高的了 甚至比肩专业的负载均衡器设备。这里就单独拿出来介绍下LVS的三种负载方式。</p></blockquote><p><strong>LVS-NAT</strong></p><p>NAT模式 负载均衡工作在网络层 修改用户数据包的目标地址并转发到相应的后端服务器，后端服务器的默认网关应该指向NAT主机，LVS服务器收到回应后再将源地址改为自己的地址。但是此模式中 负载均衡器对所有的流量进行转发 所以随着后端服务器的增加，负载均衡器容易成为流量瓶颈。</p><p><strong>LVS-DR</strong></p><p>直接路由模式 负载均衡工作在数据链路层，通过修改数据包中的目标MAC地址，将数据包转发到后端服务器。最后数据直接由选中的后端服务器返回给用户，所以后端服务器也必须接入互联网。这时候LVS服务器不会是流量的瓶颈了 但是所有的后端服务器都需要有公网IP，而且必须和负载均衡器在同一个交换机上。</p><p><strong>LVS-TUN</strong></p><p>IP隧道模式 和直接路由工作原理相似，可以跨机房，服务器之间通过IP隧道连接 拥有直接路由模式模式的优点。但是IP隧道实际上是对数据包的又一层封装，IP隧道数据包的封装和解包都会有一定的开销。</p><h4 id="硬件升级"><a href="#硬件升级" class="headerlink" title="硬件升级"></a>硬件升级</h4><blockquote><p>可能的情况下 升级硬件设备对性能的提升是非常巨大的。当然在升级硬件的时候也要考虑主板是否支持这些硬件。</p></blockquote><h5 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h5><p>在选择CPU一般会考虑CPU的主频、核心数、制作工艺以及支持的指令集。</p><p>一般来说 CPU的主频越高 性能越强 但是功耗也会越高。核心数越多表示可以同时运行的进程越多，Intel的超线程技术 可以将一个物理核心数模拟为两个逻辑核心数，总性能大约可以提升20%左右。而随着CPU制作工艺的提升 芯片的体积可以越来越小 功耗也会更小。</p><h5 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h5><p>选购内存一般考虑类型和主频。现在内存已经进入了DDR4时代 但是服务器硬件更新迭代的比较慢 大部分服务器依旧使用DDR3内存，DDR4有着比DDR3更高的主频，更快的速度，和更低的功耗</p><h5 id="硬盘"><a href="#硬盘" class="headerlink" title="硬盘"></a>硬盘</h5><h6 id="机械硬盘"><a href="#机械硬盘" class="headerlink" title="机械硬盘"></a>机械硬盘</h6><p>机械硬盘的单位容量更为廉价，也是服务器采用最多的存储方式。但是机械硬盘属于损耗品 大约工作5年左右就会出现故障，一般企业会选择磁盘阵列技术来对硬盘的数据进行容错和提升性能。服务器硬盘的转速多为10000rpm或者15000rpm 转速越高 硬盘的读写性能越强。</p><p>下面看看几种常见的磁盘阵列方式</p><p><strong>Raid 1</strong>: 至少需要两块硬盘 其中一块作为数据备份，读取性能高，且允许故障一块硬盘，但是空间利用率只有50%。</p><p><strong>Raid 5</strong>: 性能 数据安全 和存储成本兼顾的方案 至少三块硬盘的话 允许故障一块，空间利用率为硬盘总数减1，因为有差不多一块盘的空间用于存储奇偶校验信息，并散列存储在所有的硬盘上。</p><p><strong>Raid 10</strong>: 集合Raid0的高性能读写和Raid1的安全 至少需要4块硬盘 最多允许坏两块硬盘 空间利用率也只有50%。</p><h6 id="固态硬盘"><a href="#固态硬盘" class="headerlink" title="固态硬盘"></a>固态硬盘</h6><p>企业级固态硬盘的成本非常，但是性能也是非常强的。固态硬盘理论上支持无限次的读取，但是对擦写是由次数限制的。程序的运行很大一部分时间耗在了等待IO上，而使用固态硬盘可以大大提升文件的读写速度，程序的执行效率提升可以很明显的增强。通过对比使用固态硬盘的机器和机械硬盘的机器开机速度可以很明显的对比出固态硬盘对系统流畅度的提升。</p><p>几种常见的固态硬盘使用的闪存芯片</p><p><strong>TLC闪存</strong>: 速度慢 寿命短 约500次擦写寿命 稳定性比较差 但是成本低。<br><strong>MLC闪存</strong>: 速度一般 寿命一般 3千到1万次擦写寿命 稳定性适中 成本适中。<br><strong>SLC闪存</strong>: 速度快 寿命长 10万次擦写寿命 稳定性强 企业级闪存 但是成本非常高。</p><h5 id="网卡"><a href="#网卡" class="headerlink" title="网卡"></a>网卡</h5><p>使用千兆网卡，并使用多网卡做bond，数据链路层的负载均衡，提高网卡可用性和最大带宽。</p><h3 id="数据库优化"><a href="#数据库优化" class="headerlink" title="数据库优化"></a>数据库优化</h3><blockquote><p>数据库可以说是Web站点的最后一部分了，后端程序执行很可能很大一部分时间是等待数据库返回需要的数据，提高数据库的查询速度可以很明显的提升Web站点性能。</p></blockquote><h4 id="数据分区"><a href="#数据分区" class="headerlink" title="数据分区"></a>数据分区</h4><blockquote><p>当随着数据的增多 单台数据库实例已经无法承受站点日益增多的数据 就需要考虑对数据进行分区了。</p></blockquote><h5 id="垂直分区"><a href="#垂直分区" class="headerlink" title="垂直分区"></a>垂直分区</h5><p>如果数据库写操作频繁 从库则会将大量时间花在复制上 照成性能浪费。这时候就需要将写操作分散到不同的服务器上。最简单的就是将无关的库分散到不同的服务器上，然后不同的数据写入到不同的服务器上。为了方便日后数据库的垂直分区，设计数据库表结构的时候应该尽量减少外键约束和联合查询。</p><h5 id="水平分区"><a href="#水平分区" class="headerlink" title="水平分区"></a>水平分区</h5><p>当单表的数据了日益增多，也达到了写操作的极限，垂直分区就不适用了。这个时候就可以通过特定的算法将同一数据表的数据写入到不同的数据库中，这就是水平分区了。</p><p>比如说将id为奇数的数据放入数据库A，为偶数的放入数据库B。如果需要分散到更多的数据库中，可以对id进行取余计算。需要注意的是 程序也需要知道相应的算法而从正确的数据库取数据。</p><p>也可以使用分区反向代理，<code>Spock Proxy</code>可以帮助应用程序实现水平分区的访问调度，我们也不应该在程序中维护分区对应关系。</p><h4 id="集群和读写分离"><a href="#集群和读写分离" class="headerlink" title="集群和读写分离"></a>集群和读写分离</h4><h5 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h5><p>多台数据库之间数据同步，查询可以从多台服务器上进行 减少单台服务器的压力。</p><h5 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h5><p>使用数据库反向代理 比如<code>Mysql Proxy</code>对后端数据库进行读写分离和负载平衡。读写分离的原理是让主数据库处理事务性查询，让从库处理数据查询，通过主从复制的方式将主库的数据更新到从库。</p><h4 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h4><blockquote><p>对数据库软件的性能调优</p></blockquote><h5 id="选择合适的存储引擎"><a href="#选择合适的存储引擎" class="headerlink" title="选择合适的存储引擎"></a>选择合适的存储引擎</h5><p>对于MySQL数据库 常用的数据引擎有<code>MyISAM</code>和<code>InnoDB</code>，随着Innodb的不断更新改进，从<code>MySQL5.5</code>已经成为了默认存储引擎。</p><p><code>InnoDB</code>: 行级锁 共享表空间 支持事务和外键 写性能比较好 支持热备份。<br><code>MyISAM</code>: 表级锁 独立表空间 不支持事务和外键 读性能比较好 不支持热备份。</p><p>所以如果网站的写操作比较多适合选择<code>InnoDB</code>，读操作比较多的话适合选择<code>MyISAM</code>。</p><h5 id="Innodb缓存池大小"><a href="#Innodb缓存池大小" class="headerlink" title="Innodb缓存池大小"></a>Innodb缓存池大小</h5><p><code>InnoDB</code>会在内存中维护一个缓冲池，用于缓存数据和索引。当用户执行查询操作时 如果缓存池中有数据会直接返回结果，否则会从磁盘读取数据，然后放到缓冲池中。配置一个合理的缓存池大小 可以将尽量多的数据缓存到内存中。如果<code>MySQL</code>数据库独占单个服务器，可以将缓存池的大小配置为物理内存的80%。</p><h5 id="建立索引"><a href="#建立索引" class="headerlink" title="建立索引"></a>建立索引</h5><p>对经常作为查询条件的字段建立索引，这样查询的时候就不需要对表数据进行完整的扫描。但是索引有时候会比整体数据还要大。</p><h5 id="减少表锁定等待"><a href="#减少表锁定等待" class="headerlink" title="减少表锁定等待"></a>减少表锁定等待</h5><p><code>MyISAM</code>的<code>UPDATE</code>操作会排斥对当前表的所有其他操作，只有更新结束后才可以继续查询。<code>InnoDB</code>支持行级锁，在写操作比较多的情况下性能会好于<code>MyISAM</code>。</p><h5 id="使用查询缓存"><a href="#使用查询缓存" class="headerlink" title="使用查询缓存"></a>使用查询缓存</h5><p>将<code>select</code>查询的结果缓存在内存中 当下次遇到相同的<code>select</code>语句将直接。默认情况下 mysql是没有开启查询缓存的，修改配置文件<code>query_cache</code>项开启。</p><p>但是需要注意，如果对这个表的数据进行了插入或更改 <code>MySQL</code>将会清除这个表所有的缓存。在对表读写频繁的情况下 查询缓存可能会添乱。但是如果有大量的相同或相似的查询，而且很少修改表中的数据就非常适合了。</p><h5 id="缓存线程池"><a href="#缓存线程池" class="headerlink" title="缓存线程池"></a>缓存线程池</h5><p>在配置文件中配置<code>thread_cache_size</code>，让<code>MySQL</code>创建的线程可以被重复利用，减少线程的创建和销毁的开销。</p><h5 id="表结构设计和查询语句优化"><a href="#表结构设计和查询语句优化" class="headerlink" title="表结构设计和查询语句优化"></a>表结构设计和查询语句优化</h5><p>设计合理的表结构和编写高效的查询语句，将相关的数据尽量不要使用多表查询，联合查询等方式。</p><h5 id="使用NoSQL"><a href="#使用NoSQL" class="headerlink" title="使用NoSQL"></a>使用NoSQL</h5><p>放弃关系型数据库，根据项目选用更合适的非关系型数据库吧。。。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><ul><li><a href="/uploads/2018/web/q99o91nda8.png">PNG版脑图</a></li><li><a href="/uploads/2018/web/q99o91nda8.svg">SVG版脑图</a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;简介&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;根据《构建高性能Web站点(修订版)》一书 加上自己的一些经验和理解写出了这篇博客，并在附录中留下了自己画的脑图。强烈推荐对Web站点优化有兴趣的开发者、web运维、架构师等阅读这本书。书中几乎涵盖了Web站点性能优化的所有内容，包括数据的网络传输、服务器并发处理能力、动态网页缓存、动态网页静态化、应用层数据缓存、分布式缓存、Web服务器缓存、反向代理缓存、脚本解释速度、页面组件分离、浏览器本地缓存、浏览器并发请求、文件的分发、数据库I/O优化、数据库访问、数据库分布式设计、负载均衡、分布式文件系统、性能监控等。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Web优化" scheme="http://www.yunfwe.cn/categories/Web%E4%BC%98%E5%8C%96/"/>
    
    
      <category term="Web优化" scheme="http://www.yunfwe.cn/tags/Web%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>打造自己的ubuntu开发环境</title>
    <link href="http://www.yunfwe.cn/2018/02/10/2018/%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84ubuntu%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/"/>
    <id>http://www.yunfwe.cn/2018/02/10/2018/%E6%89%93%E9%80%A0%E8%87%AA%E5%B7%B1%E7%9A%84ubuntu%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83/</id>
    <published>2018-02-10T14:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.871Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>对于经常在Linux做开发的开发者 打造一款让自己用的舒服 赏心悦目的系统开发环境是非常重要的。看着精美的主题和系统 心情也会变得更好，心情好了，代码的质量也就更高了。linux好的桌面发行版有Archlinux啊 Ubuntu啊 还有国产良心Deepin啊之类的，Archlinux太需要折腾了，Deepin呢 已经帮用户做的太多了，安装完毕后总觉得很多自己用不到的软件，桌面自己可以折腾的地方也不多，于是就选择了Ubuntu。鉴于下一个Ubuntu的LTS版18.04还有两个多月才发布 遂使用Ubuntu 16.04来折腾。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>由于Windows系统的便利性还是比Ubuntu高的 还有很多Ubuntu无法代替的地方 所以就只好吧Ubuntu安装到虚拟机里了</p></blockquote><table><thead><tr><th>主机</th><th>内存</th><th>CPU</th><th>硬盘</th></tr></thead><tbody><tr><td>Windows 10 64位</td><td>8G DDR4</td><td>i7 6代</td><td>256G SSD</td></tr></tbody></table><table><thead><tr><th>虚拟机</th><th>内存</th><th>CPU</th><th>硬盘</th></tr></thead><tbody><tr><td>Ubuntu 16.04 64位</td><td>4G DDR4</td><td>i7 6代</td><td>40G SSD</td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="获取Ubuntu"><a href="#获取Ubuntu" class="headerlink" title="获取Ubuntu"></a><font color="#CDAA7D">获取Ubuntu</font></h3><blockquote><p>可以在ubuntu的官网获取 但是速度可能会比较慢。可以在国内的镜像站上免费下载ubuntu系统镜像</p></blockquote><p><strong>在阿里云镜像站获取最新版ubuntu 16.04的镜像</strong></p><p>ubuntu-16.04.3-desktop-amd64.iso <a href="https://mirrors.aliyun.com/ubuntu-releases/16.04.3/ubuntu-16.04.3-desktop-amd64.iso" target="_blank" rel="noopener">点此下载</a></p><h3 id="安装Ubuntu"><a href="#安装Ubuntu" class="headerlink" title="安装Ubuntu"></a><font color="#CDAA7D">安装Ubuntu</font></h3><p>可以选择在虚拟机或者物理机上安装Ubuntu</p><p><strong>在终端中更新升级软件</strong></p><blockquote><p>由于Ubuntu的官方镜像站有中国的服务器，中文版的也默认使用中国的服务器 所以就不更改镜像站了</p></blockquote><p><strong>执行以下命令</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br></pre></td></tr></table></figure></p><p>接下来就是开始美化主题了</p><h4 id="安装漂亮的主题"><a href="#安装漂亮的主题" class="headerlink" title="安装漂亮的主题"></a><font color="#DDA0DD">安装漂亮的主题</font></h4><blockquote><p>这里使用我比较喜欢的Numix主题</p></blockquote><p><strong>deb离线安装</strong></p><blockquote><p>由于安装Numix主题需要添加Numix的ppa源 官方源有时候并不稳定 因为也可以直接安装Numix的deb包。在ubuntu内用火狐浏览器打开此页面后下载，或者Windows上下载好后想办法传入到ubuntu中。<br>如果想使用官方ppa源安装可以跳过这一段。</p></blockquote><table><thead><tr><th>包名</th><th>下载地址</th></tr></thead><tbody><tr><td>numix-gtk-theme</td><td><a href="/uploads/2018/ubuntu/debs/numix-gtk-theme.deb">点此下载</a></td></tr><tr><td>numix-icon-theme-circle</td><td><a href="/uploads/2018/ubuntu/debs/numix-icon-theme-circle.deb">点此下载</a></td></tr></tbody></table><p>然后安装这两个包，如果没报错的话应该就安装成功了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dpkg -i numix-gtk-theme.deb</span><br><span class="line">dpkg -i numix-icon-theme-circle.deb</span><br></pre></td></tr></table></figure></p><p><strong>注意</strong>：直接安装deb包只在当前ubuntu版本上测试通过，其他版本不保证可以使用，最好还是使用官方ppa源的安装方式。</p><p><strong>使用Numix官方源安装</strong></p><blockquote><p>如果使用deb离线安装成功的话 这一步就不用继续了哦</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository ppa:numix/ppa</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install numix-gtk-theme numix-icon-theme-circle</span><br></pre></td></tr></table></figure><p><strong>还需要一款主题管理工具来更改主题</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install unity-tweak-tool</span><br></pre></td></tr></table></figure></p><p><strong>打开tweak工具 然后将主题、桌面壁纸等换成自己喜欢的吧</strong></p><p>是不是瞬间感觉用户体验上升了一个档次呢 逼格也更高了</p><h3 id="安装常用软件"><a href="#安装常用软件" class="headerlink" title="安装常用软件"></a><font color="#CDAA7D">安装常用软件</font></h3><h4 id="搜狗输入法"><a href="#搜狗输入法" class="headerlink" title="搜狗输入法"></a><font color="#DDA0DD">搜狗输入法</font></h4><p>Ubuntu内用火狐浏览器打开：<a href="https://pinyin.sogou.com/linux/" target="_blank" rel="noopener">https://pinyin.sogou.com/linux/</a> 点击立即下载64位。<br>下载好后打开文件所在目录，然后在此目录打开终端 输入以下命令开始安装。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -f ./sogoupinyin_2.2.0.0102_amd64.deb</span><br></pre></td></tr></table></figure></p><p>安装完后需要注销下重新登陆 然后打开浏览器 点击左上角小键盘的图标 切换到搜狗输入法。<br>试试看，是不是可以很舒服的输入中文了。使用<code>Shift</code>键切换中英输入哦。</p><h4 id="Chrome浏览器"><a href="#Chrome浏览器" class="headerlink" title="Chrome浏览器"></a><font color="#DDA0DD">Chrome浏览器</font></h4><blockquote><p>由于Windows下一直使用Chrome浏览器，所以对Chrome比较情有独钟。下载需要自备梯子哦。</p></blockquote><p>Chrome浏览器下载地址：<a href="https://www.google.cn/chrome/" target="_blank" rel="noopener">https://www.google.cn/chrome/</a></p><p>如果用Ubuntu中的火狐浏览器打开Chrome浏览器的主页，可以直接点击下载Chrome的图标。<br>Windows下的话 需要点击下载适用于其他平台的Chrome，下载后传到Ubuntu中。</p><p><strong>接下来安装deb包</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install -f ./google-chrome-stable_current_amd64.deb</span><br></pre></td></tr></table></figure></p><p>其他软件的安装方式都大同小异 可以在Ubuntu应用商店找到的就在应用商店安装，找不到的就去官方找有没有ppa源或者deb包。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><p><strong>漂亮的锁屏界面</strong><br><img src="/uploads/2018/ubuntu/lock.jpg" alt="配置"></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;对于经常在Linux做开发的开发者 打造一款让自己用的舒服 赏心悦目的系统开发环境是非常重要的。看着精美的主题和系统 心情也会变得更好，心情好了，代码的质量也就更高了。linux好的桌面发行版有Archlinux啊 Ubuntu啊 还有国产良心Deepin啊之类的，Archlinux太需要折腾了，Deepin呢 已经帮用户做的太多了，安装完毕后总觉得很多自己用不到的软件，桌面自己可以折腾的地方也不多，于是就选择了Ubuntu。鉴于下一个Ubuntu的LTS版18.04还有两个多月才发布 遂使用Ubuntu 16.04来折腾。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Ubuntu" scheme="http://www.yunfwe.cn/categories/Ubuntu/"/>
    
    
      <category term="Ubuntu" scheme="http://www.yunfwe.cn/tags/Ubuntu/"/>
    
  </entry>
  
  <entry>
    <title>Hadoop入门笔记</title>
    <link href="http://www.yunfwe.cn/2018/02/04/2018/Hadoop%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/"/>
    <id>http://www.yunfwe.cn/2018/02/04/2018/Hadoop%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/</id>
    <published>2018-02-04T06:05:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Hadoop是一个由Apache基金会所开发的分布式系统基础架构。<br>用户可以在不了解分布式底层细节的情况下，开发分布式程序。充分利用集群的威力进行高速运算和存储。<br>Hadoop实现了一个分布式文件系统，简称HDFS。HDFS有高容错性的特点，并且设计用来部署在低廉的硬件上；而且它提供高吞吐量来访问应用程序的数据，适合那些有着超大数据集的应用程序。<br>Hadoop的核心设计是：HDFS、YARN和MapReduce。HDFS为海量的数据提供了存储，YARN提供资源调度，而MapReduce则为海量的数据提供了计算.</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a><font color="#CDAA7D">系统环境</font></h3><blockquote><p>为了避免防火墙等影响 默认已经关闭iptables和selinux</p></blockquote><table><thead><tr><th>身份</th><th style="text-align:center">系统</th><th style="text-align:center">主机名</th><th style="text-align:right">IP</th></tr></thead><tbody><tr><td>Hadoop master</td><td style="text-align:center">ubuntu 16.04</td><td style="text-align:center">master</td><td style="text-align:right">10.0.0.3</td></tr><tr><td>Hadoop slave1</td><td style="text-align:center">ubuntu 16.04</td><td style="text-align:center">slave1</td><td style="text-align:right">10.0.0.4</td></tr><tr><td>Hadoop slave2</td><td style="text-align:center">ubuntu 16.04</td><td style="text-align:center">slave2</td><td style="text-align:right">10.0.0.5</td></tr><tr><td>Hadoop slave3</td><td style="text-align:center">ubuntu 16.04</td><td style="text-align:center">slave3</td><td style="text-align:right">10.0.0.6</td></tr></tbody></table><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a><font color="#CDAA7D">软件环境</font></h3><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>Hadoop</td><td style="text-align:center">2.7.5</td><td style="text-align:right"><a href="http://mirror.bit.edu.cn/apache/hadoop/common/hadoop-2.7.5/hadoop-2.7.5.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>jdk</td><td style="text-align:center">1.8.0_161</td><td style="text-align:right"><a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="安装Hadoop"><a href="#安装Hadoop" class="headerlink" title="安装Hadoop"></a><font color="#CDAA7D">安装Hadoop</font></h3><blockquote><p>下载的是官方编译好的二进制包 所以就不用再重新编译了。<br>注意：下面的操作需要在所有主机上进行 或者配置好一台后<code>rsync</code>同步到其他主机</p></blockquote><h4 id="下载和解压"><a href="#下载和解压" class="headerlink" title="下载和解压"></a><font color="#DDA0DD">下载和解压</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 软件包在windows上下载并上传到了Linux上 注意jdk下载需要先接受许可协议</span></span><br><span class="line">tar xf hadoop-2.7.5.tar.gz -C /usr/<span class="built_in">local</span>/</span><br><span class="line">mv /usr/<span class="built_in">local</span>/&#123;hadoop-2.7.5,hadoop&#125;</span><br><span class="line">tar xf jdk-8u161-linux-x64.tar.gz -C /usr/<span class="built_in">local</span>/</span><br></pre></td></tr></table></figure><h4 id="配置集群环境"><a href="#配置集群环境" class="headerlink" title="配置集群环境"></a><font color="#DDA0DD">配置集群环境</font></h4><blockquote><p>集群环境为启动和使用Hadoop集群所需要的配置</p></blockquote><h5 id="配置jdk环境变量"><a href="#配置jdk环境变量" class="headerlink" title="配置jdk环境变量"></a>配置jdk环境变量</h5><blockquote><p>将以下内容写入到 <code>/etc/profile.d/jdk.sh</code></p></blockquote><pre><code>export JAVA_HOME=/usr/local/jdk1.8.0_161export PATH=$JAVA_HOME/bin:$PATH export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</code></pre><blockquote><p>修改 <code>/usr/local/hadoop/etc/hadoop/hadoop-env.sh</code></p></blockquote><pre><code>找到   export JAVA_HOME=${JAVA_HOME}修改为 export JAVA_HOME=/usr/local/jdk1.8.0_161</code></pre><h5 id="配置hadoop环境变量"><a href="#配置hadoop环境变量" class="headerlink" title="配置hadoop环境变量"></a>配置hadoop环境变量</h5><blockquote><p>将以下内容写入到 <code>/etc/profile.d/hadoop.sh</code></p></blockquote><pre><code>export HADOOP_HOME=/usr/local/hadoopexport PATH=$HADOOP_HOME/bin:$HADOOP_HOME/sbin:$PATH</code></pre><h5 id="使环境变量立即生效"><a href="#使环境变量立即生效" class="headerlink" title="使环境变量立即生效"></a>使环境变量立即生效</h5><blockquote><p>运行命令：</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h5 id="配置主机名解析"><a href="#配置主机名解析" class="headerlink" title="配置主机名解析"></a>配置主机名解析</h5><blockquote><p>将以下内容写入到<code>/etc/hosts</code></p></blockquote><pre><code>10.0.0.3    master10.0.0.4    slave110.0.0.5    slave210.0.0.6    slave3</code></pre><p>Windows上也顺便更改下hosts文件 以便于后面的访问集群<br>hosts文件位置：<code>C:\Windows\System32\drivers\etc\hosts</code><br>因为系统目录权限问题 可以将hosts文件拖到桌面修改后再拖回去覆盖了原文件即可</p><hr><h3 id="认识HDFS"><a href="#认识HDFS" class="headerlink" title="认识HDFS"></a><font color="#CDAA7D">认识HDFS</font></h3><blockquote><p>HDFS的全称是 “Hadoop分布式文件系统” ，可以简单理解为由用户进程模拟的一块大硬盘，为大数据处理提供了基础的数据存储服务，下面先看看HDFS是怎么一回事，再探究它到底是个什么东东。</p></blockquote><h4 id="启动HDFS"><a href="#启动HDFS" class="headerlink" title="启动HDFS"></a><font color="#DDA0DD">启动HDFS</font></h4><blockquote><p>Hadoop由三部分组成 HDFS则是其最基层的一部分。</p></blockquote><h5 id="配置文件语法"><a href="#配置文件语法" class="headerlink" title="配置文件语法"></a>配置文件语法</h5><blockquote><p>Hadoop的配置文件在<code>/usr/local/hadoop/etc/hadoop/</code>中，配置文件使用xml语法</p></blockquote><pre><code>&lt;property&gt;                   &lt;!-- 属性 --&gt;    &lt;name&gt;&lt;/name&gt;            &lt;!-- 名称 --&gt;    &lt;value&gt;&lt;/value&gt;          &lt;!-- 值 --&gt;&lt;/property&gt;                  </code></pre><p>配置项需要写在配置文件的<code>&lt;configuration&gt;&lt;/configuration&gt;</code>代码块中</p><h5 id="配置文件简单介绍"><a href="#配置文件简单介绍" class="headerlink" title="配置文件简单介绍"></a>配置文件简单介绍</h5><blockquote><p>Hadoop可能需要经常改动的配置文件有四个，下面简单说说这四个都是干嘛用的，具体用到的配置文件，后面会详细说明。</p></blockquote><table><thead><tr><th>配置文件</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>core-site.xml</td><td style="text-align:left">Hadoop Core的配置项</td></tr><tr><td>hdfs-site.xml</td><td style="text-align:left">HDFS的配置项 比如配置HDFS数据存储位置等</td></tr><tr><td>yarn-site.xml</td><td style="text-align:left">yarn资源调度器的配置 比如yarn监听的地址等</td></tr><tr><td>mapred-site.xml</td><td style="text-align:left">MapReduce计算引擎的相关配置</td></tr></tbody></table><h5 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h5><blockquote><p>HDFS的配置文件为<code>hdfs-site.xml</code> 打开发现<code>&lt;configuration&gt;&lt;/configuration&gt;</code>中是空的。其实Hadoop已经为HDFS的各种参数配置了默认值，用户重写进配置文件的值会覆盖掉Hadoop默认的。启动HDFS集群需要让各slave节点知道要连接谁，而这个配置是在<code>core-site.xml</code>中。</p></blockquote><blockquote><p>将所有节点的 <code>core-site.xml</code> 修改为如下内容</p></blockquote><pre><code>&lt;configuration&gt;    &lt;property&gt;        &lt;name&gt;fs.defaultFS&lt;/name&gt;        &lt;value&gt;hdfs://master:9000&lt;/value&gt;    &lt;/property&gt;&lt;/configuration&gt;</code></pre><p>配置hdfs的slave都连接master的9000端口</p><h5 id="启动HDFS集群"><a href="#启动HDFS集群" class="headerlink" title="启动HDFS集群"></a>启动HDFS集群</h5><blockquote><p>HDFS集群分为 <strong>NameNode</strong> 和 <strong>DataNode</strong> ，其中NameNode为master节点 DataNode为slave节点<br>NameNode的作用就像一本书的目录 记录每一个文件存放在哪个slave节点上。而DataNode则是存放数据用的了。</p></blockquote><p>启动前需要先对namenode进行目录格式化<br>在master节点上执行NameNode格式化命令和启动的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop namenode -format</span><br><span class="line">hadoop-daemon.sh start namenode</span><br></pre></td></tr></table></figure></p><p>在所有slave节点上执行启动DataNode的命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop-daemon.sh start datanode</span><br></pre></td></tr></table></figure></p><p>使用<code>jps</code>命令可以看到当前启动的java进程，可以看到master节点跑着的是NameNode进程，而slave节点跑着的是DataNode进程</p><h5 id="验证是否启动成功"><a href="#验证是否启动成功" class="headerlink" title="验证是否启动成功"></a>验证是否启动成功</h5><blockquote><p>HDFS启动成功后 master会监听9000端口，并且还会监听50070端口，这个端口是HDFS的web管理界面。</p></blockquote><p>可以使用命令的方式查看集群各节点的运行状况<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs dfsadmin -report</span><br></pre></td></tr></table></figure></p><p>也可以在web界面上直观的看到HDFS集群的状况<br>浏览器访问：<a href="http://master:50070" target="_blank" rel="noopener">http://master:50070</a> 然后点击 Datanodes 可以看到三个slave正常在线<br><img src="/uploads/2018/hadoop/hadoop-hdfs-web.png" alt="DataNodes"></p><p>如果还想继续增加slave节点 只需要更改了slave节点的配置文件后启动就可以了。<br>HDFS的总容量会随着节点的增多而增多 拓展性是不是非常好呢。但是随着节点的增加又一个问题出现了 现在slave节点拓展到一千多台了 我该怎么启动这个集群呢？</p><h4 id="集中式管理HDFS集群"><a href="#集中式管理HDFS集群" class="headerlink" title="集中式管理HDFS集群"></a><font color="#DDA0DD">集中式管理HDFS集群</font></h4><blockquote><p>Hadoop官方已经提供了一个批量启动和关闭HDFS集群的脚本了 而且以后用的更多的也是这些脚本。但是使用脚本之前 还需要做一些小配置。</p></blockquote><h5 id="配置ssh密钥认证"><a href="#配置ssh密钥认证" class="headerlink" title="配置ssh密钥认证"></a>配置ssh密钥认证</h5><blockquote><p>这一步配置master节点到其他slave节点的ssh密钥认证，其实就是master节点替你登陆到各slave节点启动DateNode了</p></blockquote><p>此步骤只在master上进行</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen</span><br><span class="line">ssh-copy-id root@master     # 没错 自己也要免密码登陆自己</span><br><span class="line">ssh-copy-id root@slave1</span><br><span class="line">ssh-copy-id root@slave2</span><br><span class="line">ssh-copy-id root@slave3</span><br></pre></td></tr></table></figure><p>配置完成后可以ssh验证在master上是否可以免密码登陆所有slave节点了</p><h5 id="配置slave节点"><a href="#配置slave节点" class="headerlink" title="配置slave节点"></a>配置slave节点</h5><blockquote><p>只有告诉了master有哪些slave节点 master才会帮助你启动或停止它们<br>修改 <code>/usr/local/hadoop/etc/hadoop/slaves</code> 如下</p></blockquote><pre><code>slave1slave2slave3</code></pre><p>如果有localhost这条记录需要删掉 这样master节点就不会也被当作slave节点了</p><h5 id="停止HDFS集群"><a href="#停止HDFS集群" class="headerlink" title="停止HDFS集群"></a>停止HDFS集群</h5><blockquote><p>因为HDFS集群已经是启动状态了 那就先试试停止它们吧</p></blockquote><p>在master上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop-dfs.sh</span><br></pre></td></tr></table></figure></p><p>再在各节点执行<code>jps</code>命令看看是不是NameNode和DataNode已经停止了呢</p><h5 id="启动HDFS集群-1"><a href="#启动HDFS集群-1" class="headerlink" title="启动HDFS集群"></a>启动HDFS集群</h5><blockquote><p>停止使用的是<code>stop-dfs.sh</code>命令 那启动就肯定是<code>start-dfs.sh</code>喽</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start-dfs.sh</span><br></pre></td></tr></table></figure><p>再用<code>jps</code>命令看看 是不是所有节点各自的服务都启动了呢<br>但是master上的进程好像不太一样 多了一个<strong>SecondaryNameNode</strong>，那么这个进程是做什么的呢</p><p>这个进程是帮助NameNode更好的工作 解决NameNode运行中可能出现的一些问题的 这也是NameNode容错的一种机制，具体作用可以查阅官方文档或搜索引擎。</p><p>接下来 就该看看这个HDFS该怎么用了吧 既然是一种分布式文件系统 那么它体现在哪里呢？</p><h4 id="HDFS的文件操作"><a href="#HDFS的文件操作" class="headerlink" title="HDFS的文件操作"></a><font color="#DDA0DD">HDFS的文件操作</font></h4><blockquote><p>先简单介绍下HDFS文件的存储方式。将文件上传到HDFS中后 HDFS会将文件按照128M为一块进行分块存储。每一块又默认会复制三次 然后存放在三个不同的节点上。这样如果有某台机器宕机了 就还可以从其他节点拿到这一块文件，所以提供了文件冗余机制，并且HDFS还会将宕机节点丢失的块再复制一份到其他节点 保证每一块都存在三份。 </p></blockquote><blockquote><p>HDFS的特性：文件分块 文件冗余 容易拓展</p></blockquote><h5 id="命令行管理HDFS中的文件"><a href="#命令行管理HDFS中的文件" class="headerlink" title="命令行管理HDFS中的文件"></a>命令行管理HDFS中的文件</h5><blockquote><p>通过java程序或者其他语言的HDFS库就可以操作HDFS中的文件了。在Linux上也提供了一些命令去操作HDFS</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -ls /                 # 查看HDFS集群根目录的文件 应该是空的</span><br><span class="line">hadoop fs -mkdir /hadoop        # 创建/hadoop目录</span><br><span class="line">hadoop fs -put /tmp/hadoop-2.7.5.tar.gz /hadoop     # 将这个文件上传到/hadoop目录中</span><br><span class="line">hadoop fs -ls /hadoop           # 这个时候应该可以看到上传的文件了</span><br><span class="line">hadoop fs -put /etc/profile.d/jdk.sh /      # 将jdk.sh 上传到根目录</span><br><span class="line">hadoop fs -cat /jdk.sh          # 有没有发现这些命令和Linux的命令都差不多呢</span><br><span class="line">hadoop fs -rm /jdk.sh           # 把jdk.sh删除</span><br><span class="line">hadoop fs -rm -r -f /hadoop     # 和rm命令一样 也是可以带-r -f 参数的哦</span><br><span class="line">hadoop fs -put /tmp/jdk-8u161-linux-x64.tar.gz /    # 把jdk上传上去 以便下面的测试</span><br><span class="line">hadoop fs -get /jdk-8u161-linux-x64.tar.gz /root/   # 把文件下载到root的家目录</span><br><span class="line">hadoop fs -help                 # 查看所有支持的操作</span><br></pre></td></tr></table></figure><p>HDFS是不允许对文件进行更改的 所以如果非要修改 只能把文件下载下来修改后再上传</p><h5 id="Web界面浏览HDFS中的文件"><a href="#Web界面浏览HDFS中的文件" class="headerlink" title="Web界面浏览HDFS中的文件"></a>Web界面浏览HDFS中的文件</h5><blockquote><p>为什么说是浏览呢 因为Web界面内是没法对文件进行操作的 只能看</p></blockquote><p>浏览器打开：<a href="http://master:50070" target="_blank" rel="noopener">http://master:50070</a>  首页的Summary中可以看到集群的状态<br><img src="/uploads/2018/hadoop/15z6669dvywjo9yc.png" alt></p><p>因为HDFS会把一个文件分块后复制三份存放在不同的节点上 jdk的大小是180多M 三倍大小差不多就是547M了</p><p>点击 <code>Utilities</code> 中的 <code>Browse the file system</code> 就可以看到集群中的文件了<br><img src="/uploads/2018/hadoop/jwo4hm29oz1wdwk9.png" alt></p><p>点击文件名称 可以查看文件的更多信息。<br>HDFS的块大小为<code>128M</code>, jdk文件自然被分成了两块 每一块都存放在了三个节点上<br><img src="/uploads/2018/hadoop/k2j9i422h2wl1kb1.png" alt></p><h4 id="HDFS的配置"><a href="#HDFS的配置" class="headerlink" title="HDFS的配置"></a><font color="#DDA0DD">HDFS的配置</font></h4><blockquote><p>默认HDFS会将文件复制三份 但是你觉得数据并不是那么重要 复制两份就满足数据冗余的需求了，那么如何更改这个配置呢</p></blockquote><h5 id="查阅官方文档"><a href="#查阅官方文档" class="headerlink" title="查阅官方文档"></a>查阅官方文档</h5><blockquote><p><strong>学习一个技术最好的方法就是查阅它的官方文档，官方文档永远是第一手资料。</strong></p></blockquote><p>打开Hadoop的官方首页：<a href="http://hadoop.apache.org/" target="_blank" rel="noopener">http://hadoop.apache.org/</a><br>然后左侧栏点开 <code>Documentation</code> 找到自己的版本：<a href="http://hadoop.apache.org/docs/r2.7.5/" target="_blank" rel="noopener">http://hadoop.apache.org/docs/r2.7.5/</a><br>左侧栏的最下方有个<code>Configuration</code> 既然是对HDFS进行配置 那肯定是看 <code>hdfs-default.xml</code> 的了<br>点开后可以看到茫茫多的配置 这些配置都是HDFS的默认配置 只用修改相应的值就可以了。既然是复制 那就看看和复制有关的配置，在网页中搜索 <code>&quot;replication&quot;</code><br><img src="/uploads/2018/hadoop/pyxapbq5mtj5ebvn.gif" alt></p><p><code>dfs.replication</code> 就是我们要更改的目标了</p><h5 id="修改-hdfs-site-xm"><a href="#修改-hdfs-site-xm" class="headerlink" title="修改 hdfs-site.xm"></a>修改 hdfs-site.xm</h5><blockquote><p>只需要修改master节点的 <code>hdfs-site.xml</code> 就可以了</p></blockquote><p><strong>修改为如下：</strong></p><pre><code>&lt;configuration&gt;    &lt;property&gt;        &lt;name&gt;dfs.replication&lt;/name&gt;        &lt;value&gt;2&lt;/value&gt;    &lt;/property&gt;&lt;/configuration&gt;</code></pre><p><strong>保存退出后重启集群</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">stop-dfs.sh</span><br><span class="line">start-dfs.sh</span><br></pre></td></tr></table></figure></p><p><strong>接下来再测试下是否文件只复制2份了 上传一个新文件到HDFS中</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -put /tmp/hadoop-2.7.5.tar.gz /</span><br></pre></td></tr></table></figure></p><p><strong>浏览器查看文件信息</strong><br><img src="/uploads/2018/hadoop/zulqztd3fgq6oo57.gif" alt></p><p>可以看到 <code>hadoop-2.7.5.tar.gz</code> 只被复制了2份，并且文件的每一份都尽量平均的分散在集群的不同slave中。block0存放在slave2和slave3上，block1存放在slave1和slave3上，那么如果slave1宕机了 HDFS会做哪些操作呢</p><h5 id="slave1宕机模拟"><a href="#slave1宕机模拟" class="headerlink" title="slave1宕机模拟"></a>slave1宕机模拟</h5><blockquote><p>只要slave1和master不能正常通信就可以了，可以停掉slave1的datanode服务 或者开启slave1的防火墙阻止通信都可以。<br>master会定期检测slave的状况 只有发现slave挂了后才会将缺少的文件再复制一份到其他节点。这个默认周期是<code>300000</code>毫秒 也就是5分钟。<br>如果不想等待这么长时间 可以修改<code>hdfs-site.xml</code>，配置 <code>dfs.namenode.heartbeat.recheck-interval</code> 的值为<code>10000</code> 也就是10秒</p></blockquote><p><strong>在slave1上运行：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop-daemon.sh stop datanode</span><br></pre></td></tr></table></figure></p><p><strong>过一阵子刷新浏览器 可以看到slave1已经离线了，并且又在slave2上复制了一份</strong><br><img src="/uploads/2018/hadoop/emi5vmt122aa767a.gif" alt></p><p><strong>测试完后记得重新启动 slave1</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop-daemon.sh start datanode</span><br></pre></td></tr></table></figure></p><p>刷新浏览器可以看到 slave1又上线了</p><h5 id="修改数据存储路径"><a href="#修改数据存储路径" class="headerlink" title="修改数据存储路径"></a>修改数据存储路径</h5><blockquote><p>HDFS文件的数据块最终还是要真实存在硬盘上的，HDFS的默认数据存放路径为<code>/tmp/</code>下 这显然不是一个好主意</p></blockquote><p>NameNode的数据存储位置定义在 <code>dfs.namenode.name.dir</code> 默认值为 <code>file://${hadoop.tmp.dir}/dfs/name</code><br>DataNode的数据存储位置定义在 <code>dfs.datanode.data.dir</code> 默认值为 <code>file://${hadoop.tmp.dir}/dfs/data</code></p><p>我们将数据目录修改到 /data/dfs 下<br><strong>master节点配置如下：</strong></p><pre><code>&lt;property&gt;    &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;    &lt;value&gt;file:///data/dfs/name&lt;/value&gt;&lt;/property&gt;</code></pre><p><strong>slave节点全部配置如下：</strong></p><pre><code>&lt;property&gt;    &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;    &lt;value&gt;file:///data/dfs/data&lt;/value&gt;&lt;/property&gt;</code></pre><p><strong>以下操作在master上进行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop-dfs.sh                     # 停止集群</span><br><span class="line">mkdir -p /data/dfs/name         # 创建相应目录</span><br><span class="line">hadoop namenode -format         # 重新格式化</span><br></pre></td></tr></table></figure></p><p><strong>接下来在slave节点上创建目录</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /data/dfs/data</span><br></pre></td></tr></table></figure></p><p><strong>然后master上重新启动HDFS集群吧</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start-dfs.sh</span><br></pre></td></tr></table></figure></p><p>HDFS的内容就先到这里吧 更多的配置项在以后用到的时候慢慢学习和了解 遇到不懂得地方记得查阅官方文档哦</p><hr><h3 id="YARN资源调度器"><a href="#YARN资源调度器" class="headerlink" title="YARN资源调度器"></a><font color="#CDAA7D">YARN资源调度器</font></h3><blockquote><p>YARN是开源项目Hadoop的一个资源管理系统，最初设计是为了解决Hadoop中MapReduce计算模型中的资源管理问题，但是现在它已经是一个更加通用的资源管理系统，可以把MapReduce计算模型作为一个应用程序运行在YARN系统之上，通过YARN来管理资源。如果你的应用程序也需要借助YARN的资源管理功能，你也可以实现YARN提供的编程API，将你的应用程序运行于YARN之上，将资源的分配与回收统一交给YARN去管理，可以大大简化资源管理功能的开发。当前，也有很多应用程序已经可以构建于YARN之上，如Storm、Spark等计算模型。</p></blockquote><h4 id="YARN的基本概念"><a href="#YARN的基本概念" class="headerlink" title="YARN的基本概念"></a><font color="#DDA0DD">YARN的基本概念</font></h4><blockquote><p>有了HDFS的基本概念 理解YARN也比较简单了 HDFS是将文件分布式存储在不同的slave节点上，而YARN是将任务拆分到不同的计算节点上。</p></blockquote><p>Hadoop第一代中是没有YARN的概念的，Hadoop第二代开始专门将资源调度抽取出来了 所以才有了YARN。Hadoop第一代中 只有HDFS和一个MapReduce计算模型。但是MapReduce发展中发现了一些局限性，比如不支持内存模型、流式模型等计算模型。在Hadoop第二代的时候对这个问题进行了改进 在HDFS之上抽象出了一个资源调度模型，这个资源调度模型就是YARN（Yet Another Resource Negotiator）。</p><p>YARN对集群的内存、CPU资源进行调度，将计算任务按照算法分发到集群节点。有了这个抽象层 就可以在之上能跑的就不只有MapReduce了，还有各种各样的计算模型，比如Spark、Storm等。YARN只做调度 不参与计算。</p><p>YARN的master上运行<strong>ResourceManager</strong>，slave上运行<strong>NodeManage</strong>r。YARN和HDFS是低耦合的，可以部署在一个集群中 也可以分开部署在两个集群中。把NodeManager和DataNode部署在同一个节点上，可以使NodeManager读取HDFS的效率更高 所以一般都将NodeManager和DataNode部署在一起。<br>而ResourceManager和NameNode都比较吃内存，所以最好分开部署。实验中将ResourceManager和NameNode部署到了一起。</p><p>用户编写好计算的任务程序 然后去请求ResourceManager，ResourceManager将用户的任务拆分，然后分发到NodeManager节点进行计算，计算节点再从HDFS中获取数据。下面就看看YARN如何配置和启动。</p><h4 id="配置YARN集群"><a href="#配置YARN集群" class="headerlink" title="配置YARN集群"></a><font color="#DDA0DD">配置YARN集群</font></h4><h5 id="修改YARN的配置文件"><a href="#修改YARN的配置文件" class="headerlink" title="修改YARN的配置文件"></a>修改YARN的配置文件</h5><p><strong>修改所有节点的<code>yarn-site.xml</code>文件</strong></p><pre><code>&lt;configuration&gt;    &lt;property&gt;        &lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;        &lt;value&gt;master&lt;/value&gt;    &lt;/property&gt;    &lt;property&gt;          &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;          &lt;value&gt;mapreduce_shuffle&lt;/value&gt;      &lt;/property&gt;      &lt;property&gt;        &lt;name&gt;yarn.nodemanager.auxservices.mapreduce.shuffle.class&lt;/name&gt;        &lt;value&gt;org.apache.hadoop.mapred.ShuffleHandler&lt;/value&gt;    &lt;/property&gt;&lt;/configuration&gt;</code></pre><p><code>yarn.resourcemanager.hostname</code> 指明ResourceManager在master上 只修改这一个 YARN集群就可以起来了。下面两个配置是NodeManager上运行的附属服务。需配置成<code>mapreduce_shuffle</code>，才可运行MapReduce程序。</p><h4 id="启动YARN集群"><a href="#启动YARN集群" class="headerlink" title="启动YARN集群"></a><font color="#DDA0DD">启动YARN集群</font></h4><blockquote><p>YARN的启动和HDFS的启动类似 可以单个启动 也可以集群化方式启动</p></blockquote><h5 id="单独启动YARN节点"><a href="#单独启动YARN节点" class="headerlink" title="单独启动YARN节点"></a>单独启动YARN节点</h5><p><strong>master节点上执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn-daemon.sh start resourcemanager        # 启动ResourceManager</span><br><span class="line">yarn-daemon.sh stop resourcemanager         # 停止ResourceManager</span><br></pre></td></tr></table></figure></p><p><strong>slave节点上执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn-daemon.sh start nodemanager            # 启动NodeManager</span><br><span class="line">yarn-daemon.sh stop nodemanager             # 停止NodeManager</span><br></pre></td></tr></table></figure></p><h5 id="集群化启动"><a href="#集群化启动" class="headerlink" title="集群化启动"></a>集群化启动</h5><p><strong>master节点上执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start-yarn.sh           # 启动整个YARN集群</span><br><span class="line">stop-yarn.sh            # 停止整个YARN集群</span><br></pre></td></tr></table></figure></p><h5 id="Web界面查看集群状态"><a href="#Web界面查看集群状态" class="headerlink" title="Web界面查看集群状态"></a>Web界面查看集群状态</h5><blockquote><p>ResourceManager启动后 会在8088端口提供一个web界面，通过这个web界面可以看到节点状态，任务运行状态等</p></blockquote><p><strong>浏览器访问：<a href="http://master:8088/" target="_blank" rel="noopener">http://master:8088/</a></strong><br><img src="/uploads/2018/hadoop/3iw3bxd3g9uclati.gif" alt></p><p>YARN起来后怎么测试效果呢 那就跑个MapReduce计算看看吧</p><hr><h3 id="MapReduce计算模型"><a href="#MapReduce计算模型" class="headerlink" title="MapReduce计算模型"></a><font color="#CDAA7D">MapReduce计算模型</font></h3><blockquote><p>MapReduce最早是由Google公司研究提出的一种面向大规模数据处理的并行计算模型和方法。<br>Hadoop的设计思想也来源自Google的几篇论文，MapReduce的论文里提到 MapReduce的灵感来自于函数式语言Lisp中的内置函数map和reduce。<br>对于熟悉Python语言的人 应该都知道Python的两个内置函数 <code>map</code> 和 <code>reduce</code>，如果对着两个函数的运用也比较熟练的话，MapReduce计算模型也很容易理解了。<br>下面就来看看利用MapReduce思想 是怎么解决数据处理中的问题的</p></blockquote><h4 id="第一个MapReduce程序"><a href="#第一个MapReduce程序" class="headerlink" title="第一个MapReduce程序"></a><font color="#DDA0DD">第一个MapReduce程序</font></h4><blockquote><p>一个很简单的例子 统计一个文本文件中每个单词出现的次数。首先 先配置好MapReduce吧</p></blockquote><h5 id="修改配置文件-1"><a href="#修改配置文件-1" class="headerlink" title="修改配置文件"></a>修改配置文件</h5><blockquote><p><code>mapred-site.xml</code>是MapReduce计算模型的配置文件。<br>MapReduce和YARN也是低耦合的，跑MapReduce计算并不一定需要YARN，当然YARN上面并不只能跑MapReduce。<br>这里就使用YARN来调度MapReduce使用的计算资源。</p></blockquote><p><strong>修改master节点的<code>mapred-site.xml</code>文件</strong></p><p><code>mapred-site.xml</code>文件不存在 所以需要先复制一份<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp /usr/local/hadoop/etc/hadoop/&#123;mapred-site.xml.template,mapred-site.xml&#125;</span><br><span class="line">vim /usr/local/hadoop/etc/hadoop/mapred-site.xml</span><br></pre></td></tr></table></figure></p><pre><code>&lt;configuration&gt;    &lt;property&gt;        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;        &lt;value&gt;yarn&lt;/value&gt;    &lt;/property&gt;&lt;/configuration&gt;</code></pre><p><code>mapreduce.framework.name</code> 指定了MapReduce在YARN这个框架上跑，如果不配置就默认在本地单机上跑。</p><h5 id="运行wordcount任务"><a href="#运行wordcount任务" class="headerlink" title="运行wordcount任务"></a>运行wordcount任务</h5><blockquote><p><code>/usr/local/hadoop/share/hadoop/mapreduce</code> 中有一个 <code>hadoop-mapreduce-examples-2.7.5.jar</code><br>里面包含了一些官方给出里例子 <code>wordcount</code>就是其中的一个</p></blockquote><p><strong>创建测试文本</strong></p><p>新建一个文件tmp.txt 然后写入以下内容：</p><pre><code>hello worldhello pythonhello javahello javahi pythonhi chi c++hi luahello lua</code></pre><p>为了效果明显点 可以将这些内容多次写入到<code>test.txt</code>文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">while :; do cat tmp.txt &gt;&gt; test.txt ; done</span><br></pre></td></tr></table></figure></p><p>这里已经获得了一个30M大小的文件了</p><pre><code>root@slave1:~# ls -lh test.txt -rw-r--r-- 1 root root 30M Feb  8 08:34 test.txt</code></pre><p><strong>上传到HDFS中</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -put test.txt /</span><br></pre></td></tr></table></figure></p><p><strong>开始测试吧！</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/share/hadoop/mapreduce</span><br><span class="line">hadoop jar hadoop-mapreduce-examples-2.7.5.jar wordcount /test.txt /testout</span><br></pre></td></tr></table></figure></p><p>简单讲解下这条命令的意思 <code>-jar</code> 是运行这个jar包，<code>wordcount</code>是运行jar包中 <code>wordcount</code>这个类 <code>/test.txt</code> 是输入文件 <code>/testout</code> 是输出目录，一定要注意 <code>/testout</code> 一定要不存在才行。</p><p>现在可以看到命令的输出<br><img src="/uploads/2018/hadoop/jrl4571tfnli6bv0.gif" alt></p><p>Web界面也可以看到任务的运行状态<br><img src="/uploads/2018/hadoop/6erbt051l1knel3e.gif" alt></p><p>点击任务的ID 就可以看到这个任务是跑在了哪些节点上哦。因为30M对于Hadoop来说简直太小了 所以只分配了两个节点就够了。这个任务中 可以看到两个Maps进程都跑在slave1上 一个Reduces进程跑在slave3上</p><p>PS: 任务可以在任何节点跑 但是想要使用YARN进行资源调度的话 也需要修改相应节点的<code>mapred-site.xml</code>文件，否则就成了本地单机版的MapReduce了。<br>ResourceManager节点重启后 所有的任务记录也都会丢失哦。</p><h5 id="查看任务结果"><a href="#查看任务结果" class="headerlink" title="查看任务结果"></a>查看任务结果</h5><blockquote><p>还记得输出目录 /testout 吗 结果就在那里</p></blockquote><p>先看一看/testout下有什么吧</p><pre><code>root@master:~# hadoop fs -ls /testoutFound 2 items-rw-r--r--   2 root supergroup          0 2018-02-08 08:53 /testout/_SUCCESS-rw-r--r--   2 root supergroup         95 2018-02-08 08:53 /testout/part-r-00000</code></pre><p>_SUCCESS是表示这个任务执行成功<br>part-r-00000 就是结果了 如果是个结果集的话 还会有<code>part-r-00001</code>、<code>part-r-00002</code> …<br>那就看看这个文件的内容吧</p><pre><code>root@master:~# hadoop fs -cat /testout/part-r-00000c        360944c++        360944hello    1804720hi        1443776java    721888lua        721888python    721888world    360944</code></pre><p>可以看到每一个单词出现的次数都被统计出来了，那么它是怎么实现的呢？</p><h4 id="MapReduce的运行原理"><a href="#MapReduce的运行原理" class="headerlink" title="MapReduce的运行原理"></a><font color="#DDA0DD">MapReduce的运行原理</font></h4><blockquote><p>MapReduce的内部工作方式是怎样的呢？它是怎么解决单词统计这个任务的呢？</p></blockquote><h5 id="Map-和-Reduce"><a href="#Map-和-Reduce" class="headerlink" title="Map 和 Reduce"></a>Map 和 Reduce</h5><p>举个简单的例子：<br>顾客想知道他经常去的图书馆里有多少本书，于是找到了老板。<br>“Hi! 老板 我想知道你的图书馆里有多少本书”<br>“好嘞 我让手下去数一数”<br>一共有二十个书架 领导分配了十个人去数，第一个人数1,2书架，第二个人数3,4书架以此类推<br>等数完后将结果交给另外一个人去汇总 把每个书架的结果累加起来<br>汇总完后 将结果给了老板后 老板告诉顾客有多少本书</p><p>这个例子中 顾客 就是开发者<br>老板呢 就像是YARN进行工作调度<br>所有的书就像是HDFS中存储的数据<br>工人的工作就是所谓的Map了 而汇总统计的那个人做的工作 就是Reduce<br>Map呢 就是将数据整理 归类 将复杂的数据变得简单有结构<br>Reduce呢 就是拿到同类的数据后进行处理 计算</p><p>再讲一个做水果沙拉的例子：<br>一堆不同种类的水果 要做成水果沙拉<br>挑出一个 是香蕉 好 切成块<br>挑出一个 是苹果 好 切成块<br>挑出一个 是梨 好 切成块<br>挑完也切完了 好 混在一起做成水果沙拉<br>挑和切的动作 就可以看作Map，最后将所有的水果块做成水果沙拉 就可以看作是Reduce的过程了</p><p>Map和Reduce 只是一种思想 并不局限于一种固定的解决问题的模式 如何玩转这种思想 得到自己想要的结果 就是一门艺术了。这就是我所理解的MapReduce。</p><h5 id="wordcount程序的实现"><a href="#wordcount程序的实现" class="headerlink" title="wordcount程序的实现"></a>wordcount程序的实现</h5><blockquote><p>回到正题 看看这个自带的wordcount程序的实现是怎么样的呢</p></blockquote><pre><code>1. 输入（input） 将文档输入到Map进程hello worldhello pythonhello javahello java2. 拆分（split） 将每一行都转为key-value形式0 - hello world1 - hello python2 - hello java3 - hello java3. 映射（map）将每一行的每一个单词都形成一个新的key-value对hello 1world 1hello 1python 1hello 1java 1hello 1java 14. 派发（shuffle）将key相同的扔到一起去hello 1 1 1 1world 1python 1java 1 15. 缩减（reduce）将同一个key的结果相加起来hello 4world 1python 1java 26. 输出（output）将缩减之后的结果输出</code></pre><h4 id="自己写一个MapReduce程序"><a href="#自己写一个MapReduce程序" class="headerlink" title="自己写一个MapReduce程序"></a><font color="#DDA0DD">自己写一个MapReduce程序</font></h4><blockquote><p>Map和Reduce的过程 是可以用户自定义的 那我们就自己实现一个统计字数的程序仍到Hadoop上跑吧<br>不会写java不怕 <code>hadoop-streaming-2.7.5.jar</code> 这个包 提供了使用其他语言来写MapReduce程序的方法，这里用Python来实现。</p></blockquote><h5 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h5><blockquote><p>编写 mapper.py 文件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:</span><br><span class="line">    words = line.split()</span><br><span class="line">    <span class="keyword">for</span> w <span class="keyword">in</span> words:</span><br><span class="line">        print(w+<span class="string">' '</span>+<span class="string">'1'</span>)</span><br></pre></td></tr></table></figure><pre><code>1. 从标准输入获取数据 然后按行读取    hello world2. 然后使用空白字符分割为一个列表    [&quot;hello&quot;,&quot;world&quot;]3. 将列表中的每一个元素都转为key-value，并且写入到标准输出    hello 1    world 14. 继续从标准输入读取下一行 直到结束</code></pre><h5 id="Reduce"><a href="#Reduce" class="headerlink" title="Reduce"></a>Reduce</h5><blockquote><p>编写 reducer.py 文件</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">result = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> sys.stdin:</span><br><span class="line">key,value = line.split()</span><br><span class="line"><span class="keyword">if</span> key <span class="keyword">in</span> result:</span><br><span class="line">result[key] += int(value)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">result[key] = int(value)</span><br><span class="line"><span class="keyword">for</span> k,v <span class="keyword">in</span> result.items():</span><br><span class="line">print(k+<span class="string">'\t'</span>+str(v))</span><br></pre></td></tr></table></figure><pre><code>1. 创建一个保存结果的字典  result2. 从标准输入中读取一行    hello 13. 使用空白字符分割为一个列表 然后赋值给key和value    key = hello, value = 14. 如果key存在result中了 那么他的值就加上变量value的值   如果key不存在result中 那么创建这个key 并将变量value赋值给它   {&quot;hello&quot;: 1}5. 继续从标准输入读取下一行 直到结束6. 将结果格式化写入到标准输出</code></pre><h5 id="运行自己的MapReduce程序"><a href="#运行自己的MapReduce程序" class="headerlink" title="运行自己的MapReduce程序"></a>运行自己的MapReduce程序</h5><blockquote><p>需要将两个脚本拷贝到所有节点相同的目录哦 因为不知道哪个节点会被调度运算</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">chmod +x mapper.py reducer.py</span><br><span class="line">scp mapper.py reducer.py root@slave1:/tmp</span><br><span class="line">scp mapper.py reducer.py root@slave2:/tmp</span><br><span class="line">scp mapper.py reducer.py root@slave3:/tmp</span><br></pre></td></tr></table></figure><p><strong>使用 hadoop-streaming 跑起来吧！</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/hadoop/share/hadoop/tools/lib     # 这个jar包的路径</span><br><span class="line"># 注意：下面两行是一条命令</span><br><span class="line">hadoop jar hadoop-streaming-2.7.5.jar -input /test.txt \</span><br><span class="line">-output /pyout -mapper /tmp/mapper.py -reducer /tmp/reducer.py</span><br></pre></td></tr></table></figure></p><p>命令参数什么的就不用说了吧 使用也是非常简单<br>PS: 前期想测试下自己写的程序 可以使用管道模拟 比如 <code>cat test.txt | ./mapper.py | ./reducer.py</code></p><p>也可以试试Linux的命令作为 <code>mapper</code> 和 <code>reducer</code> 的处理程序哦 比如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop jar hadoop-streaming-2.7.5.jar -input /test.txt \</span><br><span class="line">-output /linuxout -mapper /usr/bin/sort -reducer /usr/bin/uniq</span><br></pre></td></tr></table></figure></p><p>跑完了 有没有很开心呢<br><img src="/uploads/2018/hadoop/7ti9iks51q2m0gx1.gif" alt></p><p>接下来该看看结果是否和自带的<code>wordcount</code>一样呢</p><pre><code>root@slave1:~# hadoop fs -ls /pyoutFound 2 items-rw-r--r--   2 root supergroup          0 2018-02-08 15:44 /pyout/_SUCCESS-rw-r--r--   2 root supergroup         95 2018-02-08 15:44 /pyout/part-00000root@slave1:~# hadoop fs -cat /pyout/part-00000hi        1443776c++        360944c        360944world    360944java    721888lua        721888python    721888hello    1804720</code></pre><p>wordcount果然是大数据的Hello World<br>学习到这里 也算是进入大数据的大门了 接下来就学习更高级的内容吧</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="学习过的资料"><a href="#学习过的资料" class="headerlink" title="学习过的资料"></a><font color="#CDAA7D">学习过的资料</font></h3><ul><li><a href="https://www.bilibili.com/video/av11075449/" target="_blank" rel="noopener"><font color="#00BFFF">马士兵老师hadoop2.7入门系列</font></a></li><li><a href="https://baike.baidu.com/item/hdfs" target="_blank" rel="noopener"><font color="#00BFFF">HDFS-百度百科</font></a></li><li><a href="https://baike.baidu.com/item/yarn" target="_blank" rel="noopener"><font color="#00BFFF">YARN-百度百科</font></a></li><li><a href="http://blog.csdn.net/u013850277/article/details/59792145" target="_blank" rel="noopener"><font color="#00BFFF">Hadoop之MapReduce运行原理</font></a></li><li><a href="https://www.zhihu.com/question/23345991" target="_blank" rel="noopener"><font color="#00BFFF">关于MapReduce的理解</font></a></li></ul><h3 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a><font color="#CDAA7D">遇到的问题</font></h3><ul><li>如果主节点重新格式化了 子节点也需要将数据目录中的文件都删除</li><li>遇到会持续更新。。。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Hadoop是一个由Apache基金会所开发的分布式系统基础架构。&lt;br&gt;用户可以在不了解分布式底层细节的情况下，开发分布式程序。充分利用集群的威力进行高速运算和存储。&lt;br&gt;Hadoop实现了一个分布式文件系统，简称HDFS。HDFS有高容错性的特点，并且设计用来部署在低廉的硬件上；而且它提供高吞吐量来访问应用程序的数据，适合那些有着超大数据集的应用程序。&lt;br&gt;Hadoop的核心设计是：HDFS、YARN和MapReduce。HDFS为海量的数据提供了存储，YARN提供资源调度，而MapReduce则为海量的数据提供了计算.&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Hadoop" scheme="http://www.yunfwe.cn/categories/Hadoop/"/>
    
    
      <category term="Hadoop" scheme="http://www.yunfwe.cn/tags/Hadoop/"/>
    
      <category term="大数据" scheme="http://www.yunfwe.cn/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/"/>
    
  </entry>
  
  <entry>
    <title>Lua入门笔记</title>
    <link href="http://www.yunfwe.cn/2018/01/12/2018/Lua%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/"/>
    <id>http://www.yunfwe.cn/2018/01/12/2018/Lua%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0/</id>
    <published>2018-01-12T06:00:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Lua是一门脚本语言 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。Lua由标准C编写而成，几乎在所有操作系统和平台上都可以编译，运行。Lua并没有提供强大的库，这是由它的定位决定的。所以Lua不适合作为开发独立应用程序的语言。Lua 有一个同时进行的JIT项目，提供在特定平台上的即时编译功能。</p></blockquote><a id="more"></a><h3 id="Lua特征"><a href="#Lua特征" class="headerlink" title="Lua特征"></a><font color="#CDAA7D">Lua特征</font></h3><ul><li>轻量级 使用标准C语言开发 编译后才100多K</li><li>可拓展 lua没有庞大的标准库，但是可以灵活使用宿主语言的功能</li><li>支持面向过程和函数式编程</li><li>自动内存管理 闭包 提供多线程（更像是协程）</li></ul><h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a><font color="#5CACEE">应用场景</font></h2><ul><li>游戏开发</li><li>独立应用脚本</li><li>Web应用脚本</li><li>程序拓展或插件（Nginx, MySQL proxy）</li><li>安全系统 如入侵检测系统</li></ul><h2 id="Lua安装"><a href="#Lua安装" class="headerlink" title="Lua安装"></a><font color="#5CACEE">Lua安装</font></h2><h3 id="Linux编译安装lua"><a href="#Linux编译安装lua" class="headerlink" title="Linux编译安装lua"></a><font color="#CDAA7D">Linux编译安装lua</font></h3><p>依赖readline.h ubuntu系统安装libreadline-dev </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://www.lua.org/ftp/lua-5.3.4.tar.gz</span><br><span class="line">tar xf lua-5.3.4.tar.gz</span><br><span class="line">cd lua-5.3.4</span><br><span class="line">make linux</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><pre><code>cd src &amp;&amp; install -p -m 0755 lua luac /usr/local/bincd src &amp;&amp; install -p -m 0644 lua.h luaconf.h lualib.h lauxlib.h lua.hpp /usr/local/includecd src &amp;&amp; install -p -m 0644 liblua.a /usr/local/libcd doc &amp;&amp; install -p -m 0644 lua.1 luac.1 /usr/local/man/man1</code></pre><p>Lua向系统安装了这些文件 接下来就可以使用Lua命令了</p><h2 id="Hello-World"><a href="#Hello-World" class="headerlink" title="Hello World"></a><font color="#5CACEE">Hello World</font></h2><p>用hello world作为lua第一个脚本的开始</p><p>lua也有一个交互式解释器 也可以写为后缀为.lua的文件来执行代码</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim hello.lua</span><br></pre></td></tr></table></figure><p>写入</p><pre><code>print(&quot;Hello world!&quot;)</code></pre><p>执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lua hello.lua</span><br></pre></td></tr></table></figure></p><h2 id="Lua的注释"><a href="#Lua的注释" class="headerlink" title="Lua的注释"></a><font color="#5CACEE">Lua的注释</font></h2><h3 id="单行注释"><a href="#单行注释" class="headerlink" title="单行注释"></a><font color="#CDAA7D">单行注释</font></h3><p>单行注释是两个减号</p><pre><code>-- 单行注释</code></pre><h3 id="多行注释"><a href="#多行注释" class="headerlink" title="多行注释"></a><font color="#CDAA7D">多行注释</font></h3><pre><code>--[[多行注释多行注释--]]</code></pre><h3 id="标示符"><a href="#标示符" class="headerlink" title="标示符"></a><font color="#CDAA7D"><font color="#5CACEE">标示符</font></font></h3><p>Lua中的标示符和其他语言的标示符都基本一致</p><h2 id="关键字"><a href="#关键字" class="headerlink" title="关键字"></a><font color="#5CACEE">关键字</font></h2><table><thead><tr><th>关键字</th><th>关键字</th><th>关键字</th><th>关键字</th></tr></thead><tbody><tr><td>and</td><td>break</td><td>do</td><td>else</td></tr><tr><td>elseif</td><td>end</td><td>false</td><td>for</td></tr><tr><td>function</td><td>if</td><td>in</td><td>local</td></tr><tr><td>nil</td><td>not</td><td>or</td><td>repeat</td></tr><tr><td>return</td><td>then</td><td>true</td><td>until</td></tr><tr><td>while</td></tr></tbody></table><p>Lua中的约定：以下划线开头的大写字母 被保留用于Lua的内部全局变量</p><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a><font color="#5CACEE">数据类型</font></h2><p>Lua有8个基本类型</p><table><thead><tr><th>数据类型</th><th>描述</th></tr></thead><tbody><tr><td>nil</td><td>表示无效值 空值</td></tr><tr><td>boolean</td><td>只有两个值：true和false</td></tr><tr><td>number</td><td>表示双精度类型的实浮点数</td></tr><tr><td>string</td><td>字符串 可以用单引号也可以双引号</td></tr><tr><td>function</td><td>由C或者Lua编写的函数</td></tr><tr><td>userdata</td><td>表示任意存储在变量中的C数据结构</td></tr><tr><td>thread</td><td>表示执行的独立线程，用于执行协同程序</td></tr><tr><td>table</td><td>Lua 中的表（table）其实是一个”关联数组”</td></tr></tbody></table><p>使用type函数测试给定的值是什么类型 比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">print(type(1))</span><br><span class="line">print(type(&quot;hello&quot;))</span><br><span class="line">print(type(false))</span><br><span class="line">print(type(&#123;&#125;))</span><br></pre></td></tr></table></figure></p><h3 id="nil-空"><a href="#nil-空" class="headerlink" title="nil (空)"></a><font color="#CDAA7D">nil (空)</font></h3><p>nil类型表示没有任何有效值 nil类型只有一个值:nil</p><p>将全局变量或table表里的变量赋值nil 相当于删除了这个变量</p><h3 id="boolean-布尔"><a href="#boolean-布尔" class="headerlink" title="boolean (布尔)"></a><font color="#CDAA7D">boolean (布尔)</font></h3><p>boolean型只有两个值：true 和 false</p><p><strong>Lua只把false和nil看作是假 其他都为真！！！就算是0也是真！！！</strong></p><h3 id="number-数字"><a href="#number-数字" class="headerlink" title="number (数字)"></a><font color="#CDAA7D">number (数字)</font></h3><p>Lua的number只有一种类型：double类型 所有的数字都是double类型的</p><h3 id="string-字符串"><a href="#string-字符串" class="headerlink" title="string (字符串)"></a><font color="#CDAA7D">string (字符串)</font></h3><p>单行字符串可以用双引号或者单引号表示<br>多行字符串用 [[string]] 表示 相当于python的三引号</p><p><strong>如果一个数字型的字符串与数字进行运算 Lua会将字符串转为number！与JavaScript相反</strong></p><p>Lua的字符串拼接使用”..” 两个点 比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">print(&quot;str&quot;..1)</span><br><span class="line">print(2 ..3 ..4)</span><br></pre></td></tr></table></figure></p><p>如果两个数字做字符串拼接 数字后面一定要带个空格 否则解释器会解释错</p><p>Lua使用#来计算字符串的长度 就像是python的len()一样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">str = &quot;Hello world!&quot;</span><br><span class="line">print(#str)</span><br><span class="line">print(#&quot;lua&quot;)</span><br></pre></td></tr></table></figure></p><h3 id="table-表"><a href="#table-表" class="headerlink" title="table (表)"></a><font color="#CDAA7D">table (表)</font></h3><p>Lua的table类型比较有意思 像是python的字典，列表，集合的合体<br>table类型的索引可以是数字 也可以是字符串<br><strong>Lua的数字索引是从1开始的！！！</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tbl1 = &#123;&#125;</span><br><span class="line">tbl2 = &#123;&quot;a&quot;,&quot;b&quot;,&quot;c&quot;&#125;</span><br><span class="line">tbl3 = &#123;a=1,b=2&#125;</span><br><span class="line">print(tbl2[1])</span><br><span class="line">print(tbl3[&quot;a&quot;])</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a = &#123;&#125;</span><br><span class="line">a[&quot;key&quot;] = &quot;value&quot;</span><br><span class="line">a[1] = 2</span><br><span class="line">print(a[&quot;key&quot;])</span><br><span class="line">print(a[1])</span><br></pre></td></tr></table></figure><p>Lua取table中的数据可以用[] 如果key是字符串类型 还可以用.<br>比如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tbl1 = &#123;key=&quot;a&quot;&#125;</span><br><span class="line">print(tbl1.key)</span><br></pre></td></tr></table></figure></p><h3 id="function-函数"><a href="#function-函数" class="headerlink" title="function (函数)"></a><font color="#CDAA7D">function (函数)</font></h3><p>Lua的函数跟JavaScript的函数很像 用function声明 还可以当作参数传给其他函数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function map(fn, tab)</span><br><span class="line">    count = 1</span><br><span class="line">    ltab = &#123;&#125;</span><br><span class="line">    for k,v in pairs(tab) do</span><br><span class="line">            ltab[k] = fn(v)</span><br><span class="line">    end</span><br><span class="line">    return ltab</span><br><span class="line">end</span><br><span class="line"></span><br><span class="line">map(function(x)</span><br><span class="line">        return x*x</span><br><span class="line">    end,</span><br><span class="line">    &#123;2,3,4,5&#125;)</span><br><span class="line">    </span><br><span class="line">for k,v in pairs(rst) do</span><br><span class="line">    print(&quot;new: &quot;..k..&quot;=&quot;..v)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h3 id="thread-线程"><a href="#thread-线程" class="headerlink" title="thread (线程)"></a><font color="#CDAA7D">thread (线程)</font></h3><p>Lua里的线程其实就是协程</p><h3 id="userdata-自定义类型"><a href="#userdata-自定义类型" class="headerlink" title="userdata (自定义类型)"></a><font color="#CDAA7D">userdata (自定义类型)</font></h3><p>userdata 是一种用户自定义数据，用于表示一种由应用程序或 C/C++ 语言库所创建的类型，可以将任意 C/C++ 的任意数据类型的数据（通常是 struct 和 指针）存储到 Lua 变量中调用。</p><h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a><font color="#5CACEE">变量</font></h2><p>默认情况下 Lua的变量总是全局的 不需要声明就可以直接赋值。访问一个不存在的变量会返回nil，想删除一个变量 将其赋值为nil就可以了<br><br><br>Lua有三种变量：全局变量 本地变量 表中的域<br>Lua除非用local声明为局部变量 否则都为全局变量</p><p><br><br>应该尽量使用局部变量</p><ul><li>避免变量冲突</li><li>访问局部变量的速度更快</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">o = 10              --&gt; 全局变量</span><br><span class="line">function say()</span><br><span class="line">   local o = 100    --&gt; 局部变量</span><br><span class="line">   print(o)</span><br><span class="line">end</span><br><span class="line">print(o)</span><br></pre></td></tr></table></figure><h3 id="变量赋值"><a href="#变量赋值" class="headerlink" title="变量赋值"></a><font color="#CDAA7D">变量赋值</font></h3><p>Lua的变量赋值也比较灵活<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">a,b,c = 1,2,3   --&gt; a=1,b=2,c=3</span><br><span class="line">a,b = b,a       --&gt; swap a for b</span><br><span class="line">a,b = 1,2,3     --&gt; a=1,b=2 3 was drop</span><br><span class="line">a,b,c = 1,2     --&gt; a=1,b=2,c=nil</span><br><span class="line">print(a,b,c)</span><br></pre></td></tr></table></figure></p><h3 id="Lua循环"><a href="#Lua循环" class="headerlink" title="Lua循环"></a><font color="#CDAA7D"><font color="#5CACEE">Lua循环</font></font></h3><h3 id="while-循环"><a href="#while-循环" class="headerlink" title="while 循环"></a><font color="#CDAA7D">while 循环</font></h3><pre><code>while (condition)do    statementsend</code></pre><h3 id="for-循环"><a href="#for-循环" class="headerlink" title="for 循环"></a><font color="#CDAA7D">for 循环</font></h3><h4 id="数值for循环"><a href="#数值for循环" class="headerlink" title="数值for循环"></a><font color="#DDA0DD">数值for循环</font></h4><pre><code>for var=exp1,exp2,exp3 do    statementsend</code></pre><p>var从exp1变化到exp2，每次变化以exp3为步长递增var，并执行一次”执行体”。exp3是可选的，如果不指定，默认为1。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for i=10,1,-1 do</span><br><span class="line">    print(i)</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p><h4 id="泛型for循环"><a href="#泛型for循环" class="headerlink" title="泛型for循环"></a><font color="#DDA0DD">泛型for循环</font></h4><p>泛型for循环通过一个迭代器函数来遍历所有值</p><pre><code>for k,v in pairs(table) do    statementsendfor i,v in ipairs(list) do    statementsend在lua中pairs与ipairs两个迭代器的用法相近，但有一点是不一样的：pairs可以遍历表中所有的key，并且除了迭代器本身以及遍历表本身还可以返回nil;但是ipairs则不能返回nil,只能返回数字0，如果遇到nil则退出。它只能遍历到表中出现的第一个不是整数的key</code></pre><h3 id="repeat…until-循环"><a href="#repeat…until-循环" class="headerlink" title="repeat…until 循环"></a><font color="#CDAA7D">repeat…until 循环</font></h3><p>类似于C的do while循环 先做后判断</p><pre><code>repeat    statementsuntil(condition)</code></pre><h3 id="break-跳出循环"><a href="#break-跳出循环" class="headerlink" title="break 跳出循环"></a><font color="#CDAA7D">break 跳出循环</font></h3><p>如果遇到break 就终止循环 很不幸的是 Lua没有continue，但是可以用嵌套循环模拟</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for i = 1, 10 do</span><br><span class="line">    repeat</span><br><span class="line">        if i == 5 then</span><br><span class="line">            break</span><br><span class="line">        end</span><br><span class="line">        print(i)</span><br><span class="line">    until true</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="流程控制"><a href="#流程控制" class="headerlink" title="流程控制"></a><font color="#5CACEE">流程控制</font></h2><h3 id="if-语句"><a href="#if-语句" class="headerlink" title="if 语句"></a><font color="#CDAA7D">if 语句</font></h3><pre><code>if (condition)then    statementsend</code></pre><h3 id="if…else-语句"><a href="#if…else-语句" class="headerlink" title="if…else 语句"></a><font color="#CDAA7D">if…else 语句</font></h3><pre><code>if (condition)then    statementselse    statementsend</code></pre><h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a><font color="#5CACEE">函数</font></h2><p>Lua的函数定义格式如下</p><pre><code>scope function name(arg1,arg2,...)    statements    return resultscope 定义函数作用域name  函数名arg   参数statements  函数内部语句return  返回值</code></pre><h3 id="多返回值"><a href="#多返回值" class="headerlink" title="多返回值"></a><font color="#CDAA7D">多返回值</font></h3><p>Lua可以一次返回多个值 同样需要多个参数来接收</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s,e = string.find(&quot;www.hinote.ga&quot;,&quot;hinote&quot;)</span><br><span class="line">print(s,e)</span><br></pre></td></tr></table></figure><h3 id="可变参数"><a href="#可变参数" class="headerlink" title="可变参数"></a><font color="#CDAA7D">可变参数</font></h3><p>将Lua的参数放入一个叫arg的表中 #arg计算有多少个arg的值<br>用”…”来表示函数有可变参数</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function args(...)</span><br><span class="line">    local arg = &#123;...&#125;</span><br><span class="line">    print(#arg)</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="Lua-运算符"><a href="#Lua-运算符" class="headerlink" title="Lua 运算符"></a><font color="#5CACEE">Lua 运算符</font></h2><p>设定A=10, B=20</p><h3 id="算数运算符"><a href="#算数运算符" class="headerlink" title="算数运算符"></a><font color="#CDAA7D">算数运算符</font></h3><table><thead><tr><th>操作符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>+</td><td>加法</td><td>A+B=30</td></tr><tr><td>-</td><td>减法</td><td>A-B=-10</td></tr><tr><td>*</td><td>乘法</td><td>A*B=200</td></tr><tr><td>/</td><td>除法</td><td>B/A=2</td></tr><tr><td>%</td><td>取余</td><td>B%A=0</td></tr><tr><td>^</td><td>乘幂</td><td>A^2=100</td></tr></tbody></table><h3 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a><font color="#CDAA7D">关系运算符</font></h3><table><thead><tr><th>操作符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>==</td><td>等于</td><td>(A == B) 为 false</td></tr><tr><td>~=</td><td>不等于</td><td>(A ~= B) 为 true</td></tr><tr><td>&gt;</td><td>大于</td><td>(A &gt; B) 为 false</td></tr><tr><td>&lt;</td><td>小于</td><td>(A &lt; B) 为 true</td></tr><tr><td>>=</td><td>大于等于</td><td>(A &gt;= B) 返回 false</td></tr><tr><td>&lt;=</td><td>小于等于</td><td>(A &lt;= B) 返回 true</td></tr></tbody></table><h3 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a><font color="#CDAA7D">逻辑运算符</font></h3><p>A=true, B=false</p><table><thead><tr><th>操作符</th><th>描述</th><th>实例</th></tr></thead><tbody><tr><td>and</td><td>逻辑与操作符</td><td>(A and B) 为 false</td></tr><tr><td>or</td><td>逻辑或操作符</td><td>(A or B) 为 true</td></tr><tr><td>not</td><td>逻辑非操作符</td><td>not(A and B) 为 true</td></tr></tbody></table><h3 id="其他运算符"><a href="#其他运算符" class="headerlink" title="其他运算符"></a><font color="#CDAA7D">其他运算符</font></h3><p>A=”Hello”, B=”World”<br>|操作符|描述|实例|<br>|-|-|-|<br>|..|连接两个字符串|A..B 返回 “Hello World”|<br>|#|返回字符串或表的长度|#A 返回 5|</p><h3 id="算数优先级"><a href="#算数优先级" class="headerlink" title="算数优先级"></a><font color="#CDAA7D">算数优先级</font></h3><pre><code>^not    - (unary)*      /+      -..&lt;      &gt;      &lt;=     &gt;=     ~=     ==andor</code></pre><h2 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a><font color="#5CACEE">字符串</font></h2><h3 id="字符串常用方法"><a href="#字符串常用方法" class="headerlink" title="字符串常用方法"></a><font color="#CDAA7D">字符串常用方法</font></h3><table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td>string.upper</td><td>字符串转为全大写</td></tr><tr><td>string.lower</td><td>字符串转为全小写</td></tr><tr><td>string.gsub</td><td>字符串替换</td></tr><tr><td>string.find</td><td>字符串查找</td></tr><tr><td>string.reverse</td><td>字符串反转</td></tr><tr><td>string.format</td><td>格式化字符串</td></tr><tr><td>string.char</td><td>将ascii转为字符串</td></tr><tr><td>string.byte</td><td>将字符串转为ascii</td></tr><tr><td>string.len</td><td>计算字符串长度</td></tr><tr><td>string.rep</td><td>返回字符串的N个拷贝</td></tr><tr><td>..</td><td>连接两个字符串</td></tr><tr><td>string.gmatch</td><td>迭代器的方式匹配正则表达式</td></tr><tr><td>string.match</td><td>只寻找源字符串的第一个匹配</td></tr></tbody></table><h2 id="数组"><a href="#数组" class="headerlink" title="数组"></a><font color="#5CACEE">数组</font></h2><h3 id="一维数组"><a href="#一维数组" class="headerlink" title="一维数组"></a><font color="#CDAA7D">一维数组</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arr = &#123;&quot;Hello&quot;, &quot;World&quot;&#125;</span><br></pre></td></tr></table></figure><h3 id="多维数组"><a href="#多维数组" class="headerlink" title="多维数组"></a><font color="#CDAA7D">多维数组</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arr = &#123;&quot;Hello&quot;,&#123;&quot;Hello&quot;,&quot;Lua&quot;&#125;&#125;</span><br></pre></td></tr></table></figure><h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a><font color="#5CACEE">迭代器</font></h2><h3 id="泛型for迭代器"><a href="#泛型for迭代器" class="headerlink" title="泛型for迭代器"></a><font color="#CDAA7D">泛型for迭代器</font></h3><p>泛型 for 在自己内部保存迭代函数，实际上它保存三个值：迭代函数、状态常量、控制变量。</p><p>泛型 for 迭代器提供了集合的 key/value 对，语法格式如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for k, v in pairs(t) do</span><br><span class="line">    print(k, v)</span><br><span class="line">end</span><br></pre></td></tr></table></figure></p><p>下面我们看看泛型 for 的执行过程：</p><ul><li>首先，初始化，计算in后面表达式的值，表达式应该返回泛型 for 需要的三个值：迭代函数、状态常量、控制变量；与多值赋值一样，如果表达式返回的结果个数不足三个会自动用nil补足，多出部分会被忽略。</li><li>第二，将状态常量和控制变量作为参数调用迭代函数（注意：对于for结构来说，状态常量没有用处，仅仅在初始化时获取他的值并传递给迭代函数）。</li><li>第三，将迭代函数返回的值赋给变量列表。</li><li>第四，如果返回的第一个值为nil循环结束，否则执行循环体。</li><li>第五，回到第二步再次调用迭代函数</li></ul><h3 id="无状态迭代器"><a href="#无状态迭代器" class="headerlink" title="无状态迭代器"></a><font color="#CDAA7D">无状态迭代器</font></h3><p>无状态的迭代器是指不保留任何状态的迭代器，因此在循环中我们可以利用无状态迭代器避免创建闭包花费额外的代价。</p><p>每一次迭代，迭代函数都是用两个变量（状态常量和控制变量）的值作为参数被调用，一个无状态的迭代器只利用这两个值可以获取下一个元素。<br>这种无状态迭代器的典型的简单的例子是ipairs，它遍历数组的每一个元素</p><h3 id="多状态迭代器"><a href="#多状态迭代器" class="headerlink" title="多状态迭代器"></a><font color="#CDAA7D">多状态迭代器</font></h3><p>很多情况下，迭代器需要保存多个状态信息而不是简单的状态常量和控制变量，最简单的方法是使用闭包，还有一种方法就是将所有的状态信息封装到table内，将table作为迭代器的状态常量，因为这种情况下可以将所有的信息存放在table内，所以迭代函数通常不需要第二个参数。</p><h2 id="table-表-1"><a href="#table-表-1" class="headerlink" title="table (表)"></a><font color="#5CACEE">table (表)</font></h2><p>table是Lua的一种数据结构来帮助我们创建不同的数据类型<br>Lua也是通过table来解决模块、包、和对象的</p><h3 id="表的常用操作"><a href="#表的常用操作" class="headerlink" title="表的常用操作"></a><font color="#CDAA7D">表的常用操作</font></h3><table><thead><tr><th>方法</th><th>用途</th></tr></thead><tbody><tr><td>table.concat</td><td>类似于python字符串的join</td></tr><tr><td>table.insert</td><td>在数组的指定位置插入一个值</td></tr><tr><td>table.remove</td><td>移除数组中的一个值</td></tr><tr><td>table.sort</td><td>对给定的table升序排序</td></tr></tbody></table><h3 id="模块与包"><a href="#模块与包" class="headerlink" title="模块与包"></a><font color="#CDAA7D"><font color="#5CACEE">模块与包</font></font></h3><p>Lua5.1开始 加入了标准的模块管理机制<br>Lua的模块是由变量和函数等元素组成的table, 最后返回这个table就可以了<br><br><br>test.lua<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">module = &#123;&#125;</span><br><span class="line">function module.max(x,y)</span><br><span class="line">    if (x &gt; y) then</span><br><span class="line">        return x</span><br><span class="line">    else</span><br><span class="line">        return y</span><br><span class="line">    end</span><br><span class="line">end</span><br><span class="line">return module</span><br></pre></td></tr></table></figure></p><p>引入也很简单<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">require(&quot;test&quot;)</span><br><span class="line">module.max(2,3)         --&gt; 引入的是模块return的名字</span><br><span class="line">test = require(&quot;test&quot;)  --&gt; 也可以这样将模块重命名</span><br><span class="line">test.max(2,3)</span><br></pre></td></tr></table></figure></p><h3 id="模块加载路径"><a href="#模块加载路径" class="headerlink" title="模块加载路径"></a><font color="#CDAA7D">模块加载路径</font></h3><p>Lua内使用package.path可以看到默认的搜索路径<br>如果找不到lua模块 则会去调用C库 使用package.cpath可以查看</p><p>也可以使用环境变量LUA_PATH来设置lua的搜索路径<br>C库的环境变量是LUA_CPATH</p><h2 id="元表-Matatable"><a href="#元表-Matatable" class="headerlink" title="元表 (Matatable)"></a><font color="#5CACEE">元表 (Matatable)</font></h2><p>感觉像是python类的魔法方法，可以自己修改table的各种行为，比如两个table相加，又有点像JavaScript的原型链</p><p>高级话题 以后再研究</p><h2 id="协程"><a href="#协程" class="headerlink" title="协程"></a><font color="#5CACEE">协程</font></h2><p>Lua 协同程序(coroutine)与线程比较类似：拥有独立的堆栈，独立的局部变量，独立的指令指针，同时又与其它协同程序共享全局变量和其它大部分东西。</p><h3 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a><font color="#CDAA7D">基本语法</font></h3><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>coroutine.create</td><td>创建coroutine,参数是一个函数</td></tr><tr><td>coroutine.resume</td><td>重启coroutine，和create配合使用</td></tr><tr><td>coroutine.yield</td><td>挂起coroutine，将coroutine设置为挂起状态</td></tr><tr><td>coroutine.status</td><td>查看coroutine的状态</td></tr><tr><td>coroutine.wrap</td><td>也是创建一个coroutine</td></tr><tr><td>coroutine.running</td><td>返回正在运行的coroutine</td></tr></tbody></table><p>高级话题 用到的时候再研究</p><h2 id="文件IO"><a href="#文件IO" class="headerlink" title="文件IO"></a><font color="#5CACEE">文件IO</font></h2><p>Lua的IO库用于读取和处理文件 分为简单模式和完全模式</p><ul><li>简单模式 拥有一个当前输入和输出文件，并且提供针对文件的相关操作</li><li>它以一种面对对象的形式，将所有的文件操作定义为文件句柄的方法</li></ul><p><br><br>打开文件操作语句如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">file = io.open (filename [, mode])</span><br></pre></td></tr></table></figure></p><p>其中mode和python的文件打开方式一摸一样 不再多说</p><h3 id="简单模式"><a href="#简单模式" class="headerlink" title="简单模式"></a><font color="#CDAA7D">简单模式</font></h3><h4 id="读取文件内容"><a href="#读取文件内容" class="headerlink" title="读取文件内容"></a><font color="#DDA0DD">读取文件内容</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">file = io.open(&quot;/etc/passwd&quot;,&quot;r&quot;)</span><br><span class="line">io.input(file)      --&gt; 设置输入文件为file</span><br><span class="line">io.read(10)         --&gt; 读取10个字节 默认是读取一行</span><br><span class="line">io.close(file)      --&gt; 关闭文件</span><br></pre></td></tr></table></figure><h4 id="写入文件内容"><a href="#写入文件内容" class="headerlink" title="写入文件内容"></a><font color="#DDA0DD">写入文件内容</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">file = io.open(&quot;/tmp/lua&quot;,&quot;a&quot;)  --&gt; 如果是w模式 文件存在则会清空文件</span><br><span class="line">io.output(file)</span><br><span class="line">io.write(&quot;Hello\n&quot;)</span><br><span class="line">io.close(file)</span><br></pre></td></tr></table></figure><h4 id="io-read有多种参数"><a href="#io-read有多种参数" class="headerlink" title="io.read有多种参数"></a><font color="#DDA0DD">io.read有多种参数</font></h4><table><thead><tr><th>模式</th><th>描述</th></tr></thead><tbody><tr><td>“*n”</td><td>读取一个数字并返回它</td></tr><tr><td>“*a”</td><td>读取全部内容</td></tr><tr><td>“*l”</td><td>读取下一行 默认行为</td></tr><tr><td>number</td><td>按照字节读取</td></tr></tbody></table><h4 id="其他的io方法"><a href="#其他的io方法" class="headerlink" title="其他的io方法"></a><font color="#DDA0DD">其他的io方法</font></h4><table><thead><tr><th>方法</th><th>描述</th></tr></thead><tbody><tr><td>io.tmpfile</td><td>返回一个临时文件 “a”模式打开</td></tr><tr><td>io.type(file)</td><td>检测obj是否是个可用的文件句柄</td></tr><tr><td>io.flush</td><td>向文件写入缓冲中的所有数据</td></tr><tr><td>io.lines</td><td>返回一个迭代函数 每次调用返回一行</td></tr></tbody></table><h3 id="完全模式"><a href="#完全模式" class="headerlink" title="完全模式"></a><font color="#CDAA7D">完全模式</font></h3><p>通常我们会在同一时间处理多个文件 简单模式就不够用了</p><h4 id="文件读写"><a href="#文件读写" class="headerlink" title="文件读写"></a><font color="#DDA0DD">文件读写</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">f1 = io.open(&quot;/etc/passwd&quot;,&quot;r&quot;)</span><br><span class="line">f1:read()     --&gt; 没看错 就是:  </span><br><span class="line">f1:close()</span><br><span class="line">f2 = io.open(&quot;/tmp/lua&quot;,&quot;w&quot;)</span><br><span class="line">f2:write(&quot;Hi!\n&quot;)</span><br><span class="line">f2:close()</span><br></pre></td></tr></table></figure><h4 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a><font color="#DDA0DD">其他方法</font></h4><table><thead><tr><th>模式</th><th>描述</th></tr></thead><tbody><tr><td>file:seek</td><td>获取和设置当前文件指针</td></tr><tr><td>file:flush</td><td>将缓冲区输入写入到文件</td></tr></tbody></table><h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a><font color="#5CACEE">错误处理</font></h2><h3 id="assert-和-error"><a href="#assert-和-error" class="headerlink" title="assert 和 error"></a><font color="#CDAA7D">assert 和 error</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function add(a,b)</span><br><span class="line">   assert(type(a) == &quot;number&quot;, &quot;a 不是一个数字&quot;)</span><br><span class="line">   assert(type(b) == &quot;number&quot;, &quot;b 不是一个数字&quot;)</span><br><span class="line">   return a+b</span><br><span class="line">end</span><br><span class="line">add(10)</span><br></pre></td></tr></table></figure><p>实例中assert首先检查第一个参数，若没问题，assert不做任何事情；否则，assert以第二个参数作为错误信息抛出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function add(a,b)</span><br><span class="line">   error(&quot;错误了&quot;)</span><br><span class="line">   return a+b</span><br><span class="line">end</span><br><span class="line">add(10)</span><br></pre></td></tr></table></figure></p><p>error更像是python的raise 主动抛出一个异常</p><h3 id="pcall-和-xpcall"><a href="#pcall-和-xpcall" class="headerlink" title="pcall 和 xpcall"></a><font color="#CDAA7D">pcall 和 xpcall</font></h3><p>Lua中处理错误，可以使用函数pcall来包装需要执行的代码。</p><p>pcall传入需要运行的函数和函数的参数，如果函数运行的有错误就返回false 否则返回true 所以可以用if进行判断和处理</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pcall(function(i) print(i) end, 33)</span><br><span class="line">pcall(function(i) print(i) error(&quot;error&quot;) end, 33)</span><br></pre></td></tr></table></figure><p>xpcall可以接收一个错误处理函数来查看错误发生时的调用栈</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xpcall(function(i) print(i) error(&apos;error..&apos;) end, function() print(debug.traceback()) end, 33)</span><br></pre></td></tr></table></figure><p>xpacall的第二个参数是传入了一个错误处理函数 可以在这个函数中使用debug库获取错误的额外信息了</p><ul><li>debug.debug 提供一个Lua提示符 让用户来检查错误的原因</li><li>debug.traceback 根据调用栈来构建一个扩展的错误信息</li></ul><h2 id="debug-调试"><a href="#debug-调试" class="headerlink" title="debug 调试"></a><font color="#5CACEE">debug 调试</font></h2><blockquote><p>未完待续。。。</p></blockquote><h2 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a><font color="#5CACEE">垃圾回收</font></h2><blockquote><p>未完待续。。。</p></blockquote><h2 id="面向对象"><a href="#面向对象" class="headerlink" title="面向对象"></a><font color="#5CACEE">面向对象</font></h2><blockquote><p>未完待续。。。</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Lua是一门脚本语言 其设计目的是为了嵌入应用程序中，从而为应用程序提供灵活的扩展和定制功能。Lua由标准C编写而成，几乎在所有操作系统和平台上都可以编译，运行。Lua并没有提供强大的库，这是由它的定位决定的。所以Lua不适合作为开发独立应用程序的语言。Lua 有一个同时进行的JIT项目，提供在特定平台上的即时编译功能。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Lua" scheme="http://www.yunfwe.cn/categories/Lua/"/>
    
    
      <category term="Lua" scheme="http://www.yunfwe.cn/tags/Lua/"/>
    
  </entry>
  
  <entry>
    <title>Leanote开源云笔记搭建</title>
    <link href="http://www.yunfwe.cn/2018/01/02/2018/Leanote%E5%BC%80%E6%BA%90%E4%BA%91%E7%AC%94%E8%AE%B0%E6%90%AD%E5%BB%BA/"/>
    <id>http://www.yunfwe.cn/2018/01/02/2018/Leanote%E5%BC%80%E6%BA%90%E4%BA%91%E7%AC%94%E8%AE%B0%E6%90%AD%E5%BB%BA/</id>
    <published>2018-01-02T06:05:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Leanote是一款开源的云笔记和博客系统 可以很方便的搭建自己的云笔记。在自己的云主机上搭建了Leanote后 就可以抛弃某云笔记了。而且还自带一套博客系统 写好的笔记可以一键生成到博客空间。Leanote还支持注册（注册功能可以关闭）或者手动添加用户，可以让好友也一起用的哦。<br>Github地址: <a href="https://github.com/leanote/leanote" target="_blank" rel="noopener">https://github.com/leanote/leanote</a></p></blockquote><a id="more"></a><h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title=" 安装步骤"></a><font color="#5CACEE"> 安装步骤</font></h2><ol><li>下载 leanote 二进制版。</li><li>安装和启动 mongodb。</li><li>导入初始数据。</li><li>配置 leanote。</li><li>运行 leanote。</li></ol><h3 id="下载-leanote-二进制版"><a href="#下载-leanote-二进制版" class="headerlink" title="下载 leanote 二进制版"></a><font color="#CDAA7D">下载 leanote 二进制版</font></h3><blockquote><p>下载地址: <a href="http://leanote.org/#download" target="_blank" rel="noopener">http://leanote.org/#download</a></p></blockquote><p>下载后将压缩包解压到目录中 linux为例</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar xf leanote-linux-amd64-v2.6.bin.tar.gz -C /usr/local/</span><br><span class="line">ls /usr/local/leanote/</span><br></pre></td></tr></table></figure><h3 id="安装和启动-mongodb"><a href="#安装和启动-mongodb" class="headerlink" title=" 安装和启动 mongodb"></a><font color="#CDAA7D"> 安装和启动 mongodb</font></h3><blockquote><p>可以使用包管理器下载比如apt或者yum 也可以从mongodb官方下载二进制包</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wget https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-3.0.1.tgz</span><br><span class="line">tar xf mongodb-linux-x86_64-3.0.1.tgz -C /usr/local/</span><br><span class="line">mv /usr/local/&#123;mongodb-linux-x86_64-3.0.1,mongodb&#125;</span><br><span class="line">mkdir /usr/local/mongodb/data</span><br><span class="line">/usr/local/mongodb/bin/mongod --dbpath /usr/local/mongodb/data/ &amp;&gt;&gt;/tmp/mongod &amp;</span><br><span class="line">/usr/local/mongodb/bin/mongo</span><br><span class="line">&gt; show dbs      # 进入mongo cli后 查看所有库</span><br></pre></td></tr></table></figure><h3 id="导入初始数据"><a href="#导入初始数据" class="headerlink" title=" 导入初始数据"></a><font color="#CDAA7D"> 导入初始数据</font></h3><blockquote><p>初始数据存放在 /usr/local/leanote/mongodb_backup/leanote_install_data/ 中</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mongodb/bin/mongorestore -h localhost -d leanote --dir \</span><br><span class="line">/usr/local/leanote/mongodb_backup/leanote_install_data/</span><br></pre></td></tr></table></figure><p>输出没有异常的话可以重新进入 mongo cli 然后 show dbs 看看是否存在leanote库了</p><h3 id="配置-leanote"><a href="#配置-leanote" class="headerlink" title=" 配置 leanote"></a><font color="#CDAA7D"> 配置 leanote</font></h3><blockquote><p>默认leanote已经存在两个用户</p></blockquote><table><thead><tr><th>用户</th><th>密码</th></tr></thead><tbody><tr><td>admin</td><td>abc123</td></tr><tr><td><a href="mailto:demo@leanote.com" target="_blank" rel="noopener">demo@leanote.com</a></td><td><a href="mailto:demo@leanote.com" target="_blank" rel="noopener">demo@leanote.com</a></td></tr></tbody></table><p>编辑 /usr/local/leanote/conf/app.conf 文件 修改app.secret 可以随便更改几个字符串</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/local/leanote/conf/app.conf</span><br></pre></td></tr></table></figure><p>默认启动端口啥的 也看着改吧</p><h3 id="运行-leanote"><a href="#运行-leanote" class="headerlink" title=" 运行 leanote"></a><font color="#CDAA7D"> 运行 leanote</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/leanote/bin/</span><br><span class="line">bash run.sh</span><br></pre></td></tr></table></figure><p>修改配置文件的<code>http.addr</code>为<code>0.0.0.0</code>可以外部访问leanote服务<br>接下来就可以浏览器访问Leanote这个专为IT人员打造的云笔记系统了。</p><h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a><font color="#5CACEE">备注</font></h2><p>Leanote官网：<a href="https://leanote.com/" target="_blank" rel="noopener">https://leanote.com/</a><br>可以在官网下载Windows客户端 还可以登录到自己搭建的私网leanote服务器</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Leanote是一款开源的云笔记和博客系统 可以很方便的搭建自己的云笔记。在自己的云主机上搭建了Leanote后 就可以抛弃某云笔记了。而且还自带一套博客系统 写好的笔记可以一键生成到博客空间。Leanote还支持注册（注册功能可以关闭）或者手动添加用户，可以让好友也一起用的哦。&lt;br&gt;Github地址: &lt;a href=&quot;https://github.com/leanote/leanote&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://github.com/leanote/leanote&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Leanote" scheme="http://www.yunfwe.cn/categories/Leanote/"/>
    
    
      <category term="Leanote" scheme="http://www.yunfwe.cn/tags/Leanote/"/>
    
  </entry>
  
  <entry>
    <title>Linux挂载多分区的img镜像文件</title>
    <link href="http://www.yunfwe.cn/2018/01/02/2018/Linux%E6%8C%82%E8%BD%BD%E5%A4%9A%E5%88%86%E5%8C%BA%E7%9A%84img%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6/"/>
    <id>http://www.yunfwe.cn/2018/01/02/2018/Linux%E6%8C%82%E8%BD%BD%E5%A4%9A%E5%88%86%E5%8C%BA%E7%9A%84img%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6/</id>
    <published>2018-01-02T06:05:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>有时候想挂载一个img镜像文件到系统目录，发现无法挂载。使用fdisk命令查看镜像结构 发现有多个分区，这个时候需要将所有分区映射为设备文件后才可以挂载。这个用处好像不太多 这个问题是当时为了修改树莓派的ubuntu镜像文件才用的。或者想自己制作一个linux启动镜像的时候可以玩玩。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>当然是在linux下进行操作了</p></blockquote><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="先看看loop设备已经映射了哪些镜像"><a href="#先看看loop设备已经映射了哪些镜像" class="headerlink" title="先看看loop设备已经映射了哪些镜像"></a><font color="#CDAA7D">先看看loop设备已经映射了哪些镜像</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">losetup -a</span><br></pre></td></tr></table></figure><h3 id="将loop设备和img镜像绑定"><a href="#将loop设备和img镜像绑定" class="headerlink" title="将loop设备和img镜像绑定"></a><font color="#CDAA7D">将loop设备和img镜像绑定</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">losetup /dev/loop0 ubuntu-16.04.3.img</span><br></pre></td></tr></table></figure><h3 id="将loop0的所有分区映射出来"><a href="#将loop0的所有分区映射出来" class="headerlink" title="将loop0的所有分区映射出来"></a><font color="#CDAA7D">将loop0的所有分区映射出来</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kpartx -av /dev/loop0</span><br></pre></td></tr></table></figure><pre><code>root@ubuntu-Lenovo:/home/ubuntu# kpartx -av /dev/loop0 add map loop0p1 (253:0): 0 262144 linear 7:0 8192add map loop0p2 (253:1): 0 7540736 linear 7:0 270336</code></pre><h3 id="将用到的分区挂载到目录"><a href="#将用到的分区挂载到目录" class="headerlink" title="将用到的分区挂载到目录"></a><font color="#CDAA7D">将用到的分区挂载到目录</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount /dev/mapper/loop0p2 /mnt/pi/</span><br></pre></td></tr></table></figure><p>需要注意的是映射的设备文件在/dev/mapper/目录下</p><h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a><font color="#CDAA7D">卸载</font></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">umount /mnt/pi/</span><br><span class="line">losetup -d /dev/loop0</span><br></pre></td></tr></table></figure><h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a><font color="#5CACEE">后记</font></h2><p>img镜像里面装个系统 就可以使用qemu等虚拟机启动了 挺好玩的<br>如果遇到无法umount的问题 可以直接使用 <code>fuser -ka /mnt/pi/</code> 强制卸载</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;有时候想挂载一个img镜像文件到系统目录，发现无法挂载。使用fdisk命令查看镜像结构 发现有多个分区，这个时候需要将所有分区映射为设备文件后才可以挂载。这个用处好像不太多 这个问题是当时为了修改树莓派的ubuntu镜像文件才用的。或者想自己制作一个linux启动镜像的时候可以玩玩。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Linux" scheme="http://www.yunfwe.cn/categories/Linux/"/>
    
    
      <category term="Linux" scheme="http://www.yunfwe.cn/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>Subversion(SVN)安装使用</title>
    <link href="http://www.yunfwe.cn/2017/12/22/2017/Subversion(SVN)%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/"/>
    <id>http://www.yunfwe.cn/2017/12/22/2017/Subversion(SVN)%E5%AE%89%E8%A3%85%E4%BD%BF%E7%94%A8/</id>
    <published>2017-12-21T16:00:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>SVN是Subversion的简称，是一个开放源代码的版本控制系统，相较于RCS、CVS，它采用了分支管理系统，它的设计目标就是取代CVS。互联网上很多版本控制服务已从CVS迁移到Subversion。说得简单一点SVN就是用于多个人共同开发同一个项目，共用资源的目的</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><blockquote><p>是在 CentoOS 6.8 上部署的</p></blockquote><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h3><table><thead><tr><th>源码包</th><th>版本</th><th>下载地址</th></tr></thead><tbody><tr><td>Subversion</td><td>1.9.7</td><td><a href="http://mirrors.hust.edu.cn/apache/subversion/subversion-1.9.7.tar.bz2" target="_blank" rel="noopener">点击下载</a></td></tr><tr><td>Sqlite</td><td>3.2.1</td><td><a href="https://www.sqlite.org/2017/sqlite-autoconf-3210000.tar.gz" target="_blank" rel="noopener">点击下载</a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y make gcc apr-devel apr-util-devel zlib-devel</span><br></pre></td></tr></table></figure><h4 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">tar xf subversion-1.9.7.tar.bz2</span><br><span class="line">mkdir subversion-1.9.7/sqlite-amalgamation/</span><br><span class="line">tar xf sqlite-autoconf-3210000.tar.gz -C subversion-1.9.7/sqlite-amalgamation/</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/subversion</span><br><span class="line">make -j4 &amp;&amp; make install</span><br><span class="line">echo &apos;export PATH=$PATH:/usr/local/subversion/bin&apos; &gt; /etc/profile.d/subversion.sh</span><br><span class="line">source /etc/profile.d/subversion.sh</span><br></pre></td></tr></table></figure><h4 id="配置和使用"><a href="#配置和使用" class="headerlink" title="配置和使用"></a>配置和使用</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /data/svn/conf</span><br><span class="line">echo &quot;svn = svn&quot; &gt; passwd        # 修改passwd文件 添加用户和密码 格式：user = password</span><br></pre></td></tr></table></figure><p>修改 <code>authz</code> 对svn用户配置访问权限 在文件末尾添加：</p><pre><code>[/]svn = rw* = r</code></pre><p>修改 <code>svnserve.conf</code> 文件 <code>[general]</code>配置块添加以下内容</p><pre><code>anon-access = readauth-access = writepassword-db = passwdauthz-db = authzrealm = mysvn</code></pre><p><code>svnserve -d -r /date/</code> 启动svn服务<br><code>-d daemon</code>模式  <code>-r</code>指定svn根目录<br>比如指定<code>/data</code>为根 那么访问svn目录就是<code>svn://ip/svn</code>了<br><code>/data</code>下可以用<code>svnadmin</code>创建多个不同的svn目录 每个目录的配置都可以不同<br>也可以直接将<code>-r</code> 指定为<code>/data/svn</code> 那访问<code>snv://ip</code> 就直接访问这个目录了<br><code>-X</code> 前台启动 <code>--listen-port</code> 更改监听端口号 默认<code>3690</code></p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p><code>Windows</code>的svn客户端可以使用<code>TortoiseSVN</code><br>官方地址：<a href="https://tortoisesvn.net/" target="_blank" rel="noopener">https://tortoisesvn.net/</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;SVN是Subversion的简称，是一个开放源代码的版本控制系统，相较于RCS、CVS，它采用了分支管理系统，它的设计目标就是取代CVS。互联网上很多版本控制服务已从CVS迁移到Subversion。说得简单一点SVN就是用于多个人共同开发同一个项目，共用资源的目的&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="SVN" scheme="http://www.yunfwe.cn/categories/SVN/"/>
    
    
      <category term="SVN" scheme="http://www.yunfwe.cn/tags/SVN/"/>
    
  </entry>
  
  <entry>
    <title>Python3编译安装</title>
    <link href="http://www.yunfwe.cn/2017/12/21/2017/Python3%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
    <id>http://www.yunfwe.cn/2017/12/21/2017/Python3%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</id>
    <published>2017-12-20T16:00:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Python是一种面向对象的解释型计算机程序设计语言，由荷兰人Guido van Rossum于1989年发明，第一个公开发行版发行于1991年。Python是纯粹的自由软件， 源代码和解释器CPython遵循GPL协议。<br>Python的用处如今已经非常强大，人工智能、数据处理、Web后端、爬虫、运维等都能见到Python的身影。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><blockquote><p>在 CentoOS 6.8 上编译的</p></blockquote><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h3><table><thead><tr><th>源码包</th><th>版本</th><th>下载地址</th></tr></thead><tbody><tr><td>Python</td><td>3.6.4</td><td><a href="https://www.python.org/ftp/python/3.6.4/Python-3.6.4.tar.xz" target="_blank" rel="noopener">点击下载</a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><blockquote><p>Python的某些模块可以按需编译 比如tkinter sqlite3等 如果不安装它的devel包 Python编译过程中将忽略此模块</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install make gcc gcc-c++ zlib-devel bzip2-devel gdbm-devel \</span><br><span class="line">xz-devel tk-devel readline-devel sqlite-devel ncurses-devel openssl-devel</span><br></pre></td></tr></table></figure><h3 id="开始编译"><a href="#开始编译" class="headerlink" title="开始编译"></a>开始编译</h3><blockquote><p>解压源码包后进入源码目录</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure --enable-optimizations --prefix=/usr/local/python3 --enable-shared</span><br><span class="line">sed -i &apos;s/test.regrtest/this/g&apos; Makefile        # 此步骤屏蔽单元测试（耗时太长）</span><br><span class="line">make -j4</span><br></pre></td></tr></table></figure><p>在make的过程中 如果有标准库中的模块依赖没有找到 标准输出会有显示 内容可能如下</p><pre><code>Python build finished successfully!The necessary bits to build these optional modules were not found:_bz2                  _curses               _curses_panel      _dbm                  _gdbm                 _lzma              _sqlite3              _ssl                  _tkinter           readline              zlib                                     To find the necessary bits, look in setup.py in detect_modules() for the module&apos;s name.</code></pre><p>安装好相应的模块的devel包后 不需要重新configure 重新make即可</p><h3 id="安装使用"><a href="#安装使用" class="headerlink" title="安装使用"></a>安装使用</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">make install </span><br><span class="line">echo &apos;export PATH=$PATH:/usr/local/python3/bin&apos; &gt; /etc/profile.d/python3.sh</span><br><span class="line">echo &apos;/usr/local/python3/lib&apos; &gt; /etc/ld.so.conf.d/python3.conf</span><br><span class="line">ldconfig</span><br><span class="line">source /etc/profile.d/python3.sh</span><br></pre></td></tr></table></figure><h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a>卸载</h3><blockquote><p>删除安装目录就可以了</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">rm -rf /usr/local/python3/</span><br><span class="line">rm -rf /etc/profile.d/python3.sh</span><br><span class="line">rm -rf /etc/ld.so.conf.d/python3.conf</span><br></pre></td></tr></table></figure><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>如果不提前把Python的依赖安装好 虽然可以编译成功 但是会缺少不少的模块</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Python是一种面向对象的解释型计算机程序设计语言，由荷兰人Guido van Rossum于1989年发明，第一个公开发行版发行于1991年。Python是纯粹的自由软件， 源代码和解释器CPython遵循GPL协议。&lt;br&gt;Python的用处如今已经非常强大，人工智能、数据处理、Web后端、爬虫、运维等都能见到Python的身影。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/categories/Python/"/>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>Galera集群编译安装</title>
    <link href="http://www.yunfwe.cn/2017/08/06/2017/Galera%E9%9B%86%E7%BE%A4%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
    <id>http://www.yunfwe.cn/2017/08/06/2017/Galera%E9%9B%86%E7%BE%A4%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</id>
    <published>2017-08-06T01:03:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Galera是一种新型的高一致性MySQL集群架构，集成了Galera插件的MySQL集群，是一种新型的，数据不共享的，高度冗余的高可用方案。当有客户端要写入或者读取数据时，随便连接哪个实例都是一样的，读到的数据是相同的，写入某一个节点之后，集群自己会将新数据同步到其它节点上面，这种架构不共享任何数据，是一种高冗余架构。</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><h3 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h3><blockquote><p>系统使用 CentOS 6.8</p></blockquote><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a>软件环境</h3><table><thead><tr><th>源码包</th><th>版本</th><th>下载地址</th></tr></thead><tbody><tr><td>mysql-wsrep</td><td>None</td><td><a href="http://galeracluster.com/downloads/" target="_blank" rel="noopener">点此自行选择合适的版本下载</a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><blockquote><p>建议查看官方文档：<a href="http://galeracluster.com/documentation-webpages/installmysqlsrc.html" target="_blank" rel="noopener">http://galeracluster.com/documentation-webpages/installmysqlsrc.html</a></p></blockquote><h3 id="安装编译环境"><a href="#安装编译环境" class="headerlink" title="安装编译环境"></a>安装编译环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install make gcc-c++ gcc cmake bison-devel ncurses-devel perl bison git automake \</span><br><span class="line">autoconf libaio libaio-devel  scons  boost  boost-devel openssl-devel openssl check check-devel</span><br></pre></td></tr></table></figure><h3 id="编译mysql"><a href="#编译mysql" class="headerlink" title="编译mysql"></a>编译mysql</h3><blockquote><p>自行下载集成wsrep补丁的MySQL后解压 这里使用MySQL 5.6的版本</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmake  \</span><br><span class="line">-DCMAKE_INSTALL_PREFIX=/usr/local/mysql    \</span><br><span class="line">-DMYSQL_DATADIR=/usr/local/mysql/data    \</span><br><span class="line">-DSYSCONFDIR=/etc   \</span><br><span class="line">-DWITH_WSREP=ON -DWITH_INNODB_DISALLOW_WRITES=ON ./</span><br><span class="line"></span><br><span class="line">make -j10 &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="编译galera插件"><a href="#编译galera插件" class="headerlink" title="编译galera插件"></a>编译galera插件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/codership/galera.git</span><br><span class="line">cd galera</span><br><span class="line">scons</span><br><span class="line">strip libgalera_smm.so      # 裁剪库文件无用的调试信息 减小文件体积</span><br><span class="line">mv libgalera_smm.so /usr/local/mysql/lib/plugin/</span><br><span class="line"># 编译过程耗时较长 可以继续下面的步骤</span><br></pre></td></tr></table></figure><h3 id="初始化mysql运行环境"><a href="#初始化mysql运行环境" class="headerlink" title="初始化mysql运行环境"></a>初始化mysql运行环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">useradd mysql -M -s /sbin/nologin</span><br><span class="line">chown -R mysql:mysql /usr/local/mysql</span><br><span class="line">cp support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">chmod +x /etc/init.d/mysqld</span><br><span class="line">cd /usr/local/mysql</span><br><span class="line">strip bin/* lib/* lib/plugin/*      # 同样进行裁剪</span><br><span class="line">scripts/mysql_install_db --datadir=/usr/local/mysql/data/ --user=mysql</span><br><span class="line">echo /usr/local/mysql/lib &gt; /etc/ld.so.conf.d/mysql5.6.conf</span><br><span class="line">ldconfig -v |grep /usr/local/mysql/lib   # 查看/usr/local/mysql/lib是否被加入到系统运行库中</span><br><span class="line">echo &apos;export PATH=$PATH:/usr/local/mysql/bin&apos; &gt; /etc/profile.d/mysql5.6.sh</span><br><span class="line">source /etc/profile</span><br><span class="line">mkdir -p /etc/mysql/conf.d</span><br><span class="line">mkdir /var/lib/mysql</span><br></pre></td></tr></table></figure><h3 id="修改配置文件"><a href="#修改配置文件" class="headerlink" title="修改配置文件"></a>修改配置文件</h3><p><strong>修改</strong> <code>/etc/my.cnf</code></p><pre><code>[mysql]!includedir /etc/mysql/conf.d/</code></pre><p><strong>编辑</strong> <code>/etc/mysql/conf.d/my_galera.cnf</code></p><pre><code>[mysql]#设置mysql client default characterdefault-character-set=utf8no-auto-rehashprompt=&quot;\\u@\\h:\\d \\r:\\m:\\s&gt;&quot;[mysqld]user=mysqlbind-address=0.0.0.0character-set-server=utf8default-storage-engine=INNODBdefault-time-zone=&apos;+8:00&apos;datadir=/usr/local/mysql/data/socket=/usr/local/mysql/data/mysql.sockskip-name-resolve#slow queryslow_query_log=onlog_output=FILEslow_query_log_file=slow_query.txtlong_query_time=1max_connections=5000table_open_cache=2048sort_buffer_size=8Mthread_cache_size=16#query_cache_size=32M  #galera: Do not use query cache# Try number of CPU&apos;s*2 for thread_concurrencythread_concurrency=8#MyISAMkey_buffer_size=512Mread_buffer_size=8Mread_rnd_buffer_size=8M#InnoDBinnodb_buffer_pool_size=1Ginnodb_additional_mem_pool_size=20M#galera innodb参数binlog_format=ROWinnodb_autoinc_lock_mode=2innodb_flush_log_at_trx_commit=0transaction-isolation=READ-COMMITTED#galera cluster参数wsrep_provider=/usr/local/mysql/lib/plugin/libgalera_smm.sowsrep_provider_options=&quot;gcache.size=300M; gcache.page_size=1G&quot;wsrep_sst_method=rsyncwsrep_sst_auth=wsrep_sst-user:123456wsrep_cluster_name=MyClusterwsrep_cluster_address=&quot;gcomm://&quot;wsrep_node_name=galera.node1wsrep_node_address=&quot;172.17.0.3&quot;</code></pre><p><strong>注意</strong>：根据实际情况更改配置文件，第一个启动的节点<code>wsrep_cluster_address</code>的值为<code>gcomm://</code>，其他节点启动的时候要将这个值改为第一个节点的IP 比如<code>gcomm://172.17.0.3</code>。<br><code>wsrep_node_address</code>修改为自己的IP就好了</p><h3 id="启动集群"><a href="#启动集群" class="headerlink" title="启动集群"></a>启动集群</h3><blockquote><p>先启动集群的第一个节点 也就是<code>wsrep_cluster_address</code>的值为<code>gcomm://</code>的那个节点，然后依次启动其他的就好了。</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">service mysqld start</span><br></pre></td></tr></table></figure><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>Galera集群好像并不是那么可靠。。。 机器的数据越多 性能的提升率就越低。</p><p>参考文章：<a href="http://www.sohu.com/a/147032902_505779" target="_blank" rel="noopener">http://www.sohu.com/a/147032902_505779</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Galera是一种新型的高一致性MySQL集群架构，集成了Galera插件的MySQL集群，是一种新型的，数据不共享的，高度冗余的高可用方案。当有客户端要写入或者读取数据时，随便连接哪个实例都是一样的，读到的数据是相同的，写入某一个节点之后，集群自己会将新数据同步到其它节点上面，这种架构不共享任何数据，是一种高冗余架构。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://www.yunfwe.cn/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="http://www.yunfwe.cn/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>Apache编译安装</title>
    <link href="http://www.yunfwe.cn/2016/09/21/2016/Apache%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
    <id>http://www.yunfwe.cn/2016/09/21/2016/Apache%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</id>
    <published>2016-09-21T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><p>Apache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。它快速、可靠并且可通过简单的API扩充，将Perl/Python等解释器编译到服务器中。同时Apache音译为阿帕奇，是北美印第安人的一个部落，叫阿帕奇族，在美国的西南部。也是一个基金会的名称、一种武装直升机等等<br><a id="more"></a></p><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>pcre</td><td style="text-align:center">8.39</td><td style="text-align:right"><a href="http://heanet.dl.sourceforge.net/project/pcre/pcre/8.39/pcre-8.39.tar.bz2" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>openssl</td><td style="text-align:center">1.0.1s</td><td style="text-align:right"><a href="http://www.openssl.org/source/openssl-1.0.1s.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>apr</td><td style="text-align:center">1.5.2</td><td style="text-align:right"><a href="http://mirrors.aliyun.com/apache/apr/apr-1.5.2.tar.bz2" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>apr-util</td><td style="text-align:center">1.5.4</td><td style="text-align:right"><a href="http://mirrors.aliyun.com/apache/apr/apr-util-1.5.4.tar.bz2" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>httpd</td><td style="text-align:center">2.4.23</td><td style="text-align:right"><a href="http://mirrors.aliyun.com/apache/httpd/httpd-2.4.23.tar.bz2" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><blockquote><p>需要系统先初始化开发环境</p></blockquote><pre><code>yum install -y make gcc gcc-c++ perl tar bzip2 vim</code></pre><h3 id="编译安装apr和apr-util"><a href="#编译安装apr和apr-util" class="headerlink" title="编译安装apr和apr-util"></a>编译安装apr和apr-util</h3><blockquote><p>apr 和 apr-util 是 httpd 的运行依赖</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># apr-1.5.2</span><br><span class="line">tar xf apr-1.5.2.tar.bz2</span><br><span class="line">cd apr-1.5.2 </span><br><span class="line">./configure --prefix=/usr/local/apr</span><br><span class="line">make -j4 &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"># apr-util-1.5.4</span><br><span class="line">tar xf apr-util-1.5.4.tar.bz2</span><br><span class="line">cd apr-util-1.5.4</span><br><span class="line">./configure --prefix=/usr/local/apr-util --with-apr=/usr/local/apr/</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="编译安装pcre"><a href="#编译安装pcre" class="headerlink" title="编译安装pcre"></a>编译安装pcre</h3><blockquote><p>pcre是一个perl的正则表达式库 httpd的rewrite需要用到</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf pcre-8.39.tar.bz2</span><br><span class="line">cd pcre-8.39</span><br><span class="line">./configure --prefix=/usr/local/pcre</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="编译安装openssl"><a href="#编译安装openssl" class="headerlink" title="编译安装openssl"></a>编译安装openssl</h3><blockquote><p>OpenSSL 是一个强大的安全套接字层密码库 搭建https的网站需要用到</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf openssl-1.0.1s.tar.gz</span><br><span class="line">cd openssl-1.0.1s</span><br><span class="line">./config  -fPIC no-shared</span><br><span class="line">make depend &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="编译安装httpd"><a href="#编译安装httpd" class="headerlink" title="编译安装httpd"></a>编译安装httpd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">tar xf httpd-2.4.23.tar.bz2</span><br><span class="line">cd httpd-2.4.23</span><br><span class="line">./configure --prefix=/usr/local/httpd \</span><br><span class="line">--enable-ssl --enable-cgi  \</span><br><span class="line">--enable-rewrite  --enable-so \</span><br><span class="line">--with-pcre --with-apr=/usr/local/apr \</span><br><span class="line">--with-apr-util=/usr/local/apr-util/ \</span><br><span class="line">--with-pcre=/usr/local/pcre/ \</span><br><span class="line">--with-ssl=/usr/local/ssl \</span><br><span class="line">--with-mpm=event --with-zlib</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="运行httpd"><a href="#运行httpd" class="headerlink" title="运行httpd"></a>运行httpd</h3><blockquote><p>httpd默认运行用户是daemon 若不存在需要先创建 也可以在配置文件中重新指定运行用户</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">修改配置文件</span><br><span class="line">vim /usr/local/httpd/conf/httpd.conf</span><br><span class="line">添加：ServerName localhost</span><br><span class="line"></span><br><span class="line">不添加这行配置 httpd服务也是可以正常启动的 但是会弹出提示</span><br><span class="line">然后就可以启动httpd服务了</span><br><span class="line"></span><br><span class="line">/usr/local/httpd/bin/httpd</span><br><span class="line"></span><br><span class="line">检查httpd是否正常监听</span><br><span class="line">netstat -anpt |grep httpd</span><br><span class="line">tcp    0   0 :::80           :::*            LISTEN      51272/httpd</span><br><span class="line"></span><br><span class="line">通过浏览器访问服务器 看是否出现了大大的 It works!</span><br></pre></td></tr></table></figure><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><p>httpd的主要目录作用</p><pre><code>ls /usr/local/httpd/bin  build  cgi-bin  conf  error  htdocs  icons  include  logs  man  manual  modulesbin:        存放着apache提供的一些小工具和httpd主程序cgi-bin:    存放cgi脚本的目录conf:       存放httpd的配置文件 主配置文件为httpd.confhtdocs:     web的默认根目录 存放网页文件logs:       存放着httpd的访问日志 错误日志 以及pid文件modules:    存放着httpd动态编译的模块 比如刚才的openssl就被编译为了mod_ssl.so</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;p&gt;Apache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。它快速、可靠并且可通过简单的API扩充，将Perl/Python等解释器编译到服务器中。同时Apache音译为阿帕奇，是北美印第安人的一个部落，叫阿帕奇族，在美国的西南部。也是一个基金会的名称、一种武装直升机等等&lt;br&gt;
    
    </summary>
    
    
      <category term="Apache" scheme="http://www.yunfwe.cn/categories/Apache/"/>
    
    
      <category term="Apache" scheme="http://www.yunfwe.cn/tags/Apache/"/>
    
  </entry>
  
  <entry>
    <title>Python爬虫入门</title>
    <link href="http://www.yunfwe.cn/2016/07/25/2016/Python%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/"/>
    <id>http://www.yunfwe.cn/2016/07/25/2016/Python%E7%88%AC%E8%99%AB%E5%85%A5%E9%97%A8/</id>
    <published>2016-07-25T07:11:41.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>网络爬虫是一个自动提取网页的程序，它为搜索引擎从万维网上下载网页，是搜索引擎的重要组成。比如百度 google等搜索引擎通过程序爬取你的个人网站，然后建立索引 这样别人就可以通过搜索关键字找到你的网站了。爬虫的意义不仅如此 还可以做更多好玩的事情。</p></blockquote><a id="more"></a><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><blockquote><p>用Python写网络爬虫是非常简单的 大致需要学习以下知识点</p></blockquote><ul><li>了解HTTP协议 以及HTML标签等</li><li>掌握Python的基本语法</li><li>学习Python的urllib, urllib2等模块</li><li>学习正则表达式 或者XPath</li><li>使用Python爬虫框架帮助开发</li></ul><h2 id="学习"><a href="#学习" class="headerlink" title="学习"></a><font color="#5CACEE">学习</font></h2><p>网络爬虫 也有人称之为网络蜘蛛 互联网是一张大网 每个人都可以在上面搭建网站 平常我们用的百度搜索的所有内容 都是百度曾经访问过的内容 然后保存下来 建立了索引 这样才能供用户查询 能快速的找到自己想要的资源 而百度去访问这些网站资源 肯定不可能人工手动去访问然后记录 背后都是一个一个的程序去抓取网页 然后根据这个网页继续往下抓取 直到收集到需要的信息 就像一个爬虫或蜘蛛 在这张大网上爬来爬去一样 来自互联网的流量 有不小的一部分并不是人为访问的 而是各大搜索引擎的爬虫程序 </p><p>可以写爬虫的语言非常多 但是因为python的简单 方便 越来越多的人使用python来写爬虫 也出现了各种优秀的爬虫框架 下面将由浅入深 一步一步的学习 如和使用python来写一个爬虫</p><h3 id="了解HTTP协议"><a href="#了解HTTP协议" class="headerlink" title="了解HTTP协议"></a><font color="#CDAA7D">了解HTTP协议</font></h3><blockquote><p>HTTP 全称 HyperText Transfer Protocol(超文本传输协议)，设计之初就是为了提供一种收发HTML页面的方法 下面详细看看一个URL是如何组成的</p></blockquote><h4 id="URL的含义"><a href="#URL的含义" class="headerlink" title="URL的含义"></a><font color="#DDA0DD">URL的含义</font></h4><blockquote><p>URL是URI的子集 关于URI的相关内容 这里不再解释 具体可以问度娘。URL 全称Universal Resource Identifier(统一资源定位符) 结构组成如下</p></blockquote><pre><code>比如我们看这样一个URL http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.28.tar.gzhttp://部分是协议部分还有类似的https, ftp, mailto, file等 作用是让程序知道如和处理要打开的资源dev.mysql.com 部分是主机名或者IP 还可以加端口号 用:隔开 比如dev.mysql.com:8080 默认的端口是80/get/Downloads/MySQL-5.6/mysql-5.6.28.tar.gz 就是服务器上的文件资源基于web根目录的绝对路径了</code></pre><h4 id="一次完整的HTTP请求"><a href="#一次完整的HTTP请求" class="headerlink" title="一次完整的HTTP请求"></a><font color="#DDA0DD">一次完整的HTTP请求</font></h4><ul><li>浏览器输入URL 比如 <a href="http://www.baidu.com/" target="_blank" rel="noopener">http://www.baidu.com/</a></li><li>向DNS服务器查询<a href="http://www.baidu.com的IP地址" target="_blank" rel="noopener">www.baidu.com的IP地址</a> 然后连接这个IP地址的80端口 </li><li>如果成功连接到了80端口 浏览器发起http请求(Request) 通过GET方法 访问服务器的/</li><li>服务器收到请求 如果是静态资源 比如图片之类的 读取文件后相应(Response)给客户端</li><li>如果请求的是.jsp或者.php等脚本 将由相应的后端程序处理 然后将生成的html页面返回给客户端</li><li>一次请求完成 服务端主动关闭连接 客户端解析获取的html页面 然后继续发起其他资源的请求</li><li>如果请求失败 服务器会有一个返回码 正常状态的返回码都是200 比如还有较为常见的404等</li></ul><h4 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a><font color="#DDA0DD">HTTP协议</font></h4><blockquote><p>HTTP协议的重点就在客户机发送的Request 和服务端返回的Response上 他们是按照怎样的格式发送的呢</p></blockquote><p><strong>Request：</strong></p><pre><code>GET /login.html HTTP/1.1Host: www.abc.comConnection: keep-aliveReferer: www.abc.comUser-Agent: Python-urllib/2.7GET 是HTTP方法 常用的还有POST方法 通过GET方法传递的参数直接编码为URL的一部分 比如/login.html?user=username&amp;passwd=password 请求login.html的同时传递了user和passwd两个参数而POST方法则不会 所以POST适合于密码传输 而且POST传递的数据没有大小限制 适合传递较大的文件Referer字段标识这个请求时从哪个链接上发起的 服务端可以通过此字段设置防盗链 也是爬虫需要注意的User-Agent字段是客户机标识自己的身份 有时候服务端会限制一些User-Agent的访问 但是爬虫可以伪装</code></pre><p><strong>Response：</strong></p><pre><code>HTTP/1.1 200 OKDate: Mon, 25 Jul 2016 12:59:31 GMTContent-Length: 10901Content-Type: text/html200的返回的状态码 OK是简单的描述 常见的400以上的错误为客户端请求的错误 500以上为服务端错误Content-Length字段告诉客户端响应内容主体的大小Content-Type字段告诉客户端返回内容的类型 比如图片的就是image/png 还有非常多的类型Request和Response的还有非常多的字段 暂时先简单了解下即可 下面开始进入正题</code></pre><h3 id="urllib库的基本使用"><a href="#urllib库的基本使用" class="headerlink" title="urllib库的基本使用"></a><font color="#CDAA7D">urllib库的基本使用</font></h3><blockquote><p>用爬虫挖掘数据的三个步骤: <strong>获取网页数据</strong> --&gt; <strong>从数据中检索需要的数据</strong> --&gt; <strong>将数据保存入库</strong><br>先来研究爬虫的第一步 获取网页数据。python获取网页数据的标准库有urllib2 还有一些非常好用的第三方库 比如requests库 python的urllib库有两个 一个是urllib 另一个是urllib2 这两个库并不是可以互相替代的关系 反而是互补的关系 下面看一个最简单的爬虫</p></blockquote><h4 id="第一个简单的爬虫"><a href="#第一个简单的爬虫" class="headerlink" title="第一个简单的爬虫"></a><font color="#DDA0DD">第一个简单的爬虫</font></h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">response = urllib2.urlopen(<span class="string">"http://www.baidu.com/"</span>)</span><br><span class="line"><span class="keyword">print</span> response.code</span><br><span class="line"><span class="keyword">print</span> response.read()</span><br></pre></td></tr></table></figure><pre><code>200&lt;!DOCTYPE html&gt;&lt;!--STATUS OK--&gt;&lt;html&gt;&lt;head&gt;&lt;meta http-equiv=&quot;content-type&quot; ......urllib2.urlopen类可以发起一个request的请求 用它打开链接就相当于浏览器请求一样response.code是响应的状态码 response.read()则读取了访问baidu后获取的网页源代码下面看看urlopen()类的常用参数</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urllib2.urlopen(url, data=None, timeout=socket)</span><br></pre></td></tr></table></figure><pre><code>url参数 顾名思义 就是要访问的地址 这个参数还可以是一个urllib2.Request的对象 下面会讲到默认urlopen使用了GET方法 如果给urlopen提供了data参数 则urlopen将使用POST方法提交数据timeout则是访问超时时间 超过多长时间后如果还没有等到服务器响应数据 则抛出URLError异常</code></pre><h4 id="手动构造Request"><a href="#手动构造Request" class="headerlink" title="手动构造Request"></a><font color="#DDA0DD">手动构造Request</font></h4><blockquote><p>手动构造Request的好处就是自己可以添加或修改Request的字段 比如修改User-Agent把自己伪装为浏览器去访问页面 urllib2访问网页的默认User-Agent是Python-urllib/2.7</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">request = urllib2.Request(<span class="string">"http://www.baidu.com/"</span>)</span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="keyword">print</span> response.read()</span><br></pre></td></tr></table></figure><p>Request类允许用户自定义请求头部(header), 同样Request默认使用的也是GET方法 下面看看Request用法 </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">urllib2.Request(url, data=<span class="literal">None</span>, headers=&#123;&#125;)</span><br></pre></td></tr></table></figure><pre><code>如果给Request提供了data的值 那么请求将变成POST</code></pre><h4 id="Headers信息修改"><a href="#Headers信息修改" class="headerlink" title="Headers信息修改"></a><font color="#DDA0DD">Headers信息修改</font></h4><blockquote><p>为了直观的看到headers的变化 我们先用socket模块 模拟一个web服务器出来</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">s = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">s.bind((<span class="string">'0.0.0.0'</span>,<span class="number">8080</span>))</span><br><span class="line">s.listen(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">print</span> <span class="string">'Listen on 0.0.0.0:8080...'</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        conn,addr = s.accept()</span><br><span class="line">        <span class="keyword">print</span> conn.recv(<span class="number">99999</span>)</span><br><span class="line">        conn.send(<span class="string">'HTTP/1.1 200 OK\r\nContent-Type: text/html\r\n\r\n&lt;h1&gt;Hello!&lt;/h1&gt;'</span>)</span><br><span class="line">        conn.close()</span><br><span class="line"><span class="keyword">except</span>:</span><br><span class="line">    s.close()</span><br></pre></td></tr></table></figure><pre><code>将这个脚本启动 先确定8080端口未被占用 或者自行修改端口 接着尝试用urllib2打开这个地址GET / HTTP/1.1Accept-Encoding: identityHost: 192.168.4.233:8080Connection: closeUser-Agent: Python-urllib/2.7可以看到脚本输出了这样的信息 这个就是服务接受到urlopen发送的数据 可以看到是GET请求有很多web网站为了防止爬虫的访问 做了User-Agent检查 如果发现不是正规浏览器访问的就会拒绝掉那么现在尝试着修改下User-Agent的值</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/47.0.2526.106 BIDUBrowser/8.5 Safari/537.36'</span></span><br><span class="line">    &#125;</span><br><span class="line">request = urllib2.Request(<span class="string">'http://192.168.4.233:8080'</span>,headers=headers)</span><br><span class="line">response = urllib2.urlopen(request)</span><br></pre></td></tr></table></figure><p>可以将创立好的headers字典传递给Request的headers参数 也可以创建完Request对象后 手动将headers字典赋值给request.headers属性 或者通过request对象的add_header方法添加</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">request.headers = headers       <span class="comment"># 或者</span></span><br><span class="line">request.add_header(<span class="string">'User-Agent'</span>,<span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64)......'</span>)</span><br></pre></td></tr></table></figure><p>以上两种方法是等效的 但是不同的是 add_header只能一次添加一个头部字段 而通过传递字典可以添加多个<br>比如我们可以针对做了防盗链处理的网站服务器 在request中添加Referer字段 表明示从那个页面发起访问的</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">headers = &#123;</span><br><span class="line">    <span class="string">'User-Agent'</span>:<span class="string">'Mozilla/5.0 (Windows NT 10.0; WOW64)......'</span>,</span><br><span class="line">    <span class="string">'Referer'</span>: <span class="string">'192.168.4.233:8080'</span></span><br><span class="line">    &#125;</span><br><span class="line">request = urllib2.Request(<span class="string">'http://192.168.4.233:8080'</span>,headers=headers)</span><br><span class="line">response = urllib2.urlopen(request)</span><br></pre></td></tr></table></figure><pre><code>接下来可以看到打印的headers中的User-Agent已经改变了 而且多了Referer字段GET / HTTP/1.1Accept-Encoding: identityHost: 192.168.4.233:8080Referer: 192.168.4.233:8080Connection: closeUser-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64)......各大浏览器的User-Agent的值可以通过百度查询得到 也可以在浏览器中 通过开发者模式的network里查到</code></pre><h4 id="GET和POST方法传递数据"><a href="#GET和POST方法传递数据" class="headerlink" title="GET和POST方法传递数据"></a><font color="#DDA0DD">GET和POST方法传递数据</font></h4><blockquote><p>如果仅仅访问静态页面 简单的GET请求数据就可以了 但是现在大多的网站都是动态网站 需要向服务器传递一些数据才能获取想要的页面 比如有些页面必须登陆才可以浏览等 下面就看看如何使用urllib发送GET和POST请求</p></blockquote><pre><code>接下来就需要使用urllib模块中的urlencode方法对数据进行编码为适合在HTTP上传输的类型了</code></pre><p><strong>GET方法：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib, urllib2</span><br><span class="line">values = &#123;<span class="string">'user'</span>:<span class="string">'myusername'</span>,<span class="string">'passwd'</span>:<span class="string">'11223344'</span>&#125;</span><br><span class="line">data = urllib.urlencode(values)</span><br><span class="line">url = <span class="string">'http://192.168.4.233:8080/login?'</span></span><br><span class="line">request = urllib2.Request(url+data)</span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="keyword">print</span> response.read()</span><br></pre></td></tr></table></figure><pre><code>GET /login?passwd=11223344&amp;user=myusername HTTP/1.1Accept-Encoding: identityHost: 192.168.4.233:8080Connection: closeUser-Agent: Python-urllib/2.7最后我们实际请求的URL是 http://192.168.4.233:8080/login?passwd=11223344&amp;user=myusername用?分隔服务器资源和向资源传递的参数 参数中用key=value的方式 两个key之间用&amp;隔开如果value中有特殊字符了 比如空格 = 等特殊字符怎么处理 详细资料可以看urlencode和urldecodeGET方法直接将需要传递的数据构造为URL的一部分 如果传送密码这样敏感的数据当然是不可以的接下来就用到POST方法了</code></pre><p><strong>POST方法：</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib, urllib2</span><br><span class="line">values = &#123;<span class="string">'user'</span>:<span class="string">'myusername'</span>,<span class="string">'passwd'</span>:<span class="string">'11223344'</span>&#125;</span><br><span class="line">data = urllib.urlencode(values)</span><br><span class="line">url = <span class="string">'http://192.168.4.233:8080/login'</span>     <span class="comment"># 因为不是GET方法 所以不需要?号分隔了</span></span><br><span class="line">request = urllib2.Request(url,data)         <span class="comment"># 注意是逗号隔开的 实际上是将data传递给了参数data</span></span><br><span class="line">response = urllib2.urlopen(request)</span><br><span class="line"><span class="keyword">print</span> response.read()</span><br></pre></td></tr></table></figure><pre><code>可以看到这回构造的request和GET方法构造的有很大不同POST /login HTTP/1.1Accept-Encoding: identityContent-Length: 31Host: 192.168.4.233:8080Content-Type: application/x-www-form-urlencodedConnection: closeUser-Agent: Python-urllib/2.7passwd=11223344&amp;user=myusername可以看到 多了Content-Length和Content-Type两个字段 一个说明内容的长度 一个说明内容类型而且数据内容并不是直接显示在URL中的 这样就适合传送比较大的数据或者比较敏感的数据还有一点需要注意 POST请求传递的数据可以是任意格式的 并不一定非要是通过urlencode编码后的数据比如直接传输一个二进制文件 request = urllib2.Request(url,data=open(&apos;/bin/bash&apos;,&apos;rb&apos;).read())还有一个比较重要的地方就是Content-Type 这个字段决定了服务器或者客户端如和处理接收到的内容如果传送的二进制数据 不确定类型的话 可以将Content-Type更改为application/octet-stream具体其他类型的数据的Content-Type可以查阅 &quot;HTTP Content-type 对照表&quot;</code></pre><h4 id="使用Proxy访问网页"><a href="#使用Proxy访问网页" class="headerlink" title="使用Proxy访问网页"></a><font color="#DDA0DD">使用Proxy访问网页</font></h4><blockquote><p>有些网站为了防止被爬虫程序 或者被Ddos攻击等 限定了单位时间内对服务器的请求次数 但是道高一尺魔高一丈 爬虫程序还是有方式绕过限制的 那就是使用代理</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setProxy</span><span class="params">(addr)</span>:</span></span><br><span class="line">    proxy_handler = urllib2.ProxyHandler(&#123;<span class="string">"http"</span> : addr&#125;)</span><br><span class="line">    opener = urllib2.build_opener(proxy_handler)</span><br><span class="line">    urllib2.install_opener(opener)</span><br><span class="line"></span><br><span class="line">request = urllib2.Request(<span class="string">'http://cip.cc/'</span>)</span><br><span class="line">request.add_header(<span class="string">'User-Agent'</span>,<span class="string">'curl'</span>)</span><br><span class="line"><span class="keyword">print</span> urllib2.urlopen(request).read()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'-------------proxy-------------'</span></span><br><span class="line">setProxy(<span class="string">'122.96.xx.xxx:8080'</span>)</span><br><span class="line"><span class="keyword">print</span> urllib2.urlopen(request).read()</span><br></pre></td></tr></table></figure><pre><code>IP    : 124.65.xxx.xx地址    : 中国  北京市运营商    : 联通数据二    : 北京市 | 联通URL    : http://www.cip.cc/124.65.xx.xx-------------proxy-------------IP    : 122.96.xx.xxx地址    : 中国  江苏省  南京市运营商    : 联通数据二    : 江苏省南京市 | 联通URL    : http://www.cip.cc/122.96.xx.xxxcip.cc是个可以查询出口公网IP地址的网站 并且对curl工具的访问做了优化 所以模拟为curl工具访问proxy_handler是使用代理的处理器 build_opener添加配置好的proxy_handler代理器 返回一个对象这个对象也有个open方法 这个方法可以像urllib2.urlopen一样使用 不同的是只有open才会使用代理install_opener则会创建一个全局使用的opener 也就是说 urllib2.urlopen的默认行为也会使用代理来看下面的例子</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">proxy_handler = urllib2.ProxyHandler(&#123;<span class="string">"http"</span> : <span class="string">'122.96.xx.xxx:8080'</span>&#125;)</span><br><span class="line">opener = urllib2.build_opener(proxy_handler)</span><br><span class="line">request = urllib2.Request(<span class="string">'http://cip.cc/'</span>)</span><br><span class="line">request.add_header(<span class="string">'User-Agent'</span>,<span class="string">'curl'</span>)</span><br><span class="line"><span class="keyword">print</span> urllib2.urlopen(request).read()</span><br><span class="line"><span class="keyword">print</span> <span class="string">'-------------opener-------------'</span></span><br><span class="line"><span class="keyword">print</span> opener.open(request).read()</span><br></pre></td></tr></table></figure><pre><code>IP    : 124.65.xxx.xx地址    : 中国  北京市运营商    : 联通数据二    : 北京市 | 联通URL    : http://www.cip.cc/124.65.xx.xx-------------opener-------------IP    : 122.96.xx.xxx地址    : 中国  江苏省  南京市运营商    : 联通数据二    : 江苏省南京市 | 联通URL    : http://www.cip.cc/122.96.xx.xxx可以看到效果是完全相同的 只不过opener.open是局部的 而urllib2.urlopen是全局的通过install_opener则可以把opener.open安装为全局的 build_opener还可以安装多个不同的Handler</code></pre><h4 id="开启Debug日志"><a href="#开启Debug日志" class="headerlink" title="开启Debug日志"></a><font color="#DDA0DD">开启Debug日志</font></h4><blockquote><p>开启urllib的Debug日志后 每次完成一次与服务器交互 都会将打印出request和response信息 这样更方便调试错误</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">proxy_handler = urllib2.ProxyHandler(&#123;<span class="string">"http"</span> : <span class="string">'122.96.xx.xxx:8080'</span>&#125;)</span><br><span class="line">http_handler = urllib2.HTTPHandler(debuglevel=<span class="number">1</span>)</span><br><span class="line">opener = urllib2.build_opener(proxy_handler, http_handler)</span><br><span class="line">request = urllib2.Request(<span class="string">'http://cip.cc/'</span>)</span><br><span class="line">request.add_header(<span class="string">'User-Agent'</span>,<span class="string">'curl'</span>)</span><br><span class="line"><span class="keyword">print</span> opener.open(request).read()</span><br></pre></td></tr></table></figure><pre><code>同时给build_opener传入了两个处理器 执行opener.open的时候 可以发现两个处理器都生效了 以下是返回数据send: &apos;GET http://cip.cc/ HTTP/1.1\r\nAccept-Encoding: identity\r\nHost: cip.cc\r\nConnection: close\r\nUser-Agent: curl\r\n\r\n&apos;reply: &apos;HTTP/1.1 200 OK\r\n&apos;header: Server: nginxheader: Date: Tue, 26 Jul 2016 04:57:13 GMTheader: Content-Type: text/html; charset=UTF-8header: Transfer-Encoding: chunkedheader: Connection: closeheader: Vary: Accept-EncodingIP    : 122.96.xx.xxx地址    : 中国  江苏省  南京市运营商    : 联通数据二    : 江苏省南京市 | 联通URL    : http://www.cip.cc/122.96.xx.xxxsend就是发送的request 而reply就是服务器的response了 如果是https页面 则需要设置HTTPSHandlerurllib2.build_opener(proxy_handler, http_handler, urllib2.HTTPSHandler(debuglevel=1))</code></pre><h4 id="使用cookie模拟登陆"><a href="#使用cookie模拟登陆" class="headerlink" title="使用cookie模拟登陆"></a><font color="#DDA0DD">使用cookie模拟登陆</font></h4><blockquote><p>HTTP协议是无状态的 也就是说你这次的请求 和下次的请求并没有联系 那么这样子 服务器怎么区分用户的身份呢 那么就是cookie的作用了<br>可以这样理解 当用户登录网站成功了 网站就给这个用户下发一个令牌 也就是cookie 下次用户再访问网站的其他页面的时候 就顺便带上令牌 那么服务器端只要区分不同的令牌就知道用户的身份了<br>所以 cookie是一个非常方便 又同时非常危险的东西 比如我在局域网中 抓取到某人登陆某网站的cookie 然后我就可以直接使用该cookie访问这个网站 那么就实现了免密码登陆了 这也是为什么很多敏感的网站cookie的有效期这么短 下次访问就有可能需要重新登陆的原因了 下面就看看urllib如和处理cookie和cookie模拟登陆的吧</p></blockquote><p><strong>使用已有的cookie登陆百度：</strong></p><pre><code>已登录网站的cookie可以通过开发者模式获取 这里以Chrome内核的浏览器为例 360浏览器等都相同一般F12都可以直接打开开发者模式 然后点击 Network 刷新下你已经登陆了的百度的首页 然后看到Network -&gt; Name块出现了一堆请求的资源 找到www.baidu.com 打开后就可以看到Headers了找到Request Headers中的Cookie字段 可以看到一大堆的字符串 这个字符串是经过加密的 复制下来</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line">request = urllib2.Request(<span class="string">'http://www.baidu.com/'</span>)</span><br><span class="line">request.add_header(<span class="string">'Cookie'</span>,<span class="string">'BD_CK_SAM=1; H_PS_645EC=0c53pNyqSabVK%2BP......'</span>)</span><br><span class="line">result = urllib2.urlopen(request).read()</span><br><span class="line">open(<span class="string">'baidu.html'</span>,<span class="string">'w'</span>).write(result)</span><br></pre></td></tr></table></figure><pre><code>可以将url换成tieba.baidu.com 然后去访问百度贴吧 看看保存到本地的网页是不是已经登陆状态呢这就是最简单的用cookie模拟登陆的方法了 但是我们不可能每次都通过这种方式获取cookie吧这就需要用程序实现如和使用账号密码登陆 然后保存cookie 然后用cookie访问其他页面</code></pre><p><strong>使用账号密码登陆：</strong></p><pre><code>这个环节其实是非常复杂的 因为现在的大多网站 为了避免爬虫等工具 登陆需要短信验证 验证码验证等而且密码可能被先经过算法加密后才上传的 甚至登陆的步骤还有非常多的坑 开发者模式以后将经常用到这里的例子使用了公司内部的网站实现数据自动提交</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"><span class="keyword">import</span> cookielib</span><br><span class="line">cookie = cookielib.CookieJar()</span><br><span class="line">cookie_handler = urllib2.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib2.build_opener(cookie_handler)</span><br><span class="line">login_info = urllib.urlencode(&#123;<span class="string">'sysName'</span>:<span class="string">'aabbcc'</span>,<span class="string">'sysPsw'</span>:<span class="string">'112233'</span>&#125;)</span><br><span class="line">resp = opener.open(<span class="string">'http://16.190.x.xxx/sysLoginAction.jsp'</span>,data=login_info,timeout=<span class="number">20</span>)</span><br><span class="line">post_data = <span class="string">'city1=%C8%FD%D1%C7&amp;zt1=%B9%CA%D5%CF%A3%ACrds%C8%EB%BF%E2%CD%A3%D6%B9'</span></span><br><span class="line">post_url = <span class="string">'http://16.190.1.207/thesisFlatRoot/save_info1.jsp?ls=0'</span></span><br><span class="line">resp = opener.open(post_url,data=post_data,timeout=<span class="number">20</span>)</span><br></pre></td></tr></table></figure><pre><code>代码没有任何的异常捕捉 就假设可以正常的执行完毕 这里引入了新库 cookielib这个库是专门处理cookie的库 同样也是安装给opener 然后模拟登陆后带着获取的cookie去提交数据这个login_info是通过开发者模式中 手动登录一次网站 然后分析想后端服务器POST的什么数据而post_data则是每天的任务中点击提交按钮实际上POST上去的数据 通过脚本就不用每天登陆提交了CookieJar是将cookie保存到一个变量中的 还可以将Cookie保存到文件中 这样就不用每次都登陆了</code></pre><p><strong>将cookie保存到文件</strong></p><pre><code>保存cookie到文件的对象是FileCookieJar 我们使用它的子类MozillaCookieJar来实现</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2,cookielib</span><br><span class="line">cookie_file = <span class="string">'cookie.txt'</span></span><br><span class="line">cookie = cookielib.MozillaCookieJar(cookie_file)</span><br><span class="line">cookie_handler = urllib2.HTTPCookieProcessor(cookie)</span><br><span class="line">opener = urllib2.build_opener(cookie_handler)</span><br><span class="line">response = opener.open(<span class="string">"http://www.baidu.com/"</span>)</span><br><span class="line">cookie.save(ignore_discard=<span class="literal">True</span>, ignore_expires=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure><pre><code>ignore_discard的意思是即使cookies将被丢弃也将它保存下来ignore_expires的意思是如果在该文件中cookies已经存在 则覆盖原文件写入可以看到当前目录出现了cookie.txt 接下来就是看看如何从文件中读取cookie了</code></pre><p><strong>从文件中读取cookie</strong></p><pre><code>从文件中读取cookie可以免去每次执行脚本都重新登陆一次 除非cookie过期的情况下才需要重新登录</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib2,cookielib</span><br><span class="line">cookie = cookielib.MozillaCookieJar()</span><br><span class="line">cookie.load(<span class="string">'cookie.txt'</span>, ignore_discard=<span class="literal">True</span>, ignore_expires=<span class="literal">True</span>)</span><br><span class="line">opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(cookie))</span><br><span class="line">response = opener.open(<span class="string">"http://www.baidu.com/"</span>)</span><br></pre></td></tr></table></figure><pre><code>这样如果cookie.txt中保存的是你登陆百度后的cookie 那么下次通过cookie.txt就可以直接登陆百度了现在数据获取方面的工作已经差不多了 数据获取还有一个比较优秀的requests库 可以自行研究下接下来就是如何从网页数据中提取我们需要的信息了</code></pre><h3 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a><font color="#CDAA7D">正则表达式</font></h3><blockquote><p>在编写处理字符串的程序或网页时 经常会有查找符合某些复杂规则的字符串的需要 正则表达式就是用于描述这些规则的工具 换句话说 正则表达式就是记录文本规则的代码 下面看看正则表达式的常用项</p></blockquote><h4 id="常用元字符"><a href="#常用元字符" class="headerlink" title="常用元字符"></a><font color="#DDA0DD">常用元字符</font></h4><table><thead><tr><th>代码</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>.</td><td style="text-align:left">匹配除换行符以外的任意字符</td></tr><tr><td>\w</td><td style="text-align:left">匹配字母或数字或下划线或汉字</td></tr><tr><td>\s</td><td style="text-align:left">匹配任意的空白符</td></tr><tr><td>\d</td><td style="text-align:left">匹配数字</td></tr><tr><td>^</td><td style="text-align:left">匹配字符串的开始</td></tr><tr><td>$</td><td style="text-align:left">匹配字符串的结束</td></tr></tbody></table><h4 id="常用限定符"><a href="#常用限定符" class="headerlink" title="常用限定符"></a><font color="#DDA0DD">常用限定符</font></h4><table><thead><tr><th>代码</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>*</td><td style="text-align:left">重复零次或更多次</td></tr><tr><td>+</td><td style="text-align:left">重复一次或更多次</td></tr><tr><td>?</td><td style="text-align:left">重复零次或一次</td></tr><tr><td>{n}</td><td style="text-align:left">重复n次</td></tr><tr><td>{n,}</td><td style="text-align:left">重复n次或更多次</td></tr><tr><td>{n,m}</td><td style="text-align:left">重复n到m次</td></tr></tbody></table><h4 id="常用的反义代码"><a href="#常用的反义代码" class="headerlink" title="常用的反义代码"></a><font color="#DDA0DD">常用的反义代码</font></h4><table><thead><tr><th>代码</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>\W</td><td style="text-align:left">匹配任意不是字母，数字，下划线，汉字的字符</td></tr><tr><td>\S</td><td style="text-align:left">匹配任意不是空白符的字符</td></tr><tr><td>\D</td><td style="text-align:left">匹配任意非数字的字符</td></tr><tr><td>\B</td><td style="text-align:left">匹配不是单词开头或结束的位置</td></tr><tr><td>[^x]</td><td style="text-align:left">匹配除了x以外的任意字符</td></tr><tr><td>[^aeiou]</td><td style="text-align:left">匹配除了aeiou这几个字母以外的任意字符</td></tr></tbody></table><h4 id="常用分组语法"><a href="#常用分组语法" class="headerlink" title="常用分组语法"></a><font color="#DDA0DD">常用分组语法</font></h4><table><thead><tr><th>代码</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>(exp)</td><td style="text-align:left">匹配exp,并捕获文本到自动命名的组里</td></tr><tr><td>(?”name”exp)</td><td style="text-align:left">匹配exp,并捕获文本到名称为name的组里</td></tr><tr><td>(?:exp)</td><td style="text-align:left">匹配exp,不捕获匹配的文本，也不给此分组分配组号</td></tr><tr><td>(?=exp)</td><td style="text-align:left">匹配exp前面的位置</td></tr><tr><td>(?&lt;=exp)&lt; span=””&gt;</td><td style="text-align:left">匹配exp后面的位置</td></tr><tr><td>(?!exp)</td><td style="text-align:left">匹配后面跟的不是exp的位置</td></tr><tr><td>(?</td><td style="text-align:left">匹配前面不是exp的位置</td></tr><tr><td>(?#comment)</td><td style="text-align:left">提供注释让人阅读</td></tr></tbody></table><h4 id="懒惰限定符"><a href="#懒惰限定符" class="headerlink" title="懒惰限定符"></a><font color="#DDA0DD">懒惰限定符</font></h4><table><thead><tr><th>代码</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>*?</td><td style="text-align:left">重复任意次，但尽可能少重复</td></tr><tr><td>+?</td><td style="text-align:left">重复1次或更多次，但尽可能少重复</td></tr><tr><td>??</td><td style="text-align:left">重复0次或1次，但尽可能少重复</td></tr><tr><td>{n,m}?</td><td style="text-align:left">重复n到m次，但尽可能少重复</td></tr><tr><td>{n,}?</td><td style="text-align:left">重复n次以上，但尽可能少重复</td></tr></tbody></table><h4 id="简单用法"><a href="#简单用法" class="headerlink" title="简单用法"></a><font color="#DDA0DD">简单用法</font></h4><blockquote><p>用最简单的例子 看看正则表达式在网页中如何匹配需要的信息</p></blockquote><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"cn"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">title</span>&gt;</span>regex<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"utf-8"</span>&gt;</span><span class="tag">&lt;/<span class="name">meta</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span> <span class="attr">alink</span>=<span class="string">"red"</span> <span class="attr">bgcolor</span>=<span class="string">"black"</span> <span class="attr">vlink</span>=<span class="string">"yellow"</span> <span class="attr">text</span>=<span class="string">"blue"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h1</span>&gt;</span>subject<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">hr</span> <span class="attr">size</span>=<span class="string">"10px"</span> <span class="attr">width</span>=<span class="string">"50%"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://127.0.0.1:5000/a.html"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"img/123.jpg"</span> <span class="attr">width</span>=<span class="string">"140"</span> <span class="attr">height</span>=<span class="string">"100"</span> <span class="attr">alt</span>=<span class="string">"image"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://127.0.0.1/b.html"</span>&gt;</span>page1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">br</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"http://127.0.0.1/c.html"</span>&gt;</span>page2<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><pre><code>在python中 正则表达式的库是re库 现在只需要简单掌握re.findall的用法</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">print</span> re.findall(<span class="string">r'&lt;title&gt;(.*?)&lt;/title&gt;'</span>,html)</span><br></pre></td></tr></table></figure><pre><code>re.findall的用法是 re.findall(pattern, string, flags)匹配的结果是 [&apos;regex&apos;] 这是一个列表 如果有多个符合条件的字符串 都会出现在列表内html就是上面的那段html代码 r&apos;&lt;title&gt;(.*?)&lt;/title&gt;&apos; 就是用来匹配网页title的正则表达式这里用到了()分组匹配 匹配被&lt;title&gt;和&lt;/title&gt;包裹的内容 .*?则是非贪婪模式匹配如果需要匹配的字符有元字符等特殊字符 就需要用 \ 进行转义 比如匹配baidu.com就需要 baidu\.com因为\是转义字符 如果要匹配\字符或者\b(数字) 就需要写成 \\ 和 \\b 这样带来了非常多的不便所以在字符串的前面加入 r&apos;&apos; 表示原生字符串 就可以写成 r&apos;\&apos; 和 r&apos;\b&apos; 这样就完美的解决了问题 </code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">re.findall(<span class="string">'&lt;a href=".*?"&gt;.*?&lt;/a&gt;'</span>,html)</span><br><span class="line">re.findall(<span class="string">'&lt;a href="(.*?)"&gt;(.*?)&lt;/a&gt;'</span>,html)</span><br></pre></td></tr></table></figure><pre><code>匹配的结果是[&apos;&lt;a href=&quot;http://127.0.0.1/b.html&quot;&gt;page1&lt;/a&gt;&apos;, &apos;&lt;a href=&quot;http://127.0.0.1/c.html&quot;&gt;page2&lt;/a&gt;&apos;][(&apos;http://127.0.0.1/b.html&apos;, &apos;page1&apos;), (&apos;http://127.0.0.1/c.html&apos;, &apos;page2&apos;)]现在能深深的体会到()的重要性了吧 会对()内的字符串自动分组 但是有个奇怪的地方 好像有个链接丢失了html中一共有三个&lt;a&gt;标签 但是只匹配到两个 仔细观察发现 第一个&lt;a&gt;标签和闭合标签&lt;/a&gt;不在同一行因为 . 这个元字符匹配除换行符以外的任意字符  因为第一个&lt;a&gt;和&lt;/a&gt;被换行符隔断了 所以匹配不到这时就需要用到flags这个参数了 比如re.I 忽略大小写 re.S 使 . 元字符完全匹配任何字符</code></pre><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line">re.findall(<span class="string">'&lt;a href="(.*?)"&gt;(.*?)&lt;/a&gt;'</span>,html,re.S)</span><br></pre></td></tr></table></figure><pre><code>[(&apos;http://127.0.0.1:5000/a.html&apos;, &apos;\n            &lt;img src=&quot;img/123.jpg&quot; ......可以看到 所有的&lt;a&gt;标签都被匹配到了re还有许多的匹配方法 比如re.finditer  re.sub  re.search  re.match等 可以自行学习</code></pre><h3 id="实战爬取数据"><a href="#实战爬取数据" class="headerlink" title="实战爬取数据"></a><font color="#CDAA7D">实战爬取数据</font></h3><blockquote><p>现在获取网页数据的方式和正则表达式都已经有了一定的了解 那就开始实际的爬取些有意思的东西</p></blockquote><h4 id="千趣网专题爬取"><a href="#千趣网专题爬取" class="headerlink" title="千趣网专题爬取"></a><font color="#DDA0DD">千趣网专题爬取</font></h4><blockquote><p>千趣网是个分享有意思新闻的网站 不需要登陆就可以浏览内容 也没有什么防爬措施 所以先拿它练手</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line">HOST = <span class="string">'http://www.qianqu.cc'</span>       <span class="comment"># 要爬的网站</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getHTML</span><span class="params">(url)</span>:</span>                   <span class="comment"># 获取网页源码</span></span><br><span class="line">    request = urllib2.urlopen(url,timeout=<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">return</span> request.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">makeUrl</span><span class="params">(baseUrl)</span>:</span>               <span class="comment"># 用来构造每一页的URL地址</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getPageNum</span><span class="params">()</span>:</span>               <span class="comment"># 获取每个专栏有多少页</span></span><br><span class="line">        html = getHTML(baseUrl.format(<span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> int(re.findall(<span class="string">r'pages: (.*?),'</span>,html,re.S)[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,getPageNum()+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">yield</span> baseUrl.format(i)     <span class="comment"># 返回一个可迭代的对象来节省内存</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getTitle</span><span class="params">(url)</span>:</span>                  <span class="comment"># 获取一页有多少文章 返回文章的标题和URL</span></span><br><span class="line">    request = urllib2.urlopen(url)</span><br><span class="line">    html = request.read()</span><br><span class="line">    div = re.findall(<span class="string">r'&lt;div class="article"&gt;(.*?)&lt;/div&gt;'</span>,html,re.S)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> div:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = re.findall(<span class="string">r'&lt;a href="(.*?)".*&lt;/a&gt;.*&lt;p&gt;(.*?)&lt;/p&gt;.*'</span>,i,re.S)[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        <span class="keyword">yield</span> (HOST+result[<span class="number">0</span>],result[<span class="number">1</span>])</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getContext</span><span class="params">(url)</span>:</span>                <span class="comment"># 根据获取到的文章URL检索出内容</span></span><br><span class="line">    request = urllib2.urlopen(url)</span><br><span class="line">    html = request.read()</span><br><span class="line">    div = re.findall(<span class="string">r'&lt;div class="contentText"&gt;(.*?)&lt;/div&gt;'</span>,html,re.S)[<span class="number">0</span>]</span><br><span class="line">    div = div.replace(<span class="string">'&amp;nbsp;'</span>,<span class="string">''</span>)</span><br><span class="line">    text = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> re.split(<span class="string">'&lt;.*?&gt;'</span>,div):</span><br><span class="line">        text += i+<span class="string">'\n'</span> <span class="keyword">if</span> i <span class="keyword">else</span> <span class="string">''</span></span><br><span class="line">    <span class="keyword">return</span> text.replace(<span class="string">'点击阅读全文'</span>,<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span>                     <span class="comment"># 将函数组合起来进行工作 最后返回一个包含URL,标题,文章的字典</span></span><br><span class="line">    urlPool = makeUrl(<span class="string">'http://www.qianqu.cc/tech/page/&#123;&#125;'</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> urlPool:</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> getTitle(i):</span><br><span class="line">            news = &#123;</span><br><span class="line">                <span class="string">'url'</span>:x[<span class="number">0</span>].decode(<span class="string">'utf-8'</span>),             <span class="comment"># 由于网页源码是utf-8编码 所以需要先解码</span></span><br><span class="line">                <span class="string">'title'</span>:x[<span class="number">1</span>].decode(<span class="string">'utf-8'</span>),</span><br><span class="line">                <span class="string">'text'</span>:getContext(x[<span class="number">0</span>]).decode(<span class="string">'utf-8'</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">yield</span> news</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:      <span class="comment"># 这个里面看你想如和处理收集到的数据了 </span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> main():            <span class="comment"># 可以打印出来 也可以存数据库</span></span><br><span class="line">        raw_input(<span class="string">'Enter key continue ...'</span>)</span><br><span class="line">        <span class="keyword">print</span> i[<span class="string">'title'</span>]</span><br><span class="line">        <span class="keyword">print</span> i[<span class="string">'text'</span>]</span><br></pre></td></tr></table></figure><pre><code>千趣有许多专题 比如生活啊 科技啊之类的 这里以科技为例 现在分析下爬取内容的思路def getHTML(url):定义一个获取网页源码的函数 因为千趣网没有反爬措施 所以就非常简单的发送请求 然后返回内容如果爬取其他网站发现失败 可以试着修改User-Agent等必要的字段试试def makeUrl(baseUrl):先进行分析千趣科技模块的URL 发现URL是http://www.qianqu.cc/tech 往下翻还有许多页数所以就需要一个函数能自动生成这些页数的URL 想获取一共有多少页 还需要对网页内容进行分析发现在页面的一段javascript脚本中 pages: 208, 而这个刚好就是这个科技专题的页码数定义一个getPageNum()的函数 用正则表达式检索出这个数字 然后提供makeUrl去生成URLdef getTitle(url):接下来就是请求makeUrl生成的URL 获取每一个URL中有多少个文章的标题和文章的URL在chrome内核的浏览器 Ctrl + U 打开页面的源代码 通过分析发现 每个文字标题都是通过&lt;div&gt;布局的 这样就可以先捕获每个标题所在的div 然后再进行二次匹配出需要的标题和文字的URLdef getContext(url):接下来就是获取标题内容页的数据了对内容中的数据重新处理 去掉多余的HTML标签 并且去掉空格 和没有用处的字符串def main():将需要的函数组合起来 开始工作 并最后返回一个字典字典有三个字段 分别是url title 和text 对应着文章url 文章标题还有文章内容可以发现 这个爬虫脚本还是有非常多可以改进的地方 比如没有异常处理等等 最后就是考虑如何处理这些数据了这里只是简单的打印了出来 最好的方法当然是保存到数据库</code></pre><h3 id="将数据保存入数据库"><a href="#将数据保存入数据库" class="headerlink" title="将数据保存入数据库"></a><font color="#CDAA7D">将数据保存入数据库</font></h3><blockquote><p>从千趣网抓取的数据可以选择存放到Nosql 比如mongodb redis等数据库中 也可以存放到普通的数据库 比如mysql sqlite3中 下面以python自带的标准库sqlite3为例</p></blockquote><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="keyword">import</span> sqlite3,time</span><br><span class="line">    <span class="keyword">with</span> sqlite3.connect(<span class="string">'qianqu.sqlite3'</span>) <span class="keyword">as</span> conn:</span><br><span class="line">        db = conn.cursor()</span><br><span class="line">        create_table = <span class="string">'create table if not exists qianqu (id integer primary key autoincrement,title varchar(128),url varchar(128),text text)'</span></span><br><span class="line">        db.execute(create_table)</span><br><span class="line">        insert_sql = <span class="string">u'insert into qianqu (url,title,text) values (?,?,?)'</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> main():</span><br><span class="line">            db.execute(insert_sql,(i[<span class="string">'url'</span>],i[<span class="string">'title'</span>],i[<span class="string">'text'</span>]))</span><br><span class="line">            conn.commit()</span><br><span class="line">            <span class="keyword">print</span> i[<span class="string">'url'</span>]+<span class="string">' OK!'</span></span><br><span class="line">            time.sleep(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><pre><code>只需要将if __name__ 的部分改为这样就可以了 这里导入sqlite3的库 然后用with管理一个sqlite3数据库的连接 然后按照字典key去建表为了防止爬取速度太快 导致对方服务器可能封锁IP 所以就每1秒爬取一次 然后将数据写入数据库中到这里 对python写爬虫已经有一个大致的学习了 这里没有用到任何的第三方库 都是用标准库实现的程序还有很多不完善的地方 比如如果中途断开了 那么脚本往数据库插入数据又得重新开始</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="Python爬虫进阶"><a href="#Python爬虫进阶" class="headerlink" title="Python爬虫进阶"></a><font color="#CDAA7D">Python爬虫进阶</font></h3><blockquote><p>如果想进一步的提高自己的爬虫水平 就需要学习一些第三方库和一些优秀的爬虫框架了 下面做了一个总结</p></blockquote><h4 id="数据获取类"><a href="#数据获取类" class="headerlink" title="数据获取类"></a><font color="#DDA0DD">数据获取类</font></h4><table><thead><tr><th>模块</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>requests</td><td style="text-align:left">一个非常好用的网络库</td></tr><tr><td>pycurl</td><td style="text-align:left">libcurl的绑定 非常强大</td></tr><tr><td>urllib3</td><td style="text-align:left">HTTP库 安全连接池 支持文件post 可用性高</td></tr><tr><td>tornado</td><td style="text-align:left">高效的非阻塞web框架 可以做HTTP Client</td></tr><tr><td>aiohttp</td><td style="text-align:left">asyncio的HTTP客户端/服务器</td></tr></tbody></table><h4 id="数据解析工具"><a href="#数据解析工具" class="headerlink" title="数据解析工具"></a><font color="#DDA0DD">数据解析工具</font></h4><table><thead><tr><th>模块</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>lxml</td><td style="text-align:left">C语言编写高效HTML/XML处理库 支持XPath</td></tr><tr><td>cssselect</td><td style="text-align:left">解析DOM树和CSS选择器</td></tr><tr><td>pyquery</td><td style="text-align:left">解析DOM树和jQuery选择器</td></tr><tr><td>BeautifulSoup</td><td style="text-align:left">低效但方便的HTML/XML处理库</td></tr><tr><td>html5lib</td><td style="text-align:left">根据WHATWG规范生成HTML/ XML文档的DOM</td></tr><tr><td>xmltodict</td><td style="text-align:left">一个可以让你在处理XML时感觉像在处理JSON一样的模块</td></tr></tbody></table><h4 id="爬虫框架"><a href="#爬虫框架" class="headerlink" title="爬虫框架"></a><font color="#DDA0DD">爬虫框架</font></h4><table><thead><tr><th>模块</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>grad</td><td style="text-align:left">网络爬虫框架(基于pycurl/multicur)</td></tr><tr><td>scrapy</td><td style="text-align:left">网络爬虫框架(基于twisted)</td></tr><tr><td>pyspider</td><td style="text-align:left">一个强大的爬虫系统</td></tr><tr><td>cola</td><td style="text-align:left">一个分布式爬虫框架</td></tr></tbody></table><h4 id="数据库驱动"><a href="#数据库驱动" class="headerlink" title="数据库驱动"></a><font color="#DDA0DD">数据库驱动</font></h4><table><thead><tr><th>模块</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>mysqlclient</td><td style="text-align:left">python的mysql驱动</td></tr><tr><td>psycopg2</td><td style="text-align:left">python的postgresql驱动</td></tr><tr><td>pymongo</td><td style="text-align:left">python的mongodb驱动</td></tr><tr><td>redis</td><td style="text-align:left">python的redis驱动</td></tr></tbody></table><h4 id="其他工具"><a href="#其他工具" class="headerlink" title="其他工具"></a><font color="#DDA0DD">其他工具</font></h4><table><thead><tr><th>模块</th><th style="text-align:left">说明</th></tr></thead><tbody><tr><td>PhantomJS</td><td style="text-align:left">无界面的,可脚本编程的WebKit浏览器引擎</td></tr><tr><td>Selenium</td><td style="text-align:left">自动化测试工具</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;网络爬虫是一个自动提取网页的程序，它为搜索引擎从万维网上下载网页，是搜索引擎的重要组成。比如百度 google等搜索引擎通过程序爬取你的个人网站，然后建立索引 这样别人就可以通过搜索关键字找到你的网站了。爬虫的意义不仅如此 还可以做更多好玩的事情。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Python" scheme="http://www.yunfwe.cn/categories/Python/"/>
    
    
      <category term="网络爬虫" scheme="http://www.yunfwe.cn/tags/%E7%BD%91%E7%BB%9C%E7%88%AC%E8%99%AB/"/>
    
      <category term="Python" scheme="http://www.yunfwe.cn/tags/Python/"/>
    
  </entry>
  
  <entry>
    <title>LNMP环境部署</title>
    <link href="http://www.yunfwe.cn/2016/07/19/2016/LAMP%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/"/>
    <id>http://www.yunfwe.cn/2016/07/19/2016/LAMP%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/</id>
    <published>2016-07-18T16:00:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Linux+Apache+Mysql/MariaDB+Perl/PHP/Python一组常用来搭建动态网站或者服务器的开源软件，本身都是各自独立的程序，但是因为常被放在一起使用，拥有了越来越高的兼容度，共同组成了一个强大的Web应用程序平台。随着开源潮流的蓬勃发展，开放源代码的LAMP已经与J2EE和.Net商业软件形成三足鼎立之势，并且该软件开发的项目在软件方面的投资成本较低，因此受到整个IT界的关注。从网站的流量上来说，70%以上的访问流量是LAMP来提供的，LAMP是最强大的网站解决方案．<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>本教程中的各服务搭建在不同的服务器上 当然也可以搭建在同一个服务器上</p></blockquote><h3 id="主机环境"><a href="#主机环境" class="headerlink" title="主机环境"></a><font color="#CDAA7D">主机环境</font></h3><table><thead><tr><th>身份</th><th style="text-align:center">系统</th><th style="text-align:right">IP</th></tr></thead><tbody><tr><td>Apache 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.18.0.4</td></tr><tr><td>MySQL 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.18.0.2</td></tr><tr><td>PHP-fpm 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.18.0.3</td></tr></tbody></table><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a><font color="#CDAA7D">软件环境</font></h3><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>Apache</td><td style="text-align:center">2.4.23</td><td style="text-align:right"><a href="http://mirrors.aliyun.com/apache/httpd/httpd-2.4.23.tar.bz2" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>MySQL</td><td style="text-align:center">5.6.28</td><td style="text-align:right"><a href="http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.28.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>PHP</td><td style="text-align:center">5.6.19</td><td style="text-align:right"><a href="http://cn2.php.net/distributions/php-5.6.19.tar.xz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><blockquote><p>httpd和php结合的方式有两种 一种是和nginx相同的 通过php-fpm启动监听的方式 然后转发php页面请求给php-fpm服务 还有一种就是php编译为httpd模块的方式提供php页面的解析能力</p></blockquote><h3 id="编译安装各组件"><a href="#编译安装各组件" class="headerlink" title="编译安装各组件"></a><font color="#CDAA7D">编译安装各组件</font></h3><table><thead><tr><th>服务器</th><th style="text-align:center">安装文档地址</th></tr></thead><tbody><tr><td>Apache</td><td style="text-align:center"><a href="/2016/03/31/nginx/nginx编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr><tr><td>MySQL</td><td style="text-align:center"><a href="/2016/04/01/mysql/MySQL编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr><tr><td>PHP-fpm</td><td style="text-align:center"><a href="/2016/04/01/php/php-fpm编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr></tbody></table><h3 id="httpd-php-fpm"><a href="#httpd-php-fpm" class="headerlink" title="httpd + php-fpm"></a><font color="#CDAA7D">httpd + php-fpm</font></h3><blockquote><p>这个是httpd通过fast-cgi方式和php-fpm搭配</p></blockquote><h4 id="配置PHP-fpm"><a href="#配置PHP-fpm" class="headerlink" title="配置PHP-fpm"></a><font color="#DDA0DD">配置PHP-fpm</font></h4><pre><code>打开编辑php-fpm.confvim /usr/local/php/etc/php-fpm.conf修改listen监听地址为0.0.0.0:9000listen = 0.0.0.0:9000 配置仅允许连接的客户机 默认运行所有主机连接 172.0.0.7是Nginx服务器的IPlisten.allowed_clients = 172.17.0.7然后启动PHP-fpm的服务service php-fpm start</code></pre><h4 id="修改httpd配置文件"><a href="#修改httpd配置文件" class="headerlink" title="修改httpd配置文件"></a><font color="#DDA0DD">修改httpd配置文件</font></h4><pre><code>打开编辑httpd.confvim /usr/local/httpd/conf/httpd.conf修改 DocumentRoot 路径为&quot;/var/www/html&quot; 这个是网站根目录 紧接着的 Directory 配置段也修改为 &lt;Directory &quot;/var/www/html&quot;&gt;去掉mod_proxy.so和mod_proxy_fcgi.so之前的注解 让httpd启动时加载这两个模块LoadModule proxy_module modules/mod_proxy.soLoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so 然后添加配置段 让php页面交给php-fpm去解析&lt;FilesMatch \.php$&gt;     SetHandler &quot;proxy:fcgi://172.18.0.3:9000&quot;&lt;/FilesMatch&gt;然后定位DirectoryIndex配置项 添加index.phpDirectoryIndex index.php index.html最后启动httpd服务/usr/local/httpd/bin/httpd下面有详细的方法检测是否搭配成功</code></pre><h3 id="httpd-php模块"><a href="#httpd-php模块" class="headerlink" title="httpd + php模块"></a><font color="#DDA0DD">httpd + php模块</font></h3><blockquote><p>接下来开始介绍如何将php编译为httpd的模块方式搭配php和httpd</p></blockquote><h4 id="将php编译为httpd模块"><a href="#将php编译为httpd模块" class="headerlink" title="将php编译为httpd模块"></a><font color="#CDAA7D">将php编译为httpd模块</font></h4><blockquote><p>将php编译为httpd模块方式和php-fpm模式的编译唯一的区别就是将–enable-fpm替换为–with-apxs2=/usr/local/httpd/bin/apxs</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">tar xf php-5.6.19.tar.xz</span><br><span class="line"><span class="built_in">cd</span> php-5.6.19</span><br><span class="line">./configure \</span><br><span class="line">--prefix=/usr/<span class="built_in">local</span>/php \</span><br><span class="line">--with-apxs2=/usr/<span class="built_in">local</span>/httpd/bin/apxs \</span><br><span class="line">--with-mcrypt \</span><br><span class="line">--with-zlib --<span class="built_in">enable</span>-mbstring \</span><br><span class="line">--with-openssl --with-mysql \</span><br><span class="line">--with-mysqli --with-mysql-sock \</span><br><span class="line">--with-gd --with-jpeg-dir=/usr/lib \</span><br><span class="line">--<span class="built_in">enable</span>-gd-native-ttf  \</span><br><span class="line">--<span class="built_in">enable</span>-pdo --with-pdo-mysql \</span><br><span class="line">--with-gettext --with-curl \</span><br><span class="line">--with-pdo-mysql --<span class="built_in">enable</span>-sockets \</span><br><span class="line">--<span class="built_in">enable</span>-bcmath --<span class="built_in">enable</span>-xml \</span><br><span class="line">--with-bz2 --<span class="built_in">enable</span>-zip \</span><br><span class="line">--with-freetype-dir=/usr \</span><br><span class="line">--with-mcrypt=/usr/<span class="built_in">local</span>/mcrypt</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><pre><code>ls /usr/local/httpd/modules/libphp5.so可以看到 在httpd的modules目录下 已经出现了libphp5.so这个模块了接下来依然要给php模块提供个配置文件 cp ./php.ini-production /usr/local/php/lib/php.ini</code></pre><h4 id="修改httpd配置文件-1"><a href="#修改httpd配置文件-1" class="headerlink" title="修改httpd配置文件"></a>修改httpd配置文件</h4><blockquote><p>php模块方式对httpd.conf的修改和php-fpm方式是完全不同的</p></blockquote><pre><code>cd到httpd的conf目录 可以发现多出来一个httpd.conf.bak的文件 这个是php安装期间 对httpd.conf做出修改后的备份 其实做的修改也仅仅是添加和启用了libphp5这个模块LoadModule php5_module        modules/libphp5.so如果沿用的是刚才的php-fpm模式的配置文件 需要先清理掉&lt;FilesMatch \.php$&gt;配置段如果是全新的配置 同样修改网站根目录和添加index.php 这里不再赘述添加如下两行配置AddType application/x-httpd-php  .phpAddType application/x-httpd-php-source  .phps最后启动httpd服务/usr/local/httpd/bin/httpd</code></pre><h3 id="验证是否搭配成功"><a href="#验证是否搭配成功" class="headerlink" title="验证是否搭配成功"></a>验证是否搭配成功</h3><blockquote><p>请注意 如果php-fpm和httpd服务不在同一个服务器 可以将网站根目录通过nfs共享访问 或者克隆一份web页面放到两台服务器相同的路径下</p></blockquote><p>MySQL创建远程登录用户 php 允许所有地址连接 密码 php123<br>grant all privileges on <em>.</em> to “php”@”%” identified by “php123”;</p><pre><code>在/var/www/html中编写index.php    &lt;?php        phpinfo();    ?&gt;在/var/www/html中编写dbtest.php    &lt;?php         $link=mysql_connect(&quot;172.18.0.2&quot;,&quot;php&quot;,&quot;php123&quot;);         if(!$link) echo &quot;连接错误!&quot;;         else echo &quot;可以连接!&quot;;     ?&gt;分别访问两个php文件http://172.18.0.4/  和  http://172.18.0.4/dbtest.php若浏览器出现大大的PHP Version 5.6.19 则index.php被正常识别访问dbtest.php若出现 &quot;可以连接!&quot; 则数据库连接成果以下是用curl访问dbtest.php的结果# curl http://172.18.0.4/dbtest.php可以连接</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><pre><code>可以看到 LAMP 和 LNMP 在php-fpm上是非常相似的 推荐使用php-fpm的方式 这样比php模块更节省服务器资源因为httpd的高并发能力比Nginx弱很多 所以高并发环境下推荐使用LNMP</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Linux+Apache+Mysql/MariaDB+Perl/PHP/Python一组常用来搭建动态网站或者服务器的开源软件，本身都是各自独立的程序，但是因为常被放在一起使用，拥有了越来越高的兼容度，共同组成了一个强大的Web应用程序平台。随着开源潮流的蓬勃发展，开放源代码的LAMP已经与J2EE和.Net商业软件形成三足鼎立之势，并且该软件开发的项目在软件方面的投资成本较低，因此受到整个IT界的关注。从网站的流量上来说，70%以上的访问流量是LAMP来提供的，LAMP是最强大的网站解决方案．&lt;br&gt;
    
    </summary>
    
    
      <category term="LAMP" scheme="http://www.yunfwe.cn/categories/LAMP/"/>
    
    
      <category term="mysql" scheme="http://www.yunfwe.cn/tags/mysql/"/>
    
      <category term="php" scheme="http://www.yunfwe.cn/tags/php/"/>
    
      <category term="apache" scheme="http://www.yunfwe.cn/tags/apache/"/>
    
      <category term="zabbix" scheme="http://www.yunfwe.cn/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>HAProxy常用配置详解</title>
    <link href="http://www.yunfwe.cn/2016/07/18/2016/HAProxy%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/"/>
    <id>http://www.yunfwe.cn/2016/07/18/2016/HAProxy%E5%B8%B8%E7%94%A8%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3/</id>
    <published>2016-07-18T07:51:49.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>HAProxy的安装非常简单 但是配置文件方面就比较复杂了 在安装路径下的doc目录下 有官方详细的使用文档。其实常用的配置也并不多 只要掌握了这些 HAProxy就可以很好的使用了<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>haproxy</td><td style="text-align:center">1.6.7</td><td style="text-align:right"><a href="http://www.haproxy.org/download/1.6/src/haproxy-1.6.7.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><blockquote><p>根据功能和用途 HAProxy配置文件主要由五个部分组成 有些部分并不是必须的 可以根据实际情况使用</p></blockquote><pre><code>1. global部分             设置全局配置参数2. defaults部分           默认参数配置部分3. frontend部分           设置接受用户请求的前端虚拟节点4. backend部分            设置后端服务器集群的配置5. listen部分             frontend和backend部分的结合体 </code></pre><h3 id="global部分"><a href="#global部分" class="headerlink" title="global部分"></a><font color="#CDAA7D">global部分</font></h3><pre><code>global        maxconn         10000        log             127.0.0.1 local0 info        uid             200        gid             200        chroot          /var/empty        daemon        nbproc          1        pidfile         /var/run/haproxy.pidmaxconn: 设定每个HAProxy进程可接受的最大并发连接数 (相当于ulimit -n的设置)log: 全局的日志配置 127.0.0.1 local0表示使用本机的rsys-log服务中的local0日志设备    还支持四种日志级别 err, warning, info, debuglog-send-hostname: 在syslog信息的首部添加当前主机名 可以自定义字符串 默认当前主机名uid/gid: 运行HAProxy进程的uid和gid 也可以用user/group代替chroot: 限定运行用户的访问目录daemon: 设置HAProxy进程后台运行nbproc: 服务启动时创建的进程数 创建多个进程 可以减少每个进程的任务队列 但是可能使服务不稳定pidfile: pid文件位置 启动用户必须有可写权限stats: 用户访问统计数据的接口node: 定义当前节点的名称 用于HA场景中多haproxy进程共享同一个IP地址时</code></pre><h3 id="defaults部分"><a href="#defaults部分" class="headerlink" title="defaults部分"></a><font color="#CDAA7D">defaults部分</font></h3><pre><code>defaults        mode            http        retries         3        timeout connect 10s        timeout client  20s        timeout server  30s        timeout check   5smode: 设置HAProxy实例默认运行模式 有tcp http health三个可选值    tcp: 在此模式下 只做数据转发 不对七层报文做检查    http: 会对七层报文做检查分析    health: 此模式基本已被废弃retries: 设置后端服务器连接失败重试次数 超过次数 HAProxy标记此服务器不可用timeout connect: 成功连接到一台服务器最长等待时间timeout client: 设置连接客户端发送数据最长等待时间 默认单位毫秒 可以使用其他单位后缀timeout server: 设置服务器回应客户最长等待时间 默认单位毫秒 可以使用其他单位后缀timeout check: 设置对后端服务器检查超时时间 默认单位毫秒 可以使用其他单位后缀</code></pre><h3 id="frontend部分"><a href="#frontend部分" class="headerlink" title="frontend部分"></a><font color="#CDAA7D">frontend部分</font></h3><pre><code>frontend www        bind            *:80        mode            http        option          httplog        option          forwardfor        option          httpclose        log             global        default_backend htmpool通过frontend关键字定义了一个名为www的前端虚拟节点bind: 只能用在frontend和listen部分 用户定义一个或多个监听的套接字 端口还可以是个段 比如80-100option httplog: 开启日志记录HTTP请求option forwardfor: 请求头中添加X-Forwardfor-For记录 可以让后端服务器获取用户真实IPoption httpclose: 完成一次连接请求后 HAProxy将主动关闭此TCP连接log global: 使用global中定义的日志选项配置格式defaults_backend: 制定默认的后端服务器池 htmpool将在backend中定义</code></pre><h3 id="backend部分"><a href="#backend部分" class="headerlink" title="backend部分"></a><font color="#CDAA7D">backend部分</font></h3><pre><code>backend htmpool        mode            http        option redispatch        option abortonclose        balance         roundrobin        cookie          SERVERID        option httpchk GET /        server web1 192.168.4.233:80 cookie server1 weight 6 check inter 2000 rise 2 fall 3        server web2 192.168.4.234:80 cookie server2 weight 6 check inter 2000 rise 2 fall 3option redispatch: 用于cookie保持环境下 如果后端服务器异常 将客户请求强制定向到另一台正常服务器option abortonclose: 服务器负载很高的情况下 自动结束当前队列中处理时间比较长的连接balance: 定义负载均衡算法 HAProxy支持多种负载均衡算法 常用的如下几种    roundrobin: 基于权重进行轮询的调度算法    static-rr: 也是基于权重进行轮询的调度算法 不过为静态方法 在运行时调整其服务器权重不会生效    source: 基于请求源IP的算法 可以使同一个客户端的IP请求始终由一台服务器处理    leastconn: 将新的连接请求转发到最有最少连接数目的后端服务器 长会话的环境中比较适用    uri: 此算法会对部分或整个URI进行hash运算 再经过与服务器的总权重相除 转发到匹配的服务器    uri-param: 根据URL路径中的参数转发 可以保证同一用户的请求始终分发到同一台服务器上    hdr: 根据http头进行转发 如果http头名称不存在 则使用roundrobin算法进行策略转发cookie: 表示允许向cookie插入SERVERID 每台服务器的SERVERID可由server关键字定义option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;: 表示启用HTTP的服务状态检测功能 method支持以下几种方式    OPTIONS GET HEAD 一般的健康检查只需要采用HEAD方式 只查看Response的状态码是否是200就可以了    uri则是要检测的URL地址 version指定检测时的HTTP版本号 默认HTTP/1.0server &lt;name&gt; &lt;address&gt;[:port] [param*]: 这个则是定义多台后端服务器了     name: 为后端服务器指定一个名称    address: 后端真实服务器的IP    port: 后端真实服务器监听的端口号    param*: 为后端服务器设定的一系列参数 常用参数如下        check: 表示对后端服务器执行健康检查        inter: 设置监控状态检测的时间 单位是毫秒        rise: 由故障状态转移到正常状态需要成功检查的次数 rise 2表示2次检查成功 此服务器才可用        fall: 由正常状态转移到故障状态需要失败检查的次数        cookies: 目的在于实现持久连接的功能 cookie server1 表示web1的serverid为server1        weight: 后端服务器的权重 默认1 最大256 设置0不参与负载均衡 权重越大 被选中的概率越大        backup: 不参与负载均衡 只有在所有服务器都不可用的情况下才启用</code></pre><h3 id="listen部分"><a href="#listen部分" class="headerlink" title="listen部分"></a><font color="#CDAA7D">listen部分</font></h3><blockquote><p>frontend和backend部分的结合体 它们中的指令 listen中都能用 新版的haproxy为了兼容旧版的才保留了listen部分 目前haproxy中 两种配置方式选一个即可</p></blockquote><pre><code>listen admin_stats    bind 0.0.0.0:9188    mode http    log 127.0.0.1 local0 err    stats refresh 30s    stats uri /haproxy-status    stats realm welcome login\ Haproxy    stats auth admin:admin~!@    stats hide-version    stats admin if TRUEstats refresh: 监控统计页面的自动刷新时间stats uri: 监控统计页面的访问路径stats realm: 访问统计页面时的文本提示信息stats auth: 认证登陆的用户名和密码stats hide-version: 隐藏版本信息stats admin: 通过此选择 可以在监控页面上手工启用或禁用后端服务器</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="HAProxy的日志配置策略"><a href="#HAProxy的日志配置策略" class="headerlink" title="HAProxy的日志配置策略"></a><font color="#CDAA7D">HAProxy的日志配置策略</font></h3><blockquote><p>默认情况下 HAProxy为了节省读写的I/0所消耗的性能 没有自动配置日志输出功能 但是为了方便维护和调试 还是需要开启的</p></blockquote><pre><code>确定系统已经安装rsyslogyum install -y rsyslog添加配置文件 vim /etc/rsyslog.d/haproxy.conf    $ModLoad imudp    $UDPServerRun 514    local0.* /var/log/haproxy.conf通过UDP 514端口接收日志 然后还要修改/etc/sysconfig/rsyslog修改为: SYSLOGD_OPTIONS=&quot;-c 2 -r -m 0&quot;然后重启rsyslog服务即可service rsyslog restart</code></pre><p>这里只讲解了HAProxy常用的配置方法 如果想深入了解其他配置项 可以查阅官方文档<br>官方文档位置: /usr/local/haproxy/doc/haproxy/</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;HAProxy的安装非常简单 但是配置文件方面就比较复杂了 在安装路径下的doc目录下 有官方详细的使用文档。其实常用的配置也并不多 只要掌握了这些 HAProxy就可以很好的使用了&lt;br&gt;
    
    </summary>
    
    
      <category term="HAProxy" scheme="http://www.yunfwe.cn/categories/HAProxy/"/>
    
    
      <category term="代理服务器" scheme="http://www.yunfwe.cn/tags/%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="负载均衡" scheme="http://www.yunfwe.cn/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>HAProxy编译安装</title>
    <link href="http://www.yunfwe.cn/2016/07/18/2016/HAProxy%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
    <id>http://www.yunfwe.cn/2016/07/18/2016/HAProxy%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</id>
    <published>2016-07-18T06:55:05.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。<br><a href="http://baike.baidu.com/view/2480120.htm" target="_blank" rel="noopener"><font color="#AAAAAA">百度百科</font></a><br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>haproxy</td><td style="text-align:center">1.6.7</td><td style="text-align:right"><a href="http://www.haproxy.org/download/1.6/src/haproxy-1.6.7.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><blockquote><p>需要系统先初始化开发环境</p></blockquote><pre><code>yum install -y gcc gcc-c++ zlib-devel make</code></pre><h3 id="编译安装haproxy"><a href="#编译安装haproxy" class="headerlink" title="编译安装haproxy"></a><font color="#CDAA7D">编译安装haproxy</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar xf haproxy-1.6.7.tar.gz</span><br><span class="line"><span class="built_in">cd</span> haproxy-1.6.7</span><br><span class="line">make -j4 TARGET=linux2628 USE_PCRE=1 USE_OPENSSL=1</span><br><span class="line">make install PREFIX=/usr/<span class="built_in">local</span>/haproxy</span><br><span class="line">mkdir /etc/haproxy</span><br><span class="line">cp examples/content-sw-sample.cfg /etc/haproxy/haproxy.conf</span><br></pre></td></tr></table></figure><pre><code>需要注意的地方是 TARGET=linux2628 这个是根据内核版本来定的 具体如何使用看源码目录下的README文件简单来说 只要你的内核版本大于2.6.28的 都可以使用TARGET=linux2628编译安装是非常简单的 至此haproxy就编译安装完成了 剩下的就是看haproxy如何使用了 </code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="四层和七层负载均衡的区别"><a href="#四层和七层负载均衡的区别" class="headerlink" title="四层和七层负载均衡的区别"></a><font color="#CDAA7D">四层和七层负载均衡的区别</font></h3><pre><code>常见的负载均衡方式 除了硬件负载均衡设备 还有软件的负载均衡产品 比如Nginx, LVS, HAProxy等软件的方式又分为基于操作系统的和基于第三方软件的 比如LVS需要内核模块的支持 HAProxy则不需要HAProxy可以实现TCP(四层)和HTTP(七层)应用的负载均衡 而早期Nginx只支持HTTP应用的负载均衡不过Nginx在新版本1.9.0之后 也支持了TCP的代理和负载均衡 在1.9.13后支持了UDP代理和负载均衡四层负载均衡也被称为四层交换机 主要通过修改数据包中目标IP地址和端口改为后端服务器的IP地址和端口然后直接转发给该后端服务器 这样一个负载均衡的请求就完成了 并没有对数据包中的数据内容做修改而负载均衡器只不过完成了一个类似路由的转发动作 在某些负载均衡策略下 甚至会修改报文的源地址以保证数据包可以正确的传输而七层负载均衡器又被称为七层交换机 位于应用层 此时负载均衡器可以支持多种应用协议 常见的有HTTP, FTP, SMTP等 七层负载均衡器不仅可以根据IP+端口的方式负载均衡 还可以根据内容比如一个网站有为手机适配的页面和电脑适配的页面 可以分析HTTP的头部User-Agent信息 来智能跳转而这些能力是在四层是无法实现的</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机，它是免费、快速并且可靠的一种解决方案。HAProxy特别适用于那些负载特大的web站点，这些站点通常又需要会话保持或七层处理。HAProxy运行在当前的硬件上，完全可以支持数以万计的并发连接。并且它的运行模式使得它可以很简单安全的整合进您当前的架构中， 同时可以保护你的web服务器不被暴露到网络上。&lt;br&gt;&lt;a href=&quot;http://baike.baidu.com/view/2480120.htm&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;font color=&quot;#AAAAAA&quot;&gt;百度百科&lt;/font&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="HAProxy" scheme="http://www.yunfwe.cn/categories/HAProxy/"/>
    
    
      <category term="代理服务器" scheme="http://www.yunfwe.cn/tags/%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    
      <category term="负载均衡" scheme="http://www.yunfwe.cn/tags/%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    
  </entry>
  
  <entry>
    <title>PHP模块拓展</title>
    <link href="http://www.yunfwe.cn/2016/07/12/2016/php%E6%A8%A1%E5%9D%97%E6%8B%93%E5%B1%95/"/>
    <id>http://www.yunfwe.cn/2016/07/12/2016/php%E6%A8%A1%E5%9D%97%E6%8B%93%E5%B1%95/</id>
    <published>2016-07-12T05:00:33.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>在PHP开发环境中可能发现项目依赖一些先前并没有编译进入的模块 或者需要用到一些第三方模块 那么该如何对PHP进行动态的拓展模块 而不用重新编译PHP呢<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>实验已安装环境为PHP 5.5.33版本 </p></blockquote><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>php</td><td style="text-align:center">5.5.33</td><td style="text-align:right"><a href="http://cn2.php.net/distributions/php-5.5.33.tar.xz" target="_blank" rel="noopener"><font color="#AAAAAA">下载地址</font></a></td></tr><tr><td>php</td><td style="text-align:center">5.6.19</td><td style="text-align:right"><a href="http://cn2.php.net/distributions/php-5.6.19.tar.xz" target="_blank" rel="noopener"><font color="#AAAAAA">下载地址</font></a></td></tr><tr><td>php</td><td style="text-align:center">7.0.4</td><td style="text-align:right"><a href="http://cn2.php.net/distributions/php-7.0.4.tar.xz" target="_blank" rel="noopener"><font color="#AAAAAA">下载地址</font></a></td></tr><tr><td>memcache</td><td style="text-align:center">3.0.8</td><td style="text-align:right"><a href="http://pecl.php.net/get/memcache-3.0.8.tgz" target="_blank" rel="noopener"><font color="#AAAAAA">下载地址</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><blockquote><p>如果后期的开发需要用到php的其他模块 或者第三方模块 那就需要对php进行模块升级<br>模块安装的方式有两种 在linux 可以选择将模块编译入php程序中 也可以作为单独的so文件让php加载</p></blockquote><pre><code>准备好php的源码包 要和当前php版本一致 下面用第三方模块memcache和自带模块soap做示例</code></pre><h3 id="编译安装自带模块soap"><a href="#编译安装自带模块soap" class="headerlink" title="编译安装自带模块soap"></a><font color="#CDAA7D">编译安装自带模块soap</font></h3><blockquote><p>解压了PHP的源码包后 进入到源码包目录的ext目录下 这个是PHP自带的所有模块</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar xf php-5.5.33.tar.xz</span><br><span class="line"><span class="built_in">cd</span> php-5.5.34/ext/soap/</span><br><span class="line">/usr/<span class="built_in">local</span>/php/bin/phpize</span><br><span class="line">./configure --with-php-config=/usr/<span class="built_in">local</span>/php/bin/php-config</span><br><span class="line">make &amp;&amp; mkdir /usr/<span class="built_in">local</span>/php/extensions/</span><br><span class="line">cp modules/soap.so /usr/<span class="built_in">local</span>/php/extensions/</span><br></pre></td></tr></table></figure><pre><code>可以看到 ext目录下 有非常多的模块文件夹 进入soap目录中后 先执行phpize脚本才会生成configure文件之后指定php-config的位置来进行生成Makefile文件 最后生成的二进制so文件在modules目录内为什么不直接make install呢 因为make install安装到的目录感觉并不是非常方便管理在php安装目录下建立一个文件夹 可以将所有的二进制so文件都放入到这个文件夹内接下来就是让php加载这个模块了 修改php.ini文件 添加以下配置extension_dir = &quot;/usr/local/php/extensions&quot;extension=soap.so先是配置好拓展模块的目录 然后下面启用的模块就可以只写模块名了 否则需要写模块的完整路径[root@e1adb08f8c82 lib]# /usr/local/php/bin/php -m |grep soapsoap[root@e1adb08f8c82 lib]#可以看到 php已经出现了soap这个模块 不放心的话 也可以通过phpinfo页面看看有没有soap模块还有一种方法安装soap模块就是重新编译php 添加 --enable-soap 配置项即可 这里不再赘诉</code></pre><h3 id="编译安装第三方memcache模块"><a href="#编译安装第三方memcache模块" class="headerlink" title="编译安装第三方memcache模块"></a><font color="#CDAA7D">编译安装第三方memcache模块</font></h3><blockquote><p>php所有的第三方模块都可以在 <strong><a href="http://pecl.php.net/" target="_blank" rel="noopener">http://pecl.php.net/</a></strong> 找到 这里以memcache为例</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf memcache-3.0.8.tgz</span><br><span class="line">/usr/<span class="built_in">local</span>/php/bin/phpize </span><br><span class="line">./configure --with-php-config=/usr/<span class="built_in">local</span>/php/bin/php-config</span><br><span class="line">cp modules/memcache.so /usr/<span class="built_in">local</span>/php/extensions/</span><br></pre></td></tr></table></figure><pre><code>接下来也是修改php.ini文件 将memcache.so加载就可以了extension=memcache.so[root@e1adb08f8c82 lib]# /usr/local/php/bin/php -m |grep memcachememcache[root@e1adb08f8c82 lib]#可以看到 memcache也成功的出现在 php的模块中 </code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><pre><code>不同版本的php模块是不能够通用的 反之如果环境相同的php 那么模块就不用重复编译了模块不通用的原因是因为 不同版本的PHP 可能使用的API不相同[root@e1adb08f8c82 memcache-3.0.8]# /usr/local/php/bin/phpize Configuring for:PHP Api Version:         20121113Zend Module Api No:      20121212Zend Extension Api No:   220121212正如每次执行phpize脚本中显示的那样</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;在PHP开发环境中可能发现项目依赖一些先前并没有编译进入的模块 或者需要用到一些第三方模块 那么该如何对PHP进行动态的拓展模块 而不用重新编译PHP呢&lt;br&gt;
    
    </summary>
    
    
      <category term="PHP" scheme="http://www.yunfwe.cn/categories/PHP/"/>
    
    
      <category term="php" scheme="http://www.yunfwe.cn/tags/php/"/>
    
      <category term="LNMP" scheme="http://www.yunfwe.cn/tags/LNMP/"/>
    
      <category term="php-fpm" scheme="http://www.yunfwe.cn/tags/php-fpm/"/>
    
  </entry>
  
  <entry>
    <title>Redis散列类型</title>
    <link href="http://www.yunfwe.cn/2016/05/25/2016/redis%E6%95%A3%E5%88%97%E7%B1%BB%E5%9E%8B/"/>
    <id>http://www.yunfwe.cn/2016/05/25/2016/redis%E6%95%A3%E5%88%97%E7%B1%BB%E5%9E%8B/</id>
    <published>2016-05-24T16:00:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Redis 是采用字典结构以键值对的形式存储数据的，而散列类型（hash）的键值也是一种字典结构，其存储了字段（field）和字段值的映射，但字段值只能是字符串，不支持其他数据类型，换句话说，散列类型不能嵌套其他的数据类型。一个散列类型键可以包含最多232最少1个字段</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>redis</td><td style="text-align:center">3.2.0</td><td style="text-align:right"><a href="http://download.redis.io/releases/redis-3.2.0.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="简单认识散列类型"><a href="#简单认识散列类型" class="headerlink" title="简单认识散列类型"></a>简单认识散列类型</h2><p>散列类型适合存储对象：使用对象类别和 ID 构成键名，使用字段表示对象的属性，而字段值则存储属性值。需要注意 散列类型的字段值只能是字符串类型 不能嵌套其他类型</p><pre><code>键:ID              字段              字段值          +----&gt;   color   -----&gt;    whitecar:1 ----+----&gt;   name    -----&gt;    Ferraris          +----&gt;   price   -----&gt;    10 million</code></pre><p>散列类型的字段可以随意拓增或者减少 所以散列类型的结构只是人为的约定</p><h2 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h2><p>下面将详细说明操作Redis散列类型的相关命令</p><h3 id="赋值与取值"><a href="#赋值与取值" class="headerlink" title="赋值与取值"></a>赋值与取值</h3><pre><code>HSET key field value                # 赋值HGET key field                      # 取值127.0.0.1:6379&gt; HSET car:1 color white(integer) 1127.0.0.1:6379&gt; HSET car:1 name Ferraris(integer) 1127.0.0.1:6379&gt; HSET car:1 price &apos;10 million&apos;(integer) 1127.0.0.1:6379&gt; HGET car:1 color&quot;white&quot;127.0.0.1:6379&gt; HGET car:1 name&quot;Ferraris&quot;127.0.0.1:6379&gt; HGET car:1 price&quot;10 million&quot;127.0.0.1:6379&gt;</code></pre><p>HSET不区分插入和更新操作 修改数据时不用事先判断字段是否存在<br>插入或修改一个字段时 当字段不存在 HSET命令返回1 否则返回0</p><pre><code>127.0.0.1:6379&gt; HSET car:1 color blue(integer) 0127.0.0.1:6379&gt; HGET car:1 color&quot;blue&quot;127.0.0.1:6379&gt;</code></pre><p>和字符串类似 当需要给多个字段同时设定值 或获取值 也有相应的命令</p><pre><code>HMSET key field value [field value ...]      # 同时赋值HGET key field                               # 同时取值127.0.0.1:6379&gt; HMSET car:2 color red name Bentley price &apos;3 million&apos;OK127.0.0.1:6379&gt; HMGET car:2 color name price1) &quot;red&quot;2) &quot;Bentley&quot;3) &quot;3 million&quot;127.0.0.1:6379&gt;</code></pre><p>如果事先不知道这个car:2有哪些字段 那么如何获取这个key中所有的字段和值呢</p><pre><code>HGETALL key             # 获取所有字段值127.0.0.1:6379&gt; HGETALL car:21) &quot;color&quot;2) &quot;red&quot;3) &quot;name&quot;4) &quot;Bentley&quot;5) &quot;price&quot;6) &quot;3 million&quot;127.0.0.1:6379&gt;</code></pre><p>还可以单独获取字段名或字段值</p><pre><code>HKEYS key           # 只获取字段名HVALS key           # 只获取字段值127.0.0.1:6379&gt; HKEYS car:11) &quot;name&quot;127.0.0.1:6379&gt; HKEYS car:21) &quot;color&quot;2) &quot;name&quot;3) &quot;price&quot;4) &quot;date&quot;127.0.0.1:6379&gt; HVALS car:11) &quot;Ferraris&quot;127.0.0.1:6379&gt; HVALS car:21) &quot;red&quot;2) &quot;Bentley&quot;3) &quot;3 million&quot;4) &quot;2016-05-22&quot;127.0.0.1:6379&gt; </code></pre><h3 id="判断字段是否存在"><a href="#判断字段是否存在" class="headerlink" title="判断字段是否存在"></a>判断字段是否存在</h3><pre><code>HEXISTS key field            # 判断字段是否存在127.0.0.1:6379&gt; HEXISTS car:1 date(integer) 0127.0.0.1:6379&gt; HSET car:1 date &apos;2016-05-22&apos;(integer) 1127.0.0.1:6379&gt; HEXISTS car:1 date(integer) 1127.0.0.1:6379&gt;</code></pre><p>当字段不存在返回0 字段存在 返回1</p><h3 id="字段不存在时赋值"><a href="#字段不存在时赋值" class="headerlink" title="字段不存在时赋值"></a>字段不存在时赋值</h3><pre><code>HSETNX key field value      # 字段不存在时赋值127.0.0.1:6379&gt; HSETNX car:2 color black(integer) 0127.0.0.1:6379&gt; HGET car:2 color&quot;red&quot;127.0.0.1:6379&gt; HSETNX car:2 date &apos;2016-05-22&apos;(integer) 1127.0.0.1:6379&gt; HGET car:2 date&quot;2016-05-22&quot;127.0.0.1:6379&gt;</code></pre><p>可以看到 如果字段存在 赋值失败 并返回0 如果不存在 赋值成功 返回1</p><h3 id="字段值自增自减"><a href="#字段值自增自减" class="headerlink" title="字段值自增自减"></a>字段值自增自减</h3><pre><code>HINCRBY key field increment     # 字段值自增127.0.0.1:6379&gt; HINCRBY car id 1(integer) 1127.0.0.1:6379&gt; HGET car id&quot;1&quot;127.0.0.1:6379&gt; HINCRBY car id 2(integer) 3127.0.0.1:6379&gt; HGET car id&quot;3&quot;127.0.0.1:6379&gt;</code></pre><p>字段值的自增和字符串的自增道理相同 因为没有自减 所以可以用自增 -1 来实现</p><h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><pre><code>HDEL key field [field ...]      # 删除指定的一个或多个字段127.0.0.1:6379&gt; HDEL car:1 price date(integer) 2127.0.0.1:6379&gt; HGETALL car:11) &quot;color&quot;2) &quot;blue&quot;3) &quot;name&quot;4) &quot;Ferraris&quot;127.0.0.1:6379&gt; HDEL car:1 price color(integer) 1127.0.0.1:6379&gt;</code></pre><p>HDEL会返回删除成功的字段个数</p><h3 id="获取字段数量"><a href="#获取字段数量" class="headerlink" title="获取字段数量"></a>获取字段数量</h3><pre><code>HLEN key            # 获取字段数量127.0.0.1:6379&gt; HLEN car:1(integer) 1127.0.0.1:6379&gt; HLEN car:2(integer) 4127.0.0.1:6379&gt;</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="命令总结"><a href="#命令总结" class="headerlink" title="命令总结"></a>命令总结</h3><pre><code>HSET key field value                    给键的字段赋值HGET key field                          获取键的字段值HMSET key field value [field value ...] 同时赋值HGET key field                          同时取值HGETALL key                             获取所有字段值HKEYS key                               只获取字段名HVALS key                               只获取字段值HEXISTS key field                       判断字段是否存在HSETNX key field value                  字段不存在时赋值HINCRBY key field increment             字段值自增HDEL key field [field ...]              删除指定的一个或多个字段HLEN key                                获取字段数量</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Redis 是采用字典结构以键值对的形式存储数据的，而散列类型（hash）的键值也是一种字典结构，其存储了字段（field）和字段值的映射，但字段值只能是字符串，不支持其他数据类型，换句话说，散列类型不能嵌套其他的数据类型。一个散列类型键可以包含最多232最少1个字段&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Redis" scheme="http://www.yunfwe.cn/categories/Redis/"/>
    
    
      <category term="Redis" scheme="http://www.yunfwe.cn/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis有序集合类型</title>
    <link href="http://www.yunfwe.cn/2016/05/24/2016/redis%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B/"/>
    <id>http://www.yunfwe.cn/2016/05/24/2016/redis%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B/</id>
    <published>2016-05-24T04:53:19.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>有序集合类型 顾名思义 与集合类型的区别就是有序 这个有序是在集合类型的基础上 给每个元素关联了一个分数 按照分数进行排序<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>redis</td><td style="text-align:center">3.2.0</td><td style="text-align:right"><a href="http://download.redis.io/releases/redis-3.2.0.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="与列表类型的区别"><a href="#与列表类型的区别" class="headerlink" title="与列表类型的区别"></a><font color="#CDAA7D">与列表类型的区别</font></h3><blockquote><p>有序集合类型在某些方面和列表类型相似 但是还是有很大的区别</p></blockquote><pre><code>与列表相似的地方:    1. 两者都是有序的    2. 两者都可以获取某一个范围的元素与列表不同的地方:    1. 列表通过链表实现 所以访问两端数据比较快 访问中间数据会较慢     2. 而集合采用散列表和跳跃表 所以没有这个忧虑    3. 列表不能简单的调整某个元素的位置 但有序集合通过修改元素分数可以     4. 有序集合比列表类型更耗费内存</code></pre><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><font color="#CDAA7D">常用命令</font></h3><blockquote><p>下面将详细说明操作Redis有序集合类型的相关命令</p></blockquote><h4 id="增加元素"><a href="#增加元素" class="headerlink" title="增加元素"></a><font color="#DDA0DD">增加元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZADD key score member [score member …]      # 增加元素</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZADD num 1 a 2 b 3 c(integer) 3127.0.0.1:6379&gt; ZADD num 2 a 2.5 d(integer) 1127.0.0.1:6379&gt;元素的分数可以修改 可以是小数 最后的排序方式就是按照分数排序的</code></pre><h4 id="获取元素分数"><a href="#获取元素分数" class="headerlink" title="获取元素分数"></a><font color="#DDA0DD">获取元素分数</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZSCORE key member           # 获取元素分数</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZSCORE num a&quot;2&quot;127.0.0.1:6379&gt; ZADD num 3 a (integer) 0127.0.0.1:6379&gt; ZSCORE num a&quot;3&quot;127.0.0.1:6379&gt;</code></pre><h4 id="获取某个范围的元素"><a href="#获取某个范围的元素" class="headerlink" title="获取某个范围的元素"></a><font color="#DDA0DD">获取某个范围的元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZRANGE key start stop [WITHSCORES]      # 获取某个索引范围的元素</span><br><span class="line">ZREVRANGE key start stop [WITHSCORES]   # 获取某个索引范围的元素 反序排序</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZRANGE num 0 -11) &quot;b&quot;2) &quot;d&quot;3) &quot;a&quot;4) &quot;c&quot;127.0.0.1:6379&gt; ZRANGE num 0 1 WITHSCORES1) &quot;b&quot;2) &quot;2&quot;3) &quot;d&quot;4) &quot;2.5&quot;127.0.0.1:6379&gt;ZRANGE的用法和LRANGE的用法大致一样 只不过多了个 WITHSCORES 可以同时显示分数如果出现分数相同的情况 则按照 0 &lt; 9 &lt; A &lt; Z &lt; a &lt; z 规则排序127.0.0.1:6379&gt; ZREVRANGE num 0 -11) &quot;c&quot;2) &quot;a&quot;3) &quot;d&quot;4) &quot;b&quot;127.0.0.1:6379&gt;可以看到 ZREVRANGE 与 ZRANGE 结果是相反的</code></pre><h4 id="获取某个分数范围的元素"><a href="#获取某个分数范围的元素" class="headerlink" title="获取某个分数范围的元素"></a><font color="#DDA0DD">获取某个分数范围的元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]     # 获取某个分数范围的元素</span><br><span class="line">ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]  # 获取某个分数范围的元素 反序排序</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZRANGEBYSCORE num 2.5 31) &quot;d&quot;2) &quot;a&quot;3) &quot;c&quot;127.0.0.1:6379&gt; ZRANGEBYSCORE num 2.5 (31) &quot;d&quot;127.0.0.1:6379&gt; ZRANGEBYSCORE num (2.5 31) &quot;a&quot;2) &quot;c&quot;127.0.0.1:6379&gt;如果不希望获取端点值 可以在端点分数前加 &quot;(&quot; 这样就可以把端点值排除在外了 无穷大可以用 +inf127.0.0.1:6379&gt; ZRANGEBYSCORE num 2.5 3 LIMIT 0 21) &quot;d&quot;2) &quot;a&quot;127.0.0.1:6379&gt; ZRANGEBYSCORE num 2.5 3 LIMIT 1 21) &quot;a&quot;2) &quot;c&quot;127.0.0.1:6379&gt; ZRANGEBYSCORE num 2.5 3 LIMIT 1 31) &quot;a&quot;2) &quot;c&quot;127.0.0.1:6379&gt; ZRANGEBYSCORE num 2.5 3 LIMIT 0 31) &quot;d&quot;2) &quot;a&quot;3) &quot;c&quot;127.0.0.1:6379&gt;WITHSCORES用法不在赘述 LIMIT是限制结果数量 LIMIT 1 2表示从结果的索引1开始 只要2个结果ZREVRANGEBYSCORE的用法可以参考ZRANGE与ZREVRANGE的去别 也不再详细说明</code></pre><h4 id="增加某个元素的分数"><a href="#增加某个元素的分数" class="headerlink" title="增加某个元素的分数"></a><font color="#DDA0DD">增加某个元素的分数</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZINCRBY key increment member            # 增加某个元素的分数</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZSCORE num a&quot;3&quot;127.0.0.1:6379&gt; ZINCRBY num 4 a&quot;7&quot;127.0.0.1:6379&gt; ZINCRBY num -2 a&quot;5&quot;127.0.0.1:6379&gt;如果指定的元素不存在 ZINCRBY同样会先创建 赋值为0后在增加分数</code></pre><h4 id="获取集合中元素数量"><a href="#获取集合中元素数量" class="headerlink" title="获取集合中元素数量"></a><font color="#DDA0DD">获取集合中元素数量</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZCARD key               # 获取集合中元素数量</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZCARD num(integer) 4127.0.0.1:6379&gt; ZADD num 6 e (integer) 1127.0.0.1:6379&gt; ZCARD num(integer) 5127.0.0.1:6379&gt;</code></pre><h4 id="获得指定分数范围内的元素个数"><a href="#获得指定分数范围内的元素个数" class="headerlink" title="获得指定分数范围内的元素个数"></a><font color="#DDA0DD">获得指定分数范围内的元素个数</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZCOUNT key min max          # 获得指定分数范围内的元素个数</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZRANGE num 0 -1 WITHSCORES 1) &quot;b&quot; 2) &quot;2&quot; 3) &quot;d&quot; 4) &quot;2.5&quot; 5) &quot;c&quot; 6) &quot;3&quot; 7) &quot;a&quot; 8) &quot;5&quot; 9) &quot;e&quot;10) &quot;6&quot;127.0.0.1:6379&gt; ZCOUNT num (2.5 5(integer) 2127.0.0.1:6379&gt; ZCOUNT num 2.5 5(integer) 3127.0.0.1:6379&gt;获取分数为2.5到5之间元素个数 也可以使用 &quot;(&quot; 是否排查端点</code></pre><h4 id="删除一个或多个元素"><a href="#删除一个或多个元素" class="headerlink" title="删除一个或多个元素"></a><font color="#DDA0DD">删除一个或多个元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZREM key member [member …]      # 删除一个或多个元素</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZREM num a b (integer) 2127.0.0.1:6379&gt; ZRANGE num 0 -1 1) &quot;d&quot;2) &quot;c&quot;3) &quot;e&quot;127.0.0.1:6379&gt;命令返回删除成功的元素数量</code></pre><h4 id="按照排名范围删除元素"><a href="#按照排名范围删除元素" class="headerlink" title="按照排名范围删除元素"></a><font color="#DDA0DD">按照排名范围删除元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZREMRANGEBYRANK key start stop          # 按照排名范围删除元素</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZREMRANGEBYRANK num 0 1(integer) 2127.0.0.1:6379&gt; ZRANGE num 0 -1 WITHSCORES1) &quot;e&quot;2) &quot;6&quot;127.0.0.1:6379&gt;按照索引范围去删除元素 返回删除成功的元素个数</code></pre><h4 id="按照分数范围删除元素"><a href="#按照分数范围删除元素" class="headerlink" title="按照分数范围删除元素"></a><font color="#DDA0DD">按照分数范围删除元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ZREMRANGEBYSCORE key min max        # 按照分数范围删除元素</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZADD num 2 a 3 b 4 d(integer) 3127.0.0.1:6379&gt; ZREMRANGEBYSCORE num (2 4(integer) 2127.0.0.1:6379&gt; ZRANGE num 0 -11) &quot;a&quot;2) &quot;e&quot;127.0.0.1:6379&gt;删除分数大于2 小于4的元素 返回删除成功的元素个数</code></pre><h4 id="获得元素的排名"><a href="#获得元素的排名" class="headerlink" title="获得元素的排名"></a><font color="#DDA0DD">获得元素的排名</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZRANK key member                # 获得元素的排名 正序排序</span><br><span class="line">ZREVRANK key member             # 获得元素的排名 反序排序</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; ZRANK num a(integer) 0127.0.0.1:6379&gt; ZRANK num e(integer) 1127.0.0.1:6379&gt; ZREVRANK num e(integer) 0127.0.0.1:6379&gt; ZREVRANK num a(integer) 1127.0.0.1:6379&gt;排序从0开始 ZREVRANK会反序排序 </code></pre><h4 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a><font color="#DDA0DD">集合运算</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ZINTERSTORE dest numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]  # 交集</span><br><span class="line">ZUNIONSTORE dest numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]  # 并集</span><br></pre></td></tr></table></figure><pre><code>numkeys是参与计算的键的个数 WEIGHTS是权重 AGGREGATE绝定最后结果集合的元素分数是取平均数还是最大最小值127.0.0.1:6379&gt; ZADD num1 1 a 2 b 3 c (integer) 3127.0.0.1:6379&gt; ZADD num2 1 b 2 c 3 d (integer) 3127.0.0.1:6379&gt; ZINTERSTORE tmp1 2 num1 num2 AGGREGATE SUM(integer) 2127.0.0.1:6379&gt; ZRANGE tmp1 0 -1 WITHSCORES 1) &quot;b&quot;2) &quot;3&quot;3) &quot;c&quot;4) &quot;5&quot;127.0.0.1:6379&gt;结果分数是取参与运算元素分数的总数 num1中b的分数是2 num2中b的分数是1 最后结果是3如果不加AGGREGATE 默认也是去SUM值 所以可以不用加WEIGHTS参数设置每个集合的权重，每个集合在参与计算时元素的分数会被乘上该集合的权重127.0.0.1:6379&gt; ZINTERSTORE tmp2 2 num1 num2 WEIGHTS 1 10(integer) 2127.0.0.1:6379&gt; zrange tmp2 0 -1 WITHSCORES1) &quot;b&quot;2) &quot;12&quot;3) &quot;c&quot;4) &quot;23&quot;127.0.0.1:6379&gt; ZUNIONSTORE与ZINTERSTORE用法相似 则不再赘述</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><blockquote><p>命令总结</p></blockquote><pre><code>ZADD key score member [score member …]              增加元素ZSCORE key member                                   获取元素分数ZRANGE key start stop [WITHSCORES]                  获取某个索引范围的元素ZREVRANGE key start stop [WITHSCORES]               获取某个索引范围的元素 反序排序ZRANGEBYSCORE key min max [WITHSCORES] [LIMIT offset count]     获取某个分数范围的元素ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count]  获取某个分数范围的元素 反序排序ZINCRBY key increment member                        增加某个元素的分数ZCARD key                                           获取集合中元素数量ZCOUNT key min max                                  获得指定分数范围内的元素个数ZREM key member [member …]                          删除一个或多个元素ZREMRANGEBYRANK key start stop                      按照排名范围删除元素ZREMRANGEBYSCORE key min max                        按照分数范围删除元素ZRANK key member                                    获得元素的排名 正序排序ZREVRANK key member                                 获得元素的排名 反序排序ZINTERSTORE dest numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]  交集ZUNIONSTORE dest numkeys key [key ...] [WEIGHTS weight] [AGGREGATE SUM|MIN|MAX]  并集</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;有序集合类型 顾名思义 与集合类型的区别就是有序 这个有序是在集合类型的基础上 给每个元素关联了一个分数 按照分数进行排序&lt;br&gt;
    
    </summary>
    
    
      <category term="Redis" scheme="http://www.yunfwe.cn/categories/Redis/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis集合类型</title>
    <link href="http://www.yunfwe.cn/2016/05/24/2016/redis%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B/"/>
    <id>http://www.yunfwe.cn/2016/05/24/2016/redis%E9%9B%86%E5%90%88%E7%B1%BB%E5%9E%8B/</id>
    <published>2016-05-24T03:17:41.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>集合和列表有很多相似的地方 但是很容易将他们区分开 集合的元素有唯一性 而且元素是无序的。集合类型的常用操作是向集合中加入或删除元素、判断某个元素是否存在等。最方便的是多个集合类型键之间还可以进行并集、交集和差集运算<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>redis</td><td style="text-align:center">3.2.0</td><td style="text-align:right"><a href="http://download.redis.io/releases/redis-3.2.0.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><font color="#CDAA7D">常用命令</font></h3><blockquote><p>下面将详细说明操作Redis集合类型的相关命令</p></blockquote><h4 id="增加和删除元素"><a href="#增加和删除元素" class="headerlink" title="增加和删除元素"></a><font color="#DDA0DD">增加和删除元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SADD key member [member ...]        # 向一个集合添加元素</span><br><span class="line">SREM key member [member ...]        # 从一个集合删除元素</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SADD num 1 2 2 3(integer) 3127.0.0.1:6379&gt; SREM num 1 1 2(integer) 2127.0.0.1:6379&gt;SADD执行成功会返回添加成功的个数 因为2相同 所以只有一个被添加 SREM也同样 返回被成功删除的个数</code></pre><h4 id="获取集合内所有元素"><a href="#获取集合内所有元素" class="headerlink" title="获取集合内所有元素"></a><font color="#DDA0DD">获取集合内所有元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SMEMBERS num            # 获取集合内所有元素</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SMEMBERS num1) &quot;3&quot;127.0.0.1:6379&gt; SADD num 2 2(integer) 1127.0.0.1:6379&gt; SMEMBERS num1) &quot;2&quot;2) &quot;3&quot;可以看到 num中只剩下3了 而且添加两个元素2 最后num中也只有一个2</code></pre><h4 id="判断元素是否在集合中"><a href="#判断元素是否在集合中" class="headerlink" title="判断元素是否在集合中"></a><font color="#DDA0DD">判断元素是否在集合中</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SISMEMBER num 2         # 判断元素是否在集合中</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SISMEMBER num 2(integer) 1127.0.0.1:6379&gt; SISMEMBER num 1(integer) 0127.0.0.1:6379&gt;如果命中了 则返回1 否则返回0</code></pre><h4 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a><font color="#DDA0DD">集合运算</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SDIFF key1 [key2 ...]           # 计算差集</span><br><span class="line">SINTER key1 [key2 ...]          # 计算交集</span><br><span class="line">SUNION key1 [key2 ...]          # 计算并集</span><br></pre></td></tr></table></figure><pre><code>SDIFF计算多个集合的差集 会想计算key1与key2的差集 然后将这个结果与key3继续计算 交集并集也同理127.0.0.1:6379&gt; SADD num1 1 2 3(integer) 3127.0.0.1:6379&gt; SADD num2 2 3 4(integer) 3127.0.0.1:6379&gt; SDIFF num1 num21) &quot;1&quot;127.0.0.1:6379&gt; SDIFF num2 num11) &quot;4&quot;127.0.0.1:6379&gt;num1与num2的差集运算表示属于num1 且不属于num2的元素 反之亦然127.0.0.1:6379&gt; SINTER num1 num21) &quot;2&quot;2) &quot;3&quot;127.0.0.1:6379&gt;SINTER 计算num1和num2的交集 127.0.0.1:6379&gt; SUNION num1 num21) &quot;1&quot;2) &quot;2&quot;3) &quot;3&quot;4) &quot;4&quot;127.0.0.1:6379SUNION 计算num1和num2的合集</code></pre><h4 id="获取集合中元素个数"><a href="#获取集合中元素个数" class="headerlink" title="获取集合中元素个数"></a><font color="#DDA0DD">获取集合中元素个数</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SCARD key               # 获取集合中元素个数</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SMEMBERS num11) &quot;1&quot;2) &quot;2&quot;3) &quot;3&quot;127.0.0.1:6379&gt; SCARD num1(integer) 3127.0.0.1:6379&gt;SCARD 返回一个集合中元素个数</code></pre><h4 id="存储集合运算后的结果"><a href="#存储集合运算后的结果" class="headerlink" title="存储集合运算后的结果"></a><font color="#DDA0DD">存储集合运算后的结果</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SDIFFSTORE dest key [key …]          # 将差集运算的结果保存为dest</span><br><span class="line">SINTERSTORE dest key [key …]         # 将交集运算的结果保存为dest</span><br><span class="line">SUNIONSTORE dest key [key …]         # 将并集运算的结果保存为dest</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SUNIONSTORE all num1 num2(integer) 4127.0.0.1:6379&gt; SMEMBERS all1) &quot;1&quot;2) &quot;2&quot;3) &quot;3&quot;4) &quot;4&quot;127.0.0.1:6379&gt;和SDIFF唯一区别就是不将结果返回 而是将结果保存为新的集合 只返回新集合元素个数 其余两个道理相同</code></pre><h4 id="随机获得集合中的元素"><a href="#随机获得集合中的元素" class="headerlink" title="随机获得集合中的元素"></a><font color="#DDA0DD">随机获得集合中的元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SRANDMEMBER key [count]         # 随机获得集合中的元素</span><br></pre></td></tr></table></figure><pre><code>count非必选项 用于每次获取多少个随机元素 count的正负体现的意义也不同 count &gt; 0 时 随机获取count个元素 但是元素不会出现重复获取的情况 也就是都是唯一的count &lt; 0 时 随机获取count的绝对值个元素 元素可能被重复获取 如果count的值大于集合中的元素个数 则SRANDMEMBER会返回集合中的全部元素127.0.0.1:6379&gt; SRANDMEMBER all &quot;1&quot;127.0.0.1:6379&gt; SRANDMEMBER all &quot;2&quot;127.0.0.1:6379&gt; SRANDMEMBER all 61) &quot;1&quot;2) &quot;2&quot;3) &quot;3&quot;4) &quot;4&quot;127.0.0.1:6379&gt; SRANDMEMBER all -61) &quot;2&quot;2) &quot;1&quot;3) &quot;1&quot;4) &quot;3&quot;5) &quot;2&quot;6) &quot;2&quot;127.0.0.1:6379&gt;</code></pre><h4 id="从集合中弹出一个元素"><a href="#从集合中弹出一个元素" class="headerlink" title="从集合中弹出一个元素"></a><font color="#DDA0DD">从集合中弹出一个元素</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPOP key            # 从集合中弹出一个元素</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SPOP all&quot;4&quot;127.0.0.1:6379&gt; SMEMBERS all1) &quot;1&quot;2) &quot;2&quot;3) &quot;3&quot;127.0.0.1:6379&gt; SPOP all&quot;1&quot;127.0.0.1:6379&gt; SMEMBERS all1) &quot;2&quot;2) &quot;3&quot;127.0.0.1:6379&gt;由于集合是无序的 所以SPOP会随机弹出一个值</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><blockquote><p>命令总结</p></blockquote><pre><code>SADD key member [member ...]            向一个集合添加元素SREM key member [member ...]            从一个集合删除元素SMEMBERS num                            获取集合内所有元素SISMEMBER num 2                         判断元素是否在集合中SDIFF key1 [key2 ...]                   计算差集SINTER key1 [key2 ...]                  计算交集SUNION key1 [key2 ...]                  计算并集SCARD key                               获取集合中元素个数SDIFFSTORE dest key [key …]             将差集运算的结果保存为destSINTERSTORE dest key [key …]            将交集运算的结果保存为destSUNIONSTORE dest key [key …]            将并集运算的结果保存为destSRANDMEMBER key [count]                 随机获得集合中的元素SPOP key                                从集合中弹出一个元素</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;集合和列表有很多相似的地方 但是很容易将他们区分开 集合的元素有唯一性 而且元素是无序的。集合类型的常用操作是向集合中加入或删除元素、判断某个元素是否存在等。最方便的是多个集合类型键之间还可以进行并集、交集和差集运算&lt;br&gt;
    
    </summary>
    
    
      <category term="Redis" scheme="http://www.yunfwe.cn/categories/Redis/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis字符串类型</title>
    <link href="http://www.yunfwe.cn/2016/05/20/2016/redis%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B/"/>
    <id>http://www.yunfwe.cn/2016/05/20/2016/redis%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%B1%BB%E5%9E%8B/</id>
    <published>2016-05-20T05:36:32.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>字符串类型是 Redis 中最基本的数据类型，它能存储任何形式的字符串，包括二进制数据。你可以用其存储用户的邮箱、JSON 化的对象甚至是一张图片。一个字符串类型键允许存储的数据的最大容量是512 MB<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>redis</td><td style="text-align:center">3.2.0</td><td style="text-align:right"><a href="http://download.redis.io/releases/redis-3.2.0.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="命令返回值"><a href="#命令返回值" class="headerlink" title="命令返回值"></a><font color="#CDAA7D">命令返回值</font></h3><blockquote><p>与redis-server交互 当执行一条命令后 redis-server都会有一个命令返回值 redis-server的返回值类型有五种 下面分别说明</p></blockquote><pre><code>1. 状态回复状态回复是最简单的一种回复 比如向Redis发送SET命名设置某个键值时 Redis会回复OK表示成功127.0.0.1:6379&gt; SET a 1OK127.0.0.1:6379&gt; PINGPONG127.0.0.1:6379&gt;2. 错误回复当命令不存在或者命令格式有错误的情况下 Redis会返回错误回复127.0.0.1:6379&gt; SET(error) ERR wrong number of arguments for &apos;set&apos; command127.0.0.1:6379&gt;3. 整数回复获取当前数据库中键的数量等 返回以(integer)开头的回复 这个便是整数回复127.0.0.1:6379&gt; dbsize(integer) 2127.0.0.1:6379&gt;4. 字符串回复字符串回复是最常用的一种回复类型 比如当获得一个键的值 Redis返回的便是一个字符串值127.0.0.1:6379&gt; get a&quot;1&quot;127.0.0.1:6379&gt;5. 多行字符串回复当请求的并非一个键的值 而是一个列表等 就会收到多行字符串回复 每行字符串都以一个序号开头127.0.0.1:6379&gt; keys *1) &quot;a&quot;2) &quot;b&quot;127.0.0.1:6379&gt;</code></pre><h3 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a><font color="#CDAA7D">常用命令</font></h3><blockquote><p>下面将详细说明操作Redis字符串类型的相关命令</p></blockquote><h4 id="赋值与取值"><a href="#赋值与取值" class="headerlink" title="赋值与取值"></a><font color="#DDA0DD">赋值与取值</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET key value       # 赋值</span><br><span class="line">GET key             # 取值</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SET name xiaomingOK127.0.0.1:6379&gt; GET name&quot;xiaoming&quot;127.0.0.1:6379&gt;如果需要给多个键同时赋值和取值 Redis还提供了MSET MGET两个命令</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MSET key value [key value ...]      # 同时赋值</span><br><span class="line">MGET key [key ...]                  # 同时取值</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; MSET a 1 b 2 c 3OK127.0.0.1:6379&gt; MGET a c b 1) &quot;1&quot;2) &quot;3&quot;3) &quot;2&quot;127.0.0.1:6379&gt;用MSET 给a 赋值1 b赋值2 c赋值3 返回状态回复OK 用MGET 先获取a的值 再获取c的值 最后获取b的值 返回一个多行字符串回复</code></pre><h4 id="递增递减"><a href="#递增递减" class="headerlink" title="递增递减"></a><font color="#DDA0DD">递增递减</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INCR key            # 递增</span><br></pre></td></tr></table></figure><pre><code>当Redis存储的字符串是整数时 Redis提供了一个INCR的命令 其作用就是让当前键值递增127.0.0.1:6379&gt; INCR num(integer) 1127.0.0.1:6379&gt; INCR num(integer) 2127.0.0.1:6379&gt; INCR num(integer) 3127.0.0.1:6379&gt;当递增的key不存在时 Redis则自动创建这个key 并赋值为0 所以第一次递增后 就返回1了可以看到 返回值类型是整数回复 如果递增的对象不是一个整数会怎样呢127.0.0.1:6379&gt; INCR name(error) ERR value is not an integer or out of range127.0.0.1:6379&gt; 可以看到 收到一条错误回复 如果想要递增指定的数字 这个就要引入第二条递增命令了</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INCRBY key increment            # 递增指定整数</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; INCRBY num 10(integer) 13127.0.0.1:6379&gt; INCRBY num 3(integer) 16127.0.0.1:6379&gt;可以看到 INCR和INCRBY的区别就是 INCRBY可以自定义递增数量 而INCR 只能每次加一现在说说递减 递减其实也有专门的操作命令</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DECR key                        # 递减</span><br><span class="line">DECRBY key decrement            # 递减指定整数</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; DECR num(integer) 15127.0.0.1:6379&gt; DECRBY num 5(integer) 10127.0.0.1:6379&gt;有没有想过 如果给INCRBY递增一个负数 或者给DECRBY递减一个负数会发生什么事情呢127.0.0.1:6379&gt; DECRBY num -10(integer) 20127.0.0.1:6379&gt; INCRBY num -5(integer) 15127.0.0.1:6379&gt;可以看到 正如所想的那样 负负得正还是成立的不仅整数可以递增 Redis还存在递增浮点数的命令</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INCRBYFLOAT num increment       # 递增指定浮点数</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; INCRBYFLOAT num 1.4&quot;16.4&quot;127.0.0.1:6379&gt; INCRBYFLOAT num -3.2&quot;13.2&quot;127.0.0.1:6379&gt;</code></pre><h4 id="向尾部追加值"><a href="#向尾部追加值" class="headerlink" title="向尾部追加值"></a><font color="#DDA0DD">向尾部追加值</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">APPEND key value                # 向尾部追加值</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; APPEND name 123abc(integer) 14127.0.0.1:6379&gt; GET name&quot;xiaoming123abc&quot;127.0.0.1:6379&gt;可以看到 APPEND 命令可以向字符串后面增加任意的字符串 返回增加后字符串长度</code></pre><h4 id="获取字符串长度"><a href="#获取字符串长度" class="headerlink" title="获取字符串长度"></a><font color="#DDA0DD">获取字符串长度</font></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STRLEN key                      # 获取字符串长度</span><br></pre></td></tr></table></figure><pre><code>127.0.0.1:6379&gt; SET hello helloOK127.0.0.1:6379&gt; STRLEN hello(integer) 5127.0.0.1:6379&gt; SET hello 你好OK127.0.0.1:6379&gt; STRLEN hello(integer) 6127.0.0.1:6379&gt;Redis可以存储所有编码的字符串 中文也不例外 例子中Redis接受的是UTF-8编码的中文 一个中文UTF-8编码长度是3 所以 &apos;你好&apos; 会返回6了</code></pre><h4 id="位操作"><a href="#位操作" class="headerlink" title="位操作"></a><font color="#DDA0DD">位操作</font></h4><blockquote><p>位操作是个很有意思的操作 操作的是这个字符串在内存中的比特位<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GETBIT key offset               # 获取偏移多少位后的值</span><br><span class="line">SETBIT key offset value         # 设置偏移多少位后的值</span><br><span class="line">BITCOUNT key [start end]        # 获取比特位是1的个数</span><br><span class="line">BITPOS key bit [start] [end]    # 获取第一个位值是0或1的位置</span><br></pre></td></tr></table></figure></p></blockquote><pre><code>大家都知道 一个字节由8个比特位组成 而一个英文字符又正好一个字节127.0.0.1:6379&gt; SET name abca b c的三个字母的ASCII码分别是97 98 99 那么转换为二进制则如下            a        b        c        01100001 01100010 01100011比特位获取索引从0开始 比如第0位是0 第1位是1 第2位也是1127.0.0.1:6379&gt; GETBIT name 2(integer) 1127.0.0.1:6379&gt; GETBIT name 7(integer) 1127.0.0.1:6379&gt; GETBIT name 8(integer) 0127.0.0.1:6379&gt; GETBIT name 9(integer) 1127.0.0.1:6379&gt;GETBIT是获取比特位的 那么SETBIT自然可以更改比特位的值 更改比特位后 自然也更改了这个字符分析a b c 三个字符的二进制数据 发现他们的区别在最后两位 01 10 11 那么修改这几个位的值试试127.0.0.1:6379&gt; SETBIT name 6 1(integer) 0127.0.0.1:6379&gt; GET name&quot;cbc&quot;127.0.0.1:6379&gt;将a的第6位修改为1 那么原本a的二进制就变成了01100011 也就是和c相同了 a被变成了cBITCOUNT用来统计一定范围内比特位为1的个数 name的值变为cbc后 比特位如下            c        b        c        01100011 01100010 01100011可以数出来 1的个数有11个 BITCOUNT还可以限定参与计算的字符范围127.0.0.1:6379&gt; BITCOUNT name(integer) 11127.0.0.1:6379&gt; BITCOUNT name 0 0(integer) 4127.0.0.1:6379&gt;第一个0是从第几个字符开始 第二个0是到第几个字符结束 0 0 就表示只有第一个字符c参与计算Redis 2.8.7版本以上才有BITPOS这个命令 可以获取指定键的第一个位值是0或者1的位置 也可以限定范围127.0.0.1:6379&gt; BITPOS name 1(integer) 1127.0.0.1:6379&gt; BITPOS name 0 1 2(integer) 8127.0.0.1:6379&gt;第一个命令 获取name中 位值为1的索引 可以看到 01100011中 位值为1的索引是1第二个命令 限定从索引为1的字符开始 到索引为2的字符 位值为0的索引 字符b的第一位就是0 索引是8</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><blockquote><p>命令总结</p></blockquote><pre><code>SET key value                   赋值GET key                         取值MSET key value [key value …]    同时赋值MGET key [key …]                同时取值INCR key                        递增INCRBY key increment            递增指定整数DECR key                        递减DECRBY key decrement            递减指定整数INCRBYFLOAT num increment       递增指定浮点数APPEND key value                向尾部追加值STRLEN key                      获取字符串长度GETBIT key offset               获取偏移多少位后的值SETBIT key offset value         设置偏移多少位后的值BITCOUNT key [start end]        获取比特位是1的个数BITPOS key bit [start] [end]    获取第一个位值是0或1的位置</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;字符串类型是 Redis 中最基本的数据类型，它能存储任何形式的字符串，包括二进制数据。你可以用其存储用户的邮箱、JSON 化的对象甚至是一张图片。一个字符串类型键允许存储的数据的最大容量是512 MB&lt;br&gt;
    
    </summary>
    
    
      <category term="Redis" scheme="http://www.yunfwe.cn/categories/Redis/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis服务管理及配置文件</title>
    <link href="http://www.yunfwe.cn/2016/05/18/2016/redis%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/"/>
    <id>http://www.yunfwe.cn/2016/05/18/2016/redis%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86%E5%8F%8A%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/</id>
    <published>2016-05-18T02:04:37.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Redis启动后还需要对其进行管理 比如如何安全的关闭数据库 以及如何配置服务的监听地址 访问密码等<br>下面将详细说明 Redis服务的简单管理 以及配置文件详解<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>redis</td><td style="text-align:center">3.2.0</td><td style="text-align:right"><a href="http://download.redis.io/releases/redis-3.2.0.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="启动和停止Redis"><a href="#启动和停止Redis" class="headerlink" title="启动和停止Redis"></a><font color="#CDAA7D">启动和停止Redis</font></h3><blockquote><p>启动Redis很简单 可执行程序路径后面跟配置文件路径就可以了 如果在前台运行Redis的话 Ctrl+c就可以很安全的关闭Redis了 那么如果在后台运行呢</p></blockquote><pre><code>/usr/local/redis/bin/redis-server /etc/redis.conf --daemonize yes通过--daemonize yes或者直接修改配置文件中的daemonize为yes 让Redis默认后台运行[root@localhost ~]# netstat -anpttcp    0   0 127.0.0.1:6379        0.0.0.0:*       LISTEN    3268/redis-server 1 可以看到 Redis已经监听在本机127.0.0.1的6379端口 PID号为3268 关闭Redis也非常简单 因为Redis能很好的处理TREM信号 所以可以直接 kill 3268同样 使用redis-cli客户端连接工具 向Redis服务发送SHUTDOWN命令也是可以安全关闭的/usr/local/redis/bin/redis-cli -h 127.0.0.1 -p 6379 SHUTDOWNredis的命令不区分大小写 但是建议命令大写如果服务监听在本机的127.0.0.1:6379 redis-cli可以直接连接 而不用指定主机和端口号当redis收到结束命令或TERM信号后 会断开所有客户端连接 然后将内存数据序列化到硬盘 最后完成退出</code></pre><h3 id="Redis配置文件"><a href="#Redis配置文件" class="headerlink" title="Redis配置文件"></a><font color="#CDAA7D">Redis配置文件</font></h3><blockquote><p>Redis的启动监听地址 监听端口 以及配置PID文件路径等 有非常多的启动参数 如果都在启动redis的时候传入 那么将非常麻烦 而通过配置文件的方式 将大大简化这个过程<br>Redis的配置项还分两种 一种是只能在启动Redis的时候配置的 比如监听端口等 还有一种可以在命令行中动态修改的 比如日志记录级别等 以下是Redis配置文件中常用配置项</p></blockquote><pre><code>include /path/to/other.conf     # 包含其他配置文件监听相关配置项tcp-backlog 511                 # TCP监听最大容纳数量 增大可以解决高并发下客户端连接缓慢问题unixsocket /tmp/redis.sock      # 非默认项 启动unix套接字监听 redis-cli -s /tmp/redis.sock连接timeout 0                       # 客户端多长时间没有操作redis关闭连接 0表示不关闭tcp-keepalive 0                 # tcp 心跳包 防止一个死的对端连接 推荐设置为60秒一般配置项daemonize no                    # Redis默认运行在前台 使用yes可以让Redis默认后台运行pidfile /var/run/redis.pid      # pid文件位置loglevel notice                 # 日志记录级别 [debug | verbose | notice | warning]logfile /tmp/redis.log          # 日志文件位置 默认是个空字符串 redis将日志打印到标准输出syslog-enabled no               # 如果想把日志记录到系统日志 就改为yesdatabases 16                    # redis启动数据库空间个数 默认进入的是id为0空间 select dbID切换数据库快照配置项save 900 1                      # 保存数据库到磁盘 900 秒内如果至少有 1 个 key 的值变化，则保存save 300 10                     # 300 秒内如果至少有 10 个 key 的值变化，则保存save 60 10000                   # 60 秒内如果至少有 10000 个 key 的值变化，则保存save &quot;&quot;                         # 停用自动保存功能 不同的保存规则是可以都生效的dbfilename dump.rdb             # 保存数据的文件位置stop-writes-on-bgsave-error yes # 后台保存数据出错 redis强制关闭写操作rdbcompression yes              # 是否在保存数据时压缩 可以减少磁盘使用 但是增大CPU负载rdbchecksum yes                 # 是否校验rdb文件dir ./                          # dump.rdb就保存在dir目录中主从复制配置项slaveof 172.17.0.2 6379         # 作为172.17.0.2的从数据库masterauth password             # 如果主数据库需要认证 密码写这里slave-serve-stale-data yes      # 如果与主失去联系 从是否要继续提供查询服务 数据可能不是最新slave-read-only yes             # 默认从数据库不支持写入操作 repl-ping-slave-period 10       # 默认每10秒 从数据库发送ping命令道主数据库repl-timeout 60                 # 主从复制过期时间 一定要比repl-ping-slave-period大repl-diskless-sync no     # 默认情况下 复制是内存-&gt; 磁盘-&gt; 内存-&gt; slave端 yes后 将直接发到slaverepl-diskless-sync-delay 5      # 收到第一个请求时 等待多个slave一起来请求之间的间隔时间repl-backlog-size 1mb           # 设置主从复制容量大小 slave断线重连 只恢复断开时丢失的数据repl-backlog-ttl 3600           # 3600秒后 slave没有连接 master将释放backlog 0表示不释放slave-priority 100              # 集群中用 master挂了 slave提升为master的优先级min-slaves-to-write 3           # 至少3个slave才允许向master写数据min-slaves-max-lag 10           # 至少3个slave 并且ping心跳的超时不超过10秒 才允许向master写数据安全配置项requirepass passwd              # 连接需要密码 redis-cli 需要通过auth命令 或 -a 参数指定密码登陆rename-command CONFIG &quot;&quot;        # 给命令重命名 如果重命名为空字符串 则屏蔽命令限制相关配置maxclients 10000                # 最大连接客户端数量 超过的 redis将关闭新连接maxmemory 1024mb                # 数据库最大占用1024mb内存 超过的话 将按照策略移除keysmaxmemory-policy noeviction     # 内存超过后默认移除key的策略maxmemory-samples 5             # 调整算法的速度和精度 默认从五个键中找到一个使用最少的键以下是支持的策略:    volatile-lru -&gt;     使用 LRU 算法移除包含过期设置的 key    allkeys-lru  -&gt;     根据 LRU 算法移除所有的 key    volatile-random -&gt;  随机移除过期的key    allkeys-random  -&gt;  随机移除所有的key    volatile-ttl -&gt;     删除最近到期的key    noeviction   -&gt;     不让任何 key 过期，只是给写入操作返回一个错误AOF日志配置项appendonly no                   # 默认不启用aof日志appendfilename redis.aof        # aof日志名称 和rdb快照共享dir路径appendfsync everysec            # aof日志同步硬盘数据策略 (fsync)每次更改数据库内存后 AOF都会将命令记录到AOF文件 但是由于系统缓存机制 数据还并没真正写入硬盘系统默认30秒写入一次硬盘 如果在这期间 系统异常退出 将导致数据丢失 以下是redis的解决策略:    no        -&gt;        不进行主动同步操作    always    -&gt;        每次执行写入操作都进行一次同步    everysec  -&gt;        每秒执行一次主动同步操作no-appendfsync-on-rewrite no    # 是否在Redis重写aof文件期间调用fsyncauto-aof-rewrite-percentage 100 # aof文件增长超过上次aof文件大小100% 重写aof文件 0 禁用auto-aof-rewrite-min-size 64mb  # 触发aof重写的大小限制 只有aof大小超过64mb 上一条才生效aof-load-truncated yes          # redis在启动时可以加载被截断的AOF文件Lua脚本配置项lua-time-limit 5000             # 一个lua脚本最长执行时间 0或负数无限执行 默认5000毫秒Redis集群配置项cluster-enabled yes             # 启用或禁用集群cluster-config-file nodes.conf     # 保存节点配置文件的路径 节点配置文件无须人为修改cluster-node-timeout 15000      # 集群节点超时 默认15000毫秒cluster-slave-validity-factor 10    # master失联多久 slave故障切换 0 表示一直尝试切换cluster-migration-barrier 1         # 一个master可以拥有的最小slave数量cluster-require-full-coverage yes   # 当一定比例的键空间没有被覆盖到 集群就停止任何查询操作慢查询日志配置项slowlog-log-slower-than 10000   # 配置记录慢查询日志的条件 单位是微妙 负值关闭 0记录所有slowlog-max-len 1024            # 记录慢查询日志最大条数延时监控配置项latency-monitor-threshold 0     # redis延迟监控子系统在运行时 会抽样检测可能导致延迟的不同操作                                # 系统只记录超过设定值的操作 单位是毫秒 0表示禁用该功能  事件通知配置项notify-keyspace-events &quot;&quot;       # 空字符串表示关闭键空间通知功能 支持以下字符任意组合K       -&gt;      键空间通知 所有通知以 __keyspace@ __ 为前缀E       -&gt;      键事件通知，所有通知以 __keyevent@ __ 为前缀g       -&gt;      DEL EXPIRE RENAME 等类型无关的通用命令的通知$       -&gt;      字符串命令的通知l       -&gt;      列表命令的通知s       -&gt;      集合命令的通知h       -&gt;      哈希命令的通知z       -&gt;      有序集合命令的通知x       -&gt;      过期事件 每当有过期键删除时通知e       -&gt;      键淘汰事件 每当有键因为maxmemory-policy 策略被淘汰时通知A       -&gt;      参数g$lshzxe 的别名高级配置hash-max-ziplist-entries 512    # 指定在超过一定的数量或者最大的元素超过某一临界值时hash-max-ziplist-value 64       # 采用一种特殊的哈希算法list-max-ziplist-size -2        # 列表 集合 有序集合和哈希的一样list-compress-depth 0set-max-intset-entries 512zset-max-ziplist-entries 128zset-max-ziplist-value 64hll-sparse-max-bytes 3000       # HyperLogLog稀疏表示限制设置activerehashing yes             # 如果对延迟要求较高 则设为no 禁止重新hash 但可能会浪费很多内存client-output-buffer-limit normal 0 0 0         # 客户端缓存限制 硬限制 软限制 以及软限制持续秒数client-output-buffer-limit slave 256mb 64mb 60  # 当满足硬限制 或者 软限制和持续秒数 与客户端断开client-output-buffer-limit pubsub 32mb 8mb 60hz 10                       # 内部函数执行的后台任务的频率 如清除过期数据 客户端超时链接等 1~500</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="动态更改Redis配置"><a href="#动态更改Redis配置" class="headerlink" title="动态更改Redis配置"></a><font color="#CDAA7D">动态更改Redis配置</font></h3><blockquote><p>连接到redis后 用CONFIG GET * 可以看到所有的配置 用CONFIG SET则可以对配置进行修改 但是 并不是所有的配置都能动态修改</p></blockquote><pre><code>下面的例子 是用CONFIG SET 动态的给数据库添加认证密码127.0.0.1:6379&gt; CONFIG SET requirepass 123.comOK127.0.0.1:6379&gt; set a 100(error) NOAUTH Authentication required.127.0.0.1:6379&gt; auth 123.comOK127.0.0.1:6379&gt; set a 100OK127.0.0.1:6379&gt;可以看到 通过CONFIG GET已经可以看到刚才设置的密码127.0.0.1:6379&gt; CONFIG GET requirepass 1) &quot;requirepass&quot;2) &quot;123.com&quot;127.0.0.1:6379&gt;由于已经配置了密码 下次登陆的时候 也可以直接用 -a 参数提供认证密码/usr/local/redis/bin/redis-cli -a 123.com</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Redis启动后还需要对其进行管理 比如如何安全的关闭数据库 以及如何配置服务的监听地址 访问密码等&lt;br&gt;下面将详细说明 Redis服务的简单管理 以及配置文件详解&lt;br&gt;
    
    </summary>
    
    
      <category term="Redis" scheme="http://www.yunfwe.cn/categories/Redis/"/>
    
    
      <category term="nosql" scheme="http://www.yunfwe.cn/tags/nosql/"/>
    
      <category term="redis" scheme="http://www.yunfwe.cn/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis数据库编译安装</title>
    <link href="http://www.yunfwe.cn/2016/05/17/2016/redis%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/"/>
    <id>http://www.yunfwe.cn/2016/05/17/2016/redis%E6%95%B0%E6%8D%AE%E5%BA%93%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85/</id>
    <published>2016-05-17T07:48:23.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，Redis的开发工作由VMware主持。从2013年5月开始，Redis的开发由Pivotal赞助。<br><a href="http://baike.baidu.com/view/4595959.htm" target="_blank" rel="noopener"><font color="#AAAAAA">百度百科</font></a><br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>redis</td><td style="text-align:center">3.2.0</td><td style="text-align:right"><a href="http://download.redis.io/releases/redis-3.2.0.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a><font color="#CDAA7D">编译安装</font></h3><blockquote><p>redis的编译安装非常简单 只需要安装 make 和 gcc 开发工具即可</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yum install make gcc</span><br><span class="line">tar xf redis-3.2.0.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-3.2.0</span><br><span class="line">make -j4</span><br><span class="line">make PREFIX=/usr/<span class="built_in">local</span>/redis install</span><br></pre></td></tr></table></figure><pre><code>通过PREFIX=/usr/local/redis可以指定redis安装路径 默认安装到/usr/local/bin/中</code></pre><h3 id="提供配置文件并启动redis"><a href="#提供配置文件并启动redis" class="headerlink" title="提供配置文件并启动redis"></a><font color="#CDAA7D">提供配置文件并启动redis</font></h3><blockquote><p>redis的启动非常方便 有很多默认配置 不使用配置文件也可以启动 但是想要灵活配置就比较不方便了</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp redis.conf /etc/redis.conf</span><br><span class="line">/usr/<span class="built_in">local</span>/redis/bin/redis-server /etc/redis.conf</span><br></pre></td></tr></table></figure><pre><code>如果如图下所示 那么就启动成功了 redis默认在前台运行 Ctrl+c 停止                _._                                                             _.-``__ &apos;&apos;-._                                                   _.-``    `.  `_.  &apos;&apos;-._           Redis 3.2.0 (00000000/0) 64 bit  .-`` .-```.  ```\/    _.,_ &apos;&apos;-._                                    (    &apos;      ,       .-`  | `,    )     Running in standalone mode |`-._`-...-` __...-.``-._|&apos;` _.-&apos;|     Port: 6379 |    `-._   `._    /     _.-&apos;    |     PID: 3173  `-._    `-._  `-./  _.-&apos;    _.-&apos;                                    |`-._`-._    `-.__.-&apos;    _.-&apos;_.-&apos;|                                   |    `-._`-._        _.-&apos;_.-&apos;    |           http://redis.io          `-._    `-._`-.__.-&apos;_.-&apos;    _.-&apos;                                    |`-._`-._    `-.__.-&apos;    _.-&apos;_.-&apos;|                                   |    `-._`-._        _.-&apos;_.-&apos;    |                                    `-._    `-._`-.__.-&apos;_.-&apos;    _.-&apos;                                         `-._    `-.__.-&apos;    _.-&apos;                                                 `-._        _.-&apos;                                                         `-.__.-&apos;  </code></pre><p>如果不使用配置文件 可以通过命令行参数方式运行redis-server</p><pre><code>/usr/local/redis/bin/redis-server /etc/redis.conf --daemonize yes --port 1212这个的意思就是在后台运行 监听端口1212 默认是监听6379 可以更改redis.conf中的 daemonize 值为yes 这样 redis-server通过配置文件启动就默认在后台运行了如果在指定了配置文件又使用了命令行参数的情况 命令行参数会覆盖配置文件中的相同项</code></pre><h3 id="redis客户端连接"><a href="#redis客户端连接" class="headerlink" title="redis客户端连接"></a><font color="#CDAA7D">redis客户端连接</font></h3><blockquote><p>redis-cli便是redis-server的客户端连接工具 同时 redis还有很多其他语言的API接口</p></blockquote><pre><code>/usr/local/redis/bin/redis-cli -h 127.0.0.1 -p 6379redis-cli 默认会连接本机的6379端口 所以如果服务监听在127.0.0.1:6379 redis-cli可以直接连接redis是基于key-value的数据库 下面就测试一下redis工作的是否正常127.0.0.1:6379&gt; set a 100OK127.0.0.1:6379&gt; get a&quot;100&quot;127.0.0.1:6379&gt; redis的使用非常简单 所有的命令也一共就一百多条 常用的更少 通过set命令给 a 赋值 100然后通过 get 命令获取 a 的值 可以看到 a 的值被正确获取 redis服务正常工作</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="redis各程序功能"><a href="#redis各程序功能" class="headerlink" title="redis各程序功能"></a><font color="#CDAA7D">redis各程序功能</font></h3><pre><code>redis-benchmark         # redis性能测试工具redis-check-aof         # aof日志检查工具redis-check-rdb         # rdb日志检查工具redis-cli               # redis服务客户端redis-server            # redis服务程序redis-sentinel          # redis哨兵 用于集群检查主从状态 实际上这个是redis-server的软链接</code></pre><h3 id="redis支持的键值数据类型"><a href="#redis支持的键值数据类型" class="headerlink" title="redis支持的键值数据类型"></a><font color="#CDAA7D">redis支持的键值数据类型</font></h3><ul><li><a href="/2016/05/20/redis/redis字符串类型"><font color="#7EC0EE">字符串类型</font></a></li><li><a href="#"><font color="#7EC0EE">散列类型</font></a></li><li><a href="#"><font color="#7EC0EE">列表类型</font></a></li><li><a href="#"><font color="#7EC0EE">集合类型</font></a></li><li><a href="#"><font color="#7EC0EE">有序集合类型</font></a></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Redis是一个开源的使用ANSI C语言编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的API。从2010年3月15日起，Redis的开发工作由VMware主持。从2013年5月开始，Redis的开发由Pivotal赞助。&lt;br&gt;&lt;a href=&quot;http://baike.baidu.com/view/4595959.htm&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;font color=&quot;#AAAAAA&quot;&gt;百度百科&lt;/font&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="Redis" scheme="http://www.yunfwe.cn/categories/Redis/"/>
    
    
      <category term="nosql" scheme="http://www.yunfwe.cn/tags/nosql/"/>
    
      <category term="redis" scheme="http://www.yunfwe.cn/tags/redis/"/>
    
  </entry>
  
  <entry>
    <title>Nginx配置文件详解</title>
    <link href="http://www.yunfwe.cn/2016/05/17/2016/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/"/>
    <id>http://www.yunfwe.cn/2016/05/17/2016/nginx%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E8%AF%A6%E8%A7%A3/</id>
    <published>2016-05-17T02:36:56.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Nginx丰富的功能实现 都是通过配置文件完成的 Nginx配置文件的结构非常简单易懂 而且又十分强大 下面就是Nginx配置文件的结构说明 以及一些常用配置项的解释<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>nginx</td><td style="text-align:center">1.9.13</td><td style="text-align:right"><a href="http://nginx.org/download/nginx-1.9.13.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="Nginx配置文件结构"><a href="#Nginx配置文件结构" class="headerlink" title="Nginx配置文件结构"></a><font color="#CDAA7D">Nginx配置文件结构</font></h3><blockquote><p>Nginx配置文件是一个纯文本文件 默认位置位于 <prefix>/conf/nginx.conf 配置文件内容是以block的形式组织 每个block用 {} 表示 block内可以包含block 其关系如下:</prefix></p></blockquote><pre><code>+--------------------------------+|              main              |      main 全局配置 pid文件位置 运行用户等配置|    +-----------------------+   ||    |        events         |   |      events 设定Nginx工作模式 比如epoll select等|    +-----------------------+   ||  +---------------------------+ ||  |            HTTP           | |      HTTP核心模块|  | +-----------------------+ | ||  | |         server        | | |      server 每一个server都可以视为一个虚拟主机|  | | +-------------------+ | | ||  | | |      location     | | | |      location 匹配网页位置|  | | +-------------------+ | | ||  | | +-------------------+ | | ||  | | |      location     | | | |      一个server可以存在多个不同的location|  | | +-------------------+ | | ||  | +-----------------------+ | ||  | +-----------------------+ | ||  | |         server        | | |      多个server就可以启动多个虚拟主机|  | +-----------------------+ | ||  +---------------------------+ |+--------------------------------+</code></pre><h3 id="Nginx配置文件参数"><a href="#Nginx配置文件参数" class="headerlink" title="Nginx配置文件参数"></a><font color="#CDAA7D">Nginx配置文件参数</font></h3><pre><code>#user  nobody;                          # 默认运行用户 编译时未指定的话为nobodyworker_processes  4;                    # Nginx主进程要开启多少个工作进程 一般为当前CPU核心数worker_cpu_affinity 0001 0010 0100 1000;   # 将每个进程绑定到CPU的每个核心上 可以略提高性能#error_log  logs/error.log;             # 错误日志的位置 默认是安装目录下的logs/error.log#error_log  logs/error.log  notice;     # 可以在日志后面添加纪录级别 #error_log  logs/error.log  info;       # 可选项有: [debug|info|notice|warn|error|crit]#pid        logs/nginx.pid;             # pid文件路径 nginx -s 控制服务就是从这里读取主进程的PIDworker_rlimit_nofile 65535;             # 指定文件描述符数量 增大可以让Nginx处理更多连接                                    # 还需要增大系统允许进程打开文件描述符的上限 ulimit -n 65536events {    use epoll;                          # Nginx默认会选择最适合的工作模式 linux一般为epoll                                        # 支持:[select | poll | kqueue | epoll | /dev/poll]    worker_connections  65535;          # Nginx每个工作进程最大的连接数}                                       # 最大客户连接数为 worker_processes * worker_connections http {    include       mime.types;         # 其他的block配置 可以通过include导入 这样可以很方便管理配置    default_type  application/octet-stream; # 响应类型未定义content-type时 文件默认类型为二进制流                                             # mime.types中包含文件扩展名与文件类型映射表    #log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;    #                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;    #                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;                                      # 定义access.log日志的格式 main为格式名称     access_log  logs/access.log  main;      # 默认access.log的位置 以及使用main中定义的格式    client_max_body_size     20m;           # 设置允许客户上传大小    client_header_buffer_size   32k;        # 客户端请求 header_buffer大小 默认1k    large_client_header_buffers  4 32k;     # 指定客户请求header_buffer的缓存最大数量和大小    sendfile        on;                     # 开启高效的文件传输模式    tcp_nopush      on;                     # 开启tcp_nopush和tcp_nodelay用于防止网络阻塞    tcp_nodelay     on;    #keepalive_timeout  0;    keepalive_timeout  65;                  # 客户端连接后保持连接的超时时间    client_header_timeout  10;              # 设置客户端请求头读取超时时间                                             # 超时将返回Request time out (408)    client_body_timeout    10;              # 设置客户端请求主体读取超时时间  超时也将返回408    send_timeout           10;              # 指定响应客户端的超时时间                                            # 如果超过这个时间 客户端没有任何活的 Nginx将关闭连接    gzip  on;                               # 开启还是关闭gzip模块 on表示开启 实时压缩输出数据流    gzip_min_length  1k;                    # 允许压缩页面最小字节数 小于1k的文件可能越压越大    gzip_buffers     4  16k;                # 申请4个单位16KB的内存做压缩结果流缓存 默认源文件大小    gzip_http_version  1.1;                 # 用于识别HTTP协议版本 默认 1.1    gzip_comp_level  2;                     # 压缩等级 1 表示最快压缩 但压缩比最小 9反之    gzip_types  text/plain application/x-javascript text/css application/xml;   # 指定压缩类型    gzip_vary  on;                          # 让前端的缓存服务器缓存经过gzip压缩的页面    server {                                # server段就是虚拟主机的配置        listen       80;                    # 监听所有IP的80端口 可以指定单个IP        server_name  localhost;             # 用来指定IP地址或域名 多个域名间用空格分开        #charset koi8-r;                    # 用于设置网页默认编码        #access_log  logs/host.access.log  main;    # 每一个虚拟主机也可以定义单独的access.log        location / {                        # URL地址匹配设置            root   /var/www/html;           # 网页根目录            index  index.html index.htm;    # 默认首页地址 会先寻找index.html 然后往后        }        location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$  {   # 匹配以这些格式结尾的请求            root    /var/www/static;                    # 匹配到的请求从这个目录找文件            expires 30d;                                # 客户端缓存静态文件过期时间30天        }        error_page  404              /404.html;         # 自定义404页面 /404.html为root指定的位置        # redirect server error pages to the static page /50x.html        #        error_page   500 502 503 504  /50x.html;        # 自定义50x页面 到/50x.html        location = /50x.html {                          # 匹配50x页面的请求            root   html;                                # 匹配到的请求从这个目录找文件        }        # proxy the PHP scripts to Apache listening on 127.0.0.1:80        #        location ~ \.php$ {                             # 匹配php页面的请求            index index.php                             # 默认索引index.php            proxy_pass   http://127.0.0.1               # 匹配到的请求转发到本机80端口处理        }        location ~ \.jsp$ {                             # 匹配jsp页面的请求            index index.jsp                             # 默认索引index.jsp            proxy_pass   http://127.0.0.1:8080          # 匹配到的请求转发到本机8080端口处理        }        location /status {                              # 匹配status的请求            stub_status on;                             # 开启Nginx工作状态统计            access_log    logs/status.log;              # 状态统计页面访问日志            auth_basic    &quot;Nginx Status&quot;;               # 自定义提醒 认证界面会显示            auth_basic_user_file    /var/www/htpasswd;  # 认证密码文件 htpasswd工具由httpd提供        }                                               # 访问http://host/status 就可以看到状态统计了        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000        #        #location ~ \.php$ {                    # FastCGI模式        #    root           /var/www/html;      # php页面根目录        #    fastcgi_pass   127.0.0.1:9000;     # FastCGI监听地址 也可以使用unix套接字监听地址        #    fastcgi_index  index.php;          # 索引文件        #    fastcgi_param  SCRIPT_FILENAME  /var/www/html$fastcgi_script_name;  # php脚本全路径        #    include        fastcgi_params;        #}        # deny access to .htaccess files, if Apache&apos;s document root        # concurs with nginx&apos;s one        #        #location ~ /\.ht {                     # 匹配ht开头的文件        #    deny  all;                         # 规则是全部拒绝        #}    }    # another virtual host using mix of IP-, name-, and port-based configuration    #    #server {                                            # 另一台虚拟主机    #    listen       8000;                                  #    listen       somename:8080;    #    server_name  somename  alias  another.alias;    #    location / {    #        root   html;    #        index  index.html index.htm;    #    }    #}    # HTTPS server    #    #server {                                           # 配置https网站    #    listen       443 ssl;                          # 监听443端口 ssl加密    #    server_name  localhost;    #    ssl_certificate      cert.pem;                 # 证书需要用openssl生成 nginx需要添加ssl模块    #    ssl_certificate_key  cert.key;                 # 证书key    #    ssl_session_cache    shared:SSL:1m;    #    ssl_session_timeout  5m;    #    ssl_ciphers  HIGH:!aNULL:!MD5;    #    ssl_prefer_server_ciphers  on;    #    location / {    #        root   html;    #        index  index.html index.htm;    #    }    #}}</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><blockquote><p>Nginx还有其他配置块 比如upstream (负载均衡) 或者其他模块提供的功能 这里只说明一些常用的配置块</p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Nginx丰富的功能实现 都是通过配置文件完成的 Nginx配置文件的结构非常简单易懂 而且又十分强大 下面就是Nginx配置文件的结构说明 以及一些常用配置项的解释&lt;br&gt;
    
    </summary>
    
    
      <category term="Nginx" scheme="http://www.yunfwe.cn/categories/Nginx/"/>
    
    
      <category term="nginx" scheme="http://www.yunfwe.cn/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Nginx服务控制</title>
    <link href="http://www.yunfwe.cn/2016/05/16/2016/nginx%E6%9C%8D%E5%8A%A1%E6%8E%A7%E5%88%B6/"/>
    <id>http://www.yunfwe.cn/2016/05/16/2016/nginx%E6%9C%8D%E5%8A%A1%E6%8E%A7%E5%88%B6/</id>
    <published>2016-05-16T06:30:10.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>Nginx可以通过向主进程发送信号的方式进行控制 甚至可以完成在不停止服务的情况下 对程序进行重启 升级 甚至回滚操作<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>nginx</td><td style="text-align:center">1.9.13</td><td style="text-align:right"><a href="http://nginx.org/download/nginx-1.9.13.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="启动Nginx"><a href="#启动Nginx" class="headerlink" title="启动Nginx"></a><font color="#CDAA7D">启动Nginx</font></h3><blockquote><p>Nginx的启动很简单 如果配置了环境变量 可以直接通过nginx命令启动 也可以通过绝对路径启动</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><p>参数 “-c” 指定了配置文件的路径 如果不使用 “-c” 参数的话 nginx 会默认加载编译选项 <strong>--conf-path=PATH</strong> 中指定的路径</p><h3 id="关闭Nginx"><a href="#关闭Nginx" class="headerlink" title="关闭Nginx"></a><font color="#CDAA7D">关闭Nginx</font></h3><blockquote><p>在早期 Nginx的关闭一般通过发送系统信号给Nginx主程序的方式来停止Nginx 之后的版本 Nginx添加了 “-s” 参数可以对Nginx主程序进行控制 通过信号的方式 需要先找到Nginx master进程的PID号 或者通过查看 nginx.pid文件来获取Nginx主进程的PID<br>Nginx能处理的停止信号有两种 一种是 QUIT  当Nginx接受到这个信号时 会处理完当前所有的请求 并有序的关闭服务<br>另一种是 TERM 或 INT  Nginx收到这两种信号 会尽可能快的停止web服务 不保证处理完所有请求<br>当然 还有一种Nginx不可控的信号 KILL  会强制杀死Nginx的进程</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">PID=`ps aux |grep nginx |grep master |awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">PID=`cat /var/run/nginx/nginx.pid`</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$PID</span></span><br></pre></td></tr></table></figure><p>通过以上方法 即可获取Nginx主程序的PID号了 接下来就是通过kill命令向Nginx发送信号</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -QUIT <span class="variable">$PID</span>             <span class="comment"># 安全从容的退出</span></span><br><span class="line"><span class="built_in">kill</span> -INT <span class="variable">$PID</span>              <span class="comment"># 尽可能快的退出 </span></span><br><span class="line"><span class="built_in">kill</span> <span class="variable">$PID</span>                   <span class="comment"># 尽可能快的退出 因为默认kill发送的是TERM信号</span></span><br><span class="line"><span class="built_in">kill</span> -KILL <span class="variable">$PID</span>             <span class="comment"># 强制杀死</span></span><br></pre></td></tr></table></figure><p>较高版本的Nginx的 “-s” 参数也可以对Nginx进行控制 Nginx会读取nginx.pid文件来获取master进程的PID 然后向这个PID发送信号</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s quit         <span class="comment"># 安全从容的退出 实质上还是发送QUIT信号</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s stop         <span class="comment"># 尽可能快的退出 实质上发送TREM或INT信号</span></span><br></pre></td></tr></table></figure><h3 id="Nginx平滑重启"><a href="#Nginx平滑重启" class="headerlink" title="Nginx平滑重启"></a><font color="#CDAA7D">Nginx平滑重启</font></h3><blockquote><p>在Nginx运行过程中 如果修改了配置文件 但是又不想停止Nginx再重启让配置文件生效 也可以通过发送信号的方式 通知Nginx重新读取配置文件</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -t -c /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf</span><br></pre></td></tr></table></figure><p>修改nginx配置文件后 可以通过 -t 参数对配置文件进行检测 如果不通过 -c 指定配置文件 会检查默认的配置文件 当检查通过 就可以通知Nginx主进程重新读取了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -HUP <span class="variable">$PID</span>              <span class="comment"># 通过HUP信号 可以通知Nginx主进程重新读取配置文件</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reload       <span class="comment"># 同理 reload也是向Nginx主进程发送HUP信号</span></span><br></pre></td></tr></table></figure><p>Nginx在收到HUP信号时 回先解析配置文件 如果解析成功 就应用新的配置文件 之后 Nginx运行新的工作进程 并从容关闭旧的工作进程 等所有的请求处理完毕后 旧的工作进程被关闭 </p><h3 id="Nginx平滑升级"><a href="#Nginx平滑升级" class="headerlink" title="Nginx平滑升级"></a><font color="#CDAA7D">Nginx平滑升级</font></h3><blockquote><p>如果想给正在运行中的Nginx升级版本 或者添加/删除服务模块 可以在服务不间断的情况下 对Nginx进行升级</p></blockquote><ol><li>备份原本的nginx二进制 为了意外恢复 并使用新的二进制程序代替了以前的位置</li><li>向Nginx主程序发送USR2信号</li><li>旧版的Nginx主程序将nginx.pid重命名为nginx.pid.oldbin 然后执行新版本的Nginx可执行程序 将新的PID写入nginx.pid文件</li><li>当前新旧两个Nginx进程会同时提供服务 还需要手动关闭旧Nginx主进程 仅保留新的Nginx主进程</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/<span class="built_in">local</span>/nginx/sbin/&#123;nginx,nginx.old&#125;</span><br><span class="line">cp objs/nginx /usr/<span class="built_in">local</span>/nginx/sbin/nginx       </span><br><span class="line"><span class="comment"># 默认nginx编译后在源码包的objs目录中 也可以直接make install覆盖安装</span></span><br><span class="line"><span class="built_in">kill</span> -USR2 <span class="variable">$PID</span>             <span class="comment"># 向Nginx主进程的PID号发送USR2信号</span></span><br></pre></td></tr></table></figure><p>现在可以看到 新旧两个Nginx主进程在同时提供服务 发送 WINCH 信号 可以通知Nginx主进程从容的关闭工作进程(worker process) 这时将只剩下新的Nginx的工作进程提供服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -WINCH <span class="variable">$PID</span></span><br></pre></td></tr></table></figure></p><p>如果一段时间 新Nginx工作正常 就可以向旧版Nginx发送退出信号 结束掉旧Nginx的主进程了 旧进程退出后还会移除nginx.pid.oldbin文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> <span class="variable">$OLD_PID</span></span><br></pre></td></tr></table></figure></p><p>如果运行一段时间 发现并不是理想中的那种工作状态 那么可以发送 HUP 信号向旧Nginx主进程 让其重新打开工作进程 接着向新Nginx主进程发送 QUIT 信号 从容关闭主进程 最后恢复旧nginx的二进制文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -HUP <span class="variable">$OLD_PID</span></span><br><span class="line"><span class="built_in">kill</span> -QUIT <span class="variable">$PID</span></span><br><span class="line">mv /usr/<span class="built_in">local</span>/nginx/sbin/&#123;nginx.old,nginx&#125;      <span class="comment"># 不要忘记恢复旧的二进制文件</span></span><br></pre></td></tr></table></figure></p><h3 id="Nginx日志控制"><a href="#Nginx日志控制" class="headerlink" title="Nginx日志控制"></a><font color="#CDAA7D">Nginx日志控制</font></h3><blockquote><p>Nginx的访问日志会记录客户端的每次一请求 所以在用户量大的情况下 会很容易变得很大 也可以通过发送信号的方式进行控制日志 而不用关闭Nginx服务</p></blockquote><p>Nginx主进程启动后 便会一直打开access.log日志文件 当服务器被长时间的访问 这个日志会越来越大 不利于日后的清理 由于这个日志文件被Nginx一直处于打开的状态 冒然删除这个日志文件并不是个很好的方法 而且删除后 Nginx还会向该文件的inode节点写入日志数据 因此 文件即使被删除 文件系统空间也不会释放 这样就只有重启Nginx才能释放空间并读写新的日志了</p><p>因此 管理access.log的方式不应该用直接删除文件的方式 如果对日志内容不在意 可以直接清空文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> &gt; /usr/<span class="built_in">local</span>/nginx/logs/access.log</span><br></pre></td></tr></table></figure></p><p>还有一个更好的方式 就是让Nginx重新打开一个新的文件进行读取 先将原来的access.log重命名 因为重命名并不会更改文件的inode节点 所以不会影响Nginx程序的日志写入 接着发送 USR1 信号 Nginx主程序将打开一个新的access.log文件开始写入<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -USR1 <span class="variable">$PID</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx -s reopen           <span class="comment"># 重新打开日志文件 和 USR1 同理</span></span><br></pre></td></tr></table></figure></p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><blockquote><p>Nginx支持的信号汇总</p></blockquote><table><thead><tr><th>信号类型</th><th style="text-align:left">功能</th></tr></thead><tbody><tr><td>TREM 或 INT</td><td style="text-align:left">快速关闭Nginx服务</td></tr><tr><td>QUIT</td><td style="text-align:left">从容关闭Nginx服务</td></tr><tr><td>HUP</td><td style="text-align:left">通知Nginx重新读取配置文件</td></tr><tr><td>USR1</td><td style="text-align:left">重新打开日志文件 常用于日志分割</td></tr><tr><td>USR2</td><td style="text-align:left">平滑升级可执行程序</td></tr><tr><td>WINCH</td><td style="text-align:left">从容关闭工作进程</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;Nginx可以通过向主进程发送信号的方式进行控制 甚至可以完成在不停止服务的情况下 对程序进行重启 升级 甚至回滚操作&lt;br&gt;
    
    </summary>
    
    
      <category term="Nginx" scheme="http://www.yunfwe.cn/categories/Nginx/"/>
    
    
      <category term="nginx" scheme="http://www.yunfwe.cn/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>Nginx编译参数详解</title>
    <link href="http://www.yunfwe.cn/2016/05/16/2016/nginx%E7%BC%96%E8%AF%91%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/"/>
    <id>http://www.yunfwe.cn/2016/05/16/2016/nginx%E7%BC%96%E8%AF%91%E5%8F%82%E6%95%B0%E8%AF%A6%E8%A7%A3/</id>
    <published>2016-05-16T03:25:49.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>主要介绍Nginx编译安装的可选项 以后对Nginx进行升级 或者功能拓展都可以查阅 查找合适的模块<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>nginx</td><td style="text-align:center">1.9.13</td><td style="text-align:right"><a href="http://nginx.org/download/nginx-1.9.13.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xf nginx-1.9.13.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.9.13</span><br><span class="line">./configure --<span class="built_in">help</span></span><br></pre></td></tr></table></figure><pre><code>--help                             打印帮助信息--prefix=PATH                      Nginx安装路径 默认 /usr/local/nginx--sbin-path=PATH                   Nginx可执行文件安装路径 默认 &lt;prefix&gt;/sbin/nginx--modules-path=PATH                Nginx动态模块安装路径 默认 &lt;prefix&gt;/modules--conf-path=PATH                   Nginx配置文件的路径 默认 &lt;prefix&gt;/conf/nginx.conf--error-log-path=PATH              nginx.conf中没有指定的情况下 错误日志默认路径 &lt;prefix&gt;/logs/error.log--pid-path=PATH                    nginx.conf中没有指定的情况下 pid文件默认路径 &lt;prefix&gt;/logs/nginx.pid--lock-path=PATH                   nginx.lock文件的路径--user=USER                        nginx.conf中没有指定的情况下 Nginx使用的用户 默认 nobody--group=GROUP                      nginx.conf中没有指定的情况下 Nginx使用的用户组 默认 nobody--build=NAME                       指定编译的名字--builddir=DIR                     指定编译的目录--with-select_module               允许select模式 根据configure检测 如果没有更好的 select将是默认方式--without-select_module            不允许select模式--with-poll_module                 允许poll模式--without-poll_module              不允许poll模式--with-threads                     允许线程池支持--with-file-aio                    允许file aio支持 (文件异步读写模型)--with-ipv6                        启动 ipv6 支持--with-http_ssl_module             提供HTTPS支持--with-http_v2_module              支持HTTP2协议--with-http_realip_module          获取客户机真实IP模块 --with-http_addition_module        添加在响应之前或之后追加内容的模块--with-http_xslt_module            通过XSLT模板转换XML应答--with-http_xslt_module=dynamic    通过XSLT模板转换XML应答 编译为动态模块--with-http_image_filter_module    传输JPEG/GIF/PNG 图片的一个过滤器--with-http_image_filter_module=dynamic       同上 编译为动态模块--with-http_geoip_module           获取IP所属地的模块--with-http_geoip_module=dynamic   获取IP所属地的模块 编译为动态模块--with-http_sub_module             允许替换响应中的一些文本--with-http_dav_module             开启WebDAV扩展动作模块--with-http_flv_module             提供flv播放服务的模块--with-http_mp4_module             提供mp4播放服务的模块--with-http_gunzip_module          提供gunzip压缩的模块--with-http_gzip_static_module     在线实时压缩输出数据流 能有效节省带宽--with-http_auth_request_module    客户子请求的认证基础--with-http_random_index_module    随机目录索引--with-http_secure_link_module     检查客户请求链接 可以用于下载防盗链--with-http_degradation_module     允许在内存不足的情况下返回204或444码--with-http_slice_module           切片模块--with-http_stub_status_module     Nginx工作状态统计模块--without-http_charset_module      禁用重新编码web页面模块--without-http_gzip_module         禁用在线实时压缩输出数据流--without-http_ssi_module          禁用服务器端包含模块--without-http_userid_module       禁用用户ID模块 该模块为用户通过cookie验证身份--without-http_access_module       禁用访问模块 对于指定的IP段 允许访问配置--without-http_auth_basic_module   禁用基本的认证模块--without-http_autoindex_module    禁用目录自动索引模块--without-http_geo_module          禁用Geo模块--without-http_map_module          禁用Map模块 该模块允许你声明map区段--without-http_split_clients_module 禁用基于某些条件将客户端分类模块--without-http_referer_module      禁用 过滤请求 拒绝报头中Referer值不正确的请求的模块--without-http_rewrite_module      禁用url重写模块--without-http_proxy_module        禁用http代理模块--without-http_fastcgi_module      禁用fastcgi模块--without-http_uwsgi_module        禁用uwsgi模块--without-http_scgi_module         禁用scgi模块--without-http_memcached_module    禁用Memcached模块--without-http_limit_conn_module   禁用连接限制模块--without-http_limit_req_module    禁用限制用户连接总和的模块--without-http_empty_gif_module    禁用empty_gif模块--without-http_browser_module      禁用Browser模块--without-http_upstream_hash_module    以下是禁用负载均衡相关的一些模块--without-http_upstream_ip_hash_module--without-http_upstream_least_conn_module--without-http_upstream_keepalive_module--without-http_upstream_zone_module--with-http_perl_module            通过此模块 nginx可以直接使用perl--with-http_perl_module=dynamic    编译为动态模块--with-perl_modules_path=PATH      设定模块路径--with-perl=PATH                   设定perl库文件路径--http-log-path=PATH               设定http访问日志路径--http-client-body-temp-path=PATH  设定http客户端请求临时文件路径--http-proxy-temp-path=PATH        设定http代理临时文件路径--http-fastcgi-temp-path=PATH      设定http fastcgi临时文件路径--http-uwsgi-temp-path=PATH        设定http uwsgi临时文件路径--http-scgi-temp-path=PATH         设定http scgi临时文件路径--without-http                     禁用http server功能--without-http-cache               禁用http cache功能--with-mail                        启用POP3/IMAP4/SMTP代理模块支持--with-mail=dynamic                编译为动态模块--with-mail_ssl_module             启用加密的邮箱代理模块--without-mail_pop3_module         禁用pop3模块--without-mail_imap_module         禁用imap模块--without-mail_smtp_module         禁用smtp模块--with-stream                      启动tcp/udp代理模块--with-stream=dynamic              编译为动态模块--with-stream_ssl_module           启动加密的tcp/udp代理模块--without-stream_limit_conn_module --without-stream_access_module     --without-stream_upstream_hash_module--without-stream_upstream_least_conn_module--without-stream_upstream_zone_module--with-google_perftools_module     启用google_perftools模块 优化高并发性能--with-cpp_test_module             启用ngx_cpp_test_module支持--add-module=PATH                  启用拓展模块 指定路径--add-dynamic-module=PATH          启用动态拓展模块--with-cc=PATH                     指定c编译器路径--with-cpp=PATH                    指定C预处理路径--with-cc-opt=OPTIONS              设置C编译器参数--with-ld-opt=OPTIONS              设置链接文件参数--with-cpu-opt=CPU                 指定编译的CPU 可选值:                                   pentium, pentiumpro, pentium3, pentium4,                                   athlon, opteron, sparc32, sparc64, ppc64--without-pcre                     禁用pcre库 (正则表达式)--with-pcre                        启用pcre库--with-pcre=DIR                    指定pcre库文件目录--with-pcre-opt=OPTIONS            在编译时为pcre库设置附加参数--with-pcre-jit                    构建pcre提供jit编译支持--with-md5=DIR                     指向md5库文件目录--with-md5-opt=OPTIONS             在编译时为md5库设置附加参数--with-md5-asm                     使用md5汇编源--with-sha1=DIR                    指向sha1库目录--with-sha1-opt=OPTIONS            在编译时为sha1库设置附加参数--with-sha1-asm                    使用sha1汇编源--with-zlib=DIR                    指向zlib库目录--with-zlib-opt=OPTIONS            在编译时为zlib设置附加参数--with-zlib-asm=CPU                为指定的CPU使用zlib汇编源进行优化--with-libatomic                   为原子内存的更新操作的实现提供一个架构--with-libatomic=DIR               指向libatomic_ops安装目录--with-openssl=DIR                 指向openssl源码目录--with-openssl-opt=OPTIONS         在编译时为openssl设置附加参数--with-debug                       启用debug信息</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><blockquote><p>只需要在编译nginx时添加相应的选项就可以了 <a href="/2016/03/31/nginx/nginx编译安装"><font color="#AAAAAA">Nginx详细编译安装教程</font></a></p></blockquote>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;主要介绍Nginx编译安装的可选项 以后对Nginx进行升级 或者功能拓展都可以查阅 查找合适的模块&lt;br&gt;
    
    </summary>
    
    
      <category term="Nginx" scheme="http://www.yunfwe.cn/categories/Nginx/"/>
    
    
      <category term="nginx" scheme="http://www.yunfwe.cn/tags/nginx/"/>
    
  </entry>
  
  <entry>
    <title>构建基于Busybox的Nginx服务容器</title>
    <link href="http://www.yunfwe.cn/2016/04/22/2016/%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8EBusybox%E7%9A%84Nginx%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8/"/>
    <id>http://www.yunfwe.cn/2016/04/22/2016/%E6%9E%84%E5%BB%BA%E5%9F%BA%E4%BA%8EBusybox%E7%9A%84Nginx%E6%9C%8D%E5%8A%A1%E5%AE%B9%E5%99%A8/</id>
    <published>2016-04-22T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.869Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>用docker容器进行打包服务非常方便 不需要考虑依赖的问题 只要把容器复制到其他有docker daemon的服务器就可以直接启动 并能很方便的利用Cgroup, Namespace技术实现资源控制和资源隔离<br>这篇文档以Nginx为例 其他的像redis mysql php等服务也是可以使用这个方法进行打包为最精简的 只包含必须依赖的服务容器</p></blockquote><a id="more"></a><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>系统是ubuntu server 15.10版 用ubuntu系统作为docker服务的载体 如果非ubuntu15.10发行版 尽量保证内核版本在3.18以上 Nginx是在CentOS 6.7的容器中编译的 之后在ubuntu上完成打包<br>在容器中编译Nginx只是我的个人习惯 不喜欢将主机环境乱安装一些不必要的包 保持清洁就好 编译什么的就交给容器去做吧</p></blockquote><h3 id="主机环境"><a href="#主机环境" class="headerlink" title="主机环境"></a><font color="#CDAA7D">主机环境</font></h3><table><thead><tr><th>身份</th><th style="text-align:center">系统</th><th style="text-align:right">IP</th></tr></thead><tbody><tr><td>Docker服务</td><td style="text-align:center">ubuntu 15.10</td><td style="text-align:right">172.17.0.1</td></tr><tr><td>Docker容器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.3</td></tr></tbody></table><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a><font color="#CDAA7D">软件环境</font></h3><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>Nginx</td><td style="text-align:center">1.9.15</td><td style="text-align:right"><a href="http://nginx.org/download/nginx-1.9.15.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>Docker</td><td style="text-align:center">1.9.1</td><td style="text-align:right"><a href="http://mirrors.aliyun.com/docker-engine/apt/pool/main/d/docker-engine/docker-engine_1.9.1-0~wily_amd64.deb" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>kernel</td><td style="text-align:center">4.2.0</td><td style="text-align:right"><font color="#AAAAAA">系统自带</font></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><p>以下是打包Nginx服务容器的基本思路</p><ul><li>选用Busybox环境作为基础</li><li>在CentOS 容器中编译Nginx</li><li>将Nginx的运行依赖库和Nginx程序复制到主机环境</li><li>部署到Busybox构建的rootfs中</li><li>导入Docker 查看是否正常运行</li></ul><h3 id="构建Busybox最小容器"><a href="#构建Busybox最小容器" class="headerlink" title="构建Busybox最小容器"></a><font color="#CDAA7D">构建Busybox最小容器</font></h3><blockquote><p>Busybox构建文档：<a href="/2016/04/21/docker/Busybox构建最小容器"><font color="#AAAAAA">点击打开文档内容</font></a><br>构建完毕之后 busybox-1.24.2/_install 就是我们需要当作容器基础的rootfs了 将它复制到随便一个目录 留用</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp -rf busybox-1.24.2/_install/ rootfs</span><br></pre></td></tr></table></figure><h3 id="编译安装Nginx"><a href="#编译安装Nginx" class="headerlink" title="编译安装Nginx"></a><font color="#CDAA7D">编译安装Nginx</font></h3><blockquote><p>Nginx的编译文档：<a href="/2016/03/31/nginx/nginx编译安装"><font color="#AAAAAA">点击打开文档内容</font></a><br>只需要做到文档中make -j4 也就是编译完成就可以了 之后的安装步骤就不按照文档的走了</p></blockquote><h4 id="安装nginx到非默认根"><a href="#安装nginx到非默认根" class="headerlink" title="安装nginx到非默认根"></a><font color="#DDA0DD">安装nginx到非默认根</font></h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make DESTDIR=/nginx install</span><br></pre></td></tr></table></figure><p>通过DESTDIR更改安装Nginx的根位置 以/nginx目录作为nginx安装的根</p><pre><code>[root@localhost nginx-1.9.15]# ls /nginx/usr  var[root@localhost nginx-1.9.15]# tree /nginx//nginx/├── usr│   └── local│       └── nginx│           ├── conf│           │   ├── fastcgi.conf│           │   ├── fastcgi.conf.default│           │   ├── fastcgi_params│           │   ├── fastcgi_params.default│           │   ├── koi-utf│           │   ├── koi-win│           │   ├── mime.types</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /nginx/</span><br><span class="line">mkdir lib lib64                     <span class="comment"># 创建两个依赖库文件夹</span></span><br><span class="line">strip usr/<span class="built_in">local</span>/nginx/sbin/nginx    <span class="comment"># 裁剪nginx二进制的编译跟踪信息 缩减nginx体积</span></span><br></pre></td></tr></table></figure><h4 id="复制Nginx运行依赖库"><a href="#复制Nginx运行依赖库" class="headerlink" title="复制Nginx运行依赖库"></a><font color="#DDA0DD">复制Nginx运行依赖库</font></h4><blockquote><p>接下来查看nginx程序的所有依赖</p></blockquote><pre><code>[root@localhost nginx]# ldd usr/local/nginx/sbin/nginx     linux-vdso.so.1 =&gt;  (0x00007fff3caa3000)    libdl.so.2 =&gt; /lib64/libdl.so.2 (0x00007f9bc2ff8000)    libpthread.so.0 =&gt; /lib64/libpthread.so.0 (0x00007f9bc2ddb000)    libcrypt.so.1 =&gt; /lib64/libcrypt.so.1 (0x00007f9bc2ba3000)    libz.so.1 =&gt; /lib64/libz.so.1 (0x00007f9bc298d000)    libc.so.6 =&gt; /lib64/libc.so.6 (0x00007f9bc25f9000)    /lib64/ld-linux-x86-64.so.2 (0x0000561c3968f000)    libfreebl3.so =&gt; /lib64/libfreebl3.so (0x00007f9bc23f5000)</code></pre><p>将依赖复制到刚才创建的lib或者lib64目录中 如果这个依赖库在系统的lib目录下 那么就复制到lib目录中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cp /lib64/libdl.so.2 lib64/</span><br><span class="line">cp /lib64/libpthread.so.0 lib64/</span><br><span class="line">cp /lib64/libcrypt.so.1 lib64/</span><br><span class="line">cp /lib64/libz.so.1 lib64/</span><br><span class="line">cp /lib64/libc.so.6 lib64/</span><br><span class="line">cp /lib64/ld-linux-x86-64.so.2 lib64/</span><br><span class="line">cp /lib64/libfreebl3.so lib64/</span><br></pre></td></tr></table></figure></p><p> 由于Nginx运行需要使用普通用户 所以需要读取passwd文件 读取解析passwd文件需要用到libnss_files.so.2这个库 所以也需要复制这个库到lib64中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp /lib64/libnss_files.so.2 lib64/</span><br></pre></td></tr></table></figure><p>如果在ubuntu上编译的话libnss_files.so.2位置在/lib/x86_64-linux-gnu/libnss_files.so.2<br>复制完成后lib64目录的内容应该如下所示：</p><pre><code>[root@localhost nginx]# ls lib64/ld-linux-x86-64.so.2  libc.so.6   libfreebl3.so      libpthread.so.0libcrypt.so.1         libdl.so.2  libnss_files.so.2  libz.so.1</code></pre><h3 id="打包Nginx服务容器"><a href="#打包Nginx服务容器" class="headerlink" title="打包Nginx服务容器"></a><font color="#CDAA7D">打包Nginx服务容器</font></h3><blockquote><p>Nginx以及Nginx的运行依赖都已经放到/nginx目录中了 将这个目录移动到和刚才的rootfs同一目录下 然后再创建两个目录 留用</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir build target</span><br></pre></td></tr></table></figure><h4 id="认识overlayFS"><a href="#认识overlayFS" class="headerlink" title="认识overlayFS"></a><font color="#DDA0DD">认识overlayFS</font></h4><blockquote><p>overlay是一种联合挂载的文件系统 可以将几个不同的目录挂载到一个目录中 然后将所有的文件展示出来 而且在挂载的目录中对文件的操作并不会影响到其他目录中实际的文件<br>同时 在新版本的docker中 overlay便是docker容器默认使用的存储驱动 但是overlay在内核大于3.18的版本中才被支持 所以尽量用使用较新内核版本的发行版来玩Docker<br>因为overlay的这些特性 用来辅助制作Nginx服务容器岂不是很方便 因为在挂载的目录中的操作并不会影响基层目录的文件 这样就算误删了文件 也是可以恢复的</p></blockquote><p>现在看起来 应该是这个效果</p><pre><code>root@ubuntu:~# ls -lhtotal 16Kdrwxr-xr-x  9 root root 4.0K Apr 22 12:50 build     # overlay的工作目录drwxr-xr-x  6 root root 4.0K Apr 22 15:34 nginx     # 刚才安装的Nginx目录drwxr-xr-x 18 root root 4.0K Apr 22 11:52 rootfs    # busybox的目录drwxr-xr-x  1 root root 4.0K Apr 22 12:50 target    # 这个就是联合挂载到的目标目录</code></pre><p>检查overlay驱动是否已经加载 否则加载overlay驱动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">lsmod |grep overlay</span><br><span class="line">modprobe overlay</span><br></pre></td></tr></table></figure></p><p>如下所示 那么就可以使用overlay文件系统了 </p><pre><code>root@ubuntu:~# lsmod |grep overlayoverlay                49152  1root@ubuntu:~# cat /proc/filesystems |grep overlaynodev    overlayfsnodev    overlay</code></pre><p>用rootfs和nginx做基层 其中rootfs是第一层 如果还有其他目录 依次用冒号隔开 build做为overlay工作目录  /tmp是overlay必须的一个空目录 将lowerdir中的目录都挂载到target目录上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mount -t overlay overlay -o lowerdir=rootfs:nginx,upperdir=build,workdir=/tmp target/</span><br></pre></td></tr></table></figure></p><p>接下来可以看到target目录中 rootfs和nginx目录中的内容同时出现在target目录中</p><pre><code>root@ubuntu:~# ls target/bin  etc   lib    linuxrc  mnt   root  sbin  tmp  vardev  home  lib64  media    proc  run   sys   usrroot@ubuntu:~# ls target/bin/busybox target/bin/busyboxroot@ubuntu:~# ls target/usr/local/nginx/sbin/nginx target/usr/local/nginx/sbin/nginx</code></pre><p>如果系统刚好不支持overlay文件系统的话 思想原理是相同的 直接将rootfs和nginx目录中的文件都复制到target中吧</p><h4 id="Chroot进行根切换"><a href="#Chroot进行根切换" class="headerlink" title="Chroot进行根切换"></a><font color="#DDA0DD">Chroot进行根切换</font></h4><blockquote><p>接下来就是配置Nginx的运行环境了 这样才能保证Nginx打包为容器后能正常的运行<br>通过chroot工具切换当前根到target目录中 这也算文件系统隔离一种的方式</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chroot target sh</span><br></pre></td></tr></table></figure><p>可以看到 进入到了一个不同的shell中 ls / 竟然发现了linuxrc文件 现在已经将根切换到target目录中了</p><pre><code>/ # ls /bin      etc      lib      linuxrc  mnt      root     sbin     tmp      vardev      home     lib64    media    proc     run      sys      usr</code></pre><h4 id="根据执行Nginx的报错进行配置"><a href="#根据执行Nginx的报错进行配置" class="headerlink" title="根据执行Nginx的报错进行配置"></a><font color="#DDA0DD">根据执行Nginx的报错进行配置</font></h4><p>接下来的操作在这个根中进行 配置Nginx的运行环境 这些操作都是通过不断的执行nginx程序 查看nginx的报错总结的</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">adduser nginx                       <span class="comment"># 添加nginx用户 </span></span><br><span class="line">mkdir -p /var/tmp/nginx/client/     <span class="comment"># 创建nginx运行需要的目录</span></span><br><span class="line">mkdir -p /var/www/html              <span class="comment"># 以后将使用这个路径作为Nginx网页根目录</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/nginx/sbin/nginx /usr/sbin/            <span class="comment"># 添加nginx软链接到环境变量中</span></span><br><span class="line">ln -s /usr/<span class="built_in">local</span>/nginx/conf/nginx.conf /etc/nginx.conf  <span class="comment"># 添加配置文件软连接到/etc目录</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'&lt;h1&gt;hello nginx&lt;/h1&gt;'</span> &gt; /var/www/html/index.html  <span class="comment"># 创建一个索引文件</span></span><br></pre></td></tr></table></figure><p>再次运行nginx程序 这时候遇到了ginx: [emerg] open(“/dev/null”) failed的错误 原因是打不开这个设备文件 这个只能通过启动为一个Docker容器来解决了</p><pre><code>/ # /usr/local/nginx/sbin/nginx nginx: [emerg] open(&quot;/dev/null&quot;) failed (2: No such file or directory)</code></pre><h4 id="修改Nginx配置文件"><a href="#修改Nginx配置文件" class="headerlink" title="修改Nginx配置文件"></a><font color="#DDA0DD">修改Nginx配置文件</font></h4><p>剩下的就是修改nginx的配置文件了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/nginx.conf</span><br></pre></td></tr></table></figure><pre><code>第一行添加 daemon off; 让nginx前台运行 这个必须添加http{}中添加 autoindex on; 运行目录索引 可以根据实际情况添加http{  server{    location / {        root   /var/www/html;           # root改为/var/www/html 可以根据实际情况更改        index  index.html index.htm;    }  }}</code></pre><h4 id="将目录打包为Docker容器"><a href="#将目录打包为Docker容器" class="headerlink" title="将目录打包为Docker容器"></a><font color="#DDA0DD">将目录打包为Docker容器</font></h4><p>输入exit或者键入 Ctrl+d 就可以退出chroot 回到正常的根中了 接下来 将数据打包为Docker容器 可以看到 大小仅仅8M<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> target/</span><br><span class="line">tar -cf /dev/stdout *|docker import - nginx:1.9.15</span><br></pre></td></tr></table></figure></p><pre><code>root@ubuntu:~/target# docker imagesREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZEnginx               1.9.15              99089cedcc48        3 seconds ago       8.071 MB</code></pre><h4 id="启动容器-检查是否成功"><a href="#启动容器-检查是否成功" class="headerlink" title="启动容器 检查是否成功"></a><font color="#DDA0DD">启动容器 检查是否成功</font></h4><p>然后后台启动这个容器 并且查看容器IP 通过curl命令检查nginx是否正常运行 可以看到 成功返回 hello nginx<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker run -d --name nginx nginx:1.9.15 nginx</span><br><span class="line">docker inspect --format <span class="string">'&#123;&#123;.NetworkSettings.IPAddress&#125;&#125;'</span> nginx</span><br></pre></td></tr></table></figure></p><pre><code>root@ubuntu:~/target# docker run -d --name nginx nginx:1.9.15 nginx0db0d45152948339fb0c9a23e8dfba6798c650e24075d725ba2d3021eb3b801broot@ubuntu:~/target# docker inspect --format &apos;{{.NetworkSettings.IPAddress}}&apos; nginx172.17.0.8root@ubuntu:~/target# curl 172.17.0.8&lt;h1&gt;hello nginx&lt;/h1&gt;root@ubuntu:~/target#</code></pre><p>这样 一个非常小 但是可以提供完整功能的Nginx服务容器就打包完成了 </p><h4 id="overlayFS文件误删的恢复"><a href="#overlayFS文件误删的恢复" class="headerlink" title="overlayFS文件误删的恢复"></a><font color="#DDA0DD">overlayFS文件误删的恢复</font></h4><p>如果在制作这个容器的过程中 不幸误删了target目录中的文件 还记的build这个文件吗<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf linuxrc</span><br></pre></td></tr></table></figure></p><pre><code>root@ubuntu:~/target# ls -l ../build/linuxrc c--------- 1 root root 0, 0 Apr 22 17:28 ../build/linuxrc</code></pre><p>可以看到 build目录中出现了一个主次设备号都为0的字符设备 只要删除了这个字符设备 文件就恢复了<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -rf ../build/linuxrc</span><br></pre></td></tr></table></figure></p><pre><code>root@ubuntu:~/target# lsbin  etc   lib    linuxrc  mnt   root  sbin  tmp  vardev  home  lib64  media    proc  run   sys   usr</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="将Nginx容器镜像保存为文件"><a href="#将Nginx容器镜像保存为文件" class="headerlink" title="将Nginx容器镜像保存为文件"></a><font color="#CDAA7D">将Nginx容器镜像保存为文件</font></h3><blockquote><p>如果想把这个容器共享给其他人使用 除了使用push到仓库中 还可以直接通过文件的方式共享</p></blockquote><h4 id="配置一个默认启动命令"><a href="#配置一个默认启动命令" class="headerlink" title="配置一个默认启动命令"></a><font color="#DDA0DD">配置一个默认启动命令</font></h4><blockquote><p>导入这个Nginx服务容器之后 每次启动都需要手动输入nginx命令 这样显的比较麻烦 可以通过Dockerfile的方式给这个容器配置一个默认的启动命令</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim Dockerfile</span><br></pre></td></tr></table></figure><pre><code>键入以下内容：root@ubuntu:~# cat Dockerfile FROM nginx:1.9.15CMD nginxnginx就是启动的命令 如果命令还带有参数 可以直接写出 例如 CMD nginx -s reload</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t nginx .         <span class="comment"># 给新镜像配置一个标签 记得不要忘记了最后的 .</span></span><br></pre></td></tr></table></figure><pre><code>root@ubuntu:~# docker build -t nginx .Sending build context to Docker daemon 25.09 MBStep 1 : FROM nginx:1.9.15 ---&gt; 99089cedcc48Step 2 : CMD nginx ---&gt; Running in 12b1a81d553c ---&gt; 114ba21e8f1cRemoving intermediate container 12b1a81d553cSuccessfully built 114ba21e8f1croot@ubuntu:~# docker run -d nginx:latest0f3f39dd3aea5a16b10a470ffecca716b31d0deab5420b07ee86bd1180bc2256</code></pre><p>可以看到 启动这个新容器已经不需要输入nginx命令了 其实还有一个方法可以更改默认启动命令 通过直接修改镜像的配置文件<br>可以看到 nginx:1.9.15镜像的ID是99089cedcc48 这只是完整ID的一部分 配置信息保存在/var/lib/docker/graph中</p><pre><code>root@ubuntu:~# docker imagesREPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZEnginx               1.9.15              99089cedcc48        48 minutes ago      8.071 MB</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/lib/docker/graph</span><br><span class="line"><span class="built_in">cd</span> 99089cedcc48*</span><br><span class="line">vim json</span><br></pre></td></tr></table></figure><p>这时就打开了这个镜像的配置文件 Cmd字段就是默认命令 还可以顺便改下comment信息</p><pre><code>&quot;comment&quot;:&quot;nginx 1.9.15&quot;,       # comment字段改为你想表达的信息&quot;Cmd&quot;:[&quot;yunfwe&quot;],               # Cmd字段有两个 第一个是作者信息&quot;Cmd&quot;:[&quot;nginx&quot;],                # 第二个才是启动命令如果运行命令有其他参数的话 用逗号隔开 例如 &quot;Cmd&quot;:[&quot;nginx&quot;,&quot;-s&quot;,&quot;reload&quot;],这样就相当于 nginx -s reload 了</code></pre><p>接下来使用docker history nginx:1.9.11 查看信息</p><pre><code>可以看到 CREATED BY 还有 COMMENT 是自己写的信息了root@ubuntu:~# docker history 99089cedcc48IMAGE               CREATED             CREATED BY          SIZE                COMMENT99089cedcc48        58 minutes ago      yunfwe              8.071 MB           nginx 1.9.15顺便可以看到运行命令也已经是nginx了root@ubuntu:~# docker inspect --format {{.Config.Cmd}} nginx:1.9.15{[nginx]}</code></pre><p>这两种修改默认启动命令方法的一个重要区别是 第二种在原本的镜像上修改 是不会产生新的层的 而用Dockerfile修改 相当于新建了一个层 这个层提供了默认启动命令 不信可以使用docker history验证一下</p><h4 id="保存为文件"><a href="#保存为文件" class="headerlink" title="保存为文件"></a><font color="#DDA0DD">保存为文件</font></h4><blockquote><p>默认docker导出的是个tar归档 这里直接将归档压缩为gz包 文件命名规则是<br>REPOSITORY_TAG-Type.tar.gz<br>其中的Type是标识这个文件是由镜像保存的还是已经生成的容器导出的</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save nginx:1.9.15 |gzip &gt; nginx_1.9.15-image.tar.gz</span><br></pre></td></tr></table></figure><p>要恢复的话也很简单 docker支持直接从gz压缩包中恢复<br>导入新的镜像 这个镜像的标签可能会丢失 但是id号还在 给这个id好重新打个标签</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker load &lt; nginx_1.9.15-image.tar.gz</span><br><span class="line">docker tag 99089cedcc48 nginx:1.9.15</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;用docker容器进行打包服务非常方便 不需要考虑依赖的问题 只要把容器复制到其他有docker daemon的服务器就可以直接启动 并能很方便的利用Cgroup, Namespace技术实现资源控制和资源隔离&lt;br&gt;这篇文档以Nginx为例 其他的像redis mysql php等服务也是可以使用这个方法进行打包为最精简的 只包含必须依赖的服务容器&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="http://www.yunfwe.cn/categories/Docker/"/>
    
    
      <category term="nginx" scheme="http://www.yunfwe.cn/tags/nginx/"/>
    
      <category term="busybox" scheme="http://www.yunfwe.cn/tags/busybox/"/>
    
      <category term="docker" scheme="http://www.yunfwe.cn/tags/docker/"/>
    
      <category term="overlay" scheme="http://www.yunfwe.cn/tags/overlay/"/>
    
  </entry>
  
  <entry>
    <title>Busybox构建最小容器</title>
    <link href="http://www.yunfwe.cn/2016/04/21/2016/Busybox%E6%9E%84%E5%BB%BA%E6%9C%80%E5%B0%8F%E5%AE%B9%E5%99%A8/"/>
    <id>http://www.yunfwe.cn/2016/04/21/2016/Busybox%E6%9E%84%E5%BB%BA%E6%9C%80%E5%B0%8F%E5%AE%B9%E5%99%A8/</id>
    <published>2016-04-21T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>BusyBox 是一个集成了一百多个最常用linux命令和工具的软件。BusyBox 包含了一些简单的工具，例如ls、cat和echo等等，还包含了一些更大、更复杂的工具，例grep、find、mount以及telnet。有些人将 BusyBox 称为 Linux 工具里的瑞士军刀。简单的说BusyBox就好像是个大工具箱，它集成压缩了 Linux 的许多工具和命令，也包含了 Linux 系统的自带的shell。<br><a href="http://baike.baidu.com/link?url=ItVb8LgSfWAdUsJW8rZ-5Zvvkw2nfdZUNAkJ6I9AMzLSy7p2VCtUY2j9_jiAcCUXaJ13OkVk7Rvy3Dp2KIbVfq" target="_blank" rel="noopener"><font color="#AAAAAA">百度百科</font></a><br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>busybox编译安装方式和编译内核的方式一样 所以需要安装make, ncurses, gcc支持</p><ul><li>ubuntu: apt-get install make gcc libncurses5-dev</li><li>centos: yum install make gcc ncurses-devel</li></ul></blockquote><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>Busybox</td><td style="text-align:center">1.24.2</td><td style="text-align:right"><a href="https://busybox.net/downloads/busybox-1.24.2.tar.bz2" target="_blank" rel="noopener"><font color="#AAAAAA">下载地址</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="配置Busybox编译选项"><a href="#配置Busybox编译选项" class="headerlink" title="配置Busybox编译选项"></a><font color="#CDAA7D">配置Busybox编译选项</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tar xf busybox-1.24.2.tar.bz2</span><br><span class="line"><span class="built_in">cd</span> busybox-1.24.2</span><br><span class="line">make menuconfig</span><br></pre></td></tr></table></figure><p>这时 将打开busybox编译的配置页面 为了方便起见 打算静态编译Busybox</p><pre><code>    Busybox Settings  ---&gt;          # 这里是对busybox的设置--- Applets                         # 以下的都是对小程序的配置    Archival Utilities  ---&gt;    Coreutils  ---&gt;    Console Utilities  ---&gt;    Debian Utilities  ---&gt;    Editors  ---&gt;    Finding Utilities  ---&gt;     Init Utilities  ---&gt;    Login/Password Management Utilities  ---&gt;</code></pre><p>静态编译Busybox属于Busybox的设定 上下键将光标选定Busybox Settings 回车进入</p><pre><code>General Configuration  ---&gt;             # 这里是通用配置Build Options  ---&gt;                     # 这里是编译选项Debugging Options  ---&gt; Installation Options (&quot;make install&quot; behavior)  ---&gt;    Busybox Library Tuning  ---&gt;</code></pre><p>选择Build Options 回车进入</p><pre><code>[*] Build BusyBox as a static binary (no shared libs)       # 在这里[ ] Force NOMMU build (NEW)[*] Build with Large File Support (for accessing files &gt; 2 GB) (NEW)()  Cross Compiler prefix (NEW)()  Path to sysroot (NEW)()  Additional CFLAGS (NEW)()  Additional LDFLAGS (NEW)()  Additional LDLIBS (NEW)</code></pre><p>光标处在Build BusyBox as a static binary处 空格键选择 [ ]变成了[*]<br>然后左右键切换光标到exit 回车回到上一个页面 选择 General Configuration 回车进入</p><pre><code>[*] Show applet usage messages (NEW)[*]   Show verbose applet usage messages (NEW)[*]   Store applet usage messages in compressed form (NEW)[*] Support --install [-s] to install applet links at runtime (NEW)[ ] Don&apos;t use /usr (NEW)[*] Enable locale support (system needs locale for this to work)    # 在这里[*] Support Unicode (NEW)[ ]   Use libc routines for Unicode (else uses internal ones) (NEW)[ ]   Check $LC_ALL, $LC_CTYPE and $LANG environment variables (NEW)(63)  Character code to substitute unprintable characters with (NEW)</code></pre><p>在 Enable locale support  处摁空格进行勾选 启动locale支持 然后一路的exit 直到以下界面</p><pre><code>Do you wish to save your new configuration?         &lt; Yes &gt;      &lt;  No  &gt;   </code></pre><p>选择 &lt; Yes &gt; 后页面将会退出 配置也就完成了 </p><h3 id="修改源代码-提供中文显示支持"><a href="#修改源代码-提供中文显示支持" class="headerlink" title="修改源代码 提供中文显示支持"></a><font color="#CDAA7D">修改源代码 提供中文显示支持</font></h3><blockquote><p>默认busybox不支持中文字符显示 接下来修改源代码 提供中文显示支持</p></blockquote><pre><code>vim ./libbb/printable_string.c</code></pre><p>找到31,32行 删除或注释这两行<br>找到45行 将”if (c &lt; ‘ ‘ || c &gt;= 0x7f)”注释”|| c &gt;= 0x7f”</p><pre><code>29                 if (c &lt; &apos; &apos;)30                         break;31         //      if (c &gt;= 0x7f)32         //              break;45          if (c &lt; &apos; &apos;/* || c &gt;= 0x7f*/)46                  *d = &apos;?&apos;;</code></pre><h3 id="开始编译安装"><a href="#开始编译安装" class="headerlink" title="开始编译安装"></a><font color="#CDAA7D">开始编译安装</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>这时 busybox已经编译好了 就是当前目录下的busybox文件 检测一下busybox是否可以显示中文</p><pre><code>root@ubuntu:~/busybox-1.24.2# touch 中文测试root@ubuntu:~/busybox-1.24.2# ./busybox ls 中文测试中文测试root@ubuntu:~/busybox-1.24.2# ldd ./busybox    not a dynamic executable可以看到 中文名称的文件被正常显示 同时这个程序是个没有依赖的二进制文件</code></pre><p>执行make install后 会将busybox和小程序的软链接都安装到当前目录中的_install/目录中 接下来就是打包为一个能正常启动docker容器</p><h3 id="打包为docker镜像"><a href="#打包为docker镜像" class="headerlink" title="打包为docker镜像"></a><font color="#CDAA7D">打包为docker镜像</font></h3><blockquote><p>如果只是编译安装Busybox的话 到这里就完了 下面是如何将Busybox制作为rootfs</p></blockquote><pre><code>root@ubuntu:~/busybox-1.24.2# cd _install/root@ubuntu:~/busybox-1.24.2/_install# lsbin  linuxrc  sbin  usr</code></pre><p>进入_install目录 可以看到已经存在几个busybox安装 小程序链接所存在的必须目录</p><pre><code>root@ubuntu2:~/busybox-1.24.2/_install# ls -lh bin |head total 2.6Mlrwxrwxrwx 1 root root    7 Apr 20 22:24 ash -&gt; busyboxlrwxrwxrwx 1 root root    7 Apr 20 22:24 base64 -&gt; busybox-rwxr-xr-x 1 root root 2.6M Apr 20 22:24 busyboxlrwxrwxrwx 1 root root    7 Apr 20 22:24 cat -&gt; busyboxlrwxrwxrwx 1 root root    7 Apr 20 22:24 catv -&gt; busyboxlrwxrwxrwx 1 root root    7 Apr 20 22:24 chattr -&gt; busyboxlrwxrwxrwx 1 root root    7 Apr 20 22:24 chgrp -&gt; busyboxlrwxrwxrwx 1 root root    7 Apr 20 22:24 chmod -&gt; busyboxlrwxrwxrwx 1 root root    7 Apr 20 22:24 chown -&gt; busybox</code></pre><p>可以看到 其实所有的命令都是软链接到busybox程序的 执行不同的命令 就有不同的效果</p><pre><code>root@ubuntu:~/busybox-1.24.2/_install# bin/dateWed Apr 20 23:07:48 EDT 2016root@ubuntu:~/busybox-1.24.2/_install# bin/uname -aLinux ubuntu 4.2.0-16-generic #19-Ubuntu SMP Thu Oct 8 15:35:06 UTC 2015 x86_64 GNU/Linux</code></pre><p>原理非常简单 busybox程序通过判断 $0 也就是自身的名字是什么 来执行相应的功能 默认也可以通过将命令作为 $1 传入busybox</p><pre><code>root@ubuntu:~/busybox-1.24.2/_install# bin/busybox dateWed Apr 20 23:11:01 EDT 2016root@ubuntu:~/busybox-1.24.2/_install# bin/busybox uname -aLinux ubuntu 4.2.0-16-generic #19-Ubuntu SMP Thu Oct 8 15:35:06 UTC 2015 x86_64 GNU/Linux</code></pre><p>当前目录下的文件夹还缺少了很多Linux根文件系统存在的文件夹 现在创建这些文件夹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir etc lib64 mnt proc run tmp var dev home lib media opt root sys</span><br><span class="line">mkdir var/&#123;<span class="built_in">log</span>,opt,spool,run&#125;</span><br><span class="line">mkdir usr/&#123;include,lib,share,src,<span class="built_in">local</span>&#125;</span><br><span class="line">mkdir usr/<span class="built_in">local</span>/&#123;bin,sbin,include,lib,share,src&#125;</span><br><span class="line">cp /etc/&#123;passwd,shadow,gshadow,group&#125; etc/</span><br><span class="line">chmod a+wrxt tmp/</span><br></pre></td></tr></table></figure><pre><code>root@ubuntu:~/busybox-1.24.2/_install# lsbin  etc   lib    linuxrc  mnt  proc  run   sys  usrdev  home  lib64  media    opt  root  sbin  tmp  var</code></pre><p>现在再看 好像已经像那么回事了 接下来就是将这个rootfs打包为docker镜像</p><pre><code>root@ubuntu:~/busybox-1.24.2/_install# tar -cf /dev/stdout *|docker import - busybox:1.24.2sha256:5b5e476a877a87b5c4c976a2a6db1782c2d89e8177e6f4d9658127320d27c1cbroot@ubuntu:~/busybox-1.24.2/_install# docker imagesREPOSITORY          TAG                 IMAGE ID            CREATED             SIZEbusybox             1.24.2              5b5e476a877a        10 seconds ago      2.635 MB</code></pre><p>通过tar命令 将归档数据传入标准输出 通过管道符提交给docker去导入 然后命名新镜像为busybox:1.24.2 可以看到已经导入成功了 大小仅仅2.635 MB</p><h3 id="测试Busybox运行效果"><a href="#测试Busybox运行效果" class="headerlink" title="测试Busybox运行效果"></a><font color="#CDAA7D">测试Busybox运行效果</font></h3><blockquote><p>从busybox镜像启动一个新的容器 进行简单的命令测试 以后打包服务为docker镜像时就可以使用这个镜像为基础了</p></blockquote><pre><code>root@ubuntu:~/busybox-1.24.2/_install# docker run -ti --rm busybox:1.24.2 sh/ # ifconfig eth0eth0      Link encap:Ethernet  HWaddr 02:42:AC:12:00:07            inet addr:172.18.0.7  Bcast:0.0.0.0  Mask:255.255.0.0          inet6 addr: fe80::42:acff:fe12:7/64 Scope:Link          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1          RX packets:6 errors:0 dropped:0 overruns:0 frame:0          TX packets:6 errors:0 dropped:0 overruns:0 carrier:0          collisions:0 txqueuelen:0           RX bytes:508 (508.0 B)  TX bytes:508 (508.0 B)/ # ls /bin      etc      lib      linuxrc  mnt      proc     run      sys      usrdev      home     lib64    media    opt      root     sbin     tmp      var</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="Busybox容器通过远程连接访问"><a href="#Busybox容器通过远程连接访问" class="headerlink" title="Busybox容器通过远程连接访问"></a><font color="#CDAA7D">Busybox容器通过远程连接访问</font></h3><blockquote><p>buxybox自带了telnetd小程序 这样就可以通过telnet工具远程登录这个容器了</p></blockquote><pre><code>/ # telnetd             # 启telnetd程序 可以看到已经正常监听23端口/ # netstat -anptActive Internet connections (servers and established)Proto Recv-Q Send-Q Local Address       Foreign Address      State      PID/Program name    tcp        0      0 :::23               :::*                 LISTEN     8/busybox/ # adduser busybox     # 然后添加一个远程登录的用户名 默认是禁止root登录Changing password for busyboxNew password: Bad password: too weakRetype password: Password for busybox changed by root</code></pre><p>添加用户的同时会让你更改用户密码 接下来就可以试试用telnet工具远程登录到这个容器了</p><pre><code>root@ubuntu:~# telnet 172.18.0.7Trying 172.18.0.7...Connected to 172.18.0.7.Escape character is &apos;^]&apos;.ea68afe67966 login: busyboxPassword: ~ $ dateThu Apr 21 03:50:10 UTC 2016~ $</code></pre><p>如果想切换到root用户 需要给busybox添加suid权限 在上一个本地会话中完成添加 </p><pre><code>/ # chmod +s /bin/busybox/ # vi /etc/passwd              # 由于不存在bash 切换root时会出错 所以需要更改root的默认shell    root:x:0:0:root:/root:/bin/sh/ # passwd root                 # 给root配置一个复杂些的密码Changing password for rootNew password: Retype password: Password for root changed by root/ # </code></pre><p>然后回到telnet登录的会话中 用 su 命令切换到root用户 切换成功</p><pre><code>~ $ suPassword: /home/busybox #</code></pre><p>不仅telnetd服务 busybox还提供了httpd, udhcpd, tftpd, ntpd, dnsd等服务 还包括了linux常用的三四百条命令 真的是麻雀虽小五脏俱全  这样 一个功能强大 大小仅2.6MB的docker镜像就制作完成了</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;BusyBox 是一个集成了一百多个最常用linux命令和工具的软件。BusyBox 包含了一些简单的工具，例如ls、cat和echo等等，还包含了一些更大、更复杂的工具，例grep、find、mount以及telnet。有些人将 BusyBox 称为 Linux 工具里的瑞士军刀。简单的说BusyBox就好像是个大工具箱，它集成压缩了 Linux 的许多工具和命令，也包含了 Linux 系统的自带的shell。&lt;br&gt;&lt;a href=&quot;http://baike.baidu.com/link?url=ItVb8LgSfWAdUsJW8rZ-5Zvvkw2nfdZUNAkJ6I9AMzLSy7p2VCtUY2j9_jiAcCUXaJ13OkVk7Rvy3Dp2KIbVfq&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;font color=&quot;#AAAAAA&quot;&gt;百度百科&lt;/font&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="Docker" scheme="http://www.yunfwe.cn/categories/Docker/"/>
    
    
      <category term="busybox" scheme="http://www.yunfwe.cn/tags/busybox/"/>
    
      <category term="docker" scheme="http://www.yunfwe.cn/tags/docker/"/>
    
  </entry>
  
  <entry>
    <title>MySQL数据误删恢复记录</title>
    <link href="http://www.yunfwe.cn/2016/04/19/2016/MySQL%E6%95%B0%E6%8D%AE%E8%AF%AF%E5%88%A0%E6%81%A2%E5%A4%8D%E8%AE%B0%E5%BD%95/"/>
    <id>http://www.yunfwe.cn/2016/04/19/2016/MySQL%E6%95%B0%E6%8D%AE%E8%AF%AF%E5%88%A0%E6%81%A2%E5%A4%8D%E8%AE%B0%E5%BD%95/</id>
    <published>2016-04-19T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>由于程序出错 导致MySQL数据库三天内的数据混乱 现在需要删除三天内错误的数据 因为大意 where语句条件忘记添加引号 导致条件不生效 删除了表中所有的数据 现在需要通过binlog日志将此表的数据恢复<br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>生产环境 MySQL-5.5.15 已经开启二进制日志</p></blockquote><pre><code>mysql&gt; show variables like &apos;log_bin&apos;;+---------------+-------+| Variable_name | Value |+---------------+-------+| log_bin       | ON    |+---------------+-------+1 row in set (0.01 sec)</code></pre><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><blockquote><p>大体的数据恢复思路是：</p><ul><li>先查询MySQL已经读写到的二进制日志 然后刷新二进制到新的日志文件 </li><li>读取二进制日志 过滤出关于要恢复表的信息 </li><li>将所有对要恢复表的操作信息保存为sql文件 </li><li>然后将sql文件导入MySQL 完成数据恢复</li></ul></blockquote><h3 id="查询已经写到的二进制位置"><a href="#查询已经写到的二进制位置" class="headerlink" title="查询已经写到的二进制位置"></a><font color="#CDAA7D">查询已经写到的二进制位置</font></h3><p>通过 show master status; 查看当前写入到的二进制日志文件</p><pre><code>[root@localhost /]# mysql -uroot -pEnter password: Welcome to the MySQL monitor.  Commands end with ; or \g.Your MySQL connection id is 236859Server version: 5.5.14-log MySQL Community Server (GPL)Copyright (c) 2000, 2012, Oracle and/or its affiliates. All rights reserved.Oracle is a registered trademark of Oracle Corporation and/or itsaffiliates. Other names may be trademarks of their respectiveowners.Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.mysql&gt; show master status;+------------------+----------+--------------+------------------+| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |+------------------+----------+--------------+------------------+| mysql-bin.000037 | 40435151 |              |                  |+------------------+----------+--------------+------------------+1 row in set (0.00 sec)</code></pre><h3 id="刷新二进制日志文件"><a href="#刷新二进制日志文件" class="headerlink" title="刷新二进制日志文件"></a><font color="#CDAA7D">刷新二进制日志文件</font></h3><p>执行 flush logs; 刷新二进制日志 可以看到 已经打来了一个新的文件开始写入了<br>二进制日志文件的路径一般在数据库目录下</p><pre><code>mysql&gt; flush logs;Query OK, 0 rows affected (0.02 sec)mysql&gt; show master status;+------------------+----------+--------------+------------------+| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB |+------------------+----------+--------------+------------------+| mysql-bin.000038 |      107 |              |                  |+------------------+----------+--------------+------------------+1 row in set (0.00 sec)</code></pre><h3 id="使用mysqlbinlog工具查看二进制日志"><a href="#使用mysqlbinlog工具查看二进制日志" class="headerlink" title="使用mysqlbinlog工具查看二进制日志"></a><font color="#CDAA7D">使用mysqlbinlog工具查看二进制日志</font></h3><blockquote><p>mysqlbinlog程序就是MySQL 二进制日志文件的查看工具了 先从从二进制中找到最后执行删除指令的语句</p></blockquote><p>最后记录删除操作的二进制日志文件为mysql-bin.000037 要恢复的表存在与dbinfo库中</p><pre><code>[root@localhost data]# mysqlbinlog -d dbinfo mysql-bin.000037 | \grep &apos;delete&apos; -B1 |grep zf_total_increment -B1 SET TIMESTAMP=1460950871/*!*/;delete  from zf_total_increment where insert_time &gt; 2016-04-16</code></pre><p>这里看到了执行删除语句的时间戳是 1460950871 现在需要将它转换为日期时间</p><pre><code>mysql&gt; select FROM_UNIXTIME(1460950871);+---------------------------+| FROM_UNIXTIME(1460950871) |+---------------------------+| 2016-04-18 11:41:11       |+---------------------------+1 row in set (0.00 sec)</code></pre><p>恢复的时候当然不能把这一句也恢复了 否则刚恢复完毕又被删除了<br>继续找到建表的日期 因为表并没有被删除 根据情况 可以先truncate下表 这样就不用重新创建了</p><pre><code>[root@localhost data]# mysqlbinlog -d dbinfo mysql-bin.000009|grep zf_total_increment -B1|head SET TIMESTAMP=1389259355/*!*/;DROP TABLE IF EXISTS `zf_total_increment` /* generated by server */--SET TIMESTAMP=1389259355/*!*/;CREATE TABLE `zf_total_increment` (---- ------------------------------ Records of zf_total_increment-- ----------------------------INSERT INTO `zf_total_increment` VALUES (......)mysql&gt; select FROM_UNIXTIME(1389259355);+---------------------------+| FROM_UNIXTIME(1389259355) |+---------------------------+| 2014-01-09 17:22:35       |+---------------------------+1 row in set (0.00 sec)</code></pre><p>可以看到 在同一时刻进行了删除已存在的表 创建表 插入第一条语句 那么就从这里开始恢复<br>zf_total_increment这个表的数据存在与mysql-bin.000009到mysql-bin.000037中 需要挨个恢复</p><p>由于我并非要恢复所有的数据 原本就是要删除这几天的数据 所以只将数据恢复到2016-04-16之前<br>如果是完全恢复的话 千万不要将delete语句的时间也恢复了 可以恢复到这个时间前一秒钟都行<br>最好可以恢复到这条语句的前一个位置 </p><pre><code>[root@localhost data]# mkdir recovery[root@localhost data]# mysqlbinlog -d dbinfo \--start-datetime=&apos;2014-01-09 17:22:35&apos; \--stop-datetime=&apos;2016-04-16 00:00:00&apos; mysql-bin.000009 | \grep zf_total_increment &gt;&gt; recovery/zf_total_increment.sql</code></pre><p>这样 mysql-bin.000009中所有关于zf_total_increment的语句都被追加到zf_total_increment.sql中了<br>接下来继续将mysql-bin.000010 到 mysql-bin.0000037中的也继续恢复</p><p>如果恢复的文件太多 可以使用脚本 等所有的日志都跑完了 最终的目标表的数据就都被保存为sql文件</p><pre><code>[root@localhost recovery]# head zf_total_increment.sql DROP TABLE IF EXISTS `zf_total_increment` /* generated by server */CREATE TABLE `zf_total_increment` (-- Records of zf_total_incrementINSERT INTO `zf_total_increment` VALUES (......)</code></pre><p>查看这个文件 发现删除和创建语句也在其中 由于创建语句并没有写在一行 所以并不完整<br>由于过滤的时候只过滤一行 导致写在下一行的 /*!*/; 丢失 下面用sed工具修正</p><pre><code>[root@localhost recovery]# sed -i &apos;1,3d&apos; zf_total_increment.sql [root@localhost recovery]# sed -i &apos;s/$/;/g&apos; zf_total_increment.sql </code></pre><p>最后就可以将这个sql文件导入MySQL执行了</p><pre><code>[root@localhost recovery]# mysql -uroot -p123456 dbinfo &lt; zf_total_increment.sql</code></pre><p>最后查看数据库 这个表的数据是否已经完全恢复了呢 这个sql文件也可以作为备份 供以后使用</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><blockquote><p>以下是mysqlbinlog支持的常用选项</p></blockquote><pre><code>--database=db_name, -d db_name      只列出该数据库的条目 只用本地日志–-host=host_name, -h host_name      获取指定主机上的MySQL服务器的二进制日志–-user=user_name, -u user_name      远程主机需要用于连接的用户名–-password[=password], -p[password] 远程主机需要输入密码 注意-p和密码间不能有空格–-port=port_num, -P port_num        连接远程主机使用的端口号–-read-from-remote-server, -R       如果未给出该选项 任何远程连接的选项都被忽略--result-file=name, -r name         输出到给定的文件--start-datetime=datetime           从二进制中的日志某个日期开始读取往后的日志--stop-datetime=datetime            读取二进制中的日志某个日期为止--start-postition=N                 从二进制中的某个位置开始读取 (# at 1 中的1就是N)--stop-postition=N                  读取到二进制中的某个位置为止–-disable-logs-bin,-D               如果直接将日志传给MySQL执行 此选项禁用二进制日志</code></pre><p>如果数据库配置的有主从同步的话 不可以禁用二进制日志方式恢复<br>否则可能因为没有二进制日志的产生 slave库并没有恢复数据</p><p>mysqlbinlog打印出来的数据是可以直接导入mysql的<br>如果想把当时INSERT语句的执行日期也记录 就需要把SET TIMESTAMP也保留下</p><p>也可以通过以下方式直接将数据恢复到MySQL</p><pre><code>mysqlbinlog mysql-bin.000009 \ --start-position=7492 --stop-position=647724 \|grep zf_total_increment -B1 -A1 |mysql -uroot -p123456 dbinfo</code></pre><p>这个例子通过事务在日志中的位置来恢复的 grep的 -B1 参数同时保留了SET TIMESTAMP语句<br>然后直接通过管道符提交给MySQL MySQL选择要恢复到的库</p><p>每一个二进制日志文件的position都是从新开始 如果在多个文件内恢复 可能就不如datetime方便了<br>但是可以精确到每一条语句上 datetime的话 可能1秒内就有好多条语句</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;由于程序出错 导致MySQL数据库三天内的数据混乱 现在需要删除三天内错误的数据 因为大意 where语句条件忘记添加引号 导致条件不生效 删除了表中所有的数据 现在需要通过binlog日志将此表的数据恢复&lt;br&gt;
    
    </summary>
    
    
      <category term="MySQL" scheme="http://www.yunfwe.cn/categories/MySQL/"/>
    
    
      <category term="数据恢复" scheme="http://www.yunfwe.cn/tags/%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D/"/>
    
      <category term="mysqlbinlog" scheme="http://www.yunfwe.cn/tags/mysqlbinlog/"/>
    
  </entry>
  
  <entry>
    <title>Dnsmasq安装配置</title>
    <link href="http://www.yunfwe.cn/2016/04/06/2016/dnsmasq%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/"/>
    <id>http://www.yunfwe.cn/2016/04/06/2016/dnsmasq%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/</id>
    <published>2016-04-06T01:03:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>DNSmasq是一个小巧且方便地用于配置DNS和DHCP的工具，适用于小型网络，它提供了DNS功能和可选择的DHCP功能。<br>它服务那些只在本地适用的域名，这些域名是不会在全球的DNS服务器中出现的。<br>DHCP服务器和DNS服务器结合，并且允许DHCP分配的地址能在DNS中正常解析，<br>而这些DHCP分配的地址和相关命令可以配置到每台主机中，也可以配置到一台核心设备中（比如路由器），DNSmasq支持静态和动态两种DHCP配置方式。<br><a href="http://baike.baidu.com/link?url=YR5BrsDncVQl0sly_MwHJSy4cXoid99NBAj_yluOPIgOttaDl_XZRubXZIyFT4vMWrmt81ak3SWE5F6ijyAocq" target="_blank" rel="noopener"><font color="#AAAAAA">百度百科</font></a><br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>dnsmasq几乎没有额外的依赖 只需要系统安装好编译环境即可</p></blockquote><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>dnsmasq</td><td style="text-align:center">2.75</td><td style="text-align:right"><a href="http://www.thekelleys.org.uk/dnsmasq/dnsmasq-2.75.tar.xz" target="_blank" rel="noopener"><font color="#AAAAAA">下载地址</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a><font color="#CDAA7D">编译安装</font></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar xf dnsmasq-2.75.tar.xz</span><br><span class="line"><span class="built_in">cd</span> dnsmasq-2.75</span><br><span class="line">make &amp;&amp; make install                            <span class="comment"># dnsmasq主程序在/usr/local/dnsmasq</span></span><br><span class="line">cp dnsmasq.conf.example /etc/dnsmasq.conf       <span class="comment"># 配置文件</span></span><br></pre></td></tr></table></figure><pre><code>一般到这就编译完成了 如果有特殊需求 可以通过修改Makefile文件实现vim Makefile    PREFIX        = /usr/local/dnsmasq      # 安装的位置    BINDIR        = $(PREFIX)/sbin    MANDIR        = $(PREFIX)/share/man    LOCALEDIR     = $(PREFIX)/share/locale    BUILDDIR      = $(SRC)    DESTDIR       =    CFLAGS        = -Wall -W -O2    LDFLAGS       = -s -static              # 去掉编译debug信息 采用静态编译     注意 并不是所有平台修改过Makefile后都可以正常编译</code></pre><h3 id="用法详解"><a href="#用法详解" class="headerlink" title="用法详解"></a><font color="#CDAA7D">用法详解</font></h3><blockquote><p>dnsmasq程序虽小 可五脏俱全 可以用来做DNS DHCP TFTP服务器 甚至可以用作PXE装机用<br>打开/etc/dnsmasq.conf配置文件 可以看到所有的选项和说明 通过man 8 dnsmasq 可以看到更详细的内容<br>为了方便配置不同的服务 将不同服务的配置文件分开 开启conf-dir=/etc/dnsmasq.d/,*.conf配置项<br>这样 dnsmasq就会在启动的时候加载/etc/dnsmasq.d/内的*.conf文件了</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dnsmasq.conf</span><br></pre></td></tr></table></figure><p><strong>修改如下内容</strong></p><pre><code>conf-dir=/etc/dnsmasq.d/,\*.conf</code></pre><h4 id="DNS服务"><a href="#DNS服务" class="headerlink" title="DNS服务"></a><font color="#DDA0DD">DNS服务</font></h4><blockquote><p>dnsmasq默认会启动dns服务 并读取系统的/etc/resolv.conf和/etc/hosts<br>/etc/resolv.conf中的nameserver会被dnsmasq作为上行DNS server<br>在遇到dnsmasq找不到的记录就像上行服务器发出请求 然后将结果返回客户机<br>下面是dnsmasq中DNS功能一些常用的配置项</p></blockquote><pre><code>port=53                                # port设置为0 会关闭dns功能resolv-file=/etc/dnsmasq.resolv.conf   # 从另一个文件获取上行DNS服务器地址addn-hosts=/etc/dnsmasq.hosts.conf     # 从另一个文件获取主机名IP地址映射no-resolv                              # 禁用resolv 不获取上行DNS服务器 同时resolv-file失效no-hosts                               # 不使用系统的hosts文件 仅使用addn-hosts配置的listen-address=127.0.0.1               # 配置监听地址interface=lo                           # 配置监听网卡接口except-interface=eth0                  # 配置不监听的网卡接口如果配置了resolv-file dnsmasq就不会去读取系统的/etc/resolv.conf而配置了addn-hosts dnsmasq会同时读取系统的/etc/hosts和配置指定的文件</code></pre><blockquote><p>为了能让系统能使用自己启动的DNS服务 并且不影响访问外网等操作 可以将系统的resolv.conf的nameserver改为127.0.0.1 然后在resolv-file指定的文件写入上行DNS服务器</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dnsmasq.d/dns.conf</span><br></pre></td></tr></table></figure><p><strong>写入如下内容</strong></p><pre><code>resolv-file=/etc/dnsmasq.resolv.confaddn-hosts=/etc/dnsmasq.hosts.conf</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'nameserver 127.0.0.1'</span> &gt; /etc/resolv.conf              <span class="comment"># 系统使用本地的DNS服务器</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'nameserver 180.76.76.76'</span> &gt; /etc/dnsmasq.resolv.conf   <span class="comment"># dnsmasq去查询的DNS服务器</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'127.0.0.1 test'</span> &gt; /etc/dnsmasq.hosts.conf             <span class="comment"># 测试dns解析效果</span></span><br><span class="line">/usr/<span class="built_in">local</span>/dnsmasq/sbin/dnsmasq -d                          <span class="comment"># 默认后台运行 -d 可以阻止</span></span><br></pre></td></tr></table></figure><p>接下来用ping命令检查域名解析服务是否正常了</p><pre><code>root@ubuntu:/etc/dnsmasq.d# ping -c4 test PING test (127.0.0.1) 56(84) bytes of data.64 bytes from localhost (127.0.0.1): icmp_seq=1 ttl=64 time=0.050 ms64 bytes from localhost (127.0.0.1): icmp_seq=2 ttl=64 time=0.037 ms64 bytes from localhost (127.0.0.1): icmp_seq=3 ttl=64 time=0.034 ms64 bytes from localhost (127.0.0.1): icmp_seq=4 ttl=64 time=0.033 ms--- test ping statistics ---4 packets transmitted, 4 received, 0% packet loss, time 3996msrtt min/avg/max/mdev = 0.033/0.037/0.050/0.009 ms</code></pre><p>用dig命令检查 可以清楚的看到解析的A记录</p><pre><code>root@ubuntu:/etc/dnsmasq.d# dig @127.0.0.1 testtest.            0    IN    A    127.0.0.1</code></pre><p>也可以用nslookup命令检查 Windows平台的话 需要将127.0.0.1改为dnsmasq所在服务器的IP</p><pre><code>root@ubuntu:/etc/dnsmasq.d# nslookup test 127.0.0.1Server:        127.0.0.1Address:    127.0.0.1#53Name:    testAddress: 127.0.0.1</code></pre><p>以后只需要将需要解析的IP和名称写入/etc/dnsmasq.resolv.conf文件就可以了，不过美中不足的一点就是 每次修改了配置文件 都需要重新启动dnsmasq服务。</p><h4 id="DHCP服务"><a href="#DHCP服务" class="headerlink" title="DHCP服务"></a><font color="#DDA0DD">DHCP服务</font></h4><blockquote><p>DHCP服务在dnsmasq中的配置非常简单 甚至只用一行配置就可以启动一个正常工作的DHCP服务器<br>一下是DHCP服务的常用配置项</p></blockquote><pre><code>dhcp-range=192.168.1.50,192.168.1.100,12h               # 起始 结束 还有租约时间dhcp-range=192.168.0.50,192.168.0.150,255.255.255.0,12h # 网段dhcp-host=aa:bb:cc:dd:ee:ff,192.168.1.50                # mac地址 IPdhcp-host=00:0e:7b:ca:1c:6e,daunbook,192.168.0.12       # mac地址 主机名 IPdhcp-option=3,192.168.0.1                               # 默认网关dhcp-option=option:router,1.2.3.4                       # 默认网关 和上面的一样dhcp-option=option:ntp-server,192.168.0.4,10.10.0.5     # ntp服务地址dhcp-option=option:dns-server,180.76.76.76              # dns服务器地址no-dhcp-interface=eth0                                  # 不提供dhcp的接口</code></pre><blockquote><p>其中只要有dhcp-range或者dhcp-host的配置 dhcp服务就会启动 接下来 添加dhcp的配置项 并检测dhcp服务是否正常分配IP</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 由于只能给同网段的主机分配IP 所以这里需要在网卡上绑定一个子接口</span></span><br><span class="line">ifconfig ens32:0 192.168.100.1/24            <span class="comment"># 网卡名称根据实际情况来定</span></span><br><span class="line">vim /etc/dnsmasq.d/dhcp.conf</span><br></pre></td></tr></table></figure><p><strong>写入如下内容</strong></p><pre><code>dhcp-range=192.168.100.10,192.168.100.20,12h  # 这里使用和当前局域网不同的网段dhcp-option=option:router,192.168.100.1  # 自己同时作为网关</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/<span class="built_in">local</span>/dnsmasq/sbin/dnsmasq -d</span><br></pre></td></tr></table></figure><p>可以清楚的看到dnsmasq的输出有DHCP的一些信息</p><pre><code>dnsmasq-dhcp: DHCP, IP range 192.168.100.10 -- 192.168.100.20, lease time 12h</code></pre><p>接下来检测DHCP服务是否能正常提供服务，在另外一台机器上 强行使用dhclient命令为网卡获取动态IP。</p><pre><code>[root@localhost ~]# dhclient -v ens32:0Internet Systems Consortium DHCP Client 4.2.5Copyright 2004-2013 Internet Systems Consortium.All rights reserved.For info, please visit https://www.isc.org/software/dhcp/Listening on LPF/ens32/00:0c:29:44:eb:ecSending on   LPF/ens32/00:0c:29:44:eb:ecSending on   Socket/fallbackDHCPREQUEST on ens32 to 255.255.255.255 port 67 (xid=0xba1741)DHCPACK from 192.168.100.1 (xid=0xba1741)bound to 192.168.100.19 -- renewal in 19449 seconds.</code></pre><p>可以看到从192.168.100.1获取了192.168.100.19这个IP 同时DHCP server端有这次请求信息。</p><pre><code>dnsmasq-dhcp: DHCPREQUEST(ens32) 192.168.100.19 00:0c:29:44:eb:ec dnsmasq-dhcp: DHCPACK(ens32) 192.168.100.19 00:0c:29:44:eb:ec</code></pre><p>也可以先将网卡配置为DHCP获取IP 然后重启 看看是否获取到了配置的IP段的IP 以及网关是否正确</p><h4 id="TFTP服务"><a href="#TFTP服务" class="headerlink" title="TFTP服务"></a><font color="#DDA0DD">TFTP服务</font></h4><blockquote><p>tftp是简单文件传输协议 有区别与一般的ftp服务 tftp使用UDP的69端口 一般用作小文件传输 下面就是如何用dnsmasq配置tftp服务</p></blockquote><pre><code>enable-tftp                     # 表示启动tftp服务tftp-root=/tftp                 # 配置tftp的文件根目录</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/dnsmasq.d/tftp.conf</span><br></pre></td></tr></table></figure><p><strong>写入如下内容</strong></p><pre><code>enable-tftptftp-root=/tftp</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir /tftp</span><br><span class="line">echo &apos;hello&apos; &gt; /tftp/test           # 添加测试文件</span><br><span class="line">/usr/local/dnsmasq/sbin/dnsmasq -d</span><br></pre></td></tr></table></figure><p>启动dnsmasq后 可以看到tftp服务也启动了</p><pre><code>dnsmasq-tftp: TFTP root is /tftp</code></pre><p>接下来验证tftp服务是否正常工作 通过tftp命令连接tftp服务 如果没有tftp命令 自行安装相应的包</p><pre><code>root@ubuntu:/tmp# tftp 127.0.0.1            # 连接本地的tftp服务tftp&gt; get test                              # 获取刚才写入的test文件Received 7 bytes in 0.0 secondstftp&gt; quit                                  # quit命令退出交互root@ubuntu:/tmp# cat test                  # 查看获取的文件hello                                       # 内容没有问题</code></pre><p>tftp是一个非常简单的文件传输协议 只有文件上传下载功能 列出目录之类的功能就不用想了，支持的命令也非常少 可以在ftfp的交互界面 通过输入?来查询支持的命令 或许有些命令 服务端也并不支持。</p><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="用dnsmasq部署pxe自动装机"><a href="#用dnsmasq部署pxe自动装机" class="headerlink" title="用dnsmasq部署pxe自动装机"></a><font color="#CDAA7D">用dnsmasq部署pxe自动装机</font></h3><blockquote><p>由于dnsmasq包含了DHCP和TFTP 所以用dnsmasq搭建pxe自动装机服务是完全可行的 而且只需要简简单单的几项配置就可以了</p></blockquote><pre><code>enable-tftptftp-root=/tftpdhcp-boot=pxelinux.0dhcp-range=192.168.100.10,192.168.100.20,12h</code></pre><p>记得要将pxe装机需要的pxelinux.0等文件放到tftp-root配置的目录下，还要注意给客户分配的网段要根据实际情况分配。</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;DNSmasq是一个小巧且方便地用于配置DNS和DHCP的工具，适用于小型网络，它提供了DNS功能和可选择的DHCP功能。&lt;br&gt;它服务那些只在本地适用的域名，这些域名是不会在全球的DNS服务器中出现的。&lt;br&gt;DHCP服务器和DNS服务器结合，并且允许DHCP分配的地址能在DNS中正常解析，&lt;br&gt;而这些DHCP分配的地址和相关命令可以配置到每台主机中，也可以配置到一台核心设备中（比如路由器），DNSmasq支持静态和动态两种DHCP配置方式。&lt;br&gt;&lt;a href=&quot;http://baike.baidu.com/link?url=YR5BrsDncVQl0sly_MwHJSy4cXoid99NBAj_yluOPIgOttaDl_XZRubXZIyFT4vMWrmt81ak3SWE5F6ijyAocq&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;font color=&quot;#AAAAAA&quot;&gt;百度百科&lt;/font&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="Dnsmasq" scheme="http://www.yunfwe.cn/categories/Dnsmasq/"/>
    
    
      <category term="dns" scheme="http://www.yunfwe.cn/tags/dns/"/>
    
      <category term="dhcp" scheme="http://www.yunfwe.cn/tags/dhcp/"/>
    
      <category term="tftp" scheme="http://www.yunfwe.cn/tags/tftp/"/>
    
      <category term="pxe" scheme="http://www.yunfwe.cn/tags/pxe/"/>
    
  </entry>
  
  <entry>
    <title>Zabbix3.0安装文档</title>
    <link href="http://www.yunfwe.cn/2016/04/02/2016/zabbix3.0%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/"/>
    <id>http://www.yunfwe.cn/2016/04/02/2016/zabbix3.0%E5%AE%89%E8%A3%85%E6%96%87%E6%A1%A3/</id>
    <published>2016-04-02T02:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。<br>zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。<br>zabbix由2部分构成，zabbix server与可选组件zabbix agent。<br>zabbix server可以通过SNMP，zabbix agent，ping，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux，Solaris，HP-UX，AIX，Free BSD，Open BSD，OS X等平台上<br><a href="http://baike.baidu.com/link?url=j3tIKvRZKMKpBkPLSXFs-lhgWSCI3Yh13Ohk7y2WOkzfLsRnZG3zZ3nHZKDKxNnl8EL6Jt37OkqEwH6DxRMfJq" target="_blank" rel="noopener"><font color="#AAAAAA">百度百科</font></a><br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>在Linux下编译安装 zabbix3.0版对PHP最低版本要求是5.4 其他软件包无要求 </p></blockquote><h3 id="主机环境"><a href="#主机环境" class="headerlink" title="主机环境"></a><font color="#CDAA7D">主机环境</font></h3><table><thead><tr><th>身份</th><th style="text-align:center">系统</th><th style="text-align:right">IP</th></tr></thead><tbody><tr><td>MySQL 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.2</td></tr><tr><td>PHP-fpm 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.3</td></tr><tr><td>Nginx 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.4</td></tr><tr><td>Zabbix Server</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.5</td></tr><tr><td>Zabbix Agent1</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.6</td></tr><tr><td>Zabbix Agent2</td><td style="text-align:center">Windows</td><td style="text-align:right">172.17.0.7</td></tr></tbody></table><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a><font color="#CDAA7D">软件环境</font></h3><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>php</td><td style="text-align:center">5.6.19</td><td style="text-align:right"><a href="http://cn2.php.net/distributions/php-5.6.19.tar.xz" target="_blank" rel="noopener"><font color="#AAAAAA">下载地址</font></a></td></tr><tr><td>nginx</td><td style="text-align:center">1.9.13</td><td style="text-align:right"><a href="http://nginx.org/download/nginx-1.9.13.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>mysql</td><td style="text-align:center">5.6.28</td><td style="text-align:right"><a href="http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.28.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>zabbix</td><td style="text-align:center">3.0.1</td><td style="text-align:right"><a href="http://ufpr.dl.sourceforge.net/project/zabbix/ZABBIX%20Latest%20Stable/3.0.1/zabbix-3.0.1.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>zabbix agent win版</td><td style="text-align:center">3.0.0</td><td style="text-align:right"><a href="http://www.zabbix.com/downloads/3.0.0/zabbix_agents_3.0.0.win.zip" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="搭建LNMP环境"><a href="#搭建LNMP环境" class="headerlink" title="搭建LNMP环境"></a><font color="#CDAA7D">搭建LNMP环境</font></h3><blockquote><p>由于zabbix自带的web管理界面需要PHP环境 所以只需要提供一个PHP版本不低于5.4的web环境即可<br>以下是在Linux上搭建LNMP环境</p></blockquote><table><thead><tr><th>服务器</th><th style="text-align:center">安装文档地址</th></tr></thead><tbody><tr><td>Nginx</td><td style="text-align:center"><a href="/2016/03/31/nginx/nginx编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr><tr><td>MySQL</td><td style="text-align:center"><a href="/2016/04/01/mysql/MySQL编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr><tr><td>PHP-fpm</td><td style="text-align:center"><a href="/2016/04/01/php/php-fpm编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr><tr><td>LNMP</td><td style="text-align:center"><a href="/2016/04/01/lnmp/LNMP环境部署"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr></tbody></table><h3 id="编译安装Zabbix"><a href="#编译安装Zabbix" class="headerlink" title="编译安装Zabbix"></a><font color="#CDAA7D">编译安装Zabbix</font></h3><blockquote><p>需要系统先初始化开发环境 以及安装需要的程序开发包</p></blockquote><pre><code>yum -y install gcc mysql-devel libxml2-devel net-snmp-devel libssh2-devel curl-devel</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tar xf zabbix-3.0.1.tar.gz</span><br><span class="line"><span class="built_in">cd</span> zabbix-3.0.1</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/zabbix \</span><br><span class="line">--<span class="built_in">enable</span>-server --<span class="built_in">enable</span>-agent \</span><br><span class="line">--with-mysql --with-net-snmp \</span><br><span class="line">--with-libcurl --with-libxml2 --with-ssh2</span><br><span class="line">make -j4 &amp;&amp; make install</span><br></pre></td></tr></table></figure><h3 id="配置zabbix-server"><a href="#配置zabbix-server" class="headerlink" title="配置zabbix server"></a><font color="#CDAA7D">配置zabbix server</font></h3><blockquote><p>还需要给zabbix server配置防火墙安全策略 数据库 web服务等</p></blockquote><h4 id="配置防火墙"><a href="#配置防火墙" class="headerlink" title="配置防火墙"></a><font color="#DDA0DD">配置防火墙</font></h4><pre><code>关闭或者配置服务器的iptables和SElinux策略service iptables stopsetenforce 0vim /etc/selinux/config    修改SELINUX=disabled</code></pre><h4 id="导入数据库"><a href="#导入数据库" class="headerlink" title="导入数据库"></a><font color="#DDA0DD">导入数据库</font></h4><pre><code>mysql授权zabbix用户以及创建zabbix库mysql -uroot -h172.17.0.2 -pmysql&gt; grant all privileges on zabbix.* to zabbix@&quot;%&quot; identified by &quot;123.com&quot;;mysql&gt; create database zabbix default charset utf8;</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql -uzabbix -h172.17.0.2 -p123.com zabbix &lt; schema.sql</span><br><span class="line">mysql -uzabbix -h172.17.0.2 -p123.com zabbix &lt; images.sql</span><br><span class="line">mysql -uzabbix -h172.17.0.2 -p123.com zabbix &lt; data.sql</span><br></pre></td></tr></table></figure><h4 id="启动zabbix服务"><a href="#启动zabbix服务" class="headerlink" title="启动zabbix服务"></a><font color="#DDA0DD">启动zabbix服务</font></h4><pre><code>修改zabbix_server.confvim /usr/local/zabbix/etc/zabbix_server.confDBName=zabbixDBHost=172.17.0.2        # 这里就是MySQL服务器的地址DBUser=zabbixDBPassword=123.comDBPort=3306ListenPort=10051LogFile=/usr/local/zabbix/log/zabbix_server.logLogFileSize=100DebugLevel=2Timeout=30PidFile=/usr/local/zabbix/var/zabbix_server.pidStartPollers=20StartPollersUnreachable=5StartTrappers=5</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/<span class="built_in">local</span>/zabbix/&#123;<span class="built_in">log</span>,var&#125;</span><br><span class="line">useradd -M -s /sbin/nologin zabbix<span class="comment"># 创建zabbix运行用户</span></span><br><span class="line">chown -R zabbix:zabbix /usr/<span class="built_in">local</span>/zabbix/</span><br><span class="line">cp misc/init.d/fedora/core/&#123;zabbix_server,zabbix_agentd&#125; /etc/init.d/</span><br><span class="line">chmod +x /etc/init.d/&#123;zabbix_server,zabbix_agentd&#125;<span class="comment">#服务控制脚本</span></span><br><span class="line"><span class="comment"># 修改/etc/init.d/zabbix_server 和 /etc/init.d/zabbix_agentd </span></span><br><span class="line"><span class="comment"># 确保BASEDIR的路径正确 BASEDIR=/usr/local/zabbix</span></span><br><span class="line">/usr/<span class="built_in">local</span>/zabbix/sbin/zabbix_server<span class="comment"># 这里直接使用绝对路径启动程序</span></span><br></pre></td></tr></table></figure><pre><code>检测zabbix_server是否正常启动监听 监听端口10051[root@7938190c2002 zabbix-3.0.1]# netstat -anpt |grep 10051tcp     0    0 0.0.0.0:10051       0.0.0.0:*        LISTEN      - 如果没有正常启动服务 请查看日志 /usr/local/zabbix/log/zabbix_server.log</code></pre><h4 id="配置web管理界面"><a href="#配置web管理界面" class="headerlink" title="配置web管理界面"></a><font color="#DDA0DD">配置web管理界面</font></h4><pre><code>修改php-fpm服务的配置文件 修改为zabbix需要的值vim php.ini            # 本环境中 php.ini位置在/usr/local/php/lib/php.ini    date.timezone = Asia/Shanghai    post_max_size = 32M    max_execution_time = 300    max_input_time = 300    always_populate_raw_post_data = -1        # php5.6以上版本会出现这个重启php-fpm服务service php-fpm restart</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意 是将php目录复制到php-fpm能访问到的路径 根据实际情况决定</span></span><br><span class="line"><span class="comment"># 本环境已经通过NFS让zabbix, nginx 和 php-fpm 共享/var/www/html目录</span></span><br><span class="line">cp -rf frontends/php/ /var/www/html/zabbix</span><br><span class="line">chmod -R 777 /var/www/html/zabbix/conf<span class="comment"># php页面需要将配置信息写到这个目录</span></span><br></pre></td></tr></table></figure><p>打开浏览器 输入zabbix页面的地址 <a href="http://172.17.0.4/zabbix" target="_blank" rel="noopener">http://172.17.0.4/zabbix</a></p><p>点击 Next step 进入 Check of pre-requisites 页面<br>确定 Check of pre-requisites 一页都是绿色 然后 Next step</p><p>进入 Configure DB connection 页面 输入mysql连接信息<br>如果mysql服务在本地 可以输入使用默认的localhost 然后 Next step</p><p><img src="/uploads/2016/zabbix/20160402001321.png" alt="Configure DB connection"></p><p>配置zabbix server的信息 输入zabbix server的IP地址 端口 还有名称<br>如果zabbix server在本机 Host使用默认的localhost即可 然后 Next step</p><p><img src="/uploads/2016/zabbix/20160402001814.png" alt="Zabbix server details"></p><p>确认一次信息是否有误 如果无误就 Next step 完成安装<br>此时所有的信息保存在 /var/www/html/zabbix/conf/zabbix.conf.php 中</p><p><img src="/uploads/2016/zabbix/20160402002133.png" alt="Zabbix server details"></p><p>进入登陆页面 初始用户名和密码是 admin/zabbix</p><p><img src="/uploads/2016/zabbix/20160402002624.png" alt="Zabbix server details"></p><p>至此 zabbix server 安装安装完成 如果配置的有错误 还可以重新访问配置页面进行重新配置<br><a href="http://172.17.0.4/zabbix/setup.php" target="_blank" rel="noopener">http://172.17.0.4/zabbix/setup.php</a></p><h4 id="web管理界面中文支持"><a href="#web管理界面中文支持" class="headerlink" title="web管理界面中文支持"></a><font color="#DDA0DD">web管理界面中文支持</font></h4><p>zabbix官方提供了中文支持 但是需要修改php页面开启</p><pre><code>vim /var/www/html/zabbix/include/locales.inc.php 找到 &apos;zh_CN&apos; =&gt; array(&apos;name&apos; =&gt; _(&apos;Chinese (zh_CN)&apos;),   &apos;display&apos; =&gt; false],修改 &apos;display&apos; =&gt; true</code></pre><p>在web管理界面 点击右上角的小人图标 或直接访问 <code>http://172.17.0.4/zabbix/profile.php</code><br>此时已经打开了zabbix的设置界面 语言选择中找到中文语言 如果中文选择是灰色<br>说明当前系统并未支持<code>zh_CN</code>字符集 需要先安装<code>zh_CN</code>的支持才能正常选择中文</p><pre><code>localedef  -f UTF-8 -i zh_CN zh_CN.UTF8</code></pre><p>通过 <code>locale -a</code> 可以查看当前系统已经支持的字符集</p><p>添加字符集后需要重启<code>php-fpm</code>服务 </p><p>如果想应用以及配置好的字符集 可以通过配置环境变量:</p><pre><code>export LANG=&apos;zh_CN.UTF-8&apos;export LANGUANE=&apos;zh_CN.UTF-8&apos;</code></pre><p>如果想设置为系统默认字符集 可以将环境变量写入到配置文件</p><pre><code>CentOS系列: vim /etc/sysconfig/i18n</code></pre><p>其实只要将已经添加好中文字符集的其他机器的 <code>locale-archive</code> 文件替换到自己目录即可<br>文件路径: <code>/usr/lib/locale/locale-archive</code> 但是这样 系统可能会缺乏相应的字体 所以并不推荐</p><p>自带的中文字体可能会出现乱码 这时需要自己替换中文字体解决<br>从Windows系统 <code>c:\windows\fonts</code> 或网上找一个自己喜欢的字体<br>复制到 <code>/var/www/html/zabbix/fonts/</code> 中 这里用 <code>msyh.ttf</code></p><pre><code>sed -i &apos;s/DejaVuSans/msyh/g&apos; /var/www/html/zabbix/include/defines.inc.php</code></pre><p>将默认的 <code>DejaVuSans</code> 替换成自己的 <code>msyh</code> 然后刷新网页</p><h3 id="配置zabbix-Agentd"><a href="#配置zabbix-Agentd" class="headerlink" title="配置zabbix Agentd"></a><font color="#CDAA7D">配置zabbix Agentd</font></h3><blockquote><p>通过–enable-agent选项可以安装zabbix_agent 因此 zabbix_server安装的时候已经启用zabbix_agent<br>不需另行安装 其他客户端安装则不需过多编译选项 只需启用–enable-agent即可</p></blockquote><h4 id="Linux主机安装Agentd"><a href="#Linux主机安装Agentd" class="headerlink" title="Linux主机安装Agentd"></a><font color="#DDA0DD">Linux主机安装Agentd</font></h4><blockquote><p>以下操作是在Zabbix Agent1主机上进行编译</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">useradd -M -s /sbin/nologin zabbix</span><br><span class="line">tar xf zabbix-2.2.10.tar.gz</span><br><span class="line"><span class="built_in">cd</span> zabbix-2.2.10</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/zabbix_agent --<span class="built_in">enable</span>-agent</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line">mkdir /usr/<span class="built_in">local</span>/zabbix_agent/&#123;<span class="built_in">log</span>,var&#125;</span><br><span class="line">chown -R zabbix:zabbix /usr/<span class="built_in">local</span>/zabbix_agent/</span><br><span class="line">/usr/<span class="built_in">local</span>/zabbix_agent/etc/zabbix_agentd.conf</span><br></pre></td></tr></table></figure><pre><code>vim /usr/local/zabbix_agent/etc/zabbix_agentd.conf    LogFile=/usr/local/zabbix_agent/log/zabbix_agentd.logPidFile=/usr/local/zabbix_agent/var/zabbix_agentd.pidDebugLevel=3Server=127.0.0.1,172.17.0.5            # 配置允许连接的zabbix_serverServerActive=127.0.0.1,172.17.0.5      # 配置允许主动连接的zabbix_serverStartAgents=8Hostname=localhostTimeout=30UnsafeUserParameters=1根据实际情况修改配置文件参数的值</code></pre><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置服务启动脚本在zabbix_server中已经介绍 agent端只需要zabbix_agentd脚本即可</span></span><br><span class="line"><span class="comment"># /usr/local/zabbix/sbin/zabbix_agentd# Server端启动zabbix_agentd</span></span><br><span class="line">/usr/<span class="built_in">local</span>/zabbix_agent/sbin/zabbix_agentd   <span class="comment"># Agent端启动zabbix_agentd</span></span><br></pre></td></tr></table></figure><pre><code>检测 10050 端口是否正常监听[root@13262019d57f ~]# netstat -anpt |grep 10050tcp     0    0 0.0.0.0:10050       0.0.0.0:*        LISTEN   -zabbix Agent端自我检测是否可以正常获取监控数据/usr/local/zabbix_agent/bin/zabbix_get -s 127.0.0.1 -k agent.pingzabbix Server端检测是否可以正常获取Agent端的数据/usr/local/zabbix/bin/zabbix_get -s 172.17.0.6 -k agent.ping都返回 1 则正常 这样就可以在web界面上添加server对agent的监控了</code></pre><h4 id="Windows主机安装Agentd"><a href="#Windows主机安装Agentd" class="headerlink" title="Windows主机安装Agentd"></a><font color="#DDA0DD">Windows主机安装Agentd</font></h4><blockquote><p>当前操作在Zabbix Agent2上进行 Zabbix Agent2是一台windows主机</p></blockquote><pre><code>获取Windwos版zabbix-agent安装包zabbix_agents_3.0.0.win.zip解压文件到任意安装目录这里解压到 C:\Program Files\zabix配置文件的修改方法大体和Linux下相同编辑 C:\Program Files\zabix\conf\zabbix_agent.win.conf    Server=127.0.0.1,172.17.0.5    ServerActive=127.0.0.1,172.17.0.5    StartAgents=8    Hostname=windows    Timeout=30    UnsafeUserParameters=1将zabbix_agentd注册为服务以管理员身份运行cmd 到zabbix_agentd.exe的目录下 注意选好32位还是64位的exe&gt; zabbix_agentd.exe --install -c &quot;C:\Program Files\zabix\conf\zabbix_agent.win.conf&quot;因为路径中有空格 所以用双引号扩起 出现installed successfully则安装成功可以在服务管理界面启动和停止 &quot;zabbix agent&quot; 也可以用net命令控制管理员身份运行cmd 控制启动和关闭服务&gt; net start &quot;zabbix agent&quot;&gt; net stop &quot;zabbix agent&quot;服务端检测是否正常获取数据/usr/local/zabbix/bin/zabbix_get -s 172.17.0.7 -k agent.ping返回1 服务端正常获取数据</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><h3 id="常见故障处理"><a href="#常见故障处理" class="headerlink" title="常见故障处理"></a><font color="#CDAA7D">常见故障处理</font></h3><h4 id="编译配置报错"><a href="#编译配置报错" class="headerlink" title="编译配置报错"></a><font color="#DDA0DD">编译配置报错</font></h4><pre><code>检测依赖包是否正常安装 gcc等编译工具是否正常安装</code></pre><h4 id="无法打开Web界面"><a href="#无法打开Web界面" class="headerlink" title="无法打开Web界面"></a><font color="#DDA0DD">无法打开Web界面</font></h4><pre><code>检查LNMP环境是否正常 以及是否配置了正确的防火墙规则等</code></pre><h4 id="Web界面出现-Zabbix-server-is-not-running-…"><a href="#Web界面出现-Zabbix-server-is-not-running-…" class="headerlink" title="Web界面出现 Zabbix server is not running …"></a><font color="#DDA0DD">Web界面出现 Zabbix server is not running …</font></h4><pre><code>检测是否关闭Selinux setenforce 0检测zabbix_server的IP地址和端口号在web界面中是否正确配置如果zabbix_server在本地 看主机是否正常解析localhost域名# telnet localhost 10051如果不能正常解析 # vim /var/www/html/zabbix/conf/zabbix.conf.php将$ZABBIX_SERVER = &apos;localhost&apos; 换成 &apos;127.0.0.1&apos; 或者修改host文件添加 localhost 到 127.0.0.1 的域名解析127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</code></pre><h4 id="数据库mysql-sock文件无法找到"><a href="#数据库mysql-sock文件无法找到" class="headerlink" title="数据库mysql.sock文件无法找到"></a><font color="#DDA0DD">数据库mysql.sock文件无法找到</font></h4><pre><code>如果MySQL服务器和php-fpm服务器在同一台主机 php-fpm可能会通过mysql.sock套接字和MySQL服务通信如果有如下错误提醒:Database error: Error connecting to database [Can&apos;t connect to local MySQL server through socket &apos;/var/lib/mysql/mysql.lock&apos;]确保/var/lib/mysql/mysql.lock存在 如果实际mysql.sock位置与报错中的位置不符 修改zabbix_server.conf中的DBSocket配置DBSocket的值要为真实mysql.sock的绝对路径 然后重启服务</code></pre><h4 id="禁用guests账号-防止非法访问"><a href="#禁用guests账号-防止非法访问" class="headerlink" title="禁用guests账号 防止非法访问"></a><font color="#DDA0DD">禁用guests账号 防止非法访问</font></h4><pre><code>在web管理界面上操作管理 &gt;&gt; 用户 &gt;&gt; Guests &gt;&gt; 状态:停用的</code></pre><h3 id="zabbix总览"><a href="#zabbix总览" class="headerlink" title="zabbix总览"></a><font color="#CDAA7D">zabbix总览</font></h3><pre><code>zabbix_get              server和agent之间数据获取    -s                  远程agent的主机名或IP地址    -p                  远程agent的端口 默认10050    -I                  如果有多块网卡 本机出去的IP地址    -k                  获取远程agent数据用的KEYzabbix_get -s 127.0.0.1 -p 10050 -k agent.pingzabbix_server           zabbix服务端的核心程序zabbix_proxy            abbix代理服务的程序 用于分布式监控proxy模式中zabbix_agent            用超级服务方式启动用的程序zabbix_agentd           独立进程方式启动用的程序zabbix_java_gateway     zabbix的java采集服务端zabbix_sender           将采集到的数据定时发送给zabbix_server</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;zabbix是一个基于WEB界面的提供分布式系统监视以及网络监视功能的企业级的开源解决方案。&lt;br&gt;zabbix能监视各种网络参数，保证服务器系统的安全运营；并提供灵活的通知机制以让系统管理员快速定位/解决存在的各种问题。&lt;br&gt;zabbix由2部分构成，zabbix server与可选组件zabbix agent。&lt;br&gt;zabbix server可以通过SNMP，zabbix agent，ping，端口监视等方法提供对远程服务器/网络状态的监视，数据收集等功能，它可以运行在Linux，Solaris，HP-UX，AIX，Free BSD，Open BSD，OS X等平台上&lt;br&gt;&lt;a href=&quot;http://baike.baidu.com/link?url=j3tIKvRZKMKpBkPLSXFs-lhgWSCI3Yh13Ohk7y2WOkzfLsRnZG3zZ3nHZKDKxNnl8EL6Jt37OkqEwH6DxRMfJq&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;font color=&quot;#AAAAAA&quot;&gt;百度百科&lt;/font&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="Zabbix" scheme="http://www.yunfwe.cn/categories/Zabbix/"/>
    
    
      <category term="zabbix" scheme="http://www.yunfwe.cn/tags/zabbix/"/>
    
      <category term="LNMP" scheme="http://www.yunfwe.cn/tags/LNMP/"/>
    
      <category term="监控" scheme="http://www.yunfwe.cn/tags/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>LNMP环境部署</title>
    <link href="http://www.yunfwe.cn/2016/04/01/2016/LNMP%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/"/>
    <id>http://www.yunfwe.cn/2016/04/01/2016/LNMP%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/</id>
    <published>2016-04-01T05:12:00.000Z</published>
    <updated>2025-07-22T07:12:54.868Z</updated>
    
    <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a><font color="#5CACEE">简介</font></h2><blockquote><p>NMP代表的就是：Linux系统下Nginx+MySQL+PHP这种网站服务器架构。<br>Linux是一类Unix计算机操作系统的统称，是目前最流行的免费操作系统。代表版本有：debian、centos、ubuntu、fedora、gentoo等。<br>Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP代理服务器。<br>Mysql是一个小型关系型数据库管理系统。<br>PHP是一种在服务器端执行的嵌入HTML文档的脚本语言。<br>这四种软件均为免费开源软件，组合到一起，成为一个免费、高效、扩展性强的网站服务系统。<br><a href="http://baike.baidu.com/link?url=bMxOeg20BJhz-ATbBQ88pBDZxMyQ92XX3lwJ5JmfK0DEJYPdFaDHLtMaLsTlyB4tT7AfyuVcLKrdX047yI0D2q" target="_blank" rel="noopener"><font color="#AAAAAA">百度百科</font></a><br><a id="more"></a></p></blockquote><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a><font color="#5CACEE">环境</font></h2><blockquote><p>本教程中的各服务搭建在不同的服务器上 当然也可以搭建在同一个服务器上</p></blockquote><h3 id="主机环境"><a href="#主机环境" class="headerlink" title="主机环境"></a><font color="#CDAA7D">主机环境</font></h3><table><thead><tr><th>身份</th><th style="text-align:center">系统</th><th style="text-align:right">IP</th></tr></thead><tbody><tr><td>Nginx 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.7</td></tr><tr><td>MySQL 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.2</td></tr><tr><td>PHP-fpm 服务器</td><td style="text-align:center">CentOS 6.7</td><td style="text-align:right">172.17.0.6</td></tr></tbody></table><h3 id="软件环境"><a href="#软件环境" class="headerlink" title="软件环境"></a><font color="#CDAA7D">软件环境</font></h3><table><thead><tr><th>软件名称</th><th style="text-align:center">版本号</th><th style="text-align:right">下载地址</th></tr></thead><tbody><tr><td>Nginx</td><td style="text-align:center">1.9.13</td><td style="text-align:right"><a href="http://nginx.org/download/nginx-1.9.13.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>MySQL</td><td style="text-align:center">5.6.28</td><td style="text-align:right"><a href="http://dev.mysql.com/get/Downloads/MySQL-5.6/mysql-5.6.28.tar.gz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr><tr><td>PHP</td><td style="text-align:center">5.6.19</td><td style="text-align:right"><a href="http://cn2.php.net/distributions/php-5.6.19.tar.xz" target="_blank" rel="noopener"><font color="#AAAAAA">点击下载</font></a></td></tr></tbody></table><h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a><font color="#5CACEE">步骤</font></h2><h3 id="编译安装各组件"><a href="#编译安装各组件" class="headerlink" title="编译安装各组件"></a><font color="#CDAA7D">编译安装各组件</font></h3><table><thead><tr><th>服务器</th><th style="text-align:center">安装文档地址</th></tr></thead><tbody><tr><td>Nginx</td><td style="text-align:center"><a href="/2016/03/31/nginx/nginx编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr><tr><td>MySQL</td><td style="text-align:center"><a href="/2016/04/01/mysql/MySQL编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr><tr><td>PHP-fpm</td><td style="text-align:center"><a href="/2016/04/01/php/php-fpm编译安装"><font color="#AAAAAA">点击打开文档内容</font></a></td></tr></tbody></table><h3 id="搭配组合"><a href="#搭配组合" class="headerlink" title="搭配组合"></a><font color="#CDAA7D">搭配组合</font></h3><blockquote><p>他们之间的搭配其实就是通过修改配置文件能互连起来 协调工作<br>如果跨主机搭建需要让Nginx和PHP-fpm能访问相同的web网页目录<br>或者只将PHP的页面放到PHP-fpm服务能访问到了路径即可<br>因为Nginx收到PHP页面的请求会将请求转发给PHP-fpm去处理 自己并不处理PHP的页面<br>但是如果其他的静态资源等 还是需要放到Nginx能访问到的路径<br>实验中 已经通过NFS共享方式让Nginx和PHP-fpm挂载相同的/var/www/html目录</p></blockquote><h4 id="配置PHP-fpm"><a href="#配置PHP-fpm" class="headerlink" title="配置PHP-fpm"></a><font color="#DDA0DD">配置PHP-fpm</font></h4><pre><code>打开编辑php-fpm.confvim /usr/local/php/etc/php-fpm.conf修改listen监听地址为0.0.0.0:9000listen = 0.0.0.0:9000 配置仅允许连接的客户机 默认运行所有主机连接 172.0.0.7是Nginx服务器的IPlisten.allowed_clients = 172.17.0.7然后启动PHP-fpm的服务service php-fpm start</code></pre><h4 id="配置Nginx"><a href="#配置Nginx" class="headerlink" title="配置Nginx"></a><font color="#DDA0DD">配置Nginx</font></h4><pre><code>打开编辑nginx.confvim /usr/local/nginx/conf/nginx.conf更改网站根路径和添加php页面的识别location / {                                                                  root   /var/www/html;                                                     index  index.html index.htm index.php;                                }去掉php段的注释 并按实际环境修改以下内容location ~ \.php$ {                                                           root           /var/www/html;                                             fastcgi_pass   172.17.0.6:9000;                                           fastcgi_index  index.php;                                                 fastcgi_param  SCRIPT_FILENAME  /var/www/html$fastcgi_script_name;        include        fastcgi_params;                                        }重启或通知Nginx重新加载配置文件/usr/local/nginx/sbin/nginx -s reload</code></pre><h4 id="配置MySQL"><a href="#配置MySQL" class="headerlink" title="配置MySQL"></a><font color="#DDA0DD">配置MySQL</font></h4><pre><code>MySQL创建远程登录用户 php 只允许 172.17.0.6连接 密码 php123grant all privileges on *.* to &quot;php&quot;@&quot;172.17.0.6&quot; identified by &quot;php123&quot;;</code></pre><h3 id="验证是否搭配成功"><a href="#验证是否搭配成功" class="headerlink" title="验证是否搭配成功"></a><font color="#CDAA7D">验证是否搭配成功</font></h3><pre><code>在/var/www/html中编写index.php    &lt;?php        phpinfo();    ?&gt;在/var/www/html中编写dbtest.php    &lt;?php         $link=mysql_connect(&quot;172.17.0.2&quot;,&quot;root&quot;,&quot;123.com&quot;);         if(!$link) echo &quot;连接错误!&quot;;         else echo &quot;可以连接!&quot;;     ?&gt;分别访问两个php文件http://172.17.0.7/  和  http://172.17.0.7/dbtest.php若浏览器出现大大的PHP Version 5.6.19 则index.php被正常识别访问dbtest.php若出现 &quot;可以连接!&quot; 则数据库连接成果以下是用curl访问dbtest.php的结果[root@45c4f07c6049 etc]# curl http://172.17.0.7/dbtest.phpOK!可以连接</code></pre><h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a><font color="#5CACEE">附录</font></h2><pre><code>搭建好LNMP后 好多用到PHP运行环境的页面就可以在上面运行了 比如zabbix的web管理界面</code></pre>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;简介&quot;&gt;&lt;a href=&quot;#简介&quot; class=&quot;headerlink&quot; title=&quot;简介&quot;&gt;&lt;/a&gt;&lt;font color=&quot;#5CACEE&quot;&gt;简介&lt;/font&gt;&lt;/h2&gt;&lt;blockquote&gt;
&lt;p&gt;NMP代表的就是：Linux系统下Nginx+MySQL+PHP这种网站服务器架构。&lt;br&gt;Linux是一类Unix计算机操作系统的统称，是目前最流行的免费操作系统。代表版本有：debian、centos、ubuntu、fedora、gentoo等。&lt;br&gt;Nginx是一个高性能的HTTP和反向代理服务器，也是一个IMAP/POP3/SMTP代理服务器。&lt;br&gt;Mysql是一个小型关系型数据库管理系统。&lt;br&gt;PHP是一种在服务器端执行的嵌入HTML文档的脚本语言。&lt;br&gt;这四种软件均为免费开源软件，组合到一起，成为一个免费、高效、扩展性强的网站服务系统。&lt;br&gt;&lt;a href=&quot;http://baike.baidu.com/link?url=bMxOeg20BJhz-ATbBQ88pBDZxMyQ92XX3lwJ5JmfK0DEJYPdFaDHLtMaLsTlyB4tT7AfyuVcLKrdX047yI0D2q&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;font color=&quot;#AAAAAA&quot;&gt;百度百科&lt;/font&gt;&lt;/a&gt;&lt;br&gt;
    
    </summary>
    
    
      <category term="LNMP" scheme="http://www.yunfwe.cn/categories/LNMP/"/>
    
    
      <category term="mysql" scheme="http://www.yunfwe.cn/tags/mysql/"/>
    
      <category term="php" scheme="http://www.yunfwe.cn/tags/php/"/>
    
      <category term="zabbix" scheme="http://www.yunfwe.cn/tags/zabbix/"/>
    
      <category term="nginx" scheme="http://www.yunfwe.cn/tags/nginx/"/>
    
  </entry>
  
</feed>
